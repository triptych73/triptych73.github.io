<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St Mary Somerset | Drawings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="firebase-config.js"></script>

    <!-- Auth Guard -->
    <script>
        if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

            firebase.auth().onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = 'login.html';
                }
            });
        }
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'portland': '#F5F5F0', // Weathered Stone
                        'midnight': '#0F1115', // Thames Midnight
                        'bronze': '#9A8C74',   // Patinated Bronze
                        'bronze-light': '#B5A894',
                        'bronze-dark': '#7d705a',
                    },
                    fontFamily: {
                        'serif': ['Cinzel', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'shimmer': 'shimmer 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE STYLES */
        body {
            background-color: #F5F5F0;
            color: #0F1115;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1CEC7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9A8C74;
        }

        /* SHIMMER EFFECT FOR FLOORS */
        .floor-region {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* The sheen that moves across */
        .floor-region::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transform: skewX(-20deg) translateX(-250%);
            transition: transform 0s;
            pointer-events: none;
        }

        .floor-region:hover {
            background-color: rgba(154, 140, 116, 0.15);
            /* Bronze Tint */
            backdrop-filter: brightness(1.1);
            box-shadow: inset 0 0 0 1px rgba(154, 140, 116, 0.4);
        }

        .floor-region:hover::after {
            animation: shimmer-slide 1.5s infinite;
        }

        .floor-region.active {
            background-color: rgba(15, 17, 21, 0.85);
            /* Midnight */
            color: #F5F5F0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        @keyframes shimmer-slide {
            0% {
                transform: skewX(-20deg) translateX(-250%);
            }

            100% {
                transform: skewX(-20deg) translateX(250%);
            }
        }

        /* UTILITIES */
        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-portland text-midnight font-sans h-screen flex flex-col selection:bg-bronze selection:text-white">

    <!-- HEADER -->
    <header
        class="h-16 bg-white/50 backdrop-blur-md border-b border-bronze/10 flex justify-between items-center px-8 fixed top-0 w-full z-40">
        <div class="flex items-center gap-4">
            <h1 class="font-serif text-xl tracking-widest uppercase text-midnight">St Mary Somerset</h1>
            <span class="h-4 w-px bg-bronze/30"></span>
            <span class="text-xs tracking-[0.2em] text-bronze uppercase">Drawings Archive</span>
        </div>

        <div class="flex items-center gap-4">
            <button id="manageDrawingsBtn"
                class="text-xs uppercase tracking-widest text-midnight hover:text-bronze transition-colors flex items-center gap-2 px-3 py-2 rounded hover:bg-white/50">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Manager
            </button>
            <button id="importCsvBtn"
                class="text-xs uppercase tracking-widest bg-midnight text-portland px-5 py-2 hover:bg-bronze transition-colors duration-300">
                Import CSV
            </button>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="flex mt-16 h-[calc(100vh-64px)] relative overflow-hidden">

        <!-- SIDEBAR NAV -->
        <div id="navPane"
            class="w-[380px] bg-white/40 border-r border-bronze/10 h-full flex flex-col relative transition-all duration-500 ease-in-out z-30 shadow-[4px_0_20px_rgba(0,0,0,0.02)]">

            <!-- Toggle Button -->
            <div id="navToggle"
                class="absolute -right-6 top-1/2 -translate-y-1/2 w-6 h-12 bg-white/80 backdrop-blur flex items-center justify-center cursor-pointer border border-l-0 border-bronze/20 rounded-r-md hover:text-bronze transition-colors z-50">
                <span id="navToggleIcon" class="text-[10px]">◀</span>
            </div>

            <div class="overflow-y-auto h-full hide-scrollbar p-6 space-y-8">

                <!-- Building Visualizer -->
                <div class="space-y-3">
                    <h2 class="font-serif text-sm text-bronze uppercase tracking-widest">Select Level</h2>

                    <!-- Centered Container -->
                    <div
                        class="w-full flex justify-center bg-white border border-bronze/10 rounded-sm py-4 shadow-inner">
                        <!-- Wrapper to fit image size exactly -->
                        <div class="relative w-fit overflow-hidden">
                            <img src="images/tower.png" alt="St Mary Somerset Tower"
                                class="max-h-[60vh] w-auto block opacity-90 shadow-sm -ml-3">

                            <!-- Floor Overlay Grid -->
                            <div class="absolute inset-0 flex flex-col" id="floorOverlay">
                                <!-- Injected via JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="space-y-6">
                    <!-- Room -->
                    <div class="space-y-3">
                        <h2 class="font-serif text-sm text-bronze uppercase tracking-widest">Room Type</h2>
                        <div id="roomTypeTabs" class="grid grid-cols-2 gap-2">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Orientation -->
                    <div class="space-y-3">
                        <h2 class="font-serif text-sm text-bronze uppercase tracking-widest">Orientation</h2>
                        <div id="orientationTabs" class="flex gap-1 bg-white/50 p-1 rounded-sm border border-bronze/5">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Stage -->
                    <div class="space-y-3">
                        <h2 class="font-serif text-sm text-bronze uppercase tracking-widest">Stage</h2>
                        <div id="stageTabs" class="flex flex-wrap gap-2">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="p-6 border-t border-bronze/10 bg-white/30 backdrop-blur-sm">
                <button id="saveBtn"
                    class="w-full border border-bronze text-bronze hover:bg-bronze hover:text-white text-xs uppercase tracking-widest py-3 transition-colors duration-300">
                    Save Changes
                </button>
            </div>
        </div>

        <!-- VIEWER AREA -->
        <div class="flex-1 bg-[#F5F5F0] relative flex items-center justify-center overflow-hidden">

            <!-- Grid Background (Subtle) -->
            <div class="absolute inset-0 opacity-[0.03]"
                style="background-image: linear-gradient(#0F1115 1px, transparent 1px), linear-gradient(90deg, #0F1115 1px, transparent 1px); background-size: 40px 40px;">
            </div>

            <!-- Content -->
            <div class="relative z-10 w-full h-full p-8 flex flex-col">

                <!-- Drawing Container -->
                <div id="drawingContainer" class="hidden w-full h-full flex flex-col animate-fade-in">

                    <!-- Toolbar -->
                    <div class="flex justify-between items-center mb-4">
                        <div id="drawingTitle" class="font-serif text-lg text-midnight tracking-wide"></div>

                        <div
                            class="flex items-center gap-2 bg-white px-2 py-1 rounded shadow-sm border border-bronze/10">
                            <button id="zoomOutBtn"
                                class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-midnight">-</button>
                            <span class="w-px h-4 bg-gray-200"></span>
                            <button id="zoomInBtn"
                                class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-midnight">+</button>
                            <span class="w-px h-4 bg-gray-200"></span>
                            <button id="panBtn"
                                class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-midnight group"
                                title="Pan Tool">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" class="group-hover:text-bronze">
                                    <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"></path>
                                    <path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"></path>
                                    <path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"></path>
                                    <path
                                        d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15">
                                    </path>
                                </svg>
                            </button>
                            <button id="changeUrlBtn"
                                class="ml-2 text-[10px] uppercase font-bold tracking-wider text-bronze hover:text-midnight px-2">Edit
                                URL</button>
                        </div>
                    </div>

                    <!-- Viewport -->
                    <div
                        class="flex-1 bg-white shadow-lg border border-bronze/10 relative overflow-hidden flex items-center justify-center">
                        <img id="drawingImage"
                            class="max-w-full max-h-full transition-transform duration-200 ease-out origin-center"
                            alt="Select a drawing">
                    </div>
                </div>

                <!-- URL Config Form (Empty State / Edit) -->
                <div id="urlForm" class="max-w-md w-full bg-white p-8 shadow-xl border border-bronze/10 m-auto hidden">
                    <h3 class="font-serif text-xl mb-6 text-midnight">Configure Drawing</h3>

                    <div class="space-y-4">
                        <div>
                            <span class="text-[10px] uppercase tracking-widest text-gray-400 block mb-1">ID Code</span>
                            <div id="drawingKey" class="font-mono text-sm text-bronze"></div>
                        </div>

                        <div>
                            <span
                                class="text-[10px] uppercase tracking-widest text-gray-400 block mb-1">Description</span>
                            <div id="drawingDescription" class="font-sans text-sm"></div>
                        </div>

                        <div class="pt-4">
                            <label for="urlInput"
                                class="text-[10px] uppercase tracking-widest text-midnight block mb-2">Image URL</label>
                            <input type="text" id="urlInput"
                                class="w-full border-b border-gray-300 py-2 text-sm focus:outline-none focus:border-bronze transition-colors placeholder-gray-300 font-light"
                                placeholder="https://...">
                        </div>

                        <div class="pt-6 flex justify-end">
                            <button id="saveUrlBtn"
                                class="bg-midnight text-white text-xs uppercase tracking-widest px-6 py-3 hover:bg-bronze transition-colors">
                                Save Configuration
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur z-50 hidden flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-bronze rounded-full animate-spin mb-4"></div>
        <div class="text-xs uppercase tracking-[0.3em] text-midnight">Retrieving Archival Data...</div>
    </div>

    <!-- Notification Toast -->
    <div id="notification"
        class="fixed top-24 right-8 bg-midnight text-white px-6 py-4 shadow-xl z-[100] transform translate-y-[-20px] opacity-0 transition-all duration-300">
        <div id="notificationMessage" class="font-sans text-sm tracking-wide"></div>
    </div>

    <!-- Logic Script (Preserved & Adapted) -->
    <script>
        // Constants - DATA MODELS
        const floors = Array.from({ length: 12 }, (_, i) => (i + 1).toString().padStart(2, '0'));
        const rooms = ['1', '2', '3'];
        const types = [
            { code: 'G', name: 'GA', hasOrientations: false },
            { code: 'E', name: 'Elevation', hasOrientations: true },
            { code: 'S', name: 'Section', hasOrientations: true },
            { code: 'I', name: 'ICP', hasOrientations: false }
        ];
        const orientations = [
            { code: 'N', name: 'North' },
            { code: 'E', name: 'East' },
            { code: 'S', name: 'South' },
            { code: 'W', name: 'West' },
            { code: 'Default', name: 'Default' }
        ];
        const stages = [
            { code: 'O', name: 'Original' },
            { code: 'D', name: 'Demolition' },
            { code: 'P', name: 'Proposed' },
            { code: 'A', name: 'As Built' }
        ];

        // State
        let csvData = [];
        let urlData = [];
        let activeFloor = '01';
        let activeRoom = '1';
        let activeType = 'G';
        let activeOrientation = 'Default';
        let activeStage = 'O'; // Default active stage

        // Viewport State
        let currentScale = 1;
        let isPanning = false;
        let startPanX = 0;
        let startPanY = 0;
        let translateX = 0;
        let translateY = 0;

        // DOM Elements
        const navPane = document.getElementById('navPane');
        const navToggle = document.getElementById('navToggle');
        const navToggleIcon = document.getElementById('navToggleIcon');
        const floorOverlay = document.getElementById('floorOverlay');
        const roomTypeTabs = document.getElementById('roomTypeTabs');
        const orientationTabs = document.getElementById('orientationTabs');
        const stageTabs = document.getElementById('stageTabs');
        const drawingContainer = document.getElementById('drawingContainer');
        const drawingTitle = document.getElementById('drawingTitle');
        const drawingImage = document.getElementById('drawingImage');
        const urlForm = document.getElementById('urlForm');
        const drawingKey = document.getElementById('drawingKey');
        const drawingDescription = document.getElementById('drawingDescription');
        const urlInput = document.getElementById('urlInput');
        const saveUrlBtn = document.getElementById('saveUrlBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const panBtn = document.getElementById('panBtn');
        const changeUrlBtn = document.getElementById('changeUrlBtn');
        const manageDrawingsBtn = document.getElementById('manageDrawingsBtn');
        const importCsvBtn = document.getElementById('importCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const saveBtn = document.getElementById('saveBtn');
        const loadingEl = document.getElementById('loading');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');

        // Initialize
        function init() {
            generateEmptyCsvData(); // Fallback
            setupEventListeners();
            renderFloorRegions();

            // Try to load CSV from localStorage first
            const savedCsv = localStorage.getItem('buildingDrawingsData');
            if (savedCsv) {
                try {
                    const savedData = JSON.parse(savedCsv);
                    // Minimal merge logic or overwrite
                    // For simplicity, we trust the saved data if it exists
                    if (savedData.csvData && savedData.csvData.length > 0) csvData = savedData.csvData;
                    if (savedData.urlData && savedData.urlData.length > 0) urlData = savedData.urlData;

                    showNotification('Project Cache Loaded');
                } catch (e) {
                    console.error('Error loading data from localStorage:', e);
                }
            } else {
                // Try fetching the actual CSV file
                fetch('building_drawings.csv')
                    .then(response => {
                        if (response.ok) return response.text();
                        throw new Error('No default CSV found');
                    })
                    .then(csvText => {
                        Papa.parse(csvText, {
                            header: true,
                            complete: function (results) {
                                processImportedData(results.data);
                                showNotification('Default Drawings Loaded');
                            }
                        });
                    })
                    .catch(err => console.log('Starting with empty state.'));
            }

            // After data load (or empty), update UI
            updateUI();
        }

        // Generate empty CSV data with all permutations
        function generateEmptyCsvData() {
            csvData = [];
            urlData = [];

            floors.forEach(floor => {
                rooms.forEach(room => {
                    types.forEach(type => {
                        if (type.hasOrientations) {
                            orientations.slice(0, 4).forEach(orientation => {
                                stages.forEach(stage => {
                                    const key = `${floor}-${room}-${type.code}-${orientation.code}-${stage.code}`;
                                    csvData.push([key, 0]); // 0 = no drawing
                                    urlData.push([key, '']);
                                });
                            });
                        } else {
                            stages.forEach(stage => {
                                const key = `${floor}-${room}-${type.code}-Default-${stage.code}`;
                                csvData.push([key, 0]);
                                urlData.push([key, '']);
                            });
                        }
                    });
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation toggle
            navToggle.addEventListener('click', toggleNavPane);

            // Zoom and pan controls
            zoomInBtn.addEventListener('click', () => zoom(0.2));
            zoomOutBtn.addEventListener('click', () => zoom(-0.2));
            panBtn.addEventListener('click', togglePanMode); // Renamed to avoid confusion
            changeUrlBtn.addEventListener('click', showUrlForm);

            // Drawing image panning
            drawingImage.addEventListener('mousedown', startPan);
            document.addEventListener('mousemove', pan);
            document.addEventListener('mouseup', endPan);

            // Prevent default drag
            drawingImage.addEventListener('dragstart', (e) => e.preventDefault());

            // URL form
            saveUrlBtn.addEventListener('click', saveDrawingUrl);

            // CSV management
            manageDrawingsBtn.addEventListener('click', () => window.location.href = 'building-drawings-manager.html');
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', importCsv);
            saveBtn.addEventListener('click', saveCsv);
        }

        // Render the floor regions on the building image
        function renderFloorRegions() {
            floorOverlay.innerHTML = '';

            floors.slice().reverse().forEach(floor => {
                const floorDiv = document.createElement('div');
                // Tailwin classes for layout + Custom classes for shimmer
                floorDiv.className = `floor-region flex-1 flex items-center justify-center cursor-pointer text-transparent hover:text-white transition-all duration-300 ${floor === activeFloor ? 'active' : ''}`;
                floorDiv.dataset.floor = floor;

                // Content inside the floor (visible on hover/active)
                const content = document.createElement('span');
                content.className = "font-serif text-lg font-medium drop-shadow-md z-20 pointer-events-none";
                content.textContent = floor;

                floorDiv.appendChild(content);

                floorDiv.addEventListener('click', () => {
                    setActiveFloor(floor);
                });

                floorOverlay.appendChild(floorDiv);
            });
        }

        // Set active floor
        function setActiveFloor(floor) {
            activeFloor = floor;
            // Reset sub-selections to defaults
            activeRoom = '1';
            activeType = 'G';
            activeOrientation = 'Default';
            // Try to keep active stage, or default to O

            document.querySelectorAll('.floor-region').forEach(el => {
                el.classList.toggle('active', el.dataset.floor === floor);
            });

            updateUI();
        }

        function updateUI() {
            renderRoomTypeTabs();
            renderOrientationTabs();
            renderStageTabs();
            updateDrawingView();
        }

        // Render room-type tabs
        function renderRoomTypeTabs() {
            roomTypeTabs.innerHTML = '';

            rooms.forEach(room => {
                types.forEach(type => {
                    const hasDrawing = hasAnyDrawingForRoomType(activeFloor, room, type.code);

                    const tabBtn = document.createElement('button');
                    // Styling logic
                    const isActive = activeRoom === room && activeType === type.code;
                    const isDisabled = !hasDrawing;

                    let classes = "text-xs py-2 px-1 border rounded transition-all duration-200 truncate ";
                    if (isActive) {
                        classes += "bg-bronze text-white border-bronze font-medium shadow-sm";
                    } else if (isDisabled) {
                        classes += "bg-gray-50 text-gray-300 border-gray-100 cursor-not-allowed";
                    } else {
                        classes += "bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-bronze/50 hover:text-bronze";
                    }

                    tabBtn.className = classes;
                    tabBtn.textContent = `R${room} • ${type.name}`;

                    if (!isDisabled || isActive) {
                        tabBtn.addEventListener('click', () => {
                            setActiveRoomType(room, type.code);
                        });
                    }

                    roomTypeTabs.appendChild(tabBtn);
                });
            });
        }

        function setActiveRoomType(room, type) {
            activeRoom = room;
            activeType = type;

            // Check orientation validity
            const typeObj = types.find(t => t.code === type);
            if (typeObj.hasOrientations) {
                if (activeOrientation === 'Default') activeOrientation = 'N'; // Reset to valid
            } else {
                activeOrientation = 'Default';
            }

            updateUI();
        }

        // Render Orientation Tabs
        function renderOrientationTabs() {
            orientationTabs.innerHTML = '';

            // Only show if type supports it
            const currentType = types.find(t => t.code === activeType);
            const showOrientations = currentType && currentType.hasOrientations;

            if (!showOrientations) {
                const msg = document.createElement('div');
                msg.className = "w-full text-center text-[10px] text-gray-400 py-1 uppercase tracking-widest italic";
                msg.textContent = "No Orientation Required";
                orientationTabs.appendChild(msg);
                return;
            }

            orientations.slice(0, 4).forEach(orient => {
                const key = `${activeFloor}-${activeRoom}-${activeType}-${orient.code}`; // Partial key check?
                // Actually need to check if ANY stage has this orientation
                const hasDrawing = hasAnyDrawingForOrientation(activeFloor, activeRoom, activeType, orient.code);

                const tabBtn = document.createElement('div');
                const isActive = activeOrientation === orient.code;

                let classes = "flex-1 text-center py-1 text-xs cursor-pointer rounded-sm transition-all ";
                if (isActive) {
                    classes += "bg-white text-bronze shadow-sm font-medium";
                } else if (!hasDrawing) {
                    classes += "text-gray-300 cursor-not-allowed";
                } else {
                    classes += "text-gray-500 hover:text-bronze hover:bg-white/50";
                }

                tabBtn.className = classes;
                tabBtn.textContent = orient.code;

                if (hasDrawing || isActive) {
                    tabBtn.addEventListener('click', () => {
                        activeOrientation = orient.code;
                        updateUI();
                    });
                }

                orientationTabs.appendChild(tabBtn);
            });
        }

        // Render Stage Tabs
        function renderStageTabs() {
            stageTabs.innerHTML = '';

            stages.forEach(stage => {
                const key = getCurrentKey(stage.code);
                const hasDrawing = checkDrawingExists(key);

                const tabBtn = document.createElement('button');
                const isActive = activeStage === stage.code;

                let classes = "px-3 py-1 text-[10px] uppercase tracking-wider border rounded-full transition-all ";
                if (isActive) {
                    classes += "bg-midnight text-white border-midnight";
                } else if (!hasDrawing) {
                    classes += "text-gray-300 border-gray-100 bg-transparent"; // Keep clickable to allow uploading?
                    // If we want to allow uploading to empty slots, don't disable. 
                    // But visually show it's empty.
                    classes += " decoration-dashed";
                } else {
                    classes += "text-midnight border-gray-300 hover:border-bronze hover:text-bronze";
                }

                tabBtn.className = classes;
                tabBtn.textContent = stage.name;

                tabBtn.addEventListener('click', () => {
                    activeStage = stage.code;
                    updateUI();
                });

                stageTabs.appendChild(tabBtn);
            });
        }

        // UPDATE MAIN VIEW
        function updateDrawingView() {
            const currentKey = getCurrentKey(activeStage);
            const drawingEntry = getDrawingEntry(currentKey);

            // Title
            const typeName = types.find(t => t.code === activeType).name;
            const orientName = activeOrientation !== 'Default' ? ` - ${orientations.find(o => o.code === activeOrientation).name}` : '';
            const stageName = stages.find(s => s.code === activeStage).name;

            drawingTitle.innerHTML = `<span class="font-bold">Floor ${activeFloor}</span> <span class="text-gray-400">|</span> Room ${activeRoom} <span class="text-gray-400">|</span> ${typeName}${orientName}`;

            // Populate Info
            drawingKey.textContent = currentKey;
            drawingDescription.textContent = `${typeName} ${orientName} (${stageName})`;

            // Show Image or Form
            if (drawingEntry && drawingEntry.url && drawingEntry.url.trim() !== '') {
                // We have a URL
                drawingImage.src = drawingEntry.url;
                urlInput.value = drawingEntry.url;

                drawingContainer.classList.remove('hidden');
                drawingContainer.classList.add('flex');
                urlForm.classList.add('hidden');

                // Reset Transform
                resetZoom();
            } else {
                // No URL
                drawingContainer.classList.add('hidden');
                drawingContainer.classList.remove('flex');
                urlForm.classList.remove('hidden');
                urlInput.value = '';
            }
        }

        // --- HELPER FUNCTIONS ---

        function getCurrentKey(stageCode) {
            return `${activeFloor}-${activeRoom}-${activeType}-${activeOrientation}-${stageCode}`;
        }

        function getDrawingEntry(key) {
            // Look in urlData primarily
            const entry = urlData.find(row => Array.isArray(row) ? row[0] === key : row.key === key);

            // Normalize return
            if (Array.isArray(entry)) return { key: entry[0], url: entry[1] };
            return entry || null;
        }

        function checkDrawingExists(key) {
            const entry = getDrawingEntry(key);
            return entry && entry.url && entry.url !== '';
        }

        // Search helpers for enabling tabs
        function hasAnyDrawingForRoomType(fl, rm, tp) {
            // Check all orientations/stages for this combo
            // Simplified check: iterate urlData
            // Optimization: Filter logic
            // Since data structures might be array or object, handle both
            return urlData.some(row => {
                const k = Array.isArray(row) ? row[0] : row.key;
                const u = Array.isArray(row) ? row[1] : row.url;
                if (!u || u === '') return false;

                const parts = k.split('-'); // 0:fl, 1:rm, 2:tp, 3:or, 4:st
                return parts[0] == fl && parts[1] == rm && parts[2] == tp;
            });
        }

        function hasAnyDrawingForOrientation(fl, rm, tp, or) {
            return urlData.some(row => {
                const k = Array.isArray(row) ? row[0] : row.key;
                const u = Array.isArray(row) ? row[1] : row.url;
                if (!u || u === '') return false;

                const parts = k.split('-');
                return parts[0] == fl && parts[1] == rm && parts[2] == tp && parts[3] == or;
            });
        }

        // --- INTERACTION LOGIC ---

        function toggleNavPane() {
            // Check if closed based on margin (or attribute)
            const isClosed = navPane.getAttribute('data-closed') === 'true';

            if (!isClosed) {
                // Close it: Move left by its width
                navPane.style.marginLeft = `-${navPane.offsetWidth}px`;
                navPane.setAttribute('data-closed', 'true');
                navToggleIcon.innerText = "▶";
                // Ensure toggle follows? No, it's relative to navPane
            } else {
                // Open it: Reset margin
                navPane.style.marginLeft = '0';
                navPane.setAttribute('data-closed', 'false');
                navToggleIcon.innerText = "◀";
            }
        }

        function showUrlForm() {
            drawingContainer.classList.add('hidden');
            drawingContainer.classList.remove('flex');
            urlForm.classList.remove('hidden');
        }

        function saveDrawingUrl() {
            const url = urlInput.value.trim();
            const key = getCurrentKey(activeStage);

            // Update Data
            let found = false;
            // Handle Array Structure
            for (let i = 0; i < urlData.length; i++) {
                if (Array.isArray(urlData[i]) && urlData[i][0] === key) {
                    urlData[i][1] = url;
                    found = true;
                    break;
                }
            }
            // Fallback object structure
            if (!found) {
                urlData.push([key, url]);
            }

            // Also update CSV availability flag
            // (Optional, strictly speaking we just need urlData)

            showNotification('URL Updated');
            // Save to local storage
            saveToLocalStorage();
            updateUI();
        }

        function saveToLocalStorage() {
            const data = {
                urlData: urlData,
                csvData: csvData
            };
            localStorage.setItem('buildingDrawingsData', JSON.stringify(data));
        }

        function zoom(delta) {
            currentScale += delta;
            if (currentScale < 0.1) currentScale = 0.1;
            updateTransform();
        }

        function resetZoom() {
            currentScale = 1;
            translateX = 0;
            translateY = 0;
            updateTransform();
        }

        function togglePanMode() {
            isPanning = !isPanning; // actually creates a state for button
            panBtn.classList.toggle('bg-bronze', isPanning); // Active state
            panBtn.classList.toggle('text-white', isPanning);

            if (isPanning) {
                drawingImage.style.cursor = 'grab';
            } else {
                drawingImage.style.cursor = 'default';
            }
        }

        // Panning Event Handlers
        let isDragging = false;

        function startPan(e) {
            if (!isPanning && !e.ctrlKey) return; // Allow Ctrl+Drag or Pan Tool
            e.preventDefault();
            isDragging = true;
            startPanX = e.clientX - translateX;
            startPanY = e.clientY - translateY;
            drawingImage.style.cursor = 'grabbing';
        }

        function pan(e) {
            if (!isDragging) return;
            e.preventDefault();
            translateX = e.clientX - startPanX;
            translateY = e.clientY - startPanY;
            updateTransform();
        }

        function endPan() {
            isDragging = false;
            if (isPanning) drawingImage.style.cursor = 'grab';
        }

        function updateTransform() {
            drawingImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        }

        function showNotification(msg) {
            notificationMessage.textContent = msg;
            notification.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-[-20px]');
            }, 3000);
        }

        // Placeholder for CSV Import/Export
        function importCsv(e) {
            const file = e.target.files[0];
            if (!file) return;

            loadingEl.classList.remove('hidden');
            loadingEl.classList.add('flex');

            Papa.parse(file, {
                header: true,
                complete: function (results) {
                    processImportedData(results.data);
                    loadingEl.classList.add('hidden');
                    loadingEl.classList.remove('flex');
                    showNotification('CSV Imported Successfully');
                }
            });
        }

        function processImportedData(data) {
            // Logic to merge imported data
            // This assumes the CSV has columns like 'key', 'hasDrawing', 'url' (optional)
            // For now, we will just map what we can.
            // If the CSV is just the boolean flags, we update csvData.
            // If it contains URLs, we update urlData.

            // naive implementation
            showNotification('Data Processed');
            updateUI();
        }

        function saveCsv() {
            // Convert urlData to CSV string
            // Just filtering for entries that have URLs
            const fields = ['key', 'url'];
            const data = urlData.map(row => {
                if (Array.isArray(row)) return { key: row[0], url: row[1] };
                return row;
            });

            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'building_drawings_export.csv';
            a.click();
        }

        // Init
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>

</html>