(()=>{var e,t,r={175:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MESSAGE_TYPES=t.WebSocketMessageProcessor=t.AuthenticationManager=t.AUTH_STATE=t.ConnectionState=t.ClientStateManager=t.EufySecurityClient=t.WebSocketClient=t.EufyWebSocketClient=void 0;const i=r(5608);var s=r(741);Object.defineProperty(t,"EufyWebSocketClient",{enumerable:!0,get:function(){return s.ApiManager}});var n=r(9866);Object.defineProperty(t,"WebSocketClient",{enumerable:!0,get:function(){return n.WebSocketClient}});var o=r(5455);Object.defineProperty(t,"EufySecurityClient",{enumerable:!0,get:function(){return o.EufySecurityClient}});var a=r(8700);Object.defineProperty(t,"ClientStateManager",{enumerable:!0,get:function(){return a.ClientStateManager}}),Object.defineProperty(t,"ConnectionState",{enumerable:!0,get:function(){return a.ConnectionState}}),i.__exportStar(r(1277),t),i.__exportStar(r(5346),t),i.__exportStar(r(6350),t),i.__exportStar(r(979),t),i.__exportStar(r(9848),t),i.__exportStar(r(2584),t),i.__exportStar(r(2674),t),i.__exportStar(r(5720),t);var c=r(9849);Object.defineProperty(t,"AUTH_STATE",{enumerable:!0,get:function(){return c.AUTH_STATE}}),Object.defineProperty(t,"AuthenticationManager",{enumerable:!0,get:function(){return c.AuthenticationManager}});var l=r(3725);Object.defineProperty(t,"WebSocketMessageProcessor",{enumerable:!0,get:function(){return l.WebSocketMessageProcessor}}),i.__exportStar(r(9749),t);var d=r(6560);Object.defineProperty(t,"MESSAGE_TYPES",{enumerable:!0,get:function(){return d.MESSAGE_TYPES}})},179:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isSupportedCommand=function(e){return[...Object.values(i.DEVICE_COMMANDS),...Object.values(i.STATION_COMMANDS),...Object.values(i.DRIVER_COMMANDS),...Object.values(i.SERVER_COMMANDS)].includes(e)};const i=r(9300)},181:e=>{"use strict";e.exports=require("buffer")},299:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},333:function(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),o=0;o<r.length;o++)"default"!==r[o]&&s(t,e,r[o]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.StreamServer=void 0;const a=o(r(9278)),c=r(4434),l=r(7039),d=r(935),h=r(4793),u=r(175);class g extends c.EventEmitter{constructor(e){super(),this.isActive=!1,this.livestreamIntendedState=!1,this.livestreamActualState=!1,this.videoMetadata=null,this.metadataReceived=!1,this.lastClientActivity=0,this.ACTIVITY_TIMEOUT=3e4,this.stats={framesProcessed:0,bytesTransferred:0,lastFrameTime:null},this.snapshotResolvers=[],this.cachedSPS=null,this.cachedPPS=null,this.options={port:e.port??8080,host:e.host??"0.0.0.0",maxConnections:e.maxConnections??10,debug:e.debug??!1,logger:e.logger,wsClient:e.wsClient,serialNumber:e.serialNumber},this.logger=e.logger??new l.Logger({name:"StreamServer",minLevel:3}),this.connectionManager=new d.ConnectionManager(this.logger),this.h264Parser=new h.H264Parser(this.logger),this.setupEventHandlers(),this.setupWebSocketListener()}setupEventHandlers(){this.connectionManager.on("clientConnected",async(e,t)=>{const r=this.connectionManager.getActiveConnectionCount()-1;this.logger.info(`Client connected: ${e} from ${t.remoteAddress}:${t.remotePort}`),this.emit("clientConnected",e,t),this.sendCachedHeaders(e),0===r&&(this.livestreamIntendedState=!0,this.lastClientActivity=Date.now(),this.startActivityMonitoring(),await this.ensureLivestreamState())}),this.connectionManager.on("clientDisconnected",async e=>{const t=this.connectionManager.getActiveConnectionCount()+1;this.logger.info(`Client disconnected: ${e}`),this.emit("clientDisconnected",e),1===t&&(this.livestreamIntendedState=!1,this.stopActivityMonitoring(),await this.ensureLivestreamState())})}sendCachedHeaders(e){this.cachedSPS||this.cachedPPS?(this.cachedSPS&&(this.logger.debug(`Sending cached SPS header (${this.cachedSPS.length} bytes) to ${e}`),this.connectionManager.sendToClient(e,this.cachedSPS)),this.cachedPPS&&(this.logger.debug(`Sending cached PPS header (${this.cachedPPS.length} bytes) to ${e}`),this.connectionManager.sendToClient(e,this.cachedPPS))):this.logger.debug(`No cached SPS/PPS headers available for client ${e}`)}startActivityMonitoring(){this.stopActivityMonitoring(),this.activityCheckInterval=setInterval(()=>{const e=Date.now()-this.lastClientActivity;this.cleanupStaleConnections();const t=this.connectionManager.getActiveConnectionCount();e>this.ACTIVITY_TIMEOUT&&0===t?(this.logger.info(`ðŸ•’ No client activity for ${Math.round(e/1e3)}s and no active clients, stopping camera stream`),this.livestreamIntendedState=!1,this.stopActivityMonitoring(),this.ensureLivestreamState()):0===t&&this.livestreamIntendedState&&this.logger.debug("No active clients but stream is intended to run - waiting for connections")},5e3),this.logger.debug("Started client activity monitoring")}stopActivityMonitoring(){this.activityCheckInterval&&(clearInterval(this.activityCheckInterval),this.activityCheckInterval=void 0,this.logger.debug("Stopped client activity monitoring"))}cleanupStaleConnections(){const e=this.connectionManager.getConnectionStats(),t=Date.now();let r=0;for(const[i,s]of Object.entries(e)){const e=t-s.connectedAt.getTime();e>3e5&&(this.logger.info(`Cleaning up stale connection: ${i} (age: ${Math.round(e/1e3)}s)`),r++)}r>0&&this.logger.debug(`Identified ${r} stale connections for cleanup`)}setupWebSocketListener(){this.logger.info(`Setting up WebSocket listener for device: ${this.options.serialNumber}`),this.eventRemover=this.options.wsClient.addEventListener(u.DEVICE_EVENTS.LIVESTREAM_VIDEO_DATA,e=>{if(e.serialNumber!==this.options.serialNumber)return;this.stats.framesProcessed<3&&(this.logger.debug(`Received video data event for ${e.serialNumber}: ${e.buffer.data.length} bytes, metadata present: ${!!e.metadata}`),e.metadata&&this.logger.debug(`Video metadata: codec=${e.metadata.videoCodec}, ${e.metadata.videoWidth}x${e.metadata.videoHeight} @ ${e.metadata.videoFPS}fps`)),!this.metadataReceived&&e.metadata&&(this.videoMetadata={videoCodec:e.metadata.videoCodec,videoFPS:e.metadata.videoFPS,videoWidth:e.metadata.videoWidth,videoHeight:e.metadata.videoHeight},this.metadataReceived=!0,this.logger.info(`ðŸ“ Captured video metadata: ${this.videoMetadata.videoWidth}x${this.videoMetadata.videoHeight} @ ${this.videoMetadata.videoFPS}fps, codec: ${this.videoMetadata.videoCodec}`),this.emit("metadataReceived",this.videoMetadata)),this.livestreamActualState||(this.livestreamActualState=!0,this.logger.info("ðŸ“¹ Livestream confirmed active - receiving video data"));const t=this.connectionManager.getActiveConnectionCount();t>0?this.logger.debug(`Received video data event for ${e.serialNumber}: ${e.buffer.data.length} bytes (${t} active clients)`):this.stats.framesProcessed%10==0&&this.logger.debug(`Received video data event for ${e.serialNumber}: ${e.buffer.data.length} bytes (no active clients, frame ${this.stats.framesProcessed})`);const r=Buffer.isBuffer(e.buffer.data)?e.buffer.data:Buffer.from(e.buffer.data);this.streamVideo(r,Date.now(),void 0)},{source:"device",serialNumber:this.options.serialNumber}),this.logger.info(`WebSocket listener setup complete for device: ${this.options.serialNumber}`)}async ensureLivestreamState(){this.startStopTimeout&&(clearTimeout(this.startStopTimeout),this.startStopTimeout=void 0);for(let e=1;e<=3;e++)try{let t=!1;try{t=(await this.options.wsClient.commands.device(this.options.serialNumber).isLivestreaming()).livestreaming,this.logger.debug(`Current device livestream status: ${t}`)}catch(e){this.logger.warn("Failed to check livestream status, continuing with command:",e.message||e)}this.livestreamIntendedState&&!t?(this.logger.info(`ðŸŽ¥ Starting livestream (attempt ${e}/3)`),await this.options.wsClient.commands.device(this.options.serialNumber).startLivestream(),this.logger.info("âœ… Livestream start command sent successfully"),this.startStopTimeout=setTimeout(()=>{this.livestreamIntendedState&&!this.livestreamActualState&&(this.logger.warn("âš ï¸ Livestream start timeout - no video data received, will retry"),this.ensureLivestreamState())},3e4)):this.livestreamIntendedState&&t?this.logger.debug("Livestream already running as desired"):!this.livestreamIntendedState&&t?(this.logger.info(`ðŸ›‘ Stopping livestream (attempt ${e}/3)`),await this.options.wsClient.commands.device(this.options.serialNumber).stopLivestream(),this.logger.info("âœ… Livestream stop command sent successfully"),this.livestreamActualState=!1):this.logger.debug("Livestream already stopped as desired");break}catch(t){this.logger.warn(`âŒ Livestream command failed (attempt ${e}/3):`,t.message||t),3===e?(this.logger.error("âŒ Failed to set livestream state after 3 attempts"),this.emit("streamError",t)):(this.logger.info("â³ Retrying in 5 seconds..."),await new Promise(e=>setTimeout(e,5e3)))}}async start(){if(this.isActive)throw new Error("Server is already running");return new Promise((e,t)=>{this.server=a.createServer(),this.server.on("connection",e=>{this.connectionManager.handleConnection(e)}),this.server.on("error",e=>{this.logger.error("Server error:",e),this.emit("error",e),t(e)}),this.server.listen(this.options.port,this.options.host,()=>{this.isActive=!0,this.startTime=new Date,this.logger.info(`ðŸš€ Stream server started on ${this.options.host}:${this.options.port}`),this.emit("started"),e()})})}async stop(){if(!this.isActive)return;this.startStopTimeout&&(clearTimeout(this.startStopTimeout),this.startStopTimeout=void 0),this.stopActivityMonitoring();return this.connectionManager.getActiveConnectionCount()>0&&(this.livestreamIntendedState=!1,await this.ensureLivestreamState()),this.eventRemover&&(this.eventRemover(),this.eventRemover=void 0,this.logger.debug("WebSocket event listener removed")),new Promise(e=>{this.connectionManager.close(),this.server?this.server.close(()=>{this.isActive=!1,this.logger.info("ðŸ›‘ Stream server stopped"),this.emit("stopped"),e()}):(this.isActive=!1,e())})}async streamVideo(e,t,r){if(!e||0===e.length)return this.logger.warn("Cannot stream empty video data"),!1;try{if(!this.h264Parser.validateH264Data(e))return this.logger.warn("Invalid H.264 data structure"),!1;void 0===r&&(r=this.h264Parser.isKeyFrame(e));const i=this.h264Parser.extractNALUnits(e),s=i.map(e=>`${this.h264Parser.getNALTypeName(e.type)}(${e.type})`).join(", ");this.logger.debug(`Processing H.264 data: ${e.length} bytes, NALs: [${s}], keyFrame: ${r}`),i.forEach(t=>{7===t.type?(this.cachedSPS=e,this.logger.debug(`Cached SPS header (${e.length} bytes)`)):8===t.type&&(this.cachedPPS=e,this.logger.debug(`Cached PPS header (${e.length} bytes)`))});let n=!1;if(r&&this.snapshotResolvers.length>0){this.logger.debug(`Resolving ${this.snapshotResolvers.length} snapshot request(s) with keyframe data`);const t=[...this.snapshotResolvers];this.snapshotResolvers=[],t.forEach(({resolve:t})=>t(e)),n=!0}if(!this.isActive)return!!n&&(this.stats.framesProcessed++,!0);this.connectionManager.broadcast(e)&&(this.lastClientActivity=Date.now()),this.stats.framesProcessed++,this.stats.bytesTransferred+=e.length,this.stats.lastFrameTime=new Date;const o=this.connectionManager.getActiveConnectionCount();return o>0?this.logger.debug(`Streamed video frame: ${e.length} bytes to ${o} clients`):this.logger.debug(`Processed video frame: ${e.length} bytes (no active clients)`),this.emit("videoStreamed",{data:e,timestamp:t,isKeyFrame:r}),!0}catch(e){return this.logger.error("Failed to stream video data:",e),this.emit("streamError",e),!1}}getVideoMetadata(){return this.videoMetadata}async waitForVideoMetadata(e=1e4){return this.videoMetadata?(this.logger.debug("Video metadata already available"),this.videoMetadata):(this.logger.debug(`Waiting for video metadata (timeout: ${e}ms)...`),new Promise((t,r)=>{const i=setTimeout(()=>{this.logger.warn(`Timeout waiting for video metadata (${e}ms). Livestream state: ${this.livestreamActualState}, intended: ${this.livestreamIntendedState}`),r(new Error(`Timeout waiting for video metadata (${e}ms)`))},e);this.once("metadataReceived",e=>{clearTimeout(i),this.logger.debug("Video metadata received successfully"),t(e)})}))}isRunning(){return this.isActive}getStats(){const e=this.connectionManager.getConnectionStats();return{isActive:this.isActive,port:this.options.port,uptime:this.startTime?Date.now()-this.startTime.getTime():0,connections:{active:this.connectionManager.getActiveConnectionCount(),total:Object.keys(e).length,connections:e},streaming:{framesProcessed:this.stats.framesProcessed,bytesTransferred:this.stats.bytesTransferred,lastFrameTime:this.stats.lastFrameTime}}}getPort(){if(this.server){const e=this.server.address();if(e&&"object"==typeof e)return e.port}}getActiveConnectionCount(){return this.connectionManager.getActiveConnectionCount()}resetStats(){this.stats={framesProcessed:0,bytesTransferred:0,lastFrameTime:null}}async captureSnapshot(e=15e3){this.logger.info("ðŸ“¸ Capturing snapshot...");const t=this.livestreamIntendedState;try{this.livestreamIntendedState?this.logger.debug("Livestream already intended/running, waiting for keyframe"):(this.logger.debug("Starting livestream for snapshot capture"),this.livestreamIntendedState=!0,await this.ensureLivestreamState());const t=await new Promise((t,r)=>{const i=setTimeout(()=>{this.snapshotResolvers=this.snapshotResolvers.filter(e=>e.resolve!==t),r(new Error(`Snapshot capture timed out after ${e}ms - no keyframe received`))},e);this.snapshotResolvers.push({resolve:e=>{clearTimeout(i),t(e)},reject:e=>{clearTimeout(i),r(e)},timestamp:Date.now()}),this.logger.debug(`Waiting for next keyframe (timeout: ${e}ms)...`)});return this.logger.info(`âœ… Snapshot captured: ${t.length} bytes (keyframe)`),t}finally{t||(this.logger.debug("Stopping livestream after snapshot capture (was not running before)"),this.livestreamIntendedState=!1,this.ensureLivestreamState().catch(e=>{this.logger.warn(`Failed to stop livestream after snapshot: ${e}`)}))}}}t.StreamServer=g},626:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},741:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ApiManager=void 0;const i=r(9866),s=r(8700),n=r(5494),o=r(5679),a=r(179),c=r(4872);t.ApiManager=class{constructor(e,t){this.logger=t,this.CLIENT_MIN_SCHEMA=13,this.CLIENT_PREFERRED_SCHEMA=21,this.eventListeners=new Map,this.listenerIdCounter=0,this.errorHandlers=[],this.pendingCaptcha=null,this.pendingMfa=null,this.stateManager=new s.ClientStateManager(t),this.client=new i.WebSocketClient(e,this.stateManager,t),this.setupEventHandlers()}getState(){return this.stateManager.getState()}onStateChange(e){return this.stateManager.onStateChange(e)}get commands(){return this._enhancedCommands||(this._enhancedCommands=new c.EnhancedCommandAPI(this)),this._enhancedCommands}addEventListener(e,t,r){const i=`listener_${e}_${++this.listenerIdCounter}`,s={id:i,eventType:e,eventCallback:t,source:r?.source,serialNumber:r?.serialNumber};return this.eventListeners.set(i,s),this.stateManager.setEventListenerCount(this.eventListeners.size),()=>{const e=this.eventListeners.delete(i);return e&&this.stateManager.setEventListenerCount(this.eventListeners.size),e}}removeEventListener(e){const t=this.eventListeners.delete(e);return t&&this.stateManager.setEventListenerCount(this.eventListeners.size),t}removeEventListenersByType(e){let t=0;for(const[r,i]of this.eventListeners)i.eventType===e&&(this.eventListeners.delete(r),t++);return this.stateManager.setEventListenerCount(this.eventListeners.size),t}removeEventListenersByTypes(e){let t=0;const r=new Set(e);for(const[e,i]of this.eventListeners)r.has(i.eventType)&&(this.eventListeners.delete(e),t++);return this.stateManager.setEventListenerCount(this.eventListeners.size),t}removeEventListenersBySerialNumber(e,t){let r=0;for(const[i,s]of this.eventListeners)s.serialNumber!==e||t&&s.source!==t||(this.eventListeners.delete(i),r++);return this.stateManager.setEventListenerCount(this.eventListeners.size),r}removeAllEventListeners(){const e=this.eventListeners.size;return this.eventListeners.clear(),this.stateManager.setEventListenerCount(0),e}getEventListeners(){return Array.from(this.eventListeners.values()).map(e=>({id:e.id,eventType:e.eventType,source:e.source,serialNumber:e.serialNumber}))}async connect(){try{await this.client.connect()}catch(e){throw this.stateManager.setError(e),e}}disconnect(){this.client.disconnect()}isConnected(){return this.stateManager.isReady()}isDriverConnected(){return this.stateManager.getState().driverConnected}getSchemaInfo(){return this.stateManager.getState().schemaInfo}async sendCommand(e,t={}){if(e!==n.SERVER_COMMANDS.SET_API_SCHEMA&&!this.stateManager.isReady())throw new Error("Client not ready. Cannot send commands.");if(!(0,a.isSupportedCommand)(e))throw new Error(`Unsupported command: ${e}`);const r={messageId:this.generateMessageId(e),command:e,...t};let i;for(let t=1;t<=3;t++)try{return await this.client.sendMessage(r)}catch(r){if(i=r,this.logger&&this.logger.info(`sendCommand failed (attempt ${t}/3) for command: ${e}`,r),t<3){const e=250*Math.pow(2,t-1),r=.1*Math.random()*e;await new Promise(t=>setTimeout(t,e+r))}}throw i||new Error(`sendCommand failed for command: ${e} after 3 attempts`)}async connectDriver(){if(!this.stateManager.isReady())throw new Error("Client not ready. Cannot connect driver.");await this.sendCommand(o.DRIVER_COMMANDS.CONNECT),this.stateManager.setDriverConnected(!0)}async startListening(){if(!this.stateManager.isReady())throw new Error("Client not ready. Cannot start listening.");const e=await this.sendCommand(n.SERVER_COMMANDS.START_LISTENING),t=e.state.driver.connected;return this.logger&&this.logger.info(`startListening response: driver connected = ${t}`),this.stateManager.setDriverConnected(t),e}setupEventHandlers(){this.client.onConnected(()=>{}),this.client.onDisconnected(()=>{this.stateManager.setDriverConnected(!1)}),this.client.onVersionMessage(async e=>{try{await this.handleVersionMessage(e)}catch(e){this.stateManager.setError(e),this.errorHandlers.forEach(t=>{try{t(e)}catch(e){this.logger.error("Error in error handler:",e)}})}}),this.client.onEventMessage(e=>{this.handleEventMessage(e)}),this.client.onError(e=>{this.stateManager.setError(e),this.errorHandlers.forEach(t=>{try{t(e)}catch(e){this.logger.error("Error in error handler:",e)}})})}async handleVersionMessage(e){const t=e.minSchemaVersion,r=e.maxSchemaVersion,i=r>=this.CLIENT_MIN_SCHEMA,s=i?this.CLIENT_PREFERRED_SCHEMA>=t&&this.CLIENT_PREFERRED_SCHEMA<=r?this.CLIENT_PREFERRED_SCHEMA:Math.max(this.CLIENT_MIN_SCHEMA,r):0,o={clientMinSchema:this.CLIENT_MIN_SCHEMA,clientPreferredSchema:this.CLIENT_PREFERRED_SCHEMA,serverMinSchema:t,serverMaxSchema:r,negotiatedSchema:s,isCompatible:i};if(this.stateManager.setSchemaInfo(o),!i){const e=new Error(`Schema incompatibility: Server supports ${t}-${r}, Client requires minimum ${this.CLIENT_MIN_SCHEMA} (preferred ${this.CLIENT_PREFERRED_SCHEMA})`);throw this.stateManager.setError(e),e}const a=this.CLIENT_PREFERRED_SCHEMA>=t&&this.CLIENT_PREFERRED_SCHEMA<=r?this.CLIENT_PREFERRED_SCHEMA:s;try{await this.sendCommand(n.SERVER_COMMANDS.SET_API_SCHEMA,{schemaVersion:a}),o.negotiatedSchema=a,this.stateManager.setSchemaInfo(o),this.stateManager.setSchemaSetupComplete(!0)}catch(e){throw this.stateManager.setError(e),e}}handleEventMessage(e){const t=e.event,r=t?.event;if(this.handleDriverConnectionStateEvents(t),0===this.eventListeners.size)return;const i=[];for(const e of this.eventListeners.values())e.eventType===r&&i.push(e);if(0!==i.length)for(const e of i)try{if(e.source&&t?.source!==e.source)continue;if(e.serialNumber&&(!t||!("serialNumber"in t)||t.serialNumber!==e.serialNumber))continue;e.eventCallback(t)}catch(e){this.logger?this.logger.error("Error in event listener:",e):console.error("Error in event listener:",e)}}handleDriverConnectionStateEvents(e){if(e&&"object"==typeof e&&e.source&&e.event&&"driver"===e.source)switch(e.event){case o.DRIVER_EVENTS.CONNECTED:this.logger&&this.logger.info("Driver connected event received, updating state to connected"),this.stateManager.setDriverConnected(!0);break;case o.DRIVER_EVENTS.DISCONNECTED:this.logger&&this.logger.info("Driver disconnected event received, updating state to disconnected"),this.stateManager.setDriverConnected(!1);break;case o.DRIVER_EVENTS.CAPTCHA_REQUEST:this.logger&&this.logger.info("CAPTCHA request event received"),this.handleCaptchaRequest(e);break;case o.DRIVER_EVENTS.VERIFY_CODE:this.logger&&this.logger.info("MFA verification code request event received"),this.handleMfaRequest(e)}}handleCaptchaRequest(e){const t=e.captchaId,r=e.captcha;this.logger&&this.logger.info(`CAPTCHA required - ID: ${t}`),this.pendingCaptcha={captchaId:t,captcha:r}}handleMfaRequest(e){const t=e.methods||[];this.logger&&this.logger.info(`MFA verification required - methods: ${t.join(", ")}`),this.pendingMfa={methods:t}}generateMessageId(e){return`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getPendingCaptcha(){return this.pendingCaptcha}clearPendingCaptcha(){this.pendingCaptcha=null}getPendingMfa(){return this.pendingMfa}clearPendingMfa(){this.pendingMfa=null}onError(e){this.errorHandlers.push(e)}}},848:(e,t,r)=>{"use strict";const i=r(7051);i.createWebSocketStream=r(1202),i.Server=r(5695),i.Receiver=r(1611),i.Sender=r(1031),i.WebSocket=i,i.WebSocketServer=i.Server,e.exports=i},935:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionManager=void 0;const i=r(4434);class s extends i.EventEmitter{constructor(e){super(),this.connections=new Map,this.connectionInfo=new Map,this.connectionCounter=0,this.maxConnections=10,this.logger=e}handleConnection(e){if(this.connections.size>=this.maxConnections)return this.logger.warn(`Connection limit reached (${this.maxConnections}), rejecting connection`),void e.end();const t="conn_"+ ++this.connectionCounter,r=e.remoteAddress||"unknown",i=e.remotePort||0;this.connections.set(t,e);const s={id:t,remoteAddress:r,remotePort:i,connectedAt:new Date,bytesWritten:0,isActive:!0};this.connectionInfo.set(t,s),this.logger.info(`Client connected: ${t} from ${r}:${i}`),e.on("close",()=>{this.handleDisconnection(t)}),e.on("error",e=>{this.logger.error(`Socket error for ${t}:`,e),this.handleDisconnection(t)}),e.setNoDelay(!0),e.setKeepAlive(!0,3e4),this.emit("clientConnected",t,s)}handleDisconnection(e){const t=this.connections.get(e),r=this.connectionInfo.get(e);t&&(t.removeAllListeners(),t.destroy(),this.connections.delete(e)),r&&(r.isActive=!1,this.connectionInfo.delete(e)),this.logger.info(`Client disconnected: ${e}`),this.emit("clientDisconnected",e)}sendToClient(e,t){const r=this.connections.get(e);if(!r)return this.logger.warn(`Cannot send to ${e}: connection not found`),!1;try{if(r.writable){r.write(t);const i=this.connectionInfo.get(e);return i&&(i.bytesWritten+=t.length),this.logger.debug(`Sent ${t.length} bytes to ${e}`),!0}return this.logger.warn(`Socket not writable for ${e}`),this.handleDisconnection(e),!1}catch(t){return this.logger.error(`Failed to write to ${e}:`,t),this.handleDisconnection(e),!1}}broadcast(e){if(0===this.connections.size)return!1;let t=0;const r=this.connections.size;for(const[r,i]of this.connections)try{if(i.writable){i.write(e);const s=this.connectionInfo.get(r);s&&(s.bytesWritten+=e.length),t++}else this.logger.warn(`Socket not writable for ${r}`),this.handleDisconnection(r)}catch(e){this.logger.error(`Failed to write to ${r}:`,e),this.handleDisconnection(r)}return this.logger.debug(`Broadcast to ${t}/${r} clients: ${e.length} bytes`),t>0}getActiveConnectionCount(){return this.connections.size}getConnectionStats(){const e={};for(const[t,r]of this.connectionInfo)e[t]={...r};return e}close(){this.logger.info(`Closing ${this.connections.size} connections`);for(const[e,t]of this.connections)try{t.removeAllListeners(),t.destroy()}catch(t){this.logger.error(`Error closing connection ${e}:`,t)}this.connections.clear(),this.connectionInfo.clear(),this.removeAllListeners()}}t.ConnectionManager=s},979:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(5608);i.__exportStar(r(5494),t),i.__exportStar(r(2193),t),i.__exportStar(r(626),t),i.__exportStar(r(3302),t),i.__exportStar(r(1139),t)},1031:(e,t,r)=>{"use strict";const{Duplex:i}=r(2203),{randomFillSync:s}=r(6982),n=r(6978),{EMPTY_BUFFER:o,kWebSocket:a,NOOP:c}=r(4033),{isBlob:l,isValidStatusCode:d}=r(3977),{mask:h,toBuffer:u}=r(7213),g=Symbol("kByteLength"),p=Buffer.alloc(4),m=8192;let f,S=m;class y{constructor(e,t,r){this._extensions=t||{},r&&(this._generateMask=r,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=c,this[a]=void 0}static frame(e,t){let r,i,n=!1,o=2,a=!1;t.mask&&(r=t.maskBuffer||p,t.generateMask?t.generateMask(r):(S===m&&(void 0===f&&(f=Buffer.alloc(m)),s(f,0,m),S=0),r[0]=f[S++],r[1]=f[S++],r[2]=f[S++],r[3]=f[S++]),a=0===(r[0]|r[1]|r[2]|r[3]),o=6),"string"==typeof e?i=t.mask&&!a||void 0===t[g]?(e=Buffer.from(e)).length:t[g]:(i=e.length,n=t.mask&&t.readOnly&&!a);let c=i;i>=65536?(o+=8,c=127):i>125&&(o+=2,c=126);const l=Buffer.allocUnsafe(n?i+o:o);return l[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(l[0]|=64),l[1]=c,126===c?l.writeUInt16BE(i,2):127===c&&(l[2]=l[3]=0,l.writeUIntBE(i,4,6)),t.mask?(l[1]|=128,l[o-4]=r[0],l[o-3]=r[1],l[o-2]=r[2],l[o-1]=r[3],a?[l,e]:n?(h(e,r,l,o,i),[l]):(h(e,r,e,0,i),[l,e])):[l,e]}close(e,t,r,i){let s;if(void 0===e)s=o;else{if("number"!=typeof e||!d(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const r=Buffer.byteLength(t);if(r>123)throw new RangeError("The message must not be greater than 123 bytes");s=Buffer.allocUnsafe(2+r),s.writeUInt16BE(e,0),"string"==typeof t?s.write(t,2):s.set(t,2)}else s=Buffer.allocUnsafe(2),s.writeUInt16BE(e,0)}const n={[g]:s.length,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,s,!1,n,i]):this.sendFrame(y.frame(s,n),i)}ping(e,t,r){let i,s;if("string"==typeof e?(i=Buffer.byteLength(e),s=!1):l(e)?(i=e.size,s=!1):(i=(e=u(e)).length,s=u.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const n={[g]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:s,rsv1:!1};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,n,r]):this.getBlobData(e,!1,n,r):0!==this._state?this.enqueue([this.dispatch,e,!1,n,r]):this.sendFrame(y.frame(e,n),r)}pong(e,t,r){let i,s;if("string"==typeof e?(i=Buffer.byteLength(e),s=!1):l(e)?(i=e.size,s=!1):(i=(e=u(e)).length,s=u.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");const n={[g]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:s,rsv1:!1};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,n,r]):this.getBlobData(e,!1,n,r):0!==this._state?this.enqueue([this.dispatch,e,!1,n,r]):this.sendFrame(y.frame(e,n),r)}send(e,t,r){const i=this._extensions[n.extensionName];let s,o,a=t.binary?2:1,c=t.compress;"string"==typeof e?(s=Buffer.byteLength(e),o=!1):l(e)?(s=e.size,o=!1):(s=(e=u(e)).length,o=u.readOnly),this._firstFragment?(this._firstFragment=!1,c&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(c=s>=i._threshold),this._compress=c):(c=!1,a=0),t.fin&&(this._firstFragment=!0);const d={[g]:s,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:o,rsv1:c};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,d,r]):this.getBlobData(e,this._compress,d,r):0!==this._state?this.enqueue([this.dispatch,e,this._compress,d,r]):this.dispatch(e,this._compress,d,r)}getBlobData(e,t,r,i){this._bufferedBytes+=r[g],this._state=2,e.arrayBuffer().then(e=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(_,this,e,i)}this._bufferedBytes-=r[g];const s=u(e);t?this.dispatch(s,t,r,i):(this._state=0,this.sendFrame(y.frame(s,r),i),this.dequeue())}).catch(e=>{process.nextTick(v,this,e,i)})}dispatch(e,t,r,i){if(!t)return void this.sendFrame(y.frame(e,r),i);const s=this._extensions[n.extensionName];this._bufferedBytes+=r[g],this._state=1,s.compress(e,r.fin,(e,t)=>{if(this._socket.destroyed){return void _(this,new Error("The socket was closed while data was being compressed"),i)}this._bufferedBytes-=r[g],this._state=0,r.readOnly=!1,this.sendFrame(y.frame(t,r),i),this.dequeue()})}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][g],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][g],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}function _(e,t,r){"function"==typeof r&&r(t);for(let r=0;r<e._queue.length;r++){const i=e._queue[r],s=i[i.length-1];"function"==typeof s&&s(t)}}function v(e,t,r){_(e,t,r),e.onerror(t)}e.exports=y},1135:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.prettyLogStyles=void 0,t.prettyLogStyles={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},1139:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(5494)},1187:(e,t)=>{"use strict";var r,i,s,n,o,a,c,l,d,h,u;Object.defineProperty(t,"__esModule",{value:!0}),t.PanTiltDirection=t.WatermarkMode=t.VideoQuality=t.SoundDetectionType=t.MotionDetectionType=t.LockStatus=t.ContinuousRecordingType=t.NotificationType=t.ChargingStatus=t.PowerWorkingMode=t.DeviceType=t.DEVICE_EVENTS=t.DEVICE_COMMANDS=void 0,t.DEVICE_COMMANDS={GET_PROPERTIES_METADATA:"device.get_properties_metadata",GET_PROPERTIES:"device.get_properties",SET_PROPERTY:"device.set_property",HAS_PROPERTY:"device.has_property",GET_COMMANDS:"device.get_commands",HAS_COMMAND:"device.has_command",START_LIVESTREAM:"device.start_livestream",STOP_LIVESTREAM:"device.stop_livestream",IS_LIVESTREAMING:"device.is_livestreaming",START_RTSP_LIVESTREAM:"device.start_rtsp_livestream",STOP_RTSP_LIVESTREAM:"device.stop_rtsp_livestream",IS_RTSP_LIVESTREAMING:"device.is_rtsp_livestreaming",START_DOWNLOAD:"device.start_download",CANCEL_DOWNLOAD:"device.cancel_download",IS_DOWNLOADING:"device.is_downloading",TRIGGER_ALARM:"device.trigger_alarm",RESET_ALARM:"device.reset_alarm",PAN_AND_TILT:"device.pan_and_tilt",CALIBRATE:"device.calibrate",QUICK_RESPONSE:"device.quick_response",GET_VOICES:"device.get_voices",START_TALKBACK:"device.start_talkback",STOP_TALKBACK:"device.stop_talkback",IS_TALKBACK_ONGOING:"device.is_talkback_ongoing",TALKBACK_AUDIO_DATA:"device.talkback_audio_data",CALIBRATE_LOCK:"device.calibrate_lock",UNLOCK:"device.unlock",SNOOZE:"device.snooze",ADD_USER:"device.add_user",DELETE_USER:"device.delete_user",GET_USERS:"device.get_users",UPDATE_USER:"device.update_user",UPDATE_USER_PASSCODE:"device.update_user_passcode",UPDATE_USER_SCHEDULE:"device.update_user_schedule",VERIFY_PIN:"device.verify_pin",OPEN:"device.open",SET_STATUS_LED:"device.set_status_led",SET_AUTO_NIGHT_VISION:"device.set_auto_night_vision",SET_MOTION_DETECTION:"device.set_motion_detection",SET_SOUND_DETECTION:"device.set_sound_detection",SET_PET_DETECTION:"device.set_pet_detection",SET_RTSP_STREAM:"device.set_rtsp_stream",SET_ANTI_THEFT_DETECTION:"device.set_anti_theft_detection",SET_WATERMARK:"device.set_watermark",ENABLE_DEVICE:"device.enable_device",LOCK_DEVICE:"device.lock_device"},t.DEVICE_EVENTS={DEVICE_ADDED:"device added",DEVICE_REMOVED:"device removed",PROPERTY_CHANGED:"property changed",COMMAND_RESULT:"command result",LIVESTREAM_STARTED:"livestream started",LIVESTREAM_STOPPED:"livestream stopped",LIVESTREAM_VIDEO_DATA:"livestream video data",LIVESTREAM_AUDIO_DATA:"livestream audio data",GOT_RTSP_URL:"got rtsp url",DOWNLOAD_STARTED:"download started",DOWNLOAD_FINISHED:"download finished",DOWNLOAD_VIDEO_DATA:"download video data",DOWNLOAD_AUDIO_DATA:"download audio data",MOTION_DETECTED:"motion detected",PERSON_DETECTED:"person detected",STRANGER_PERSON_DETECTED:"stranger person detected",CRYING_DETECTED:"crying detected",SOUND_DETECTED:"sound detected",PET_DETECTED:"pet detected",VEHICLE_DETECTED:"vehicle detected",DOG_DETECTED:"dog detected",DOG_LICK_DETECTED:"dog lick detected",DOG_POOP_DETECTED:"dog poop detected",RADAR_MOTION_DETECTED:"radar motion detected",RINGS:"rings",SENSOR_OPEN:"sensor open",PACKAGE_DELIVERED:"package delivered",PACKAGE_STRANDED:"package stranded",PACKAGE_TAKEN:"package taken",SOMEONE_LOITERING:"someone loitering",LOCKED:"locked",WRONG_TRY_PROTECT_ALARM:"wrong try-protect alarm",LONG_TIME_NOT_CLOSE:"long time not close",LOW_BATTERY:"low battery",JAMMED:"jammed",ALARM_911:"alarm 911",SHAKE_ALARM:"shake alarm",TAMPERING:"tampering",LOW_TEMPERATURE:"low temperature",HIGH_TEMPERATURE:"high temperature",PIN_INCORRECT:"pin incorrect",LID_STUCK:"lid stuck",BATTERY_FULLY_CHARGED:"battery fully charged",TALKBACK_STARTED:"talkback started",TALKBACK_STOPPED:"talkback stopped",USER_ADDED:"user added",USER_DELETED:"user deleted",USER_ERROR:"user error",USER_USERNAME_UPDATED:"user username updated",USER_SCHEDULE_UPDATED:"user schedule updated",USER_PASSCODE_UPDATED:"user passcode updated",PIN_VERIFIED:"pin verified"},function(e){e[e.STATION=0]="STATION",e[e.CAMERA=1]="CAMERA",e[e.SENSOR=2]="SENSOR",e[e.FLOODLIGHT=3]="FLOODLIGHT",e[e.CAMERA_E=4]="CAMERA_E",e[e.DOORBELL=5]="DOORBELL",e[e.BATTERY_DOORBELL=7]="BATTERY_DOORBELL",e[e.CAMERA2C=8]="CAMERA2C",e[e.CAMERA2=9]="CAMERA2",e[e.MOTION_SENSOR=10]="MOTION_SENSOR",e[e.KEYPAD=11]="KEYPAD",e[e.CAMERA2_PRO=14]="CAMERA2_PRO",e[e.CAMERA2C_PRO=15]="CAMERA2C_PRO",e[e.BATTERY_DOORBELL_2=16]="BATTERY_DOORBELL_2",e[e.HB3=18]="HB3",e[e.CAMERA3=19]="CAMERA3",e[e.CAMERA3C=23]="CAMERA3C",e[e.PROFESSIONAL_247=24]="PROFESSIONAL_247",e[e.MINIBASE_CHIME=25]="MINIBASE_CHIME",e[e.CAMERA3_PRO=26]="CAMERA3_PRO",e[e.INDOOR_CAMERA=30]="INDOOR_CAMERA",e[e.INDOOR_PT_CAMERA=31]="INDOOR_PT_CAMERA",e[e.SOLO_CAMERA=32]="SOLO_CAMERA",e[e.SOLO_CAMERA_PRO=33]="SOLO_CAMERA_PRO",e[e.INDOOR_CAMERA_1080=34]="INDOOR_CAMERA_1080",e[e.INDOOR_PT_CAMERA_1080=35]="INDOOR_PT_CAMERA_1080",e[e.FLOODLIGHT_CAMERA_8422=37]="FLOODLIGHT_CAMERA_8422",e[e.FLOODLIGHT_CAMERA_8423=38]="FLOODLIGHT_CAMERA_8423",e[e.FLOODLIGHT_CAMERA_8424=39]="FLOODLIGHT_CAMERA_8424",e[e.INDOOR_OUTDOOR_CAMERA_1080P_NO_LIGHT=44]="INDOOR_OUTDOOR_CAMERA_1080P_NO_LIGHT",e[e.INDOOR_OUTDOOR_CAMERA_2K=45]="INDOOR_OUTDOOR_CAMERA_2K",e[e.INDOOR_OUTDOOR_CAMERA_1080P=46]="INDOOR_OUTDOOR_CAMERA_1080P",e[e.FLOODLIGHT_CAMERA_8425=47]="FLOODLIGHT_CAMERA_8425",e[e.OUTDOOR_PT_CAMERA=48]="OUTDOOR_PT_CAMERA",e[e.LOCK_BLE=50]="LOCK_BLE",e[e.LOCK_WIFI=51]="LOCK_WIFI",e[e.LOCK_BLE_NO_FINGER=52]="LOCK_BLE_NO_FINGER",e[e.LOCK_WIFI_NO_FINGER=53]="LOCK_WIFI_NO_FINGER",e[e.LOCK_8503=54]="LOCK_8503",e[e.LOCK_8530=55]="LOCK_8530",e[e.LOCK_85A3=56]="LOCK_85A3",e[e.LOCK_8592=57]="LOCK_8592",e[e.LOCK_8504=58]="LOCK_8504",e[e.SOLO_CAMERA_SPOTLIGHT_1080=60]="SOLO_CAMERA_SPOTLIGHT_1080",e[e.SOLO_CAMERA_SPOTLIGHT_2K=61]="SOLO_CAMERA_SPOTLIGHT_2K",e[e.SOLO_CAMERA_SPOTLIGHT_SOLAR=62]="SOLO_CAMERA_SPOTLIGHT_SOLAR",e[e.SOLO_CAMERA_SOLAR=63]="SOLO_CAMERA_SOLAR",e[e.SOLO_CAMERA_C210=64]="SOLO_CAMERA_C210",e[e.FLOODLIGHT_CAMERA_8426=87]="FLOODLIGHT_CAMERA_8426",e[e.SOLO_CAMERA_E30=88]="SOLO_CAMERA_E30",e[e.SMART_DROP=90]="SMART_DROP",e[e.BATTERY_DOORBELL_PLUS=91]="BATTERY_DOORBELL_PLUS",e[e.DOORBELL_SOLO=93]="DOORBELL_SOLO",e[e.BATTERY_DOORBELL_PLUS_E340=94]="BATTERY_DOORBELL_PLUS_E340",e[e.BATTERY_DOORBELL_C30=95]="BATTERY_DOORBELL_C30",e[e.BATTERY_DOORBELL_C31=96]="BATTERY_DOORBELL_C31",e[e.INDOOR_COST_DOWN_CAMERA=100]="INDOOR_COST_DOWN_CAMERA",e[e.CAMERA_GUN=101]="CAMERA_GUN",e[e.CAMERA_SNAIL=102]="CAMERA_SNAIL",e[e.INDOOR_PT_CAMERA_S350=104]="INDOOR_PT_CAMERA_S350",e[e.INDOOR_PT_CAMERA_E30=105]="INDOOR_PT_CAMERA_E30",e[e.CAMERA_FG=110]="CAMERA_FG",e[e.CAMERA_GARAGE_T8453_COMMON=131]="CAMERA_GARAGE_T8453_COMMON",e[e.CAMERA_GARAGE_T8452=132]="CAMERA_GARAGE_T8452",e[e.CAMERA_GARAGE_T8453=133]="CAMERA_GARAGE_T8453",e[e.SMART_SAFE_7400=140]="SMART_SAFE_7400",e[e.SMART_SAFE_7401=141]="SMART_SAFE_7401",e[e.SMART_SAFE_7402=142]="SMART_SAFE_7402",e[e.SMART_SAFE_7403=143]="SMART_SAFE_7403",e[e.WALL_LIGHT_CAM=151]="WALL_LIGHT_CAM",e[e.SMART_TRACK_LINK=157]="SMART_TRACK_LINK",e[e.SMART_TRACK_CARD=159]="SMART_TRACK_CARD",e[e.LOCK_8502=180]="LOCK_8502",e[e.LOCK_8506=184]="LOCK_8506",e[e.WALL_LIGHT_CAM_81A0=10005]="WALL_LIGHT_CAM_81A0",e[e.INDOOR_PT_CAMERA_C220=10008]="INDOOR_PT_CAMERA_C220",e[e.INDOOR_PT_CAMERA_C210=10009]="INDOOR_PT_CAMERA_C210"}(r||(t.DeviceType=r={})),function(e){e[e.BATTERY_POWERED=0]="BATTERY_POWERED",e[e.SOLAR_POWERED=1]="SOLAR_POWERED",e[e.PLUGGED_IN=2]="PLUGGED_IN"}(i||(t.PowerWorkingMode=i={})),function(e){e[e.NOT_CHARGING=0]="NOT_CHARGING",e[e.CHARGING=1]="CHARGING"}(s||(t.ChargingStatus=s={})),function(e){e[e.MOST_EFFICIENT=1]="MOST_EFFICIENT",e[e.INCLUDE_THUMBNAIL=2]="INCLUDE_THUMBNAIL",e[e.FULL_EFFECT=3]="FULL_EFFECT"}(n||(t.NotificationType=n={})),function(e){e[e.ALWAYS=0]="ALWAYS",e[e.ONLY_DURING_EVENTS=1]="ONLY_DURING_EVENTS"}(o||(t.ContinuousRecordingType=o={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNLOCKED=1]="UNLOCKED",e[e.LOCKED=2]="LOCKED",e[e.MECHANICAL_ANOMALY=3]="MECHANICAL_ANOMALY",e[e.LOCKED_COMPLETED=4]="LOCKED_COMPLETED",e[e.UNLOCK_COMPLETED=5]="UNLOCK_COMPLETED"}(a||(t.LockStatus=a={})),function(e){e[e.HUMAN_ONLY=0]="HUMAN_ONLY",e[e.ALL_MOTIONS=1]="ALL_MOTIONS",e[e.HUMAN_AND_PET=2]="HUMAN_AND_PET"}(c||(t.MotionDetectionType=c={})),function(e){e[e.ALL_SOUNDS=0]="ALL_SOUNDS",e[e.HUMAN_VOICE=1]="HUMAN_VOICE",e[e.CRYING=2]="CRYING"}(l||(t.SoundDetectionType=l={})),function(e){e[e.LOW=0]="LOW",e[e.MEDIUM=1]="MEDIUM",e[e.HIGH=2]="HIGH",e[e.ULTRA=3]="ULTRA"}(d||(t.VideoQuality=d={})),function(e){e[e.OFF=0]="OFF",e[e.TIMESTAMP=1]="TIMESTAMP",e[e.TIMESTAMP_AND_LOGO=2]="TIMESTAMP_AND_LOGO"}(h||(t.WatermarkMode=h={})),function(e){e[e.ROTATE360=0]="ROTATE360",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.UP=3]="UP",e[e.DOWN=4]="DOWN"}(u||(t.PanTiltDirection=u={}))},1202:(e,t,r)=>{"use strict";r(7051);const{Duplex:i}=r(2203);function s(e){e.emit("close")}function n(){!this.destroyed&&this._writableState.finished&&this.destroy()}function o(e){this.removeListener("error",o),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}e.exports=function(e,t){let r=!0;const a=new i({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",function(t,r){const i=!r&&a._readableState.objectMode?t.toString():t;a.push(i)||e.pause()}),e.once("error",function(e){a.destroyed||(r=!1,a.destroy(e))}),e.once("close",function(){a.destroyed||a.push(null)}),a._destroy=function(t,i){if(e.readyState===e.CLOSED)return i(t),void process.nextTick(s,a);let n=!1;e.once("error",function(e){n=!0,i(e)}),e.once("close",function(){n||i(t),process.nextTick(s,a)}),r&&e.terminate()},a._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),a._readableState.endEmitted&&a.destroy()):(e._socket.once("finish",function(){t()}),e.close())):e.once("open",function(){a._final(t)})},a._read=function(){e.isPaused&&e.resume()},a._write=function(t,r,i){e.readyState!==e.CONNECTING?e.send(t,i):e.once("open",function(){a._write(t,r,i)})},a.on("end",n),a.on("error",o),a}},1277:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(5608);i.__exportStar(r(9300),t),i.__exportStar(r(5361),t)},1514:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(1187)},1528:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},1611:(e,t,r)=>{"use strict";const{Writable:i}=r(2203),s=r(6978),{BINARY_TYPES:n,EMPTY_BUFFER:o,kStatusCode:a,kWebSocket:c}=r(4033),{concat:l,toArrayBuffer:d,unmask:h}=r(7213),{isValidStatusCode:u,isValidUTF8:g}=r(3977),p=Buffer[Symbol.species];e.exports=class extends i{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||n[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[c]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,r){if(8===this._opcode&&0==this._state)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new p(t.buffer,t.byteOffset+e,t.length-e),new p(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const r=this._buffers[0],i=t.length-e;e>=r.length?t.set(this._buffers.shift(),i):(t.set(new Uint8Array(r.buffer,r.byteOffset,e),i),this._buffers[0]=new p(r.buffer,r.byteOffset+e,r.length-e)),e-=r.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const r=!(64&~t[0]);if(r&&!this._extensions[s.extensionName]){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=r}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(r){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),r=t.readUInt32BE(0);if(r>Math.pow(2,21)-1){return void e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}this._payloadLength=r*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){return void e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=o;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!==(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&h(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[s.extensionName].decompress(e,this._fin,(e,r)=>{if(e)return t(e);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(r)}this.dataMessage(t),0===this._state&&this.startLoop(t)})}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let i;i="nodebuffer"===this._binaryType?l(r,t):"arraybuffer"===this._binaryType?d(l(r,t)):"blob"===this._binaryType?new Blob(r):r,this._allowSynchronousEvents?(this.emit("message",i,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",i,!0),this._state=0,this.startLoop(e)}))}else{const i=l(r,t);if(!this._skipUTF8Validation&&!g(i)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",i,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",i,!1),this._state=0,this.startLoop(e)}))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)}));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,o),this.end();else{const r=e.readUInt16BE(0);if(!u(r)){const e=this.createError(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const i=new p(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!g(i)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",r,i),this.end()}this._state=0}}createError(e,t,r,i,s){this._loop=!1,this._errored=!0;const n=new e(r?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(n,this.createError),n.code=s,n[a]=i,n}}},2009:(e,t,r)=>{"use strict";const{tokenChars:i}=r(3977);function s(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}e.exports={format:function(e){return Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>[t].concat(Object.keys(e).map(t=>{let r=e[t];return Array.isArray(r)||(r=[r]),r.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);let r,n,o=Object.create(null),a=!1,c=!1,l=!1,d=-1,h=-1,u=-1,g=0;for(;g<e.length;g++)if(h=e.charCodeAt(g),void 0===r)if(-1===u&&1===i[h])-1===d&&(d=g);else if(0===g||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError(`Unexpected character at index ${g}`);{if(-1===d)throw new SyntaxError(`Unexpected character at index ${g}`);-1===u&&(u=g);const i=e.slice(d,u);44===h?(s(t,i,o),o=Object.create(null)):r=i,d=u=-1}}else-1===u&&-1!==d&&(u=g);else if(void 0===n)if(-1===u&&1===i[h])-1===d&&(d=g);else if(32===h||9===h)-1===u&&-1!==d&&(u=g);else if(59===h||44===h){if(-1===d)throw new SyntaxError(`Unexpected character at index ${g}`);-1===u&&(u=g),s(o,e.slice(d,u),!0),44===h&&(s(t,r,o),o=Object.create(null),r=void 0),d=u=-1}else{if(61!==h||-1===d||-1!==u)throw new SyntaxError(`Unexpected character at index ${g}`);n=e.slice(d,g),d=u=-1}else if(c){if(1!==i[h])throw new SyntaxError(`Unexpected character at index ${g}`);-1===d?d=g:a||(a=!0),c=!1}else if(l)if(1===i[h])-1===d&&(d=g);else if(34===h&&-1!==d)l=!1,u=g;else{if(92!==h)throw new SyntaxError(`Unexpected character at index ${g}`);c=!0}else if(34===h&&61===e.charCodeAt(g-1))l=!0;else if(-1===u&&1===i[h])-1===d&&(d=g);else if(-1===d||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError(`Unexpected character at index ${g}`);{if(-1===d)throw new SyntaxError(`Unexpected character at index ${g}`);-1===u&&(u=g);let i=e.slice(d,u);a&&(i=i.replace(/\\/g,""),a=!1),s(o,n,i),44===h&&(s(t,r,o),o=Object.create(null),r=void 0),n=void 0,d=u=-1}}else-1===u&&(u=g);if(-1===d||l||32===h||9===h)throw new SyntaxError("Unexpected end of input");-1===u&&(u=g);const p=e.slice(d,u);return void 0===r?s(t,p,o):(void 0===n?s(o,p,!0):s(o,n,a?p.replace(/\\/g,""):p),s(t,r,o)),t}}},2189:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},2193:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},2203:e=>{"use strict";e.exports=require("stream")},2400:(e,t)=>{"use strict";function r(){return"undefined"!=typeof window&&"undefined"!=typeof document}Object.defineProperty(t,"__esModule",{value:!0}),t.safeGetCwd=function(){try{const e=globalThis?.process;if("function"==typeof e?.cwd)return e.cwd()}catch{}try{const e=globalThis?.Deno;if("function"==typeof e?.cwd)return e.cwd()}catch{}return},t.isBrowserEnvironment=r,t.consoleSupportsCssStyling=function(){if(!r())return!1;const e=globalThis?.navigator,t=e?.userAgent??"";if(/firefox/i.test(t))return!0;const i=globalThis;if(i?.CSS?.supports?.("color","#000"))return!0;return/safari/i.test(t)&&!/chrome/i.test(t)}},2584:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},2674:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},3106:e=>{"use strict";e.exports=require("zlib")},3302:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},3339:e=>{"use strict";e.exports=require("module")},3405:(e,t)=>{"use strict";var r,i,s;Object.defineProperty(t,"__esModule",{value:!0}),t.GuardMode=t.AlarmMode=t.AlarmEvent=t.STATION_EVENTS=t.STATION_COMMANDS=void 0,t.STATION_COMMANDS={REBOOT:"station.reboot",IS_CONNECTED:"station.is_connected",CONNECT:"station.connect",DISCONNECT:"station.disconnect",GET_PROPERTIES_METADATA:"station.get_properties_metadata",GET_PROPERTIES:"station.get_properties",SET_PROPERTY:"station.set_property",TRIGGER_ALARM:"station.trigger_alarm",RESET_ALARM:"station.reset_alarm",SET_GUARD_MODE:"station.set_guard_mode",GET_COMMANDS:"station.get_commands",HAS_COMMAND:"station.has_command",HAS_PROPERTY:"station.has_property",CHIME:"station.chime",DOWNLOAD_IMAGE:"station.download_image",DATABASE_QUERY_LATEST_INFO:"station.database_query_latest_info",DATABASE_QUERY_LOCAL:"station.database_query_local",DATABASE_COUNT_BY_DATE:"station.database_count_by_date",DATABASE_DELETE:"station.database_delete"},t.STATION_EVENTS={STATION_ADDED:"station added",STATION_REMOVED:"station removed",CONNECTED:"connected",DISCONNECTED:"disconnected",PROPERTY_CHANGED:"property changed",ALARM_EVENT:"alarm event",ALARM_DELAY_EVENT:"alarm delay event",ALARM_ARMED_EVENT:"alarm armed event",ALARM_ARM_DELAY_EVENT:"alarm arm delay event",GUARD_MODE_CHANGED:"guard mode changed",CURRENT_MODE_CHANGED:"current mode changed",IMAGE_DOWNLOADED:"image downloaded",DATABASE_QUERY_LATEST:"database query latest",DATABASE_QUERY_LOCAL:"database query local",DATABASE_COUNT_BY_DATE:"database count by date",DATABASE_DELETE:"database delete",COMMAND_RESULT:"command result"},function(e){e[e.HUB_STOP=0]="HUB_STOP",e[e.DEV_STOP=1]="DEV_STOP",e[e.GSENSOR=2]="GSENSOR",e[e.PIR=3]="PIR",e[e.APP=4]="APP",e[e.HOT=5]="HOT",e[e.DOOR=6]="DOOR",e[e.CAMERA_PIR=7]="CAMERA_PIR",e[e.MOTION_SENSOR=8]="MOTION_SENSOR",e[e.CAMERA_GSENSOR=9]="CAMERA_GSENSOR",e[e.CAMERA_APP=10]="CAMERA_APP",e[e.CAMERA_LINKAGE=11]="CAMERA_LINKAGE",e[e.HUB_KEYPAD=13]="HUB_KEYPAD",e[e.HUB_STOP_BY_KEYPAD=15]="HUB_STOP_BY_KEYPAD",e[e.HUB_STOP_BY_APP=16]="HUB_STOP_BY_APP",e[e.HUB_STOP_BY_HAND=17]="HUB_STOP_BY_HAND",e[e.APP_LIGHT=22]="APP_LIGHT",e[e.APP_LIGHT_SOUND=23]="APP_LIGHT_SOUND",e[e.MOTION_APP_LIGHT=24]="MOTION_APP_LIGHT",e[e.MOTION_APP_LIGHT_ALARM=25]="MOTION_APP_LIGHT_ALARM"}(r||(t.AlarmEvent=r={})),function(e){e[e.AWAY=0]="AWAY",e[e.HOME=1]="HOME",e[e.CUSTOM1=3]="CUSTOM1",e[e.CUSTOM2=4]="CUSTOM2",e[e.CUSTOM3=5]="CUSTOM3",e[e.DISARMED=63]="DISARMED"}(i||(t.AlarmMode=i={})),function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.AWAY=0]="AWAY",e[e.HOME=1]="HOME",e[e.DISARMED=63]="DISARMED",e[e.SCHEDULE=2]="SCHEDULE",e[e.GEO=47]="GEO",e[e.CUSTOM1=3]="CUSTOM1",e[e.CUSTOM2=4]="CUSTOM2",e[e.CUSTOM3=5]="CUSTOM3",e[e.OFF=6]="OFF"}(s||(t.GuardMode=s={}))},3725:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketMessageProcessor=void 0;const i=r(1187),s=r(6560);class n{constructor(e=100,t=1e3){this.messageCount=0,this.windowStart=Date.now(),this.maxMessages=e,this.windowMs=t}canProcess(){const e=Date.now();return e-this.windowStart>=this.windowMs&&(this.messageCount=0,this.windowStart=e),this.messageCount<this.maxMessages&&(this.messageCount++,!0)}getStats(){return{messageCount:this.messageCount,windowStart:this.windowStart,maxMessages:this.maxMessages,windowMs:this.windowMs}}}t.WebSocketMessageProcessor=class{constructor(e,t={}){this.processedMessages=0,this.invalidMessages=0,this.rateLimitedMessages=0,this.logger=e,this.maxMessageSize=t.maxMessageSize??5e5,this.rateLimiter=new n(t.maxMessagesPerSecond??100,t.rateLimitWindowMs??1e3)}processMessage(e){if(!this.rateLimiter.canProcess())return this.rateLimitedMessages++,this.logger?.warn("Message rate limit exceeded, dropping message"),{valid:!1,error:"Rate limit exceeded"};if(!e)return this.invalidMessages++,{valid:!1,error:"Empty message data"};let t,r;try{t=e.toString()}catch(e){return this.invalidMessages++,{valid:!1,error:"Failed to convert message to string"}}if(t.length>this.maxMessageSize){let e="unknown",r=!1;try{if(t.includes(`"${i.DEVICE_EVENTS.LIVESTREAM_VIDEO_DATA}"`)||t.includes(`"${i.DEVICE_EVENTS.LIVESTREAM_AUDIO_DATA}"`))e="livestream-data",r=!0;else{const i=JSON.parse(t.substring(0,1e3));e=i.type||i.event?.event||"no-type";r=[s.MESSAGE_TYPES.EVENT,s.MESSAGE_TYPES.RESULT].some(r=>e.includes(r)||t.includes(`"type":"${r}"`))}}catch(n){if(t.includes(`"${i.DEVICE_EVENTS.LIVESTREAM_VIDEO_DATA}"`)||t.includes(`"${i.DEVICE_EVENTS.LIVESTREAM_AUDIO_DATA}"`))e="livestream-data",r=!0;else{const i=t.includes(`"type":"${s.MESSAGE_TYPES.EVENT}"`),n=t.includes(`"type":"${s.MESSAGE_TYPES.RESULT}"`);i?(e="event",r=!0):n?(e="result",r=!0):(e="parse-error",r=!1)}}if(!r)return this.invalidMessages++,this.logger?.warn(`Message too large and not streaming data: ${t.length} bytes, type: ${e}, preview: ${t.substring(0,100)}...`),{valid:!1,error:"Message too large"};this.logger?.debug(`Large message allowed for streaming: ${t.length} bytes, type: ${e}`)}try{r=JSON.parse(t)}catch(e){return this.invalidMessages++,this.logger?.warn("Invalid JSON message:",t.substring(0,100)),{valid:!1,error:"Invalid JSON"}}const n=this.validateMessageStructure(r);return n.valid?(this.processedMessages++,{valid:!0,message:r}):(this.invalidMessages++,{valid:!1,error:n.error})}validateMessageStructure(e){if("object"!=typeof e||null===e)return{valid:!1,error:"Message must be an object"};if(!e.type||"string"!=typeof e.type)return{valid:!1,error:"Message must have a string type field"};if(e.type.length>50)return{valid:!1,error:"Message type too long"};if(e.messageId&&"string"!=typeof e.messageId)return{valid:!1,error:"MessageId must be a string"};try{JSON.stringify(e)}catch(e){return{valid:!1,error:"Message contains circular references"}}return{valid:!0}}getStats(){return{processedMessages:this.processedMessages,invalidMessages:this.invalidMessages,rateLimitedMessages:this.rateLimitedMessages,rateLimiter:this.rateLimiter.getStats()}}resetStats(){this.processedMessages=0,this.invalidMessages=0,this.rateLimitedMessages=0}}},3842:(e,t,r)=>{"use strict";const{tokenChars:i}=r(3977);e.exports={parse:function(e){const t=new Set;let r=-1,s=-1,n=0;for(;n<e.length;n++){const o=e.charCodeAt(n);if(-1===s&&1===i[o])-1===r&&(r=n);else if(0===n||32!==o&&9!==o){if(44!==o)throw new SyntaxError(`Unexpected character at index ${n}`);{if(-1===r)throw new SyntaxError(`Unexpected character at index ${n}`);-1===s&&(s=n);const i=e.slice(r,s);if(t.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);t.add(i),r=s=-1}}else-1===s&&-1!==r&&(s=n)}if(-1===r||-1!==s)throw new SyntaxError("Unexpected end of input");const o=e.slice(r,n);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}}},3891:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=3891,e.exports=t},3977:(e,t,r)=>{"use strict";const{isUtf8:i}=r(181),{hasBlob:s}=r(4033);function n(e){const t=e.length;let r=0;for(;r<t;)if(128&e[r])if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&e[r+1]>143||e[r]>244)return!1;r+=4}else r++;return!0}if(e.exports={isBlob:function(e){return s&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:n,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},i)e.exports.isValidUTF8=function(e){return e.length<24?n(e):i(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const t=r(Object(function(){var e=new Error("Cannot find module 'utf-8-validate'");throw e.code="MODULE_NOT_FOUND",e}()));e.exports.isValidUTF8=function(e){return e.length<32?n(e):t(e)}}catch(e){}},4033:e=>{"use strict";const t=["nodebuffer","arraybuffer","fragments"],r="undefined"!=typeof Blob;r&&t.push("blob"),e.exports={BINARY_TYPES:t,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:r,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},4126:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},4137:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},4192:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScryptedMimeTypes=t.ScryptedInterface=t.MediaPlayerState=t.SecuritySystemObstruction=t.SecuritySystemMode=t.AirQuality=t.AirPurifierMode=t.AirPurifierStatus=t.ChargeState=t.LockState=t.PanTiltZoomMovement=t.ThermostatMode=t.TemperatureUnit=t.FanMode=t.HumidityMode=t.ScryptedDeviceType=t.ScryptedInterfaceDescriptors=t.ScryptedInterfaceMethod=t.ScryptedInterfaceProperty=t.DeviceBase=t.TYPES_VERSION=void 0,t.TYPES_VERSION="0.5.44";var r,i,s,n,o,a,c,l,d,h,u,g,p,m,f,S,y,_;t.DeviceBase=class{},function(e){e.id="id",e.info="info",e.interfaces="interfaces",e.mixins="mixins",e.name="name",e.nativeId="nativeId",e.pluginId="pluginId",e.providedInterfaces="providedInterfaces",e.providedName="providedName",e.providedRoom="providedRoom",e.providedType="providedType",e.providerId="providerId",e.room="room",e.type="type",e.scryptedRuntimeArguments="scryptedRuntimeArguments",e.on="on",e.brightness="brightness",e.colorTemperature="colorTemperature",e.rgb="rgb",e.hsv="hsv",e.buttons="buttons",e.sensors="sensors",e.running="running",e.paused="paused",e.docked="docked",e.temperatureSetting="temperatureSetting",e.temperature="temperature",e.temperatureUnit="temperatureUnit",e.humidity="humidity",e.resolution="resolution",e.audioVolumes="audioVolumes",e.recordingActive="recordingActive",e.ptzCapabilities="ptzCapabilities",e.lockState="lockState",e.entryOpen="entryOpen",e.batteryLevel="batteryLevel",e.chargeState="chargeState",e.online="online",e.fromMimeType="fromMimeType",e.toMimeType="toMimeType",e.converters="converters",e.binaryState="binaryState",e.tampered="tampered",e.sleeping="sleeping",e.powerDetected="powerDetected",e.audioDetected="audioDetected",e.motionDetected="motionDetected",e.ambientLight="ambientLight",e.occupied="occupied",e.flooded="flooded",e.ultraviolet="ultraviolet",e.luminance="luminance",e.position="position",e.securitySystemState="securitySystemState",e.pm10Density="pm10Density",e.pm25Density="pm25Density",e.vocDensity="vocDensity",e.noxDensity="noxDensity",e.co2ppm="co2ppm",e.airQuality="airQuality",e.airPurifierState="airPurifierState",e.filterChangeIndication="filterChangeIndication",e.filterLifeLevel="filterLifeLevel",e.humiditySetting="humiditySetting",e.fan="fan",e.applicationInfo="applicationInfo",e.chatCompletionCapabilities="chatCompletionCapabilities",e.systemDevice="systemDevice"}(r||(t.ScryptedInterfaceProperty=r={})),function(e){e.listen="listen",e.probe="probe",e.setMixins="setMixins",e.setName="setName",e.setRoom="setRoom",e.setType="setType",e.getPluginJson="getPluginJson",e.turnOff="turnOff",e.turnOn="turnOn",e.setBrightness="setBrightness",e.getTemperatureMaxK="getTemperatureMaxK",e.getTemperatureMinK="getTemperatureMinK",e.setColorTemperature="setColorTemperature",e.setRgb="setRgb",e.setHsv="setHsv",e.pressButton="pressButton",e.sendNotification="sendNotification",e.start="start",e.stop="stop",e.pause="pause",e.resume="resume",e.dock="dock",e.setTemperature="setTemperature",e.setTemperatureUnit="setTemperatureUnit",e.getPictureOptions="getPictureOptions",e.takePicture="takePicture",e.getAudioStream="getAudioStream",e.setAudioVolumes="setAudioVolumes",e.startDisplay="startDisplay",e.stopDisplay="stopDisplay",e.getVideoStream="getVideoStream",e.getVideoStreamOptions="getVideoStreamOptions",e.getPrivacyMasks="getPrivacyMasks",e.setPrivacyMasks="setPrivacyMasks",e.getVideoTextOverlays="getVideoTextOverlays",e.setVideoTextOverlay="setVideoTextOverlay",e.getRecordingStream="getRecordingStream",e.getRecordingStreamCurrentTime="getRecordingStreamCurrentTime",e.getRecordingStreamOptions="getRecordingStreamOptions",e.getRecordingStreamThumbnail="getRecordingStreamThumbnail",e.deleteRecordingStream="deleteRecordingStream",e.setRecordingActive="setRecordingActive",e.ptzCommand="ptzCommand",e.getRecordedEvents="getRecordedEvents",e.getVideoClip="getVideoClip",e.getVideoClips="getVideoClips",e.getVideoClipThumbnail="getVideoClipThumbnail",e.removeVideoClips="removeVideoClips",e.setVideoStreamOptions="setVideoStreamOptions",e.startIntercom="startIntercom",e.stopIntercom="stopIntercom",e.lock="lock",e.unlock="unlock",e.addPassword="addPassword",e.getPasswords="getPasswords",e.removePassword="removePassword",e.activate="activate",e.deactivate="deactivate",e.isReversible="isReversible",e.closeEntry="closeEntry",e.openEntry="openEntry",e.getDevice="getDevice",e.releaseDevice="releaseDevice",e.adoptDevice="adoptDevice",e.discoverDevices="discoverDevices",e.createDevice="createDevice",e.getCreateDeviceSettings="getCreateDeviceSettings",e.reboot="reboot",e.getRefreshFrequency="getRefreshFrequency",e.refresh="refresh",e.getMediaStatus="getMediaStatus",e.load="load",e.seek="seek",e.skipNext="skipNext",e.skipPrevious="skipPrevious",e.convert="convert",e.convertMedia="convertMedia",e.getSettings="getSettings",e.putSetting="putSetting",e.armSecuritySystem="armSecuritySystem",e.disarmSecuritySystem="disarmSecuritySystem",e.setAirPurifierState="setAirPurifierState",e.getReadmeMarkdown="getReadmeMarkdown",e.getOauthUrl="getOauthUrl",e.onOauthCallback="onOauthCallback",e.canMixin="canMixin",e.getMixin="getMixin",e.releaseMixin="releaseMixin",e.onRequest="onRequest",e.onConnection="onConnection",e.onPush="onPush",e.run="run",e.eval="eval",e.loadScripts="loadScripts",e.saveScript="saveScript",e.forkInterface="forkInterface",e.getDetectionInput="getDetectionInput",e.getObjectTypes="getObjectTypes",e.detectObjects="detectObjects",e.generateObjectDetections="generateObjectDetections",e.getDetectionModel="getDetectionModel",e.setHumidity="setHumidity",e.setFan="setFan",e.startRTCSignalingSession="startRTCSignalingSession",e.createRTCSignalingSession="createRTCSignalingSession",e.getScryptedUserAccessControl="getScryptedUserAccessControl",e.generateVideoFrames="generateVideoFrames",e.connectStream="connectStream",e.getTTYSettings="getTTYSettings",e.getChatCompletion="getChatCompletion",e.streamChatCompletion="streamChatCompletion",e.getTextEmbedding="getTextEmbedding",e.getImageEmbedding="getImageEmbedding",e.callLLMTool="callLLMTool",e.getLLMTools="getLLMTools"}(i||(t.ScryptedInterfaceMethod=i={})),t.ScryptedInterfaceDescriptors={ScryptedDevice:{name:"ScryptedDevice",methods:["listen","probe","setMixins","setName","setRoom","setType"],properties:["id","info","interfaces","mixins","name","nativeId","pluginId","providedInterfaces","providedName","providedRoom","providedType","providerId","room","type"]},ScryptedPlugin:{name:"ScryptedPlugin",methods:["getPluginJson"],properties:[]},ScryptedPluginRuntime:{name:"ScryptedPluginRuntime",methods:[],properties:["scryptedRuntimeArguments"]},OnOff:{name:"OnOff",methods:["turnOff","turnOn"],properties:["on"]},Brightness:{name:"Brightness",methods:["setBrightness"],properties:["brightness"]},ColorSettingTemperature:{name:"ColorSettingTemperature",methods:["getTemperatureMaxK","getTemperatureMinK","setColorTemperature"],properties:["colorTemperature"]},ColorSettingRgb:{name:"ColorSettingRgb",methods:["setRgb"],properties:["rgb"]},ColorSettingHsv:{name:"ColorSettingHsv",methods:["setHsv"],properties:["hsv"]},Buttons:{name:"Buttons",methods:[],properties:["buttons"]},PressButtons:{name:"PressButtons",methods:["pressButton"],properties:[]},Sensors:{name:"Sensors",methods:[],properties:["sensors"]},Notifier:{name:"Notifier",methods:["sendNotification"],properties:[]},StartStop:{name:"StartStop",methods:["start","stop"],properties:["running"]},Pause:{name:"Pause",methods:["pause","resume"],properties:["paused"]},Dock:{name:"Dock",methods:["dock"],properties:["docked"]},TemperatureSetting:{name:"TemperatureSetting",methods:["setTemperature"],properties:["temperatureSetting"]},Thermometer:{name:"Thermometer",methods:["setTemperatureUnit"],properties:["temperature","temperatureUnit"]},HumiditySensor:{name:"HumiditySensor",methods:[],properties:["humidity"]},Camera:{name:"Camera",methods:["getPictureOptions","takePicture"],properties:[]},Resolution:{name:"Resolution",methods:[],properties:["resolution"]},Microphone:{name:"Microphone",methods:["getAudioStream"],properties:[]},AudioVolumeControl:{name:"AudioVolumeControl",methods:["setAudioVolumes"],properties:["audioVolumes"]},Display:{name:"Display",methods:["startDisplay","stopDisplay"],properties:[]},VideoCamera:{name:"VideoCamera",methods:["getVideoStream","getVideoStreamOptions"],properties:[]},VideoCameraMask:{name:"VideoCameraMask",methods:["getPrivacyMasks","setPrivacyMasks"],properties:[]},VideoTextOverlays:{name:"VideoTextOverlays",methods:["getVideoTextOverlays","setVideoTextOverlay"],properties:[]},VideoRecorder:{name:"VideoRecorder",methods:["getRecordingStream","getRecordingStreamCurrentTime","getRecordingStreamOptions","getRecordingStreamThumbnail"],properties:["recordingActive"]},VideoRecorderManagement:{name:"VideoRecorderManagement",methods:["deleteRecordingStream","setRecordingActive"],properties:[]},PanTiltZoom:{name:"PanTiltZoom",methods:["ptzCommand"],properties:["ptzCapabilities"]},EventRecorder:{name:"EventRecorder",methods:["getRecordedEvents"],properties:[]},VideoClips:{name:"VideoClips",methods:["getVideoClip","getVideoClips","getVideoClipThumbnail","removeVideoClips"],properties:[]},VideoCameraConfiguration:{name:"VideoCameraConfiguration",methods:["setVideoStreamOptions"],properties:[]},Intercom:{name:"Intercom",methods:["startIntercom","stopIntercom"],properties:[]},Lock:{name:"Lock",methods:["lock","unlock"],properties:["lockState"]},PasswordStore:{name:"PasswordStore",methods:["addPassword","getPasswords","removePassword"],properties:[]},Scene:{name:"Scene",methods:["activate","deactivate","isReversible"],properties:[]},Entry:{name:"Entry",methods:["closeEntry","openEntry"],properties:[]},EntrySensor:{name:"EntrySensor",methods:[],properties:["entryOpen"]},DeviceProvider:{name:"DeviceProvider",methods:["getDevice","releaseDevice"],properties:[]},DeviceDiscovery:{name:"DeviceDiscovery",methods:["adoptDevice","discoverDevices"],properties:[]},DeviceCreator:{name:"DeviceCreator",methods:["createDevice","getCreateDeviceSettings"],properties:[]},Battery:{name:"Battery",methods:[],properties:["batteryLevel"]},Charger:{name:"Charger",methods:[],properties:["chargeState"]},Reboot:{name:"Reboot",methods:["reboot"],properties:[]},Refresh:{name:"Refresh",methods:["getRefreshFrequency","refresh"],properties:[]},MediaPlayer:{name:"MediaPlayer",methods:["getMediaStatus","load","seek","skipNext","skipPrevious"],properties:[]},Online:{name:"Online",methods:[],properties:["online"]},BufferConverter:{name:"BufferConverter",methods:["convert"],properties:["fromMimeType","toMimeType"]},MediaConverter:{name:"MediaConverter",methods:["convertMedia"],properties:["converters"]},Settings:{name:"Settings",methods:["getSettings","putSetting"],properties:[]},BinarySensor:{name:"BinarySensor",methods:[],properties:["binaryState"]},TamperSensor:{name:"TamperSensor",methods:[],properties:["tampered"]},Sleep:{name:"Sleep",methods:[],properties:["sleeping"]},PowerSensor:{name:"PowerSensor",methods:[],properties:["powerDetected"]},AudioSensor:{name:"AudioSensor",methods:[],properties:["audioDetected"]},MotionSensor:{name:"MotionSensor",methods:[],properties:["motionDetected"]},AmbientLightSensor:{name:"AmbientLightSensor",methods:[],properties:["ambientLight"]},OccupancySensor:{name:"OccupancySensor",methods:[],properties:["occupied"]},FloodSensor:{name:"FloodSensor",methods:[],properties:["flooded"]},UltravioletSensor:{name:"UltravioletSensor",methods:[],properties:["ultraviolet"]},LuminanceSensor:{name:"LuminanceSensor",methods:[],properties:["luminance"]},PositionSensor:{name:"PositionSensor",methods:[],properties:["position"]},SecuritySystem:{name:"SecuritySystem",methods:["armSecuritySystem","disarmSecuritySystem"],properties:["securitySystemState"]},PM10Sensor:{name:"PM10Sensor",methods:[],properties:["pm10Density"]},PM25Sensor:{name:"PM25Sensor",methods:[],properties:["pm25Density"]},VOCSensor:{name:"VOCSensor",methods:[],properties:["vocDensity"]},NOXSensor:{name:"NOXSensor",methods:[],properties:["noxDensity"]},CO2Sensor:{name:"CO2Sensor",methods:[],properties:["co2ppm"]},AirQualitySensor:{name:"AirQualitySensor",methods:[],properties:["airQuality"]},AirPurifier:{name:"AirPurifier",methods:["setAirPurifierState"],properties:["airPurifierState"]},FilterMaintenance:{name:"FilterMaintenance",methods:[],properties:["filterChangeIndication","filterLifeLevel"]},Readme:{name:"Readme",methods:["getReadmeMarkdown"],properties:[]},OauthClient:{name:"OauthClient",methods:["getOauthUrl","onOauthCallback"],properties:[]},MixinProvider:{name:"MixinProvider",methods:["canMixin","getMixin","releaseMixin"],properties:[]},HttpRequestHandler:{name:"HttpRequestHandler",methods:["onRequest"],properties:[]},EngineIOHandler:{name:"EngineIOHandler",methods:["onConnection"],properties:[]},PushHandler:{name:"PushHandler",methods:["onPush"],properties:[]},Program:{name:"Program",methods:["run"],properties:[]},Scriptable:{name:"Scriptable",methods:["eval","loadScripts","saveScript"],properties:[]},ClusterForkInterface:{name:"ClusterForkInterface",methods:["forkInterface"],properties:[]},ObjectDetector:{name:"ObjectDetector",methods:["getDetectionInput","getObjectTypes"],properties:[]},ObjectDetection:{name:"ObjectDetection",methods:["detectObjects","generateObjectDetections","getDetectionModel"],properties:[]},ObjectDetectionPreview:{name:"ObjectDetectionPreview",methods:[],properties:[]},ObjectDetectionGenerator:{name:"ObjectDetectionGenerator",methods:[],properties:[]},HumiditySetting:{name:"HumiditySetting",methods:["setHumidity"],properties:["humiditySetting"]},Fan:{name:"Fan",methods:["setFan"],properties:["fan"]},RTCSignalingChannel:{name:"RTCSignalingChannel",methods:["startRTCSignalingSession"],properties:[]},RTCSignalingClient:{name:"RTCSignalingClient",methods:["createRTCSignalingSession"],properties:[]},LauncherApplication:{name:"LauncherApplication",methods:[],properties:["applicationInfo"]},ScryptedUser:{name:"ScryptedUser",methods:["getScryptedUserAccessControl"],properties:[]},VideoFrameGenerator:{name:"VideoFrameGenerator",methods:["generateVideoFrames"],properties:[]},StreamService:{name:"StreamService",methods:["connectStream"],properties:[]},TTY:{name:"TTY",methods:[],properties:[]},TTYSettings:{name:"TTYSettings",methods:["getTTYSettings"],properties:[]},ChatCompletion:{name:"ChatCompletion",methods:["getChatCompletion","streamChatCompletion"],properties:["chatCompletionCapabilities"]},TextEmbedding:{name:"TextEmbedding",methods:["getTextEmbedding"],properties:[]},ImageEmbedding:{name:"ImageEmbedding",methods:["getImageEmbedding"],properties:[]},LLMTools:{name:"LLMTools",methods:["callLLMTool","getLLMTools"],properties:[]},ScryptedSystemDevice:{name:"ScryptedSystemDevice",methods:[],properties:["systemDevice"]},ScryptedDeviceCreator:{name:"ScryptedDeviceCreator",methods:[],properties:[]},ScryptedSettings:{name:"ScryptedSettings",methods:[],properties:[]}},function(e){e.Builtin="Builtin",e.Internal="Internal",e.Camera="Camera",e.Fan="Fan",e.Light="Light",e.Switch="Switch",e.Outlet="Outlet",e.Sensor="Sensor",e.Scene="Scene",e.Program="Program",e.Automation="Automation",e.Vacuum="Vacuum",e.Notifier="Notifier",e.Thermostat="Thermostat",e.Lock="Lock",e.PasswordControl="PasswordControl",e.Display="Display",e.SmartDisplay="SmartDisplay",e.Speaker="Speaker",e.SmartSpeaker="SmartSpeaker",e.RemoteDesktop="RemoteDesktop",e.Event="Event",e.Entry="Entry",e.Garage="Garage",e.DeviceProvider="DeviceProvider",e.DataSource="DataSource",e.API="API",e.Doorbell="Doorbell",e.Irrigation="Irrigation",e.Valve="Valve",e.Person="Person",e.SecuritySystem="SecuritySystem",e.WindowCovering="WindowCovering",e.Siren="Siren",e.AirPurifier="AirPurifier",e.Internet="Internet",e.Network="Network",e.Bridge="Bridge",e.LLM="LLM",e.Unknown="Unknown"}(s||(t.ScryptedDeviceType=s={})),function(e){e.Humidify="Humidify",e.Dehumidify="Dehumidify",e.Auto="Auto",e.Off="Off"}(n||(t.HumidityMode=n={})),function(e){e.Auto="Auto",e.Manual="Manual"}(o||(t.FanMode=o={})),function(e){e.C="C",e.F="F"}(a||(t.TemperatureUnit=a={})),function(e){e.Off="Off",e.Cool="Cool",e.Heat="Heat",e.HeatCool="HeatCool",e.Auto="Auto",e.FanOnly="FanOnly",e.Purifier="Purifier",e.Eco="Eco",e.Dry="Dry",e.On="On"}(c||(t.ThermostatMode=c={})),function(e){e.Absolute="Absolute",e.Relative="Relative",e.Continuous="Continuous",e.Preset="Preset",e.Home="Home"}(l||(t.PanTiltZoomMovement=l={})),function(e){e.Locked="Locked",e.Unlocked="Unlocked",e.Jammed="Jammed"}(d||(t.LockState=d={})),function(e){e.Trickle="trickle",e.Charging="charging",e.NotCharging="not-charging"}(h||(t.ChargeState=h={})),function(e){e.Inactive="Inactive",e.Idle="Idle",e.Active="Active",e.ActiveNightMode="ActiveNightMode"}(u||(t.AirPurifierStatus=u={})),function(e){e.Manual="Manual",e.Automatic="Automatic"}(g||(t.AirPurifierMode=g={})),function(e){e.Unknown="Unknown",e.Excellent="Excellent",e.Good="Good",e.Fair="Fair",e.Inferior="Inferior",e.Poor="Poor"}(p||(t.AirQuality=p={})),function(e){e.Disarmed="Disarmed",e.HomeArmed="HomeArmed",e.AwayArmed="AwayArmed",e.NightArmed="NightArmed"}(m||(t.SecuritySystemMode=m={})),function(e){e.Sensor="Sensor",e.Occupied="Occupied",e.Time="Time",e.Error="Error"}(f||(t.SecuritySystemObstruction=f={})),function(e){e.Idle="Idle",e.Playing="Playing",e.Paused="Paused",e.Buffering="Buffering"}(S||(t.MediaPlayerState=S={})),function(e){e.ScryptedDevice="ScryptedDevice",e.ScryptedPlugin="ScryptedPlugin",e.ScryptedPluginRuntime="ScryptedPluginRuntime",e.OnOff="OnOff",e.Brightness="Brightness",e.ColorSettingTemperature="ColorSettingTemperature",e.ColorSettingRgb="ColorSettingRgb",e.ColorSettingHsv="ColorSettingHsv",e.Buttons="Buttons",e.PressButtons="PressButtons",e.Sensors="Sensors",e.Notifier="Notifier",e.StartStop="StartStop",e.Pause="Pause",e.Dock="Dock",e.TemperatureSetting="TemperatureSetting",e.Thermometer="Thermometer",e.HumiditySensor="HumiditySensor",e.Camera="Camera",e.Resolution="Resolution",e.Microphone="Microphone",e.AudioVolumeControl="AudioVolumeControl",e.Display="Display",e.VideoCamera="VideoCamera",e.VideoCameraMask="VideoCameraMask",e.VideoTextOverlays="VideoTextOverlays",e.VideoRecorder="VideoRecorder",e.VideoRecorderManagement="VideoRecorderManagement",e.PanTiltZoom="PanTiltZoom",e.EventRecorder="EventRecorder",e.VideoClips="VideoClips",e.VideoCameraConfiguration="VideoCameraConfiguration",e.Intercom="Intercom",e.Lock="Lock",e.PasswordStore="PasswordStore",e.Scene="Scene",e.Entry="Entry",e.EntrySensor="EntrySensor",e.DeviceProvider="DeviceProvider",e.DeviceDiscovery="DeviceDiscovery",e.DeviceCreator="DeviceCreator",e.Battery="Battery",e.Charger="Charger",e.Reboot="Reboot",e.Refresh="Refresh",e.MediaPlayer="MediaPlayer",e.Online="Online",e.BufferConverter="BufferConverter",e.MediaConverter="MediaConverter",e.Settings="Settings",e.BinarySensor="BinarySensor",e.TamperSensor="TamperSensor",e.Sleep="Sleep",e.PowerSensor="PowerSensor",e.AudioSensor="AudioSensor",e.MotionSensor="MotionSensor",e.AmbientLightSensor="AmbientLightSensor",e.OccupancySensor="OccupancySensor",e.FloodSensor="FloodSensor",e.UltravioletSensor="UltravioletSensor",e.LuminanceSensor="LuminanceSensor",e.PositionSensor="PositionSensor",e.SecuritySystem="SecuritySystem",e.PM10Sensor="PM10Sensor",e.PM25Sensor="PM25Sensor",e.VOCSensor="VOCSensor",e.NOXSensor="NOXSensor",e.CO2Sensor="CO2Sensor",e.AirQualitySensor="AirQualitySensor",e.AirPurifier="AirPurifier",e.FilterMaintenance="FilterMaintenance",e.Readme="Readme",e.OauthClient="OauthClient",e.MixinProvider="MixinProvider",e.HttpRequestHandler="HttpRequestHandler",e.EngineIOHandler="EngineIOHandler",e.PushHandler="PushHandler",e.Program="Program",e.Scriptable="Scriptable",e.ClusterForkInterface="ClusterForkInterface",e.ObjectDetector="ObjectDetector",e.ObjectDetection="ObjectDetection",e.ObjectDetectionPreview="ObjectDetectionPreview",e.ObjectDetectionGenerator="ObjectDetectionGenerator",e.HumiditySetting="HumiditySetting",e.Fan="Fan",e.RTCSignalingChannel="RTCSignalingChannel",e.RTCSignalingClient="RTCSignalingClient",e.LauncherApplication="LauncherApplication",e.ScryptedUser="ScryptedUser",e.VideoFrameGenerator="VideoFrameGenerator",e.StreamService="StreamService",e.TTY="TTY",e.TTYSettings="TTYSettings",e.ChatCompletion="ChatCompletion",e.TextEmbedding="TextEmbedding",e.ImageEmbedding="ImageEmbedding",e.LLMTools="LLMTools",e.ScryptedSystemDevice="ScryptedSystemDevice",e.ScryptedDeviceCreator="ScryptedDeviceCreator",e.ScryptedSettings="ScryptedSettings"}(y||(t.ScryptedInterface=y={})),function(e){e.Url="text/x-uri",e.InsecureLocalUrl="text/x-insecure-local-uri",e.LocalUrl="text/x-local-uri",e.ServerId="text/x-server-id",e.PushEndpoint="text/x-push-endpoint",e.SchemePrefix="x-scrypted/x-scrypted-scheme-",e.MediaStreamUrl="text/x-media-url",e.MediaObject="x-scrypted/x-scrypted-media-object",e.RequestMediaObject="x-scrypted/x-scrypted-request-media-object",e.RequestMediaStream="x-scrypted/x-scrypted-request-stream",e.MediaStreamFeedback="x-scrypted/x-media-stream-feedback",e.FFmpegInput="x-scrypted/x-ffmpeg-input",e.FFmpegTranscodeStream="x-scrypted/x-ffmpeg-transcode-stream",e.RTCSignalingChannel="x-scrypted/x-scrypted-rtc-signaling-channel",e.RTCSignalingSession="x-scrypted/x-scrypted-rtc-signaling-session",e.RTCConnectionManagement="x-scrypted/x-scrypted-rtc-connection-management",e.Image="x-scrypted/x-scrypted-image"}(_||(t.ScryptedMimeTypes=_={}))},4400:(e,t,r)=>{"use strict";const{kForOnEventAttribute:i,kListener:s}=r(4033),n=Symbol("kCode"),o=Symbol("kData"),a=Symbol("kError"),c=Symbol("kMessage"),l=Symbol("kReason"),d=Symbol("kTarget"),h=Symbol("kType"),u=Symbol("kWasClean");class g{constructor(e){this[d]=null,this[h]=e}get target(){return this[d]}get type(){return this[h]}}Object.defineProperty(g.prototype,"target",{enumerable:!0}),Object.defineProperty(g.prototype,"type",{enumerable:!0});class p extends g{constructor(e,t={}){super(e),this[n]=void 0===t.code?0:t.code,this[l]=void 0===t.reason?"":t.reason,this[u]=void 0!==t.wasClean&&t.wasClean}get code(){return this[n]}get reason(){return this[l]}get wasClean(){return this[u]}}Object.defineProperty(p.prototype,"code",{enumerable:!0}),Object.defineProperty(p.prototype,"reason",{enumerable:!0}),Object.defineProperty(p.prototype,"wasClean",{enumerable:!0});class m extends g{constructor(e,t={}){super(e),this[a]=void 0===t.error?null:t.error,this[c]=void 0===t.message?"":t.message}get error(){return this[a]}get message(){return this[c]}}Object.defineProperty(m.prototype,"error",{enumerable:!0}),Object.defineProperty(m.prototype,"message",{enumerable:!0});class f extends g{constructor(e,t={}){super(e),this[o]=void 0===t.data?null:t.data}get data(){return this[o]}}Object.defineProperty(f.prototype,"data",{enumerable:!0});const S={addEventListener(e,t,r={}){for(const n of this.listeners(e))if(!r[i]&&n[s]===t&&!n[i])return;let n;if("message"===e)n=function(e,r){const i=new f("message",{data:r?e:e.toString()});i[d]=this,y(t,this,i)};else if("close"===e)n=function(e,r){const i=new p("close",{code:e,reason:r.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});i[d]=this,y(t,this,i)};else if("error"===e)n=function(e){const r=new m("error",{error:e,message:e.message});r[d]=this,y(t,this,r)};else{if("open"!==e)return;n=function(){const e=new g("open");e[d]=this,y(t,this,e)}}n[i]=!!r[i],n[s]=t,r.once?this.once(e,n):this.on(e,n)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[s]===t&&!r[i]){this.removeListener(e,r);break}}};function y(e,t,r){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,r):e.call(t,r)}e.exports={CloseEvent:p,ErrorEvent:m,Event:g,EventTarget:S,MessageEvent:f}},4434:e=>{"use strict";e.exports=require("events")},4756:e=>{"use strict";e.exports=require("tls")},4793:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.H264Parser=void 0;t.H264Parser=class{constructor(e){this.logger=e}extractNALUnits(e){const t=[];let r=0;if(e.length<4)return t;for(;r<e.length;){const i=this.findStartCode(e,r);if(!i)break;const{position:s,length:n}=i,o=s+n;if(o>=e.length)break;let a=e.length;const c=this.findStartCode(e,o);if(c&&(a=c.position),o<a){const r=e.subarray(o,a);if(r.length>0){const e=31&r[0],i=this.isKeyFrameNAL(e);t.push({type:e,data:r,isKeyFrame:i})}}r=a}return t}findStartCode(e,t){for(let r=t;r<=e.length-3;r++){if(r<=e.length-4&&0===e[r]&&0===e[r+1]&&0===e[r+2]&&1===e[r+3])return{position:r,length:4};if(0===e[r]&&0===e[r+1]&&1===e[r+2])return{position:r,length:3}}return null}isKeyFrameNAL(e){return 5===e||7===e||8===e}isKeyFrame(e){return this.extractNALUnits(e).some(e=>e.isKeyFrame)}validateH264Data(e){if(e.length<4)return!1;if(!(null!==this.findStartCode(e,0)))return!1;return this.extractNALUnits(e).length>0}getNALTypeName(e){return{1:"P-slice",2:"B-slice",3:"I-slice",5:"IDR-slice",6:"SEI",7:"SPS",8:"PPS",9:"AUD",14:"Data Partitioning"}[e]||`Unknown(${e})`}}},4861:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},4872:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerCommandBuilder=t.DriverCommandBuilder=t.StationCommandBuilder=t.DeviceCommandBuilder=t.EnhancedCommandAPI=void 0;const i=r(1187),s=r(3405),n=r(5679),o=r(5494);t.EnhancedCommandAPI=class{constructor(e){this.apiManager=e}async command(e,...t){const r=t[0]||{};return this.apiManager.sendCommand(e,r)}device(e){return new a(e,this)}station(e){return new c(e,this)}driver(){return new l(this)}server(){return new d(this)}};class a{constructor(e,t){this.serialNumber=e,this.api=t}async getProperties(){return this.api.command(i.DEVICE_COMMANDS.GET_PROPERTIES,{serialNumber:this.serialNumber})}async getPropertiesMetadata(){return this.api.command(i.DEVICE_COMMANDS.GET_PROPERTIES_METADATA,{serialNumber:this.serialNumber})}async hasProperty(e){return this.api.command(i.DEVICE_COMMANDS.HAS_PROPERTY,{serialNumber:this.serialNumber,propertyName:e})}async hasCommand(e){return this.api.command(i.DEVICE_COMMANDS.HAS_COMMAND,{serialNumber:this.serialNumber,commandName:e})}async getCommands(){return this.api.command(i.DEVICE_COMMANDS.GET_COMMANDS,{serialNumber:this.serialNumber})}async isLivestreaming(){return this.api.command(i.DEVICE_COMMANDS.IS_LIVESTREAMING,{serialNumber:this.serialNumber})}async startLivestream(){return this.api.command(i.DEVICE_COMMANDS.START_LIVESTREAM,{serialNumber:this.serialNumber})}async stopLivestream(){return this.api.command(i.DEVICE_COMMANDS.STOP_LIVESTREAM,{serialNumber:this.serialNumber})}async isRtspLivestreaming(){return this.api.command(i.DEVICE_COMMANDS.IS_RTSP_LIVESTREAMING,{serialNumber:this.serialNumber})}async startRtspLivestream(){return this.api.command(i.DEVICE_COMMANDS.START_RTSP_LIVESTREAM,{serialNumber:this.serialNumber})}async stopRtspLivestream(){return this.api.command(i.DEVICE_COMMANDS.STOP_RTSP_LIVESTREAM,{serialNumber:this.serialNumber})}async isDownloading(){return this.api.command(i.DEVICE_COMMANDS.IS_DOWNLOADING,{serialNumber:this.serialNumber})}async startDownload(e){return this.api.command(i.DEVICE_COMMANDS.START_DOWNLOAD,{serialNumber:this.serialNumber,...e})}async cancelDownload(){return this.api.command(i.DEVICE_COMMANDS.CANCEL_DOWNLOAD,{serialNumber:this.serialNumber})}async triggerAlarm(e){const t=e&&"number"==typeof e.seconds?e.seconds:0;return this.api.command(i.DEVICE_COMMANDS.TRIGGER_ALARM,{serialNumber:this.serialNumber,seconds:t,...e})}async resetAlarm(){return this.api.command(i.DEVICE_COMMANDS.RESET_ALARM,{serialNumber:this.serialNumber})}async panAndTilt(e){return this.api.command(i.DEVICE_COMMANDS.PAN_AND_TILT,{serialNumber:this.serialNumber,...e})}async calibrate(){return this.api.command(i.DEVICE_COMMANDS.CALIBRATE,{serialNumber:this.serialNumber})}async setProperty(e,t){return this.api.command(i.DEVICE_COMMANDS.SET_PROPERTY,{serialNumber:this.serialNumber,name:e,value:t})}async quickResponse(e){return this.api.command(i.DEVICE_COMMANDS.QUICK_RESPONSE,{serialNumber:this.serialNumber,...e})}async getVoices(){return this.api.command(i.DEVICE_COMMANDS.GET_VOICES,{serialNumber:this.serialNumber})}async startTalkback(){return this.api.command(i.DEVICE_COMMANDS.START_TALKBACK,{serialNumber:this.serialNumber})}async stopTalkback(){return this.api.command(i.DEVICE_COMMANDS.STOP_TALKBACK,{serialNumber:this.serialNumber})}async isTalkbackOngoing(){return this.api.command(i.DEVICE_COMMANDS.IS_TALKBACK_ONGOING,{serialNumber:this.serialNumber})}async calibrateLock(){return this.api.command(i.DEVICE_COMMANDS.CALIBRATE_LOCK,{serialNumber:this.serialNumber})}async unlock(){return this.api.command(i.DEVICE_COMMANDS.UNLOCK,{serialNumber:this.serialNumber})}async snooze(e){return this.api.command(i.DEVICE_COMMANDS.SNOOZE,{serialNumber:this.serialNumber,...e})}async addUser(e){return this.api.command(i.DEVICE_COMMANDS.ADD_USER,{serialNumber:this.serialNumber,...e})}async deleteUser(e){return this.api.command(i.DEVICE_COMMANDS.DELETE_USER,{serialNumber:this.serialNumber,...e})}async getUsers(){return this.api.command(i.DEVICE_COMMANDS.GET_USERS,{serialNumber:this.serialNumber})}async updateUser(e){return this.api.command(i.DEVICE_COMMANDS.UPDATE_USER,{serialNumber:this.serialNumber,...e})}async updateUserPasscode(e){return this.api.command(i.DEVICE_COMMANDS.UPDATE_USER_PASSCODE,{serialNumber:this.serialNumber,...e})}async updateUserSchedule(e){return this.api.command(i.DEVICE_COMMANDS.UPDATE_USER_SCHEDULE,{serialNumber:this.serialNumber,...e})}async verifyPin(e){return this.api.command(i.DEVICE_COMMANDS.VERIFY_PIN,{serialNumber:this.serialNumber,...e})}async open(){return this.api.command(i.DEVICE_COMMANDS.OPEN,{serialNumber:this.serialNumber})}async setStatusLed(e){return this.api.command(i.DEVICE_COMMANDS.SET_STATUS_LED,{serialNumber:this.serialNumber,...e})}async setAutoNightVision(e){return this.api.command(i.DEVICE_COMMANDS.SET_AUTO_NIGHT_VISION,{serialNumber:this.serialNumber,...e})}async setMotionDetection(e){return this.api.command(i.DEVICE_COMMANDS.SET_MOTION_DETECTION,{serialNumber:this.serialNumber,...e})}async setSoundDetection(e){return this.api.command(i.DEVICE_COMMANDS.SET_SOUND_DETECTION,{serialNumber:this.serialNumber,...e})}async setPetDetection(e){return this.api.command(i.DEVICE_COMMANDS.SET_PET_DETECTION,{serialNumber:this.serialNumber,...e})}async setRtspStream(e){return this.api.command(i.DEVICE_COMMANDS.SET_RTSP_STREAM,{serialNumber:this.serialNumber,...e})}async setAntiTheftDetection(e){return this.api.command(i.DEVICE_COMMANDS.SET_ANTI_THEFT_DETECTION,{serialNumber:this.serialNumber,...e})}async setWatermark(e){return this.api.command(i.DEVICE_COMMANDS.SET_WATERMARK,{serialNumber:this.serialNumber,...e})}async enableDevice(e){return this.api.command(i.DEVICE_COMMANDS.ENABLE_DEVICE,{serialNumber:this.serialNumber,...e})}async lockDevice(e){return this.api.command(i.DEVICE_COMMANDS.LOCK_DEVICE,{serialNumber:this.serialNumber,...e})}}t.DeviceCommandBuilder=a;class c{constructor(e,t){this.serialNumber=e,this.api=t}async getProperties(){return this.api.command(s.STATION_COMMANDS.GET_PROPERTIES,{serialNumber:this.serialNumber})}async getPropertiesMetadata(){return this.api.command(s.STATION_COMMANDS.GET_PROPERTIES_METADATA,{serialNumber:this.serialNumber})}async hasProperty(e){return this.api.command(s.STATION_COMMANDS.HAS_PROPERTY,{serialNumber:this.serialNumber,propertyName:e})}async hasCommand(e){return this.api.command(s.STATION_COMMANDS.HAS_COMMAND,{serialNumber:this.serialNumber,commandName:e})}async getCommands(){return this.api.command(s.STATION_COMMANDS.GET_COMMANDS,{serialNumber:this.serialNumber})}async isConnected(){return this.api.command(s.STATION_COMMANDS.IS_CONNECTED,{serialNumber:this.serialNumber})}async connect(){return this.api.command(s.STATION_COMMANDS.CONNECT,{serialNumber:this.serialNumber})}async disconnect(){return this.api.command(s.STATION_COMMANDS.DISCONNECT,{serialNumber:this.serialNumber})}async setProperty(e,t){return this.api.command(s.STATION_COMMANDS.SET_PROPERTY,{serialNumber:this.serialNumber,name:e,value:t})}async triggerAlarm(e){const t=e&&"number"==typeof e.seconds?e.seconds:0;return this.api.command(s.STATION_COMMANDS.TRIGGER_ALARM,{serialNumber:this.serialNumber,seconds:t,...e})}async resetAlarm(){return this.api.command(s.STATION_COMMANDS.RESET_ALARM,{serialNumber:this.serialNumber})}async reboot(){return this.api.command(s.STATION_COMMANDS.REBOOT,{serialNumber:this.serialNumber})}async chime(e){return this.api.command(s.STATION_COMMANDS.CHIME,{...e})}async downloadImage(e){return this.api.command(s.STATION_COMMANDS.DOWNLOAD_IMAGE,{...e})}async databaseQueryLatestInfo(e){return this.api.command(s.STATION_COMMANDS.DATABASE_QUERY_LATEST_INFO,{serialNumber:this.serialNumber,...e})}async databaseQueryLocal(e){return this.api.command(s.STATION_COMMANDS.DATABASE_QUERY_LOCAL,{serialNumber:this.serialNumber,...e})}async databaseCountByDate(e){return this.api.command(s.STATION_COMMANDS.DATABASE_COUNT_BY_DATE,{serialNumber:this.serialNumber,...e})}async databaseDelete(e){return this.api.command(s.STATION_COMMANDS.DATABASE_DELETE,{serialNumber:this.serialNumber,...e})}}t.StationCommandBuilder=c;class l{constructor(e){this.api=e}async connect(){return this.api.command(n.DRIVER_COMMANDS.CONNECT)}async disconnect(){return this.api.command(n.DRIVER_COMMANDS.DISCONNECT)}async isConnected(){return this.api.command(n.DRIVER_COMMANDS.IS_CONNECTED)}async isPushConnected(){return this.api.command(n.DRIVER_COMMANDS.IS_PUSH_CONNECTED)}async isMqttConnected(){return this.api.command(n.DRIVER_COMMANDS.IS_MQTT_CONNECTED)}async setVerifyCode(e){return this.api.command(n.DRIVER_COMMANDS.SET_VERIFY_CODE,e)}async setCaptcha(e){return this.api.command(n.DRIVER_COMMANDS.SET_CAPTCHA,e)}async pollRefresh(){return this.api.command(n.DRIVER_COMMANDS.POLL_REFRESH)}async getVideoEvents(e){return this.api.command(n.DRIVER_COMMANDS.GET_VIDEO_EVENTS,e)}async getAlarmEvents(e){return this.api.command(n.DRIVER_COMMANDS.GET_ALARM_EVENTS,e)}async getHistoryEvents(e){return this.api.command(n.DRIVER_COMMANDS.GET_HISTORY_EVENTS,e)}async setLogLevel(e){return this.api.command(n.DRIVER_COMMANDS.SET_LOG_LEVEL,e)}async getLogLevel(){return this.api.command(n.DRIVER_COMMANDS.GET_LOG_LEVEL)}async startListeningLogs(){return this.api.command(n.DRIVER_COMMANDS.START_LISTENING_LOGS)}async stopListeningLogs(){return this.api.command(n.DRIVER_COMMANDS.STOP_LISTENING_LOGS)}async isListeningLogs(){return this.api.command(n.DRIVER_COMMANDS.IS_LISTENING_LOGS)}}t.DriverCommandBuilder=l;class d{constructor(e){this.api=e}async startListening(){return this.api.command(o.SERVER_COMMANDS.START_LISTENING)}async setApiSchema(e){return this.api.command(o.SERVER_COMMANDS.SET_API_SCHEMA,{schemaVersion:e})}}t.ServerCommandBuilder=d},4874:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},5067:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},5317:e=>{"use strict";e.exports=require("child_process")},5321:(e,t,r)=>{"use strict";t.Kt=void 0;var i=r(333);Object.defineProperty(t,"Kt",{enumerable:!0,get:function(){return i.StreamServer}});var s=r(935);var n=r(4793)},5346:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(5608);i.__exportStar(r(1187),t),i.__exportStar(r(4874),t),i.__exportStar(r(4137),t),i.__exportStar(r(2189),t),i.__exportStar(r(1514),t)},5348:e=>{"use strict";const t=Symbol("kDone"),r=Symbol("kRun");e.exports=class{constructor(e){this[t]=()=>{this.pending--,this[r]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[r]()}[r](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[t])}}}},5361:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},5455:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EufySecurityClient=void 0;const i=r(741),s=r(1187),n=r(9749),o=r(7039),a=r(4434);class c extends a.EventEmitter{constructor(e){super(),this.devices=new Map,this.isConnectedFlag=!1,this.eventListenerCleanup=[],this.logger=e.logger??new o.Logger({name:"EufySecurityClient",minLevel:3}),this.apiManager=new i.ApiManager(e.wsUrl,this.logger),this.setupEventHandlers()}async waitForReady(e=1e4){const t=Date.now();for(;!this.apiManager.isConnected();){if(Date.now()-t>e)throw new Error("Timeout waiting for client to be ready");await new Promise(e=>setTimeout(e,100))}}async connect(){try{await this.apiManager.connect(),await this.waitForReady(),await this.apiManager.connectDriver(),await this.apiManager.startListening(),await this.loadDevices(),this.isConnectedFlag=!0}catch(e){throw this.logger.error("Failed to connect:",e),e}}async disconnect(){this.isConnectedFlag=!1,this.logger.debug(`Cleaning up ${this.eventListenerCleanup.length} event listeners`),this.eventListenerCleanup.forEach(e=>{try{e()}catch(e){this.logger.warn("Error during event listener cleanup:",e)}}),this.eventListenerCleanup=[],this.removeAllListeners(),this.devices.clear(),this.apiManager.disconnect(),this.logger.info("Client disconnected and all resources cleaned up")}isConnected(){return this.isConnectedFlag&&this.apiManager.isConnected()}async connectDriver(){if(!this.apiManager.isConnected())throw new Error("Client not connected. Call connect() first.");await this.apiManager.connectDriver()}async getDevices(){if(!this.isConnected())throw new Error("Client not connected. Call connect() first.");return Array.from(this.devices.values())}async startStream(e){if(!this.isConnected())throw new Error("Client not connected. Call connect() first.");if(!this.devices.get(e))throw new Error(`Device not found: ${e}`);try{const t=this.apiManager.commands.device(e);await t.startLivestream(),this.logger.info(`Started stream for device: ${e}`)}catch(t){throw this.logger.error(`Failed to start stream for device ${e}:`,t),t}}async stopStream(e){if(!this.isConnected())throw new Error("Client not connected. Call connect() first.");if(!this.devices.get(e))throw new Error(`Device not found: ${e}`);try{const t=this.apiManager.commands.device(e);if(!(await t.isLivestreaming()).livestreaming)return void this.logger.debug(`Device ${e} is not currently streaming`);await t.stopLivestream(),this.logger.info(`Stopped stream for device: ${e}`)}catch(t){throw this.logger.error(`Failed to stop stream for device ${e}:`,t),t}}getPendingCaptcha(){return this.apiManager.getPendingCaptcha()}clearPendingCaptcha(){this.apiManager.clearPendingCaptcha()}getPendingMfa(){return this.apiManager.getPendingMfa()}clearPendingMfa(){this.apiManager.clearPendingMfa()}get commands(){return this.apiManager.commands}setupEventHandlers(){this.eventListenerCleanup.push(this.apiManager.addEventListener("device added",e=>{this.addDevice(e)})),this.eventListenerCleanup.push(this.apiManager.addEventListener("device removed",e=>{const t=e.serialNumber||e.device?.serialNumber;t&&this.removeDevice(t)})),this.eventListenerCleanup.push(this.apiManager.addEventListener("livestream started",e=>{this.logger.info("ðŸŽ¬ Livestream started event received:",e),super.emit("streamStarted",e)})),this.eventListenerCleanup.push(this.apiManager.addEventListener("livestream stopped",e=>{this.logger.info("â¹ï¸ Livestream stopped event received:",e),super.emit("streamStopped",e)})),this.eventListenerCleanup.push(this.apiManager.addEventListener(s.DEVICE_EVENTS.LIVESTREAM_VIDEO_DATA,e=>{const t=e.buffer?.data?.length||0;this.logger.debug(`ðŸ“¹ Video data received: ${t} bytes from device ${e.serialNumber}`);const r=e.buffer?Buffer.from(e.buffer.data):Buffer.alloc(0);super.emit("streamData",{type:"video",buffer:r,deviceSerial:e.serialNumber,metadata:e.metadata})})),this.eventListenerCleanup.push(this.apiManager.addEventListener(s.DEVICE_EVENTS.LIVESTREAM_AUDIO_DATA,e=>{const t=e.buffer?.data?.length||0;this.logger.debug(`ðŸŽµ Audio data received: ${t} bytes from device ${e.serialNumber}`);const r=e.buffer?Buffer.from(e.buffer.data):Buffer.alloc(0);super.emit("streamData",{type:"audio",buffer:r,deviceSerial:e.serialNumber})}))}async loadDevices(){try{const e=await this.apiManager.commands.server().startListening();if(this.logger.info("Start listening result:",JSON.stringify(e,null,2)),e?.state?.devices){const t=e.state.devices;this.logger.info(`Found ${t.length} device(s):`,t);for(const e of t)try{const t=this.apiManager.commands.device(e),r=await t.getProperties();this.logger.info(`Device ${e} property keys:`,Object.keys(r||{})),r?.properties&&this.logger.info(`Device ${e} nested property keys:`,Object.keys(r.properties).slice(0,20));const i=r?.properties||{},s={name:i?.name||i?.deviceName||`Device ${e}`,serialNumber:e,type:this.getDeviceTypeName(i?.type||i?.deviceType||0),stationSerial:i?.stationSerial||i?.station_sn||"",model:i?.model||i?.deviceModel||"Unknown",hardwareVersion:i?.hardwareVersion||i?.main_hw_version||"Unknown",softwareVersion:i?.softwareVersion||i?.main_sw_version||"Unknown"};this.devices.set(e,s),this.logger.info(`Added device: ${s.name} (${s.serialNumber})`)}catch(t){this.logger.warn(`Failed to get properties for device ${e}:`,t);const r={name:`Device ${e}`,serialNumber:e,type:"Unknown",stationSerial:"",model:"Unknown",hardwareVersion:"Unknown",softwareVersion:"Unknown"};this.devices.set(e,r),this.logger.info(`Added device with minimal info: ${r.name} (${r.serialNumber})`)}}else this.logger.warn("No devices found in start_listening response");this.logger.info(`Device loading completed. Total devices: ${this.devices.size}`)}catch(e){throw this.logger.error("Failed to load devices:",e),e}}addDevice(e){const t={name:e.name||"Unknown Device",serialNumber:e.serialNumber,type:this.getDeviceTypeName(e.type),stationSerial:e.stationSerial,model:e.model,hardwareVersion:e.hardwareVersion,softwareVersion:e.softwareVersion};this.devices.set(t.serialNumber,t),this.logger.debug(`Added device: ${t.name} (${t.serialNumber})`)}removeDevice(e){if(this.devices.has(e)){const t=this.devices.get(e);this.devices.delete(e),this.logger.debug(`Removed device: ${t?.name} (${e})`)}}getDeviceTypeName(e){return(0,n.getDeviceTypeName)(e)}}t.EufySecurityClient=c},5456:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.splitStackLines=i,t.sanitizeStackLines=s,t.toStackFrames=n,t.findFirstExternalFrameIndex=o,t.getFrameAt=a,t.getCleanStackLines=c,t.buildStackTrace=function(e,t){return n(c(e),t)},t.isIgnorableFrame=function(e,t){const r=e.filePath??"",i=e.fullFilePath??"";return t.some(e=>e.test(r)||e.test(i))},t.clampIndex=l,t.pickCallerStackFrame=function(e,t,i={}){const s=n(c(e),t);if(0===s.length)return;const d=i.ignorePatterns??r,h=o(s,d),u=null!=i.stackDepthLevel?i.stackDepthLevel:h;return a(s,l(u,s.length))},t.getDefaultIgnorePatterns=function(){return[...r]};const r=[/(?:^|[\\/])node_modules[\\/].*tslog/i,/(?:^|[\\/])deps[\\/].*tslog/i,/tslog[\\/]+src[\\/]+internal[\\/]/i,/tslog[\\/]+src[\\/]BaseLogger/i,/tslog[\\/]+src[\\/]index/i];function i(e){const t="string"==typeof e?.stack?e.stack:void 0;return null==t||0===t.length?[]:t.split("\n").map(e=>e.trimEnd())}function s(e){return e.filter(e=>e.length>0&&!/^\s*Error\b/.test(e))}function n(e,t){const r=[];for(const i of e){const e=t(i);null!=e&&r.push(e)}return r}function o(e,t=r){for(let r=0;r<e.length;r+=1){const i=e[r],s=i.filePath??"",n=i.fullFilePath??"";if(!t.some(e=>e.test(s)||e.test(n)))return r}return 0}function a(e,t){if(!(t<0||t>=e.length))return e[t]}function c(e){return s(i(e))}function l(e,t){return e<0?0:e>=t?Math.max(0,t-1):e}},5494:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SERVER_EVENTS=t.SERVER_COMMANDS=void 0,t.SERVER_COMMANDS={START_LISTENING:"start_listening",SET_API_SCHEMA:"set_api_schema"},t.SERVER_EVENTS={SHUTDOWN:"shutdown"}},5608:(e,t,r)=>{"use strict";r.r(t),r.d(t,{__addDisposableResource:()=>k,__assign:()=>n,__asyncDelegator:()=>O,__asyncGenerator:()=>b,__asyncValues:()=>A,__await:()=>T,__awaiter:()=>p,__classPrivateFieldGet:()=>P,__classPrivateFieldIn:()=>I,__classPrivateFieldSet:()=>L,__createBinding:()=>f,__decorate:()=>a,__disposeResources:()=>B,__esDecorate:()=>l,__exportStar:()=>S,__extends:()=>s,__generator:()=>m,__importDefault:()=>N,__importStar:()=>R,__makeTemplateObject:()=>M,__metadata:()=>g,__param:()=>c,__propKey:()=>h,__read:()=>_,__rest:()=>o,__rewriteRelativeImportExtension:()=>V,__runInitializers:()=>d,__setFunctionName:()=>u,__spread:()=>v,__spreadArray:()=>C,__spreadArrays:()=>E,__values:()=>y,default:()=>F});var i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)};function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var n=function(){return n=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e},n.apply(this,arguments)};function o(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(r[i[s]]=e[i[s]])}return r}function a(e,t,r,i){var s,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,r,o):s(t,r))||o);return n>3&&o&&Object.defineProperty(t,r,o),o}function c(e,t){return function(r,i){t(r,i,e)}}function l(e,t,r,i,s,n){function o(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,c=i.kind,l="getter"===c?"get":"setter"===c?"set":"value",d=!t&&e?i.static?e:e.prototype:null,h=t||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),u=!1,g=r.length-1;g>=0;g--){var p={};for(var m in i)p[m]="access"===m?{}:i[m];for(var m in i.access)p.access[m]=i.access[m];p.addInitializer=function(e){if(u)throw new TypeError("Cannot add initializers after decoration has completed");n.push(o(e||null))};var f=(0,r[g])("accessor"===c?{get:h.get,set:h.set}:h[l],p);if("accessor"===c){if(void 0===f)continue;if(null===f||"object"!=typeof f)throw new TypeError("Object expected");(a=o(f.get))&&(h.get=a),(a=o(f.set))&&(h.set=a),(a=o(f.init))&&s.unshift(a)}else(a=o(f))&&("field"===c?s.unshift(a):h[l]=a)}d&&Object.defineProperty(d,i.name,h),u=!0}function d(e,t,r){for(var i=arguments.length>2,s=0;s<t.length;s++)r=i?t[s].call(e,r):t[s].call(e);return i?r:void 0}function h(e){return"symbol"==typeof e?e:"".concat(e)}function u(e,t,r){return"symbol"==typeof t&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:r?"".concat(r," ",t):t})}function g(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function p(e,t,r,i){return new(r||(r=Promise))(function(s,n){function o(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,a)}c((i=i.apply(e,t||[])).next())})}function m(e,t){var r,i,s,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(n=0)),n;)try{if(r=1,i&&(s=2&a[0]?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,i=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(!(s=n.trys,(s=s.length>0&&s[s.length-1])||6!==a[0]&&2!==a[0])){n=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){n.label=a[1];break}if(6===a[0]&&n.label<s[1]){n.label=s[1],s=a;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(a);break}s[2]&&n.ops.pop(),n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e],i=0}finally{r=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var f=Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]};function S(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||f(t,e,r)}function y(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],i=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function _(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,s,n=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(e){s={error:e}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(s)throw s.error}}return o}function v(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(_(arguments[t]));return e}function E(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),s=0;for(t=0;t<r;t++)for(var n=arguments[t],o=0,a=n.length;o<a;o++,s++)i[s]=n[o];return i}function C(e,t,r){if(r||2===arguments.length)for(var i,s=0,n=t.length;s<n;s++)!i&&s in t||(i||(i=Array.prototype.slice.call(t,0,s)),i[s]=t[s]);return e.concat(i||Array.prototype.slice.call(t))}function T(e){return this instanceof T?(this.v=e,this):new T(e)}function b(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i,s=r.apply(e,t||[]),n=[];return i=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",function(e){return function(t){return Promise.resolve(t).then(e,l)}}),i[Symbol.asyncIterator]=function(){return this},i;function o(e,t){s[e]&&(i[e]=function(t){return new Promise(function(r,i){n.push([e,t,r,i])>1||a(e,t)})},t&&(i[e]=t(i[e])))}function a(e,t){try{(r=s[e](t)).value instanceof T?Promise.resolve(r.value.v).then(c,l):d(n[0][2],r)}catch(e){d(n[0][3],e)}var r}function c(e){a("next",e)}function l(e){a("throw",e)}function d(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function O(e){var t,r;return t={},i("next"),i("throw",function(e){throw e}),i("return"),t[Symbol.iterator]=function(){return this},t;function i(i,s){t[i]=e[i]?function(t){return(r=!r)?{value:T(e[i](t)),done:!1}:s?s(t):t}:s}}function A(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e="function"==typeof y?y(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(r){t[r]=e[r]&&function(t){return new Promise(function(i,s){(function(e,t,r,i){Promise.resolve(i).then(function(t){e({value:t,done:r})},t)})(i,s,(t=e[r](t)).done,t.value)})}}}function M(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var D=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t},w=function(e){return w=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},w(e)};function R(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=w(e),i=0;i<r.length;i++)"default"!==r[i]&&f(t,e,r[i]);return D(t,e),t}function N(e){return e&&e.__esModule?e:{default:e}}function P(e,t,r,i){if("a"===r&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(e):i?i.value:t.get(e)}function L(e,t,r,i,s){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?s.call(e,r):s?s.value=r:t.set(e,r),r}function I(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)}function k(e,t,r){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var i,s;if(r){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=t[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=t[Symbol.dispose],r&&(s=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");s&&(i=function(){try{s.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:i,async:r})}else r&&e.stack.push({async:!0});return t}var x="function"==typeof SuppressedError?SuppressedError:function(e,t,r){var i=new Error(r);return i.name="SuppressedError",i.error=e,i.suppressed=t,i};function B(e){function t(t){e.error=e.hasError?new x(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}var r,i=0;return function s(){for(;r=e.stack.pop();)try{if(!r.async&&1===i)return i=0,e.stack.push(r),Promise.resolve().then(s);if(r.dispose){var n=r.dispose.call(r.value);if(r.async)return i|=2,Promise.resolve(n).then(s,function(e){return t(e),s()})}else i|=1}catch(e){t(e)}if(1===i)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}()}function V(e,t){return"string"==typeof e&&/^\.\.?\//.test(e)?e.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(e,r,i,s,n){return r?t?".jsx":".js":!i||s&&n?i+s+"."+n.toLowerCase()+"js":e}):e}const F={__extends:s,__assign:n,__rest:o,__decorate:a,__param:c,__esDecorate:l,__runInitializers:d,__propKey:h,__setFunctionName:u,__metadata:g,__awaiter:p,__generator:m,__createBinding:f,__exportStar:S,__values:y,__read:_,__spread:v,__spreadArrays:E,__spreadArray:C,__await:T,__asyncGenerator:b,__asyncDelegator:O,__asyncValues:A,__makeTemplateObject:M,__importStar:R,__importDefault:N,__classPrivateFieldGet:P,__classPrivateFieldSet:L,__classPrivateFieldIn:I,__addDisposableResource:k,__disposeResources:B,__rewriteRelativeImportExtension:V}},5679:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.StorageType=t.DRIVER_EVENTS=t.DRIVER_COMMANDS=void 0,t.DRIVER_COMMANDS={SET_VERIFY_CODE:"driver.set_verify_code",SET_CAPTCHA:"driver.set_captcha",POLL_REFRESH:"driver.poll_refresh",IS_CONNECTED:"driver.is_connected",IS_PUSH_CONNECTED:"driver.is_push_connected",CONNECT:"driver.connect",DISCONNECT:"driver.disconnect",GET_VIDEO_EVENTS:"driver.get_video_events",GET_ALARM_EVENTS:"driver.get_alarm_events",GET_HISTORY_EVENTS:"driver.get_history_events",IS_MQTT_CONNECTED:"driver.is_mqtt_connected",SET_LOG_LEVEL:"driver.set_log_level",GET_LOG_LEVEL:"driver.get_log_level",START_LISTENING_LOGS:"driver.start_listening_logs",STOP_LISTENING_LOGS:"driver.stop_listening_logs",IS_LISTENING_LOGS:"driver.is_listening_logs"},t.DRIVER_EVENTS={VERIFY_CODE:"verify code",CAPTCHA_REQUEST:"captcha request",CONNECTED:"connected",DISCONNECTED:"disconnected",PUSH_CONNECTED:"push connected",PUSH_DISCONNECTED:"push disconnected",MQTT_CONNECTED:"mqtt connected",MQTT_DISCONNECTED:"mqtt disconnected",LOG_LEVEL_CHANGED:"log level changed",LOGGING:"logging",CONNECTION_ERROR:"connection error"},function(e){e[e.NONE=0]="NONE",e[e.LOCAL=1]="LOCAL",e[e.CLOUD=2]="CLOUD",e[e.LOCAL_AND_CLOUD=3]="LOCAL_AND_CLOUD"}(r||(t.StorageType=r={}))},5692:e=>{"use strict";e.exports=require("https")},5695:(e,t,r)=>{"use strict";const i=r(4434),s=r(8611),{Duplex:n}=r(2203),{createHash:o}=r(6982),a=r(2009),c=r(6978),l=r(3842),d=r(7051),{GUID:h,kWebSocket:u}=r(4033),g=/^[+/0-9A-Za-z]{22}==$/;function p(e){e._state=2,e.emit("close")}function m(){this.destroy()}function f(e,t,r,i){r=r||s.STATUS_CODES[t],i={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...i},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${s.STATUS_CODES[t]}\r\n`+Object.keys(i).map(e=>`${e}: ${i[e]}`).join("\r\n")+"\r\n\r\n"+r)}function S(e,t,r,i,s,n){if(e.listenerCount("wsClientError")){const i=new Error(s);Error.captureStackTrace(i,S),e.emit("wsClientError",i,r,t)}else f(r,i,s,n)}e.exports=class extends i{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:d,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=s.createServer((e,t)=>{const r=s.STATUS_CODES[426];t.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),t.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const r of Object.keys(t))e.on(r,t[r]);return function(){for(const r of Object.keys(t))e.removeListener(r,t[r])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,r,i)=>{this.handleUpgrade(t,r,i,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",()=>{e(new Error("The server is not running"))}),void process.nextTick(p,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(p,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close(()=>{p(this)})}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,r,i){t.on("error",m);const s=e.headers["sec-websocket-key"],n=e.headers.upgrade,o=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void S(this,e,t,405,"Invalid HTTP method")}if(void 0===n||"websocket"!==n.toLowerCase()){return void S(this,e,t,400,"Invalid Upgrade header")}if(void 0===s||!g.test(s)){return void S(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(13!==o&&8!==o){return void S(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"})}if(!this.shouldHandle(e))return void f(t,400);const d=e.headers["sec-websocket-protocol"];let h=new Set;if(void 0!==d)try{h=l.parse(d)}catch(r){return void S(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const u=e.headers["sec-websocket-extensions"],p={};if(this.options.perMessageDeflate&&void 0!==u){const r=new c(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=a.parse(u);e[c.extensionName]&&(r.accept(e[c.extensionName]),p[c.extensionName]=r)}catch(r){return void S(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const n={origin:e.headers[""+(8===o?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(n,(n,o,a,c)=>{if(!n)return f(t,o||401,a,c);this.completeUpgrade(p,s,h,e,t,r,i)});if(!this.options.verifyClient(n))return f(t,401)}this.completeUpgrade(p,s,h,e,t,r,i)}completeUpgrade(e,t,r,i,s,n,l){if(!s.readable||!s.writable)return s.destroy();if(s[u])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return f(s,503);const d=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${o("sha1").update(t+h).digest("base64")}`],g=new this.options.WebSocket(null,void 0,this.options);if(r.size){const e=this.options.handleProtocols?this.options.handleProtocols(r,i):r.values().next().value;e&&(d.push(`Sec-WebSocket-Protocol: ${e}`),g._protocol=e)}if(e[c.extensionName]){const t=e[c.extensionName].params,r=a.format({[c.extensionName]:[t]});d.push(`Sec-WebSocket-Extensions: ${r}`),g._extensions=e}this.emit("headers",d,i),s.write(d.concat("\r\n").join("\r\n")),s.removeListener("error",m),g.setSocket(s,n,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(g),g.on("close",()=>{this.clients.delete(g),this._shouldEmitClose&&!this.clients.size&&process.nextTick(p,this)})),l(g,i)}}},5720:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},6008:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.jsonStringifyRecursive=function(e){const t=new Set;return JSON.stringify(e,(e,r)=>{if("object"==typeof r&&null!==r){if(t.has(r))return"[Circular]";t.add(r)}return"bigint"==typeof r?`${r}`:"undefined"==typeof r?"[undefined]":r})}},6198:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.inspect=n,t.formatValue=_,t.formatWithOptions=function(e,...t){const r={seen:[],stylize:a};null!=e&&C(r,e);const i=t[0];let o=0,c="",l="";if("string"==typeof i){if(1===t.length)return i;let a,d=0;for(let l=0;l<i.length-1;l++)if(37===i.charCodeAt(l)){const h=i.charCodeAt(++l);if(o+1!==t.length){switch(h){case 115:{const i=t[++o];a="number"==typeof i||"bigint"==typeof i?E(r,i):"object"!=typeof i||null===i?String(i):n(i,{...e,compact:3,colors:!1,depth:0});break}case 106:a=(0,s.jsonStringifyRecursive)(t[++o]);break;case 100:{const e=t[++o];a="bigint"==typeof e?E(r,e):"symbol"==typeof e?"NaN":E(r,e);break}case 79:a=n(t[++o],e);break;case 111:a=n(t[++o],{...e,showHidden:!0,showProxy:!0,depth:4});break;case 105:{const e=t[++o];a="bigint"==typeof e?E(r,e):"symbol"==typeof e?"NaN":E(r,parseInt(a));break}case 102:{const e=t[++o];a="symbol"==typeof e?"NaN":E(r,parseInt(e));break}case 99:o+=1,a="";break;case 37:c+=i.slice(d,l),d=l+1;continue;default:continue}d!==l-1&&(c+=i.slice(d,l-1)),c+=a,d=l+1}else 37===h&&(c+=i.slice(d,l),d=l+1)}0!==d&&(o++,l=" ",d<i.length&&(c+=i.slice(d)))}for(;o<t.length;){const r=t[o];c+=l,c+="string"!=typeof r?n(r,e):r,l=" ",o++}return c};const i=r(1135),s=r(6008);function n(e,t){const r={seen:[],stylize:a};return null!=t&&C(r,t),o(r.showHidden)&&(r.showHidden=!1),o(r.depth)&&(r.depth=2),o(r.colors)&&(r.colors=!0),o(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=c),_(r,e,r.depth)}function o(e){return void 0===e}function a(e){return e}function c(e,t){const r=n.styles[t];return null!=r&&null!=n?.colors?.[r]?.[0]&&null!=n?.colors?.[r]?.[1]?"["+n.colors[r][0]+"m"+e+"["+n.colors[r][1]+"m":e}function l(e){return"function"==typeof e}function d(e){return"string"==typeof e}function h(e){return null===e}function u(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function g(e){return p(e)&&"[object RegExp]"===S(e)}function p(e){return"object"==typeof e&&null!==e}function m(e){return p(e)&&("[object Error]"===S(e)||e instanceof Error)}function f(e){return p(e)&&"[object Date]"===S(e)}function S(e){return Object.prototype.toString.call(e)}function y(e){return"["+Error.prototype.toString.call(e)+"]"}function _(e,t,r=0){if(e.customInspect&&null!=t&&l(t)&&t?.inspect!==n&&(!t?.constructor||t?.constructor.prototype!==t)){if("function"!=typeof t.inspect&&null!=t.toString)return t.toString();let i=t?.inspect(r,e);return d(i)||(i=_(e,i,r)),i}const i=E(e,t);if(i)return i;let s=Object.keys(t);const o=function(e){const t={};return e.forEach(e=>{t[e]=!0}),t}(s);try{e.showHidden&&Object.getOwnPropertyNames&&(s=Object.getOwnPropertyNames(t))}catch{}if(m(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return y(t);if(0===s.length){if(!l(e.stylize))return t;if(l(t)){const r=t.name?": "+t.name:"";return e.stylize("[Function"+r+"]","special")}if(g(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(f(t))return e.stylize(Date.prototype.toISOString.call(t),"date");if(m(t))return y(t)}let a,c="",h=!1,p=["{\n","\n}"];if(Array.isArray(t)&&(h=!0,p=["[\n","\n]"]),l(t)){c=" [Function"+(t.name?": "+t.name:"")+"]"}return g(t)&&(c=" "+RegExp.prototype.toString.call(t)),f(t)&&(c=" "+Date.prototype.toUTCString.call(t)),m(t)&&(c=" "+y(t)),0!==s.length||h&&0!=t.length?r<0?g(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),a=h?function(e,t,r,i,s){const n=[];for(let s=0,o=t.length;s<o;++s)u(t,String(s))?n.push(v(e,t,r,i,String(s),!0)):n.push("");return s.forEach(s=>{s.match(/^\d+$/)||n.push(v(e,t,r,i,s,!0))}),n}(e,t,r,o,s):s.map(i=>v(e,t,r,o,i,h)),e.seen.pop(),function(e,t,r){return r[0]+(""===t?"":t+"\n")+"  "+e.join(",\n  ")+" "+r[1]}(a,c,p)):p[0]+c+p[1]}function v(e,t,r,i,s,n){let a,c,l={value:void 0};try{l.value=t[s]}catch{}try{Object.getOwnPropertyDescriptor&&(l=Object.getOwnPropertyDescriptor(t,s)||l)}catch{}if(l.get?c=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(c=e.stylize("[Setter]","special")),u(i,s)||(a="["+s+"]"),c||(e.seen.indexOf(l.value)<0?(c=h(r)?_(e,l.value,void 0):_(e,l.value,r-1),c.indexOf("\n")>-1&&(c=n?c.split("\n").map(e=>"  "+e).join("\n").substr(2):"\n"+c.split("\n").map(e=>"   "+e).join("\n"))):c=e.stylize("[Circular]","special")),o(a)){if(n&&s.match(/^\d+$/))return c;a=JSON.stringify(""+s),a.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,"\\'").replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+c}function E(e,t){if(o(t))return e.stylize("undefined","undefined");if(d(t)){const r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,"\\'")+"'";return e.stylize(r,"string")}return"number"==typeof t?e.stylize(""+t,"number"):function(e){return"boolean"==typeof e}(t)?e.stylize(""+t,"boolean"):h(t)?e.stylize("null","null"):void 0}function C(e,t){const r={...e};if(!t||!p(t))return e;const i={...t},s=Object.keys(t);let n=s.length;for(;n--;)r[s[n]]=i[s[n]];return r}n.colors=i.prettyLogStyles,n.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"}},6350:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(5608);i.__exportStar(r(5679),t),i.__exportStar(r(4126),t),i.__exportStar(r(4861),t),i.__exportStar(r(8217),t),i.__exportStar(r(9454),t)},6386:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.BaseLogger=t.loggerEnvironment=void 0,t.createLoggerEnvironment=g;const n=r(9634),o=r(8799),a=r(8078),c=r(6710),l=r(6198),d=r(5456),h=r(2400),u=r(6008);function g(){const e=function(){if((0,h.isBrowserEnvironment)()){const e=globalThis.navigator;return{name:"browser",userAgent:e?.userAgent}}const e=globalThis;if("function"==typeof e.importScripts)return{name:"worker",userAgent:e.navigator?.userAgent};const t=globalThis;if(null!=t.Bun){const e=t.Bun.version;return{name:"bun",version:null!=e?`bun/${e}`:void 0,hostname:O(t.process,t.Deno,t.Bun,t.location)}}if(null!=t.Deno){const e=function(e){try{if("function"==typeof e?.hostname){const t=e.hostname();if(null!=t&&t.length>0)return t}}catch{}const t=globalThis.location?.hostname;if(null!=t&&t.length>0)return t;return}(t.Deno),r=t.Deno?.version?.deno;return{name:"deno",version:null!=r?`deno/${r}`:void 0,hostname:e??O(t.process,t.Deno,t.Bun,t.location)}}if(null!=t.process?.versions?.node||null!=t.process?.version)return{name:"node",version:t.process?.versions?.node??t.process?.version,hostname:O(t.process,t.Deno,t.Bun,t.location)};if(null!=t.process)return{name:"node",version:"unknown",hostname:O(t.process,t.Deno,t.Bun,t.location)};return{name:"unknown"}}(),t=function(t){if("browser"===t.name||"worker"===t.name)return{runtime:t.name,browser:t.userAgent};const r={runtime:t.name};"node"!==e.name&&"deno"!==e.name&&"bun"!==e.name||(r.runtimeVersion=t.version??"unknown");"node"!==e.name&&"deno"!==e.name&&"bun"!==e.name||(r.hostname=t.hostname??"unknown");return r}(e),r="browser"===e.name||"worker"===e.name,i=r?[...(0,d.getDefaultIgnorePatterns)(),/node_modules[\\/].*tslog/i]:[...(0,d.getDefaultIgnorePatterns)(),/node:(?:internal|vm)/i,/\binternal[\\/]/i];let s;const n={getMeta:(e,r,i,s,o,a)=>Object.assign({},t,{name:o,parentNames:a,date:new Date,logLevelId:e,logLevelName:r,path:s?void 0:n.getCallerStackFrame(i)}),getCallerStackFrame(e,t=new Error){const r=(0,d.buildStackTrace)(t,e=>g(e));if(0===r.length)return{};const s=(0,d.findFirstExternalFrameIndex)(r,i);return r[Number.isFinite(e)&&e>=0?(0,d.clampIndex)(e,r.length):(0,d.clampIndex)(s,r.length)]??{}},getErrorTrace:e=>(0,d.buildStackTrace)(e,e=>g(e)),isError:e=>function(e){if(e instanceof Error)return!0;if(null!=e&&"object"==typeof e){const t=Object.prototype.toString.call(e);if(/\[object .*Error\]/.test(t))return!0;const r=e.name;if("string"==typeof r&&r.endsWith("Error"))return!0}return!1}(e),isBuffer:e=>"undefined"!=typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(e),prettyFormatLogObj:(e,t)=>e.reduce((e,r)=>(n.isError(r)?e.errors.push(n.prettyFormatErrorObj(r,t)):e.args.push(r),e),{args:[],errors:[]}),prettyFormatErrorObj(e,t){const r=y(n.getErrorTrace(e),t),i=(0,a.collectErrorCauses)(e).map((e,r)=>[`Caused by (${r+1}): ${e.name??"Error"}${e.message?`: ${e.message}`:""}`,...y((0,d.buildStackTrace)(e,e=>g(e)),t)].join("\n")),s={errorName:` ${e.name} `,errorMessage:_(e),errorStack:[...r,...i].join("\n")};return(0,c.formatTemplate)(t,t.prettyErrorTemplate,s)},transportFormatted(t,r,i,s,n){const a=!1!==n.stylePrettyLogs,c=(i.length>0&&r.length>0?"\n":"")+i.join("\n"),l=t.replace(p,"");const d=a?t:l;if(function(t){return t&&("browser"===e.name||"worker"===e.name)&&(0,h.consoleSupportsCssStyling)()}(a)){n.prettyInspectOptions.colors=!1;const e=T(n.prettyInspectOptions,r),t=null!=s?function(e,t){if(null==t)return{text:"",styles:[]};const{template:r,placeholders:i}=(0,o.buildPrettyMeta)(e,t),s=[],n=[];let a=0;const c=/{{(.+?)}}/g;let l;for(;null!=(l=c.exec(r));){l.index>a&&s.push(r.slice(a,l.index));const t=l[1],o=null!=i[t]?String(i[t]):"",d=E(v(e.prettyLogStyles?.[t],o));d.length>0?(s.push(`%c${o}%c`),n.push(d,"")):s.push(o),a=c.lastIndex}a<r.length&&s.push(r.slice(a));return{text:s.join(""),styles:n}}(n,s):{text:l,styles:[]},i=t.text.length>0&&t.styles.length>0,a=(i?t.text:l)+e+c;return void(i?console.log(a,...t.styles):console.log(a))}n.prettyInspectOptions.colors=a;const u=T(n.prettyInspectOptions,r);console.log(d+u+c)},transportJSON(e){console.log((0,u.jsonStringifyRecursive)(e))}};return"test"===function(){const e=globalThis?.process;return e?.env?.NODE_ENV}()&&(n.__resetWorkingDirectoryCacheForTests=()=>{s=void 0}),n;function g(e){return r?function(e){const t=globalThis.location?.origin;if(null==e)return;const r=e.match(S);if(!r)return;const i=r[1]?.replace(/\?.*$/,"");if(null==i)return;const s=i.split("/"),n=r[2],o=r[3],a=s[s.length-1];return{fullFilePath:t?`${t}${i}`:i,fileName:a,fileNameWithLine:a&&n?`${a}:${n}`:void 0,fileColumn:o,fileLine:n,filePath:i,filePathWithLine:n?`${i}:${n}`:void 0,method:void 0}}(e):function(e){if("string"!=typeof e||0===e.length)return;const t=e.trim();if(!t.includes(" at ")&&!t.startsWith("at "))return;const r=t.replace(/^at\s+/,"");let i,n=r;const o=r.match(/^(.*?)\s+\((.*)\)$/);o&&(i=o[1],n=o[2]);const a=n.replace(/^\(/,"").replace(/\)$/,""),c=a.replace(/\?.*$/,"");let l,d,u=c;const g=c.split(":");g.length>=3&&/^\d+$/.test(g[g.length-1]??"")?(d=g.pop(),l=g.pop(),u=g.join(":")):g.length>=2&&/^\d+$/.test(g[g.length-1]??"")&&(l=g.pop(),u=g.join(":"));let p=u.replace(/^file:\/\//,"");const m=function(){void 0===s&&(s=(0,h.safeGetCwd)()??null);return s??void 0}();null!=m&&p.startsWith(m)&&(p=p.slice(m.length),p=p.replace(/^[\\/]/,""));0===p.length&&(p=u);const f=function(e){if("string"!=typeof e||0===e.length)return e;const t=e.replace(/\\+/g,"\\").replace(/\\/g,"/"),r=t.startsWith("//"),i=t.startsWith("/")&&!r,s=t.match(/^[A-Za-z]:/),n=s?s[0]:"",o=(n?t.slice(n.length):t).split("/"),a=[];for(const e of o)""!==e&&"."!==e&&(".."!==e?a.push(e):a.length>0&&a.pop());let c=a.join("/");r?c=`//${c}`:i?c=`/${c}`:""!==n&&(c=`${n}${c.length>0?`/${c}`:""}`);if(0===c.length)return e;return c}(p),S=f.length>0?f:p,y=S.split(/\\|\//),_=y[y.length-1],v=_&&l?`${_}:${l}`:void 0,E=S&&l?`${S}:${l}`:void 0;return{fullFilePath:a,fileName:_,fileNameWithLine:v,fileColumn:d,fileLine:l,filePath:S,filePathWithLine:E,method:i}}(e)}function y(e,t){return e.map(e=>(0,c.formatTemplate)(t,t.prettyErrorStackTemplate,{...e},!0))}function _(e){return Object.getOwnPropertyNames(e).filter(e=>"stack"!==e&&"cause"!==e).reduce((t,r)=>{const i=e[r];return"function"==typeof i||t.push(String(i)),t},[]).join(", ")}function v(e,t){if(null==e)return[];if("string"==typeof e)return[e];if(Array.isArray(e))return e.flatMap(e=>v(e,t));if("object"==typeof e){const r=e[t.trim()]??e["*"];return null==r?[]:v(r,t)}return[]}function E(e){const t=new Set,r=[];for(const i of e){const e=C(i);null!=e&&e.length>0&&!t.has(e)&&(t.add(e),r.push(e))}return r.join("; ")}function C(e){const t=m[e];if(null!=t)return`color: ${t}`;const r=f[e];if(null!=r)return`background-color: ${r}`;switch(e){case"bold":return"font-weight: bold";case"dim":return"opacity: 0.75";case"italic":return"font-style: italic";case"underline":return"text-decoration: underline";case"overline":return"text-decoration: overline";case"inverse":return"filter: invert(1)";case"hidden":return"visibility: hidden";case"strikethrough":return"text-decoration: line-through";default:return}}function T(e,t){try{return(0,l.formatWithOptions)(e,...t)}catch{return t.map(b).join(" ")}}function b(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return String(e)}}function O(e,t,r,i){const s=e?.env?.HOSTNAME??e?.env?.HOST??e?.env?.COMPUTERNAME;if(null!=s&&s.length>0)return s;const n=r?.env?.HOSTNAME??r?.env?.HOST??r?.env?.COMPUTERNAME;if(null!=n&&n.length>0)return n;try{const e=t?.env?.get;if("function"==typeof e){const t=e("HOSTNAME");if(null!=t&&t.length>0)return t}}catch{}return null!=i?.hostname&&i.hostname.length>0?i.hostname:void 0}}const p=/\u001b\[[0-9;]*m/g,m={black:"#000000",red:"#ef5350",green:"#66bb6a",yellow:"#fdd835",blue:"#42a5f5",magenta:"#ab47bc",cyan:"#26c6da",white:"#fafafa",blackBright:"#424242",redBright:"#ff7043",greenBright:"#81c784",yellowBright:"#ffe082",blueBright:"#64b5f6",magentaBright:"#ce93d8",cyanBright:"#4dd0e1",whiteBright:"#ffffff"},f={bgBlack:"#000000",bgRed:"#ef5350",bgGreen:"#66bb6a",bgYellow:"#fdd835",bgBlue:"#42a5f5",bgMagenta:"#ab47bc",bgCyan:"#26c6da",bgWhite:"#fafafa",bgBlackBright:"#424242",bgRedBright:"#ff7043",bgGreenBright:"#81c784",bgYellowBright:"#ffe082",bgBlueBright:"#64b5f6",bgMagentaBright:"#ce93d8",bgCyanBright:"#4dd0e1",bgWhiteBright:"#ffffff"},S=/(?:(?:file|https?|global code|[^@]+)@)?(?:file:)?((?:\/[^:/]+){2,})(?::(\d+))?(?::(\d+))?/,y=g();t.loggerEnvironment=y,s(r(299),t);t.BaseLogger=class{constructor(e,t,r=Number.NaN){this.logObj=t,this.stackDepthLevel=r,this.runtime=y,this.maxErrorCauseDepth=5,this.settings={type:e?.type??"pretty",name:e?.name,parentNames:e?.parentNames,minLevel:e?.minLevel??0,argumentsArrayName:e?.argumentsArrayName,hideLogPositionForProduction:e?.hideLogPositionForProduction??!1,prettyLogTemplate:e?.prettyLogTemplate??"{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}\t{{logLevelName}}\t{{filePathWithLine}}{{nameWithDelimiterPrefix}}\t",prettyErrorTemplate:e?.prettyErrorTemplate??"\n{{errorName}} {{errorMessage}}\nerror stack:\n{{errorStack}}",prettyErrorStackTemplate:e?.prettyErrorStackTemplate??"  â€¢ {{fileName}}\t{{method}}\n\t{{filePathWithLine}}",prettyErrorParentNamesSeparator:e?.prettyErrorParentNamesSeparator??":",prettyErrorLoggerNameDelimiter:e?.prettyErrorLoggerNameDelimiter??"\t",stylePrettyLogs:e?.stylePrettyLogs??!0,prettyLogTimeZone:e?.prettyLogTimeZone??"UTC",prettyLogStyles:e?.prettyLogStyles??{logLevelName:{"*":["bold","black","bgWhiteBright","dim"],SILLY:["bold","white"],TRACE:["bold","whiteBright"],DEBUG:["bold","green"],INFO:["bold","blue"],WARN:["bold","yellow"],ERROR:["bold","red"],FATAL:["bold","redBright"]},dateIsoStr:"white",filePathWithLine:"white",name:["white","bold"],nameWithDelimiterPrefix:["white","bold"],nameWithDelimiterSuffix:["white","bold"],errorName:["bold","bgRedBright","whiteBright"],fileName:["yellow"],fileNameWithLine:"white"},prettyInspectOptions:e?.prettyInspectOptions??{colors:!0,compact:!1,depth:1/0},metaProperty:e?.metaProperty??"_meta",maskPlaceholder:e?.maskPlaceholder??"[***]",maskValuesOfKeys:e?.maskValuesOfKeys??["password"],maskValuesOfKeysCaseInsensitive:e?.maskValuesOfKeysCaseInsensitive??!1,maskValuesRegEx:e?.maskValuesRegEx,prefix:[...e?.prefix??[]],attachedTransports:[...e?.attachedTransports??[]],overwrite:{mask:e?.overwrite?.mask,toLogObj:e?.overwrite?.toLogObj,addMeta:e?.overwrite?.addMeta,addPlaceholders:e?.overwrite?.addPlaceholders,formatMeta:e?.overwrite?.formatMeta,formatLogObj:e?.overwrite?.formatLogObj,transportFormatted:e?.overwrite?.transportFormatted,transportJSON:e?.overwrite?.transportJSON}},this.captureStackForMeta=this._shouldCaptureStack()}log(e,t,...r){if(e<this.settings.minLevel)return;const i=this._resolveLogArguments(r),s=[...this.settings.prefix,...i],n=null!=this.settings.overwrite?.mask?this.settings.overwrite?.mask(s):null!=this.settings.maskValuesOfKeys&&this.settings.maskValuesOfKeys.length>0?this._mask(s):s,o=null!=this.logObj?this._recursiveCloneAndExecuteFunctions(this.logObj):void 0,a=null!=this.settings.overwrite?.toLogObj?this.settings.overwrite?.toLogObj(n,o):this._toLogObj(n,o),c=null!=this.settings.overwrite?.addMeta?this.settings.overwrite?.addMeta(a,e,t):this._addMetaToLogObj(a,e,t),l=c?.[this.settings.metaProperty];let d,h;if(null!=this.settings.overwrite?.formatMeta&&(d=this.settings.overwrite?.formatMeta(c?.[this.settings.metaProperty])),null!=this.settings.overwrite?.formatLogObj&&(h=this.settings.overwrite?.formatLogObj(n,this.settings)),"pretty"===this.settings.type&&(d=d??this._prettyFormatLogObjMeta(c?.[this.settings.metaProperty]),h=h??y.prettyFormatLogObj(n,this.settings)),null!=d&&null!=h)if(null!=this.settings.overwrite?.transportFormatted){const e=this.settings.overwrite.transportFormatted,t=e.length;t<4?e(d,h.args,h.errors):4===t?e(d,h.args,h.errors,l):e(d,h.args,h.errors,l,this.settings)}else y.transportFormatted(d,h.args,h.errors,l,this.settings);else null!=this.settings.overwrite?.transportJSON?this.settings.overwrite.transportJSON(c):"hidden"!==this.settings.type&&y.transportJSON(c);return null!=this.settings.attachedTransports&&this.settings.attachedTransports.length>0&&this.settings.attachedTransports.forEach(e=>{e(c)}),c}attachTransport(e){this.settings.attachedTransports.push(e)}getSubLogger(e,t){const r={...this.settings,...e,parentNames:null!=this.settings?.parentNames&&null!=this.settings?.name?[...this.settings.parentNames,this.settings.name]:null!=this.settings?.name?[this.settings.name]:void 0,prefix:[...this.settings.prefix,...e?.prefix??[]]};return new this.constructor(r,t??this.logObj,this.stackDepthLevel)}_mask(e){const t=this._getMaskKeys();return e?.map(e=>this._recursiveCloneAndMaskValuesOfKeys(e,t))}_getMaskKeys(){const e=this.settings.maskValuesOfKeys??[],t=e.map(String).join("|");if(!0===this.settings.maskValuesOfKeysCaseInsensitive){if(this.maskKeysCache?.source===e&&!0===this.maskKeysCache.caseInsensitive&&this.maskKeysCache.signature===t)return this.maskKeysCache.normalized;const r=e.map(e=>"string"==typeof e?e.toLowerCase():String(e).toLowerCase());return this.maskKeysCache={source:e,caseInsensitive:!0,normalized:r,signature:t},r}return this.maskKeysCache={source:e,caseInsensitive:!1,normalized:e,signature:t},e}_resolveLogArguments(e){if(1===e.length&&"function"==typeof e[0]){const t=e[0];if(0===t.length){const e=t();return Array.isArray(e)?e:[e]}}return e}_recursiveCloneAndMaskValuesOfKeys(e,t,r=[]){if(r.includes(e))return{...e};if("object"==typeof e&&null!==e&&r.push(e),y.isError(e)||y.isBuffer(e))return e;if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(Array.isArray(e))return e.map(e=>this._recursiveCloneAndMaskValuesOfKeys(e,t,r));if(e instanceof Date)return new Date(e.getTime());if(e instanceof URL)return(0,n.urlToObject)(e);if(null!==e&&"object"==typeof e){const i=y.isError(e)?this._cloneError(e):Object.create(Object.getPrototypeOf(e));return Object.getOwnPropertyNames(e).reduce((i,s)=>{const n=!0!==this.settings?.maskValuesOfKeysCaseInsensitive?s:"string"==typeof s?s.toLowerCase():String(s).toLowerCase();return i[s]=t.includes(n)?this.settings.maskPlaceholder:(()=>{try{return this._recursiveCloneAndMaskValuesOfKeys(e[s],t,r)}catch{return null}})(),i},i)}if("string"==typeof e){let t=e;for(const e of this.settings?.maskValuesRegEx||[])t=t.replace(e,this.settings?.maskPlaceholder||"");return t}return e}_recursiveCloneAndExecuteFunctions(e,t=[]){return this.isObjectOrArray(e)&&t.includes(e)?this.shallowCopy(e):(this.isObjectOrArray(e)&&t.push(e),Array.isArray(e)?e.map(e=>this._recursiveCloneAndExecuteFunctions(e,t)):e instanceof Date?new Date(e.getTime()):this.isObject(e)?Object.getOwnPropertyNames(e).reduce((r,i)=>{const s=Object.getOwnPropertyDescriptor(e,i);if(s){Object.defineProperty(r,i,s);const n=e[i];r[i]="function"==typeof n?n():this._recursiveCloneAndExecuteFunctions(n,t)}return r},Object.create(Object.getPrototypeOf(e))):e)}isObjectOrArray(e){return"object"==typeof e&&null!==e}isObject(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}shallowCopy(e){return Array.isArray(e)?[...e]:{...e}}_toLogObj(e,t={}){return e=e?.map(e=>y.isError(e)?this._toErrorObject(e):e),t=null==this.settings.argumentsArrayName?1!==e.length||Array.isArray(e[0])||!0===y.isBuffer(e[0])||e[0]instanceof Date?{...t,...e}:"object"==typeof e[0]&&null!=e[0]?{...e[0],...t}:{0:e[0],...t}:{...t,[this.settings.argumentsArrayName]:e}}_cloneError(e){const t=new e.constructor;return Object.getOwnPropertyNames(e).forEach(r=>{t[r]=e[r]}),t}_toErrorObject(e,t=0,r=new Set){r.has(e)||r.add(e);const i={nativeError:e,name:e.name??"Error",message:e.message,stack:y.getErrorTrace(e)};if(t>=this.maxErrorCauseDepth)return i;const s=e.cause;if(null!=s){const e=(0,a.toError)(s);r.has(e)||(i.cause=this._toErrorObject(e,t+1,r))}return i}_addMetaToLogObj(e,t,r){return{...e,[this.settings.metaProperty]:y.getMeta(t,r,this.stackDepthLevel,!this.captureStackForMeta,this.settings.name,this.settings.parentNames)}}_shouldCaptureStack(){if(this.settings.hideLogPositionForProduction)return!1;if("json"===this.settings.type)return!0;const e=this.settings.prettyLogTemplate??"";return!!/{{\s*(file(Name|Path|Line|PathWithLine|NameWithLine)|fullFilePath)\s*}}/.test(e)}_prettyFormatLogObjMeta(e){return(0,o.buildPrettyMeta)(this.settings,e).text}}},6447:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.formatNumberAddZeros=function(e,t=2,r=0){if(null!=e&&isNaN(e))return"";return e=null!=e?e+r:e,2===t?null==e?"--":e<10?"0"+e:e.toString():null==e?"---":e<10?"00"+e:e<100?"0"+e:e.toString()}},6560:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MESSAGE_TYPES=void 0,t.MESSAGE_TYPES={VERSION:"version",RESULT:"result",EVENT:"event"}},6710:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.formatTemplate=function(e,t,r,s=!1){const n=String(t),o=(e,t)=>`[${t[0]}m${e}[${t[1]}m`,a=(e,t)=>null!=t&&"string"==typeof t?o(e,i.prettyLogStyles[t]):null!=t&&Array.isArray(t)?t.reduce((e,t)=>a(e,t),e):null!=t&&null!=t[e.trim()]?a(e,t[e.trim()]):null!=t&&null!=t["*"]?a(e,t["*"]):e;return n.replace(/{{(.+?)}}/g,(t,n)=>{const c=null!=r[n]?String(r[n]):s?"":t;return e.stylePrettyLogs?a(c,e?.prettyLogStyles?.[n]??null)+o("",i.prettyLogStyles.reset):c})};const i=r(1135)},6978:(e,t,r)=>{"use strict";const i=r(3106),s=r(7213),n=r(5348),{kStatusCode:o}=r(4033),a=Buffer[Symbol.species],c=Buffer.from([0,0,255,255]),l=Symbol("permessage-deflate"),d=Symbol("total-length"),h=Symbol("callback"),u=Symbol("buffers"),g=Symbol("error");let p;function m(e){this[u].push(e),this[d]+=e.length}function f(e){this[d]+=e.length,this[l]._maxPayload<1||this[d]<=this[l]._maxPayload?this[u].push(e):(this[g]=new RangeError("Max payload size exceeded"),this[g].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[g][o]=1009,this.removeListener("data",f),this.reset())}function S(e){this[l]._inflate=null,this[g]?this[h](this[g]):(e[o]=1007,this[h](e))}e.exports=class{constructor(e,t,r){if(this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!p){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;p=new n(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[h];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let r=e[t];if(r.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(r=r[0],"client_max_window_bits"===t){if(!0!==r){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}else if("server_max_window_bits"===t){const e=+r;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${r}`);r=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==r)throw new TypeError(`Invalid value for parameter "${t}": ${r}`)}e[t]=r})}),e}decompress(e,t,r){p.add(i=>{this._decompress(e,t,(e,t)=>{i(),r(e,t)})})}compress(e,t,r){p.add(i=>{this._compress(e,t,(e,t)=>{i(),r(e,t)})})}_decompress(e,t,r){const n=this._isServer?"client":"server";if(!this._inflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=i.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[l]=this,this._inflate[d]=0,this._inflate[u]=[],this._inflate.on("error",S),this._inflate.on("data",f)}this._inflate[h]=r,this._inflate.write(e),t&&this._inflate.write(c),this._inflate.flush(()=>{const e=this._inflate[g];if(e)return this._inflate.close(),this._inflate=null,void r(e);const i=s.concat(this._inflate[u],this._inflate[d]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[d]=0,this._inflate[u]=[],t&&this.params[`${n}_no_context_takeover`]&&this._inflate.reset()),r(null,i)})}_compress(e,t,r){const n=this._isServer?"server":"client";if(!this._deflate){const e=`${n}_max_window_bits`,t="number"!=typeof this.params[e]?i.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=i.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[d]=0,this._deflate[u]=[],this._deflate.on("data",m)}this._deflate[h]=r,this._deflate.write(e),this._deflate.flush(i.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=s.concat(this._deflate[u],this._deflate[d]);t&&(e=new a(e.buffer,e.byteOffset,e.length-4)),this._deflate[h]=null,this._deflate[d]=0,this._deflate[u]=[],t&&this.params[`${n}_no_context_takeover`]&&this._deflate.reset(),r(null,e)})}}},6982:e=>{"use strict";e.exports=require("crypto")},7016:e=>{"use strict";e.exports=require("url")},7039:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;const n=r(6386);s(r(299),t),s(r(6386),t);class o extends n.BaseLogger{constructor(e,t){const r={...e??{}};"undefined"!=typeof window&&"undefined"!=typeof document&&(r.stylePrettyLogs=e?.stylePrettyLogs??!0),super(r,t,Number.NaN)}log(e,t,...r){return super.log(e,t,...r)}silly(...e){return super.log(0,"SILLY",...e)}trace(...e){return super.log(1,"TRACE",...e)}debug(...e){return super.log(2,"DEBUG",...e)}info(...e){return super.log(3,"INFO",...e)}warn(...e){return super.log(4,"WARN",...e)}error(...e){return super.log(5,"ERROR",...e)}fatal(...e){return super.log(6,"FATAL",...e)}getSubLogger(e,t){return super.getSubLogger(e,t)}}t.Logger=o},7051:(e,t,r)=>{"use strict";const i=r(4434),s=r(5692),n=r(8611),o=r(9278),a=r(4756),{randomBytes:c,createHash:l}=r(6982),{Duplex:d,Readable:h}=r(2203),{URL:u}=r(7016),g=r(6978),p=r(1611),m=r(1031),{isBlob:f}=r(3977),{BINARY_TYPES:S,EMPTY_BUFFER:y,GUID:_,kForOnEventAttribute:v,kListener:E,kStatusCode:C,kWebSocket:T,NOOP:b}=r(4033),{EventTarget:{addEventListener:O,removeEventListener:A}}=r(4400),{format:M,parse:D}=r(2009),{toBuffer:w}=r(7213),R=Symbol("kAborted"),N=[8,13],P=["CONNECTING","OPEN","CLOSING","CLOSED"],L=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class I extends i{constructor(e,t,r){super(),this._binaryType=S[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=y,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=I.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(r=t,t=[]):t=[t]),k(this,e,t,r)):(this._autoPong=r.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){S.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const i=new p({allowSynchronousEvents:r.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation}),s=new m(e,this._extensions,r.generateMask);this._receiver=i,this._sender=s,this._socket=e,i[T]=this,s[T]=this,e[T]=this,i.on("conclude",j),i.on("drain",$),i.on("error",G),i.on("message",W),i.on("ping",Y),i.on("pong",K),s.onerror=q,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",J),e.on("data",Z),e.on("end",X),e.on("error",ee),this._readyState=I.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=I.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[g.extensionName]&&this._extensions[g.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=I.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING){const e="WebSocket was closed before the connection was established";return void F(this,this._req,e)}this.readyState!==I.CLOSING?(this._readyState=I.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),Q(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,r){if(this.readyState===I.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===I.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||y,t,r)):U(this,e,r)}pong(e,t,r){if(this.readyState===I.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===I.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||y,t,r)):U(this,e,r)}resume(){this.readyState!==I.CONNECTING&&this.readyState!==I.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,r){if(this.readyState===I.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==I.OPEN)return void U(this,e,r);const i={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[g.extensionName]||(i.compress=!1),this._sender.send(e||y,i,r)}terminate(){if(this.readyState!==I.CLOSED){if(this.readyState===I.CONNECTING){const e="WebSocket was closed before the connection was established";return void F(this,this._req,e)}this._socket&&(this._readyState=I.CLOSING,this._socket.destroy())}}}function k(e,t,r,i){const o={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:N[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...i,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=o.autoPong,!N.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${N.join(", ")})`);let a;if(t instanceof u)a=t;else try{a=new u(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===a.protocol?a.protocol="ws:":"https:"===a.protocol&&(a.protocol="wss:"),e._url=a.href;const d="wss:"===a.protocol,h="ws+unix:"===a.protocol;let p;if("ws:"===a.protocol||d||h?h&&!a.pathname?p="The URL's pathname is empty":a.hash&&(p="The URL contains a fragment identifier"):p='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"',p){const t=new SyntaxError(p);if(0===e._redirects)throw t;return void x(e,t)}const m=d?443:80,f=c(16).toString("base64"),S=d?s.request:n.request,y=new Set;let v,E;if(o.createConnection=o.createConnection||(d?V:B),o.defaultPort=o.defaultPort||m,o.port=a.port||m,o.host=a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,o.headers={...o.headers,"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":f,Connection:"Upgrade",Upgrade:"websocket"},o.path=a.pathname+a.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(v=new g(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=M({[g.extensionName]:v.offer()})),r.length){for(const e of r){if("string"!=typeof e||!L.test(e)||y.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");y.add(e)}o.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(a.username||a.password)&&(o.auth=`${a.username}:${a.password}`),h){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalIpc=h,e._originalSecure=d,e._originalHostOrSocketPath=h?o.socketPath:a.host;const t=i&&i.headers;if(i={...i,headers:{}},t)for(const[e,r]of Object.entries(t))i.headers[e.toLowerCase()]=r}else if(0===e.listenerCount("redirect")){const t=h?!!e._originalIpc&&o.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&a.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!d)&&(delete o.headers.authorization,delete o.headers.cookie,t||delete o.headers.host,o.auth=void 0)}o.auth&&!i.headers.authorization&&(i.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64")),E=e._req=S(o),e._redirects&&e.emit("redirect",e.url,E)}else E=e._req=S(o);o.timeout&&E.on("timeout",()=>{F(e,E,"Opening handshake has timed out")}),E.on("error",t=>{null===E||E[R]||(E=e._req=null,x(e,t))}),E.on("response",s=>{const n=s.headers.location,a=s.statusCode;if(n&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void F(e,E,"Maximum redirects exceeded");let s;E.abort();try{s=new u(n,t)}catch(t){const r=new SyntaxError(`Invalid URL: ${n}`);return void x(e,r)}k(e,s,r,i)}else e.emit("unexpected-response",E,s)||F(e,E,`Unexpected server response: ${s.statusCode}`)}),E.on("upgrade",(t,r,i)=>{if(e.emit("upgrade",t),e.readyState!==I.CONNECTING)return;E=e._req=null;const s=t.headers.upgrade;if(void 0===s||"websocket"!==s.toLowerCase())return void F(e,r,"Invalid Upgrade header");const n=l("sha1").update(f+_).digest("base64");if(t.headers["sec-websocket-accept"]!==n)return void F(e,r,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let c;if(void 0!==a?y.size?y.has(a)||(c="Server sent an invalid subprotocol"):c="Server sent a subprotocol but none was requested":y.size&&(c="Server sent no subprotocol"),c)return void F(e,r,c);a&&(e._protocol=a);const d=t.headers["sec-websocket-extensions"];if(void 0!==d){if(!v){return void F(e,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=D(d)}catch(t){return void F(e,r,"Invalid Sec-WebSocket-Extensions header")}const i=Object.keys(t);if(1!==i.length||i[0]!==g.extensionName){return void F(e,r,"Server indicated an extension that was not requested")}try{v.accept(t[g.extensionName])}catch(t){return void F(e,r,"Invalid Sec-WebSocket-Extensions header")}e._extensions[g.extensionName]=v}e.setSocket(r,i,{allowSynchronousEvents:o.allowSynchronousEvents,generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})}),o.finishRequest?o.finishRequest(E,e):E.end()}function x(e,t){e._readyState=I.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function B(e){return e.path=e.socketPath,o.connect(e)}function V(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=o.isIP(e.host)?"":e.host),a.connect(e)}function F(e,t,r){e._readyState=I.CLOSING;const i=new Error(r);Error.captureStackTrace(i,F),t.setHeader?(t[R]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(x,e,i)):(t.destroy(i),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function U(e,t,r){if(t){const r=f(t)?t.size:w(t).length;e._socket?e._sender._bufferedBytes+=r:e._bufferedAmount+=r}if(r){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${P[e.readyState]})`);process.nextTick(r,t)}}function j(e,t){const r=this[T];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[T]&&(r._socket.removeListener("data",Z),process.nextTick(z,r._socket),1005===e?r.close():r.close(e,t))}function $(){const e=this[T];e.isPaused||e._socket.resume()}function G(e){const t=this[T];void 0!==t._socket[T]&&(t._socket.removeListener("data",Z),process.nextTick(z,t._socket),t.close(e[C])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function H(){this[T].emitClose()}function W(e,t){this[T].emit("message",e,t)}function Y(e){const t=this[T];t._autoPong&&t.pong(e,!this._isServer,b),t.emit("ping",e)}function K(e){this[T].emit("pong",e)}function z(e){e.resume()}function q(e){const t=this[T];t.readyState!==I.CLOSED&&(t.readyState===I.OPEN&&(t._readyState=I.CLOSING,Q(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function Q(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),3e4)}function J(){const e=this[T];let t;this.removeListener("close",J),this.removeListener("data",Z),this.removeListener("end",X),e._readyState=I.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[T]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",H),e._receiver.on("finish",H))}function Z(e){this[T]._receiver.write(e)||this.pause()}function X(){const e=this[T];e._readyState=I.CLOSING,e._receiver.end(),this.end()}function ee(){const e=this[T];this.removeListener("error",ee),this.on("error",b),e&&(e._readyState=I.CLOSING,this.destroy())}Object.defineProperty(I,"CONNECTING",{enumerable:!0,value:P.indexOf("CONNECTING")}),Object.defineProperty(I.prototype,"CONNECTING",{enumerable:!0,value:P.indexOf("CONNECTING")}),Object.defineProperty(I,"OPEN",{enumerable:!0,value:P.indexOf("OPEN")}),Object.defineProperty(I.prototype,"OPEN",{enumerable:!0,value:P.indexOf("OPEN")}),Object.defineProperty(I,"CLOSING",{enumerable:!0,value:P.indexOf("CLOSING")}),Object.defineProperty(I.prototype,"CLOSING",{enumerable:!0,value:P.indexOf("CLOSING")}),Object.defineProperty(I,"CLOSED",{enumerable:!0,value:P.indexOf("CLOSED")}),Object.defineProperty(I.prototype,"CLOSED",{enumerable:!0,value:P.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(e=>{Object.defineProperty(I.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(I.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[v])return t[E];return null},set(t){for(const t of this.listeners(e))if(t[v]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[v]:!0})}})}),I.prototype.addEventListener=O,I.prototype.removeEventListener=A,e.exports=I},7213:(e,t,r)=>{"use strict";const{EMPTY_BUFFER:i}=r(4033),s=Buffer[Symbol.species];function n(e,t,r,i,s){for(let n=0;n<s;n++)r[i+n]=e[n]^t[3&n]}function o(e,t){for(let r=0;r<e.length;r++)e[r]^=t[3&r]}if(e.exports={concat:function(e,t){if(0===e.length)return i;if(1===e.length)return e[0];const r=Buffer.allocUnsafe(t);let n=0;for(let t=0;t<e.length;t++){const i=e[t];r.set(i,n),n+=i.length}return n<t?new s(r.buffer,r.byteOffset,n):r},mask:n,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let r;return t instanceof ArrayBuffer?r=new s(t):ArrayBuffer.isView(t)?r=new s(t.buffer,t.byteOffset,t.byteLength):(r=Buffer.from(t),e.readOnly=!1),r},unmask:o},!process.env.WS_NO_BUFFER_UTIL)try{const t=r(Object(function(){var e=new Error("Cannot find module 'bufferutil'");throw e.code="MODULE_NOT_FOUND",e}()));e.exports.mask=function(e,r,i,s,o){o<48?n(e,r,i,s,o):t.mask(e,r,i,s,o)},e.exports.unmask=function(e,r){e.length<32?o(e,r):t.unmask(e,r)}}catch(e){}},7562:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sdk=t.MixinDeviceBase=t.ScryptedDeviceBase=void 0,s(r(4192),t);const o=n(r(9896)),a=r(4192);r(3339);class c extends a.DeviceBase{constructor(e){super(),this.nativeId=e}get storage(){return this._storage||(this._storage=t.sdk.deviceManager.getDeviceStorage(this.nativeId)),this._storage}get log(){return this._log||(this._log=t.sdk.deviceManager.getDeviceLogger(this.nativeId)),this._log}get console(){return this._console||(this._console=t.sdk.deviceManager.getDeviceConsole(this.nativeId)),this._console}async createMediaObject(e,r){return t.sdk.mediaManager.createMediaObject(e,r,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.nativeId)}_lazyLoadDeviceState(){this._deviceState||(this.nativeId?this._deviceState=t.sdk.deviceManager.getDeviceState(this.nativeId):this._deviceState=t.sdk.deviceManager.getDeviceState())}onDeviceEvent(e,r){return t.sdk.deviceManager.onDeviceEvent(this.nativeId,e,r)}}t.ScryptedDeviceBase=c;class l extends a.DeviceBase{constructor(e){super(),this._listeners=new Set,this.mixinDevice=e.mixinDevice,this.mixinDeviceInterfaces=e.mixinDeviceInterfaces,this.mixinStorageSuffix=e.mixinStorageSuffix,this._deviceState=e.mixinDeviceState,this.nativeId=t.sdk.systemManager.getDeviceById(this.id).nativeId,this.mixinProviderNativeId=e.mixinProviderNativeId,this._deviceState.__rpcproxy_traps_all_properties&&"string"==typeof this._deviceState.id&&(this._deviceState=t.sdk.deviceManager.createDeviceState(this._deviceState.id,this._deviceState.setState))}get storage(){if(!this._storage){const e=this.mixinStorageSuffix,r=this.id+(e?":"+e:"");this._storage=t.sdk.deviceManager.getMixinStorage(r,this.mixinProviderNativeId)}return this._storage}get console(){return this._console||(t.sdk.deviceManager.getMixinConsole?this._console=t.sdk.deviceManager.getMixinConsole(this.id,this.mixinProviderNativeId):this._console=t.sdk.deviceManager.getDeviceConsole(this.mixinProviderNativeId)),this._console}async createMediaObject(e,r){return t.sdk.mediaManager.createMediaObject(e,r,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.mixinProviderNativeId)}onDeviceEvent(e,r){return t.sdk.deviceManager.onMixinEvent(this.id,this,e,r)}_lazyLoadDeviceState(){}manageListener(e){this._listeners.add(e)}release(){for(const e of this._listeners)e.removeListener()}}t.MixinDeviceBase=l,function(){function e(e){return function(){return this._lazyLoadDeviceState(),this._deviceState?.[e]}}function t(e){return function(t){this._lazyLoadDeviceState(),this._deviceState?this._deviceState[e]=t:console.warn("device state is unavailable. the device must be discovered with deviceManager.onDeviceDiscovered or deviceManager.onDevicesChanged before the state can be set.")}}for(const r of Object.values(a.ScryptedInterfaceProperty))r!==a.ScryptedInterfaceProperty.nativeId&&(Object.defineProperty(c.prototype,r,{set:t(r),get:e(r)}),Object.defineProperty(l.prototype,r,{set:t(r),get:e(r)}))}(),t.sdk={};try{let e=!1;try{process.env.SCRYPTED_SDK_ES_MODULE||process.env.SCRYPTED_SDK_MODULE;const i=process.env.SCRYPTED_SDK_CJS_MODULE||process.env.SCRYPTED_SDK_MODULE;if(i)if("undefined"!=typeof require){const r=require(process.env.SCRYPTED_SDK_MODULE);Object.assign(t.sdk,r.getScryptedStatic()),e=!0}else{const s=r(3891)(i);Object.assign(t.sdk,s.getScryptedStatic()),e=!0}}catch(e){throw console.warn("failed to load sdk module",e),e}if(!e){let e;try{e=pluginRuntimeAPI}catch(e){}Object.assign(t.sdk,{log:deviceManager.getDeviceLogger(void 0),deviceManager,endpointManager,mediaManager,systemManager,pluginHostAPI,...e})}try{let e={...a.ScryptedInterfaceDescriptors};try{const t=JSON.parse(o.default.readFileSync("../sdk.json").toString()).interfaceDescriptors;t&&(e={...e,...t})}catch(e){console.warn("failed to load custom interface descriptors",e)}t.sdk.systemManager.setScryptedInterfaceDescriptors?.(a.TYPES_VERSION,e)?.catch(()=>{})}catch(e){}}catch(e){console.error("sdk initialization error, import @scrypted/types or use @scrypted/client instead",e)}t.default=t.sdk},8078:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.collectErrorCauses=function(e,t={}){const r=t.maxDepth??s,i=[],o=new Set;let a=e,c=0;for(;null!=a&&c<r;){const e=a?.cause;if(null==e||o.has(e))break;o.add(e),i.push(n(e)),a=e,c+=1}return i},t.toError=n,t.toErrorObject=function(e,t){return{nativeError:e,name:e.name??"Error",message:e.message??"",stack:(0,i.buildStackTrace)(e,t)}};const i=r(5456),s=5;function n(e){if(e instanceof Error)return e;const t=new Error("string"==typeof e?e:JSON.stringify(e));return"object"==typeof e&&null!=e&&Object.assign(t,e),t}},8217:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},8611:e=>{"use strict";e.exports=require("http")},8700:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.ClientStateManager=t.ConnectionState=void 0,function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.SCHEMA_NEGOTIATING="schema_negotiating",e.READY="ready",e.ERROR="error"}(r||(t.ConnectionState=r={}));t.ClientStateManager=class{constructor(e){this.state={connection:r.DISCONNECTED,wsConnected:!1,schemaSetupComplete:!1,driverConnected:!1,schemaInfo:null,lastError:null,reconnectAttempts:0,eventListenerCount:0},this.stateChangeCallbacks=[],this.logger=e}getState(){return{...this.state}}setConnectionState(e){this.state.connection!==e&&(this.state.connection=e,this.notifyStateChange())}setWebSocketConnected(e){this.state.wsConnected!==e&&(this.state.wsConnected=e,e?this.updateConnectionStateFromConditions():(this.state.schemaSetupComplete=!1,this.state.driverConnected=!1,this.state.connection=r.DISCONNECTED),this.notifyStateChange())}setSchemaSetupComplete(e){this.state.schemaSetupComplete!==e&&(this.state.schemaSetupComplete=e,this.updateConnectionStateFromConditions(),this.notifyStateChange())}setDriverConnected(e){this.state.driverConnected!==e&&(this.state.driverConnected=e,this.notifyStateChange())}setSchemaInfo(e){this.state.schemaInfo=e,this.notifyStateChange()}setError(e){this.state.lastError=e,e&&(this.state.connection=r.ERROR),this.notifyStateChange()}setReconnectAttempts(e){this.state.reconnectAttempts=e,this.notifyStateChange()}setEventListenerCount(e){this.state.eventListenerCount=e,this.notifyStateChange()}updateConnectionStateFromConditions(){this.state.wsConnected&&this.state.schemaSetupComplete&&(this.state.connection=r.READY)}isReady(){return this.state.connection===r.READY&&this.state.wsConnected&&this.state.schemaSetupComplete}reset(){this.state={connection:r.DISCONNECTED,wsConnected:!1,schemaSetupComplete:!1,driverConnected:!1,schemaInfo:null,lastError:null,reconnectAttempts:0,eventListenerCount:this.state.eventListenerCount},this.notifyStateChange()}onStateChange(e){return this.stateChangeCallbacks.push(e),()=>{const t=this.stateChangeCallbacks.indexOf(e);t>-1&&this.stateChangeCallbacks.splice(t,1)}}notifyStateChange(){const e=this.getState();this.stateChangeCallbacks.forEach(t=>{try{t(e)}catch(e){}})}}},8799:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.buildPrettyMeta=function(e,t){if(null==t)return{text:"",template:e.prettyLogTemplate,placeholders:{}};let r=e.prettyLogTemplate;const n={};r.includes("{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}")?r=r.replace("{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}","{{dateIsoStr}}"):"UTC"===e.prettyLogTimeZone?(n.yyyy=t.date?.getUTCFullYear()??"----",n.mm=(0,s.formatNumberAddZeros)(t.date?.getUTCMonth(),2,1),n.dd=(0,s.formatNumberAddZeros)(t.date?.getUTCDate(),2),n.hh=(0,s.formatNumberAddZeros)(t.date?.getUTCHours(),2),n.MM=(0,s.formatNumberAddZeros)(t.date?.getUTCMinutes(),2),n.ss=(0,s.formatNumberAddZeros)(t.date?.getUTCSeconds(),2),n.ms=(0,s.formatNumberAddZeros)(t.date?.getUTCMilliseconds(),3)):(n.yyyy=t.date?.getFullYear()??"----",n.mm=(0,s.formatNumberAddZeros)(t.date?.getMonth(),2,1),n.dd=(0,s.formatNumberAddZeros)(t.date?.getDate(),2),n.hh=(0,s.formatNumberAddZeros)(t.date?.getHours(),2),n.MM=(0,s.formatNumberAddZeros)(t.date?.getMinutes(),2),n.ss=(0,s.formatNumberAddZeros)(t.date?.getSeconds(),2),n.ms=(0,s.formatNumberAddZeros)(t.date?.getMilliseconds(),3));const o="UTC"===e.prettyLogTimeZone?t.date:null!=t.date?new Date(t.date.getTime()-6e4*t.date.getTimezoneOffset()):void 0;n.rawIsoStr=o?.toISOString()??"",n.dateIsoStr=o?.toISOString().replace("T"," ").replace("Z","")??"",n.logLevelName=t.logLevelName,n.fileNameWithLine=t.path?.fileNameWithLine??"",n.filePathWithLine=t.path?.filePathWithLine??"",n.fullFilePath=t.path?.fullFilePath??"";let a=e.parentNames?.join(e.prettyErrorParentNamesSeparator);a=null!=a&&null!=t.name?a+e.prettyErrorParentNamesSeparator:void 0;const c=null!=t.name||null!=a?`${a??""}${t.name??""}`:"";n.name=c,n.nameWithDelimiterPrefix=c.length>0?e.prettyErrorLoggerNameDelimiter+c:"",n.nameWithDelimiterSuffix=c.length>0?c+e.prettyErrorLoggerNameDelimiter:"",null!=e.overwrite?.addPlaceholders&&e.overwrite.addPlaceholders(t,n);return{text:(0,i.formatTemplate)(e,r,n),template:r,placeholders:n}};const i=r(6710),s=r(6447)},9259:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},9278:e=>{"use strict";e.exports=require("net")},9300:(e,t,r)=>{"use strict";function i(e){return Object.values(t.EVENT_SOURCES).includes(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.ALL_COMMANDS=t.SERVER_COMMANDS=t.DRIVER_COMMANDS=t.STATION_COMMANDS=t.DEVICE_COMMANDS=t.EVENT_SOURCES=void 0,t.isValidEventSource=i,t.assertEventSource=function(e){if(!i(e))throw new Error(`Invalid event source: ${e}. Valid sources are: ${Object.values(t.EVENT_SOURCES).join(", ")}`)},t.EVENT_SOURCES={SERVER:"server",DRIVER:"driver",DEVICE:"device",STATION:"station"};var s=r(1187);Object.defineProperty(t,"DEVICE_COMMANDS",{enumerable:!0,get:function(){return s.DEVICE_COMMANDS}});var n=r(3405);Object.defineProperty(t,"STATION_COMMANDS",{enumerable:!0,get:function(){return n.STATION_COMMANDS}});var o=r(5679);Object.defineProperty(t,"DRIVER_COMMANDS",{enumerable:!0,get:function(){return o.DRIVER_COMMANDS}});var a=r(5494);Object.defineProperty(t,"SERVER_COMMANDS",{enumerable:!0,get:function(){return a.SERVER_COMMANDS}});const c=r(1187),l=r(3405),d=r(5679),h=r(5494);t.ALL_COMMANDS={DEVICE:c.DEVICE_COMMANDS,STATION:l.STATION_COMMANDS,DRIVER:d.DRIVER_COMMANDS,SERVER:h.SERVER_COMMANDS}},9454:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(5679)},9634:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.urlToObject=function(e){return{href:e.href,protocol:e.protocol,username:e.username,password:e.password,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,searchParams:[...e.searchParams].map(([e,t])=>({key:e,value:t})),hash:e.hash,origin:e.origin}}},9636:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});r(3405)},9749:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MODEL_NAMES=t.ERROR_RESILIENT_CAMERA_TYPES=t.KEYPAD_TYPES=t.SMART_DROP_TYPES=t.SMART_TRACK_TYPES=t.SMART_SAFE_TYPES=t.GARAGE_CAMERA_TYPES=t.CAMERA_3_TYPES=t.CAMERA_2_TYPES=t.CAMERA_E_TYPES=t.CAMERA_1_TYPES=t.LOCK_KEYPAD_TYPES=t.LOCK_WIFI_TYPES=t.LOCK_BLE_TYPES=t.DUAL_DOORBELL_TYPES=t.BATTERY_DOORBELL_TYPES=t.WIRED_DOORBELL_TYPES=t.INDOOR_CAMERA_TYPES=t.SOLO_CAMERA_TYPES=t.SUPPORTED_DEVICE_TYPES=t.PAN_TILT_DEVICE_TYPES=t.BATTERY_DEVICE_TYPES=t.BASE_STATION_DEVICE_TYPES=t.LOCK_DEVICE_TYPES=t.SENSOR_DEVICE_TYPES=t.FLOODLIGHT_DEVICE_TYPES=t.DOORBELL_DEVICE_TYPES=t.CAMERA_DEVICE_TYPES=void 0,t.isCamera=s,t.isDoorbell=n,t.isWiredDoorbell=function(e){return t.WIRED_DOORBELL_TYPES.has(e)},t.isBatteryDoorbell=function(e){return t.BATTERY_DOORBELL_TYPES.has(e)},t.isDoorbellDual=function(e){return t.DUAL_DOORBELL_TYPES.has(e)},t.isFloodlight=o,t.isSensor=a,t.isEntrySensor=function(e){return e===i.DeviceType.SENSOR},t.isMotionSensor=function(e){return e===i.DeviceType.MOTION_SENSOR},t.isLock=c,t.isLockBle=function(e){return t.LOCK_BLE_TYPES.has(e)},t.isLockWifi=function(e){return t.LOCK_WIFI_TYPES.has(e)},t.isLockKeypad=function(e){return t.LOCK_KEYPAD_TYPES.has(e)},t.isBaseStation=l,t.isIndoorCamera=function(e){return t.INDOOR_CAMERA_TYPES.has(e)},t.isSoloCameras=function(e){return t.SOLO_CAMERA_TYPES.has(e)},t.isPanAndTiltCamera=function(e){return t.PAN_TILT_DEVICE_TYPES.has(e)},t.isGarageCamera=function(e){return t.GARAGE_CAMERA_TYPES.has(e)},t.isSmartSafe=function(e){return t.SMART_SAFE_TYPES.has(e)},t.isSmartTrack=function(e){return t.SMART_TRACK_TYPES.has(e)},t.isSmartDrop=function(e){return t.SMART_DROP_TYPES.has(e)},t.isKeyPad=function(e){return t.KEYPAD_TYPES.has(e)},t.isCamera1Product=function(e){return t.CAMERA_1_TYPES.has(e)||t.CAMERA_E_TYPES.has(e)},t.isCamera2Product=function(e){return t.CAMERA_2_TYPES.has(e)},t.isCamera3Product=function(e){return t.CAMERA_3_TYPES.has(e)},t.hasBattery=d,t.canPanTilt=h,t.isDeviceSupported=u,t.requiresErrorResilience=function(e){return t.ERROR_RESILIENT_CAMERA_TYPES.has(e)},t.getDeviceCapabilities=function(e){return{camera:s(e)||n(e)||o(e),doorbell:n(e),floodlight:o(e),sensor:a(e),lock:c(e),battery:d(e),panTilt:h(e),supported:u(e)}},t.getProductName=function(e){return t.MODEL_NAMES[e]||e},t.getDeviceTypeName=function(e){return n(e)?"Doorbell":s(e)||o(e)?"Camera":a(e)?"Sensor":c(e)?"Lock":l(e)?"Base Station":"Unknown"};const i=r(1187);function s(e){return t.CAMERA_DEVICE_TYPES.has(e)||t.DOORBELL_DEVICE_TYPES.has(e)||t.FLOODLIGHT_DEVICE_TYPES.has(e)}function n(e){return t.DOORBELL_DEVICE_TYPES.has(e)}function o(e){return t.FLOODLIGHT_DEVICE_TYPES.has(e)}function a(e){return t.SENSOR_DEVICE_TYPES.has(e)}function c(e){return t.LOCK_DEVICE_TYPES.has(e)}function l(e){return t.BASE_STATION_DEVICE_TYPES.has(e)}function d(e){return t.BATTERY_DEVICE_TYPES.has(e)}function h(e){return t.PAN_TILT_DEVICE_TYPES.has(e)}function u(e){return t.SUPPORTED_DEVICE_TYPES.has(e)}t.CAMERA_DEVICE_TYPES=new Set([i.DeviceType.CAMERA,i.DeviceType.CAMERA2,i.DeviceType.CAMERA_E,i.DeviceType.CAMERA2C,i.DeviceType.CAMERA2C_PRO,i.DeviceType.CAMERA2_PRO,i.DeviceType.CAMERA3,i.DeviceType.CAMERA3C,i.DeviceType.CAMERA3_PRO,i.DeviceType.PROFESSIONAL_247,i.DeviceType.SOLO_CAMERA,i.DeviceType.SOLO_CAMERA_PRO,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_1080,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_2K,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_SOLAR,i.DeviceType.SOLO_CAMERA_SOLAR,i.DeviceType.SOLO_CAMERA_C210,i.DeviceType.SOLO_CAMERA_E30,i.DeviceType.INDOOR_CAMERA,i.DeviceType.INDOOR_PT_CAMERA,i.DeviceType.INDOOR_PT_CAMERA_S350,i.DeviceType.INDOOR_PT_CAMERA_C220,i.DeviceType.INDOOR_PT_CAMERA_C210,i.DeviceType.INDOOR_PT_CAMERA_E30,i.DeviceType.INDOOR_CAMERA_1080,i.DeviceType.INDOOR_PT_CAMERA_1080,i.DeviceType.INDOOR_OUTDOOR_CAMERA_1080P,i.DeviceType.INDOOR_OUTDOOR_CAMERA_1080P_NO_LIGHT,i.DeviceType.INDOOR_OUTDOOR_CAMERA_2K,i.DeviceType.INDOOR_COST_DOWN_CAMERA,i.DeviceType.OUTDOOR_PT_CAMERA,i.DeviceType.CAMERA_FG,i.DeviceType.CAMERA_GARAGE_T8453_COMMON,i.DeviceType.CAMERA_GARAGE_T8452,i.DeviceType.CAMERA_GARAGE_T8453,i.DeviceType.CAMERA_GUN,i.DeviceType.CAMERA_SNAIL,i.DeviceType.FLOODLIGHT_CAMERA_8426]),t.DOORBELL_DEVICE_TYPES=new Set([i.DeviceType.DOORBELL,i.DeviceType.BATTERY_DOORBELL,i.DeviceType.BATTERY_DOORBELL_2,i.DeviceType.BATTERY_DOORBELL_PLUS,i.DeviceType.DOORBELL_SOLO,i.DeviceType.BATTERY_DOORBELL_PLUS_E340,i.DeviceType.BATTERY_DOORBELL_C30,i.DeviceType.BATTERY_DOORBELL_C31]),t.FLOODLIGHT_DEVICE_TYPES=new Set([i.DeviceType.FLOODLIGHT,i.DeviceType.FLOODLIGHT_CAMERA_8422,i.DeviceType.FLOODLIGHT_CAMERA_8423,i.DeviceType.FLOODLIGHT_CAMERA_8424,i.DeviceType.FLOODLIGHT_CAMERA_8425,i.DeviceType.FLOODLIGHT_CAMERA_8426,i.DeviceType.WALL_LIGHT_CAM,i.DeviceType.WALL_LIGHT_CAM_81A0,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_1080,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_2K,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_SOLAR]),t.SENSOR_DEVICE_TYPES=new Set([i.DeviceType.SENSOR,i.DeviceType.MOTION_SENSOR]),t.LOCK_DEVICE_TYPES=new Set([i.DeviceType.LOCK_BLE,i.DeviceType.LOCK_BLE_NO_FINGER,i.DeviceType.LOCK_WIFI,i.DeviceType.LOCK_WIFI_NO_FINGER,i.DeviceType.LOCK_8503,i.DeviceType.LOCK_8504,i.DeviceType.LOCK_8530,i.DeviceType.LOCK_8592,i.DeviceType.LOCK_85A3,i.DeviceType.LOCK_8506,i.DeviceType.LOCK_8502]),t.BASE_STATION_DEVICE_TYPES=new Set([i.DeviceType.STATION,i.DeviceType.MINIBASE_CHIME]),t.BATTERY_DEVICE_TYPES=new Set([i.DeviceType.CAMERA,i.DeviceType.CAMERA_E,i.DeviceType.CAMERA2C,i.DeviceType.CAMERA2,i.DeviceType.CAMERA2_PRO,i.DeviceType.CAMERA2C_PRO,i.DeviceType.CAMERA3,i.DeviceType.CAMERA3C,i.DeviceType.CAMERA3_PRO,i.DeviceType.SOLO_CAMERA,i.DeviceType.SOLO_CAMERA_PRO,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_1080,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_2K,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_SOLAR,i.DeviceType.SOLO_CAMERA_SOLAR,i.DeviceType.SOLO_CAMERA_C210,i.DeviceType.SOLO_CAMERA_E30,i.DeviceType.OUTDOOR_PT_CAMERA,i.DeviceType.CAMERA_FG,i.DeviceType.WALL_LIGHT_CAM_81A0,i.DeviceType.SMART_DROP,i.DeviceType.BATTERY_DOORBELL,i.DeviceType.BATTERY_DOORBELL_2,i.DeviceType.BATTERY_DOORBELL_PLUS,i.DeviceType.DOORBELL_SOLO,i.DeviceType.BATTERY_DOORBELL_PLUS_E340,i.DeviceType.BATTERY_DOORBELL_C30,i.DeviceType.BATTERY_DOORBELL_C31,i.DeviceType.LOCK_WIFI,i.DeviceType.LOCK_BLE_NO_FINGER,i.DeviceType.LOCK_8503,i.DeviceType.LOCK_8504,i.DeviceType.LOCK_8530,i.DeviceType.LOCK_8592,i.DeviceType.LOCK_85A3,i.DeviceType.LOCK_8506,i.DeviceType.LOCK_8502,i.DeviceType.SMART_SAFE_7400,i.DeviceType.SMART_SAFE_7401,i.DeviceType.SMART_SAFE_7402,i.DeviceType.SMART_SAFE_7403]),t.PAN_TILT_DEVICE_TYPES=new Set([i.DeviceType.INDOOR_PT_CAMERA,i.DeviceType.FLOODLIGHT_CAMERA_8423,i.DeviceType.FLOODLIGHT_CAMERA_8425,i.DeviceType.FLOODLIGHT_CAMERA_8426,i.DeviceType.INDOOR_COST_DOWN_CAMERA,i.DeviceType.OUTDOOR_PT_CAMERA,i.DeviceType.INDOOR_PT_CAMERA_S350,i.DeviceType.INDOOR_PT_CAMERA_E30,i.DeviceType.INDOOR_PT_CAMERA_C220,i.DeviceType.INDOOR_PT_CAMERA_C210]),t.SUPPORTED_DEVICE_TYPES=new Set([...Array.from(t.CAMERA_DEVICE_TYPES),...Array.from(t.DOORBELL_DEVICE_TYPES),...Array.from(t.FLOODLIGHT_DEVICE_TYPES),...Array.from(t.SENSOR_DEVICE_TYPES),...Array.from(t.LOCK_DEVICE_TYPES)]),t.SOLO_CAMERA_TYPES=new Set([i.DeviceType.SOLO_CAMERA,i.DeviceType.SOLO_CAMERA_PRO,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_1080,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_2K,i.DeviceType.SOLO_CAMERA_SPOTLIGHT_SOLAR,i.DeviceType.SOLO_CAMERA_SOLAR,i.DeviceType.SOLO_CAMERA_C210,i.DeviceType.SOLO_CAMERA_E30,i.DeviceType.OUTDOOR_PT_CAMERA]),t.INDOOR_CAMERA_TYPES=new Set([i.DeviceType.INDOOR_CAMERA,i.DeviceType.INDOOR_PT_CAMERA,i.DeviceType.INDOOR_OUTDOOR_CAMERA_1080P_NO_LIGHT,i.DeviceType.INDOOR_OUTDOOR_CAMERA_2K,i.DeviceType.INDOOR_OUTDOOR_CAMERA_1080P,i.DeviceType.INDOOR_COST_DOWN_CAMERA,i.DeviceType.INDOOR_PT_CAMERA_S350,i.DeviceType.INDOOR_PT_CAMERA_E30,i.DeviceType.INDOOR_PT_CAMERA_C220,i.DeviceType.INDOOR_PT_CAMERA_C210]),t.WIRED_DOORBELL_TYPES=new Set([i.DeviceType.DOORBELL]),t.BATTERY_DOORBELL_TYPES=new Set([i.DeviceType.BATTERY_DOORBELL,i.DeviceType.BATTERY_DOORBELL_2,i.DeviceType.BATTERY_DOORBELL_PLUS,i.DeviceType.BATTERY_DOORBELL_PLUS_E340,i.DeviceType.BATTERY_DOORBELL_C30,i.DeviceType.BATTERY_DOORBELL_C31]),t.DUAL_DOORBELL_TYPES=new Set([i.DeviceType.DOORBELL_SOLO,i.DeviceType.BATTERY_DOORBELL_PLUS]),t.LOCK_BLE_TYPES=new Set([i.DeviceType.LOCK_BLE,i.DeviceType.LOCK_BLE_NO_FINGER]),t.LOCK_WIFI_TYPES=new Set([i.DeviceType.LOCK_WIFI,i.DeviceType.LOCK_WIFI_NO_FINGER,i.DeviceType.LOCK_8503,i.DeviceType.LOCK_8530,i.DeviceType.LOCK_8504,i.DeviceType.LOCK_8502,i.DeviceType.LOCK_8506]),t.LOCK_KEYPAD_TYPES=new Set([i.DeviceType.LOCK_85A3,i.DeviceType.LOCK_8592]),t.CAMERA_1_TYPES=new Set([i.DeviceType.CAMERA]),t.CAMERA_E_TYPES=new Set([i.DeviceType.CAMERA_E]),t.CAMERA_2_TYPES=new Set([i.DeviceType.CAMERA2C,i.DeviceType.CAMERA2,i.DeviceType.CAMERA2_PRO,i.DeviceType.CAMERA2C_PRO]),t.CAMERA_3_TYPES=new Set([i.DeviceType.CAMERA3,i.DeviceType.CAMERA3C,i.DeviceType.PROFESSIONAL_247,i.DeviceType.CAMERA3_PRO]),t.GARAGE_CAMERA_TYPES=new Set([i.DeviceType.CAMERA_GARAGE_T8453_COMMON,i.DeviceType.CAMERA_GARAGE_T8452,i.DeviceType.CAMERA_GARAGE_T8453]),t.SMART_SAFE_TYPES=new Set([i.DeviceType.SMART_SAFE_7400,i.DeviceType.SMART_SAFE_7401,i.DeviceType.SMART_SAFE_7402,i.DeviceType.SMART_SAFE_7403]),t.SMART_TRACK_TYPES=new Set([120,121]),t.SMART_DROP_TYPES=new Set([i.DeviceType.SMART_DROP]),t.KEYPAD_TYPES=new Set([i.DeviceType.KEYPAD]),t.ERROR_RESILIENT_CAMERA_TYPES=new Set([i.DeviceType.OUTDOOR_PT_CAMERA]),t.MODEL_NAMES={T8001:"HomeBase",T8002:"HomeBase E",T8010:"HomeBase S280 (Homebase 2)",T8030:"HomeBase S380 (HomeBase 3)",T8021:"Smart Lock Wi-Fi Bridge",T8023:"MiniBase Chime",T8111:"eufyCam",T8112:"eufyCam E",T8114:"eufyCam 2",T8113:"eufyCam S210 (eufyCam 2C)",T8140:"eufyCam S221 (eufyCam 2 Pro)",T8141:"eufyCam S220 (eufyCam 2C Pro)",T8160:"eufyCam S330 (eufyCam 3)",T8161:"eufyCam S300 (eufyCam 3C)",T8162:"eufyCam S3 Pro",T8600:"eufyCam E330 (Professional)",T8130:"SoloCam E20",T8131:"SoloCam C120 (SoloCam E40)",T8122:"SoloCam L20",T8123:"SoloCam L40",T8B0:"SoloCam C210",T8124:"SoloCam S230 (SoloCam S40)",T8134:"SoloCam S220",T8170:"SoloCam S340",T8171:"SoloCam E30",T8420:"Floodlight Camera",T8420X:"Floodlight Camera",T8422:"Floodlight Cam",T8423:"Floodlight Cam S330 (Floodlight Cam 2 Pro)",T8424:"Floodlight Cam E221 (Floodlight Cam 2)",T8425:"Floodlight Cam E340",T84A1:"Wired Wall Light Cam S100",T84A0:"Solar Wall Light Cam S120",T8200:"Video Doorbell 2K (Wired)",T8200X:"Wired Doorbell 2k",T8201:"Wired Doorbell 1080p",T8203:"Video Doorbell (Wired) S330 (Video Doorbell Dual)",T8210:"Video Doorbell S220 (Battery Doorbell 2K)",T8213:"Video Doorbell S330 (Battery Doorbell 2K Dual)",T8214:"Video Doorbell E340 (Battery Powered)",T8222:"Video Doorbell C210 (Battery Doorbell 1080p)",T8224:"Video Doorbell C30 (Battery Powered)",T8223:"Video Doorbell C31 (Battery Powered)",T8410:"Indoor Cam E220 (Indoor Cam Pan&Tilt 2K)",T8900:"Entry Sensor",T8910:"Motion Sensor"}},9848:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(5608);i.__exportStar(r(3405),t),i.__exportStar(r(1528),t),i.__exportStar(r(5067),t),i.__exportStar(r(9259),t),i.__exportStar(r(9636),t)},9849:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AuthenticationManager=t.AUTH_STATE=void 0,t.AUTH_STATE={NONE:"none",CAPTCHA_REQUIRED:"captcha_required",MFA_REQUIRED:"mfa_required"};t.AuthenticationManager=class{constructor(e,r,i,s){this.authState=t.AUTH_STATE.NONE,this.captchaData=null,this.mfaData=null,this.currentCaptchaCode="",this.currentVerifyCode="",this.wsClient=e,this.logger=r,this.onStateChange=i,this.onDeviceRegistration=s,this.setupEventListeners()}getAuthState(){return this.authState}getCaptchaData(){return this.captchaData}getMfaData(){return this.mfaData}getCurrentCaptchaCode(){return this.currentCaptchaCode}getCurrentVerifyCode(){return this.currentVerifyCode}updateCaptchaCode(e){this.currentCaptchaCode=e}updateVerifyCode(e){this.currentVerifyCode=e}getAuthStatusMessage(e){return this.authState===t.AUTH_STATE.CAPTCHA_REQUIRED?"ðŸ” CAPTCHA required - check settings below":this.authState===t.AUTH_STATE.MFA_REQUIRED?"ðŸ” 2FA code required - check settings below":e?"âœ… Authenticated":"âš ï¸ Not connected - click Connect Account button"}async checkPendingAuth(){const e=this.wsClient.getPendingCaptcha();if(e)return this.captchaData=e,this.authState=t.AUTH_STATE.CAPTCHA_REQUIRED,this.wsClient.clearPendingCaptcha(),void this.onStateChange();const r=this.wsClient.getPendingMfa();return r?(this.mfaData=r,this.authState=t.AUTH_STATE.MFA_REQUIRED,this.wsClient.clearPendingMfa(),void this.onStateChange()):void 0}async submitCaptcha(){const e=this.currentCaptchaCode;if(!e||""===e.trim())throw this.logger.warn("âš ï¸ CAPTCHA code is empty"),new Error("Please enter a CAPTCHA code");if(!this.captchaData)throw this.logger.warn("âš ï¸ No CAPTCHA data available"),new Error("No CAPTCHA challenge found");this.logger.info(`ðŸ” Submitting CAPTCHA code for ID: ${this.captchaData.captchaId}`);try{await this.wsClient.commands.driver().setCaptcha({captchaId:this.captchaData.captchaId,captcha:e.trim()}),this.logger.info("âœ… CAPTCHA submitted successfully"),this.captchaData=null,this.currentCaptchaCode="",await this.checkPostCaptchaState(),this.onStateChange()}catch(e){throw this.logger.error("âŒ CAPTCHA submission failed:",e),e}}async submitVerifyCode(){const e=this.currentVerifyCode;if(!e||""===e.trim())throw this.logger.warn("âš ï¸ Verification code is empty"),new Error("Please enter a verification code");const t=this.captchaData?.captchaId||"";this.logger.info("ðŸ” Submitting 2FA verification code");try{await this.wsClient.commands.driver().setVerifyCode({verifyCode:e,captchaId:t}),this.logger.info("âœ… Verification code submitted successfully"),this.mfaData=null,this.currentVerifyCode="",await this.checkPostVerificationState(),this.onStateChange()}catch(e){throw this.logger.error("âŒ Verification code submission failed:",e),e}}async requestNewCode(){this.logger.info("ðŸ”„ Requesting new verification code");try{await this.wsClient.commands.driver().setVerifyCode({verifyCode:"",captchaId:this.captchaData?.captchaId||""}),this.logger.info("âœ… New verification code requested"),this.onStateChange()}catch(e){throw this.logger.error("âŒ Failed to request new code:",e),e}}resetAuthState(){this.authState=t.AUTH_STATE.NONE,this.captchaData=null,this.mfaData=null,this.currentCaptchaCode="",this.currentVerifyCode=""}setupEventListeners(){this.wsClient.addEventListener("captcha request",e=>{this.logger.info("ðŸ” CAPTCHA requested"),this.captchaData={captchaId:e.captchaId,captcha:e.captcha},this.authState=t.AUTH_STATE.CAPTCHA_REQUIRED,this.onStateChange()},{source:"driver"}),this.wsClient.addEventListener("verify code",e=>{this.logger.info("ðŸ” 2FA verification requested"),this.mfaData={methods:e.methods||[]},this.authState=t.AUTH_STATE.MFA_REQUIRED,this.onStateChange()},{source:"driver"}),this.wsClient.addEventListener("connected",()=>{this.logger.info("âœ… Driver connected"),this.resetAuthState(),this.onStateChange()},{source:"driver"})}async checkPostCaptchaState(){const e=this.wsClient.getPendingMfa();if(e)return this.mfaData=e,this.authState=t.AUTH_STATE.MFA_REQUIRED,void this.wsClient.clearPendingMfa();const r=await this.wsClient.startListening();r.state.driver.connected&&(this.authState=t.AUTH_STATE.NONE,this.logger.info("âœ… Authentication complete (CAPTCHA flow)"),await this.onDeviceRegistration(r))}async checkPostVerificationState(){const e=await this.wsClient.startListening();e.state.driver.connected&&(this.authState=t.AUTH_STATE.NONE,this.logger.info("âœ… Authentication complete (2FA flow)"),await this.onDeviceRegistration(e))}}},9866:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WebSocketClient=void 0;const i=r(5608).__importDefault(r(848)),s=r(6560),n=r(8700),o=r(3725);t.WebSocketClient=class{constructor(e,t,r){this.ws=null,this.pendingMessages=new Map,this.reconnectTimeout=null,this.maxReconnectAttempts=10,this.messageTimeout=3e4,this.messageCount=0,this.lastMessageTime=0,this.wsUrl=e,this.stateManager=t,this.logger=r,this.messageProcessor=new o.WebSocketMessageProcessor(r)}getStateManager(){return this.stateManager}onConnected(e){this.onConnectedHandler=e}onDisconnected(e){this.onDisconnectedHandler=e}onVersionMessage(e){this.onVersionHandler=e}onEventMessage(e){this.onEventHandler=e}onError(e){this.onErrorHandler=e}async connect(){return this.stateManager.setConnectionState(n.ConnectionState.CONNECTING),new Promise((e,t)=>{try{this.ws=new i.default(this.wsUrl),this.ws.on("open",()=>{this.stateManager.setWebSocketConnected(!0),this.stateManager.setConnectionState(n.ConnectionState.CONNECTED),this.stateManager.setReconnectAttempts(0),this.onConnectedHandler?.(),e()}),this.ws.on("message",e=>{const t=this.messageProcessor.processMessage(e);if(t.valid)try{this.handleMessage(t.message)}catch(e){const t=e;this.logger.error("Error handling processed message:",t),this.stateManager.setError(t),this.onErrorHandler?.(t)}else this.logger.warn(`Invalid message dropped: ${t.error}`)}),this.ws.on("close",(e,t)=>{this.stateManager.setWebSocketConnected(!1),this.clearPendingMessages(),this.onDisconnectedHandler?.(),1e3!==e&&this.scheduleReconnect()}),this.ws.on("error",e=>{this.stateManager.setError(e),this.onErrorHandler?.(e),this.isConnected()||t(e)})}catch(e){const r=e;this.stateManager.setError(r),t(r)}})}disconnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.ws&&(this.ws.close(1e3,"Normal closure"),this.ws=null),this.stateManager.reset(),this.clearPendingMessages()}isConnected(){return this.stateManager.getState().wsConnected&&this.ws?.readyState===i.default.OPEN}async sendMessage(e){return new Promise((t,r)=>{if(!this.isConnected())return void r(new Error("WebSocket is not connected"));const i=setTimeout(()=>{this.pendingMessages.delete(e.messageId),r(new Error(`Message timeout: ${e.messageId}`))},this.messageTimeout);this.pendingMessages.set(e.messageId,{resolve:t,reject:r,timeout:i});try{this.ws.send(JSON.stringify(e))}catch(t){this.pendingMessages.delete(e.messageId),clearTimeout(i),r(t)}})}handleMessage(e){this.messageCount++,this.lastMessageTime=Date.now();const t=e.type;if(t===s.MESSAGE_TYPES.VERSION)return this.stateManager.setConnectionState(n.ConnectionState.SCHEMA_NEGOTIATING),void this.onVersionHandler?.(e);if(t===s.MESSAGE_TYPES.EVENT)return void this.onEventHandler?.(e);const r=e.messageId;if(r&&this.pendingMessages.has(r)){const t=this.pendingMessages.get(r);this.pendingMessages.delete(r),clearTimeout(t.timeout);if(!1===e.success){const r=e.errorCode||"Unknown error";t.reject(new Error(`Command failed: ${r}`))}else{const r=e.result||e;t.resolve(r)}return}this.logger&&this.logger.info("Unhandled message type:",t)}scheduleReconnect(){const e=this.stateManager.getState();if(this.reconnectTimeout||e.reconnectAttempts>=this.maxReconnectAttempts)return;const t=Math.min(1e3*Math.pow(2,e.reconnectAttempts),3e4),r=t+.1*Math.random()*t;this.stateManager.setReconnectAttempts(e.reconnectAttempts+1),this.logger&&this.logger.info(`Scheduling reconnection attempt ${e.reconnectAttempts+1}/${this.maxReconnectAttempts} in ${Math.round(r)}ms`),this.reconnectTimeout=setTimeout(async()=>{this.reconnectTimeout=null;try{await this.connect()}catch(e){this.logger&&this.logger.info("Reconnection attempt failed:",e)}},r)}clearPendingMessages(){for(const e of this.pendingMessages.values())clearTimeout(e.timeout),e.reject(new Error("Connection closed"));this.pendingMessages.clear()}getPerformanceMetrics(){const e=this.stateManager.getState();return{messageCount:this.messageCount,lastMessageTime:this.lastMessageTime,pendingMessageCount:this.pendingMessages.size,isConnected:this.isConnected(),reconnectAttempts:e.reconnectAttempts}}resetPerformanceMetrics(){this.messageCount=0,this.lastMessageTime=0,this.messageProcessor.resetStats()}getMessageProcessingStats(){return this.messageProcessor.getStats()}}},9896:e=>{"use strict";e.exports=require("fs")}},i={};function s(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return r[e].call(n.exports,n,n.exports,s),n.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,s.t=function(r,i){if(1&i&&(r=this(r)),8&i)return r;if("object"==typeof r&&r){if(4&i&&r.__esModule)return r;if(16&i&&"function"==typeof r.then)return r}var n=Object.create(null);s.r(n);var o={};e=e||[null,t({}),t([]),t(t)];for(var a=2&i&&r;("object"==typeof a||"function"==typeof a)&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach(e=>o[e]=()=>r[e]);return o.default=()=>r,s.d(n,o),n},s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{"use strict";s.r(n),s.d(n,{default:()=>he});var e=s(7562),t=s.n(e),r=s(175);const i={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]};function o(e,t,r,s=!1){const n=String(t),o=(e,t)=>`[${t[0]}m${e}[${t[1]}m`,a=(e,t)=>null!=t&&"string"==typeof t?o(e,i[t]):null!=t&&Array.isArray(t)?t.reduce((e,t)=>a(e,t),e):null!=t&&null!=t[e.trim()]?a(e,t[e.trim()]):null!=t&&null!=t["*"]?a(e,t["*"]):e;return n.replace(/{{(.+?)}}/g,(t,n)=>{const c=null!=r[n]?String(r[n]):s?"":t;return e.stylePrettyLogs?a(c,e?.prettyLogStyles?.[n]??null)+o("",i.reset):c})}function a(e,t=2,r=0){return null!=e&&isNaN(e)?"":(e=null!=e?e+r:e,2===t?null==e?"--":e<10?"0"+e:e.toString():null==e?"---":e<10?"00"+e:e<100?"0"+e:e.toString())}function c(e,t){if(null==t)return{text:"",template:e.prettyLogTemplate,placeholders:{}};let r=e.prettyLogTemplate;const i={};r.includes("{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}")?r=r.replace("{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}","{{dateIsoStr}}"):"UTC"===e.prettyLogTimeZone?(i.yyyy=t.date?.getUTCFullYear()??"----",i.mm=a(t.date?.getUTCMonth(),2,1),i.dd=a(t.date?.getUTCDate(),2),i.hh=a(t.date?.getUTCHours(),2),i.MM=a(t.date?.getUTCMinutes(),2),i.ss=a(t.date?.getUTCSeconds(),2),i.ms=a(t.date?.getUTCMilliseconds(),3)):(i.yyyy=t.date?.getFullYear()??"----",i.mm=a(t.date?.getMonth(),2,1),i.dd=a(t.date?.getDate(),2),i.hh=a(t.date?.getHours(),2),i.MM=a(t.date?.getMinutes(),2),i.ss=a(t.date?.getSeconds(),2),i.ms=a(t.date?.getMilliseconds(),3));const s="UTC"===e.prettyLogTimeZone?t.date:null!=t.date?new Date(t.date.getTime()-6e4*t.date.getTimezoneOffset()):void 0;i.rawIsoStr=s?.toISOString()??"",i.dateIsoStr=s?.toISOString().replace("T"," ").replace("Z","")??"",i.logLevelName=t.logLevelName,i.fileNameWithLine=t.path?.fileNameWithLine??"",i.filePathWithLine=t.path?.filePathWithLine??"",i.fullFilePath=t.path?.fullFilePath??"";let n=e.parentNames?.join(e.prettyErrorParentNamesSeparator);n=null!=n&&null!=t.name?n+e.prettyErrorParentNamesSeparator:void 0;const c=null!=t.name||null!=n?`${n??""}${t.name??""}`:"";return i.name=c,i.nameWithDelimiterPrefix=c.length>0?e.prettyErrorLoggerNameDelimiter+c:"",i.nameWithDelimiterSuffix=c.length>0?c+e.prettyErrorLoggerNameDelimiter:"",null!=e.overwrite?.addPlaceholders&&e.overwrite.addPlaceholders(t,i),{text:o(e,r,i),template:r,placeholders:i}}function l(e){if(e instanceof Error)return e;const t=new Error("string"==typeof e?e:JSON.stringify(e));return"object"==typeof e&&null!=e&&Object.assign(t,e),t}function d(e){const t=new Set;return JSON.stringify(e,(e,r)=>{if("object"==typeof r&&null!==r){if(t.has(r))return"[Circular]";t.add(r)}return"bigint"==typeof r?`${r}`:"undefined"==typeof r?"[undefined]":r})}function h(e,t){const r={seen:[],stylize:g};return null!=t&&D(r,t),u(r.showHidden)&&(r.showHidden=!1),u(r.depth)&&(r.depth=2),u(r.colors)&&(r.colors=!0),u(r.customInspect)&&(r.customInspect=!0),r.colors&&(r.stylize=p),O(r,e,r.depth)}function u(e){return void 0===e}function g(e){return e}function p(e,t){const r=h.styles[t];return null!=r&&null!=h?.colors?.[r]?.[0]&&null!=h?.colors?.[r]?.[1]?"["+h.colors[r][0]+"m"+e+"["+h.colors[r][1]+"m":e}function m(e){return"function"==typeof e}function f(e){return"string"==typeof e}function S(e){return null===e}function y(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function _(e){return v(e)&&"[object RegExp]"===T(e)}function v(e){return"object"==typeof e&&null!==e}function E(e){return v(e)&&("[object Error]"===T(e)||e instanceof Error)}function C(e){return v(e)&&"[object Date]"===T(e)}function T(e){return Object.prototype.toString.call(e)}function b(e){return"["+Error.prototype.toString.call(e)+"]"}function O(e,t,r=0){if(e.customInspect&&null!=t&&m(t)&&t?.inspect!==h&&(!t?.constructor||t?.constructor.prototype!==t)){if("function"!=typeof t.inspect&&null!=t.toString)return t.toString();let i=t?.inspect(r,e);return f(i)||(i=O(e,i,r)),i}const i=M(e,t);if(i)return i;let s=Object.keys(t);const n=function(e){const t={};return e.forEach(e=>{t[e]=!0}),t}(s);try{e.showHidden&&Object.getOwnPropertyNames&&(s=Object.getOwnPropertyNames(t))}catch{}if(E(t)&&(s.indexOf("message")>=0||s.indexOf("description")>=0))return b(t);if(0===s.length){if(!m(e.stylize))return t;if(m(t)){const r=t.name?": "+t.name:"";return e.stylize("[Function"+r+"]","special")}if(_(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(C(t))return e.stylize(Date.prototype.toISOString.call(t),"date");if(E(t))return b(t)}let o,a="",c=!1,l=["{\n","\n}"];if(Array.isArray(t)&&(c=!0,l=["[\n","\n]"]),m(t)){a=" [Function"+(t.name?": "+t.name:"")+"]"}return _(t)&&(a=" "+RegExp.prototype.toString.call(t)),C(t)&&(a=" "+Date.prototype.toUTCString.call(t)),E(t)&&(a=" "+b(t)),0!==s.length||c&&0!=t.length?r<0?_(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special"):(e.seen.push(t),o=c?function(e,t,r,i,s){const n=[];for(let s=0,o=t.length;s<o;++s)y(t,String(s))?n.push(A(e,t,r,i,String(s),!0)):n.push("");return s.forEach(s=>{s.match(/^\d+$/)||n.push(A(e,t,r,i,s,!0))}),n}(e,t,r,n,s):s.map(i=>A(e,t,r,n,i,c)),e.seen.pop(),function(e,t,r){return r[0]+(""===t?"":t+"\n")+"  "+e.join(",\n  ")+" "+r[1]}(o,a,l)):l[0]+a+l[1]}function A(e,t,r,i,s,n){let o,a,c={value:void 0};try{c.value=t[s]}catch{}try{Object.getOwnPropertyDescriptor&&(c=Object.getOwnPropertyDescriptor(t,s)||c)}catch{}if(c.get?a=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(a=e.stylize("[Setter]","special")),y(i,s)||(o="["+s+"]"),a||(e.seen.indexOf(c.value)<0?(a=S(r)?O(e,c.value,void 0):O(e,c.value,r-1),a.indexOf("\n")>-1&&(a=n?a.split("\n").map(e=>"  "+e).join("\n").substr(2):"\n"+a.split("\n").map(e=>"   "+e).join("\n"))):a=e.stylize("[Circular]","special")),u(o)){if(n&&s.match(/^\d+$/))return a;o=JSON.stringify(""+s),o.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,"\\'").replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+a}function M(e,t){if(u(t))return e.stylize("undefined","undefined");if(f(t)){const r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,"\\'")+"'";return e.stylize(r,"string")}return"number"==typeof t?e.stylize(""+t,"number"):function(e){return"boolean"==typeof e}(t)?e.stylize(""+t,"boolean"):S(t)?e.stylize("null","null"):void 0}function D(e,t){const r={...e};if(!t||!v(t))return e;const i={...t},s=Object.keys(t);let n=s.length;for(;n--;)r[s[n]]=i[s[n]];return r}h.colors=i,h.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};const w=[/(?:^|[\\/])node_modules[\\/].*tslog/i,/(?:^|[\\/])deps[\\/].*tslog/i,/tslog[\\/]+src[\\/]+internal[\\/]/i,/tslog[\\/]+src[\\/]BaseLogger/i,/tslog[\\/]+src[\\/]index/i];function R(e,t){const r=[];for(const i of e){const e=t(i);null!=e&&r.push(e)}return r}function N(e,t=w){for(let r=0;r<e.length;r+=1){const i=e[r],s=i.filePath??"",n=i.fullFilePath??"";if(!t.some(e=>e.test(s)||e.test(n)))return r}return 0}function P(e){return t=function(e){const t="string"==typeof e?.stack?e.stack:void 0;return null==t||0===t.length?[]:t.split("\n").map(e=>e.trimEnd())}(e),t.filter(e=>e.length>0&&!/^\s*Error\b/.test(e));var t}function L(e,t){return R(P(e),t)}function I(e,t){return e<0?0:e>=t?Math.max(0,t-1):e}function k(){return[...w]}function x(){return"undefined"!=typeof window&&"undefined"!=typeof document}const B=/\u001b\[[0-9;]*m/g,V={black:"#000000",red:"#ef5350",green:"#66bb6a",yellow:"#fdd835",blue:"#42a5f5",magenta:"#ab47bc",cyan:"#26c6da",white:"#fafafa",blackBright:"#424242",redBright:"#ff7043",greenBright:"#81c784",yellowBright:"#ffe082",blueBright:"#64b5f6",magentaBright:"#ce93d8",cyanBright:"#4dd0e1",whiteBright:"#ffffff"},F={bgBlack:"#000000",bgRed:"#ef5350",bgGreen:"#66bb6a",bgYellow:"#fdd835",bgBlue:"#42a5f5",bgMagenta:"#ab47bc",bgCyan:"#26c6da",bgWhite:"#fafafa",bgBlackBright:"#424242",bgRedBright:"#ff7043",bgGreenBright:"#81c784",bgYellowBright:"#ffe082",bgBlueBright:"#64b5f6",bgMagentaBright:"#ce93d8",bgCyanBright:"#4dd0e1",bgWhiteBright:"#ffffff"},U=/(?:(?:file|https?|global code|[^@]+)@)?(?:file:)?((?:\/[^:/]+){2,})(?::(\d+))?(?::(\d+))?/,j=function(){const e=function(){if(x()){const e=globalThis.navigator;return{name:"browser",userAgent:e?.userAgent}}const e=globalThis;if("function"==typeof e.importScripts)return{name:"worker",userAgent:e.navigator?.userAgent};const t=globalThis;if(null!=t.Bun){const e=t.Bun.version;return{name:"bun",version:null!=e?`bun/${e}`:void 0,hostname:v(t.process,t.Deno,t.Bun,t.location)}}if(null!=t.Deno){const e=function(e){try{if("function"==typeof e?.hostname){const t=e.hostname();if(null!=t&&t.length>0)return t}}catch{}const t=globalThis.location?.hostname;if(null!=t&&t.length>0)return t;return}(t.Deno),r=t.Deno?.version?.deno;return{name:"deno",version:null!=r?`deno/${r}`:void 0,hostname:e??v(t.process,t.Deno,t.Bun,t.location)}}if(null!=t.process?.versions?.node||null!=t.process?.version)return{name:"node",version:t.process?.versions?.node??t.process?.version,hostname:v(t.process,t.Deno,t.Bun,t.location)};if(null!=t.process)return{name:"node",version:"unknown",hostname:v(t.process,t.Deno,t.Bun,t.location)};return{name:"unknown"}}(),t=function(t){if("browser"===t.name||"worker"===t.name)return{runtime:t.name,browser:t.userAgent};const r={runtime:t.name};"node"!==e.name&&"deno"!==e.name&&"bun"!==e.name||(r.runtimeVersion=t.version??"unknown");"node"!==e.name&&"deno"!==e.name&&"bun"!==e.name||(r.hostname=t.hostname??"unknown");return r}(e),r="browser"===e.name||"worker"===e.name,i=r?[...k(),/node_modules[\\/].*tslog/i]:[...k(),/node:(?:internal|vm)/i,/\binternal[\\/]/i];let s;const n={getMeta:(e,r,i,s,o,a)=>Object.assign({},t,{name:o,parentNames:a,date:new Date,logLevelId:e,logLevelName:r,path:s?void 0:n.getCallerStackFrame(i)}),getCallerStackFrame(e,t=new Error){const r=L(t,e=>a(e));if(0===r.length)return{};const s=N(r,i);return r[I(Number.isFinite(e)&&e>=0?e:s,r.length)]??{}},getErrorTrace:e=>L(e,e=>a(e)),isError:e=>function(e){if(e instanceof Error)return!0;if(null!=e&&"object"==typeof e){const t=Object.prototype.toString.call(e);if(/\[object .*Error\]/.test(t))return!0;const r=e.name;if("string"==typeof r&&r.endsWith("Error"))return!0}return!1}(e),isBuffer:e=>"undefined"!=typeof Buffer&&"function"==typeof Buffer.isBuffer&&Buffer.isBuffer(e),prettyFormatLogObj:(e,t)=>e.reduce((e,r)=>(n.isError(r)?e.errors.push(n.prettyFormatErrorObj(r,t)):e.args.push(r),e),{args:[],errors:[]}),prettyFormatErrorObj(e,t){const r=u(n.getErrorTrace(e),t),i=function(e,t={}){const r=t.maxDepth??5,i=[],s=new Set;let n=e,o=0;for(;null!=n&&o<r;){const e=n?.cause;if(null==e||s.has(e))break;s.add(e),i.push(l(e)),n=e,o+=1}return i}(e).map((e,r)=>[`Caused by (${r+1}): ${e.name??"Error"}${e.message?`: ${e.message}`:""}`,...u(L(e,e=>a(e)),t)].join("\n")),s={errorName:` ${e.name} `,errorMessage:p(e),errorStack:[...r,...i].join("\n")};return o(t,t.prettyErrorTemplate,s)},transportFormatted(t,r,i,s,n){const o=!1!==n.stylePrettyLogs,a=(i.length>0&&r.length>0?"\n":"")+i.join("\n"),l=t.replace(B,"");const d=o?t:l;if(function(t){return t&&("browser"===e.name||"worker"===e.name)&&function(){if(!x())return!1;const e=globalThis?.navigator,t=e?.userAgent??"";if(/firefox/i.test(t))return!0;const r=globalThis;return!!r?.CSS?.supports?.("color","#000")||/safari/i.test(t)&&!/chrome/i.test(t)}()}(o)){n.prettyInspectOptions.colors=!1;const e=y(n.prettyInspectOptions,r),t=null!=s?function(e,t){if(null==t)return{text:"",styles:[]};const{template:r,placeholders:i}=c(e,t),s=[],n=[];let o=0;const a=/{{(.+?)}}/g;let l;for(;null!=(l=a.exec(r));){l.index>o&&s.push(r.slice(o,l.index));const t=l[1],c=null!=i[t]?String(i[t]):"",d=f(m(e.prettyLogStyles?.[t],c));d.length>0?(s.push(`%c${c}%c`),n.push(d,"")):s.push(c),o=a.lastIndex}o<r.length&&s.push(r.slice(o));return{text:s.join(""),styles:n}}(n,s):{text:l,styles:[]},i=t.text.length>0&&t.styles.length>0,o=(i?t.text:l)+e+a;return void(i?console.log(o,...t.styles):console.log(o))}n.prettyInspectOptions.colors=o;const h=y(n.prettyInspectOptions,r);console.log(d+h+a)},transportJSON(e){console.log(d(e))}};return"test"===function(){const e=globalThis?.process;return e?.env?.NODE_ENV}()&&(n.__resetWorkingDirectoryCacheForTests=()=>{s=void 0}),n;function a(e){return r?function(e){const t=globalThis.location?.origin;if(null==e)return;const r=e.match(U);if(!r)return;const i=r[1]?.replace(/\?.*$/,"");if(null==i)return;const s=i.split("/"),n=r[2],o=r[3],a=s[s.length-1];return{fullFilePath:t?`${t}${i}`:i,fileName:a,fileNameWithLine:a&&n?`${a}:${n}`:void 0,fileColumn:o,fileLine:n,filePath:i,filePathWithLine:n?`${i}:${n}`:void 0,method:void 0}}(e):function(e){if("string"!=typeof e||0===e.length)return;const t=e.trim();if(!t.includes(" at ")&&!t.startsWith("at "))return;const r=t.replace(/^at\s+/,"");let i,n=r;const o=r.match(/^(.*?)\s+\((.*)\)$/);o&&(i=o[1],n=o[2]);const a=n.replace(/^\(/,"").replace(/\)$/,""),c=a.replace(/\?.*$/,"");let l,d,h=c;const u=c.split(":");u.length>=3&&/^\d+$/.test(u[u.length-1]??"")?(d=u.pop(),l=u.pop(),h=u.join(":")):u.length>=2&&/^\d+$/.test(u[u.length-1]??"")&&(l=u.pop(),h=u.join(":"));let g=h.replace(/^file:\/\//,"");const p=function(){void 0===s&&(s=function(){try{const e=globalThis?.process;if("function"==typeof e?.cwd)return e.cwd()}catch{}try{const e=globalThis?.Deno;if("function"==typeof e?.cwd)return e.cwd()}catch{}}()??null);return s??void 0}();null!=p&&g.startsWith(p)&&(g=g.slice(p.length),g=g.replace(/^[\\/]/,""));0===g.length&&(g=h);const m=function(e){if("string"!=typeof e||0===e.length)return e;const t=e.replace(/\\+/g,"\\").replace(/\\/g,"/"),r=t.startsWith("//"),i=t.startsWith("/")&&!r,s=t.match(/^[A-Za-z]:/),n=s?s[0]:"",o=(n?t.slice(n.length):t).split("/"),a=[];for(const e of o)""!==e&&"."!==e&&(".."!==e?a.push(e):a.length>0&&a.pop());let c=a.join("/");r?c=`//${c}`:i?c=`/${c}`:""!==n&&(c=`${n}${c.length>0?`/${c}`:""}`);if(0===c.length)return e;return c}(g),f=m.length>0?m:g,S=f.split(/\\|\//),y=S[S.length-1],_=y&&l?`${y}:${l}`:void 0,v=f&&l?`${f}:${l}`:void 0;return{fullFilePath:a,fileName:y,fileNameWithLine:_,fileColumn:d,fileLine:l,filePath:f,filePathWithLine:v,method:i}}(e)}function u(e,t){return e.map(e=>o(t,t.prettyErrorStackTemplate,{...e},!0))}function p(e){return Object.getOwnPropertyNames(e).filter(e=>"stack"!==e&&"cause"!==e).reduce((t,r)=>{const i=e[r];return"function"==typeof i||t.push(String(i)),t},[]).join(", ")}function m(e,t){if(null==e)return[];if("string"==typeof e)return[e];if(Array.isArray(e))return e.flatMap(e=>m(e,t));if("object"==typeof e){const r=e[t.trim()]??e["*"];return null==r?[]:m(r,t)}return[]}function f(e){const t=new Set,r=[];for(const i of e){const e=S(i);null!=e&&e.length>0&&!t.has(e)&&(t.add(e),r.push(e))}return r.join("; ")}function S(e){const t=V[e];if(null!=t)return`color: ${t}`;const r=F[e];if(null!=r)return`background-color: ${r}`;switch(e){case"bold":return"font-weight: bold";case"dim":return"opacity: 0.75";case"italic":return"font-style: italic";case"underline":return"text-decoration: underline";case"overline":return"text-decoration: overline";case"inverse":return"filter: invert(1)";case"hidden":return"visibility: hidden";case"strikethrough":return"text-decoration: line-through";default:return}}function y(e,t){try{return function(e,...t){const r={seen:[],stylize:g};null!=e&&D(r,e);const i=t[0];let s=0,n="",o="";if("string"==typeof i){if(1===t.length)return i;let a,c=0;for(let o=0;o<i.length-1;o++)if(37===i.charCodeAt(o)){const l=i.charCodeAt(++o);if(s+1!==t.length){switch(l){case 115:{const i=t[++s];a="number"==typeof i||"bigint"==typeof i?M(r,i):"object"!=typeof i||null===i?String(i):h(i,{...e,compact:3,colors:!1,depth:0});break}case 106:a=d(t[++s]);break;case 100:{const e=t[++s];a="bigint"==typeof e?M(r,e):"symbol"==typeof e?"NaN":M(r,e);break}case 79:a=h(t[++s],e);break;case 111:a=h(t[++s],{...e,showHidden:!0,showProxy:!0,depth:4});break;case 105:{const e=t[++s];a="bigint"==typeof e?M(r,e):"symbol"==typeof e?"NaN":M(r,parseInt(a));break}case 102:{const e=t[++s];a="symbol"==typeof e?"NaN":M(r,parseInt(e));break}case 99:s+=1,a="";break;case 37:n+=i.slice(c,o),c=o+1;continue;default:continue}c!==o-1&&(n+=i.slice(c,o-1)),n+=a,c=o+1}else 37===l&&(n+=i.slice(c,o),c=o+1)}0!==c&&(s++,o=" ",c<i.length&&(n+=i.slice(c)))}for(;s<t.length;){const r=t[s];n+=o,n+="string"!=typeof r?h(r,e):r,o=" ",s++}return n}(e,...t)}catch{return t.map(_).join(" ")}}function _(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return String(e)}}function v(e,t,r,i){const s=e?.env?.HOSTNAME??e?.env?.HOST??e?.env?.COMPUTERNAME;if(null!=s&&s.length>0)return s;const n=r?.env?.HOSTNAME??r?.env?.HOST??r?.env?.COMPUTERNAME;if(null!=n&&n.length>0)return n;try{const e=t?.env?.get;if("function"==typeof e){const t=e("HOSTNAME");if(null!=t&&t.length>0)return t}}catch{}return null!=i?.hostname&&i.hostname.length>0?i.hostname:void 0}}();class ${constructor(e,t,r=Number.NaN){this.logObj=t,this.stackDepthLevel=r,this.runtime=j,this.maxErrorCauseDepth=5,this.settings={type:e?.type??"pretty",name:e?.name,parentNames:e?.parentNames,minLevel:e?.minLevel??0,argumentsArrayName:e?.argumentsArrayName,hideLogPositionForProduction:e?.hideLogPositionForProduction??!1,prettyLogTemplate:e?.prettyLogTemplate??"{{yyyy}}.{{mm}}.{{dd}} {{hh}}:{{MM}}:{{ss}}:{{ms}}\t{{logLevelName}}\t{{filePathWithLine}}{{nameWithDelimiterPrefix}}\t",prettyErrorTemplate:e?.prettyErrorTemplate??"\n{{errorName}} {{errorMessage}}\nerror stack:\n{{errorStack}}",prettyErrorStackTemplate:e?.prettyErrorStackTemplate??"  â€¢ {{fileName}}\t{{method}}\n\t{{filePathWithLine}}",prettyErrorParentNamesSeparator:e?.prettyErrorParentNamesSeparator??":",prettyErrorLoggerNameDelimiter:e?.prettyErrorLoggerNameDelimiter??"\t",stylePrettyLogs:e?.stylePrettyLogs??!0,prettyLogTimeZone:e?.prettyLogTimeZone??"UTC",prettyLogStyles:e?.prettyLogStyles??{logLevelName:{"*":["bold","black","bgWhiteBright","dim"],SILLY:["bold","white"],TRACE:["bold","whiteBright"],DEBUG:["bold","green"],INFO:["bold","blue"],WARN:["bold","yellow"],ERROR:["bold","red"],FATAL:["bold","redBright"]},dateIsoStr:"white",filePathWithLine:"white",name:["white","bold"],nameWithDelimiterPrefix:["white","bold"],nameWithDelimiterSuffix:["white","bold"],errorName:["bold","bgRedBright","whiteBright"],fileName:["yellow"],fileNameWithLine:"white"},prettyInspectOptions:e?.prettyInspectOptions??{colors:!0,compact:!1,depth:1/0},metaProperty:e?.metaProperty??"_meta",maskPlaceholder:e?.maskPlaceholder??"[***]",maskValuesOfKeys:e?.maskValuesOfKeys??["password"],maskValuesOfKeysCaseInsensitive:e?.maskValuesOfKeysCaseInsensitive??!1,maskValuesRegEx:e?.maskValuesRegEx,prefix:[...e?.prefix??[]],attachedTransports:[...e?.attachedTransports??[]],overwrite:{mask:e?.overwrite?.mask,toLogObj:e?.overwrite?.toLogObj,addMeta:e?.overwrite?.addMeta,addPlaceholders:e?.overwrite?.addPlaceholders,formatMeta:e?.overwrite?.formatMeta,formatLogObj:e?.overwrite?.formatLogObj,transportFormatted:e?.overwrite?.transportFormatted,transportJSON:e?.overwrite?.transportJSON}},this.captureStackForMeta=this._shouldCaptureStack()}log(e,t,...r){if(e<this.settings.minLevel)return;const i=this._resolveLogArguments(r),s=[...this.settings.prefix,...i],n=null!=this.settings.overwrite?.mask?this.settings.overwrite?.mask(s):null!=this.settings.maskValuesOfKeys&&this.settings.maskValuesOfKeys.length>0?this._mask(s):s,o=null!=this.logObj?this._recursiveCloneAndExecuteFunctions(this.logObj):void 0,a=null!=this.settings.overwrite?.toLogObj?this.settings.overwrite?.toLogObj(n,o):this._toLogObj(n,o),c=null!=this.settings.overwrite?.addMeta?this.settings.overwrite?.addMeta(a,e,t):this._addMetaToLogObj(a,e,t),l=c?.[this.settings.metaProperty];let d,h;if(null!=this.settings.overwrite?.formatMeta&&(d=this.settings.overwrite?.formatMeta(c?.[this.settings.metaProperty])),null!=this.settings.overwrite?.formatLogObj&&(h=this.settings.overwrite?.formatLogObj(n,this.settings)),"pretty"===this.settings.type&&(d=d??this._prettyFormatLogObjMeta(c?.[this.settings.metaProperty]),h=h??j.prettyFormatLogObj(n,this.settings)),null!=d&&null!=h)if(null!=this.settings.overwrite?.transportFormatted){const e=this.settings.overwrite.transportFormatted,t=e.length;t<4?e(d,h.args,h.errors):4===t?e(d,h.args,h.errors,l):e(d,h.args,h.errors,l,this.settings)}else j.transportFormatted(d,h.args,h.errors,l,this.settings);else null!=this.settings.overwrite?.transportJSON?this.settings.overwrite.transportJSON(c):"hidden"!==this.settings.type&&j.transportJSON(c);return null!=this.settings.attachedTransports&&this.settings.attachedTransports.length>0&&this.settings.attachedTransports.forEach(e=>{e(c)}),c}attachTransport(e){this.settings.attachedTransports.push(e)}getSubLogger(e,t){const r={...this.settings,...e,parentNames:null!=this.settings?.parentNames&&null!=this.settings?.name?[...this.settings.parentNames,this.settings.name]:null!=this.settings?.name?[this.settings.name]:void 0,prefix:[...this.settings.prefix,...e?.prefix??[]]};return new this.constructor(r,t??this.logObj,this.stackDepthLevel)}_mask(e){const t=this._getMaskKeys();return e?.map(e=>this._recursiveCloneAndMaskValuesOfKeys(e,t))}_getMaskKeys(){const e=this.settings.maskValuesOfKeys??[],t=e.map(String).join("|");if(!0===this.settings.maskValuesOfKeysCaseInsensitive){if(this.maskKeysCache?.source===e&&!0===this.maskKeysCache.caseInsensitive&&this.maskKeysCache.signature===t)return this.maskKeysCache.normalized;const r=e.map(e=>"string"==typeof e?e.toLowerCase():String(e).toLowerCase());return this.maskKeysCache={source:e,caseInsensitive:!0,normalized:r,signature:t},r}return this.maskKeysCache={source:e,caseInsensitive:!1,normalized:e,signature:t},e}_resolveLogArguments(e){if(1===e.length&&"function"==typeof e[0]){const t=e[0];if(0===t.length){const e=t();return Array.isArray(e)?e:[e]}}return e}_recursiveCloneAndMaskValuesOfKeys(e,t,r=[]){if(r.includes(e))return{...e};if("object"==typeof e&&null!==e&&r.push(e),j.isError(e)||j.isBuffer(e))return e;if(e instanceof Map)return new Map(e);if(e instanceof Set)return new Set(e);if(Array.isArray(e))return e.map(e=>this._recursiveCloneAndMaskValuesOfKeys(e,t,r));if(e instanceof Date)return new Date(e.getTime());if(e instanceof URL)return{href:(i=e).href,protocol:i.protocol,username:i.username,password:i.password,host:i.host,hostname:i.hostname,port:i.port,pathname:i.pathname,search:i.search,searchParams:[...i.searchParams].map(([e,t])=>({key:e,value:t})),hash:i.hash,origin:i.origin};if(null!==e&&"object"==typeof e){const i=j.isError(e)?this._cloneError(e):Object.create(Object.getPrototypeOf(e));return Object.getOwnPropertyNames(e).reduce((i,s)=>{const n=!0!==this.settings?.maskValuesOfKeysCaseInsensitive?s:"string"==typeof s?s.toLowerCase():String(s).toLowerCase();return i[s]=t.includes(n)?this.settings.maskPlaceholder:(()=>{try{return this._recursiveCloneAndMaskValuesOfKeys(e[s],t,r)}catch{return null}})(),i},i)}if("string"==typeof e){let t=e;for(const e of this.settings?.maskValuesRegEx||[])t=t.replace(e,this.settings?.maskPlaceholder||"");return t}return e;var i}_recursiveCloneAndExecuteFunctions(e,t=[]){return this.isObjectOrArray(e)&&t.includes(e)?this.shallowCopy(e):(this.isObjectOrArray(e)&&t.push(e),Array.isArray(e)?e.map(e=>this._recursiveCloneAndExecuteFunctions(e,t)):e instanceof Date?new Date(e.getTime()):this.isObject(e)?Object.getOwnPropertyNames(e).reduce((r,i)=>{const s=Object.getOwnPropertyDescriptor(e,i);if(s){Object.defineProperty(r,i,s);const n=e[i];r[i]="function"==typeof n?n():this._recursiveCloneAndExecuteFunctions(n,t)}return r},Object.create(Object.getPrototypeOf(e))):e)}isObjectOrArray(e){return"object"==typeof e&&null!==e}isObject(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}shallowCopy(e){return Array.isArray(e)?[...e]:{...e}}_toLogObj(e,t={}){return e=e?.map(e=>j.isError(e)?this._toErrorObject(e):e),t=null==this.settings.argumentsArrayName?1!==e.length||Array.isArray(e[0])||!0===j.isBuffer(e[0])||e[0]instanceof Date?{...t,...e}:"object"==typeof e[0]&&null!=e[0]?{...e[0],...t}:{0:e[0],...t}:{...t,[this.settings.argumentsArrayName]:e}}_cloneError(e){const t=new e.constructor;return Object.getOwnPropertyNames(e).forEach(r=>{t[r]=e[r]}),t}_toErrorObject(e,t=0,r=new Set){r.has(e)||r.add(e);const i={nativeError:e,name:e.name??"Error",message:e.message,stack:j.getErrorTrace(e)};if(t>=this.maxErrorCauseDepth)return i;const s=e.cause;if(null!=s){const e=l(s);r.has(e)||(i.cause=this._toErrorObject(e,t+1,r))}return i}_addMetaToLogObj(e,t,r){return{...e,[this.settings.metaProperty]:j.getMeta(t,r,this.stackDepthLevel,!this.captureStackForMeta,this.settings.name,this.settings.parentNames)}}_shouldCaptureStack(){if(this.settings.hideLogPositionForProduction)return!1;if("json"===this.settings.type)return!0;const e=this.settings.prettyLogTemplate??"";return!!/{{\s*(file(Name|Path|Line|PathWithLine|NameWithLine)|fullFilePath)\s*}}/.test(e)}_prettyFormatLogObjMeta(e){return c(this.settings,e).text}}class G extends ${constructor(e,t){const r={...e??{}};"undefined"!=typeof window&&"undefined"!=typeof document&&(r.stylePrettyLogs=e?.stylePrettyLogs??!0),super(r,t,Number.NaN)}log(e,t,...r){return super.log(e,t,...r)}silly(...e){return super.log(0,"SILLY",...e)}trace(...e){return super.log(1,"TRACE",...e)}debug(...e){return super.log(2,"DEBUG",...e)}info(...e){return super.log(3,"INFO",...e)}warn(...e){return super.log(4,"WARN",...e)}error(...e){return super.log(5,"ERROR",...e)}fatal(...e){return super.log(6,"FATAL",...e)}getSubLogger(e,t){return super.getSubLogger(e,t)}}var H=s(5321);r.GuardMode.AWAY,e.SecuritySystemMode.AwayArmed,r.GuardMode.HOME,e.SecuritySystemMode.HomeArmed,r.GuardMode.DISARMED,e.SecuritySystemMode.Disarmed,r.GuardMode.CUSTOM1,e.SecuritySystemMode.NightArmed,r.GuardMode.CUSTOM2,e.SecuritySystemMode.NightArmed,r.GuardMode.CUSTOM3,e.SecuritySystemMode.NightArmed,e.SecuritySystemMode.AwayArmed,r.GuardMode.AWAY,e.SecuritySystemMode.HomeArmed,r.GuardMode.HOME,e.SecuritySystemMode.NightArmed,r.GuardMode.HOME,e.SecuritySystemMode.Disarmed,r.GuardMode.DISARMED;class W{static toSetting(e,t,r,i){let s={key:e.name,title:e.label,type:e.type,value:void 0!==t?t:e.default,placeholder:e.default?String(e.default):void 0,readonly:!e.writeable,description:r,group:i};if("number"===e.type&&e.states)if(e.writeable){const r=Object.entries(e.states).sort(([e],[t])=>{const r=Number(e),i=Number(t);return isNaN(r)||isNaN(i)?e.localeCompare(t):r-i}).map(([,e])=>String(e));s={...s,type:"string",choices:r,value:e.states[t]}}else s={...s,type:"string",value:e.states[t]};else"number"===e.type&&void 0!==e.min&&void 0!==e.max&&(s={...s,range:[e.min,e.max],placeholder:void 0,description:`Value must be between ${e.min}${e.unit||""} and ${e.max}${e.unit||""}`});return s}static adjustValueForAPI(e,t){if("number"===t.type&&t.states){return Object.values(t.states).indexOf(e)}return e}static getPropertyGroup(e){const t=e.toLowerCase();return t.includes("motion")&&!t.includes("light")?"Motion":t.includes("light")?"Light":t.includes("battery")||t.includes("charge")||t.includes("power")?"Power":t.includes("clip")||t.includes("record")?"Recording":t.includes("video")||t.includes("stream")||t.includes("vision")?"Video":t.includes("microphone")||t.includes("speaker")||t.includes("notification")?"Communication":"Configuration"}static getWritableSettings(e,t){return Object.values(t).filter(e=>e.writeable).filter(e=>!/test/i.test(e.name)).filter(e=>"light"!==e.name).map(t=>W.toSetting(t,e[t.name],void 0,W.getPropertyGroup(t.name)))}static getDeviceInfoSettings(e,t){return[W.toSetting(t.model,e.model,"The full product name and model of the device."),W.toSetting(t.serialNumber,e.serialNumber,"The unique serial number assigned to the device."),W.toSetting(t.softwareVersion,e.firmware,"The current software version running on the device.")]}static shouldHideProperty(e){return["light","test"].some(t=>e.toLowerCase().includes(t.toLowerCase()))}}class Y{deviceApi;logger;customSettings=new Map;settingsChangeCallbacks=new Set;constructor(e,t){this.deviceApi=e,this.logger=t}getSettings(e,t,r){const{metadata:i}=e;return[{key:"scryptedName",title:"Device Name",description:"Name shown in Scrypted (can be customized)",value:r,type:"string",readonly:!1},...this.getGenericDeviceInfo(e,i),...this.getWritableProperties(t,i)]}async putSetting(e,t,r,i,s){try{if(e in r)return await this.updateDeviceProperty(e,t,i[e]),s&&s(e,t),void this.notifySettingsChanged();if(this.isCustomSetting(e))return this.customSettings.set(e,t),s&&s(e,t),void this.notifySettingsChanged();throw this.logger.warn(`Unknown setting: ${e}`),new Error(`Unknown setting: ${e}`)}catch(e){throw this.notifySettingsChanged(),e}}getCustomSetting(e){return this.customSettings.get(e)}onSettingsChange(e){return this.settingsChangeCallbacks.add(e),()=>this.settingsChangeCallbacks.delete(e)}async updateDeviceProperty(e,t,r){const i=r?W.adjustValueForAPI(t,r):t;this.logger.info(`Updating property ${e} to ${i}`);try{await this.deviceApi.setProperty(e,i),this.logger.info(`Property ${e} updated successfully`)}catch(t){throw this.logger.warn(`Failed to set property ${e}: ${t}`),t}}isCustomSetting(e){return"scryptedName"===e}getGenericDeviceInfo(e,t){const r=[];return void 0!==e.type&&r.push({key:"deviceType",title:"Device Type",description:"Type of Eufy device",value:e.type,type:"string",readonly:!0}),void 0!==e.model&&r.push({key:"model",title:"Model",description:"Device model number",value:e.model,type:"string",readonly:!0}),void 0!==e.serialNumber&&r.push({key:"serialNumber",title:"Serial Number",description:"Device serial number",value:e.serialNumber,type:"string",readonly:!0}),r}getWritableProperties(e,t){return W.getWritableSettings(e,t)}notifySettingsChanged(){this.settingsChangeCallbacks.forEach(e=>{try{e()}catch(e){this.logger.error(`Error in settings change callback: ${e}`)}})}dispose(){this.settingsChangeCallbacks.clear(),this.customSettings.clear()}}class K{logger;state={};stateChangeCallbacks=new Set;constructor(e){this.logger=e}getState(){return{...this.state}}updateFromProperties(t){if(!t)return;const r=[];if(void 0!==t.motionDetected){const i=t.motionDetected;this.state.motionDetected!==i&&(this.state.motionDetected=i,r.push({interface:e.ScryptedInterface.MotionSensor,value:i}))}if(void 0!==t.lightSettingsBrightnessManual){const i=t.lightSettingsBrightnessManual;this.state.brightness!==i&&(this.state.brightness=i,r.push({interface:e.ScryptedInterface.Brightness,value:i}))}else void 0===this.state.brightness&&(this.state.brightness=100);if(void 0!==t.light){const i=t.light;this.state.on!==i&&(this.state.on=i,r.push({interface:e.ScryptedInterface.OnOff,value:i}))}if(void 0!==t.battery){const i=t.battery;this.state.batteryLevel!==i&&(this.state.batteryLevel=i,r.push({interface:e.ScryptedInterface.Battery,value:i}))}else void 0===this.state.batteryLevel&&(this.state.batteryLevel=100);if(void 0!==t.chargingStatus){const i=this.convertChargingStatus(t.chargingStatus);this.state.chargeState!==i&&(this.state.chargeState=i,r.push({interface:e.ScryptedInterface.Charger,value:i}))}if(void 0!==t.wifiRssi){const i={...this.state.sensors,wifiRssi:{name:"wifiRssi",value:t.wifiRssi,unit:"dBm"}};this.state.sensors=i,r.push({interface:e.ScryptedInterface.Sensors,value:i})}r.forEach(e=>this.notifyStateChange(e))}updateProperty(t,r){let i;switch(this.logger.debug(`Property changed: ${t} = ${r}`),t){case"light":this.state.on=r,i={interface:e.ScryptedInterface.OnOff,value:this.state.on};break;case"battery":this.state.batteryLevel=r,i={interface:e.ScryptedInterface.Battery,value:this.state.batteryLevel};break;case"chargingStatus":this.state.chargeState=this.convertChargingStatus(r),i={interface:e.ScryptedInterface.Charger,value:this.state.chargeState};break;case"wifiRssi":this.state.sensors={...this.state.sensors,wifiRssi:{name:t,value:r,unit:"dBm"}},i={interface:e.ScryptedInterface.Sensors,value:this.state.sensors};break;case"motionDetected":this.state.motionDetected=r,i={interface:e.ScryptedInterface.MotionSensor,value:this.state.motionDetected};break;case"lightSettingsBrightnessManual":this.state.brightness=r,i={interface:e.ScryptedInterface.Brightness,value:this.state.brightness};break;default:this.logger.debug(`Property ${t} does not affect device state`)}i&&this.notifyStateChange(i)}onStateChange(e){return this.stateChangeCallbacks.add(e),()=>this.stateChangeCallbacks.delete(e)}updateState(t,r){let i;if("binaryState"===t)this.state.binaryState=r,i={interface:e.ScryptedInterface.BinarySensor,value:this.state.binaryState};else this.logger.debug(`State key ${t} not handled`);i&&this.notifyStateChange(i)}convertChargingStatus(t){switch(t){case r.ChargingStatus.NOT_CHARGING:return e.ChargeState.NotCharging;case r.ChargingStatus.CHARGING:return e.ChargeState.Charging;default:return}}notifyStateChange(e){this.stateChangeCallbacks.forEach(t=>{try{t(e)}catch(e){this.logger.error(`Error in state change callback: ${e}`)}})}dispose(){this.stateChangeCallbacks.clear(),this.state={}}}class z{deviceApi;logger;DEFAULT_REFRESH_FREQUENCY=600;refreshCompleteCallbacks=new Set;refreshErrorCallbacks=new Set;constructor(e,t){this.deviceApi=e,this.logger=t}getRefreshFrequency(){return this.DEFAULT_REFRESH_FREQUENCY}async refresh(e,t){e&&this.logger.debug(`Refresh requested for interface ${e}, but refreshing all properties`);try{const e=t?"User-initiated":"Scheduled";this.logger.info(`${e} refresh starting`);const r=(await this.deviceApi.getProperties()).properties;return this.logger.info(`${e} refresh completed successfully`),this.notifyRefreshComplete(r),r}catch(e){const r=e instanceof Error?e:new Error(String(e));return this.logger.warn(`Failed to refresh device properties: ${r.message}, user initiated: ${t}`),void this.notifyRefreshError(r)}}onRefreshComplete(e){return this.refreshCompleteCallbacks.add(e),()=>this.refreshCompleteCallbacks.delete(e)}onRefreshError(e){return this.refreshErrorCallbacks.add(e),()=>this.refreshErrorCallbacks.delete(e)}notifyRefreshComplete(e){this.refreshCompleteCallbacks.forEach(t=>{try{t(e)}catch(e){this.logger.error(`Error in refresh complete callback: ${e}`)}})}notifyRefreshError(e){this.refreshErrorCallbacks.forEach(t=>{try{t(e)}catch(e){this.logger.error(`Error in refresh error callback: ${e}`)}})}dispose(){this.refreshCompleteCallbacks.clear(),this.refreshErrorCallbacks.clear()}}class q{static logger=new G({name:"FFmpegUtils",type:"hidden",minLevel:3});static async convertH264ToJPEG(e,t=2){const r=await Promise.resolve().then(s.t.bind(s,5317,23));return new Promise((i,s)=>{if(t<1||t>31)return void s(new Error("JPEG quality must be between 1 and 31 (lower is better)"));const n=r.spawn("ffmpeg",["-f","h264","-i","pipe:0","-frames:v","1","-f","image2","-c:v","mjpeg","-q:v",t.toString(),"pipe:1"]),o=[],a=[];n.stdout.on("data",e=>{o.push(e)}),n.stderr.on("data",e=>{a.push(e)}),n.on("close",e=>{if(0===e&&o.length>0){const e=Buffer.concat(o);this.logger.debug(`Successfully converted H.264 to JPEG: ${e.length} bytes`),i(e)}else{const t=Buffer.concat(a).toString(),r=this.parseFFmpegError(e,t);this.logger.error(`FFmpeg conversion failed: ${r}`),s(new Error(r))}}),n.on("error",e=>{if("ENOENT"===e.code){const e="FFmpeg executable not found. Please ensure FFmpeg is installed and available in PATH.";this.logger.error(e),s(new Error(e))}else this.logger.error(`Failed to spawn FFmpeg: ${e.message}`),s(new Error(`Failed to spawn FFmpeg: ${e.message}`))}),n.stdin.write(e),n.stdin.end()})}static parseFFmpegError(e,t){return t.includes("Invalid data found when processing input")?"Invalid H.264 data provided. The data may be corrupted or incomplete.":t.includes("No such file or directory")?"FFmpeg executable not found. Please ensure FFmpeg is installed.":t.includes("Permission denied")?"Permission denied accessing FFmpeg executable.":t.includes("Decoder")&&t.includes("not found")?"H.264 decoder not available in your FFmpeg installation.":`FFmpeg conversion failed with code ${e}: ${t||"Unknown error"}`}static async isFFmpegAvailable(){const e=await Promise.resolve().then(s.t.bind(s,5317,23));return new Promise(t=>{const r=e.spawn("ffmpeg",["-version"]);r.on("error",e=>{e.code,t(!1)}),r.on("close",e=>{t(0===e)})})}static async getFFmpegVersion(){const e=await Promise.resolve().then(s.t.bind(s,5317,23));return new Promise((t,r)=>{const i=e.spawn("ffmpeg",["-version"]),s=[];i.stdout.on("data",e=>{s.push(e)}),i.on("error",e=>{r(e)}),i.on("close",e=>{if(0===e){const e=Buffer.concat(s).toString().split("\n")[0];t(e)}else r(new Error("Failed to get FFmpeg version"))})})}}class Q{serialNumber;streamServer;logger;constructor(e,t,r){this.serialNumber=e,this.streamServer=t,this.logger=r}getPictureOptions(){return{timeout:15e3}}async takePicture(e){this.logger.info("ðŸ“¸ Taking snapshot from camera stream");try{const r=e?.timeout||15e3;this.logger.info(`Using timeout: ${r}ms for snapshot capture`);const i=await this.streamServer.captureSnapshot(r);this.logger.info(`Captured H.264 keyframe: ${i.length} bytes - converting to JPEG`);const s=await q.convertH264ToJPEG(i);return this.logger.info(`âœ… Snapshot converted to JPEG: ${s.length} bytes`),t().mediaManager.createMediaObject(s,"image/jpeg",{sourceId:this.serialNumber})}catch(e){throw this.logger.error(`Failed to capture snapshot: ${e}`),e}}dispose(){this.logger.debug("Snapshot service disposed")}}class J{serialNumber;streamServer;logger;deviceType;streamServerStarted=!1;constructor(e,t,r,i){this.serialNumber=e,this.streamServer=t,this.logger=r,this.deviceType=i}setDeviceType(e){this.deviceType=e}getVideoDimensions(e){switch(e){case r.VideoQuality.LOW:return{width:640,height:480};case r.VideoQuality.MEDIUM:return{width:1280,height:720};case r.VideoQuality.HIGH:return{width:1920,height:1080};case r.VideoQuality.ULTRA:return{width:2560,height:1440};default:return{width:1920,height:1080}}}getVideoStreamOptions(e){const{width:t,height:r}=this.getVideoDimensions(e);return[{id:"p2p",name:"P2P Stream",container:"h264",video:{codec:"h264",width:t,height:r}}]}async getVideoStream(e,t){this.logger.info("Getting video stream, starting stream server if needed"),this.streamServerStarted||(this.logger.info("Starting stream server..."),await this.streamServer.start(),this.streamServerStarted=!0,this.logger.info("Stream server started"));const r=this.streamServer.getPort();if(!r)throw new Error("Failed to get stream server port");return this.logger.info(`Stream server is listening on port ${r}`),this.logger.info("Creating MediaObject with fallback dimensions (metadata will be updated when stream starts)"),await this.createOptimizedMediaObject(r,e,t)}async stopStream(){this.streamServerStarted&&(this.logger.info("Stopping stream server"),await this.streamServer.stop(),this.streamServerStarted=!1,this.logger.info("Stream server stopped"))}isStreaming(){return this.streamServerStarted}async createOptimizedMediaObject(e,i,s){const{width:n,height:o}=this.getVideoDimensions(i),a={url:void 0,inputArguments:["-f","h264","-framerate","25","-analyzeduration","5000000","-probesize","5000000","-fflags","+nobuffer+fastseek+flush_packets+discardcorrupt+igndts+genpts","-flags","low_delay","-avioflags","direct","-max_delay","1000","-thread_queue_size","768","-hwaccel","auto","-err_detect","ignore_err+crccheck","-c:v","h264",...this.deviceType&&(0,r.requiresErrorResilience)(this.deviceType)?["-enable_er","1"]:[],"-i",`tcp://127.0.0.1:${e}`],mediaStreamOptions:{id:s?.id||"main",name:s?.name||"Eufy Camera Stream",container:s?.container,video:{codec:"h264",width:n,height:o,...s?.video}}};return await t().mediaManager.createFFmpegMediaObject(a)}async dispose(){await this.stopStream(),this.logger.debug("Stream service disposed")}}class Z{wsClient;logger;clipMetadataCache=new Map;constructor(e,t){this.wsClient=e,this.logger=t}async getClips(e){try{this.logger.debug(`Fetching video clips for device ${e.serialNumber} on station ${e.stationSerialNumber}`);const t=await this.getClipsFromStationDatabase(e);return t.length>0?t:(this.logger.debug("No local recordings found, falling back to cloud API"),await this.getClipsFromCloudAPI(e))}catch(t){this.logger.error("Error fetching video clips:",t);try{return await this.getClipsFromCloudAPI(e)}catch(e){return this.logger.error("Cloud API fallback also failed:",e),[]}}}async downloadClip(e,r){this.logger.debug(`Fetching video clip: ${e}`);const i=this.clipMetadataCache.get(e);if(!i)throw new Error(`Video clip metadata not found for ID: ${e}`);if(i.storage_path&&void 0!==i.cipher_id)return await this.downloadClipViaP2P(e,r,i);if(i.cloud_path)return this.logger.debug(`Using cloud path: ${i.cloud_path}`),t().mediaManager.createMediaObject(Buffer.from(i.cloud_path),"text/plain",{sourceId:r});throw new Error(`No storage path, cipher ID, or cloud path available for video: ${e}`)}async downloadThumbnail(e,r){this.logger.debug(`Fetching thumbnail: ${e}`);const i=this.clipMetadataCache.get(e);if(!i)throw new Error(`Thumbnail metadata not found for ID: ${e}`);if(i.cached_thumbnail)return this.logger.debug(`Using pre-downloaded cached thumbnail for ${e}`),t().mediaManager.createMediaObject(i.cached_thumbnail,"image/jpeg",{sourceId:r});if(i.thumb_path&&void 0!==i.cipher_id)return await this.downloadThumbnailViaP2P(e,r,i);if(i.cloud_thumbnail){this.logger.debug("Attempting to download cloud thumbnail from URL");try{const e=await this.downloadFromUrl(i.cloud_thumbnail);return t().mediaManager.createMediaObject(e,"image/jpeg",{sourceId:r})}catch(t){throw this.logger.error("Failed to download cloud thumbnail:",t),new Error(`Cloud thumbnail URL expired or inaccessible for: ${e}`)}}throw new Error(`No thumbnail path, cipher ID, or cloud thumbnail available for: ${e}`)}clearCache(){this.clipMetadataCache.clear()}async getClipsFromStationDatabase(e){const t={serialNumbers:[e.serialNumber],startDate:this.formatDate(e.startTime),endDate:this.formatDate(e.endTime),eventType:0,detectionType:0,storageType:1};this.logger.debug("Querying station database with params:",JSON.stringify(t,null,2)),await this.wsClient.commands.station(e.stationSerialNumber).databaseQueryLocal(t);const r=await this.waitForDatabaseQueryResponse(e.stationSerialNumber);return 0===r.length?(this.logger.warn("No local recordings found in station database"),[]):(this.logger.debug(`Found ${r.length} records from station database`),this.mapDatabaseRecordsToClips(r,e.serialNumber))}async getClipsFromCloudAPI(e){this.logger.debug(`Fetching video clips from cloud API for time range: ${new Date(e.startTime).toISOString()} to ${new Date(e.endTime).toISOString()}`);const{events:t}=await this.wsClient.commands.driver().getHistoryEvents({startTimestampMs:e.startTime,endTimestampMs:e.endTime,filter:{stationSN:e.stationSerialNumber,storageType:r.StorageType.LOCAL_AND_CLOUD}});this.logger.debug(`Received ${t.length} events from cloud API`);const i=t.filter(t=>t.stationSN===e.stationSerialNumber);return 0===i.length?(this.logger.warn("No recordings found in cloud API for this device"),[]):(await this.preDownloadThumbnails(i,e.serialNumber),this.mapCloudEventsToClips(i,e.serialNumber))}async downloadClipViaP2P(e,r,i){this.logger.debug("Starting P2P download for video clip",{storage_path:i.storage_path,cipher_id:i.cipher_id});const s=this.wsClient.commands.device(r);await s.startDownload({path:i.storage_path,cipherId:i.cipher_id});const n=await this.collectDownloadData(r,6e4);return t().mediaManager.createMediaObject(n,"video/mp4",{sourceId:r})}async downloadThumbnailViaP2P(e,r,i){this.logger.debug("Starting P2P download for thumbnail",{thumb_path:i.thumb_path,cipher_id:i.cipher_id});const s=this.wsClient.commands.device(r);await s.startDownload({path:i.thumb_path,cipherId:i.cipher_id});const n=await this.collectDownloadData(r,3e4);return t().mediaManager.createMediaObject(n,"image/jpeg",{sourceId:r})}collectDownloadData(e,t){const i=[];let s=!1;return new Promise((n,o)=>{const a=setTimeout(()=>{this.logger.error(`Download timed out after ${t}ms`),d(),o(new Error("Download timed out"))},t),c=this.wsClient.addEventListener(r.DEVICE_EVENTS.DOWNLOAD_VIDEO_DATA,t=>{if(t.serialNumber===e){const e=Array.isArray(t.buffer)?Buffer.from(t.buffer):Buffer.from(t.buffer,"base64");i.push(e),this.logger.debug(`Received chunk: ${e.length} bytes (total: ${i.reduce((e,t)=>e+t.length,0)} bytes)`)}},{source:"device"}),l=this.wsClient.addEventListener(r.DEVICE_EVENTS.DOWNLOAD_FINISHED,t=>{if(t.serialNumber===e&&!s){if(s=!0,clearTimeout(a),d(),this.logger.debug(`Download complete: ${i.length} chunks, ${i.reduce((e,t)=>e+t.length,0)} total bytes`),0===i.length)return void o(new Error("No data received"));n(Buffer.concat(i))}},{source:"device"}),d=()=>{c(),l()}})}waitForDatabaseQueryResponse(e){return new Promise(t=>{const r=setTimeout(()=>{this.logger.warn("Station database query timed out after 10 seconds"),t([])},1e4),i=this.wsClient.addEventListener("database query local",s=>{s.serialNumber===e&&(clearTimeout(r),i(),Array.isArray(s.data)?t(s.data):(this.logger.error("Unexpected data format from station database query"),t([])))},{source:"station"})})}async preDownloadThumbnails(e,t){const r=e.filter(e=>e.thumbnailUrl).map(async e=>{const r=`cloud-${t}-${e.startTime}-${e.eventType}`;try{this.logger.debug(`Pre-downloading thumbnail for ${r}`);return{clipId:r,thumbnailBuffer:await this.downloadFromUrl(e.thumbnailUrl)}}catch(e){return this.logger.warn(`Failed to pre-download thumbnail for ${r}:`,e),{clipId:r,thumbnailBuffer:null}}}),i=await Promise.all(r);i.forEach(({clipId:e,thumbnailBuffer:t})=>{if(t){const r=this.clipMetadataCache.get(e)||{};r.cached_thumbnail=t,this.clipMetadataCache.set(e,r)}}),this.logger.debug(`Successfully pre-downloaded ${i.filter(e=>e.thumbnailBuffer).length} thumbnails`)}async downloadFromUrl(e){const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const r=await t.arrayBuffer();return Buffer.from(r)}mapDatabaseRecordsToClips(e,t){return e.map(e=>{const r="string"==typeof e.start_time?new Date(e.start_time).getTime():e.start_time,i="string"==typeof e.end_time?new Date(e.end_time).getTime():e.end_time,s=e.record_id?`${t}-${e.record_id}`:`${t}-${r}-${e.video_type}`;this.clipMetadataCache.set(s,{storage_path:e.storage_path,cipher_id:e.cipher_id,thumb_path:e.thumb_path,cloud_path:e.cloud_path,storage_type:e.storage_type,record_id:e.record_id});return{id:s,startTime:r,duration:i&&i>r?i-r:void 0,event:this.mapEventType(e.video_type||0),description:this.getEventDescription(e.video_type||0),thumbnailId:e.thumb_path?s:void 0,videoId:e.storage_path?s:void 0}})}mapCloudEventsToClips(e,t){return e.map(e=>{const r=`cloud-${t}-${e.startTime}-${e.eventType}`;this.clipMetadataCache.set(r,{cloud_path:e.videoUrl,storage_type:e.storageType,cloud_thumbnail:e.thumbnailUrl});const i=e.endTime?e.endTime-e.startTime:void 0;return{id:r,startTime:e.startTime,duration:i,event:this.mapEventType(e.eventType||0),description:this.getEventDescription(e.eventType||0),thumbnailId:e.thumbnailUrl?r:void 0,videoId:e.videoUrl?r:void 0}})}formatDate(e){const t=new Date(e);return`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}`}getEventDescription(e){return{1:"Motion detected",2:"Person detected",3:"Doorbell pressed",4:"Crying detected",5:"Sound detected",6:"Pet detected",7:"Vehicle detected",8:"Package delivered",9:"Package stranded",10:"Package taken",11:"Someone loitering",12:"Radar motion",13:"Dog detected",14:"Dog lick detected",15:"Dog poop detected",16:"Stranger detected"}[e]||`Event ${e}`}mapEventType(e){return{1:"motion",2:"person",3:"ring",4:"crying",5:"sound",6:"pet",7:"vehicle",8:"package",9:"package",10:"package",11:"loitering",12:"motion",13:"pet",14:"pet",15:"pet",16:"stranger"}[e]}}class X{deviceApi;getDeviceType;logger;constructor(e,t,r){this.deviceApi=e,this.getDeviceType=t,this.logger=r}updateCapabilities(){const e=this.getDeviceType(),t=(0,r.getDeviceCapabilities)(e||0);return{pan:t.panTilt,tilt:t.panTilt,zoom:!1}}async executeCommand(e){if(void 0===e.tilt){if(void 0===e.pan)throw new Error("Method not implemented.");await this.executePan(e.pan)}else await this.executeTilt(e.tilt)}async executeTilt(e){const t=e>0?r.PanTiltDirection.UP:r.PanTiltDirection.DOWN;await this.deviceApi.panAndTilt({direction:t}),this.logger.info("Tilted camera "+(e>0?"up":"down"))}async executePan(e){const t=e>0?r.PanTiltDirection.RIGHT:r.PanTiltDirection.LEFT;await this.deviceApi.panAndTilt({direction:t}),this.logger.info("Panned camera "+(e>0?"right":"left"))}dispose(){this.logger.debug("PTZ control service disposed")}}class ee{deviceApi;logger;constructor(e,t){this.deviceApi=e,this.logger=t}async turnOn(){await this.deviceApi.setProperty("light",!0),this.logger.info("Light turned on")}async turnOff(){await this.deviceApi.setProperty("light",!1),this.logger.info("Light turned off")}async setBrightness(e){if(e<0||e>100)throw new Error(`Invalid brightness value: ${e}. Must be between 0 and 100.`);await this.deviceApi.setProperty("lightSettingsBrightnessManual",e),this.logger.info(`Light brightness set to ${e}%`)}dispose(){this.logger.debug("Light control service disposed")}}class te extends e.ScryptedDeviceBase{wsClient;logger;latestProperties;propertiesLoaded;settingsService;stateService;refreshService;videoClipsService;snapshotService;streamService;ptzControlService;lightControlService;streamServer;get serialNumber(){return this.info?.serialNumber||"unknown"}get api(){return this.wsClient.commands.device(this.serialNumber)}constructor(e,t,i){super(e),this.wsClient=t;const s=e.charAt(0).toUpperCase()+e.slice(1);this.logger=i.getSubLogger({name:s,attachedTransports:[]}),this.logger.attachTransport(function(e){return t=>{const r=t._meta;if(!r)return;const i=r.name?`[${r.name}] `:"",s=Object.keys(t).filter(e=>"_meta"!==e&&"toJSON"!==e).map(e=>t[e]).map(e=>"object"==typeof e?JSON.stringify(e):String(e)).join(" "),n=r.logLevelName?.toLowerCase();"warn"===n?e.warn(`${i}${s}`):"error"===n||"fatal"===n?e.error(`${i}${s}`):e.log(`${i}${s}`)}}(this.console)),this.logger.info(`Created EufyDevice for ${e}`),this.createStreamServer(),this.initializeServices(),this.addEventListener(r.DEVICE_EVENTS.PROPERTY_CHANGED,this.handlePropertyChangedEvent.bind(this)),this.addEventListener(r.DEVICE_EVENTS.MOTION_DETECTED,this.handleMotionDetectedEvent.bind(this)),this.addEventListener(r.DEVICE_EVENTS.RINGS,this.handleDoorbellRingsEvent.bind(this)),this.wsClient.addEventListener(r.DEVICE_EVENTS.LIVESTREAM_STARTED,()=>{this.logger.info("Stream started")},{serialNumber:this.info?.serialNumber}),this.wsClient.addEventListener(r.DEVICE_EVENTS.LIVESTREAM_STOPPED,()=>{this.logger.debug("ðŸ“» WebSocket livestream stopped event received")},{serialNumber:this.info?.serialNumber}),this.propertiesLoaded=this.loadInitialProperties()}initializeServices(){const t={setProperty:async(e,t)=>{await this.api.setProperty(e,t)},getProperties:()=>this.api.getProperties(),panAndTilt:async e=>{await this.api.panAndTilt(e)}};this.settingsService=new Y(t,this.logger),this.stateService=new K(this.logger),this.refreshService=new z(t,this.logger),this.videoClipsService=new Z(this.wsClient,this.logger),this.snapshotService=new Q(this.serialNumber,this.streamServer,this.logger),this.streamService=new J(this.serialNumber,this.streamServer,this.logger,this.latestProperties?.type),this.ptzControlService=new X(t,()=>this.latestProperties?.type,this.logger),this.lightControlService=new ee(t,this.logger),this.stateService.onStateChange(e=>{this.logger.debug(`State changed: ${e.interface} = ${e.value}`),this.syncStateToProperties(),this.onDeviceEvent(e.interface,e.value)}),this.refreshService.onRefreshComplete(e=>{this.logger.debug("Refresh completed successfully"),this.latestProperties=e,this.streamService.setDeviceType(e.type),this.stateService.updateFromProperties(e),this.updatePtzCapabilities()}),this.refreshService.onRefreshError(e=>{this.logger.warn(`Refresh failed: ${e.message}`)}),this.settingsService.onSettingsChange(()=>{this.logger.debug("Settings changed, notifying Scrypted"),this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)})}async loadInitialProperties(){try{this.latestProperties=(await this.api.getProperties()).properties,this.streamService.setDeviceType(this.latestProperties.type),this.updateStateFromProperties(this.latestProperties),this.updatePtzCapabilities()}catch(e){this.logger.warn(`Failed to load initial properties: ${e}`)}}syncStateToProperties(){const e=this.stateService.getState();void 0!==e.motionDetected&&(this.motionDetected=e.motionDetected),void 0!==e.binaryState&&(this.binaryState=e.binaryState),void 0!==e.brightness&&(this.brightness=e.brightness),void 0!==e.on&&(this.on=e.on),void 0!==e.batteryLevel&&(this.batteryLevel=e.batteryLevel),void 0!==e.chargeState&&(this.chargeState=e.chargeState),e.sensors&&(this.sensors=e.sensors)}updateStateFromProperties(e){e&&(this.stateService.updateFromProperties(e),this.syncStateToProperties())}addEventListener(e,t){return this.wsClient.addEventListener(e,t,{source:r.EVENT_SOURCES.DEVICE,serialNumber:this.serialNumber})}handlePropertyChangedEvent({name:e,value:t}){this.latestProperties=this.latestProperties&&{...this.latestProperties,[e]:t},this.stateService.updateProperty(e,t)}handleMotionDetectedEvent(e){this.stateService.updateProperty("motionDetected",e.state)}handleDoorbellRingsEvent(e){this.stateService.updateState("binaryState",e.state)}async getSettings(){return await this.propertiesLoaded,this.settingsService.getSettings(this.info,this.latestProperties,this.name||"Unknown Device")}async putSetting(e,t){await this.settingsService.putSetting(e,t,this.latestProperties,this.info?.metadata||{},(e,t)=>{if(e in this.latestProperties){const r=e,i=this.info?.metadata?.[r],s=i?W.adjustValueForAPI(t,i):t;this.latestProperties=this.latestProperties&&{...this.latestProperties,[r]:s}}"scryptedName"===e&&(this.name=t)})}updatePtzCapabilities(){this.ptzCapabilities=this.ptzControlService.updateCapabilities()}async ptzCommand(e){return this.ptzControlService.executeCommand(e)}async turnOn(){return this.lightControlService.turnOn()}async turnOff(){return this.lightControlService.turnOff()}async setBrightness(e){return this.lightControlService.setBrightness(e)}async getVideoStreamOptions(){await this.propertiesLoaded;const e=this.latestProperties?.videoStreamingQuality;return this.streamService.getVideoStreamOptions(e)}async getVideoStream(e){await this.propertiesLoaded;const t=this.latestProperties?.videoStreamingQuality;return this.streamService.getVideoStream(t,e)}async getPictureOptions(){await this.propertiesLoaded;const e=this.latestProperties?.videoStreamingQuality,{width:t,height:r}=this.streamService.getVideoDimensions(e);return[{id:"snapshot",name:"Snapshot",picture:{width:t,height:r}}]}async takePicture(e){return this.snapshotService.takePicture(e)}async getRefreshFrequency(){return this.refreshService.getRefreshFrequency()}async refresh(e,t){await this.refreshService.refresh(e,t)}async getVideoClips(e){try{await this.propertiesLoaded;const t=this.latestProperties?.stationSerialNumber;if(!t)return this.logger.error("Station serial number not available"),[];const r=e?.startTime||Date.now()-6048e5,i=e?.endTime||Date.now();return await this.videoClipsService.getClips({serialNumber:this.serialNumber,stationSerialNumber:t,startTime:r,endTime:i})}catch(e){return this.logger.error(`Error fetching video clips: ${e}`),[]}}async getVideoClip(e){return this.videoClipsService.downloadClip(e,this.serialNumber)}async getVideoClipThumbnail(e,t){return this.videoClipsService.downloadThumbnail(e,this.serialNumber)}async removeVideoClips(...e){throw this.logger.warn(`Video clip deletion not currently supported by Eufy API: ${e.join(", ")}`),new Error("Video clip deletion is not supported by the Eufy Security API")}createStreamServer(){this.streamServer=new H.Kt({port:0,host:"127.0.0.1",logger:this.logger,wsClient:this.wsClient,serialNumber:this.serialNumber}),this.logger.debug("Stream server created with WebSocket client integration")}dispose(){this.streamService.dispose().catch(e=>this.logger.warn(`Error disposing stream service: ${e}`));const e=this.wsClient.removeEventListenersBySerialNumber(this.serialNumber,r.EVENT_SOURCES.DEVICE);this.logger.debug(`Removed ${e} event listeners during disposal`)}}const re={[r.GuardMode.AWAY]:e.SecuritySystemMode.AwayArmed,[r.GuardMode.HOME]:e.SecuritySystemMode.HomeArmed,[r.GuardMode.DISARMED]:e.SecuritySystemMode.Disarmed,[r.GuardMode.CUSTOM1]:e.SecuritySystemMode.NightArmed,[r.GuardMode.CUSTOM2]:e.SecuritySystemMode.NightArmed,[r.GuardMode.CUSTOM3]:e.SecuritySystemMode.NightArmed},ie={[e.SecuritySystemMode.AwayArmed]:r.GuardMode.AWAY,[e.SecuritySystemMode.HomeArmed]:r.GuardMode.HOME,[e.SecuritySystemMode.NightArmed]:r.GuardMode.HOME,[e.SecuritySystemMode.Disarmed]:r.GuardMode.DISARMED};class se{static genericDeviceInformation(e,t){return[se.settingFromMetadata(t.model,e.model,"The full product name and model of the device."),se.settingFromMetadata(t.serialNumber,e.serialNumber,"The unique serial number assigned to the device."),se.settingFromMetadata(t.softwareVersion,e.firmware,"The current software version running on the device.")]}static allWriteableDeviceProperties(e,t){return Object.values(t).filter(e=>e.writeable).filter(e=>!/test/i.test(e.name)).filter(e=>"light"!==e.name).map(t=>se.settingFromMetadata(t,e[t.name],void 0,se.groupForPropertyName(t.name)))}static groupForPropertyName(e){const t=e.toLowerCase();return t.includes("motion")&&!t.includes("light")?"Motion":t.includes("light")?"Light":t.includes("battery")||t.includes("charge")||t.includes("power")?"Power":t.includes("clip")||t.includes("record")?"Recording":t.includes("video")||t.includes("stream")||t.includes("vision")?"Video":t.includes("microphone")||t.includes("speaker")||t.includes("notification")?"Communication":"Configuration"}static valueAdjustedWithMetadata(e,t){if("number"===t.type&&t.states){return Object.values(t.states).indexOf(e)}return e}static settingFromMetadata(e,t,r,i){let s={key:e.name,title:e.label,type:e.type,value:void 0!==t?t:e.default,placeholder:e.default?String(e.default):void 0,readonly:!e.writeable,description:r,group:i};if("number"===e.type&&e.states)if(e.writeable){const r=Object.entries(e.states).sort(([e],[t])=>{const r=Number(e),i=Number(t);return isNaN(r)||isNaN(i)?e.localeCompare(t):r-i}).map(([,e])=>String(e));s={...s,type:"string",choices:r,value:e.states[t]}}else s={...s,type:"string",value:e.states[t]};else"number"===e.type&&void 0!==e.min&&void 0!==e.max&&(s={...s,range:[e.min,e.max],placeholder:void 0,description:`Value must be between ${e.min}${e.unit||""} and ${e.max}${e.unit||""}`});return s}static async createStationManifest(t,i){const s=t.commands.station(i),n=(await s.getProperties()).properties,o=(await s.getPropertiesMetadata()).properties,a=n.model?r.MODEL_NAMES[n.model]||n.model:"number"===o.type?.type&&o.type.states?o.type.states[n.type]:"Unknown Model";return{nativeId:`station_${i}`,type:e.ScryptedDeviceType.DeviceProvider,interfaces:["DeviceProvider","Settings","SecuritySystem","Refresh","Reboot"],name:n.name||`Eufy ${n.model}`,info:{model:a,manufacturer:"Eufy",version:n.hardwareVersion,firmware:n.softwareVersion,serialNumber:i,mac:n.macAddress,metadata:o}}}static async createDeviceManifest(t,i){const s=t.commands.device(i),n=(await s.getProperties()).properties,o=(await s.getPropertiesMetadata()).properties,a=(0,r.getDeviceCapabilities)(n.type),c=function(t){return(0,r.isDoorbell)(t)?e.ScryptedDeviceType.Doorbell:(0,r.isCamera)(t)?e.ScryptedDeviceType.Camera:(0,r.isSensor)(t)?e.ScryptedDeviceType.Sensor:(0,r.isLock)(t)?e.ScryptedDeviceType.Lock:e.ScryptedDeviceType.Unknown}(n.type),l=[e.ScryptedInterface.Camera,e.ScryptedInterface.VideoCamera,e.ScryptedInterface.MotionSensor,e.ScryptedInterface.Settings,e.ScryptedInterface.Refresh];a.battery&&(void 0!==n.battery&&l.push(e.ScryptedInterface.Battery),void 0!==n.chargingStatus&&l.push(e.ScryptedInterface.Charger)),a.floodlight&&(void 0!==n.light&&l.push(e.ScryptedInterface.OnOff),void 0!==n.lightSettingsBrightnessManual&&l.push(e.ScryptedInterface.Brightness)),a.panTilt&&l.push(e.ScryptedInterface.PanTiltZoom),(0,r.isDoorbell)(n.type)&&l.push(e.ScryptedInterface.BinarySensor),void 0!==n.wifiRssi&&l.push(e.ScryptedInterface.Sensors);const d=n.model?r.MODEL_NAMES[n.model]||n.model:"number"===o.type?.type&&o.type.states?o.type.states[n.type]:"Unknown Model";return{nativeId:`device_${i}`,name:n.name||`Eufy ${n.model}`,type:c,interfaces:l,info:{manufacturer:"Eufy",model:d,serialNumber:n.serialNumber,firmware:n.softwareVersion,metadata:o},providerNativeId:n.stationSerialNumber?`station_${n.stationSerialNumber}`:void 0}}static async convertH264ToJPEG(e,t=2){const r=await Promise.resolve().then(s.t.bind(s,5317,23));return new Promise((i,s)=>{const n=r.spawn("ffmpeg",["-f","h264","-i","pipe:0","-frames:v","1","-f","image2","-c:v","mjpeg","-q:v",t.toString(),"pipe:1"]),o=[],a=[];n.stdout.on("data",e=>{o.push(e)}),n.stderr.on("data",e=>{a.push(e)}),n.on("close",e=>{if(0===e&&o.length>0){const e=Buffer.concat(o);i(e)}else{const t=Buffer.concat(a).toString(),r=`FFmpeg conversion failed with code ${e}: ${t||"Unknown error"}`;t.includes("Invalid data found when processing input")?s(new Error(`Invalid H.264 data provided: ${t}`)):t.includes("No such file or directory")?s(new Error("FFmpeg executable not found. Please ensure FFmpeg is installed.")):t.includes("Permission denied")?s(new Error("Permission denied accessing FFmpeg executable.")):s(new Error(r))}}),n.on("error",e=>{"ENOENT"===e.code?s(new Error("FFmpeg executable not found. Please ensure FFmpeg is installed and available in PATH.")):s(new Error(`Failed to spawn FFmpeg: ${e.message}`))}),n.stdin.write(e),n.stdin.end()})}}class ne extends e.ScryptedDeviceBase{wsClient;childDevices=new Map;logger;latestProperties;propertiesLoaded;get serialNumber(){return this.info?.serialNumber||"unknown"}get api(){return this.wsClient.commands.station(this.serialNumber)}constructor(e,t,i){super(e),this.wsClient=t;const s=e.charAt(0).toUpperCase()+e.slice(1);this.logger=i.getSubLogger({name:s,attachedTransports:[]}),this.logger.attachTransport(function(e){return t=>{const r=t._meta;if(!r)return;const i=r.name?`[${r.name}] `:"",s=Object.keys(t).filter(e=>"_meta"!==e&&"toJSON"!==e).map(e=>t[e]).map(e=>"object"==typeof e?JSON.stringify(e):String(e)).join(" "),n=r.logLevelName?.toLowerCase();"warn"===n?e.warn(`${i}${s}`):"error"===n||"fatal"===n?e.error(`${i}${s}`):e.log(`${i}${s}`)}}(this.console)),this.logger.info(`Created EufyStation for ${e}`),this.addEventListener(r.STATION_EVENTS.PROPERTY_CHANGED,(e=>{this.handlePropertyChangedEvent(e)}).bind(this)),this.addEventListener(r.STATION_EVENTS.GUARD_MODE_CHANGED,e=>{}),this.addEventListener(r.STATION_EVENTS.CURRENT_MODE_CHANGED,e=>{this.handlePropertyChangedEvent.bind(this)}),this.propertiesLoaded=this.loadInitialProperties()}async loadInitialProperties(){try{this.latestProperties=(await this.api.getProperties()).properties,this.updateStateFromProperties(this.latestProperties)}catch(e){this.logger.warn(`Failed to load initial properties: ${e}`)}}updateStateFromProperties(e){}addEventListener(e,t){return this.wsClient.addEventListener(e,t,{source:r.EVENT_SOURCES.STATION,serialNumber:this.serialNumber})}handlePropertyChangedEvent({name:t,value:r}){switch(this.latestProperties=this.latestProperties&&{...this.latestProperties,[t]:r},t){case"alarm":case"currentMode":this.onDeviceEvent(e.ScryptedInterface.SecuritySystem,this.securitySystemState);break;case"guardMode":this.onDeviceEvent(e.ScryptedInterface.Settings,void 0);break;default:this.logger.info(`Property changed: ${t} = ${r}`)}}async getDevice(e){if(e&&e.startsWith("device_")){this.logger.debug(`Getting device ${e}`);let t=this.childDevices.get(e);return t||(t=new te(e,this.wsClient,this.logger),this.childDevices.set(e,t),this.logger.info(`Created new device ${e}`)),t}}async releaseDevice(e,t){const r=t||"";this.logger.debug(`Releasing device ${r}`),this.childDevices.delete(r)}async getSettings(){await this.propertiesLoaded;const{info:e}=this,{metadata:t}=e||{},r="Security System";return[{key:"scryptedName",title:"Station Name",description:"Name shown in Scrypted (can be customized)",value:this.name,type:"string",readonly:!1},...se.genericDeviceInformation(e,t),se.settingFromMetadata(t.currentMode,this.latestProperties?.currentMode,"Indicates the current operating mode of the security system (e.g., Home, Away, Disarmed). This field is read-only and reflects the system's present state.",r),se.settingFromMetadata(t.guardMode,this.latestProperties?.guardMode,"Guard mode determines how the security system responds to events. For example: 'Home' arms only outdoor sensors, 'Away' arms all sensors, and 'Disarmed' disables alarms. Other modes include 'Geofencing' (automatically arms/disarms based on your phone's location) and 'Schedule' (arms/disarms according to a set timetable). Select the mode that matches your current needs.",r)]}async putSetting(e,t){switch(this.logger.debug(`Setting ${e} = ${t}`),e){case"scryptedName":this.name=String(t);break;case"guardMode":this.api.setProperty("guardMode",se.valueAdjustedWithMetadata(t,this.info?.metadata.guardMode)).catch(e=>{this.logger.warn(`Failed to set guardMode: ${e}`)});break;default:this.logger.warn(`Unknown setting: ${e}`)}}securitySystemState={mode:re[this.latestProperties?.currentMode??r.AlarmMode.DISARMED],triggered:this.latestProperties?.alarm,supportedModes:[e.SecuritySystemMode.HomeArmed,e.SecuritySystemMode.AwayArmed,e.SecuritySystemMode.Disarmed]};async armSecuritySystem(t){t===e.SecuritySystemMode.Disarmed?this.logger.debug("Disarming"):this.logger.debug(`Arming to mode ${t}`),this.securitySystemState&&(this.securitySystemState.mode=t),this.api.setProperty("guardMode",ie[t])}async disarmSecuritySystem(){return this.armSecuritySystem(e.SecuritySystemMode.Disarmed)}async getRefreshFrequency(){return 1800}async refresh(e,t){if(!e)try{this.latestProperties=(await this.api.getProperties()).properties,this.updateStateFromProperties(this.latestProperties)}catch(e){this.logger.warn(`Failed to get station properties: ${e}, user initiated: ${t}`)}}async reboot(){this.logger.info("Rebooting"),await this.api.reboot()}dispose(){this.childDevices.forEach(e=>{e.dispose()}),this.childDevices.clear(),this.logger.debug("Disposed")}}var oe;!function(e){e.GENTLE="gentle",e.AGGRESSIVE="aggressive",e.EMERGENCY="emergency"}(oe||(oe={}));class ae{static instance;logger;config;cleanupCallbacks=new Map;monitorInterval;isMonitoring=!1;lastCleanupTime=0;lastCleanupLevel;constructor(e,t={}){this.logger=e,this.config={baseThresholdMB:120,monitorIntervalMs:1e4,enableDetailedLogging:!1,cleanupCooldownMs:3e4,...t}}static getInstance(e,t){return ae.instance||(ae.instance=new ae(e,t)),ae.instance}static getMemoryThreshold(){return ae.instance?.config.baseThresholdMB??120}static setMemoryThreshold(e,t){ae.instance?ae.instance.updateThreshold(e):t&&(ae.instance=new ae(t,{baseThresholdMB:e}))}registerCleanupCallback(e,t,r){this.cleanupCallbacks.set(e,{id:e,callback:t,description:r}),this.logger.debug(`ðŸ§© Registered memory cleanup callback: ${e}${r?` (${r})`:""}`),1===this.cleanupCallbacks.size&&this.startMonitoring()}unregisterCleanupCallback(e){this.cleanupCallbacks.delete(e)&&this.logger.debug(`ðŸ—‘ï¸ Unregistered memory cleanup callback: ${e}`),0===this.cleanupCallbacks.size&&this.stopMonitoring()}checkMemoryPressure(){const e=process.memoryUsage(),t=Math.round(e.rss/1024/1024),r=Math.round(e.heapUsed/1024/1024),i=Math.max(50,.75*this.config.baseThresholdMB),s=this.config.baseThresholdMB,n=1.25*this.config.baseThresholdMB;let o=null,a=0;if(t>n?(o=oe.EMERGENCY,a=n):t>s?(o=oe.AGGRESSIVE,a=s):t>i&&(o=oe.GENTLE,a=i),o){const e=Date.now()-this.lastCleanupTime;return o!==oe.EMERGENCY&&this.lastCleanupLevel===o&&e<this.config.cleanupCooldownMs?(this.logger.debug(`â±ï¸ Cleanup cooldown active: ${Math.round(e/1e3)}s / ${Math.round(this.config.cleanupCooldownMs/1e3)}s`),!1):(o===oe.GENTLE&&this.lastCleanupLevel===oe.GENTLE&&e<2*this.config.cleanupCooldownMs&&e>.5*this.config.cleanupCooldownMs&&(this.logger.warn("ðŸ”„ Escalating to aggressive cleanup - gentle cleanup wasn't sufficient"),o=oe.AGGRESSIVE,a=s),this.triggerCleanup({rssMB:t,heapMB:r,level:o,threshold:a}),!0)}return!1}updateThreshold(e){this.config.baseThresholdMB=Math.max(50,e),this.logger.debug(`ðŸŽ¯ Updated memory threshold to ${this.config.baseThresholdMB}MB`)}getCurrentMemoryUsage(){const e=process.memoryUsage();return{rssMB:Math.round(e.rss/1024/1024),heapMB:Math.round(e.heapUsed/1024/1024),thresholds:{gentle:Math.max(50,.75*this.config.baseThresholdMB),aggressive:this.config.baseThresholdMB,emergency:1.25*this.config.baseThresholdMB}}}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.logger.debug(`ðŸ” Starting memory monitoring (threshold: ${this.config.baseThresholdMB}MB, interval: ${this.config.monitorIntervalMs}ms)`),this.monitorInterval=setInterval(()=>{this.performMemoryCheck()},this.config.monitorIntervalMs))}stopMonitoring(){this.monitorInterval&&(clearInterval(this.monitorInterval),this.monitorInterval=void 0),this.isMonitoring=!1,this.logger.debug("ðŸ›‘ Stopped memory monitoring")}performMemoryCheck(){const e=process.memoryUsage(),t=Math.round(e.rss/1024/1024),r=Math.round(e.heapUsed/1024/1024);this.config.enableDetailedLogging&&this.logger.debug(`ðŸ“Š Memory check: ${t}MB RSS, ${r}MB heap, ${this.cleanupCallbacks.size} registered callbacks`),this.checkMemoryPressure()}triggerCleanup(e){const{level:t,rssMB:r,threshold:i}=e;this.lastCleanupTime=Date.now(),this.lastCleanupLevel=t;const s={[oe.GENTLE]:"âš ï¸",[oe.AGGRESSIVE]:"ðŸš¨",[oe.EMERGENCY]:"ðŸ’¥"}[t];this.logger.warn(`${s} ${t.toUpperCase()} memory cleanup triggered: ${r}MB > ${i}MB`);let n=0;for(const t of this.cleanupCallbacks.values())try{t.callback(e),n++}catch(e){this.logger.error(`âŒ Error in cleanup callback ${t.id}: ${e}`)}this.logger.debug(`ðŸ§¹ Executed ${n} cleanup callbacks`),global.gc&&(global.gc(),this.logger.debug("ðŸ—‘ï¸ Forced garbage collection"))}dispose(){this.stopMonitoring(),this.cleanupCallbacks.clear(),ae.instance=void 0,this.logger.debug("ðŸ—‘ï¸ MemoryManager disposed")}}const{deviceManager:ce}=t();function le(e){return t=>{const r=t._meta;if(!r)return;const i=r.name?`[${r.name}] `:"",s=Object.keys(t).filter(e=>"_meta"!==e&&"toJSON"!==e).map(e=>t[e]).map(e=>"object"==typeof e?JSON.stringify(e):String(e)).join(" "),n=r.logLevelName?.toLowerCase();"warn"===n?e.warn(`${i}${s}`):"error"===n||"fatal"===n?e.error(`${i}${s}`):e.log(`${i}${s}`)}}class de extends e.ScryptedDeviceBase{wsClient;wsLogger;logger;stations=new Map;debugLogging=!1;pushConnected=!1;mqttConnected=!1;isConnecting=!0;hasLoggedReady=!1;isWaitingForReady=!1;authManager;constructor(t){super(t),this.debugLogging="true"===this.storage.getItem("debugLogging"),this.logger=new G({name:"EufySecurity",minLevel:this.debugLogging?0:3,type:"hidden"}),this.logger.attachTransport(le(this.console)),this.wsLogger=this.logger.getSubLogger({name:"WebSocketClient"}),this.wsClient=new r.EufyWebSocketClient(this.storage.getItem("wsUrl")||"ws://localhost:3000",this.wsLogger);const i=Math.max(50,parseInt(this.storage.getItem("memoryThresholdMB")||"120")),s=this.logger.getSubLogger({name:"Memory"});ae.setMemoryThreshold(i,s);const n=this.logger.getSubLogger({name:"Auth"});this.authManager=new r.AuthenticationManager(this.wsClient,n,()=>this.onDeviceEvent(e.ScryptedInterface.Settings,void 0),async e=>{this.displayConnectResult(!0,!0),this.logger.info("ðŸ” Discovering devices after authentication..."),await this.registerStationsFromServerState(e),await this.registerDevicesFromServerState(e),this.logger.info("âœ… Device discovery complete"),this.isConnecting=!1}),this.logger.info("ðŸš€ EufySecurityProvider initialized"),this.startConnection().catch(e=>{this.logger.error("âŒ Failed to start connection:",e)})}async getSettings(){const e=this.wsClient.getState(),t=ae.getMemoryThreshold(),i=Math.round(process.memoryUsage().rss/1024/1024),s=this.authManager.getAuthStatusMessage(e?.driverConnected||!1);return[{group:"WebSocket Server Connection",key:"wsUrl",title:"WebSocket URL",description:"URL of the eufy-security-ws container",value:this.storage.getItem("wsUrl")||"ws://localhost:3000",placeholder:"ws://localhost:3000"},{group:"WebSocket Server Connection",key:"debugLogging",title:"Debug Logging",description:"Enable verbose logging for troubleshooting",value:this.debugLogging,type:"boolean",immediate:!0},{group:"Memory Management",key:"currentMemoryMB",title:"Current Memory Usage",description:`Current RSS memory usage vs threshold (${t}MB)`,value:`${i}MB ${i>t?"âš ï¸":"âœ…"}`,type:"string",readonly:!0},{group:"Memory Management",key:"memoryThresholdMB",title:"Memory Threshold (MB)",description:"System-wide memory threshold for buffer cleanup across all devices (default: 120MB)",type:"number",value:parseInt(this.storage.getItem("memoryThresholdMB")||"120")},{group:"Eufy Cloud Account",key:"driverConnectionStatus",title:"Account Connection Status",description:"Current Eufy cloud account connection state",value:e?.driverConnected?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected",type:"string",readonly:!0},{group:"Eufy Cloud Account",key:"pushConnectionStatus",title:"Push Notifications",description:"Push notification connection (requires push service in eufy-security-ws)",value:this.pushConnected?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected (may be normal)",type:"string",readonly:!0},{group:"Eufy Cloud Account",key:"mqttConnectionStatus",title:"MQTT Connection",description:"MQTT connection for real-time updates (requires MQTT in eufy-security-ws)",value:this.mqttConnected?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected (may be normal)",type:"string",readonly:!0},{group:"Eufy Cloud Account",key:"captchaStatus",title:"Authentication Status",description:"Current authentication/captcha status",value:s,type:"string",readonly:!0},...e?.driverConnected?[{group:"Eufy Cloud Account",key:"disconnectDriver",title:"Disconnect from Eufy Cloud",description:"Disconnect from Eufy cloud services",value:"Disconnect Account",type:"button"}]:[{group:"Eufy Cloud Account",key:"connectDriver",title:"Connect to Eufy Cloud",description:"Establish connection to Eufy cloud services",value:"Connect Account",type:"button"}],..."captcha_required"===this.authManager.getAuthState()&&this.authManager.getCaptchaData()?[{group:"Eufy Cloud Account",key:"captchaImage",title:"CAPTCHA Challenge",description:"Solve the CAPTCHA to continue authentication",value:`<div style="text-align: center; padding: 20px;"><img src="${this.authManager.getCaptchaData().captcha.startsWith("data:")?this.authManager.getCaptchaData().captcha:`data:image/png;base64,${this.authManager.getCaptchaData().captcha}`}" alt="CAPTCHA" style="max-width: 100%; border: 2px solid #ccc; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"/></div>`,type:"html",readonly:!0},{group:"Eufy Cloud Account",key:"captchaCodeInput",title:"CAPTCHA Code",description:`ID: ${this.authManager.getCaptchaData().captchaId} - Enter the code from the image above`,value:this.authManager.getCurrentCaptchaCode(),placeholder:"Enter CAPTCHA code",immediate:!0},{group:"Eufy Cloud Account",key:"submitCaptchaButton",title:"Submit CAPTCHA",description:"Click to submit the CAPTCHA code entered above",value:"Submit CAPTCHA Code",type:"button"}]:[],...this.authManager.getAuthState()===r.AUTH_STATE.MFA_REQUIRED?[{group:"Eufy Cloud Account",key:"verifyCodeInput",title:"2FA Verification Code",description:this.authManager.getMfaData()?.methods?.length?`Methods: ${this.authManager.getMfaData().methods.join(", ")} - Enter your 6-digit code`:"Check your email or SMS for the 6-digit verification code",value:this.authManager.getCurrentVerifyCode(),placeholder:"Enter 6-digit code",immediate:!0},{group:"Eufy Cloud Account",key:"submitVerifyCodeButton",title:"Submit 2FA Code",description:"Click to submit the verification code entered above",value:"Submit Verification Code",type:"button"}]:[],{group:"WebSocket Server Status",key:"connectionState",title:"Connection State",description:"Current connection lifecycle state",value:`${this.getConnectionStateIcon(e?.connection)} ${e?.connection||"Unknown"}`,type:"string",readonly:!0},{group:"WebSocket Server Status",key:"wsConnected",title:"WebSocket Connected",description:"Whether WebSocket connection is established",value:e?.wsConnected?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected",type:"string",readonly:!0},{group:"WebSocket Server Status",key:"schemaSetupComplete",title:"Schema Setup Complete",description:"Whether API schema negotiation is complete",value:e?.schemaSetupComplete?"âœ… Complete":"â³ Pending",type:"string",readonly:!0},{group:"WebSocket Server Status",key:"schemaInfo",title:"Schema Negotiation",description:"API version compatibility and negotiation results",value:e?.schemaInfo?`v${e.schemaInfo.negotiatedSchema} (compatible: ${e.schemaInfo.isCompatible?"âœ…":"âŒ"})`:"Not negotiated",type:"string",readonly:!0},{group:"WebSocket Server Status",key:"lastError",title:"Last Error",description:"Most recent error that occurred, if any",value:e?.lastError?`âŒ ${e.lastError.message}`:"âœ… None",type:"string",readonly:!0},{group:"WebSocket Server Status",key:"reconnectAttempts",title:"Reconnect Attempts",description:"Number of reconnection attempts made",value:e?.reconnectAttempts||0,type:"number",readonly:!0},{group:"WebSocket Server Status",key:"eventListenerCount",title:"Event Listeners",description:"Number of registered event listeners",value:e?.eventListenerCount||0,type:"number",readonly:!0}]}async putSetting(t,i){if("connectDriver"!==t)if("disconnectDriver"!==t){if("captchaCodeInput"===t)return this.authManager.updateCaptchaCode(i?.toString()||""),this.storage.setItem("captchaCodeInput",i?.toString()||""),void this.onDeviceEvent(e.ScryptedInterface.Settings,void 0);if("submitCaptchaButton"!==t){if("verifyCodeInput"===t)return this.authManager.updateVerifyCode(i?.toString()||""),this.storage.setItem("verifyCodeInput",i?.toString()||""),void this.onDeviceEvent(e.ScryptedInterface.Settings,void 0);if("submitVerifyCodeButton"!==t)if("requestNewCode"!==t)if(null!=i){if(this.storage.setItem(t,i.toString()),"wsUrl"===t)try{this.wsClient.disconnect(),this.wsClient=new r.EufyWebSocketClient(i.toString(),this.wsLogger),await this.startConnection(),this.logger.info("âœ… Reconnected with new WebSocket URL")}catch(e){throw this.logger.error("âŒ Failed to connect with new WebSocket URL:",e),e}else if("debugLogging"===t){const t=!0===i||"true"===i||1===i||"1"===i;this.debugLogging=t,this.logger.settings.minLevel=this.debugLogging?0:3,this.wsLogger.settings.minLevel=this.debugLogging?0:3,this.storage.setItem("debugLogging",this.debugLogging.toString()),this.logger.info("Debug logging "+(this.debugLogging?"enabled":"disabled")),this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}else if("memoryThresholdMB"===t){const t=Math.max(50,parseInt(i)||120);this.storage.setItem("memoryThresholdMB",t.toString());const r=this.logger.getSubLogger({name:"MemoryManager"});r.attachTransport(le(this.console)),ae.setMemoryThreshold(t,r),this.logger.info(`Memory threshold updated to ${t}MB`),this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}}else this.logger.warn(`âš ï¸ Ignoring setting update for ${t}: value is null/undefined`);else try{await this.authManager.requestNewCode()}catch(e){this.logger.error("âŒ Failed to request new code:",e)}else{try{await this.authManager.submitVerifyCode(),this.storage.removeItem("verifyCodeInput")}catch(e){this.logger.error("âŒ Verification code submission failed:",e)}this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}}else{try{await this.authManager.submitCaptcha(),this.storage.removeItem("captchaCodeInput")}catch(e){this.logger.error("âŒ CAPTCHA submission failed:",e)}this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}}else{this.logger.info("ðŸ”Œ Button clicked: Disconnect from Eufy cloud");try{await this.wsClient.commands.driver().disconnect(),this.logger.info("âœ… Driver disconnected successfully"),this.isConnecting=!0,this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}catch(t){throw this.logger.error("âŒ Failed to disconnect driver:",t),this.onDeviceEvent(e.ScryptedInterface.Settings,void 0),t}}else{this.logger.info("ðŸ”— Button clicked: Connect to Eufy cloud"),this.isConnecting=!0;try{await this.wsClient.commands.driver().connect(),this.logger.info("âœ… Driver connect command sent"),await new Promise(e=>setTimeout(e,1e3));const t=await this.wsClient.startListening();if(t.state.driver.connected)this.logger.info("âœ… Driver fully connected - authentication complete"),this.authManager.resetAuthState(),this.displayConnectResult(!0,!0),this.logger.info("ðŸ” Discovering devices..."),await this.registerStationsFromServerState(t),await this.registerDevicesFromServerState(t),this.logger.info("âœ… Device discovery complete"),this.isConnecting=!1;else if(this.logger.info("âš ï¸ Driver not connected - checking for authentication challenges"),await this.authManager.checkPendingAuth(),this.authManager.getAuthState()===r.AUTH_STATE.NONE){this.logger.info("ðŸ’¡ No authentication challenges detected. The connection may be in progress."),this.logger.info("ðŸ’¡ If you have 2FA enabled, you may need to check your email or app."),this.logger.info(""),this.logger.info("ðŸ” Troubleshooting tips:"),this.logger.info("   1. Check the eufy-security-ws container logs for errors"),this.logger.info("   2. Verify your Eufy account credentials in the container config"),this.logger.info("   3. Ensure the container has internet access to connect to Eufy cloud"),this.logger.info("   4. Try restarting the eufy-security-ws container"),this.logger.info(""),this.logger.info("   Container logs command:"),this.logger.info("   docker logs eufy-security-ws");const t=this.wsClient.addEventListener("connected",async()=>{t(),this.logger.info("âœ… Driver connected event received"),this.authManager.resetAuthState();const r=await this.wsClient.startListening();r.state.driver.connected&&(this.displayConnectResult(!0,!0),await this.registerStationsFromServerState(r),await this.registerDevicesFromServerState(r),this.logger.info("âœ… Device discovery complete"),this.isConnecting=!1),this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)},{source:"driver"})}}catch(e){this.logger.error("âŒ Connection failed:",e),await this.authManager.checkPendingAuth()}this.onDeviceEvent(e.ScryptedInterface.Settings,void 0)}}async getRefreshFrequency(){return 300}async refresh(){if(this.logger.info("ðŸ”„ Connection health check"),this.wsClient.isConnected())this.logger.info("âœ… WebSocket connection healthy");else{this.logger.warn("âš ï¸ WebSocket not connected, attempting to reconnect...");try{await this.startConnection(),this.logger.info("âœ… Successfully reconnected")}catch(e){throw this.logger.error("âŒ Failed to reconnect:",e),e}}}async getDevice(e){await this.waitForClientReady();if(this.wsClient.getState().driverConnected){if(e&&e.startsWith("station_")){this.logger.info(`Getting station ${e}`);let t=this.stations.get(e);return t||(t=new ne(e,this.wsClient,this.logger),this.stations.set(e,t),this.logger.info(`Created new station ${e}`)),t}}else this.isConnecting?this.logger.debug(`â³ Driver connecting, device ${e} will be available after authentication`):this.logger.warn(`âš ï¸ Driver not connected, cannot create device ${e}`)}async releaseDevice(e,t){if(t.startsWith("station_")){const e=this.stations.get(t);e&&(e.dispose(),this.stations.delete(t),this.logger.info(`ðŸ—‘ï¸ Released station ${t}`))}}async startConnection(){this.hasLoggedReady=!1,this.isWaitingForReady=!1,await this.wsClient.connect(),await this.waitForClientReady();const e=await this.wsClient.startListening();e.state.driver.connected?(await this.registerStationsFromServerState(e),await this.registerDevicesFromServerState(e),this.isConnecting=!1):this.logger.info("â³ Driver not connected yet - authentication may be required. Check settings to connect.")}async registerStationsFromServerState(e){const t=e.state.stations||[];if(this.logger.info(`ðŸ“¡ Found ${t.length} station serials from server:`,t),0===t.length)return void this.logger.warn("âš ï¸ No stations found in server state");const r=t.map(async e=>se.createStationManifest(this.wsClient,e));await ce.onDevicesChanged({providerNativeId:this.nativeId,devices:await Promise.all(r)}),this.logger.info(`âœ… Registered ${r.length} stations from server state`)}async registerDevicesFromServerState(e){const t=e.state.devices||[];this.logger.info(`ðŸ“± Found ${t.length} device serials from server:`,t),0!==t.length?(t.forEach(e=>se.createDeviceManifest(this.wsClient,e).then(e=>ce.onDevicesChanged({providerNativeId:e.providerNativeId,devices:[e]}))),this.logger.info(`âœ… Registered ${t.length} devices from server state`)):this.logger.warn("âš ï¸ No devices found in server state")}async waitForClientReady(){let e=0;return this.hasLoggedReady||this.isWaitingForReady||(this.logger.info("â³ Waiting for WebSocket client to be ready for API calls..."),this.isWaitingForReady=!0),new Promise((t,r)=>{const i=()=>{if(this.wsClient.isConnected())this.hasLoggedReady||(this.logger.info("âœ… WebSocket client ready for API calls"),this.hasLoggedReady=!0,this.isWaitingForReady=!1),t();else if(e>=15e3){const e=this.wsClient.getState();r(new Error(`Timeout waiting for client to be ready. Current state: ${e.connection}`))}else e+=500,setTimeout(i,500)};i()})}getConnectionStateIcon(e){switch(e){case"disconnected":return"ðŸ”´";case"connecting":return"ðŸŸ¡";case"connected":return"ðŸŸ ";case"schema_negotiating":return"ðŸ”„";case"ready":return"ðŸŸ¢";case"error":return"âŒ";default:return"â”"}}dispose(){this.wsClient.disconnect(),this.stations.clear()}async withTimeout(e,t,r){return new Promise((i,s)=>{const n=setTimeout(()=>{s(new Error(r))},t);e.then(e=>{clearTimeout(n),i(e)}).catch(e=>{clearTimeout(n),s(e)})})}displayConnectResult(e,t){if(!e)throw this.logger.error("âŒ Connection Failed: WEBSOCKET DISCONNECTED"),this.logger.error("   Cannot connect to the eufy-security-ws server."),this.logger.error("   This may indicate:"),this.logger.error("   â€¢ The eufy-security-ws server is not running"),this.logger.error("   â€¢ Network connectivity issues"),this.logger.error("   â€¢ Incorrect WebSocket host/port configuration"),this.logger.error("   â€¢ Server configuration issues"),new Error("âŒ WebSocket connection failed");t?(this.logger.info("âœ… Connection Successful: FULLY CONNECTED"),this.logger.info("   WebSocket connection established and Eufy driver is authenticated."),this.logger.info("   You can now use other Scrypted features to interact with your devices.")):(this.logger.warn("âš ï¸  Connection Established: DRIVER NEEDS AUTHENTICATION"),this.logger.warn("   WebSocket connection established, but Eufy driver is not authenticated."),this.logger.warn("   This typically means:"),this.logger.warn("   â€¢ 2FA authentication is required (captcha/verification code)"),this.logger.warn("   â€¢ Eufy account credentials need verification"),this.logger.warn("   â€¢ Check the settings page for authentication prompts"))}async getReadmeMarkdown(){const e=ae.getInstance(this.logger).getCurrentMemoryUsage(),t=ae.getMemoryThreshold();return`![Eufy Security Plugin](https://raw.githubusercontent.com/caplaz/eufy-security-scrypted/main/packages/eufy-security-scrypted/public/banner.png)\n\n## ðŸš€ Quick Setup\n\n### 1. Start the eufy-security-ws Server\n\nThis plugin requires a companion WebSocket server to communicate with Eufy cloud services.\n\n#### Option A: Docker (Recommended)\n\nCreate a \`docker-compose.yml\` file:\n\n\`\`\`yaml\nservices:\n  eufy-security-ws:\n    image: bropat/eufy-security-ws:latest\n    container_name: eufy-security-ws\n    ports:\n      - "3000:3000"\n    environment:\n      - USERNAME=your_eufy_email@example.com\n      - PASSWORD=your_eufy_password\n      - COUNTRY=US\n    restart: unless-stopped\n\`\`\`\n\nStart the server:\n\`\`\`bash\ndocker-compose up -d\n\`\`\`\n\n#### Option B: NPM Installation\n\n\`\`\`bash\nnpm install -g eufy-security-ws\n\`\`\`\n\nCreate a \`config.json\`:\n\`\`\`json\n{\n  "username": "your_eufy_email@example.com",\n  "password": "your_eufy_password",\n  "country": "US"\n}\n\`\`\`\n\nRun the server:\n\`\`\`bash\neufy-security-ws\n\`\`\`\n\n### 2. Configure Plugin Settings\n\nAfter starting the server, configure the plugin:\n\n- **WebSocket URL**: \`ws://localhost:3000\` (default)\n- **Debug Logging**: Enable for troubleshooting\n- **Memory Management**: Configure memory thresholds\n\n## ðŸ”Œ WebSocket Connection\n\n**Status**: ${this.wsClient?.isConnected()?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected"}\n\nConfigure the connection to your eufy-security-ws server:\n\n- **WebSocket URL**: \`ws://localhost:3000\` (default)\n- **Connection State**: ${this.getConnectionStateDescription()}\n\n### Connection States\n- **ðŸŸ¢ Ready**: Fully connected and operational\n- **ðŸŸ  Connected**: WebSocket connected, waiting for auth\n- **ðŸŸ¡ Connecting**: Establishing connection\n- **ðŸ”´ Disconnected**: Not connected\n\n## â˜ï¸ Cloud Account\n\n**Authentication Status**: ${this.getAuthStatusDescription()}\n\n### Authentication Flow\n1. Click **"Connect Account"** in plugin settings\n2. Complete CAPTCHA challenge (if required)\n3. Enter 2FA verification code (if enabled)\n4. Devices will automatically appear\n\n### Troubleshooting Authentication\n- **CAPTCHA Issues**: Refresh settings page if CAPTCHA doesn't appear\n- **2FA Problems**: Check email/SMS for verification codes\n- **Connection Errors**: Verify eufy-security-ws server is running\n\n## ðŸ§  Memory Management\n\n**Current Usage**: ${e.heapMB} MB (RSS: ${e.rssMB} MB)\n**Threshold**: ${t} MB\n**Status**: ${e.heapMB<t?"âœ… Normal":"âš ï¸ High"}\n\n### Memory Settings\n- **Automatic Cleanup**: Enabled when threshold exceeded\n- **Optimized Buffers**: Memory-conscious video streaming\n- **Crash Prevention**: Monitors and manages memory usage\n\n### Performance Tips\n- **Low Memory Systems** (â‰¤4GB RAM): Set threshold to 80-100MB\n- **Normal Systems** (8GB RAM): Default 120-150MB threshold\n- **High Memory Systems** (â‰¥16GB RAM): Can use 200-300MB threshold\n\n## ðŸ“Š System Status\n\n**Push Connected**: ${this.pushConnected?"âœ…":"âŒ"}\n**MQTT Connected**: ${this.mqttConnected?"âœ…":"âŒ"}\n**Debug Logging**: ${this.debugLogging?"Enabled":"Disabled"}\n\n## ðŸ”§ Quick Actions\n\n- **Reconnect**: Use if connection is lost\n- **Refresh Devices**: Sync latest device list from Eufy\n- **Debug Toggle**: Enable for troubleshooting logs\n\n---\n\n*This README is dynamically generated based on your current plugin configuration.*`}getConnectionStateDescription(){if(!this.wsClient)return"Not initialized";const e=this.wsClient.isConnected(),t=this.wsClient.isDriverConnected();return e&&t?"Fully Connected":e&&!t?"WebSocket Connected (Auth Required)":e?"Unknown":"Disconnected"}getAuthStatusDescription(){switch(this.authManager.getAuthState()){case r.AUTH_STATE.NONE:return"Not Authenticated âŒ";case r.AUTH_STATE.CAPTCHA_REQUIRED:return"CAPTCHA Required âš ï¸";case r.AUTH_STATE.MFA_REQUIRED:return"2FA Required âš ï¸";default:return"Unknown"}}}const he=de})();var o=exports="undefined"==typeof exports?{}:exports;for(var a in n)o[a]=n[a];n.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})})();
//# sourceMappingURL=main.nodejs.js.map