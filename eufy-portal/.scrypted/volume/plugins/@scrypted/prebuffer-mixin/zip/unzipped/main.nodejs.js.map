{"version":3,"file":"main.nodejs.js","mappings":"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","sources":["../external node-commonjs \"url\"","../src/sps-resolution.ts","../node_modules/h264-sps-parser/dist/vui.js","../external node-commonjs \"dgram\"","../external node-commonjs \"stream\"","../../../common/node_modules/http-auth-utils/dist/utils.js","../src/local-addresses.ts","../external node-commonjs \"net\"","../../../common/node_modules/http-auth-utils/dist/mechanisms/basic.js","../../../common/node_modules/http-auth-utils/dist/mechanisms/digest.js","../../../server/src/deferred.ts","../external node-commonjs \"child_process\"","../../../common/src/rtsp-server.ts","../external node-commonjs \"module\"","../node_modules/h264-sps-parser/dist/index.js","../../../sdk/dist/src|sync","../../../sdk/dist/src/storage-settings.js","../node_modules/h264-sps-parser/dist/bitstream.js","../src/main.ts","../external node-commonjs \"events\"","../../../common/src/clone-deep.ts","../../../common/src/read-stream.ts","../../../server/src/promise-utils.ts","../src/ffmpeg-rebroadcast.ts","../../../common/src/listen-cluster.ts","../external node-commonjs \"os\"","../../../common/node_modules/yerror/dist/index.js","../src/rebroadcast-mixin-token.ts","../../../common/src/activity-timeout.ts","../../../server/src/sleep.ts","../../../common/src/media-helpers.ts","../../../server/src/listen-zero.ts","../src/rtsp-session.ts","../src/rfc4571.ts","../../../common/src/sleep.ts","../../../sdk/dist/src/index.js","../external node-commonjs \"tls\"","../src/stream-settings.ts","../../../sdk/dist/types/gen/index.js","../../../common/src/settings-mixin.ts","../../../common/src/autoenable-mixin-provider.ts","../../../common/src/sdp-utils.ts","../external node-commonjs \"fs\"","../src/file-rtsp-server.ts","../external node-commonjs \"path\"","../external node-commonjs \"process\"","../external node-commonjs \"crypto\"","../../../server/src/media-helpers.ts","../webpack/bootstrap","../webpack/runtime/define property getters","../webpack/runtime/hasOwnProperty shorthand","../webpack/startup"],"sourcesContent":["module.exports = require(\"url\");","import { SPSInfo } from \"h264-sps-parser\";\n\nexport function getSpsResolution(sps: SPSInfo) {\n    let SubWidthC: number;\n    let SubHeightC: number;\n\n    if (sps.chroma_format_idc == 0 && sps.color_plane_flag == 0) { //monochrome\n        SubWidthC = SubHeightC = 0;\n    }\n    else if (sps.chroma_format_idc == 1 && sps.color_plane_flag == 0) { //4:2:0 \n        SubWidthC = SubHeightC = 2;\n    }\n    else if (sps.chroma_format_idc == 2 && sps.color_plane_flag == 0) { //4:2:2 \n        SubWidthC = 2;\n        SubHeightC = 1;\n    }\n    else if (sps.chroma_format_idc == 3) { //4:4:4\n        if (sps.color_plane_flag == 0) {\n            SubWidthC = SubHeightC = 1;\n        }\n        else if (sps.color_plane_flag == 1) {\n            SubWidthC = SubHeightC = 0;\n        }\n    }\n\n    let PicWidthInMbs = sps.pic_width_in_mbs;\n\n    let PicHeightInMapUnits = sps.pic_height_in_map_units;\n    let FrameHeightInMbs = (2 - sps.frame_mbs_only_flag) * PicHeightInMapUnits;\n\n    let crop_left = 0;\n    let crop_right = 0;\n    let crop_top = 0;\n    let crop_bottom = 0;\n\n    if (sps.frame_cropping_flag) {\n        crop_left = sps.frame_cropping.left;\n        crop_right = sps.frame_cropping.right;\n        crop_top = sps.frame_cropping.top;\n        crop_bottom = sps.frame_cropping.bottom;\n    }\n\n    let width = PicWidthInMbs * 16 - SubWidthC * (crop_left + crop_right);\n    let height = FrameHeightInMbs * 16 - SubHeightC * (2 - sps.frame_mbs_only_flag) * (crop_top + crop_bottom);\n\n    return {\n        width,\n        height,\n    };\n}","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction hrd_parameters(hrd, stream) {\r\n    const cpb_cnt_minus1 = stream.ExpGolomb();\r\n    hrd.cpb_cnt = cpb_cnt_minus1 + 1;\r\n    hrd.bit_rate_scale = stream.readNibble();\r\n    hrd.cpb_size_scale = stream.readNibble();\r\n    for (let i = 0; i <= cpb_cnt_minus1; i++) {\r\n        hrd.bit_rate_value[i] = stream.ExpGolomb() + 1;\r\n        hrd.cpb_size_value[i] = stream.ExpGolomb() + 1;\r\n        hrd.cbr_flag[i] = stream.readBit();\r\n    }\r\n    hrd.initial_cpb_removal_delay_length = stream.read5() + 1;\r\n    hrd.cpb_removal_delay_length = stream.read5() + 1;\r\n    hrd.dpb_output_delay_length = stream.read5() + 1;\r\n    hrd.time_offset_length = stream.read5();\r\n}\r\nfunction getVUIParams(flag, stream) {\r\n    const vp = {\r\n        aspect_ratio_info_present_flag: 0,\r\n        aspect_ratio_idc: 0,\r\n        sar_width: 0,\r\n        sar_height: 0,\r\n        overscan_info_present_flag: 0,\r\n        overscan_appropriate_flag: 0,\r\n        video_signal_type_present_flag: 0,\r\n        video_format: 0,\r\n        video_full_range_flag: 0,\r\n        colour_description_present_flag: 0,\r\n        colour_primaries: 0,\r\n        transfer_characteristics: 0,\r\n        matrix_coefficients: 0,\r\n        chroma_loc_info_present_flag: 0,\r\n        chroma_sample_loc_type_top_field: 0,\r\n        chroma_sample_loc_type_bottom_field: 0,\r\n        timing_info_present_flag: 0,\r\n        num_units_in_tick: 0,\r\n        time_scale: 0,\r\n        fixed_frame_rate_flag: 0,\r\n        nal_hrd_parameters_present_flag: 0,\r\n        vcl_hrd_parameters_present_flag: 0,\r\n        hrd_params: {\r\n            cpb_cnt: 0,\r\n            bit_rate_scale: 0,\r\n            cpb_size_scale: 0,\r\n            bit_rate_value: [],\r\n            cpb_size_value: [],\r\n            cbr_flag: [],\r\n            initial_cpb_removal_delay_length: 0,\r\n            cpb_removal_delay_length: 0,\r\n            dpb_output_delay_length: 0,\r\n            time_offset_length: 0,\r\n        },\r\n        low_delay_hrd_flag: 0,\r\n        pic_struct_present_flag: 0,\r\n        bitstream_restriction_flag: 0,\r\n        motion_vectors_over_pic_boundaries_flag: 0,\r\n        max_bytes_per_pic_denom: 0,\r\n        max_bits_per_mb_denom: 0,\r\n        log2_max_mv_length_horizontal: 0,\r\n        log2_max_mv_length_vertical: 0,\r\n        num_reorder_frames: 0,\r\n        max_dec_frame_buffering: 0,\r\n    };\r\n    if (!flag)\r\n        return vp;\r\n    vp.aspect_ratio_info_present_flag = stream.readBit();\r\n    if (vp.aspect_ratio_info_present_flag) {\r\n        vp.aspect_ratio_idc = stream.ExpGolomb();\r\n        if (vp.aspect_ratio_idc === 255) { // Extended_SAR\r\n            vp.sar_width = stream.readByte();\r\n            vp.sar_height = stream.readByte();\r\n        }\r\n    }\r\n    vp.overscan_info_present_flag = stream.readBit();\r\n    if (vp.overscan_info_present_flag) {\r\n        vp.overscan_appropriate_flag = stream.readBit();\r\n    }\r\n    vp.video_signal_type_present_flag = stream.readBit();\r\n    if (vp.video_signal_type_present_flag) {\r\n        vp.video_format = (stream.readBit() << 2) |\r\n            (stream.readBit() << 1) |\r\n            stream.readBit();\r\n        vp.video_full_range_flag = stream.readBit();\r\n        vp.colour_description_present_flag = stream.readBit();\r\n        if (vp.colour_description_present_flag) {\r\n            vp.colour_primaries = stream.readByte();\r\n            vp.transfer_characteristics = stream.readByte();\r\n            vp.matrix_coefficients = stream.readByte();\r\n        }\r\n    }\r\n    vp.chroma_loc_info_present_flag = stream.readBit();\r\n    if (vp.chroma_loc_info_present_flag) {\r\n        vp.chroma_sample_loc_type_top_field = stream.ExpGolomb();\r\n        vp.chroma_sample_loc_type_bottom_field = stream.ExpGolomb();\r\n    }\r\n    vp.timing_info_present_flag = stream.readBit();\r\n    if (vp.timing_info_present_flag) {\r\n        vp.num_units_in_tick = stream.readWord();\r\n        vp.time_scale = stream.readWord();\r\n        vp.fixed_frame_rate_flag = stream.readBit();\r\n    }\r\n    vp.nal_hrd_parameters_present_flag = stream.readBit();\r\n    if (vp.nal_hrd_parameters_present_flag) {\r\n        hrd_parameters(vp.hrd_params, stream);\r\n    }\r\n    vp.vcl_hrd_parameters_present_flag = stream.readBit();\r\n    if (vp.vcl_hrd_parameters_present_flag) {\r\n        hrd_parameters(vp.hrd_params, stream);\r\n    }\r\n    if (vp.nal_hrd_parameters_present_flag || vp.vcl_hrd_parameters_present_flag) {\r\n        vp.low_delay_hrd_flag = stream.readBit();\r\n    }\r\n    vp.pic_struct_present_flag = stream.readBit();\r\n    vp.bitstream_restriction_flag = stream.readBit();\r\n    if (vp.bitstream_restriction_flag) {\r\n        vp.motion_vectors_over_pic_boundaries_flag = stream.readBit();\r\n        vp.max_bytes_per_pic_denom = stream.ExpGolomb();\r\n        vp.max_bits_per_mb_denom = stream.ExpGolomb();\r\n        vp.log2_max_mv_length_horizontal = stream.ExpGolomb();\r\n        vp.log2_max_mv_length_vertical = stream.ExpGolomb();\r\n        vp.num_reorder_frames = stream.ExpGolomb();\r\n        vp.max_dec_frame_buffering = stream.ExpGolomb();\r\n    }\r\n    return vp;\r\n}\r\nexports.getVUIParams = getVUIParams;\r\n","module.exports = require(\"dgram\");","module.exports = require(\"stream\");","import { YError } from 'yerror';\nconst QUOTE = '\"';\nconst EQUAL = '=';\nconst SEPARATOR = ', ';\n/*\n * Regular expression for matching the key-value pairs\n * \\w+     = The key\n * =       = The equal sign\n * \".*?\"   = Value option 1: A double-quoted value (using the non-greedy *? to stop at the first doublequote)\n * [^\",]+  = Value option 2: A string without commas or double-quotes\n * (?=,|$) = Zero-width (as in not captured) positive lookahead assertion.\n *           The previous match will only be valid if it's followed by a \" literal\n *           or the end of the string\n */\nconst KEYVALUE_REGEXP = /\\w+=(\".*?\"|[^\",]+)(?=,|$)/g;\n// FIXME: Create a real parser\nexport function parseHTTPHeadersQuotedKeyValueSet(contents, authorizedKeys, requiredKeys = [], valuesToNormalize = []) {\n    const matches = contents.trim().match(KEYVALUE_REGEXP);\n    if (!matches)\n        throw new YError('E_MALFORMED_QUOTEDKEYVALUE', contents);\n    const data = matches\n        .map((part, partPosition) => {\n        const [key, ...rest] = part.split(EQUAL);\n        const value = rest.join(EQUAL);\n        if (0 === rest.length) {\n            throw new YError('E_MALFORMED_QUOTEDKEYVALUE', partPosition, part);\n        }\n        return [key, value];\n    })\n        .reduce(function (parsedValues, [name, value], valuePosition) {\n        const normalizedName = name.toLowerCase();\n        if (-1 === authorizedKeys.indexOf(normalizedName)) {\n            throw new YError('E_UNAUTHORIZED_KEY', valuePosition, normalizedName);\n        }\n        /*\n         * Regular expression for stripping paired starting and ending double quotes off the value:\n         * ^      = The beginning of the string\n         * \"      = The first double quote\n         * .+     = One or more characters of any kind\n         * (?=\"$) = Zero-width (as in not captured) positive lookahead assertion.\n         *          The previous match will only be valid if it's followed by a \" literal\n         *          or the end of the string\n         * \"      = The ending double quote\n         * $      = The end of the string\n         */\n        const strippedValue = value.replace(/^\"(.+(?=\"$))\"$/, '$1');\n        parsedValues[normalizedName] = valuesToNormalize.includes(normalizedName)\n            ? strippedValue.toLowerCase()\n            : strippedValue;\n        return parsedValues;\n    }, {});\n    _checkRequiredKeys(requiredKeys, data);\n    return data;\n}\nexport function buildHTTPHeadersQuotedKeyValueSet(data, authorizedKeys, requiredKeys = []) {\n    _checkRequiredKeys(requiredKeys, data);\n    return authorizedKeys.reduce(function (contents, key) {\n        if (data[key]) {\n            return (contents +\n                (contents ? SEPARATOR : '') +\n                key +\n                EQUAL +\n                QUOTE +\n                data[key] +\n                QUOTE);\n        }\n        return contents;\n    }, '');\n}\nfunction _checkRequiredKeys(requiredKeys, data) {\n    requiredKeys.forEach((name) => {\n        if ('undefined' === typeof data[name]) {\n            throw new YError('E_REQUIRED_KEY', name);\n        }\n    });\n}\n//# sourceMappingURL=utils.js.map","import net from 'net';\nimport sdk from '@scrypted/sdk';\n\nexport async function getUrlLocalAdresses(console: Console, url: string) {\n    let urls: string[];\n    try {\n        const addresses = await sdk.endpointManager.getLocalAddresses();\n        if (addresses) {\n            urls = addresses.map(address => {\n                const u = new URL(url);\n                u.hostname = net.isIPv6(address) ? `[${address}]` : address;\n                return u.toString();\n            });\n        }\n    }\n    catch (e) {\n        console.warn('Error determining external addresses. Is Scrypted Server Address configured?', e);\n    }\n\n    if (process.env.SCRYPTED_CLUSTER_ADDRESS) {\n        try {\n            const clusterUrl = new URL(url);\n            clusterUrl.hostname = process.env.SCRYPTED_CLUSTER_ADDRESS;\n            const str = clusterUrl.toString();\n            if (!urls?.includes(str)) {\n                urls ||= [];\n                urls.push(str);\n            }\n        }\n        catch (e) {\n            console.warn('Error determining external addresses. Is Scrypted Cluster Address configured?', e);\n        }\n    }\n\n    return urls;\n}\n","module.exports = require(\"net\");","/**\n * @module http-auth-utils/mechanisms/basic\n */\nimport { YError } from 'yerror';\nimport { parseHTTPHeadersQuotedKeyValueSet, buildHTTPHeadersQuotedKeyValueSet, } from '../utils.js';\nconst REQUIRED_WWW_AUTHENTICATE_KEYS = ['realm'];\nconst AUTHORIZED_WWW_AUTHENTICATE_KEYS = REQUIRED_WWW_AUTHENTICATE_KEYS;\n/* Architecture Note #1.2: Basic mechanism\n\nSee the following [RFC](https://tools.ietf.org/html/rfc7617).\n\n*/\n/**\n * Basic authentication mechanism.\n * @type {Object}\n * @see http://tools.ietf.org/html/rfc2617#section-2\n */\nconst BASIC = {\n    /**\n     * The Basic auth mechanism prefix.\n     * @type {String}\n     */\n    type: 'Basic',\n    /**\n     * Parse the WWW Authenticate header rest.\n     * @param  {String} rest The header rest (string after the authentication mechanism prefix).\n     * @return {Object}      Object representing the result of the parse operation.\n     * @example\n     * assert.deepEqual(\n     *   BASIC.parseWWWAuthenticateRest('realm=\"perlinpinpin\"'), {\n     *     realm: 'perlinpinpin'\n     *   }\n     * );\n     * @api public\n     */\n    parseWWWAuthenticateRest: function parseWWWAuthenticateRest(rest) {\n        return parseHTTPHeadersQuotedKeyValueSet(rest, AUTHORIZED_WWW_AUTHENTICATE_KEYS, REQUIRED_WWW_AUTHENTICATE_KEYS);\n    },\n    /**\n     * Build the WWW Authenticate header rest.\n     * @param  {Object} data The content from wich to build the rest.\n     * @return {String}         The built rest.\n     * @example\n     * assert.equal(\n     *   BASIC.buildWWWAuthenticateRest({\n     *     realm: 'perlinpinpin'\n     *   }),\n     *   'realm=\"perlinpinpin\"'\n     * );\n     * @api public\n     */\n    buildWWWAuthenticateRest: function buildWWWAuthenticateRest(data) {\n        return buildHTTPHeadersQuotedKeyValueSet(data, AUTHORIZED_WWW_AUTHENTICATE_KEYS, REQUIRED_WWW_AUTHENTICATE_KEYS);\n    },\n    /**\n     * Parse the Authorization header rest.\n     * @param  {String} rest The header rest (string after the authentication mechanism prefix).)\n     * @return {Object}      Object representing the result of the parse operation {hash}.\n     * @example\n     * assert.deepEqual(\n     *   BASIC.parseAuthorizationRest('QWxpIEJhYmE6b3BlbiBzZXNhbWU='), {\n     *     hash: 'QWxpIEJhYmE6b3BlbiBzZXNhbWU=',\n     *     username: 'Ali Baba',\n     *     password: 'open sesame'\n     *   }\n     * );\n     * @api public\n     */\n    parseAuthorizationRest: function parseAuthorizationRest(rest) {\n        if (!rest) {\n            throw new YError('E_EMPTY_AUTH');\n        }\n        const { username, password } = BASIC.decodeHash(rest);\n        return {\n            hash: rest,\n            username,\n            password,\n        };\n    },\n    /**\n     * Build the Authorization header rest.\n     * @param  {Object} content The content from wich to build the rest.\n     * @return {String}         The rest built.\n     * @example\n     * assert.equal(\n     *   BASIC.buildAuthorizationRest({\n     *     hash: 'QWxpIEJhYmE6b3BlbiBzZXNhbWU='\n     *   }),\n     *   'QWxpIEJhYmE6b3BlbiBzZXNhbWU='\n     * );\n     * @api public\n     */\n    buildAuthorizationRest: function buildAuthorizationRest({ hash, username, password, }) {\n        if (username && password) {\n            return BASIC.computeHash({\n                username,\n                password,\n            });\n        }\n        if (!hash) {\n            throw new YError('E_NO_HASH');\n        }\n        return hash;\n    },\n    /**\n     * Compute the Basic authentication hash from the given credentials.\n     * @param  {Object} credentials The credentials to encode {username, password}.\n     * @return {String}             The hash representing the credentials.\n     * @example\n     * assert.equal(\n     *   BASIC.computeHash({\n     *     username: 'Ali Baba',\n     *     password: 'open sesame'\n     *   }),\n     *   'QWxpIEJhYmE6b3BlbiBzZXNhbWU='\n     * );\n     * @api public\n     */\n    computeHash: function computeHash({ username, password, }) {\n        return Buffer.from(username + ':' + password).toString('base64');\n    },\n    /**\n     * Decode the Basic hash and return the corresponding credentials.\n     * @param  {String} hash The hash.\n     * @return {Object}      Object representing the credentials {username, password}.\n     * @example\n     * assert.deepEqual(\n     *   BASIC.decodeHash('QWxpIEJhYmE6b3BlbiBzZXNhbWU='), {\n     *     username: 'Ali Baba',\n     *     password: 'open sesame'\n     *   }\n     * );\n     * @api public\n     */\n    decodeHash: function decodeHash(hash) {\n        const [username, ...passwordParts] = Buffer.from(hash, 'base64')\n            .toString()\n            .split(':');\n        return {\n            username,\n            password: passwordParts.join(':'),\n        };\n    },\n};\nexport default BASIC;\n//# sourceMappingURL=basic.js.map","/**\n * @module http-auth-utils/mechanisms/digest\n */\nimport { parseHTTPHeadersQuotedKeyValueSet, buildHTTPHeadersQuotedKeyValueSet, } from '../utils.js';\nimport crypto from 'crypto';\nconst REQUIRED_WWW_AUTHENTICATE_KEYS = ['realm', 'nonce'];\nconst AUTHORIZED_WWW_AUTHENTICATE_KEYS = [\n    ...REQUIRED_WWW_AUTHENTICATE_KEYS,\n    'domain',\n    'opaque',\n    'stale',\n    'algorithm',\n    'qop',\n];\nconst CASE_INSENSITIVE_WWW_AUTHENTICATE_VALUES = ['stale'];\nconst REQUIRED_AUTHORIZATION_KEYS = [\n    'username',\n    'realm',\n    'nonce',\n    'uri',\n    'response',\n];\nconst AUTHORIZED_AUTHORIZATION_KEYS = [\n    ...REQUIRED_AUTHORIZATION_KEYS,\n    'algorithm',\n    'cnonce',\n    'opaque',\n    'qop',\n    'nc',\n];\n/* Architecture Note #1.3: Digest mechanism\n\nSee the following [RFC](https://tools.ietf.org/html/rfc2617).\n\n*/\n/**\n * Digest authentication mechanism.\n * @type {Object}\n * @see http://tools.ietf.org/html/rfc2617#section-3\n * @see http://tools.ietf.org/html/rfc2069#section-2\n */\nconst DIGEST = {\n    /**\n     * The Digest auth mechanism prefix.\n     * @type {String}\n     */\n    type: 'Digest',\n    /**\n     * Parse the WWW Authenticate header rest.\n     * @param  {String} rest The header rest (string after the authentication mechanism prefix).\n     * @return {Object}      Object representing the result of the parse operation.\n     * @example\n     * assert.deepEqual(\n     *   DIGEST.parseWWWAuthenticateRest(\n     *     'realm=\"testrealm@host.com\", ' +\n     *     'qop=\"auth, auth-int\", ' +\n     *     'nonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\", ' +\n     *     'opaque=\"5ccc069c403ebaf9f0171e9517f40e41\"'\n     *   ), {\n     *     realm: 'testrealm@host.com',\n     *     qop: 'auth, auth-int',\n     *     nonce: 'dcd98b7102dd2f0e8b11d0f600bfb0c093',\n     *     opaque: '5ccc069c403ebaf9f0171e9517f40e41'\n     *   }\n     * );\n     * @api public\n     */\n    parseWWWAuthenticateRest: function parseWWWAuthenticateRest(rest) {\n        return parseHTTPHeadersQuotedKeyValueSet(rest, AUTHORIZED_WWW_AUTHENTICATE_KEYS, REQUIRED_WWW_AUTHENTICATE_KEYS, CASE_INSENSITIVE_WWW_AUTHENTICATE_VALUES);\n    },\n    /**\n     * Build the WWW Authenticate header rest.\n     * @param  {Object} data The content from which to build the rest.\n     * @return {String}         The built rest.\n     * @example\n     * assert.equal(\n     *   DIGEST.buildWWWAuthenticateRest({\n     *     realm: 'testrealm@host.com',\n     *     qop: 'auth, auth-int',\n     *     nonce: 'dcd98b7102dd2f0e8b11d0f600bfb0c093',\n     *     opaque: '5ccc069c403ebaf9f0171e9517f40e41'\n     *   }),\n     *   'realm=\"testrealm@host.com\", ' +\n     *   'qop=\"auth, auth-int\", ' +\n     *   'nonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\", ' +\n     *   'opaque=\"5ccc069c403ebaf9f0171e9517f40e41\"'\n     * );\n     * @api public\n     */\n    buildWWWAuthenticateRest: function buildWWWAuthenticateRest(data) {\n        return buildHTTPHeadersQuotedKeyValueSet(data, AUTHORIZED_WWW_AUTHENTICATE_KEYS, REQUIRED_WWW_AUTHENTICATE_KEYS);\n    },\n    /**\n     * Parse the Authorization header rest.\n     * @param  {String} rest The header rest (string after the authentication mechanism prefix).)\n     * @return {Object}      Object representing the result of the parse operation {hash}.\n     * @example\n     * assert.deepEqual(\n     *   DIGEST.parseAuthorizationRest(\n     *     'username=\"Mufasa\",' +\n     *     'realm=\"testrealm@host.com\",' +\n     *     'nonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\",' +\n     *     'uri=\"/dir/index.html\",' +\n     *     'qop=\"auth\",' +\n     *     'nc=\"00000001\",' +\n     *     'cnonce=\"0a4f113b\",' +\n     *     'response=\"6629fae49393a05397450978507c4ef1\",' +\n     *     'opaque=\"5ccc069c403ebaf9f0171e9517f40e41\"'\n     *   ), {\n     *     username: \"Mufasa\",\n     *     realm: 'testrealm@host.com',\n     *     nonce: \"dcd98b7102dd2f0e8b11d0f600bfb0c093\",\n     *     uri: \"/dir/index.html\",\n     *     qop: 'auth',\n     *     nc: '00000001',\n     *     cnonce: \"0a4f113b\",\n     *     response: \"6629fae49393a05397450978507c4ef1\",\n     *     opaque: \"5ccc069c403ebaf9f0171e9517f40e41\"\n     *   }\n     * );\n     * @api public\n     */\n    parseAuthorizationRest: function parseAuthorizationRest(rest) {\n        return parseHTTPHeadersQuotedKeyValueSet(rest, AUTHORIZED_AUTHORIZATION_KEYS, REQUIRED_AUTHORIZATION_KEYS);\n    },\n    /**\n     * Build the Authorization header rest.\n     * @param  {Object} data The content from which to build the rest.\n     * @return {String}         The rest built.\n     * @example\n     * assert.equal(\n     *   DIGEST.buildAuthorizationRest({\n     *     username: \"Mufasa\",\n     *     realm: 'testrealm@host.com',\n     *     nonce: \"dcd98b7102dd2f0e8b11d0f600bfb0c093\",\n     *     uri: \"/dir/index.html\",\n     *     qop: 'auth',\n     *     nc: '00000001',\n     *     cnonce: \"0a4f113b\",\n     *     response: \"6629fae49393a05397450978507c4ef1\",\n     *     opaque: \"5ccc069c403ebaf9f0171e9517f40e41\"\n     *   }),\n     *   'username=\"Mufasa\", ' +\n     *   'realm=\"testrealm@host.com\", ' +\n     *   'nonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\", ' +\n     *   'uri=\"/dir/index.html\", ' +\n     *   'response=\"6629fae49393a05397450978507c4ef1\", ' +\n     *   'cnonce=\"0a4f113b\", ' +\n     *   'opaque=\"5ccc069c403ebaf9f0171e9517f40e41\", ' +\n     *   'qop=\"auth\", ' +\n     *   'nc=\"00000001\"'\n     * );\n     * @api public\n     */\n    buildAuthorizationRest: function buildAuthorizationRest(data) {\n        return buildHTTPHeadersQuotedKeyValueSet(data, AUTHORIZED_AUTHORIZATION_KEYS, REQUIRED_AUTHORIZATION_KEYS);\n    },\n    /**\n     * Compute the Digest authentication hash from the given credentials.\n     * @param  {Object} data The credentials to encode and other encoding details.\n     * @return {String}             The hash representing the credentials.\n     * @example\n     * assert.equal(\n     *   DIGEST.computeHash({\n     *     username: 'Mufasa',\n     *     realm: 'testrealm@host.com',\n     *     password: 'Circle Of Life',\n     *     method: 'GET',\n     *     uri: '/dir/index.html',\n     *     nonce: 'dcd98b7102dd2f0e8b11d0f600bfb0c093',\n     *     nc: '00000001',\n     *     cnonce: '0a4f113b',\n     *     qop: 'auth',\n     *     algorithm: 'md5'\n     *   }),\n     *   '6629fae49393a05397450978507c4ef1'\n     * );\n     * @api public\n     */\n    computeHash: function computeHash(data) {\n        const ha1 = data.ha1 ||\n            _computeHash(data.algorithm, [data.username, data.realm, data.password].join(':'));\n        const ha2 = _computeHash(data.algorithm, [data.method, data.uri].join(':'));\n        return _computeHash(data.algorithm, [ha1, data.nonce, data.nc, data.cnonce, data.qop, ha2].join(':'));\n    },\n};\nfunction _computeHash(algorithm, str) {\n    const hashsum = crypto.createHash(algorithm);\n    hashsum.update(str);\n    return hashsum.digest('hex');\n}\nexport default DIGEST;\n//# sourceMappingURL=digest.js.map","export class Deferred<T> {\n    finished = false;\n    resolve!: (value: T) => this;\n    reject!: (error: Error) => this;\n\n    [Symbol.dispose]() {\n        if (!this.finished)\n            this.reject(new Error('deferred disposed without being resolved'));\n    }\n\n    async resolvePromise(p: Promise<T>) {\n        try {\n            this.resolve(await p);\n        }\n        catch (e) {\n            this.reject(e as Error);\n        }\n    }\n    promise = new Promise<T>((resolve, reject) => {\n        this.resolve = v => {\n            this.finished = true;\n            resolve(v);\n            return this;\n        };\n        this.reject = e => {\n            this.finished = true;\n            reject(e);\n            return this;\n        };\n    });\n}\n","module.exports = require(\"child_process\");","import crypto, { randomBytes } from 'crypto';\nimport dgram from 'dgram';\nimport { once } from 'events';\nimport net from 'net';\nimport { Duplex, Readable, Writable } from 'stream';\nimport tls from 'tls';\nimport { URL } from 'url';\nimport { Deferred } from './deferred';\nimport { closeQuiet, createBindZero, createSquentialBindZero, listenZeroSingleClient } from './listen-cluster';\nimport { timeoutPromise } from './promise-utils';\nimport { readLength, readLine } from './read-stream';\nimport { MSection, parseSdp } from './sdp-utils';\nimport { sleep } from './sleep';\nimport { StreamChunk, StreamParser, StreamParserOptions } from './stream-parser';\n\nconst REQUIRED_WWW_AUTHENTICATE_KEYS = ['realm', 'nonce'];\n\ntype DigestWWWAuthenticateData = {\n    realm: string;\n    domain?: string;\n    nonce: string;\n    opaque?: string;\n    stale?: 'true' | 'false';\n    algorithm?: 'MD5' | 'MD5-sess' | 'token';\n    qop?: 'auth' | 'auth-int' | string;\n};\n\nexport const RTSP_FRAME_MAGIC = 36;\n\nexport interface Headers {\n    [header: string]: string\n}\n\nexport interface RtspStreamParser extends StreamParser {\n    sdp: Promise<string>;\n}\n\nexport async function readMessage(client: Readable): Promise<string[]> {\n    let currentHeaders: string[] = [];\n    while (true) {\n        let line = await readLine(client);\n        line = line.trim();\n        if (!line)\n            return currentHeaders;\n        currentHeaders.push(line);\n    }\n}\n\n\nexport async function readBody(client: Readable, response: Headers) {\n    const cl = parseInt(response['content-length']);\n    if (cl)\n        return readLength(client, cl)\n}\n\n\nexport function writeMessage(client: Writable, messageLine: string, body: Buffer, headers: Headers, console?: Console) {\n    let message = messageLine !== undefined ? `${messageLine}\\r\\n` : '';\n    if (body)\n        headers['Content-Length'] = body.length.toString();\n    for (const [key, value] of Object.entries(headers)) {\n        message += `${key}: ${value}\\r\\n`;\n    }\n    message += '\\r\\n';\n    client.write(message);\n    console?.log('rtsp outgoing message\\n', message);\n    console?.log();\n    if (body)\n        client.write(body);\n}\n\n// https://yumichan.net/video-processing/video-compression/introduction-to-h264-nal-unit/\n\nexport const H264_NAL_TYPE_RESERVED0 = 0;\nexport const H264_NAL_TYPE_RESERVED30 = 30;\nexport const H264_NAL_TYPE_RESERVED31 = 31;\n\nexport const H264_NAL_TYPE_IDR = 5;\nexport const H264_NAL_TYPE_SEI = 6;\nexport const H264_NAL_TYPE_SPS = 7;\nexport const H264_NAL_TYPE_PPS = 8;\n// aggregate NAL Unit\nexport const H264_NAL_TYPE_STAP_A = 24;\nexport const H264_NAL_TYPE_STAP_B = 25;\n// fragmented NAL Unit (need to match against first)\nexport const H264_NAL_TYPE_FU_A = 28;\nexport const H264_NAL_TYPE_FU_B = 29;\n\nexport const H264_NAL_TYPE_MTAP16 = 26;\nexport const H264_NAL_TYPE_MTAP32 = 27;\n\nexport const H265_NAL_TYPE_AGG = 48;\nexport const H265_NAL_TYPE_VPS = 32;\nexport const H265_NAL_TYPE_SPS = 33;\nexport const H265_NAL_TYPE_PPS = 34;\nexport const H265_NAL_TYPE_BLA_W_LP = 16;\nexport const H265_NAL_TYPE_BLA_W_RADL = 17;\nexport const H265_NAL_TYPE_BLA_N_LP = 18;\nexport const H265_NAL_TYPE_IDR_W_RADL = 19;\nexport const H265_NAL_TYPE_IDR_N_LP = 20;\nexport const H265_NAL_TYPE_CRA_NUT = 21;\nexport const H265_NAL_TYPE_FU = 49;\nexport const H265_NAL_TYPE_SEI_PREFIX = 39;\nexport const H265_NAL_TYPE_SEI_SUFFIX = 40;\n\nexport function findH264NaluType(streamChunk: StreamChunk, naluType: number) {\n    if (streamChunk.type !== 'h264')\n        return;\n    return findH264NaluTypeInNalu(streamChunk.chunks[streamChunk.chunks.length - 1].subarray(12), naluType);\n}\n\nexport function findH265NaluType(streamChunk: StreamChunk, naluType: number) {\n    if (streamChunk.type !== 'h265')\n        return;\n    return findH265NaluTypeInNalu(streamChunk.chunks[streamChunk.chunks.length - 1].subarray(12), naluType);\n}\n\nexport function parseH264NaluType(firstNaluByte: number) {\n    return firstNaluByte & 0x1f;\n}\n\nexport function findH264NaluTypeInNalu(nalu: Buffer, naluType: number) {\n    const checkNaluType = parseH264NaluType(nalu[0]);\n    if (checkNaluType === H264_NAL_TYPE_STAP_A) {\n        let pos = 1;\n        while (pos < nalu.length) {\n            const naluLength = nalu.readUInt16BE(pos);\n            pos += 2;\n            const stapaType = parseH264NaluType(nalu[pos]);\n            if (stapaType === naluType)\n                return nalu.subarray(pos, pos + naluLength);\n            pos += naluLength;\n        }\n    }\n    else if (checkNaluType === H264_NAL_TYPE_FU_A) {\n        const fuaType = parseH264NaluType(nalu[1]);\n        const isFuStart = !!(nalu[1] & 0x80);\n\n        if (fuaType === naluType && isFuStart)\n            return nalu.subarray(1);\n    }\n    else if (checkNaluType === naluType) {\n        return nalu;\n    }\n    return;\n}\n\nfunction parseH265NaluType(firstNaluByte: number) {\n    return (firstNaluByte & 0b01111110) >> 1;\n}\n\nexport function findH265NaluTypeInNalu(nalu: Buffer, naluType: number) {\n    const checkNaluType = parseH265NaluType(nalu[0]);\n    if (checkNaluType === H265_NAL_TYPE_AGG) {\n        let pos = 1;\n        while (pos < nalu.length) {\n            const naluLength = nalu.readUInt16BE(pos);\n            pos += 2;\n            const stapaType = parseH265NaluType(nalu[pos]);\n            if (stapaType === naluType)\n                return nalu.subarray(pos, pos + naluLength);\n            pos += naluLength;\n        }\n    }\n    else if (checkNaluType === naluType) {\n        return nalu;\n    }\n    return;\n}\n\nexport function getStartedH264NaluTypes(streamChunk: StreamChunk) {\n    if (streamChunk.type !== 'h264')\n        return new Set<number>();\n    return getNaluTypesInNalu(streamChunk.chunks[streamChunk.chunks.length - 1].subarray(12), true)\n}\n\nexport function getNaluTypesInNalu(nalu: Buffer, fuaRequireStart = false, fuaRequireEnd = false) {\n    const ret = new Set<number>();\n    const naluType = parseH264NaluType(nalu[0]);\n    if (naluType === H264_NAL_TYPE_STAP_A) {\n        ret.add(H264_NAL_TYPE_STAP_A);\n        let pos = 1;\n        while (pos < nalu.length) {\n            const naluLength = nalu.readUInt16BE(pos);\n            pos += 2;\n            const stapaType = parseH264NaluType(nalu[pos]);\n            ret.add(stapaType);\n            pos += naluLength;\n        }\n    }\n    else if (naluType === H264_NAL_TYPE_FU_A) {\n        ret.add(H264_NAL_TYPE_FU_A);\n        const fuaType = parseH264NaluType(nalu[1]);\n        if (fuaRequireStart) {\n            const isFuStart = !!(nalu[1] & 0x80);\n            if (isFuStart)\n                ret.add(fuaType);\n        }\n        else if (fuaRequireEnd) {\n            const isFuEnd = !!(nalu[1] & 0x40);\n            if (isFuEnd)\n                ret.add(fuaType);\n        }\n        else {\n            ret.add(fuaType);\n        }\n    }\n    else {\n        ret.add(naluType);\n    }\n\n    return ret;\n}\n\nexport function getStartedH265NaluTypes(streamChunk: StreamChunk) {\n    if (streamChunk.type !== 'h265')\n        return new Set<number>();\n    return getNaluTypesInH265Nalu(streamChunk.chunks[streamChunk.chunks.length - 1].subarray(12), true)\n}\n\nexport function getNaluTypesInH265Nalu(nalu: Buffer, fuaRequireStart = false, fuaRequireEnd = false) {\n    const ret = new Set<number>();\n    const naluType = parseH265NaluType(nalu[0]);\n    if (naluType === H265_NAL_TYPE_AGG) {\n        ret.add(H265_NAL_TYPE_AGG);\n        let pos = 2;\n        while (pos < nalu.length) {\n            const naluLength = nalu.readUInt16BE(pos);\n            pos += 2;\n            const stapaType = parseH265NaluType(nalu[pos]);\n            ret.add(stapaType);\n            pos += naluLength;\n        }\n    }\n    else if (naluType === H265_NAL_TYPE_FU) {\n        ret.add(H265_NAL_TYPE_FU);\n        const fuaType = nalu[2] & 0x3F;  // 6 bits\n        if (fuaRequireStart) {\n            const isFuStart = !!(nalu[2] & 0x80);\n            if (isFuStart)\n                ret.add(fuaType);\n        }\n        else if (fuaRequireEnd) {\n            const isFuEnd = !!(nalu[2] & 0x40);\n            if (isFuEnd)\n                ret.add(fuaType);\n        }\n        else {\n            ret.add(fuaType);\n        }\n    }\n    else {\n        ret.add(naluType);\n    }\n\n    return ret;\n}\n\nexport function isH265KeyFrameRelatedInSet(naluTypes: Set<number>, allowCodecInfo = true) {\n    if (naluTypes.has(H265_NAL_TYPE_IDR_N_LP)\n        || naluTypes.has(H265_NAL_TYPE_IDR_W_RADL)\n        || naluTypes.has(H265_NAL_TYPE_CRA_NUT)\n        || naluTypes.has(H265_NAL_TYPE_BLA_N_LP)\n        || naluTypes.has(H265_NAL_TYPE_BLA_W_LP)\n        || naluTypes.has(H265_NAL_TYPE_BLA_W_RADL)) {\n        return true;\n    }\n\n    if (allowCodecInfo) {\n        if (naluTypes.has(H265_NAL_TYPE_VPS)\n            || naluTypes.has(H265_NAL_TYPE_SPS)\n            || naluTypes.has(H265_NAL_TYPE_PPS))\n            return true;\n    }\n    return false;\n}\n\n\nexport function createRtspParser(options?: StreamParserOptions): RtspStreamParser {\n    let resolve: any;\n\n    return {\n        container: 'rtsp',\n        tcpProtocol: 'rtsp://127.0.0.1/' + randomBytes(8).toString('hex'),\n        inputArguments: [\n            '-rtsp_transport',\n            'tcp',\n        ],\n        outputArguments: [\n            '-rtsp_transport',\n            'tcp',\n            ...(options?.vcodec || []),\n            ...(options?.acodec || []),\n            // linux and windows seem to support 64000 but darwin is 32000?\n            '-pkt_size', '32000',\n            '-f', 'rtsp',\n        ],\n        findSyncFrame(streamChunks: StreamChunk[]) {\n            for (let prebufferIndex = 0; prebufferIndex < streamChunks.length; prebufferIndex++) {\n                const streamChunk = streamChunks[prebufferIndex];\n                if (streamChunk.type === 'h264') {\n                    const naluTypes = getStartedH264NaluTypes(streamChunk);\n                    if (naluTypes.has(H264_NAL_TYPE_SPS) || naluTypes.has(H264_NAL_TYPE_IDR)) {\n                        return streamChunks.slice(prebufferIndex);\n                    }\n                }\n                else if (streamChunk.type === 'h265') {\n                    const naluTypes = getStartedH265NaluTypes(streamChunk);\n\n                    if (isH265KeyFrameRelatedInSet(naluTypes)) {\n                        return streamChunks.slice(prebufferIndex);\n                    }\n                }\n            }\n\n            // oh well!\n        },\n        sdp: new Promise<string>(r => resolve = r),\n        async *parse(duplex, width, height) {\n            const server = new RtspServer(duplex);\n            await server.handleSetup();\n            resolve(server.sdp);\n            for await (const { type, rtcp, header, packet } of server.handleRecord()) {\n                yield {\n                    chunks: [header, packet],\n                    type: `${rtcp ? 'rtcp-' : ''}${type}`,\n                    width,\n                    height,\n                }\n            }\n        }\n    }\n}\n\nexport function parseHeaders(headers: string[]): Headers {\n    const ret: any = {};\n    for (const header of headers.slice(1)) {\n        const index = header.indexOf(':');\n        let value = '';\n        if (index !== -1)\n            value = header.substring(index + 1).trim();\n        const key = header.substring(0, index).toLowerCase();\n        ret[key] = value;\n    }\n    return ret;\n}\n\nexport function getFirstAuthenticateHeader(headers: string[]): string {\n    for (const header of headers.slice(1)) {\n        const index = header.indexOf(':');\n        let value = '';\n        if (index !== -1)\n            value = header.substring(index + 1).trim();\n        const key = header.substring(0, index).toLowerCase();\n        if (key === 'www-authenticate')\n            return value;\n    }\n}\n\nexport function parseSemicolonDelimited(value: string) {\n    const dict: { [key: string]: string } = {};\n    for (const part of value.split(';')) {\n        const [key, value] = part.split('=', 2);\n        dict[key] = value;\n    }\n\n    return dict;\n}\n\nexport interface RtspStatus {\n    line: string,\n    code: number,\n    version: string,\n    reason: string,\n}\n\nexport interface RtspServerResponse {\n    headers: Headers;\n    body: Buffer;\n    status: RtspStatus;\n}\n\nexport class RtspStatusError extends Error {\n    constructor(public status: RtspStatus) {\n        super(`RTSP Error: ${status.line}`);\n    }\n}\n\nexport class RtspBase {\n    client: net.Socket;\n    console?: Console;\n\n    constructor() {\n    }\n\n    write(messageLine: string, headers: Headers, body?: Buffer) {\n        writeMessage(this.client, messageLine, body, headers, this.console);\n    }\n\n    async readMessage(): Promise<string[]> {\n        const message = await readMessage(this.client);\n        this.console?.log('rtsp incoming message\\n', message.join('\\n'));\n        this.console?.log();\n        return message;\n    }\n}\n\nconst quote = (str: string): string => `\"${str.replace(/\"/g, '\\\\\"')}\"`;\n\nexport interface RtspClientSetupOptions {\n    type: 'tcp' | 'udp';\n    path?: string;\n    onRtp: (rtspHeader: Buffer, rtp: Buffer) => void;\n}\n\nexport interface RtspClientTcpSetupOptions extends RtspClientSetupOptions {\n    type: 'tcp';\n    port: number;\n}\n\nexport interface RtspClientUdpSetupOptions extends RtspClientSetupOptions {\n    type: 'udp';\n    dgram?: dgram.Socket;\n}\n\n// probably only works with scrypted rtsp server.\nexport class RtspClient extends RtspBase {\n    cseq = 0;\n    session: string;\n    wwwAuthenticate: string;\n    requestTimeout: number;\n    needKeepAlive = false;\n    setupOptions = new Map<number, RtspClientTcpSetupOptions>();\n    issuedTeardown = false;\n    hasGetParameter = true;\n    contentBase: string;\n\n    constructor(public readonly url: string) {\n        super();\n        const u = new URL(url);\n        const port = parseInt(u.port) || 554;\n        if (url.startsWith('rtsps')) {\n            this.client = tls.connect({\n                rejectUnauthorized: false,\n                port,\n                host: u.hostname,\n            })\n        }\n        else {\n            this.client = net.connect(port, u.hostname);\n        }\n        this.client.on('error', e => {\n            this.console?.log('client error', e);\n        });\n    }\n\n    async safeTeardown() {\n        // issue a teardown to upstream to close gracefully\n        if (this.issuedTeardown)\n            return;\n        this.issuedTeardown = true;\n        try {\n            this.writeTeardown();\n            await sleep(500);\n        }\n        catch (e) {\n        }\n        finally {\n            // will trigger after teardown returns\n            this.client.destroy();\n        }\n    }\n\n    async writeRequest(method: string, headers?: Headers, path?: string, body?: Buffer) {\n        headers = headers || {};\n\n        let fullUrl: string;\n        if (!path) {\n            fullUrl = this.url;\n        }\n        else {\n            // a=control may be a full or \"relative\" url.\n            if (path.includes('rtsp://') || path.includes('rtsps://') || path === '*') {\n                fullUrl = path;\n            }\n            else {\n                fullUrl = this.contentBase || this.url;\n\n                // strangely, relative RTSP urls do not behave like expected from an HTTP-ish server.\n                // ffmpeg will happily suffix path segments after query strings:\n                // SETUP rtsp://localhost:5554/cam/realmonitor?channel=1&subtype=0/trackID=0 RTSP/1.0\n                fullUrl += (fullUrl.endsWith('/') ? '' : '/') + path;\n            }\n        }\n\n        const sanitized = new URL(fullUrl);\n        sanitized.username = '';\n        sanitized.password = '';\n\n        const line = `${method} ${sanitized} RTSP/1.0`;\n        const cseq = this.cseq++;\n        headers['CSeq'] = cseq.toString();\n        headers['User-Agent'] = 'Scrypted';\n\n        if (this.wwwAuthenticate)\n            headers['Authorization'] = await this.createAuthorizationHeader(method, new URL(fullUrl));\n\n        if (this.session)\n            headers['Session'] = this.session;\n\n        this.write(line, headers, body);\n    }\n\n    async handleDataPayload(header: Buffer) {\n        // todo: fix this, because calling teardown outside of the read loop causes this.\n        if (header[0] !== RTSP_FRAME_MAGIC)\n            throw new Error('RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): ' + header.toString());\n\n        const channel = header.readUInt8(1);\n        const length = header.readUInt16BE(2);\n        const data = await readLength(this.client, length);\n\n        const options = this.setupOptions.get(channel);\n        options?.onRtp?.(header, data);\n    }\n\n    async readDataPayload() {\n        const header = await readLength(this.client, 4);\n        return this.handleDataPayload(header);\n    }\n\n    createBadHeader(header: Buffer) {\n        return new Error('RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): ' + header.toString());\n    }\n\n    async readLoopLegacy() {\n        try {\n            while (true) {\n                if (this.needKeepAlive) {\n                    this.needKeepAlive = false;\n                    if (this.hasGetParameter)\n                        await this.getParameter();\n                    else\n                        await this.options();\n                }\n                await this.readDataPayload();\n            }\n        }\n        catch (e) {\n            this.client.destroy(e as Error);\n            throw e;\n        }\n    }\n\n    async *handleStream(): AsyncGenerator<{\n        rtcp: boolean,\n        header: Buffer,\n        packet: Buffer,\n        channel: number,\n    }> {\n        while (true) {\n            const header = await readLength(this.client, 4);\n            // can this even happen? since the RTSP request method isn't a fixed\n            // value like the \"RTSP\" in the RTSP response, I don't think so?\n            if (header[0] !== RTSP_FRAME_MAGIC) {\n                if (header.toString() !== 'RTSP')\n                    throw this.createBadHeader(header);\n\n                this.client.unshift(header);\n\n                // do what with this?\n                const message = await super.readMessage();\n                const body = await this.readBody(parseHeaders(message));\n\n                continue;\n            }\n\n            const length = header.readUInt16BE(2);\n            const packet = await readLength(this.client, length);\n            const id = header.readUInt8(1);\n\n            yield {\n                channel: id,\n                rtcp: id % 2 === 1,\n                header,\n                packet,\n            }\n        }\n    }\n\n    async readLoop() {\n        const deferred = new Deferred<void>();\n\n        let header: Buffer;\n        let channel: number;\n        let length: number;\n\n        const read = async () => {\n            if (this.needKeepAlive) {\n                this.needKeepAlive = false;\n                if (this.hasGetParameter)\n                    this.writeGetParameter();\n                else\n                    this.writeOptions();\n            }\n\n            try {\n                while (true) {\n                    // get header if needed\n                    if (!header) {\n                        header = this.client.read(4);\n\n                        if (!header)\n                            return;\n\n                        // validate header once.\n                        if (header[0] !== RTSP_FRAME_MAGIC) {\n                            if (header.toString() !== 'RTSP')\n                                throw this.createBadHeader(header);\n\n                            this.client.unshift(header);\n                            header = undefined;\n\n                            // remove the listener to operate in pull mode.\n                            this.client.removeListener('readable', read);\n\n                            // do what with this?\n                            const message = await super.readMessage();\n                            const body = await this.readBody(parseHeaders(message));\n\n                            // readd the listener to operate in streaming mode.\n                            this.client.on('readable', read);\n\n                            continue;\n                        }\n\n                        channel = header.readUInt8(1);\n                        length = header.readUInt16BE(2);\n                    }\n\n                    const data = this.client.read(length);\n                    if (!data)\n                        return;\n\n                    const h = header;\n                    header = undefined;\n                    const options = this.setupOptions.get(channel);\n                    options?.onRtp?.(h, data);\n                }\n            }\n            catch (e) {\n                if (!deferred.finished)\n                    deferred.reject(e as Error);\n                this.client.destroy();\n            }\n        };\n\n        read();\n        this.client.on('readable', read);\n\n        await Promise.all([once(this.client, 'end')]);\n    }\n\n    // rtsp over tcp will actually interleave RTSP request/responses\n    // within the RTSP data stream. The only way to tell if it's a request/response\n    // is to see if the header + data starts with RTSP/1.0 message line.\n    // Or RTSP, if looking at only the header bytes. Then grab the response out.\n    async readMessage(): Promise<string[]> {\n        while (true) {\n            const header = await readLength(this.client, 4);\n            if (header[0] !== RTSP_FRAME_MAGIC) {\n                if (header.toString() === 'RTSP') {\n                    this.client.unshift(header);\n                    const message = await super.readMessage();\n                    return message;\n                }\n                throw this.createBadHeader(header);\n            }\n\n            await this.handleDataPayload(header);\n        }\n    }\n\n    async createAuthorizationHeader(method: string, url: URL) {\n        if (!this.wwwAuthenticate)\n            throw new Error('no WWW-Authenticate found');\n\n        const { BASIC } = await import('http-auth-utils');\n        // @ts-ignore\n        const { parseHTTPHeadersQuotedKeyValueSet } = await import('http-auth-utils/dist/utils');\n\n        const authedUrl = new URL(this.url);\n        const username = decodeURIComponent(authedUrl.username);\n        const password = decodeURIComponent(authedUrl.password);\n\n        if (this.wwwAuthenticate.includes('Basic')) {\n            const hash = BASIC.computeHash({ username, password });\n            return `Basic ${hash}`;\n        }\n\n        // hikvision sends out of spec 'random' name and value parameter,\n        // which causes the digest auth lib to fail. so, need to parse the header\n        // manually with a relax set of authorized parameters.\n        // https://github.com/koush/scrypted/issues/344#issuecomment-1223627956\n        // https://github.com/nfroidure/http-auth-utils/blob/7532d21a419ad098d1240c9e1b55855020df5d7f/src/mechanisms/digest.ts#L97\n        // const wwwAuth = DIGEST.parseWWWAuthenticateRest(this.wwwAuthenticate);\n        const wwwAuth = parseHTTPHeadersQuotedKeyValueSet(\n            this.wwwAuthenticate,\n            // the parser will call indexOf to see if the key is authorized. monkey patch this call.\n            // https://github.com/nfroidure/http-auth-utils/blob/17186d3eefb86535916d044c7f59a340bc765603/src/utils.ts#L43\n            {\n                indexOf: () => 0,\n            } as any,\n            REQUIRED_WWW_AUTHENTICATE_KEYS,\n        ) as DigestWWWAuthenticateData;\n\n        const strippedUrl = new URL(url.toString());\n        strippedUrl.username = '';\n        strippedUrl.password = '';\n\n        const ha1 = crypto.createHash('md5').update(`${username}:${wwwAuth.realm}:${password}`).digest('hex');\n        const ha2 = crypto.createHash('md5').update(`${method}:${strippedUrl}`).digest('hex');\n        const hash = crypto.createHash('md5').update(`${ha1}:${wwwAuth.nonce}:${ha2}`).digest('hex');\n\n        const params = {\n            username,\n            realm: wwwAuth.realm,\n            nonce: wwwAuth.nonce,\n            uri: strippedUrl.toString(),\n            algorithm: 'MD5',\n            response: hash,\n        };\n\n        const paramsString = Object.entries(params).map(([key, value]) => `${key}=${value && quote(value)}`).join(', ');\n        return `Digest ${paramsString}`;\n    }\n\n    async readBody(response: Headers) {\n        return readBody(this.client, response);\n    }\n\n    async request(method: string, headers?: Headers, path?: string, body?: Buffer, authenticating?: boolean): Promise<RtspServerResponse> {\n        await this.writeRequest(method, headers, path, body);\n\n        const message = this.requestTimeout ? await timeoutPromise(this.requestTimeout, this.readMessage()) : await this.readMessage();\n        const statusLine = message[0];\n        const [version, codeString, reason] = statusLine.split(' ', 3);\n        const code = parseInt(codeString);\n        const response = parseHeaders(message);\n\n        const status = {\n            line: statusLine,\n            code,\n            version,\n            reason,\n        };\n\n        if (code !== 200 && !response['www-authenticate'])\n            throw new RtspStatusError(status);\n\n        // it seems that the first www-authenticate header should be used, as latter ones that are\n        // offered are not actually valid? weird issue seen on tp-link that offers both DIGEST and BASIC.\n        const wwwAuthenticate = getFirstAuthenticateHeader(message) || response['www-authenticate']\n        if (wwwAuthenticate) {\n            if (authenticating)\n                throw new Error('auth failed');\n\n            this.wwwAuthenticate = wwwAuthenticate;\n\n            return this.request(method, headers, path, body, true);\n        }\n        return {\n            headers: response,\n            body: await this.readBody(response),\n            status,\n        }\n    }\n\n    async options() {\n        const headers: Headers = {};\n        const ret = await this.request('OPTIONS', headers);\n        const publicHeader = ret.headers['public'];\n        if (publicHeader)\n            this.hasGetParameter = publicHeader.toLowerCase().includes('get_parameter');\n        return ret;\n    }\n\n    writeOptions() {\n        return this.writeRequest('OPTIONS');\n    }\n\n    async getParameter() {\n        return this.request('GET_PARAMETER');\n    }\n\n    writeGetParameter() {\n        return this.writeRequest('GET_PARAMETER');\n    }\n\n    async describe(headers?: Headers) {\n        const response = await this.request('DESCRIBE', {\n            ...(headers || {}),\n            Accept: 'application/sdp',\n        });\n\n        this.contentBase = response.headers['content-base'] || response.headers['content-location'];\n        // content base may be a relative path? seems odd.\n        if (this.contentBase)\n            this.contentBase = new URL(this.contentBase, this.url).toString();\n        return response;\n    }\n\n    async setup(options: RtspClientTcpSetupOptions | RtspClientUdpSetupOptions, headers?: Headers) {\n        const protocol = options.type === 'udp' ? '' : '/TCP';\n        const client = options.type === 'udp' ? 'client_port' : 'interleaved';\n        let port: number;\n        if (options.type === 'tcp') {\n            port = options.port;\n        }\n        else {\n            if (!options.dgram) {\n                const udp = await createBindZero();\n                options.dgram = udp.server;\n                this.client.on('close', () => closeQuiet(udp.server));\n            }\n            port = options.dgram.address().port;\n            options.dgram.on('message', data => options.onRtp(undefined, data));\n        }\n        headers = Object.assign({\n            Transport: `RTP/AVP${protocol};unicast;${client}=${port}-${port + 1}`,\n        }, headers);\n        const response = await this.request('SETUP', headers, options.path);\n        let interleaved: {\n            begin: number;\n            end: number;\n        };\n        if (response.headers.session) {\n            const sessionDict = parseSemicolonDelimited(response.headers.session);\n            let timeout = parseInt(sessionDict['timeout']);\n            if (timeout) {\n                // if a timeout is requested, need to keep the session alive with periodic refresh.\n                // one suggestion is calling OPTIONS, but apparently GET_PARAMETER is more reliable.\n                // https://stackoverflow.com/a/39818378\n                let interval = (timeout - 5) * 1000;\n                let timer = setInterval(() => this.needKeepAlive = true, interval);\n                this.client.once('close', () => clearInterval(timer));\n            }\n\n            this.session = response.headers.session.split(';')[0];\n        }\n        if (response.headers.transport) {\n            const match = response.headers.transport.match(/.*?interleaved=([0-9]+)-([0-9]+)/);\n            if (match) {\n                const [_, begin, end] = match;\n                if (begin && end) {\n                    interleaved = {\n                        begin: parseInt(begin),\n                        end: parseInt(end),\n                    };\n                }\n            }\n        }\n        if (options.type === 'tcp')\n            this.setupOptions.set(interleaved ? interleaved.begin : port, options);\n        return Object.assign({ interleaved, options }, response);\n    }\n\n    async play(headers: Headers = {}, start = '0.000') {\n        headers['Range'] = `npt=${start}-`;\n        return this.request('PLAY', headers);\n    }\n\n    writePlay(start: string = '0.000') {\n        const headers: any = {\n            Range: `npt=${start}-`,\n        };\n        return this.writeRequest('PLAY', headers);\n    }\n\n    writeRtpPayload(header: Buffer, rtp: Buffer) {\n        this.client.write(header);\n        return this.client.write(Buffer.from(rtp));\n    }\n\n    send(rtp: Buffer, channel: number) {\n        const header = Buffer.alloc(4);\n        header.writeUInt8(RTSP_FRAME_MAGIC, 0);\n        header.writeUInt8(channel, 1);\n        header.writeUInt16BE(rtp.length, 2);\n\n        return this.writeRtpPayload(header, rtp);\n    }\n\n    async pause() {\n        return this.request('PAUSE');\n    }\n\n    async teardown() {\n        try {\n            // todo: fix this, because calling teardown outside of the read loop causes this.\n            return await this.request('TEARDOWN');\n        }\n        finally {\n            this.client.destroy();\n        }\n    }\n\n    writeTeardown() {\n        this.writeRequest('TEARDOWN');\n    }\n}\n\nexport interface RtspTrack {\n    protocol: 'tcp' | 'udp';\n    destination: number;\n    codec: string;\n    control: string;\n    rtp?: dgram.Socket;\n    rtcp?: dgram.Socket;\n}\n\nexport class RtspServer {\n    session: string;\n    console: Console;\n    setupTracks: {\n        [trackId: string]: RtspTrack;\n    } = {};\n\n    constructor(public client: Duplex, public sdp?: string, public udp?: boolean, public checkRequest?: (method: string, url: string, headers: Headers, rawMessage: string[]) => Promise<boolean>) {\n        this.session = randomBytes(4).toString('hex');\n        if (sdp)\n            sdp = sdp.trim();\n\n        if (client instanceof net.Socket)\n            client.setNoDelay(true);\n    }\n\n    async handleSetup(methods = ['play', 'record', 'teardown']) {\n        let currentHeaders: string[] = [];\n        while (true) {\n            let line = await readLine(this.client);\n            line = line.trim();\n            if (!line) {\n                const method = await this.headers(currentHeaders);\n                if (methods.includes(method))\n                    return method;\n                currentHeaders = [];\n                continue;\n            }\n            currentHeaders.push(line);\n        }\n    }\n\n    async handlePlayback() {\n        return this.handleSetup();\n    }\n\n    async handleTeardown() {\n        return this.handleSetup();\n    }\n\n    async *handleRecord(): AsyncGenerator<{\n        type: string,\n        rtcp: boolean,\n        header: Buffer,\n        packet: Buffer,\n    }> {\n        while (true) {\n            const header = await readLength(this.client, 4);\n            // can this even happen? since the RTSP request method isn't a fixed\n            // value like the \"RTSP\" in the RTSP response, I don't think so?\n            if (header[0] !== RTSP_FRAME_MAGIC)\n                throw new Error('RTSP Server expected frame magic but received: ' + header.toString());\n            const length = header.readUInt16BE(2);\n            const packet = await readLength(this.client, length);\n            const id = header.readUInt8(1);\n            const destination = id - (id % 2);\n            const track = Object.values(this.setupTracks).find(track => track.destination === destination);\n            if (!track)\n                throw new Error('RSTP Server received unknown channel: ' + id);\n\n            yield {\n                type: track.codec,\n                rtcp: id % 2 === 1,\n                header,\n                packet,\n            }\n        }\n    }\n\n    writeRtpPayload(header: Buffer, rtp: Buffer) {\n        this.client.write(header);\n        return this.client.write(Buffer.from(rtp));\n    }\n\n    send(rtp: Buffer, channel: number) {\n        const header = Buffer.alloc(4);\n        header.writeUInt8(36, 0);\n        header.writeUInt8(channel, 1);\n        header.writeUInt16BE(rtp.length, 2);\n\n        return this.writeRtpPayload(header, rtp);\n    }\n\n    sendUdp(udp: dgram.Socket, port: number, packet: Buffer) {\n        // todo: support non local host?\n        udp.send(packet, port, '127.0.0.1');\n    }\n\n    sendTrack(trackId: string, packet: Buffer, rtcp: boolean) {\n        const track = this.setupTracks[trackId];\n        if (!track) {\n            this.console?.warn('RTSP Server track not found:', trackId);\n            return true;\n        }\n\n        if (track.protocol === 'udp') {\n            if (!this.udp)\n                this.console?.warn('RTSP Server UDP socket not available.');\n            else\n                this.sendUdp(rtcp ? track.rtcp : track.rtp, track.destination, packet);\n            return true;\n        }\n\n        return this.send(packet, rtcp ? track.destination + 1 : track.destination);\n    }\n\n    availableOptions = ['DESCRIBE', 'OPTIONS', 'PAUSE', 'PLAY', 'SETUP', 'TEARDOWN', 'ANNOUNCE', 'RECORD', 'GET_PARAMETER'];\n    options(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        headers['Public'] = this.availableOptions.join(', ');\n\n        this.respond(200, 'OK', requestHeaders, headers);\n    }\n\n    async get_parameter(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        this.respond(200, 'OK', requestHeaders, headers);\n    }\n\n    describe(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        headers['Content-Base'] = url;\n        headers['Content-Type'] = 'application/sdp';\n        this.respond(200, 'OK', requestHeaders, headers, Buffer.from(this.sdp))\n    }\n\n    setupInterleaved(msection: MSection, low: number, high: number) {\n        this.setupTracks[msection.control] = {\n            control: msection.control,\n            protocol: 'tcp',\n            destination: low,\n            codec: msection.codec,\n        }\n    }\n\n\n    resolveInterleaved?: (msection: MSection) => [number, number];\n\n    // todo: use the sdp itself to determine the audio/video track ids so\n    // rewriting is not necessary.\n    async setup(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        let transport = requestHeaders['transport'];\n        headers['Session'] = this.session;\n        const parsedSdp = parseSdp(this.sdp);\n        const msection = parsedSdp.msections.find(msection => url.endsWith(msection.control));\n        if (!msection) {\n            this.respond(404, 'Not Found', requestHeaders, headers);\n            return;\n        }\n\n        if (transport.includes('TCP')) {\n            if (this.resolveInterleaved) {\n                const [low, high] = this.resolveInterleaved(msection);\n                this.setupInterleaved(msection, low, high);\n                transport = `RTP/AVP/TCP;unicast;interleaved=${low}-${high}`;\n            }\n            else {\n                const match = transport.match(/.*?interleaved=([0-9]+)-([0-9]+)/);\n                if (match) {\n                    const low = parseInt(match[1]);\n                    const high = parseInt(match[2]);\n                    this.setupInterleaved(msection, low, high);\n                }\n            }\n        }\n        else {\n            if (!this.udp) {\n                this.respond(461, 'Unsupported Transport', requestHeaders, {});\n                return;\n            }\n            const match = transport.match(/.*?client_port=([0-9]+)-([0-9]+)/);\n            const [_, rtp, rtcp] = match;\n\n            const [rtpServer, rtcpServer] = await createSquentialBindZero();\n            this.client.on('close', () => closeQuiet(rtpServer.server));\n            this.client.on('close', () => closeQuiet(rtcpServer.server));\n            this.setupTracks[msection.control] = {\n                control: msection.control,\n                protocol: 'udp',\n                destination: parseInt(rtp),\n                codec: msection.codec,\n                rtp: rtpServer.server,\n                rtcp: rtcpServer.server,\n            }\n            transport = transport.replace('RTP/AVP/UDP', 'RTP/AVP').replace('RTP/AVP', 'RTP/AVP/UDP');\n            transport += `;server_port=${rtpServer.port}-${rtcpServer.port}`;\n        }\n        headers['Transport'] = transport;\n        this.respond(200, 'OK', requestHeaders, headers)\n    }\n\n    play(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        const rtpInfos = Object.values(this.setupTracks).map(track => `url=${url}/${track.control}`);\n        // seq/rtptime was causing issues with gstreamer. commented out.\n        const rtpInfo = rtpInfos.join(','); // + ';seq=0;rtptime=0';\n        headers['RTP-Info'] = rtpInfo;\n        headers['Range'] = 'npt=now-';\n        headers['Session'] = this.session;\n        this.respond(200, 'OK', requestHeaders, headers);\n    }\n\n    async announce(url: string, requestHeaders: Headers) {\n        const contentLength = parseInt(requestHeaders['content-length']);\n        const sdpBuffer = await readLength(this.client, contentLength);\n        this.sdp = sdpBuffer.toString();\n        const headers: Headers = {};\n        headers['Session'] = this.session;\n\n        this.respond(200, 'OK', requestHeaders, headers);\n    }\n\n    async record(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        headers['Session'] = this.session;\n        this.respond(200, 'OK', requestHeaders, headers);\n    }\n\n    async teardown(url: string, requestHeaders: Headers) {\n        const headers: Headers = {};\n        headers['Session'] = this.session;\n        this.respond(200, 'OK', requestHeaders, headers);\n        this.client.destroy();\n    }\n\n    async headers(headers: string[]) {\n        this.console?.log('request headers', headers.join('\\n'));\n\n        let [method, url] = headers[0].split(' ', 2);\n        method = method.toLowerCase();\n        const requestHeaders = parseHeaders(headers);\n        if (this.checkRequest) {\n            let allow: boolean;\n            try {\n                allow = await this.checkRequest(method, url, requestHeaders, headers)\n            }\n            catch (e) {\n                this.console?.error('error checking request', e);\n            }\n            if (!allow) {\n                this.respond(400, 'Bad Request', requestHeaders, {});\n                this.client.destroy();\n                throw new Error('check request failed');\n            }\n        }\n\n        const thisAny = this as any;\n        if (!thisAny[method] || !this.availableOptions.includes(method.toUpperCase())) {\n            this.respond(400, 'Bad Request', requestHeaders, {});\n            return;\n        }\n\n        await thisAny[method](url, requestHeaders);\n        return method;\n    }\n\n    respond(code: number, message: string, requestHeaders: Headers, headers: Headers, buffer?: Buffer) {\n        let response = `RTSP/1.0 ${code} ${message}\\r\\n`;\n        if (requestHeaders['cseq'])\n            headers['CSeq'] = requestHeaders['cseq'];\n        if (buffer)\n            headers['Content-Length'] = buffer.length.toString();\n        for (const [key, value] of Object.entries(headers)) {\n            response += `${key}: ${value}\\r\\n`;\n        }\n        this.console?.log('response headers', response);\n        response += '\\r\\n';\n        this.client.write(response);\n        if (buffer) {\n            this.client.write(buffer);\n            this.console?.log('response body', buffer.toString());\n        }\n    }\n\n    destroy() {\n        this.client.destroy();\n        for (const track of Object.values(this.setupTracks)) {\n            closeQuiet(track.rtp);\n            closeQuiet(track.rtcp);\n        }\n    }\n}\n\nexport async function listenSingleRtspClient<T extends RtspServer>(options?: {\n    hostname: string,\n    pathToken?: string,\n    createServer?(duplex: Duplex): T,\n}) {\n    const pathToken = options?.pathToken || crypto.randomBytes(8).toString('hex');\n    let { url, clientPromise, server } = await listenZeroSingleClient(options?.hostname);\n\n    const rtspServerPath = '/' + pathToken;\n    url = url.replace('tcp:', 'rtsp:') + rtspServerPath;\n\n    const rtspServerPromise = clientPromise.then(client => {\n        const createServer = options?.createServer || (duplex => new RtspServer(duplex));\n\n        const rtspServer = createServer(client);\n        rtspServer.checkRequest = async (method, url, headers, message) => {\n            rtspServer.checkRequest = undefined;\n            const u = new URL(url);\n            return u.pathname === rtspServerPath;\n        };\n        return rtspServer as T;\n    });\n\n    return {\n        url,\n        rtspServerPromise,\n        server,\n    }\n}\n","module.exports = require(\"module\");","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst bitstream_1 = require(\"./bitstream\");\r\nexports.Bitstream = bitstream_1.Bitstream;\r\nconst vui_1 = require(\"./vui\");\r\nfunction scaling_list(stream, sizeOfScalingList, use_default, i) {\r\n    let lastScale = 8;\r\n    let nextScale = 8;\r\n    const scalingList = [];\r\n    for (let j = 0; j < sizeOfScalingList; j++) {\r\n        if (nextScale !== 0) {\r\n            const deltaScale = stream.SignedExpGolomb();\r\n            nextScale = (lastScale + deltaScale + 256) % 256;\r\n            use_default[i] = +(j === 0 && nextScale === 0);\r\n        }\r\n        if (nextScale) {\r\n            lastScale = nextScale;\r\n        }\r\n        scalingList[j] = lastScale;\r\n    }\r\n    return scalingList;\r\n}\r\nfunction getFrameCropping(flag, stream) {\r\n    if (!flag)\r\n        return { left: 0, right: 0, top: 0, bottom: 0 };\r\n    const left = stream.ExpGolomb();\r\n    const right = stream.ExpGolomb();\r\n    const top = stream.ExpGolomb();\r\n    const bottom = stream.ExpGolomb();\r\n    return { left, right, top, bottom };\r\n}\r\nfunction parse(nalu) {\r\n    if ((nalu[0] & 0x1F) !== 7)\r\n        throw new Error(\"Not an SPS unit\");\r\n    const stream = new bitstream_1.Bitstream(new DataView(nalu.buffer, nalu.byteOffset + 4));\r\n    const profile_idc = nalu[1];\r\n    const profile_compatibility = nalu[2];\r\n    const level_idc = nalu[3];\r\n    const sps_id = stream.ExpGolomb();\r\n    let chroma_format_idc = 1;\r\n    let bit_depth_luma = 0;\r\n    let bit_depth_chroma = 0;\r\n    let color_plane_flag = 0;\r\n    let qpprime_y_zero_transform_bypass_flag = 0;\r\n    let seq_scaling_matrix_present_flag = 0;\r\n    const scaling_list_4x4 = [];\r\n    const scaling_list_8x8 = [];\r\n    const use_default_scaling_matrix_4x4_flag = [];\r\n    const use_default_scaling_matrix_8x8_flag = [];\r\n    if (profile_idc === 100 || profile_idc === 110 ||\r\n        profile_idc === 122 || profile_idc === 244 || profile_idc === 44 ||\r\n        profile_idc === 83 || profile_idc === 86 || profile_idc === 118 ||\r\n        profile_idc === 128 || profile_idc === 138 || profile_idc === 139 ||\r\n        profile_idc === 134 || profile_idc === 135) {\r\n        chroma_format_idc = stream.ExpGolomb();\r\n        let limit = 8;\r\n        if (chroma_format_idc === 3) {\r\n            limit = 12;\r\n            color_plane_flag = stream.readBit();\r\n        }\r\n        bit_depth_luma = stream.ExpGolomb() + 8;\r\n        bit_depth_chroma = stream.ExpGolomb() + 8;\r\n        qpprime_y_zero_transform_bypass_flag = stream.readBit();\r\n        seq_scaling_matrix_present_flag = stream.readBit();\r\n        if (seq_scaling_matrix_present_flag) {\r\n            let i = 0;\r\n            for (; i < 6; i++) {\r\n                if (stream.readBit()) { //seq_scaling_list_present_flag\r\n                    scaling_list_4x4.push(scaling_list(stream, 16, use_default_scaling_matrix_4x4_flag, i));\r\n                }\r\n            }\r\n            for (; i < limit; i++) {\r\n                if (stream.readBit()) { //seq_scaling_list_present_flag\r\n                    scaling_list_8x8.push(scaling_list(stream, 64, use_default_scaling_matrix_8x8_flag, i - 6));\r\n                }\r\n            }\r\n        }\r\n    }\r\n    const log2_max_frame_num = stream.ExpGolomb() + 4;\r\n    const pic_order_cnt_type = stream.ExpGolomb();\r\n    let delta_pic_order_always_zero_flag = 0;\r\n    let offset_for_non_ref_pic = 0;\r\n    let offset_for_top_to_bottom_field = 0;\r\n    const offset_for_ref_frame = [];\r\n    let log2_max_pic_order_cnt_lsb = 0;\r\n    if (pic_order_cnt_type === 0) {\r\n        log2_max_pic_order_cnt_lsb = stream.ExpGolomb() + 4;\r\n    }\r\n    else if (pic_order_cnt_type === 1) {\r\n        delta_pic_order_always_zero_flag = stream.readBit();\r\n        offset_for_non_ref_pic = stream.SignedExpGolomb();\r\n        offset_for_top_to_bottom_field = stream.SignedExpGolomb();\r\n        const num_ref_frames_in_pic_order_cnt_cycle = stream.ExpGolomb();\r\n        for (let i = 0; i < num_ref_frames_in_pic_order_cnt_cycle; i++) {\r\n            offset_for_ref_frame.push(stream.SignedExpGolomb());\r\n        }\r\n    }\r\n    const max_num_ref_frames = stream.ExpGolomb();\r\n    const gaps_in_frame_num_value_allowed_flag = stream.readBit();\r\n    const pic_width_in_mbs = stream.ExpGolomb() + 1;\r\n    const pic_height_in_map_units = stream.ExpGolomb() + 1;\r\n    const frame_mbs_only_flag = stream.readBit();\r\n    let mb_adaptive_frame_field_flag = 0;\r\n    if (!frame_mbs_only_flag) {\r\n        mb_adaptive_frame_field_flag = stream.readBit();\r\n    }\r\n    const direct_8x8_inference_flag = stream.readBit();\r\n    const frame_cropping_flag = stream.readBit();\r\n    const frame_cropping = getFrameCropping(frame_cropping_flag, stream);\r\n    const vui_parameters_present_flag = stream.readBit();\r\n    const vui_parameters = vui_1.getVUIParams(vui_parameters_present_flag, stream);\r\n    return {\r\n        sps_id,\r\n        profile_compatibility,\r\n        profile_idc,\r\n        level_idc,\r\n        chroma_format_idc,\r\n        bit_depth_luma,\r\n        bit_depth_chroma,\r\n        color_plane_flag,\r\n        qpprime_y_zero_transform_bypass_flag,\r\n        seq_scaling_matrix_present_flag,\r\n        seq_scaling_matrix: scaling_list_4x4,\r\n        log2_max_frame_num,\r\n        pic_order_cnt_type,\r\n        delta_pic_order_always_zero_flag,\r\n        offset_for_non_ref_pic,\r\n        offset_for_top_to_bottom_field,\r\n        offset_for_ref_frame,\r\n        log2_max_pic_order_cnt_lsb,\r\n        max_num_ref_frames,\r\n        gaps_in_frame_num_value_allowed_flag,\r\n        pic_width_in_mbs,\r\n        pic_height_in_map_units,\r\n        frame_mbs_only_flag,\r\n        mb_adaptive_frame_field_flag,\r\n        direct_8x8_inference_flag,\r\n        frame_cropping_flag,\r\n        frame_cropping,\r\n        vui_parameters_present_flag,\r\n        vui_parameters,\r\n    };\r\n}\r\nexports.parse = parse;\r\n","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 394;\nmodule.exports = webpackEmptyContext;","\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || (function () {\n    var ownKeys = function(o) {\n        ownKeys = Object.getOwnPropertyNames || function (o) {\n            var ar = [];\n            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;\n            return ar;\n        };\n        return ownKeys(o);\n    };\n    return function (mod) {\n        if (mod && mod.__esModule) return mod;\n        var result = {};\n        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== \"default\") __createBinding(result, mod, k[i]);\n        __setModuleDefault(result, mod);\n        return result;\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.StorageSettings = void 0;\nconst _1 = __importStar(require(\".\"));\nconst { systemManager } = _1.default;\nfunction parseValue(value, setting, readDefaultValue, rawDevice) {\n    if (value === null || value === undefined) {\n        return readDefaultValue();\n    }\n    const type = setting.multiple ? 'array' : setting.type;\n    if (type === 'boolean') {\n        if (value === 'true')\n            return true;\n        if (value === 'false')\n            return false;\n        return readDefaultValue() || false;\n    }\n    if (type === 'number') {\n        const n = parseFloat(value);\n        if (!isNaN(n))\n            return n;\n        return readDefaultValue() || 0;\n    }\n    if (type === 'integer') {\n        const n = parseInt(value);\n        if (!isNaN(n))\n            return n;\n        return readDefaultValue() || 0;\n    }\n    if (type === 'array') {\n        if (!value)\n            return readDefaultValue() || [];\n        try {\n            return JSON.parse(value);\n        }\n        catch (e) {\n            return readDefaultValue() || [];\n        }\n    }\n    if (type === 'device') {\n        if (rawDevice)\n            return value;\n        return systemManager.getDeviceById(value) || systemManager.getDeviceById(readDefaultValue());\n    }\n    // string type, so check if it is json.\n    if (value && setting.json) {\n        try {\n            return JSON.parse(value);\n        }\n        catch (e) {\n            return readDefaultValue();\n        }\n    }\n    return value || readDefaultValue();\n}\nclass StorageSettings {\n    constructor(device, settings) {\n        this.device = device;\n        this.settings = settings;\n        this.values = {};\n        this.hasValue = {};\n        for (const key of Object.keys(settings)) {\n            const setting = settings[key];\n            const rawGet = () => this.getItem(key);\n            let get;\n            if (setting.type !== 'clippath') {\n                get = rawGet;\n            }\n            else {\n                // maybe need a mapPut. clippath is the only complex type at the moment.\n                get = () => {\n                    try {\n                        return JSON.parse(rawGet());\n                    }\n                    catch (e) {\n                    }\n                };\n            }\n            Object.defineProperty(this.values, key, {\n                get,\n                set: value => this.putSetting(key, value),\n                enumerable: true,\n            });\n            Object.defineProperty(this.hasValue, key, {\n                get: () => this.device.storage.getItem(key) != null,\n                enumerable: true,\n            });\n        }\n    }\n    get keys() {\n        const ret = {};\n        for (const key of Object.keys(this.settings)) {\n            ret[key] = key;\n        }\n        return ret;\n    }\n    async getSettings() {\n        const onGet = await this.options?.onGet?.();\n        const ret = [];\n        for (const [key, setting] of Object.entries(this.settings)) {\n            let s = Object.assign({}, setting);\n            if (onGet?.[key])\n                s = Object.assign(s, onGet[key]);\n            if (s.onGet)\n                s = Object.assign(s, await s.onGet());\n            if (s.hide || await this.options?.hide?.[key]?.())\n                continue;\n            s.key = key;\n            s.value = this.getItemInternal(key, s, true);\n            if (typeof s.deviceFilter === 'function')\n                s.deviceFilter = s.deviceFilter.toString();\n            ret.push(s);\n            delete s.onPut;\n            delete s.onGet;\n            delete s.mapPut;\n            delete s.mapGet;\n        }\n        return ret;\n    }\n    async putSetting(key, value) {\n        const setting = this.settings[key];\n        let oldValue;\n        if (setting)\n            oldValue = this.getItemInternal(key, setting);\n        return this.putSettingInternal(setting, oldValue, key, value);\n    }\n    putSettingInternal(setting, oldValue, key, value) {\n        if (!setting?.noStore) {\n            if (setting?.mapPut)\n                value = setting.mapPut(oldValue, value);\n            // nullish values should be removed, since Storage can't persist them correctly.\n            if (value == null)\n                this.device.storage.removeItem(key);\n            else if (typeof value === 'object')\n                this.device.storage.setItem(key, JSON.stringify(value));\n            else\n                this.device.storage.setItem(key, value?.toString());\n        }\n        setting?.onPut?.(oldValue, value);\n        if (!setting?.hide)\n            this.device.onDeviceEvent(_1.ScryptedInterface.Settings, undefined);\n    }\n    getItemInternal(key, setting, rawDevice) {\n        if (!setting)\n            return this.device.storage.getItem(key);\n        const readDefaultValue = () => {\n            if (setting.persistedDefaultValue != null) {\n                this.putSettingInternal(setting, undefined, key, setting.persistedDefaultValue);\n                return setting.persistedDefaultValue;\n            }\n            return setting.defaultValue;\n        };\n        const ret = parseValue(this.device.storage.getItem(key), setting, readDefaultValue, rawDevice);\n        return setting.mapGet ? setting.mapGet(ret) : ret;\n    }\n    getItem(key) {\n        return this.getItemInternal(key, this.settings[key]);\n    }\n}\nexports.StorageSettings = StorageSettings;\n//# sourceMappingURL=storage-settings.js.map","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction ExpGolomInit(view, bitoffset) {\r\n    let bit = 0;\r\n    let byteoffset = bitoffset >> 3;\r\n    let skip = bitoffset & 7;\r\n    let zeros = -1;\r\n    let byt = view.getUint8(byteoffset) << skip;\r\n    do {\r\n        bit = byt & 0x80;\r\n        byt <<= 1;\r\n        zeros++;\r\n        skip++;\r\n        if (skip === 8) {\r\n            skip = 0;\r\n            byteoffset++;\r\n            byt = view.getUint8(byteoffset);\r\n        }\r\n    } while (!bit);\r\n    return { zeros, skip, byt, byteoffset };\r\n}\r\nconst shift16 = 2 ** 16;\r\nclass Bitstream {\r\n    constructor(view) {\r\n        this.view = view;\r\n        this.bitoffset = 0;\r\n    }\r\n    ExpGolomb() {\r\n        const { view } = this;\r\n        let { zeros, skip, byt, byteoffset, } = ExpGolomInit(view, this.bitoffset);\r\n        let code = 1;\r\n        while (zeros > 0) {\r\n            code = (code << 1) | ((byt & 0x80) >>> 7);\r\n            byt <<= 1;\r\n            skip++;\r\n            zeros--;\r\n            if (skip === 8) {\r\n                skip = 0;\r\n                byteoffset++;\r\n                byt = view.getUint8(byteoffset);\r\n            }\r\n        }\r\n        this.bitoffset = (byteoffset << 3) | skip;\r\n        return code - 1;\r\n    }\r\n    SignedExpGolomb() {\r\n        const code = this.ExpGolomb();\r\n        return code & 1 ? (code + 1) >>> 1 : -(code >>> 1);\r\n    }\r\n    readBit() {\r\n        const skip = this.bitoffset & 7;\r\n        const byteoffset = this.bitoffset >> 3;\r\n        this.bitoffset++;\r\n        return ((this.view.getUint8(byteoffset) >>> (7 - skip)) & 1);\r\n    }\r\n    readByte() {\r\n        const skip = this.bitoffset & 7;\r\n        const byteoffset = this.bitoffset >>> 3;\r\n        this.bitoffset += 8;\r\n        const high = this.view.getUint8(byteoffset);\r\n        if (skip === 0)\r\n            return high;\r\n        const low = this.view.getUint8(byteoffset + 1);\r\n        return (high << skip) | (low >>> (8 - skip));\r\n    }\r\n    readNibble() {\r\n        const skip = this.bitoffset & 7;\r\n        const byteoffset = this.bitoffset >> 3;\r\n        this.bitoffset += 4;\r\n        const high = this.view.getUint8(byteoffset);\r\n        if (skip === 0)\r\n            return high >>> 4;\r\n        if (skip <= 4)\r\n            return (high >>> (4 - skip)) & 0xf;\r\n        const low = this.view.getUint8(byteoffset + 1);\r\n        return ((high << (skip - 4)) | (low >>> (12 - skip))) & 0xf;\r\n    }\r\n    read5() {\r\n        const skip = this.bitoffset & 7;\r\n        const byteoffset = this.bitoffset >> 3;\r\n        this.bitoffset += 5;\r\n        const high = this.view.getUint8(byteoffset);\r\n        if (skip === 0)\r\n            return high >>> 3;\r\n        if (skip <= 3)\r\n            return (high >>> (3 - skip)) & 0x1f;\r\n        const low = this.view.getUint8(byteoffset + 1);\r\n        return ((high << (skip - 3)) | (low >>> (11 - skip))) & 0x1f;\r\n    }\r\n    readWord() {\r\n        const skip = this.bitoffset & 7;\r\n        const byteoffset = this.bitoffset >>> 3;\r\n        this.bitoffset += 32;\r\n        const { view } = this;\r\n        const tmp = (view.getUint16(byteoffset) * shift16) +\r\n            view.getUint16(byteoffset + 2);\r\n        if (skip === 0)\r\n            return tmp;\r\n        return (tmp * (2 ** skip)) + (view.getUint8(byteoffset + 4) >>> (8 - skip));\r\n    }\r\n    more_rbsp_data() {\r\n        const skip = this.bitoffset & 7;\r\n        let byteoffset = this.bitoffset >> 3;\r\n        const l = this.view.byteLength;\r\n        if (byteoffset >= l)\r\n            return false;\r\n        let byte = (this.view.getUint8(byteoffset) << skip) & 0xff;\r\n        let found_bit = byte > 0;\r\n        if (found_bit && !Number.isInteger(Math.log2(byte)))\r\n            return true;\r\n        while (++byteoffset < l) {\r\n            byte = this.view.getUint8(byteoffset);\r\n            const has_bit = byte > 0;\r\n            if (found_bit && has_bit)\r\n                return true;\r\n            if (has_bit && !Number.isInteger(Math.log2(byte)))\r\n                return true;\r\n            found_bit = found_bit || has_bit;\r\n        }\r\n        return false;\r\n    }\r\n}\r\nexports.Bitstream = Bitstream;\r\n","import { AutoenableMixinProvider } from '@scrypted/common/src/autoenable-mixin-provider';\nimport { ListenZeroSingleClientTimeoutError, closeQuiet, listenZeroSingleClient } from '@scrypted/common/src/listen-cluster';\nimport { readLength } from '@scrypted/common/src/read-stream';\nimport { H264_NAL_TYPE_IDR, H264_NAL_TYPE_SPS, RtspServer, RtspTrack, createRtspParser, findH264NaluType, listenSingleRtspClient } from '@scrypted/common/src/rtsp-server';\nimport { addTrackControls, getSpsPps, parseSdp } from '@scrypted/common/src/sdp-utils';\nimport { SettingsMixinDeviceBase, SettingsMixinDeviceOptions } from \"@scrypted/common/src/settings-mixin\";\nimport { sleep } from '@scrypted/common/src/sleep';\nimport { StreamChunk, StreamParser } from '@scrypted/common/src/stream-parser';\nimport sdk, { BufferConverter, ChargeState, EventListenerRegister, FFmpegInput, ForkWorker, MediaObject, MediaStreamDestination, MediaStreamOptions, MixinProvider, RequestMediaStreamOptions, ResponseMediaStreamOptions, ScryptedDevice, ScryptedDeviceType, ScryptedInterface, ScryptedMimeTypes, Setting, SettingValue, Settings, VideoCamera, VideoCameraConfiguration, WritableDeviceState } from '@scrypted/sdk';\nimport { StorageSettings } from '@scrypted/sdk/storage-settings';\nimport crypto from 'crypto';\nimport { once } from 'events';\nimport { parse as h264SpsParse } from \"h264-sps-parser\";\nimport net, { AddressInfo } from 'net';\nimport path from 'path';\nimport { Duplex } from 'stream';\nimport { ParserOptions, ParserSession, startParserSession } from './ffmpeg-rebroadcast';\nimport { FileRtspServer } from './file-rtsp-server';\nimport { getUrlLocalAdresses } from './local-addresses';\nimport { REBROADCAST_MIXIN_INTERFACE_TOKEN } from './rebroadcast-mixin-token';\nimport { connectRFC4571Parser, startRFC4571Parser } from './rfc4571';\nimport { RtspSessionParserSpecific, startRtspSession } from './rtsp-session';\nimport { getSpsResolution } from './sps-resolution';\nimport { createStreamSettings } from './stream-settings';\n\nconst { mediaManager, log, systemManager, deviceManager } = sdk;\n\nconst prebufferDurationMs = 10000;\nconst DEFAULT_FFMPEG_INPUT_ARGUMENTS = '-fflags +genpts';\n\nconst SCRYPTED_PARSER_TCP = 'Scrypted (TCP)';\nconst SCRYPTED_PARSER_UDP = 'Scrypted (UDP)';\nconst FFMPEG_PARSER_TCP = 'FFmpeg (TCP)';\nconst FFMPEG_PARSER_UDP = 'FFmpeg (UDP)';\nconst STRING_DEFAULT = 'Default';\n\ninterface PrebufferStreamChunk extends StreamChunk {\n  time?: number;\n}\n\ntype PrebufferParsers = 'rtsp';\n\nclass PrebufferSession {\n\n  parserSessionPromise: Promise<ParserSession<PrebufferParsers>>;\n  parserSession: ParserSession<PrebufferParsers>;\n  rtspPrebuffer: PrebufferStreamChunk[] = []\n  parsers: { [container: string]: StreamParser };\n  sdp: Promise<string>;\n  usingScryptedParser = false;\n  usingScryptedUdpParser = false;\n\n  mixinDevice: VideoCamera;\n  console: Console;\n  storage: Storage;\n\n  activeClients = 0;\n  inactivityTimeout: NodeJS.Timeout;\n  syntheticInputIdKey: string;\n  ffmpegInputArgumentsKey: string;\n  ffmpegOutputArgumentsKey: string;\n  lastDetectedAudioCodecKey: string;\n  rtspParserKey: string;\n  rtspServerPath: string;\n  rtspServerMutedPath: string;\n\n  batteryListener: EventListenerRegister;\n  chargerListener: EventListenerRegister;\n\n  constructor(public mixin: PrebufferMixin, public advertisedMediaStreamOptions: ResponseMediaStreamOptions, public enabled: boolean, public forceBatteryPrebuffer: boolean) {\n    this.storage = mixin.storage;\n    this.console = mixin.console;\n    this.mixinDevice = mixin.mixinDevice;\n    this.syntheticInputIdKey = 'syntheticInputIdKey-' + this.streamId;\n    this.ffmpegInputArgumentsKey = 'ffmpegInputArguments-' + this.streamId;\n    this.ffmpegOutputArgumentsKey = 'ffmpegOutputArguments-' + this.streamId;\n    this.lastDetectedAudioCodecKey = 'lastDetectedAudioCodec-' + this.streamId;\n    this.rtspParserKey = 'rtspParser-' + this.streamId;\n    const rtspServerPathKey = 'rtspServerPathKey-' + this.streamId;\n    const rtspServerMutedPathKey = 'rtspServerMutedPathKey-' + this.streamId;\n\n    this.rtspServerPath = this.storage.getItem(rtspServerPathKey);\n    if (!this.rtspServerPath) {\n      this.rtspServerPath = crypto.randomBytes(8).toString('hex');\n      this.storage.setItem(rtspServerPathKey, this.rtspServerPath);\n    }\n\n    this.rtspServerMutedPath = this.storage.getItem(rtspServerMutedPathKey);\n    if (!this.rtspServerMutedPath) {\n      this.rtspServerMutedPath = crypto.randomBytes(8).toString('hex');\n      this.storage.setItem(rtspServerMutedPathKey, this.rtspServerMutedPath);\n    }\n\n    this.handleChargingBatteryEvents();\n  }\n\n  get stopInactive() {\n    return !this.enabled || this.shouldDisableBatteryPrebuffer();\n  }\n\n  getDetectedIdrInterval() {\n    const durations: number[] = [];\n    if (this.rtspPrebuffer.length) {\n      let last: number;\n\n      for (const chunk of this.rtspPrebuffer) {\n        if (findH264NaluType(chunk, H264_NAL_TYPE_IDR)) {\n          if (last)\n            durations.push(chunk.time - last);\n          last = chunk.time;\n        }\n      }\n    }\n\n    if (!durations.length)\n      return;\n\n    const total = durations.reduce((prev, current) => prev + current, 0);\n    return total / durations.length;\n  }\n\n  get streamId() {\n    return this.advertisedMediaStreamOptions.id;\n  }\n\n  get streamName() {\n    return this.advertisedMediaStreamOptions.name || `Stream ${this.streamId}`;\n  }\n\n  clearPrebuffers() {\n    this.rtspPrebuffer = [];\n  }\n\n  release() {\n    this.clearPrebuffers();\n    this.parserSessionPromise?.then(parserSession => {\n      this.console.log(this.streamName, 'prebuffer session released');\n      parserSession.kill(new Error('rebroadcast disabled'));\n      this.clearPrebuffers();\n    });\n    if (this.batteryListener) {\n      this.batteryListener.removeListener();\n      this.batteryListener = null;\n    }\n    if (this.chargerListener) {\n      this.chargerListener.removeListener();\n      this.chargerListener = null;\n    }\n  }\n\n  ensurePrebufferSession() {\n    if (this.parserSessionPromise || this.mixin.released)\n      return;\n    this.console.log(this.streamName, 'prebuffer session started');\n    this.parserSessionPromise = this.startPrebufferSession();\n    let active = false;\n    this.parserSessionPromise.then(pso => {\n      pso.once('rtsp', () => {\n        active = true;\n        if (!this.mixin.online)\n          this.mixin.online = true;\n      });\n\n      pso.killed.finally(() => {\n        this.console.error(this.streamName, 'prebuffer session ended');\n        this.parserSessionPromise = undefined;\n      });\n    })\n      .catch(e => {\n        this.console.error(this.streamName, 'prebuffer session ended with error', e);\n        this.parserSessionPromise = undefined;\n\n        if (!active) {\n          // find sessions that arent this one, and check their prebuffers to see if any data has been received.\n          // if there's no data, then consider this camera offline.\n          const others = [...this.mixin.sessions.values()].filter(s => s !== this);\n          if (others.length) {\n            const hasData = others.some(s => s.rtspPrebuffer.length);\n            if (!hasData && this.mixin.online)\n              this.mixin.online = false;\n          }\n        }\n      });\n  }\n\n  canUseRtspParser(mediaStreamOptions: MediaStreamOptions) {\n    return mediaStreamOptions?.container?.startsWith('rtsp');\n  }\n\n  getParser(mediaStreamOptions: MediaStreamOptions) {\n    let parser: string;\n    let rtspParser = this.storage.getItem(this.rtspParserKey);\n\n    let isDefault = !rtspParser || rtspParser === 'Default';\n\n    if (!this.canUseRtspParser(mediaStreamOptions)) {\n      parser = STRING_DEFAULT;\n      isDefault = true;\n      rtspParser = undefined;\n    }\n    else {\n      if (isDefault) {\n        // use the plugin default\n        rtspParser = localStorage.getItem('defaultRtspParser');\n      }\n      switch (rtspParser) {\n        case FFMPEG_PARSER_TCP:\n        case FFMPEG_PARSER_UDP:\n        case SCRYPTED_PARSER_TCP:\n        case SCRYPTED_PARSER_UDP:\n          parser = rtspParser;\n          break;\n        default:\n          parser = SCRYPTED_PARSER_TCP;\n          break;\n      }\n    }\n\n    return {\n      parser,\n      isDefault,\n    }\n  }\n\n  async parseCodecs(skipResolution?: boolean) {\n    const sdp = await this.parserSession.sdp;\n    const parsedSdp = parseSdp(sdp);\n    const videoSection = parsedSdp.msections.find(msection => msection.type === 'video');\n    const audioSection = parsedSdp.msections.find(msection => msection.type === 'audio');\n\n    const inputAudioCodec = audioSection?.codec;\n    const inputVideoCodec = videoSection.codec;\n    let inputVideoResolution: ReturnType<typeof getSpsResolution>;\n\n    if (!skipResolution) {\n      // scan the prebuffer for sps\n      for (const chunk of this.rtspPrebuffer) {\n        try {\n          let sps = findH264NaluType(chunk, H264_NAL_TYPE_SPS);\n          if (sps) {\n            const parsedSps = h264SpsParse(sps);\n            inputVideoResolution = getSpsResolution(parsedSps);\n          }\n          else if (!sps) {\n            // sps = findH265NaluType(chunk, H265_NAL_TYPE_SPS);\n          }\n        }\n        catch (e) {\n        }\n      }\n\n      if (!inputVideoResolution) {\n        try {\n          const spspps = getSpsPps(videoSection);\n          let { sps } = spspps;\n          if (sps) {\n            if (videoSection.codec === 'h264') {\n              const parsedSps = h264SpsParse(sps);\n              inputVideoResolution = getSpsResolution(parsedSps);\n            }\n            else if (videoSection.codec === 'h265') {\n            }\n          }\n        }\n        catch (e) {\n        }\n      }\n    }\n\n    return {\n      inputVideoCodec,\n      inputAudioCodec,\n      inputVideoResolution,\n    }\n  }\n\n  async getMixinSettings(): Promise<Setting[]> {\n    const settings: Setting[] = [];\n\n    const session = this.parserSession;\n\n    let total = 0;\n    let start = 0;\n    for (const prebuffer of this.rtspPrebuffer) {\n      start = start || prebuffer.time;\n      for (const chunk of prebuffer.chunks) {\n        total += chunk.byteLength;\n      }\n    }\n    const elapsed = Date.now() - start;\n    const bitrate = Math.round(total / elapsed * 8);\n\n    const group = \"Streams\";\n    const subgroup = `Stream: ${this.streamName}`;\n\n    if (this.mixin.streamSettings.storageSettings.values.synthenticStreams.includes(this.streamId)) {\n      const nonSynthetic = [...this.mixin.sessions.keys()].filter(s => s && !s.startsWith('synthetic:'));\n      settings.push({\n        group,\n        subgroup,\n        key: this.syntheticInputIdKey,\n        title: 'Synthetic Stream Source',\n        description: 'The source stream to transcode.',\n        choices: nonSynthetic,\n        value: this.storage.getItem(this.syntheticInputIdKey),\n      });\n    }\n\n    const addFFmpegInputSettings = () => {\n      settings.push(\n        {\n          title: 'FFmpeg Input Arguments Prefix',\n          group,\n          subgroup,\n          description: 'Optional/Advanced: Additional input arguments to pass to the ffmpeg command. These will be placed before the input arguments.',\n          key: this.ffmpegInputArgumentsKey,\n          value: this.storage.getItem(this.ffmpegInputArgumentsKey),\n          placeholder: DEFAULT_FFMPEG_INPUT_ARGUMENTS,\n          choices: [\n            DEFAULT_FFMPEG_INPUT_ARGUMENTS,\n            '-use_wallclock_as_timestamps 1',\n            '-v verbose',\n          ],\n          combobox: true,\n        },\n        {\n          title: 'FFmpeg Output Prefix',\n          group,\n          subgroup,\n          description: 'Optional/Advanced: Additional output arguments to pass to the ffmpeg command. These will be placed before the output.',\n          key: this.ffmpegOutputArgumentsKey,\n          value: this.storage.getItem(this.ffmpegOutputArgumentsKey),\n          choices: [\n            '-c:v libx264 -pix_fmt yuvj420p -preset ultrafast -bf 0 -g 60 -r 15 -b:v 500000 -bufsize 1000000 -maxrate 500000'\n          ],\n          combobox: true,\n        },\n      )\n    }\n\n    let usingFFmpeg = true;\n\n    if (this.canUseRtspParser(this.advertisedMediaStreamOptions)) {\n      const parser = this.getParser(this.advertisedMediaStreamOptions);\n      const defaultValue = parser.parser;\n\n      const currentParser = parser.isDefault ? STRING_DEFAULT : parser.parser;\n\n      settings.push(\n        {\n          key: this.rtspParserKey,\n          group,\n          subgroup,\n          title: 'RTSP Parser',\n          description: `The RTSP Parser used to read the stream. The default is \"${defaultValue}\" for this stream.`,\n          value: currentParser,\n          choices: [\n            STRING_DEFAULT,\n            SCRYPTED_PARSER_TCP,\n            SCRYPTED_PARSER_UDP,\n            FFMPEG_PARSER_TCP,\n            FFMPEG_PARSER_UDP,\n          ],\n        }\n      );\n\n      usingFFmpeg = !parser.parser.includes('Scrypted');\n    }\n\n    if (usingFFmpeg) {\n      addFFmpegInputSettings();\n    }\n\n    if (session) {\n      const codecInfo = await this.parseCodecs();\n      const resolution = codecInfo.inputVideoResolution?.width && codecInfo.inputVideoResolution?.height\n        ? `${codecInfo.inputVideoResolution?.width}x${codecInfo.inputVideoResolution?.height}`\n        : 'unknown';\n\n      const idrInterval = this.getDetectedIdrInterval();\n      settings.push(\n        {\n          key: 'detectedResolution',\n          group,\n          subgroup,\n          title: 'Detected Resolution and Bitrate',\n          readonly: true,\n          value: `${resolution} @ ${bitrate || \"unknown\"} Kb/s`,\n          description: 'Configuring your camera to 1920x1080, 2000Kb/S, Variable Bit Rate, is recommended.',\n        },\n        {\n          key: 'detectedCodec',\n          group,\n          subgroup,\n          title: 'Detected Video/Audio Codecs',\n          readonly: true,\n          value: (codecInfo?.inputVideoCodec?.toString() || 'unknown') + '/' + (codecInfo?.inputAudioCodec?.toString() || 'unknown'),\n          description: 'Configuring your camera to H264 video, and audio to Opus or PCM-mulaw (G.711ulaw) is recommended.'\n        },\n        {\n          key: 'detectedKeyframe',\n          group,\n          subgroup,\n          title: 'Detected Keyframe Interval',\n          description: \"Configuring your camera to 4 seconds is recommended (IDR aka Frame Interval = FPS * 4 seconds).\",\n          readonly: true,\n          value: (idrInterval || 0) / 1000 || 'unknown',\n        },\n      );\n    }\n    else {\n      settings.push(\n        {\n          title: 'Status',\n          group,\n          subgroup,\n          key: 'status',\n          description: 'Rebroadcast is currently idle and will be started automatically on demand.',\n          value: 'Idle',\n          readonly: true,\n        },\n      );\n    }\n\n    settings.push({\n      group,\n      subgroup,\n      key: 'rtspRebroadcastUrl',\n      title: 'RTSP Rebroadcast Url',\n      description: 'The RTSP URL of the rebroadcast stream. Substitute localhost as appropriate.',\n      readonly: true,\n      value: `rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerPath}`,\n    });\n    settings.push({\n      group,\n      subgroup,\n      key: 'rtspRebroadcastMutedUrl',\n      title: 'RTSP Rebroadcast Url (Muted)',\n      description: 'The RTSP URL of the muted rebroadcast stream. Substitute localhost as appropriate.',\n      readonly: true,\n      value: `rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerMutedPath}`,\n    });\n\n    return settings;\n  }\n\n  async startPrebufferSession() {\n    this.clearPrebuffers();\n\n    let mso: ResponseMediaStreamOptions;\n    try {\n      mso = (await this.mixinDevice.getVideoStreamOptions()).find(o => o.id === this.streamId);\n      if (this.mixin.streamSettings.storageSettings.values.noAudio)\n        mso.audio = null;\n    }\n    catch (e) {\n    }\n\n    if (this.mixin.streamSettings.storageSettings.values.privacyMode) {\n      mso.audio = null;\n    }\n\n    // camera may explicity request that its audio stream be muted via a null.\n    // respect that setting.\n    const audioSoftMuted = mso?.audio === null;\n    const advertisedAudioCodec = !audioSoftMuted && mso?.audio?.codec;\n\n    let detectedAudioCodec = this.storage.getItem(this.lastDetectedAudioCodecKey) || undefined;\n    if (detectedAudioCodec === 'null')\n      detectedAudioCodec = null;\n\n    const rbo: ParserOptions<PrebufferParsers> = {\n      console: this.console,\n      timeout: 60000,\n      parsers: {\n      },\n    };\n    this.parsers = rbo.parsers;\n\n    let mo: MediaObject;\n    if (this.mixin.streamSettings.storageSettings.values.privacyMode) {\n      const ffmpegInput: FFmpegInput = {\n        container: 'mp4',\n        inputArguments: [\n          '-re',\n          '-stream_loop', '-1',\n          '-i', 'camera-slash.mp4',\n        ],\n        mediaStreamOptions: {\n          id: this.streamId,\n          container: 'mp4',\n        }\n      };\n      mo = await mediaManager.createMediaObject(ffmpegInput, ScryptedMimeTypes.FFmpegInput);\n    }\n    else if (this.mixin.streamSettings.storageSettings.values.synthenticStreams.includes(this.streamId)) {\n      const syntheticInputId = this.storage.getItem(this.syntheticInputIdKey);\n      if (!syntheticInputId)\n        throw new Error('synthetic stream has not been configured with an input');\n      const realDevice = systemManager.getDeviceById<VideoCamera>(this.mixin.id);\n      mo = await realDevice.getVideoStream({\n        id: syntheticInputId,\n      });\n    }\n    else {\n      mo = await this.mixinDevice.getVideoStream(mso);\n    }\n    const isRfc4571 = mo.mimeType === 'x-scrypted/x-rfc4571';\n\n    let session: ParserSession<PrebufferParsers>;\n    let sessionMso: ResponseMediaStreamOptions;\n\n    // before launching the parser session, clear out the last detected codec.\n    // an erroneous cached codec could cause ffmpeg to fail to start.\n    this.storage.removeItem(this.lastDetectedAudioCodecKey);\n    this.usingScryptedParser = false;\n\n    if (isRfc4571) {\n      this.usingScryptedParser = true;\n      this.console.log('bypassing ffmpeg: using scrypted rfc4571 parser')\n      const json = await mediaManager.convertMediaObjectToJSON<any>(mo, 'x-scrypted/x-rfc4571');\n      let { url, sdp, mediaStreamOptions } = json;\n      sdp = addTrackControls(sdp);\n      sessionMso = mediaStreamOptions;\n\n      const rtspParser = createRtspParser();\n      rbo.parsers.rtsp = rtspParser;\n\n      session = startRFC4571Parser(this.console, connectRFC4571Parser(url), sdp, mediaStreamOptions, {\n        timeout: 10000,\n      });\n    }\n    else {\n      const ffmpegInput: FFmpegInput = await mediaManager.convertMediaObjectToJSON(mo, ScryptedMimeTypes.FFmpegInput);\n      sessionMso = ffmpegInput.mediaStreamOptions || this.advertisedMediaStreamOptions;\n\n      let { parser, isDefault } = this.getParser(sessionMso);\n      this.usingScryptedParser = parser === SCRYPTED_PARSER_TCP || parser === SCRYPTED_PARSER_UDP;\n      this.usingScryptedUdpParser = parser === SCRYPTED_PARSER_UDP;\n\n      if (this.usingScryptedParser) {\n        const rtspParser = createRtspParser();\n        rbo.parsers.rtsp = rtspParser;\n\n        session = await startRtspSession(this.console, ffmpegInput.url, ffmpegInput.mediaStreamOptions, {\n          useUdp: parser === SCRYPTED_PARSER_UDP,\n          audioSoftMuted,\n          rtspRequestTimeout: 10000,\n        });\n      }\n      else {\n        let acodec: string[];\n\n        if (audioSoftMuted) {\n          // no audio? explicitly disable it.\n          acodec = ['-an'];\n        }\n        else {\n          acodec = [\n            '-acodec',\n            'copy',\n          ];\n        }\n\n        let vcodec = [\n          '-vcodec', 'copy',\n        ];\n\n        acodec = audioSoftMuted ? acodec : ['-acodec', 'copy'];\n\n        if (parser === FFMPEG_PARSER_UDP)\n          ffmpegInput.inputArguments = ['-rtsp_transport', 'udp', '-i', ffmpegInput.url];\n        else if (parser === FFMPEG_PARSER_TCP)\n          ffmpegInput.inputArguments = ['-rtsp_transport', 'tcp', '-i', ffmpegInput.url];\n        // create missing pts from dts so mpegts and mp4 muxing does not fail\n        const userInputArguments = this.storage.getItem(this.ffmpegInputArgumentsKey);\n        const extraInputArguments = userInputArguments || DEFAULT_FFMPEG_INPUT_ARGUMENTS;\n        const extraOutputArguments = this.storage.getItem(this.ffmpegOutputArgumentsKey) || '';\n        ffmpegInput.inputArguments.unshift(...extraInputArguments.split(' '));\n\n        if (ffmpegInput.h264EncoderArguments?.length) {\n          vcodec = [...ffmpegInput.h264EncoderArguments];\n        }\n        // extraOutputArguments must contain full codec information\n        if (extraOutputArguments) {\n          vcodec = [...extraOutputArguments.split(' ').filter(d => !!d)];\n          acodec = [];\n        }\n\n        const rtspParser = createRtspParser({\n          vcodec,\n          // the rtsp parser should always stream copy unless audio is soft muted.\n          acodec,\n        });\n        rbo.parsers.rtsp = rtspParser;\n\n        session = await startParserSession(ffmpegInput, rbo);\n      }\n    }\n\n    this.sdp = session.sdp;\n    session.on('error', e => {\n      if (!e.message?.startsWith('killed:'))\n        console.error('rebroadcast error', e)\n    });\n\n    await session.sdp;\n    this.parserSession = session;\n    session.killed.finally(() => {\n      if (this.parserSession === session)\n        this.parserSession = undefined;\n    });\n    session.killed.finally(() => clearTimeout(this.inactivityTimeout));\n\n    const codecInfo = await this.parseCodecs();\n\n    // complain to the user about the codec if necessary. upstream may send a audio\n    // stream but report none exists (to request muting).\n    if (!audioSoftMuted && advertisedAudioCodec && codecInfo.inputAudioCodec !== undefined\n      && codecInfo.inputAudioCodec !== advertisedAudioCodec) {\n      this.console.warn('Audio codec plugin reported vs detected mismatch', advertisedAudioCodec, detectedAudioCodec);\n    }\n\n    const advertisedVideoCodec = mso?.video?.codec;\n    if (advertisedVideoCodec && codecInfo.inputVideoCodec !== undefined\n      && codecInfo.inputVideoCodec !== advertisedVideoCodec) {\n      this.console.warn('Video codec plugin reported vs detected mismatch', advertisedVideoCodec, codecInfo.inputVideoCodec);\n    }\n\n    if (!codecInfo.inputAudioCodec) {\n      this.console.log('No audio stream detected.');\n    }\n\n    // set/update the detected codec, set it to null if no audio was found.\n    this.storage.setItem(this.lastDetectedAudioCodecKey, codecInfo.inputAudioCodec || 'null');\n\n    if (codecInfo.inputVideoCodec !== 'h264') {\n      this.console.error(`Video codec is not h264. If there are errors, try changing your camera's encoder output.`);\n    }\n\n    // settings ui refresh\n    deviceManager.onMixinEvent(this.mixin.id, this.mixin, ScryptedInterface.Settings, undefined);\n\n    // cloud streams need a periodic token refresh.\n    if (sessionMso?.refreshAt) {\n      let mso = sessionMso;\n      let refreshTimeout: NodeJS.Timeout;\n\n      const refreshStream = async () => {\n        if (!session.isActive)\n          return;\n        const mo = await this.mixinDevice.getVideoStream(mso);\n        const ffmpegInput: FFmpegInput = await mediaManager.convertMediaObjectToJSON(mo, ScryptedMimeTypes.FFmpegInput);\n        mso = ffmpegInput.mediaStreamOptions;\n\n        scheduleRefresh(mso);\n      };\n\n      const scheduleRefresh = (refreshMso: ResponseMediaStreamOptions) => {\n        const when = refreshMso.refreshAt - Date.now() - 30000;\n        this.console.log('refreshing media stream in', when);\n        refreshTimeout = setTimeout(refreshStream, when);\n      }\n\n      scheduleRefresh(mso);\n      session.killed.finally(() => clearTimeout(refreshTimeout));\n    }\n\n    let shifts = 0;\n    let prebufferContainer: PrebufferStreamChunk[] = this.rtspPrebuffer;\n\n    session.on('rtsp', (chunk: PrebufferStreamChunk) => {\n      const now = Date.now();\n\n      chunk.time = now;\n      prebufferContainer.push(chunk);\n\n      while (prebufferContainer.length && prebufferContainer[0].time < now - prebufferDurationMs) {\n        prebufferContainer.shift();\n        shifts++;\n      }\n\n      if (shifts > 100000) {\n        prebufferContainer = prebufferContainer.slice();\n        this.rtspPrebuffer = prebufferContainer;\n        shifts = 0;\n      }\n    });\n\n    session.start();\n    return session;\n  }\n\n  printActiveClients() {\n    this.console.log(this.streamName, 'active rebroadcast clients:', this.activeClients);\n  }\n\n  inactivityCheck(session: ParserSession<PrebufferParsers>, resetTimeout: boolean) {\n    if (this.activeClients)\n      return;\n\n    if (!this.stopInactive) {\n      return;\n    }\n\n    // passive clients should not reset timeouts.\n    if (this.inactivityTimeout && !resetTimeout)\n      return;\n\n    clearTimeout(this.inactivityTimeout)\n    this.inactivityTimeout = setTimeout(() => {\n      this.inactivityTimeout = undefined;\n      if (this.activeClients) {\n        this.console.log('inactivity timeout found active clients.');\n        return;\n      }\n      this.console.log(this.streamName, 'terminating rebroadcast due to inactivity');\n      session.kill(new Error('killed: stream inactivity'));\n    }, 10000);\n  }\n\n  handleChargingBatteryEvents() {\n    if (!this.mixin.interfaces.includes(ScryptedInterface.Charger) ||\n      !this.mixin.interfaces.includes(ScryptedInterface.Battery)) {\n      return;\n    }\n\n    const checkDisablePrebuffer = async () => {\n      if (this.stopInactive) {\n        this.console.log(this.streamName, 'low battery or not charging, prebuffering and rebroadcasting will only work on demand')\n        if (!this.activeClients && this.parserSessionPromise) {\n          this.console.log(this.streamName, 'terminating rebroadcast due to low battery or not charging')\n          const session = await this.parserSessionPromise;\n          session.kill(new Error('killed: low battery or not charging'));\n        }\n      } else {\n        this.ensurePrebufferSession();\n      }\n    }\n\n    const id = this.mixin.id;\n    if (!this.batteryListener) {\n      this.batteryListener = systemManager.listenDevice(id, ScryptedInterface.Battery, () => checkDisablePrebuffer());\n    }\n    if (!this.chargerListener) {\n      this.chargerListener = systemManager.listenDevice(id, ScryptedInterface.Charger, () => checkDisablePrebuffer());\n    }\n  }\n\n  shouldDisableBatteryPrebuffer(): boolean | null {\n    if (!this.mixin.interfaces.includes(ScryptedInterface.Battery)) {\n      return null;\n    }\n    if (this.forceBatteryPrebuffer) {\n      return false;\n    }\n    const lowBattery = this.mixin.batteryLevel == null || this.mixin.batteryLevel < 20;\n    const hasCharger = this.mixin.interfaces.includes(ScryptedInterface.Charger);\n    return !hasCharger || lowBattery || this.mixin.chargeState !== ChargeState.Charging;\n  }\n\n  async handleRebroadcasterClient(options: {\n    findSyncFrame: boolean,\n    isActiveClient: boolean,\n    session: ParserSession<PrebufferParsers>,\n    socketPromise: Promise<Duplex>,\n    requestedPrebuffer: number,\n    filter?: (chunk: StreamChunk, prebuffer: boolean) => StreamChunk,\n  }) {\n    const { isActiveClient, session, socketPromise, requestedPrebuffer } = options;\n    // this.console.log('sending prebuffer', requestedPrebuffer);\n\n    let socket: Duplex;\n\n    try {\n      socket = await socketPromise;\n\n      if (!session.isActive) {\n        // session may be killed while waiting for socket.\n        socket.destroy();\n        throw new Error('session terminated before socket connected');\n      }\n    }\n    catch (e) {\n      // in case the client never connects, do an inactivity check.\n      this.inactivityCheck(session, false);\n      if (e instanceof ListenZeroSingleClientTimeoutError)\n        this.console.warn('client connection timed out');\n      else\n        this.console.error('client connection error', e);\n      return;\n    }\n\n    if (isActiveClient) {\n      this.activeClients++;\n      this.printActiveClients();\n    }\n\n    socket.once('close', () => {\n      if (isActiveClient) {\n        this.activeClients--;\n        this.printActiveClients();\n      }\n      this.inactivityCheck(session, isActiveClient);\n    });\n\n    let writeData = (data: StreamChunk): number => {\n      if (data.startStream) {\n        socket.write(data.startStream)\n      }\n\n      const writeDataWithoutStartStream = (data: StreamChunk) => {\n        for (const chunk of data.chunks) {\n          socket.write(chunk);\n        }\n\n        return socket.writableLength;\n      };\n\n      writeData = writeDataWithoutStartStream;\n      return writeDataWithoutStartStream(data);\n    }\n\n    const safeWriteData = (chunk: StreamChunk, prebuffer?: boolean) => {\n      if (options.filter) {\n        chunk = options.filter(chunk, prebuffer);\n        if (!chunk)\n          return;\n      }\n      const buffered = writeData(chunk);\n      if (buffered > 100000000) {\n        this.console.log('more than 100MB has been buffered, did downstream die? killing connection.', this.streamName);\n        cleanup();\n      }\n    }\n\n    const cleanup = () => {\n      socket.destroy();\n      session.removeListener('rtsp', safeWriteData);\n      session.removeListener('killed', cleanup);\n    };\n\n    session.on('rtsp', safeWriteData);\n    session.once('killed', cleanup);\n\n    socket.once('close', () => {\n      cleanup();\n    });\n\n    // socket.on('error', e => this.console.log('client stream ended'));\n\n\n    const now = Date.now();\n    const prebufferContainer: PrebufferStreamChunk[] = this.rtspPrebuffer;\n    // if starting on a sync frame, ffmpeg will skip the first segment while initializing\n    // on live sources like rtsp. the buffer before the sync frame stream will be enough\n    // for ffmpeg to analyze and start up in time for the sync frame.\n    if (!options.findSyncFrame) {\n      for (const chunk of prebufferContainer) {\n        if (chunk.time < now - requestedPrebuffer)\n          continue;\n\n        safeWriteData(chunk, true);\n      }\n    }\n    else {\n      const parser = this.parsers['rtsp'];\n      const filtered = prebufferContainer.filter(pb => pb.time >= now - requestedPrebuffer);\n      let availablePrebuffers = parser.findSyncFrame(filtered);\n      if (!availablePrebuffers) {\n        this.console.warn('Unable to find sync frame in rtsp prebuffer.');\n        availablePrebuffers = [];\n      }\n      else {\n        // this.console.log('Found sync frame in rtsp prebuffer.');\n      }\n      for (const prebuffer of availablePrebuffers) {\n        safeWriteData(prebuffer, true);\n      }\n    }\n  }\n\n  async getVideoStream(findSyncFrame: boolean, options?: RequestMediaStreamOptions) {\n    if (options?.refresh === false && !this.parserSessionPromise)\n      throw new Error('Stream is currently unavailable and will not be started for this request. RequestMediaStreamOptions.refresh === false');\n\n    const startedParserSession = !this.parserSessionPromise;\n\n    this.ensurePrebufferSession();\n\n    const session = await this.parserSessionPromise;\n\n    let requestedPrebuffer = options?.prebuffer;\n    // if no prebuffer was requested, try to find a sync frame in the prebuffer.\n    // also do this if this request initiated the prebuffer: so, an explicit request for 0 prebuffer\n    // will still send the initial sync frame in the stream start. it may otherwise be missed\n    // if some time passes between the initial stream request and the actual pulling of the stream.\n    if (requestedPrebuffer == null || startedParserSession) {\n      // prebuffer search for remote streaming should be even more conservative than local network.\n      const defaultPrebuffer = options?.destination === 'remote' ? 2000 : 4000;\n      // try to gaurantee a sync frame, but don't search too much prebuffer to make it happen.\n      requestedPrebuffer = Math.min(defaultPrebuffer, this.getDetectedIdrInterval() || defaultPrebuffer);\n    }\n\n    const codecInfo = await this.parseCodecs(true);\n    const mediaStreamOptions: ResponseMediaStreamOptions = session.negotiateMediaStream(options, codecInfo.inputVideoCodec, codecInfo.inputAudioCodec);\n    let sdp = await this.sdp;\n\n    if (this.mixin.streamSettings.storageSettings.values.noAudio)\n      mediaStreamOptions.audio = null;\n\n    let socketPromise: Promise<Duplex>;\n    let url: string;\n    let urls: string[];\n    let filter: (chunk: StreamChunk, prebuffer: boolean) => StreamChunk;\n    let interleavePassthrough = false;\n    const interleavedMap = new Map<string, number>();\n    const serverPortMap = new Map<string, RtspTrack>();\n    let server: FileRtspServer;\n    const parsedSdp = parseSdp(sdp);\n    const videoSection = parsedSdp.msections.find(msection => msection.codec && msection.codec === mediaStreamOptions.video?.codec) || parsedSdp.msections.find(msection => msection.type === 'video');\n    let audioSection = parsedSdp.msections.find(msection => msection.codec && msection.codec === mediaStreamOptions.audio?.codec) || parsedSdp.msections.find(msection => msection.type === 'audio');\n    // ensure the mso and sdp both reflect audio mute, or no audio found (which can be an upstream plugin error)\n    if (mediaStreamOptions.audio === null)\n      audioSection = undefined;\n    if (!audioSection)\n      mediaStreamOptions.audio = null;\n    parsedSdp.msections = parsedSdp.msections.filter(msection => msection === videoSection || msection === audioSection);\n    const filterPrebufferAudio = options?.prebuffer === undefined;\n    const videoCodec = parsedSdp.msections.find(msection => msection.type === 'video')?.codec;\n    sdp = parsedSdp.toSdp();\n    filter = (chunk, prebuffer) => {\n      // if no prebuffer is explicitly requested, don't send prebuffer audio\n      if (prebuffer && filterPrebufferAudio && chunk.type !== videoCodec)\n        return;\n\n      const channel = interleavedMap.get(chunk.type);\n      if (!interleavePassthrough) {\n        if (channel == undefined) {\n          const udp = serverPortMap.get(chunk.type);\n          if (udp)\n            server.sendTrack(udp.control, chunk.chunks[1], chunk.type.startsWith('rtcp-'));\n          return;\n        }\n\n        const chunks = chunk.chunks.slice();\n        const header = Buffer.from(chunks[0]);\n        header.writeUInt8(channel, 1);\n        chunks[0] = header;\n        chunk = {\n          type: chunk.type,\n          startStream: chunk.startStream,\n          chunks,\n        }\n      }\n      else if (channel === undefined) {\n        return;\n      }\n\n      if (server.writeStream) {\n        server.writeRtpPayload(chunk.chunks[0], chunk.chunks[1]);\n        return;\n      }\n\n      return chunk;\n    }\n\n    const hostname = options?.route === 'internal' ? undefined : '0.0.0.0';\n\n    const clientPromise = await listenSingleRtspClient({\n      hostname,\n      pathToken: path.join(crypto.randomBytes(8).toString('hex'), this.mixin.id),\n      createServer: duplex => {\n        sdp = addTrackControls(sdp);\n        server = new FileRtspServer(duplex, sdp);\n        server.writeConsole = this.console;\n        return server;\n      }\n    });\n\n    socketPromise = clientPromise.rtspServerPromise.then(async server => {\n      if (session.parserSpecific) {\n        const parserSpecific = session.parserSpecific as RtspSessionParserSpecific;\n        server.resolveInterleaved = msection => {\n          const channel = parserSpecific.interleaved.get(msection.codec);\n          return [channel, channel + 1];\n        }\n      }\n      // server.console = this.console;\n      await server.handlePlayback();\n      server.handleTeardown().catch(() => { }).finally(() => server.client.destroy());\n      for (const track of Object.values(server.setupTracks)) {\n        if (track.protocol === 'udp') {\n          serverPortMap.set(track.codec, track);\n          serverPortMap.set(`rtcp-${track.codec}`, track);\n          continue;\n        }\n        interleavedMap.set(track.codec, track.destination);\n        interleavedMap.set(`rtcp-${track.codec}`, track.destination + 1);\n      }\n\n      interleavePassthrough = session.parserSpecific && serverPortMap.size === 0;\n      return server.client;\n    })\n\n    url = clientPromise.url;\n    if (hostname) {\n      urls = await getUrlLocalAdresses(this.console, url);\n    }\n\n    mediaStreamOptions.sdp = sdp;\n\n    const isActiveClient = options?.refresh !== false;\n\n    this.handleRebroadcasterClient({\n      findSyncFrame,\n      isActiveClient,\n      requestedPrebuffer,\n      socketPromise,\n      session,\n      filter,\n    });\n    mediaStreamOptions.prebuffer = 0;\n\n    if (audioSection) {\n      mediaStreamOptions.audio ||= {};\n      mediaStreamOptions.audio.codec ||= audioSection.rtpmap.codec;\n      mediaStreamOptions.audio.sampleRate ||= audioSection.rtpmap.clock;\n    }\n\n    if (codecInfo.inputVideoResolution?.width && codecInfo.inputVideoResolution?.height) {\n      // this may be an audio only request.\n      if (mediaStreamOptions.video)\n        Object.assign(mediaStreamOptions.video, codecInfo.inputVideoResolution);\n    }\n\n    const now = Date.now();\n    let available = 0;\n    const prebufferContainer: PrebufferStreamChunk[] = this.rtspPrebuffer;\n    for (const prebuffer of prebufferContainer) {\n      if (prebuffer.time < now - requestedPrebuffer)\n        continue;\n      if (!mediaStreamOptions.prebuffer)\n        mediaStreamOptions.prebuffer = now - prebuffer.time;\n      for (const chunk of prebuffer.chunks) {\n        available += chunk.length;\n      }\n    }\n    mediaStreamOptions.prebufferBytes = available;\n\n    const length = Math.max(500000, available).toString();\n\n    const inputArguments = [\n      '-analyzeduration', '0', '-probesize', length,\n    ];\n    if (!this.usingScryptedUdpParser)\n      inputArguments.push('-reorder_queue_size', '0');\n\n    const ffmpegInput: FFmpegInput = {\n      url,\n      urls,\n      container: 'rtsp',\n      inputArguments: [\n        ...inputArguments,\n        ...(this.parsers['rtsp'].inputArguments || []),\n        '-f', this.parsers['rtsp'].container,\n        '-i', url,\n      ],\n      mediaStreamOptions,\n    }\n\n    return ffmpegInput;\n  }\n}\n\nclass PrebufferMixin extends SettingsMixinDeviceBase<VideoCamera> implements VideoCamera, Settings {\n  released = false;\n  sessions = new Map<string, PrebufferSession>();\n  streamSettings = createStreamSettings(this);\n  rtspServer: net.Server;\n  settingsListener: EventListenerRegister;\n  videoCameraListener: EventListenerRegister;\n\n  constructor(options: SettingsMixinDeviceOptions<VideoCamera & VideoCameraConfiguration>) {\n    super(options);\n\n    const rebroadcast = systemManager.getDeviceById('@scrypted/prebuffer-mixin').id;\n    const expected: string[] = [rebroadcast];\n\n    const webrtc = systemManager.getDeviceById('@scrypted/webrtc');\n    if (webrtc && this.providedInterfaces.includes(ScryptedInterface.RTCSignalingChannel))\n      expected.unshift(webrtc.id);\n\n    let matched = true;\n    for (let i = 0; i < expected.length; i++) {\n      if (this.mixins[i] !== expected[i]) {\n        matched = false;\n        break;\n      }\n    }\n\n    if (!matched) {\n      this.console.warn('rebroadcast/webrtc order not matched. this may cause flapping on interface changes. fixing.');\n      setTimeout(() => {\n        const currentMixins = this.mixins.filter(mixin => !expected.includes(mixin));\n        currentMixins.unshift(...expected);\n        const realDevice = systemManager.getDeviceById(this.id);\n        realDevice.setMixins(currentMixins);\n      }, 1000);\n    }\n\n    this.delayStart();\n\n    (async () => {\n      let retry = 1000;\n      while (true) {\n        try {\n          await this.startRtspServer();\n          break;\n        }\n        catch (e) {\n          this.console.warn('Error starting RTSP Rebroadcast Server. Retrying shortly. If this problem persists, consider assigning a different port. This warning can be ignored if the rebroadcast URL is not in use.', e);\n          await sleep(retry);\n          retry = Math.min(60000, retry * 2);\n        }\n      }\n    })();\n\n    this.settingsListener = systemManager.listenDevice(this.id, ScryptedInterface.Settings, () => this.ensurePrebufferSessions());\n    this.videoCameraListener = systemManager.listenDevice(this.id, ScryptedInterface.VideoCamera, () => this.reinitiatePrebufferSessions());\n  }\n\n  async startRtspServer() {\n    closeQuiet(this.rtspServer);\n\n    this.rtspServer = new net.Server(async (client) => {\n      this.console.log('external rtsp client', client.localAddress, client.localPort);\n\n      let prebufferSession: PrebufferSession;\n\n      const server = new RtspServer(client, undefined, false, async (method, url, headers, rawMessage) => {\n        server.checkRequest = undefined;\n\n        const u = new URL(url);\n\n        for (const session of this.sessions.values()) {\n          if (u.pathname === '/' + session.rtspServerPath) {\n            server.console = session.console;\n            prebufferSession = session;\n            prebufferSession.ensurePrebufferSession();\n            await prebufferSession.parserSessionPromise;\n            server.sdp = await prebufferSession.sdp;\n            return true;\n          }\n          if (u.pathname === '/' + session.rtspServerMutedPath) {\n            server.console = session.console;\n            prebufferSession = session;\n            prebufferSession.ensurePrebufferSession();\n            await prebufferSession.parserSessionPromise;\n            const sdp = parseSdp(await prebufferSession.sdp);\n            sdp.msections = sdp.msections.filter(msection => msection.type === 'video');\n            server.sdp = sdp.toSdp();\n            return true;\n          }\n        }\n\n        return false;\n      });\n\n      this.console.log('RTSP Rebroadcast connection started.')\n      server.console = this.console;\n\n      try {\n        await server.handlePlayback();\n        const map = new Map<string, string>();\n        for (const [id, track] of Object.entries(server.setupTracks)) {\n          map.set(track.codec, id);\n        }\n        const session = await prebufferSession.parserSessionPromise;\n\n        const requestedPrebuffer = Math.max(4000, prebufferSession.getDetectedIdrInterval() || 4000);;\n\n        prebufferSession.handleRebroadcasterClient({\n          findSyncFrame: true,\n          isActiveClient: true,\n          session,\n          socketPromise: Promise.resolve(client),\n          requestedPrebuffer,\n          filter: (chunk, prebuffer) => {\n            const track = map.get(chunk.type);\n            if (track) {\n              server.sendTrack(track, chunk.chunks[1], false);\n              const buffered = server.client.writableLength;\n              if (buffered > 100000000) {\n                this.console.log('more than 100MB has been buffered to RTSP Client, did downstream die? killing connection.');\n                client.destroy();\n              }\n            }\n            return undefined;\n          }\n        });\n\n        await server.handleTeardown();\n      }\n      catch (e) {\n        client.destroy();\n      }\n      this.console.log('RTSP Rebroadcast connection finished.')\n    });\n\n    this.rtspServer.listen(this.streamSettings.storageSettings.values.rebroadcastPort || 0);\n\n    await once(this.rtspServer, 'listening').then(() => {\n      const port = (this.rtspServer.address() as AddressInfo).port;\n      this.streamSettings.storageSettings.values.rebroadcastPort = port;\n    });\n  }\n\n  delayStart() {\n    this.console.log('prebuffer sessions starting in 5 seconds');\n    // to prevent noisy startup/reload/shutdown, delay the prebuffer starting.\n    setTimeout(() => this.ensurePrebufferSessions(), 5000);\n  }\n\n  async getVideoStream(options?: RequestMediaStreamOptions): Promise<MediaObject> {\n    await this.ensurePrebufferSessions();\n\n    let id = options?.id;\n    if (!this.sessions.has(id))\n      id = undefined;\n\n    const msos = await this.mixinDevice.getVideoStreamOptions();\n    let result: {\n      stream: ResponseMediaStreamOptions,\n      isDefault: boolean,\n      title: string;\n    };\n\n    if (!id) {\n      switch (options?.destination) {\n        case 'medium-resolution':\n        case 'remote':\n          result = this.streamSettings.getRemoteStream(msos);\n          break;\n        case 'low-resolution':\n          result = this.streamSettings.getLowResolutionStream(msos);\n          break;\n        case 'local-recorder':\n          result = this.streamSettings.getRecordingStream(msos);\n          break;\n        case 'remote-recorder':\n          result = this.streamSettings.getRemoteRecordingStream(msos);\n          break;\n        case 'local':\n          result = this.streamSettings.getDefaultStream(msos);\n          break;\n        default:\n          const width = options?.video?.width;\n          const height = options?.video?.height;\n          const max = Math.max(width, height);\n          if (max) {\n            if (max > 1280) {\n              result = this.streamSettings.getDefaultStream(msos);\n            }\n            else if (max > 720) {\n              result = this.streamSettings.getRemoteStream(msos);\n            }\n            else {\n              result = this.streamSettings.getLowResolutionStream(msos);\n            }\n          }\n          else {\n            result = this.streamSettings.getDefaultStream(msos);\n          }\n          break;\n      }\n\n      id = result.stream.id;\n    }\n\n    let session = this.sessions.get(id);\n    let ffmpegInput: FFmpegInput;\n    if (!session)\n      throw new Error('stream not found');\n\n    ffmpegInput = await session.getVideoStream(true, options);\n\n    return mediaManager.createFFmpegMediaObject(ffmpegInput, {\n      sourceId: this.id,\n    });\n  }\n\n  async ensurePrebufferSessions() {\n    const msos = await this.mixinDevice.getVideoStreamOptions();\n    const enabled = this.getPrebufferedStreams(msos);\n    const enabledIds = enabled ? enabled.map(mso => mso.id) : [undefined];\n    const ids = msos?.map(mso => mso.id) || [undefined];\n\n    if (this.storage.getItem('warnedCloud') !== 'true') {\n      const cloud = msos?.find(mso => mso.source === 'cloud');\n      if (cloud) {\n        this.storage.setItem('warnedCloud', 'true');\n        log.a(`${this.name} is a cloud camera. Prebuffering maintains a persistent stream and will not be enabled by default. You must enable the Prebuffer stream manually.`)\n      }\n    }\n    if (this.storage.getItem('warnedSynthetic') !== 'true') {\n      const synthetic = msos?.find(mso => mso.source === 'synthetic');\n      if (synthetic) {\n        this.storage.setItem('warnedSynthetic', 'true');\n        log.a(`${this.name} is a synthetic stream requiring substantial transcoding overhead. Prebuffering maintains a persistent stream and will not be enabled by default. You must enable the Prebuffer stream manually.`)\n      }\n    }\n\n    // figure out the default stream and streams that may have been removed due to\n    // a config change.\n    const toRemove = new Set(this.sessions.keys());\n    toRemove.delete(undefined);\n    this.sessions.delete(undefined);\n\n    for (const id of ids) {\n      toRemove.delete(id);\n\n      let session = this.sessions.get(id);\n\n      if (session)\n        continue;\n\n      const mso = msos?.find(mso => mso.id === id);\n      if (mso?.prebuffer) {\n        log.a(`Prebuffer is already available on ${this.name}. If this is a grouped device, disable the Rebroadcast extension.`)\n      }\n      const name = mso?.name;\n      const enabled = enabledIds.includes(id);\n      session = new PrebufferSession(this, mso, enabled, mso.allowBatteryPrebuffer);\n      this.sessions.set(id, session);\n\n      if (!enabled) {\n        this.console.log('stream', name, 'is not enabled and will be rebroadcast on demand.');\n        continue;\n      }\n\n      if (session.shouldDisableBatteryPrebuffer()) {\n        this.console.log('camera is battery powered and either not charging or on low battery, prebuffering and rebroadcasting will only work on demand.');\n      }\n\n      (async () => {\n        while (this.sessions.get(id) === session && !this.released) {\n          if (session.shouldDisableBatteryPrebuffer()) {\n            // since battery devices could be eligible for prebuffer, check periodically\n            // in the event the battery device becomes eligible again\n            await new Promise(resolve => setTimeout(resolve, 60000));\n            continue;\n          }\n\n          session.ensurePrebufferSession();\n          try {\n            this.console.log(name, 'prebuffer session starting');\n            const ps = await session.parserSessionPromise;\n            await ps.killed;\n          }\n          catch (e) {\n          }\n          this.console.log(this.name, 'restarting prebuffer session in 5 seconds');\n          await new Promise(resolve => setTimeout(resolve, 5000));\n        }\n        this.console.log(name, 'exiting prebuffer session (released or restarted with new configuration)');\n      })();\n    }\n\n    for (const synthetic of this.streamSettings.storageSettings.values.synthenticStreams) {\n      const id = `synthetic:${synthetic}`;\n      toRemove.delete(id);\n\n      let session = this.sessions.get(id);\n\n      if (session)\n        continue;\n\n      session = new PrebufferSession(this, {\n        id: synthetic,\n      }, false, false);\n      this.sessions.set(id, session);\n      this.console.log('stream', synthetic, 'is synthetic and will be rebroadcast on demand.');\n    }\n\n    if (!this.sessions.has(undefined)) {\n      const defaultStreamName = this.streamSettings.storageSettings.values.defaultStream;\n      let defaultSession = this.sessions.get(msos?.find(mso => mso.name === defaultStreamName)?.id);\n      if (!defaultSession)\n        defaultSession = this.sessions.get(msos?.find(mso => mso.id === enabledIds[0])?.id);\n      if (!defaultSession)\n        defaultSession = this.sessions.get(msos?.find(mso => mso.id === ids?.[0])?.id);\n\n      if (defaultSession) {\n        this.sessions.set(undefined, defaultSession);\n        // this.console.log('Default Stream:', defaultSession.advertisedMediaStreamOptions.id, defaultSession.advertisedMediaStreamOptions.name);\n      }\n      else {\n        this.console.warn('Unable to find Default Stream?');\n      }\n    }\n\n    if (toRemove.size) {\n      this.console.log('Removing sessions due to config change', [...toRemove]);\n      for (const id of toRemove) {\n        const session = this.sessions.get(id);\n        this.sessions.delete(id);\n        session.release();\n      }\n    }\n  }\n\n  async getMixinSettings(): Promise<Setting[]> {\n    const settings: Setting[] = [];\n\n    settings.push(...await this.streamSettings.storageSettings.getSettings());\n\n    for (const session of new Set([...this.sessions.values()])) {\n      if (!session)\n        continue;\n      try {\n        settings.push(...await session.getMixinSettings());\n      }\n      catch (e) {\n        this.console.error('error in prebuffer session getMixinSettings', e);\n      }\n    }\n\n    return settings;\n  }\n\n  async reinitiatePrebufferSessions() {\n    const sessions = this.sessions;\n    this.sessions = new Map();\n    // kill and reinitiate the prebuffers.\n    for (const session of sessions.values()) {\n      session?.parserSessionPromise?.then(session => session.kill(new Error('rebroadcast settings changed')));\n    }\n    this.ensurePrebufferSessions();\n  }\n\n  async putMixinSetting(key: string, value: SettingValue): Promise<void> {\n    if (this.streamSettings.storageSettings.settings[key])\n      await this.streamSettings.storageSettings.putSetting(key, value);\n    else\n      this.storage.setItem(key, value?.toString() || '');\n\n    // no prebuffer change necessary if the setting is a transcoding hint.\n    if (this.streamSettings.storageSettings.settings[key]?.group === 'Transcoding')\n      return;\n\n    this.reinitiatePrebufferSessions();\n  }\n\n  getPrebufferedStreams(msos?: ResponseMediaStreamOptions[]) {\n    return this.streamSettings.getPrebufferedStreams(msos);\n  }\n\n  async getVideoStreamOptions(): Promise<ResponseMediaStreamOptions[]> {\n    const ret: ResponseMediaStreamOptions[] = await this.mixinDevice.getVideoStreamOptions() || [];\n    let enabledStreams = this.getPrebufferedStreams(ret);\n\n    const map = new Map<MediaStreamDestination, string>();\n    map.set('local', this.streamSettings.getDefaultStream(ret)?.stream?.id);\n    map.set('remote', this.streamSettings.getRemoteStream(ret)?.stream?.id);\n    map.set('medium-resolution', this.streamSettings.getRemoteRecordingStream(ret)?.stream?.id);\n    map.set('remote-recorder', this.streamSettings.getRemoteRecordingStream(ret)?.stream?.id);\n    map.set('local-recorder', this.streamSettings.getRecordingStream(ret)?.stream?.id);\n    map.set('low-resolution', this.streamSettings.getLowResolutionStream(ret)?.stream?.id);\n\n    for (const mso of ret) {\n      const session = this.sessions.get(mso.id);\n      if (session?.parserSession || enabledStreams.includes(mso))\n        mso.prebuffer = prebufferDurationMs;\n      if (!mso.destinations) {\n        mso.destinations = [];\n        for (const [k, v] of map.entries()) {\n          if (v === mso.id)\n            mso.destinations.push(k);\n        }\n      }\n    }\n\n    return ret;\n  }\n\n  async release() {\n    closeQuiet(this.rtspServer);\n    this.settingsListener.removeListener();\n    this.videoCameraListener.removeListener();\n    this.online = true;\n    super.release();\n    this.console.log('prebuffer sessions releasing if started');\n    this.released = true;\n    for (const session of this.sessions.values()) {\n      session?.release();\n    }\n  }\n}\n\nfunction millisUntilMidnight() {\n  var midnight = new Date();\n  midnight.setHours(24);\n  midnight.setMinutes(0);\n  midnight.setSeconds(0);\n  midnight.setMilliseconds(0);\n  return (midnight.getTime() - new Date().getTime());\n}\n\nexport class RebroadcastPlugin extends AutoenableMixinProvider implements MixinProvider, BufferConverter, Settings, Settings {\n  // no longer in use, but kept for future use.\n  storageSettings = new StorageSettings(this, {\n    defaultRtspParser: {\n      group: 'Advanced',\n      title: 'Default RTSP Parser',\n      description: `Experimental: The Default parser used to read RTSP streams. The default is \"${SCRYPTED_PARSER_TCP}\".`,\n      defaultValue: STRING_DEFAULT,\n      choices: [\n        STRING_DEFAULT,\n        SCRYPTED_PARSER_TCP,\n        SCRYPTED_PARSER_UDP,\n        FFMPEG_PARSER_TCP,\n        FFMPEG_PARSER_UDP,\n      ],\n      onPut: () => {\n        this.log.a('Rebroadcast Plugin will restart momentarily.');\n        sdk.deviceManager.requestRestart();\n      }\n    }\n  });\n\n  currentMixins = new Map<PrebufferMixin, {\n    worker: ForkWorker,\n    id: string,\n  }>();\n\n  constructor(nativeId?: string) {\n    super(nativeId);\n\n    this.log.clearAlerts();\n\n    this.fromMimeType = 'x-scrypted/x-rfc4571';\n    this.toMimeType = ScryptedMimeTypes.FFmpegInput;\n\n    // trigger the prebuffer. do this on next tick\n    // to allow the mixins to spin up from this provider.\n    process.nextTick(() => {\n      for (const id of Object.keys(systemManager.getSystemState())) {\n        const device = systemManager.getDeviceById<VideoCamera>(id);\n        if (!device.mixins?.includes(this.id))\n          continue;\n        try {\n          device.getVideoStreamOptions();\n        }\n        catch (e) {\n          this.console.error('error triggering prebuffer', device.name, e);\n        }\n      }\n    });\n\n    // legacy transcode extension that needs to be removed.\n    if (sdk.deviceManager.getNativeIds().includes('transcode')) {\n      process.nextTick(() => {\n        deviceManager.onDeviceRemoved('transcode');\n      });\n    }\n  }\n\n  async getSettings(): Promise<Setting[]> {\n    return [\n      ...await this.storageSettings.getSettings(),\n    ];\n  }\n\n  putSetting(key: string, value: SettingValue): Promise<void> {\n    return this.storageSettings.putSetting(key, value);\n  }\n\n\n  async convert(data: Buffer, fromMimeType: string, toMimeType: string): Promise<Buffer> {\n    const json = JSON.parse(data.toString());\n    const { url, sdp } = json;\n\n    const parsedSdp = parseSdp(sdp);\n    const trackLookups = new Map<number, string>();\n    for (const msection of parsedSdp.msections) {\n      for (const pt of msection.payloadTypes) {\n        trackLookups.set(pt, msection.control);\n      }\n    }\n\n    const u = new URL(url);\n    if (!u.protocol.startsWith('tcp'))\n      throw new Error('rfc4751 url must be tcp');\n    const { clientPromise, url: clientUrl } = await listenZeroSingleClient('127.0.0.1');\n    const ffmpeg: FFmpegInput = {\n      url: clientUrl,\n      inputArguments: [\n        \"-rtsp_transport\", \"tcp\",\n        '-i', clientUrl.replace('tcp', 'rtsp'),\n      ]\n    };\n\n    clientPromise.then(async (client) => {\n      const rtsp = new RtspServer(client, sdp);\n      rtsp.console = this.console;\n      await rtsp.handlePlayback();\n      const socket = net.connect(parseInt(u.port), u.hostname);\n\n      client.on('close', () => {\n        socket.destroy();\n      });\n      socket.on('close', () => {\n        client.destroy();\n      })\n\n      while (true) {\n        const header = await readLength(socket, 2);\n        const length = header.readInt16BE(0);\n        const data = await readLength(socket, length);\n        const pt = data[1] & 0x7f;\n        const track = trackLookups.get(pt);\n        if (!track) {\n          client.destroy();\n          socket.destroy();\n          throw new Error('unknown payload type ' + pt);\n        }\n        rtsp.sendTrack(track, data, false);\n      }\n    });\n\n    return Buffer.from(JSON.stringify(ffmpeg));\n  }\n\n  async shouldEnableMixin(device: ScryptedDevice): Promise<boolean> {\n    return device.type === ScryptedDeviceType.Camera || device.type === ScryptedDeviceType.Doorbell;\n  }\n\n  shouldUnshiftMixin(device: ScryptedDevice): boolean {\n    return device.providedInterfaces.includes(ScryptedInterface.VideoCamera);\n  }\n\n  async canMixin(type: ScryptedDeviceType, interfaces: string[]): Promise<string[]> {\n    if (type !== ScryptedDeviceType.Doorbell && type !== ScryptedDeviceType.Camera)\n      return;\n    if (!interfaces.includes(ScryptedInterface.VideoCamera))\n      return;\n    const ret = [ScryptedInterface.VideoCamera, ScryptedInterface.Settings, ScryptedInterface.Online, REBROADCAST_MIXIN_INTERFACE_TOKEN];\n    return ret;\n  }\n\n  async getMixin(mixinDevice: any, mixinDeviceInterfaces: ScryptedInterface[], mixinDeviceState: WritableDeviceState) {\n    this.setHasEnabledMixin(mixinDeviceState.id);\n\n    const { id } = mixinDeviceState;\n    const forked = sdk.fork<RebroadcastPluginFork>();\n    const { worker } = forked;\n    const result = await forked.result;\n    const mixin = await result.newPrebufferMixin(mixinDevice, mixinDeviceInterfaces, mixinDeviceState);\n    this.currentMixins.set(mixin, {\n      worker,\n      id,\n    });\n    return mixin;\n  }\n\n  async releaseMixin(id: string, mixinDevice: PrebufferMixin) {\n    const worker = this.currentMixins.get(mixinDevice)?.worker;\n    this.currentMixins.delete(mixinDevice);\n    await mixinDevice.release().catch(() => { });\n    await sleep(1000);\n    worker?.terminate();\n  }\n}\n\nasync function newPrebufferMixin(mixinDevice: any, mixinDeviceInterfaces: ScryptedInterface[], mixinDeviceState: WritableDeviceState) {\n  return new PrebufferMixin({\n    mixinDevice,\n    mixinDeviceState,\n    mixinProviderNativeId: undefined,\n    mixinDeviceInterfaces,\n    group: \"Streams\",\n    groupKey: \"prebuffer\",\n  })\n}\n\nclass RebroadcastPluginFork {\n  newPrebufferMixin = newPrebufferMixin;\n}\n\nexport async function fork() {\n  return new RebroadcastPluginFork();\n}\n\nexport default RebroadcastPlugin;\n","module.exports = require(\"events\");","export function cloneDeep(o: any) {\n    if (!o)\n        return;\n    return JSON.parse(JSON.stringify(o));\n}\n","import { Readable } from 'stream';\nimport { once } from 'events';\n\nexport async function read16BELengthLoop(readable: Readable, options: {\n  headerLength: number;\n  offset?: number;\n  // optionally skip a header, and pause loop parsing until calee resumes.\n  skipHeader?: (header: Buffer, resumeRead: () => void) => boolean;\n  callback: (header: Buffer, data: Buffer) => void;\n}) {\n  let error: Error;\n  const { skipHeader, callback } = options;\n  const offset = options.offset || 0;\n  const headerLength = options.headerLength || 2;\n\n  readable.on('error', e => error = e);\n\n  let header: Buffer;\n  let length: number;\n  let skipCount = 0;\n  let readCount = 0;\n\n  const resumeRead = () => {\n    readCount++;\n    read();\n  }\n\n  const read = () => {\n    while (true) {\n      if (skipCount !== readCount)\n        return;\n      if (!header) {\n        header = readable.read(headerLength);\n        if (!header)\n          return;\n        if (skipHeader?.(header, resumeRead)) {\n          skipCount++;\n          header = undefined;\n          continue;\n        }\n        length = header.readUInt16BE(offset);\n      }\n      else {\n        const data = readable.read(length);\n        if (!data)\n          return;\n        callback(header, data);\n        header = undefined;\n      }\n    }\n  };\n\n  read();\n  readable.on('readable', read);\n\n  await once(readable, 'end');\n  throw new StreamEndError('read16BELengthLoop');\n}\n\nexport class StreamEndError extends Error {\n  constructor(where: string) {\n    super(`stream ended: ${where}`);\n  }\n}\n\nexport async function readLength(readable: Readable, length: number): Promise<Buffer> {\n  if (readable.readableEnded || readable.destroyed)\n    throw new StreamEndError('readLength start');\n\n  if (!length) {\n    return Buffer.alloc(0);\n  }\n\n  {\n    const ret = readable.read(length);\n    if (ret) {\n      return ret;\n    }\n  }\n\n  return new Promise((resolve, reject) => {\n    const r = () => {\n      const ret = readable.read(length);\n      if (ret) {\n        cleanup();\n        resolve(ret);\n        return;\n      }\n\n      if (readable.readableEnded || readable.destroyed)\n        reject(new StreamEndError('readLength readable'));\n    };\n\n    const e = () => {\n      cleanup();\n      reject(new StreamEndError('readLength end'));\n    };\n\n    const cleanup = () => {\n      readable.removeListener('readable', r);\n      readable.removeListener('end', e);\n    }\n\n    readable.on('readable', r);\n    readable.on('end', e);\n  });\n}\n\nconst CHARCODE_NEWLINE = '\\n'.charCodeAt(0);\n\nexport async function readUntil(readable: Readable, charCode: number) {\n  const queued: Buffer[] = [];\n  while (true) {\n    const available: Buffer = readable.read();\n    if (!available) {\n      await once(readable, 'readable');\n      continue;\n    }\n    const index = available.findIndex(b => b === charCode);\n    if (index === -1) {\n      queued.push(available);\n      continue;\n    }\n\n    const before = available.subarray(0, index);\n    queued.push(before);\n\n    const after = available.subarray(index + 1);\n    readable.unshift(after);\n    return Buffer.concat(queued).toString();\n  }\n}\n\nexport async function readLine(readable: Readable) {\n  return readUntil(readable, CHARCODE_NEWLINE);\n}\n\nexport async function readString(readable: Readable | Promise<Readable>) {\n  const buffer = await readBuffer(readable);\n  return buffer.toString();\n}\n\nexport async function readBuffer(readable: Readable | Promise<Readable>) {\n  const buffers: Buffer[] = [];\n  readable = await readable;\n  readable.on('data', buffer => {\n    buffers.push(buffer);\n  });\n  readable.resume();\n  await once(readable, 'end')\n  return Buffer.concat(buffers);\n}\n","export interface RefreshPromise<T> {\n    promise: Promise<T>;\n    cacheDuration: number;\n}\n\nexport function singletonPromise<T>(rp: undefined | RefreshPromise<T>, method: () => Promise<T>, cacheDuration = 0) {\n    if (rp?.promise)\n        return rp;\n\n    const promise = method();\n    if (!rp) {\n        rp = {\n            promise,\n            cacheDuration,\n        }\n    }\n    else {\n        rp.promise = promise;\n    }\n    promise.finally(() => setTimeout(() => rp.promise = undefined, rp.cacheDuration));\n    return rp;\n}\n\nexport class TimeoutError<T> extends Error {\n    constructor(public promise: Promise<T>) {\n        super('Operation Timed Out');\n    }\n}\n\nexport function timeoutPromise<T>(timeout: number, promise: Promise<T>): Promise<T> {\n    return new Promise<T>((resolve, reject) => {\n        const t = setTimeout(() => reject(new TimeoutError(promise)), timeout);\n\n        promise\n            .then(v => {\n                clearTimeout(t);\n                resolve(v);\n            })\n            .catch(e => {\n                clearTimeout(t);\n                reject(e);\n            });\n    })\n}\n\nexport function timeoutFunction<T>(timeout: number, f: (isTimedOut: () => boolean) => Promise<T>): Promise<T> {\n    return new Promise<T>((resolve, reject) => {\n        let isTimedOut = false;\n        const promise = f(() => isTimedOut);\n\n        const t = setTimeout(() => {\n            isTimedOut = true;\n            reject(new TimeoutError(promise));\n        }, timeout);\n\n        promise\n            .then(v => {\n                clearTimeout(t);\n                resolve(v);\n            })\n            .catch(e => {\n                clearTimeout(t);\n                reject(e);\n            });\n    })\n}\n\nexport function createPromiseDebouncer<T>() {\n    let current: Promise<T>;\n\n    return (func: () => Promise<T>): Promise<T> => {\n        if (!current)\n            current = func().finally(() => current = undefined);\n        return current;\n    }\n}\n\nexport function createMapPromiseDebouncer<T>() {\n    const map = new Map<string, Promise<T>>();\n\n    return (key: any, debounce: number, func: () => Promise<T>): Promise<T> => {\n        const keyStr = JSON.stringify(key);\n        let value = map.get(keyStr);\n        if (!value) {\n            value = func().finally(() => {\n                if (!debounce) {\n                    map.delete(keyStr);\n                    return;\n                }\n                setTimeout(() => map.delete(keyStr), debounce);\n            });\n            map.set(keyStr, value);\n        }\n        return value;\n    }\n}\n","import { createActivityTimeout } from '@scrypted/common/src/activity-timeout';\nimport { cloneDeep } from '@scrypted/common/src/clone-deep';\nimport { Deferred } from \"@scrypted/common/src/deferred\";\nimport { listenZeroSingleClient } from '@scrypted/common/src/listen-cluster';\nimport { ffmpegLogInitialOutput, safeKillFFmpeg, safePrintFFmpegArguments } from '@scrypted/common/src/media-helpers';\nimport { createRtspParser } from \"@scrypted/common/src/rtsp-server\";\nimport { StreamChunk, StreamParser } from '@scrypted/common/src/stream-parser';\nimport sdk, { FFmpegInput, RequestMediaStreamOptions, ResponseMediaStreamOptions } from \"@scrypted/sdk\";\nimport child_process, { ChildProcess, StdioOptions } from 'child_process';\nimport { EventEmitter } from 'events';\n\nconst { mediaManager } = sdk;\n\nexport interface ParserSession<T extends string> {\n    parserSpecific?: any;\n    sdp: Promise<string>;\n    resetActivityTimer?: () => void,\n    negotiateMediaStream(requestMediaStream: RequestMediaStreamOptions, inputVideoCodec: string, inputAudioCodec: string): ResponseMediaStreamOptions;\n    start(): void;\n    kill(error?: Error): void;\n    killed: Promise<void>;\n    isActive: boolean;\n\n    emit(container: T, chunk: StreamChunk): this;\n    on(container: T, callback: (chunk: StreamChunk) => void): this;\n    on(error: 'error', callback: (e: Error) => void): this;\n    removeListener(event: T | 'killed', callback: any): this;\n    once(event: T | 'killed', listener: (...args: any[]) => void): this;\n}\n\nexport interface ParserOptions<T extends string> {\n    parsers: { [container in T]?: StreamParser };\n    timeout?: number;\n    console: Console;\n    storage?: Storage;\n}\n\nexport async function parseResolution(cp: ChildProcess) {\n    return new Promise<string[]>((resolve, reject) => {\n        cp.on('exit', () => reject(new Error('ffmpeg exited while waiting to parse stream resolution')));\n        const parser = (data: Buffer) => {\n            const stdout = data.toString();\n            const res = /(([0-9]{2,5})x([0-9]{2,5}))/.exec(stdout);\n            if (res) {\n                cp.stdout.removeListener('data', parser);\n                cp.stderr.removeListener('data', parser);\n                resolve(res);\n            }\n        };\n        cp.stdout.on('data', parser);\n        cp.stderr.on('data', parser);\n    });\n}\n\nasync function parseInputToken(cp: ChildProcess, token: string) {\n    let processed = 0;\n    return new Promise<string>((resolve, reject) => {\n        cp.on('exit', () => reject(new Error('ffmpeg exited while waiting to parse stream information: ' + token)));\n        const parser = (data: Buffer) => {\n            processed += data.length;\n            if (processed > 10000)\n                return resolve(undefined);\n            const stdout: string = data.toString().split('Output ')[0];\n            const idx = stdout.lastIndexOf(`${token}: `);\n            if (idx !== -1) {\n                const check = stdout.substring(idx + token.length + 1).trim();\n                let next = check.indexOf(' ');\n                const next2 = check.indexOf(',');\n                if (next !== -1 && next2 < next)\n                    next = next2;\n                if (next !== -1) {\n                    cp.stdout.removeListener('data', parser);\n                    cp.stderr.removeListener('data', parser);\n                    resolve(check.substring(0, next));\n                }\n            }\n        };\n        cp.stdout.on('data', parser);\n        cp.stderr.on('data', parser);\n    })\n        .finally(() => {\n            cp.stdout.removeAllListeners('data');\n            cp.stderr.removeAllListeners('data');\n        });\n}\n\nexport async function parseVideoCodec(cp: ChildProcess) {\n    return parseInputToken(cp, 'Video');\n}\n\nexport async function parseAudioCodec(cp: ChildProcess) {\n    return parseInputToken(cp, 'Audio');\n}\n\nexport function setupActivityTimer(container: string, kill: (error?: Error) => void, events: {\n    once(event: 'killed', callback: () => void): void,\n}, timeout: number) {\n    const ret = createActivityTimeout(timeout, () => {\n        const str = 'timeout waiting for data, killing parser session';\n        console.error(str, container);\n        kill(new Error(str));\n    });\n    events.once('killed', () => ret.clearActivityTimer());\n    return ret;\n}\n\nexport async function startParserSession<T extends string>(ffmpegInput: FFmpegInput, options: ParserOptions<T>): Promise<ParserSession<T>> {\n    const { console } = options;\n\n    let isActive = true;\n    const events = new EventEmitter();\n    // need this to prevent kill from throwing due to uncaught Error during cleanup\n    events.on('error', () => {});\n\n    let sessionKilled: any;\n    const killed = new Promise<void>(resolve => {\n        sessionKilled = resolve;\n    });\n\n    const sdpDeferred = new Deferred<string>();\n    function kill(error?: Error) {\n        error ||= new Error('killed');\n        if (isActive) {\n            events.emit('killed');\n            events.emit('error', error);\n        }\n        if (!sdpDeferred.finished)\n            sdpDeferred.reject(error);\n        isActive = false;\n        sessionKilled();\n        safeKillFFmpeg(cp);\n    }\n\n\n    const args = ffmpegInput.inputArguments.slice();\n    const env = ffmpegInput.env ? { ...process.env, ...ffmpegInput.env } : undefined;\n\n    const ensureActive = (killed: () => void) => {\n        if (!isActive) {\n            killed();\n            throw new Error('parser session was killed killed before ffmpeg connected');\n        }\n        events.on('killed', killed);\n    }\n\n    // first see how many pipes are needed, and prep them for the child process\n    const stdio: StdioOptions = ['pipe', 'pipe', 'pipe']\n    let pipeCount = 3;\n    const startParsers: (() => void)[] = [];\n    for (const container of Object.keys(options.parsers)) {\n        const parser: StreamParser = options.parsers[container as T];\n\n        if (parser.tcpProtocol) {\n            const tcp = await listenZeroSingleClient('127.0.0.1');\n            const url = new URL(parser.tcpProtocol);\n            url.port = tcp.port.toString();\n            args.push(\n                ...parser.outputArguments,\n                url.toString(),\n            );\n\n            const { resetActivityTimer } = setupActivityTimer(container, kill, events, options?.timeout);\n\n            startParsers.push(async () => {\n                const socket = await tcp.clientPromise;\n                try {\n                    ensureActive(() => socket.destroy());\n\n                    for await (const chunk of parser.parse(socket, undefined, undefined)) {\n                        events.emit(container, chunk);\n                        resetActivityTimer();\n                    }\n                }\n                catch (e) {\n                    console.error('rebroadcast parse error', e);\n                    kill(e);\n                }\n            });\n        }\n        else {\n            args.push(\n                ...parser.outputArguments,\n                `pipe:${pipeCount++}`,\n            );\n            stdio.push('pipe');\n        }\n    }\n\n    // start ffmpeg process with child process pipes\n    args.unshift('-hide_banner');\n    safePrintFFmpegArguments(console, args);\n    const cp = child_process.spawn(ffmpegInput.ffmpegPath || await mediaManager.getFFmpegPath(), args, {\n        stdio,\n        env,\n    });\n    ffmpegLogInitialOutput(console, cp, undefined, options?.storage);\n    cp.on('exit', () => kill(new Error('ffmpeg exited')));\n\n    const deferredStart = new Deferred<void>();\n    // now parse the created pipes\n    const start = () => {\n        for (const p of startParsers) {\n            p();\n        }\n\n        let pipeIndex = 0;\n        Object.keys(options.parsers).forEach(async (container) => {\n            const parser: StreamParser = options.parsers[container as T];\n            if (!parser.parse || parser.tcpProtocol)\n                return;\n            const pipe = cp.stdio[3 + pipeIndex];\n            pipeIndex++;\n\n            try {\n                const { resetActivityTimer } = setupActivityTimer(container, kill, events, options?.timeout);\n\n                for await (const chunk of parser.parse(pipe as any, undefined, undefined)) {\n                    await deferredStart.promise;\n                    events.emit(container, chunk);\n                    resetActivityTimer();\n                }\n            }\n            catch (e) {\n                console.error('rebroadcast parse error', e);\n                kill(e);\n            }\n        });\n    };\n\n    const rtsp = (options.parsers as any).rtsp as ReturnType<typeof createRtspParser>;\n    rtsp.sdp.then(sdp => {\n        console?.log('sdp received from ffmpeg', sdp);\n        sdpDeferred.resolve(sdp);\n    });\n\n    start();\n\n    return {\n        start() {\n            deferredStart.resolve();\n        },\n        sdp: sdpDeferred.promise,\n        get isActive() { return isActive },\n        kill(error?: Error) {\n            kill(error);\n        },\n        killed,\n        negotiateMediaStream: (requestMediaStream: RequestMediaStreamOptions, inputVideoCodec, inputAudioCodec) => {\n            const ret: ResponseMediaStreamOptions = cloneDeep(ffmpegInput.mediaStreamOptions) || {\n                id: undefined,\n                name: undefined,\n            };\n\n            if (!ret.video)\n                ret.video = {};\n\n            ret.video.codec = inputVideoCodec;\n\n            // reported codecs may be wrong/cached/etc, so before blindly copying the audio codec info,\n            // verify what was found.\n            if (ret?.audio?.codec === inputAudioCodec) {\n                ret.audio = ffmpegInput?.mediaStreamOptions?.audio;\n            }\n            else {\n                ret.audio = {\n                    codec: inputAudioCodec,\n                }\n            }\n\n            return ret;\n        },\n        emit(container: T, chunk: StreamChunk) {\n            events.emit(container, chunk);\n            return this;\n        },\n        on(event: string, cb: any) {\n            events.on(event, cb);\n            return this;\n        },\n        once(event: any, cb: any) {\n            events.once(event, cb);\n            return this;\n        },\n        removeListener(event, cb) {\n            events.removeListener(event, cb);\n            return this;\n        }\n    };\n}\n","import dgram, { SocketType } from 'dgram';\nimport { once } from 'events';\nimport net from 'net';\n\nexport async function closeQuiet(socket: dgram.Socket | net.Server) {\n    if (!socket)\n        return;\n    try {\n        await new Promise((r, f) => {\n            try {\n                socket.close(r);\n            }\n            catch (e) {\n                f(e);\n            }\n        });\n    }\n    catch (e) {\n    }\n}\n\nexport async function bindUdp(server: dgram.Socket, usePort: number, address?: string) {\n    server.bind(usePort, address);\n    await once(server, 'listening');\n    const port = server.address().port;\n    return {\n        port,\n        url: `udp://127.0.0.1:${port}`,\n    }\n}\n\nexport async function bindZero(server: dgram.Socket) {\n    return bindUdp(server, 0);\n}\n\nexport async function createBindZero(socketType?: SocketType) {\n    return createBindUdp(0, socketType);\n}\n\nexport async function createSquentialBindZero(socketType?: SocketType) {\n    let attempts = 0;\n    while (true) {\n        const rtpServer = await createBindZero(socketType);\n        try {\n            const rtcpServer = await createBindUdp(rtpServer.port + 1, socketType);\n            return [rtpServer, rtcpServer];\n        }\n        catch (e) {\n            attempts++;\n            closeQuiet(rtpServer.server);\n        }\n        if (attempts === 10)\n            throw new Error('unable to reserve sequential udp ports')\n    }\n}\n\nexport async function reserveUdpPort() {\n    const udp = await createBindZero();\n    await new Promise(resolve => udp.server.close(() => resolve(undefined)));\n    return udp.port;\n}\n\nexport async function createBindUdp(usePort: number, socketType?: SocketType) {\n    const server = dgram.createSocket(socketType || 'udp4');\n    const { port, url } = await bindUdp(server, usePort);\n    return {\n        server,\n        port,\n        url,\n    };\n}\n\nexport async function bind(server: dgram.Socket, port: number) {\n    server.bind(port);\n    await once(server, 'listening');\n    return {\n        port,\n        url: `udp://127.0.0.1:${port}`,\n    }\n}\n\nexport { ListenZeroSingleClientTimeoutError, listenZero, listenZeroSingleClient } from \"../../server/src/listen-zero\";\n","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"os\");","import os from 'os';\n/**\n * A YError class able to contain some params and\n *  print better stack traces\n * @extends Error\n */\nclass YError extends Error {\n    code;\n    params;\n    wrappedErrors;\n    constructor(wrappedErrors, errorCode, ...params) {\n        // Detecting if wrappedErrors are passed\n        if (!(wrappedErrors instanceof Array)) {\n            params = ('undefined' === typeof errorCode ? [] : [errorCode]).concat(params);\n            errorCode = wrappedErrors;\n            wrappedErrors = [];\n        }\n        // Call the parent constructor\n        super(errorCode);\n        // Filling error\n        this.code = errorCode || 'E_UNEXPECTED';\n        this.params = params;\n        this.wrappedErrors = wrappedErrors;\n        this.name = this.toString();\n        if (Error.captureStackTrace) {\n            Error.captureStackTrace(this, this.constructor);\n        }\n    }\n    /**\n     * Wraps any error and output a YError with an error\n     *  code and some params as debug values.\n     * @param {Error} err\n     * The error to wrap\n     * @param {string} [errorCode = 'E_UNEXPECTED']\n     * The error code corresponding to the actual error\n     * @param {...YErrorParams} [params]\n     * Some additional debugging values\n     * @return {YError}\n     * The wrapped error\n     */\n    static wrap(err, errorCode, ...params) {\n        const wrappedErrorIsACode = _looksLikeAYErrorCode(err.message);\n        const wrappedErrors = ('wrappedErrors' in err ? err.wrappedErrors : []).concat(err);\n        if (!errorCode) {\n            if (wrappedErrorIsACode) {\n                errorCode = err.message;\n            }\n            else {\n                errorCode = 'E_UNEXPECTED';\n            }\n        }\n        if (err.message && !wrappedErrorIsACode) {\n            params.push(err.message);\n        }\n        return new YError(wrappedErrors, errorCode, ...params);\n    }\n    /**\n     * Return a YError as is or wraps any other error and output\n     *  a YError with a code and some params as debug values.\n     * @param {Error} err\n     * The error to cast\n     * @param {string} [errorCode = 'E_UNEXPECTED']\n     * The error code corresponding to the actual error\n     * @param {...YErrorParams} [params]\n     * Some additional debugging values\n     * @return {YError}\n     * The wrapped error\n     */\n    static cast(err, errorCode, ...params) {\n        if (_looksLikeAYError(err)) {\n            return err;\n        }\n        return YError.wrap(err, errorCode, ...params);\n    }\n    /**\n     * Same than `YError.wrap()` but preserves the code\n     *  and the debug values of the error if it is\n     *  already an instance of the YError constructor.\n     * @param {Error} err\n     * The error to bump\n     * @param {string} [errorCode = 'E_UNEXPECTED']\n     * The error code corresponding to the actual error\n     * @param {...YErrorParams} [params]\n     * Some additional debugging values\n     * @return {YError}\n     * The wrapped error\n     */\n    static bump(err, errorCode, ...params) {\n        if (_looksLikeAYError(err)) {\n            return YError.wrap(err, err.code, ...err.params);\n        }\n        return YError.wrap(err, errorCode, ...params);\n    }\n    toString() {\n        return ((this.wrappedErrors.length\n            ? // eslint-disable-next-line\n                this.wrappedErrors[this.wrappedErrors.length - 1].stack + os.EOL\n            : '') +\n            this.constructor.name +\n            ': ' +\n            this.code +\n            ' (' +\n            this.params.join(', ') +\n            ')');\n    }\n}\n/**\n * Allow to print a stack from anything (especially catched\n *  errors that may or may not contain errors ).\n * @param {Error} err\n * The error to print\n * @return {string}\n * The stack trace if any\n */\nexport function printStackTrace(err) {\n    return typeof err === 'object' && typeof err.stack === 'string'\n        ? err.stack\n        : `[no_stack_trace]: error is ${err != null && typeof err.toString === 'function'\n            ? err.toString()\n            : typeof err}`;\n}\n// In order to keep compatibility through major versions\n// we have to make kind of an cross major version instanceof\nfunction _looksLikeAYError(err) {\n    return (!!(err instanceof YError) ||\n        !!(err.constructor &&\n            err.constructor.name &&\n            err.constructor.name.endsWith('Error') &&\n            'code' in err &&\n            'string' === typeof err.code &&\n            _looksLikeAYErrorCode(err.code) &&\n            'params' in err &&\n            err.params &&\n            err.params instanceof Array));\n}\nfunction _looksLikeAYErrorCode(str) {\n    return /^([A-Z0-9_]+)$/.test(str);\n}\nexport { YError };\n//# sourceMappingURL=index.js.map","export const REBROADCAST_MIXIN_INTERFACE_TOKEN = 'mixin:@scrypted/prebuffer-mixin';\n","export function createActivityTimeout(timeout: number, timeoutCallback: () => void) {\n    let dataTimeout: NodeJS.Timeout;\n\n    let lastTime = Date.now();\n    function resetActivityTimer() {\n        lastTime = Date.now();\n    }\n\n    function clearActivityTimer() {\n        clearInterval(dataTimeout);\n    }\n\n    if (timeout) {\n        dataTimeout = setInterval(() => {\n            if (Date.now() > lastTime + timeout) {\n                clearInterval(dataTimeout);\n                dataTimeout = undefined;\n                timeoutCallback();\n            }\n        }, timeout);\n    }\n\n    resetActivityTimer();\n    return {\n        resetActivityTimer,\n        clearActivityTimer,\n    }\n}\n","export async function sleep(ms: number) {\n    await new Promise(resolve => setTimeout(resolve, ms));\n}\n","export { safeKillFFmpeg, ffmpegLogInitialOutput, safePrintFFmpegArguments } from '../../server/src/media-helpers';\n","import { once } from 'events';\nimport net from 'net';\nimport tls from 'tls';\n\nexport class ListenZeroSingleClientTimeoutError extends Error {\n    constructor() {\n        super('timeout waiting for client')\n    }\n}\n\nexport async function listenZero(server: net.Server, hostname: string) {\n    server.listen(0, hostname || '127.0.0.1');\n    await once(server, 'listening');\n    return (server.address() as net.AddressInfo).port;\n}\n\nexport async function listenZeroSingleClient(hostname: string, options?: net.ServerOpts & { tls?: boolean }, listenTimeout = 30000) {\n    const server = options?.tls ? new tls.Server(options) : new net.Server(options);\n    const port = await listenZero(server, hostname);\n\n    let cancel: () => void;\n    const clientPromise = new Promise<net.Socket>((resolve, reject) => {\n        const timeout = setTimeout(() => {\n            server.close();\n            reject(new ListenZeroSingleClientTimeoutError());\n        }, listenTimeout);\n        cancel = () => {\n            clearTimeout(timeout);\n            server.close();\n        };\n        server.on('connection', client => {\n            cancel();\n            resolve(client);\n        });\n    });\n\n    clientPromise.catch(() => { });\n\n    let host = hostname;\n    if (!host || host === '0.0.0.0')\n        host = '127.0.0.1';\n\n    return {\n        server,\n        cancel,\n        url: `tcp://${host}:${port}`,\n        host,\n        port,\n        clientPromise,\n    }\n}\n","import { closeQuiet } from \"@scrypted/common/src/listen-cluster\";\nimport { RTSP_FRAME_MAGIC, RtspClient, RtspClientUdpSetupOptions, parseSemicolonDelimited } from \"@scrypted/common/src/rtsp-server\";\nimport { parseSdp } from \"@scrypted/common/src/sdp-utils\";\nimport { StreamChunk } from \"@scrypted/common/src/stream-parser\";\nimport { ResponseMediaStreamOptions } from \"@scrypted/sdk\";\nimport dgram from 'dgram';\nimport { EventEmitter } from \"stream\";\nimport { ParserSession, setupActivityTimer } from \"./ffmpeg-rebroadcast\";\nimport { negotiateMediaStream } from \"./rfc4571\";\n\nexport type RtspChannelCodecMapping = { [key: number]: string };\n\nexport interface RtspSessionParserSpecific {\n    interleaved: Map<string, number>;\n}\n\nexport async function startRtspSession(console: Console, url: string, mediaStreamOptions: ResponseMediaStreamOptions, options: {\n    useUdp: boolean,\n    audioSoftMuted: boolean,\n    rtspRequestTimeout: number,\n}): Promise<ParserSession<\"rtsp\">> {\n    let isActive = true;\n    const events = new EventEmitter();\n    // need this to prevent kill from throwing due to uncaught Error during cleanup\n    events.on('error', () => {});\n\n    let servers: dgram.Socket[] = [];\n    const rtspClient = new RtspClient(url);\n    rtspClient.console = console;\n    rtspClient.requestTimeout = options.rtspRequestTimeout;\n\n    const cleanupSockets = () => {\n        for (const server of servers) {\n            closeQuiet(server);\n        }\n        rtspClient.safeTeardown();\n    }\n\n    let sessionKilled: any;\n    const killed = new Promise<void>(resolve => {\n        sessionKilled = resolve;\n    });\n\n    const kill = (error?: Error) => {\n        if (isActive) {\n            events.emit('killed');\n            events.emit('error', error || new Error('killed'));\n        }\n        isActive = false;\n        sessionKilled();\n        cleanupSockets();\n    };\n\n    rtspClient.client.on('close', () => {\n        kill(new Error('rtsp socket closed'));\n    });\n    rtspClient.client.on('error', e => {\n        kill(e);\n    });\n\n    const { resetActivityTimer } = setupActivityTimer('rtsp', kill, events, options?.rtspRequestTimeout);\n\n    try {\n        await rtspClient.options();\n        const sdpResponse = await rtspClient.describe();\n        let sdp = sdpResponse.body.toString().trim();\n        console.log('sdp', sdp);\n\n        const parsedSdp = parseSdp(sdp);\n        let channel = 0;\n        const mapping: RtspChannelCodecMapping = {};\n        let udpSessionTimeout: number;\n        const { useUdp } = options;\n        const checkUdpSessionTimeout = (headers: { [key: string]: string }) => {\n            if (useUdp && headers.session && !udpSessionTimeout) {\n                const sessionDict = parseSemicolonDelimited(headers.session);\n                udpSessionTimeout = parseInt(sessionDict['timeout']);\n            }\n        }\n\n        let parserSpecific: RtspSessionParserSpecific;\n        if (!useUdp) {\n            parserSpecific = {\n                interleaved: new Map(),\n            }\n        }\n\n        const doSetup = async (control: string, codec: string) => {\n            let udp: dgram.Socket;\n            if (useUdp) {\n                const rtspChannel = channel;\n\n                const setup: RtspClientUdpSetupOptions = {\n                    path: control,\n                    type: 'udp',\n                    onRtp: (header, data) => {\n                        const prefix = Buffer.alloc(4);\n                        prefix.writeUInt8(RTSP_FRAME_MAGIC, 0);\n                        prefix.writeUInt8(rtspChannel, 1);\n                        prefix.writeUInt16BE(data.length, 2);\n                        const chunk: StreamChunk = {\n                            chunks: [prefix, data],\n                            type: codec,\n                        };\n                        events.emit('rtsp', chunk);\n                        resetActivityTimer?.();\n                    },\n                };\n                const setupResult = await rtspClient.setup(setup);\n                udp = setup.dgram;\n                checkUdpSessionTimeout(setupResult.headers);\n\n                const punch = Buffer.alloc(1);\n                const transport = setupResult.headers['transport'];\n                const match = transport.match(/.*?server_port=([0-9]+)-([0-9]+)/);\n                const [_, rtp, rtcp] = match;\n                const rtpPort = parseInt(rtp);\n                // have seen some servers return a server_port 0. should watch for bad data in any case.\n                if (rtpPort) {\n                    const { hostname } = new URL(rtspClient.url);\n                    udp.send(punch, rtpPort, hostname)\n                }\n                mapping[channel] = codec;\n            }\n            else {\n                const setupResult = await rtspClient.setup({\n                    path: control,\n                    type: 'tcp',\n                    port: channel,\n                    onRtp: (header, data) => {\n                        const chunk: StreamChunk = {\n                            chunks: [header, data],\n                            type: codec,\n                        };\n                        events.emit('rtsp', chunk);\n                        resetActivityTimer?.();\n                    },\n                });\n\n                const resultChannel = setupResult.interleaved ? setupResult.interleaved.begin : channel;\n                mapping[resultChannel] = codec;\n                parserSpecific.interleaved.set(codec, resultChannel);\n            }\n\n            channel += 2;\n        }\n\n        let setupVideoSection = false;\n\n        parsedSdp.msections = parsedSdp.msections.filter(section => {\n            if (section.type === 'video') {\n                if (setupVideoSection) {\n                    console.warn('additional video section found. skipping.');\n                    return false;\n                }\n                setupVideoSection = true;\n            }\n            else if (section.type !== 'audio') {\n                console.warn('unknown section', section.type);\n                return false;\n            }\n            else if (options.audioSoftMuted) {\n                return false;\n            }\n            return true;\n        });\n\n        for (const section of parsedSdp.msections) {\n            await doSetup(section.control, section.codec)\n        }\n\n        // sdp may contain multiple audio/video sections. take only the first video section.\n        sdp = [...parsedSdp.header.lines, ...parsedSdp.msections.map(msection => msection.lines).flat()].join('\\r\\n');\n\n        // don't start parsing until next tick when this function returns to allow\n        // event handlers to be set prior to parsing.\n        const start = async () => {\n            try {\n                await rtspClient.play();\n                rtspClient.console = undefined;\n                await rtspClient.readLoop();\n            }\n            catch (e) {\n                kill(e);\n            }\n            finally {\n                kill(new Error('rtsp read loop exited'));\n            }\n        };\n\n        // this return block is intentional, to ensure that the remaining code happens sync.\n        return (() => {\n            const videoSection = parsedSdp.msections.find(msection => msection.type === 'video');\n\n            if (!videoSection)\n                throw new Error('SDP does not contain a video section!');\n\n            return {\n                parserSpecific,\n                start,\n                sdp: Promise.resolve(sdp),\n                get isActive() { return isActive },\n                kill(error?: Error) {\n                    kill(error);\n                },\n                killed,\n                resetActivityTimer,\n                negotiateMediaStream: (requestMediaStream, inputVideoCodec, inputAudioCodec) => {\n                    return negotiateMediaStream(sdp, mediaStreamOptions, inputVideoCodec, inputAudioCodec, requestMediaStream);\n                },\n                emit(container: 'rtsp', chunk: StreamChunk) {\n                    events.emit(container, chunk);\n                    return this;\n                },\n                on(event: string, cb: any) {\n                    events.on(event, cb);\n                    return this;\n                },\n                once(event: any, cb: any) {\n                    events.once(event, cb);\n                    return this;\n                },\n                removeListener(event, cb) {\n                    events.removeListener(event, cb);\n                    return this;\n                }\n            }\n        })();\n    }\n    catch (e) {\n        cleanupSockets();\n        throw e;\n    }\n}\n","import { cloneDeep } from \"@scrypted/common/src/clone-deep\";\nimport { read16BELengthLoop } from \"@scrypted/common/src/read-stream\";\nimport { H264_NAL_TYPE_SPS, RTSP_FRAME_MAGIC, findH264NaluType } from \"@scrypted/common/src/rtsp-server\";\nimport { parseSdp } from \"@scrypted/common/src/sdp-utils\";\nimport { StreamChunk } from \"@scrypted/common/src/stream-parser\";\nimport { MediaStreamOptions, ResponseMediaStreamOptions } from \"@scrypted/sdk\";\nimport { parse as spsParse } from \"h264-sps-parser\";\nimport net from 'net';\nimport { EventEmitter, Readable } from \"stream\";\nimport { ParserSession, setupActivityTimer } from \"./ffmpeg-rebroadcast\";\nimport { getSpsResolution } from \"./sps-resolution\";\n\nexport function negotiateMediaStream(sdp: string, mediaStreamOptions: MediaStreamOptions, inputVideoCodec: string, inputAudioCodec: string, requestMediaStream: MediaStreamOptions) {\n    const parsedSdp = parseSdp(sdp);\n    const ret: ResponseMediaStreamOptions = cloneDeep(mediaStreamOptions) || {\n        id: undefined,\n        name: undefined,\n    };\n\n    // if the source doesn't provide a video codec, dummy one up\n    if (ret.video === undefined)\n        ret.video = {};\n\n    // the requests does not want video\n    if (requestMediaStream?.video === null)\n        ret.video = null;\n\n    if (ret.video)\n        ret.video.codec = inputVideoCodec;\n\n    // some rtsp like unifi offer alternate audio tracks (aac and opus).\n    if (requestMediaStream?.audio?.codec && requestMediaStream?.audio?.codec !== inputAudioCodec) {\n        const alternateAudio = parsedSdp.msections.find(msection => msection.type === 'audio' && msection.codec === requestMediaStream?.audio?.codec);\n        if (alternateAudio) {\n            ret.audio = {\n                codec: requestMediaStream?.audio?.codec,\n            };\n\n            return ret;\n        }\n    }\n\n    // reported codecs may be wrong/cached/etc, so before blindly copying the audio codec info,\n    // verify what was found.\n    if (ret?.audio?.codec === inputAudioCodec) {\n        ret.audio = mediaStreamOptions?.audio;\n    }\n    else {\n        ret.audio = {\n            codec: inputAudioCodec,\n        }\n    }\n\n    return ret;\n}\n\nexport function connectRFC4571Parser(url: string) {\n    const u = new URL(url);\n    if (!u.protocol.startsWith('tcp'))\n        throw new Error('rfc4751 url must be tcp');\n\n    const socket = net.connect(parseInt(u.port), u.hostname);\n    return socket;\n}\n\nexport function startRFC4571Parser(console: Console, socket: Readable, sdp: string, mediaStreamOptions: ResponseMediaStreamOptions, options?: {\n    timeout?: number,\n}): ParserSession<\"rtsp\"> {\n    let isActive = true;\n    const events = new EventEmitter();\n    // need this to prevent kill from throwing due to uncaught Error during cleanup\n    events.on('error', () => {});\n\n    const parsedSdp = parseSdp(sdp);\n    const audioSection = parsedSdp.msections.find(msection => msection.type === 'audio');\n    const videoSection = parsedSdp.msections.find(msection => msection.type === 'video');\n    const audioPt = audioSection?.payloadTypes?.[0];\n    const videoPt = videoSection?.payloadTypes?.[0];\n\n    const inputAudioCodec = audioSection?.codec;\n    const inputVideoCodec = videoSection.codec;\n\n    let sessionKilled: any;\n    const killed = new Promise<void>(resolve => {\n        sessionKilled = resolve;\n    });\n\n    const kill = (error?: Error) => {\n        if (isActive) {\n            events.emit('killed');\n            events.emit('error', error || new Error('killed'));\n        }\n        isActive = false;\n        sessionKilled();\n        socket.destroy();\n    };\n\n    socket.on('close', () => {\n        kill(new Error('rfc4751 socket closed'));\n    });\n    socket.on('error', e => {\n        kill(e);\n    });\n\n    const { resetActivityTimer } = setupActivityTimer('rtsp', kill, events, options?.timeout);\n\n    let inputVideoResolution: {\n        width: number;\n        height: number;\n    };\n\n    const sprop = videoSection\n        ?.fmtp?.[0]?.parameters?.['sprop-parameter-sets'];\n    const sdpSps = sprop?.split(',')?.[0];\n    // const sdpPps = sprop?.split(',')?.[1];\n\n    if (sdpSps) {\n        try {\n            const sps = Buffer.from(sdpSps, 'base64');\n            const parsedSps = spsParse(sps);\n            inputVideoResolution = getSpsResolution(parsedSps);\n            console.log('parsed sdp sps', parsedSps);\n        }\n        catch (e) {\n            console.warn('sdp sps parsing failed', e);\n        }\n    }\n\n    const start = () => {\n        // don't start parsing until next tick, to prevent missed packets.\n        read16BELengthLoop(socket, {\n            headerLength: 2,\n            skipHeader: undefined,\n            callback: (header, data) => {\n                let type: string;\n                const pt = data[1] & 0x7f;\n\n                const prefix = Buffer.alloc(2);\n                prefix[0] = RTSP_FRAME_MAGIC;\n                if (pt === audioPt) {\n                    prefix[1] = 0;\n                }\n                else if (pt === videoPt) {\n                    prefix[1] = 2;\n                }\n                header = Buffer.concat([prefix, header]);\n\n                if (pt === audioPt)\n                    type = inputAudioCodec;\n                else if (pt === videoPt)\n                    type = inputVideoCodec;\n\n                const chunk: StreamChunk = {\n                    chunks: [header, data],\n                    type,\n                };\n\n                if (!inputVideoResolution) {\n                    const sps = findH264NaluType(chunk, H264_NAL_TYPE_SPS);\n                    if (sps) {\n                        try {\n                            const parsedSps = spsParse(sps);\n                            inputVideoResolution = getSpsResolution(parsedSps);\n                            console.log(inputVideoResolution);\n                            console.log('parsed bitstream sps', parsedSps);\n                        }\n                        catch (e) {\n                            console.warn('sps parsing failed');\n                            inputVideoResolution = {\n                                width: NaN,\n                                height: NaN,\n                            }\n                        }\n                    }\n                }\n\n                events.emit('rtsp', chunk);\n                if (chunk.type === inputVideoCodec)\n                    resetActivityTimer();\n            }\n        })\n            .catch(e => {\n                throw e;\n            })\n            .finally(() => {\n                kill(new Error('parser exited'));\n            });\n    };\n\n\n\n    return {\n        start,\n        sdp: Promise.resolve(sdp),\n        get isActive() { return isActive },\n        kill(error?: Error) {\n            kill(error);\n        },\n        killed,\n        resetActivityTimer,\n        negotiateMediaStream: (requestMediaStream,inputVideoCodec, inputAudioCodec) => {\n            return negotiateMediaStream(sdp, mediaStreamOptions, inputVideoCodec, inputAudioCodec, requestMediaStream);\n        },\n        emit(container: 'rtsp', chunk: StreamChunk) {\n            events.emit(container, chunk);\n            return this;\n        },\n        on(event: string, cb: any) {\n            events.on(event, cb);\n            return this;\n        },\n        once(event: any, cb: any) {\n            events.once(event, cb);\n            return this;\n        },\n        removeListener(event, cb) {\n            events.removeListener(event, cb);\n            return this;\n        }\n    }\n}\n","export { sleep } from \"../../server/src/sleep\";\n","\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    var desc = Object.getOwnPropertyDescriptor(m, k);\n    if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n      desc = { enumerable: true, get: function() { return m[k]; } };\n    }\n    Object.defineProperty(o, k2, desc);\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.sdk = exports.MixinDeviceBase = exports.ScryptedDeviceBase = void 0;\n__exportStar(require(\"../types/gen/index\"), exports);\nconst fs_1 = __importDefault(require(\"fs\"));\nconst index_1 = require(\"../types/gen/index\");\nconst module_1 = require(\"module\");\n/**\n * @category Core Reference\n */\nclass ScryptedDeviceBase extends index_1.DeviceBase {\n    constructor(nativeId) {\n        super();\n        this.nativeId = nativeId;\n    }\n    get storage() {\n        if (!this._storage) {\n            this._storage = exports.sdk.deviceManager.getDeviceStorage(this.nativeId);\n        }\n        return this._storage;\n    }\n    get log() {\n        if (!this._log) {\n            this._log = exports.sdk.deviceManager.getDeviceLogger(this.nativeId);\n        }\n        return this._log;\n    }\n    get console() {\n        if (!this._console) {\n            this._console = exports.sdk.deviceManager.getDeviceConsole(this.nativeId);\n        }\n        return this._console;\n    }\n    async createMediaObject(data, mimeType) {\n        return exports.sdk.mediaManager.createMediaObject(data, mimeType, {\n            sourceId: this.id,\n        });\n    }\n    getMediaObjectConsole(mediaObject) {\n        if (typeof mediaObject.sourceId !== 'string')\n            return this.console;\n        return exports.sdk.deviceManager.getMixinConsole(mediaObject.sourceId, this.nativeId);\n    }\n    _lazyLoadDeviceState() {\n        if (!this._deviceState) {\n            if (this.nativeId) {\n                this._deviceState = exports.sdk.deviceManager.getDeviceState(this.nativeId);\n            }\n            else {\n                this._deviceState = exports.sdk.deviceManager.getDeviceState();\n            }\n        }\n    }\n    /**\n     * Fire an event for this device.\n     */\n    onDeviceEvent(eventInterface, eventData) {\n        return exports.sdk.deviceManager.onDeviceEvent(this.nativeId, eventInterface, eventData);\n    }\n}\nexports.ScryptedDeviceBase = ScryptedDeviceBase;\n/**\n * @category Mixin Reference\n */\nclass MixinDeviceBase extends index_1.DeviceBase {\n    constructor(options) {\n        super();\n        this._listeners = new Set();\n        this.mixinDevice = options.mixinDevice;\n        this.mixinDeviceInterfaces = options.mixinDeviceInterfaces;\n        this.mixinStorageSuffix = options.mixinStorageSuffix;\n        this._deviceState = options.mixinDeviceState;\n        this.nativeId = exports.sdk.systemManager.getDeviceById(this.id).nativeId;\n        this.mixinProviderNativeId = options.mixinProviderNativeId;\n        // RpcProxy will trap all properties, and the following check/hack will determine\n        // if the device state came from another node worker thread.\n        // This should ultimately be discouraged and warned at some point in the future.\n        if (this._deviceState.__rpcproxy_traps_all_properties && typeof this._deviceState.id === 'string') {\n            this._deviceState = exports.sdk.deviceManager.createDeviceState(this._deviceState.id, this._deviceState.setState);\n        }\n    }\n    get storage() {\n        if (!this._storage) {\n            const mixinStorageSuffix = this.mixinStorageSuffix;\n            const mixinStorageKey = this.id + (mixinStorageSuffix ? ':' + mixinStorageSuffix : '');\n            this._storage = exports.sdk.deviceManager.getMixinStorage(mixinStorageKey, this.mixinProviderNativeId);\n        }\n        return this._storage;\n    }\n    get console() {\n        if (!this._console) {\n            if (exports.sdk.deviceManager.getMixinConsole)\n                this._console = exports.sdk.deviceManager.getMixinConsole(this.id, this.mixinProviderNativeId);\n            else\n                this._console = exports.sdk.deviceManager.getDeviceConsole(this.mixinProviderNativeId);\n        }\n        return this._console;\n    }\n    async createMediaObject(data, mimeType) {\n        return exports.sdk.mediaManager.createMediaObject(data, mimeType, {\n            sourceId: this.id,\n        });\n    }\n    getMediaObjectConsole(mediaObject) {\n        if (typeof mediaObject.sourceId !== 'string')\n            return this.console;\n        return exports.sdk.deviceManager.getMixinConsole(mediaObject.sourceId, this.mixinProviderNativeId);\n    }\n    /**\n     * Fire an event for this device.\n     */\n    onDeviceEvent(eventInterface, eventData) {\n        return exports.sdk.deviceManager.onMixinEvent(this.id, this, eventInterface, eventData);\n    }\n    _lazyLoadDeviceState() {\n    }\n    manageListener(listener) {\n        this._listeners.add(listener);\n    }\n    release() {\n        for (const l of this._listeners) {\n            l.removeListener();\n        }\n    }\n}\nexports.MixinDeviceBase = MixinDeviceBase;\n(function () {\n    function _createGetState(state) {\n        return function () {\n            this._lazyLoadDeviceState();\n            // @ts-ignore: accessing private property\n            return this._deviceState?.[state];\n        };\n    }\n    function _createSetState(state) {\n        return function (value) {\n            this._lazyLoadDeviceState();\n            // @ts-ignore: accessing private property\n            if (!this._deviceState) {\n                console.warn('device state is unavailable. the device must be discovered with deviceManager.onDeviceDiscovered or deviceManager.onDevicesChanged before the state can be set.');\n            }\n            else {\n                // @ts-ignore: accessing private property\n                this._deviceState[state] = value;\n            }\n        };\n    }\n    for (const field of Object.values(index_1.ScryptedInterfaceProperty)) {\n        if (field === index_1.ScryptedInterfaceProperty.nativeId)\n            continue;\n        Object.defineProperty(ScryptedDeviceBase.prototype, field, {\n            set: _createSetState(field),\n            get: _createGetState(field),\n        });\n        Object.defineProperty(MixinDeviceBase.prototype, field, {\n            set: _createSetState(field),\n            get: _createGetState(field),\n        });\n    }\n})();\nexports.sdk = {};\ntry {\n    let loaded = false;\n    try {\n        // todo: remove usage of process.env.SCRYPTED_SDK_MODULE, only existed in prerelease builds.\n        // import.meta is not a reliable way to detect es module support in webpack since webpack\n        // evaluates that to true at runtime.\n        const esModule = process.env.SCRYPTED_SDK_ES_MODULE || process.env.SCRYPTED_SDK_MODULE;\n        const cjsModule = process.env.SCRYPTED_SDK_CJS_MODULE || process.env.SCRYPTED_SDK_MODULE;\n        // @ts-expect-error\n        if (esModule && typeof import.meta !== 'undefined') {\n            // @ts-expect-error\n            const require = (0, module_1.createRequire)(import.meta.url);\n            const sdkModule = require(esModule);\n            Object.assign(exports.sdk, sdkModule.getScryptedStatic());\n            loaded = true;\n        }\n        else if (cjsModule) {\n            // @ts-expect-error\n            if (typeof __non_webpack_require__ !== 'undefined') {\n                // @ts-expect-error\n                const sdkModule = __non_webpack_require__(process.env.SCRYPTED_SDK_MODULE);\n                Object.assign(exports.sdk, sdkModule.getScryptedStatic());\n                loaded = true;\n            }\n            else {\n                const sdkModule = require(cjsModule);\n                Object.assign(exports.sdk, sdkModule.getScryptedStatic());\n                loaded = true;\n            }\n        }\n    }\n    catch (e) {\n        console.warn(\"failed to load sdk module\", e);\n        throw e;\n    }\n    if (!loaded) {\n        let runtimeAPI;\n        try {\n            runtimeAPI = pluginRuntimeAPI;\n        }\n        catch (e) {\n        }\n        Object.assign(exports.sdk, {\n            log: deviceManager.getDeviceLogger(undefined),\n            deviceManager,\n            endpointManager,\n            mediaManager,\n            systemManager,\n            pluginHostAPI,\n            ...runtimeAPI,\n        });\n    }\n    try {\n        let descriptors = {\n            ...index_1.ScryptedInterfaceDescriptors,\n        };\n        try {\n            const sdkJson = JSON.parse(fs_1.default.readFileSync('../sdk.json').toString());\n            const customDescriptors = sdkJson.interfaceDescriptors;\n            if (customDescriptors) {\n                descriptors = {\n                    ...descriptors,\n                    ...customDescriptors,\n                };\n            }\n        }\n        catch (e) {\n            console.warn('failed to load custom interface descriptors', e);\n        }\n        exports.sdk.systemManager.setScryptedInterfaceDescriptors?.(index_1.TYPES_VERSION, descriptors)?.catch(() => { });\n    }\n    catch (e) {\n    }\n}\ncatch (e) {\n    console.error('sdk initialization error, import @scrypted/types or use @scrypted/client instead', e);\n}\nexports.default = exports.sdk;\n//# sourceMappingURL=index.js.map","module.exports = require(\"tls\");","import { MixinDeviceBase, ResponseMediaStreamOptions, VideoCamera } from \"@scrypted/sdk\";\nimport { StorageSetting, StorageSettings, StorageSettingsDict } from \"@scrypted/sdk/storage-settings\";\n\nexport type StreamStorageSetting = StorageSetting & {\n    prefersPrebuffer: boolean,\n    preferredResolution: number,\n};\nexport type StreamStorageSettingsDict<T extends string> = { [key in T]: StreamStorageSetting };\n\n\nfunction getStreamTypes<T extends string>(storageSettings: StreamStorageSettingsDict<T>) {\n    return storageSettings;\n}\n\nfunction msoHasJpegCodec(mso: ResponseMediaStreamOptions) {\n    const lower = mso?.video?.codec?.toLowerCase();\n    return lower?.includes('jpeg') || lower?.includes('jpg');\n}\n\nfunction pickBestStream(msos: ResponseMediaStreamOptions[], resolution: number) {\n    if (!msos)\n        return;\n\n    let best: ResponseMediaStreamOptions;\n    let bestScore: number;\n    for (const mso of msos) {\n        if (msoHasJpegCodec(mso)) {\n            continue;\n        }\n\n        const score = Math.abs(mso.video?.width * mso.video?.height - resolution);\n        if (!best || score < bestScore) {\n            best = mso;\n            bestScore = score;\n            if (Number.isNaN(bestScore))\n                bestScore = Number.MAX_SAFE_INTEGER;\n        }\n    }\n\n    return best;\n}\n\nexport function createStreamSettings(device: MixinDeviceBase<VideoCamera>) {\n    const subgroup = \"Manage\";\n\n    const streamTypes = getStreamTypes({\n        defaultStream: {\n            subgroup,\n            title: 'Local Stream',\n            description: 'The media stream to use when streaming on your local network. This stream should be prebuffered. Recommended resolution: 1920x1080 to 4K.',\n            hide: true,\n            prefersPrebuffer: false,\n            preferredResolution: 3840 * 2160,\n        },\n        remoteStream: {\n            subgroup,\n            title: 'Remote (Medium Resolution) Stream',\n            description: 'The media stream to use when streaming from outside your local network. Selecting a low birate stream is recommended. Recommended resolution: 1280x720.',\n            hide: true,\n            prefersPrebuffer: false,\n            preferredResolution: 1280 * 720,\n        },\n        lowResolutionStream: {\n            subgroup,\n            title: 'Low Resolution Stream',\n            description: 'The media stream to use for low resolution output, such as Apple Watch and Video Analysis. Recommended resolution: 480x360.',\n            hide: true,\n            prefersPrebuffer: false,\n            preferredResolution: 480 * 360,\n        },\n        recordingStream: {\n            subgroup,\n            title: 'Local Recording Stream',\n            description: 'The media stream to use when recording to local storage such as an NVR. Recommended resolution: 1920x1080 to 4K.',\n            hide: true,\n            // will be automatically prebuferred when in use, but doesn't really need it.\n            prefersPrebuffer: false,\n            preferredResolution: 3840 * 2160,\n        },\n        remoteRecordingStream: {\n            subgroup,\n            title: 'Remote Recording Stream',\n            description: 'The media stream to use when recording to cloud storage such as HomeKit Secure Video clips in iCloud. This stream should be prebuffered. Recommended resolution: 1280x720.',\n            hide: true,\n            prefersPrebuffer: true,\n            preferredResolution: 2560 * 1440,\n        },\n    });\n\n    const storageSettings = new StorageSettings(device, {\n        hasMjpeg: {\n            subgroup,\n            title: 'Invalid Codecs',\n            type: 'html',\n            defaultValue: '<p style=\"color: red;\">MJPEG streams detected. These streams are incompatible Scrypted and should be reconfigured to H264 using the camera\\'s web admin if possible.</p>',\n            hide: true,\n        },\n        noAudio: {\n            subgroup,\n            title: 'No Audio',\n            description: 'Enable this setting if the camera does not have audio or to mute audio.',\n            type: 'boolean',\n        },\n        privacyMode: {\n            group: 'Privacy',\n            title: 'Disable Stream',\n            description: 'Disable this camera\\'s stream to all services provided by Scrypted.',\n            type: 'boolean',\n        },\n        enabledStreams: {\n            subgroup,\n            title: 'Prebuffered Streams',\n            description: 'Prebuffering maintains an active connection to the stream and improves load times. Prebuffer also retains the recent video for capturing motion events with HomeKit Secure video. Enabling Prebuffer is not recommended on Cloud cameras.',\n            multiple: true,\n            hide: false,\n        },\n        ...streamTypes,\n        rebroadcastPort: {\n            subgroup,\n            title: 'Rebroadcast Port',\n            description: 'The port of the RTSP server that will rebroadcast your streams.',\n            type: 'number',\n            hide: false,\n        },\n        synthenticStreams: {\n            subgroup,\n            title: 'Synthetic Streams',\n            description: 'Create additional streams by transcoding the existing streams. This can be useful for creating streams with different resolutions or bitrates.',\n            immediate: true,\n            multiple: true,\n            combobox: true,\n            choices: [],\n            defaultValue: [],\n        }\n    });\n\n    function getDefaultPrebufferedStreams(msos: ResponseMediaStreamOptions[]) {\n        if (!msos)\n            return;\n\n        const local = getMediaStream(storageSettings.keys.defaultStream, msos);\n        const remoteRecording = getMediaStream(storageSettings.keys.remoteRecordingStream, msos);\n\n        if (!local?.stream || local.stream.source === 'cloud' || local.stream.source === 'synthetic')\n            return [];\n\n        if (local.stream.id === remoteRecording.stream.id)\n            return [local.stream];\n        return [local.stream, remoteRecording.stream];\n    }\n\n    function getPrebufferedStreams(msos: ResponseMediaStreamOptions[]) {\n        if (!msos)\n            return;\n\n        if (!storageSettings.hasValue.enabledStreams)\n            return getDefaultPrebufferedStreams(msos);\n\n        return msos.filter(mso => storageSettings.values.enabledStreams.includes(mso.name));\n    }\n\n\n    function getDefaultMediaStream(v: StreamStorageSetting, msos: ResponseMediaStreamOptions[]) {\n        return pickBestStream(msos, v.preferredResolution);\n    }\n\n    function getMediaStream(key: string, msos: ResponseMediaStreamOptions[]) {\n        const v: StreamStorageSetting = storageSettings.settings[key];\n        const value = storageSettings.values[key];\n        let isDefault = value === 'Default';\n\n        let stream = msos?.find(mso => mso.name === value);\n        if (storageSettings.values.synthenticStreams.includes(value)) {\n            stream = {\n                id: `synthetic:${value}`,\n            };\n        }\n        else {\n            if (isDefault || !stream) {\n                isDefault = true;\n                stream = getDefaultMediaStream(v, msos);\n            }\n        }\n        return {\n            title: streamTypes[key].title,\n            isDefault,\n            stream,\n        };\n    };\n\n    function createStreamOptions(v: StreamStorageSetting, msos: ResponseMediaStreamOptions[]) {\n        const choices = [\n            'Default',\n            ...msos.map(mso => mso.name),\n            ...storageSettings.values.synthenticStreams,\n        ];\n        const defaultValue = getDefaultMediaStream(v, msos).name;\n\n        const streamOptions = {\n            defaultValue: 'Default',\n            description: v.description + ` The default for this stream is ${defaultValue}.`,\n            choices,\n            hide: false,\n        };\n        return streamOptions;\n    }\n\n    storageSettings.options = {\n        onGet: async () => {\n            let enabledStreams: StorageSetting;\n\n            try {\n                const msos = await device.mixinDevice.getVideoStreamOptions();\n\n                const hasMjpeg: StorageSettingsDict<'hasMjpeg'> = msos?.find(mso => msoHasJpegCodec(mso))\n                    ? {\n                        hasMjpeg: {\n                            hide: false,\n                        },\n                    }\n                    : undefined;\n\n\n                enabledStreams = {\n                    defaultValue: getDefaultPrebufferedStreams(msos)?.map(mso => mso.name || mso.id),\n                    choices: msos.map((mso, index) => mso.name || mso.id),\n                    hide: false,\n                };\n\n                if (msos?.length > 1) {\n                    return {\n                        enabledStreams,\n                        defaultStream: createStreamOptions(streamTypes.defaultStream, msos),\n                        remoteStream: createStreamOptions(streamTypes.remoteStream, msos),\n                        lowResolutionStream: createStreamOptions(streamTypes.lowResolutionStream, msos),\n                        recordingStream: createStreamOptions(streamTypes.recordingStream, msos),\n                        remoteRecordingStream: createStreamOptions(streamTypes.remoteRecordingStream, msos),\n                        ...hasMjpeg,\n                    }\n                }\n                else {\n                    return {\n                        enabledStreams,\n                        ...hasMjpeg,\n                    }\n                }\n            }\n            catch (e) {\n                device.console.error('error retrieving getVideoStreamOptions', e);\n            }\n\n            return {\n            }\n        }\n    }\n\n    return {\n        getDefaultPrebufferedStreams,\n        getPrebufferedStreams,\n        getDefaultStream: (msos: ResponseMediaStreamOptions[]) => getMediaStream(storageSettings.keys.defaultStream, msos),\n        getRemoteStream: (msos: ResponseMediaStreamOptions[]) => getMediaStream(storageSettings.keys.remoteStream, msos),\n        getLowResolutionStream: (msos: ResponseMediaStreamOptions[]) => getMediaStream(storageSettings.keys.lowResolutionStream, msos),\n        getRecordingStream: (msos: ResponseMediaStreamOptions[]) => getMediaStream(storageSettings.keys.recordingStream, msos),\n        getRemoteRecordingStream: (msos: ResponseMediaStreamOptions[]) => getMediaStream(storageSettings.keys.remoteRecordingStream, msos),\n        storageSettings,\n    };\n}\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ScryptedMimeTypes = exports.ScryptedInterface = exports.MediaPlayerState = exports.SecuritySystemObstruction = exports.SecuritySystemMode = exports.AirQuality = exports.AirPurifierMode = exports.AirPurifierStatus = exports.ChargeState = exports.LockState = exports.PanTiltZoomMovement = exports.ThermostatMode = exports.TemperatureUnit = exports.FanMode = exports.HumidityMode = exports.ScryptedDeviceType = exports.ScryptedInterfaceDescriptors = exports.ScryptedInterfaceMethod = exports.ScryptedInterfaceProperty = exports.DeviceBase = exports.TYPES_VERSION = void 0;\nexports.TYPES_VERSION = \"0.5.49\";\nclass DeviceBase {\n}\nexports.DeviceBase = DeviceBase;\nvar ScryptedInterfaceProperty;\n(function (ScryptedInterfaceProperty) {\n    ScryptedInterfaceProperty[\"id\"] = \"id\";\n    ScryptedInterfaceProperty[\"info\"] = \"info\";\n    ScryptedInterfaceProperty[\"interfaces\"] = \"interfaces\";\n    ScryptedInterfaceProperty[\"mixins\"] = \"mixins\";\n    ScryptedInterfaceProperty[\"name\"] = \"name\";\n    ScryptedInterfaceProperty[\"nativeId\"] = \"nativeId\";\n    ScryptedInterfaceProperty[\"pluginId\"] = \"pluginId\";\n    ScryptedInterfaceProperty[\"providedInterfaces\"] = \"providedInterfaces\";\n    ScryptedInterfaceProperty[\"providedName\"] = \"providedName\";\n    ScryptedInterfaceProperty[\"providedRoom\"] = \"providedRoom\";\n    ScryptedInterfaceProperty[\"providedType\"] = \"providedType\";\n    ScryptedInterfaceProperty[\"providerId\"] = \"providerId\";\n    ScryptedInterfaceProperty[\"room\"] = \"room\";\n    ScryptedInterfaceProperty[\"type\"] = \"type\";\n    ScryptedInterfaceProperty[\"scryptedRuntimeArguments\"] = \"scryptedRuntimeArguments\";\n    ScryptedInterfaceProperty[\"on\"] = \"on\";\n    ScryptedInterfaceProperty[\"brightness\"] = \"brightness\";\n    ScryptedInterfaceProperty[\"colorTemperature\"] = \"colorTemperature\";\n    ScryptedInterfaceProperty[\"rgb\"] = \"rgb\";\n    ScryptedInterfaceProperty[\"hsv\"] = \"hsv\";\n    ScryptedInterfaceProperty[\"buttons\"] = \"buttons\";\n    ScryptedInterfaceProperty[\"sensors\"] = \"sensors\";\n    ScryptedInterfaceProperty[\"running\"] = \"running\";\n    ScryptedInterfaceProperty[\"paused\"] = \"paused\";\n    ScryptedInterfaceProperty[\"docked\"] = \"docked\";\n    ScryptedInterfaceProperty[\"temperatureSetting\"] = \"temperatureSetting\";\n    ScryptedInterfaceProperty[\"temperature\"] = \"temperature\";\n    ScryptedInterfaceProperty[\"temperatureUnit\"] = \"temperatureUnit\";\n    ScryptedInterfaceProperty[\"humidity\"] = \"humidity\";\n    ScryptedInterfaceProperty[\"resolution\"] = \"resolution\";\n    ScryptedInterfaceProperty[\"audioVolumes\"] = \"audioVolumes\";\n    ScryptedInterfaceProperty[\"recordingActive\"] = \"recordingActive\";\n    ScryptedInterfaceProperty[\"ptzCapabilities\"] = \"ptzCapabilities\";\n    ScryptedInterfaceProperty[\"lockState\"] = \"lockState\";\n    ScryptedInterfaceProperty[\"entryOpen\"] = \"entryOpen\";\n    ScryptedInterfaceProperty[\"batteryLevel\"] = \"batteryLevel\";\n    ScryptedInterfaceProperty[\"chargeState\"] = \"chargeState\";\n    ScryptedInterfaceProperty[\"online\"] = \"online\";\n    ScryptedInterfaceProperty[\"fromMimeType\"] = \"fromMimeType\";\n    ScryptedInterfaceProperty[\"toMimeType\"] = \"toMimeType\";\n    ScryptedInterfaceProperty[\"converters\"] = \"converters\";\n    ScryptedInterfaceProperty[\"binaryState\"] = \"binaryState\";\n    ScryptedInterfaceProperty[\"tampered\"] = \"tampered\";\n    ScryptedInterfaceProperty[\"sleeping\"] = \"sleeping\";\n    ScryptedInterfaceProperty[\"powerDetected\"] = \"powerDetected\";\n    ScryptedInterfaceProperty[\"audioDetected\"] = \"audioDetected\";\n    ScryptedInterfaceProperty[\"motionDetected\"] = \"motionDetected\";\n    ScryptedInterfaceProperty[\"ambientLight\"] = \"ambientLight\";\n    ScryptedInterfaceProperty[\"occupied\"] = \"occupied\";\n    ScryptedInterfaceProperty[\"flooded\"] = \"flooded\";\n    ScryptedInterfaceProperty[\"ultraviolet\"] = \"ultraviolet\";\n    ScryptedInterfaceProperty[\"luminance\"] = \"luminance\";\n    ScryptedInterfaceProperty[\"position\"] = \"position\";\n    ScryptedInterfaceProperty[\"securitySystemState\"] = \"securitySystemState\";\n    ScryptedInterfaceProperty[\"pm10Density\"] = \"pm10Density\";\n    ScryptedInterfaceProperty[\"pm25Density\"] = \"pm25Density\";\n    ScryptedInterfaceProperty[\"vocDensity\"] = \"vocDensity\";\n    ScryptedInterfaceProperty[\"noxDensity\"] = \"noxDensity\";\n    ScryptedInterfaceProperty[\"co2ppm\"] = \"co2ppm\";\n    ScryptedInterfaceProperty[\"airQuality\"] = \"airQuality\";\n    ScryptedInterfaceProperty[\"airPurifierState\"] = \"airPurifierState\";\n    ScryptedInterfaceProperty[\"filterChangeIndication\"] = \"filterChangeIndication\";\n    ScryptedInterfaceProperty[\"filterLifeLevel\"] = \"filterLifeLevel\";\n    ScryptedInterfaceProperty[\"humiditySetting\"] = \"humiditySetting\";\n    ScryptedInterfaceProperty[\"fan\"] = \"fan\";\n    ScryptedInterfaceProperty[\"applicationInfo\"] = \"applicationInfo\";\n    ScryptedInterfaceProperty[\"chatCompletionCapabilities\"] = \"chatCompletionCapabilities\";\n    ScryptedInterfaceProperty[\"systemDevice\"] = \"systemDevice\";\n})(ScryptedInterfaceProperty || (exports.ScryptedInterfaceProperty = ScryptedInterfaceProperty = {}));\nvar ScryptedInterfaceMethod;\n(function (ScryptedInterfaceMethod) {\n    ScryptedInterfaceMethod[\"listen\"] = \"listen\";\n    ScryptedInterfaceMethod[\"probe\"] = \"probe\";\n    ScryptedInterfaceMethod[\"setMixins\"] = \"setMixins\";\n    ScryptedInterfaceMethod[\"setName\"] = \"setName\";\n    ScryptedInterfaceMethod[\"setRoom\"] = \"setRoom\";\n    ScryptedInterfaceMethod[\"setType\"] = \"setType\";\n    ScryptedInterfaceMethod[\"getPluginJson\"] = \"getPluginJson\";\n    ScryptedInterfaceMethod[\"turnOff\"] = \"turnOff\";\n    ScryptedInterfaceMethod[\"turnOn\"] = \"turnOn\";\n    ScryptedInterfaceMethod[\"setBrightness\"] = \"setBrightness\";\n    ScryptedInterfaceMethod[\"getTemperatureMaxK\"] = \"getTemperatureMaxK\";\n    ScryptedInterfaceMethod[\"getTemperatureMinK\"] = \"getTemperatureMinK\";\n    ScryptedInterfaceMethod[\"setColorTemperature\"] = \"setColorTemperature\";\n    ScryptedInterfaceMethod[\"setRgb\"] = \"setRgb\";\n    ScryptedInterfaceMethod[\"setHsv\"] = \"setHsv\";\n    ScryptedInterfaceMethod[\"pressButton\"] = \"pressButton\";\n    ScryptedInterfaceMethod[\"sendNotification\"] = \"sendNotification\";\n    ScryptedInterfaceMethod[\"start\"] = \"start\";\n    ScryptedInterfaceMethod[\"stop\"] = \"stop\";\n    ScryptedInterfaceMethod[\"pause\"] = \"pause\";\n    ScryptedInterfaceMethod[\"resume\"] = \"resume\";\n    ScryptedInterfaceMethod[\"dock\"] = \"dock\";\n    ScryptedInterfaceMethod[\"setTemperature\"] = \"setTemperature\";\n    ScryptedInterfaceMethod[\"setTemperatureUnit\"] = \"setTemperatureUnit\";\n    ScryptedInterfaceMethod[\"getPictureOptions\"] = \"getPictureOptions\";\n    ScryptedInterfaceMethod[\"takePicture\"] = \"takePicture\";\n    ScryptedInterfaceMethod[\"getAudioStream\"] = \"getAudioStream\";\n    ScryptedInterfaceMethod[\"setAudioVolumes\"] = \"setAudioVolumes\";\n    ScryptedInterfaceMethod[\"startDisplay\"] = \"startDisplay\";\n    ScryptedInterfaceMethod[\"stopDisplay\"] = \"stopDisplay\";\n    ScryptedInterfaceMethod[\"getVideoStream\"] = \"getVideoStream\";\n    ScryptedInterfaceMethod[\"getVideoStreamOptions\"] = \"getVideoStreamOptions\";\n    ScryptedInterfaceMethod[\"getPrivacyMasks\"] = \"getPrivacyMasks\";\n    ScryptedInterfaceMethod[\"setPrivacyMasks\"] = \"setPrivacyMasks\";\n    ScryptedInterfaceMethod[\"getVideoTextOverlays\"] = \"getVideoTextOverlays\";\n    ScryptedInterfaceMethod[\"setVideoTextOverlay\"] = \"setVideoTextOverlay\";\n    ScryptedInterfaceMethod[\"getRecordingStream\"] = \"getRecordingStream\";\n    ScryptedInterfaceMethod[\"getRecordingStreamCurrentTime\"] = \"getRecordingStreamCurrentTime\";\n    ScryptedInterfaceMethod[\"getRecordingStreamOptions\"] = \"getRecordingStreamOptions\";\n    ScryptedInterfaceMethod[\"getRecordingStreamThumbnail\"] = \"getRecordingStreamThumbnail\";\n    ScryptedInterfaceMethod[\"deleteRecordingStream\"] = \"deleteRecordingStream\";\n    ScryptedInterfaceMethod[\"setRecordingActive\"] = \"setRecordingActive\";\n    ScryptedInterfaceMethod[\"ptzCommand\"] = \"ptzCommand\";\n    ScryptedInterfaceMethod[\"getRecordedEvents\"] = \"getRecordedEvents\";\n    ScryptedInterfaceMethod[\"getVideoClip\"] = \"getVideoClip\";\n    ScryptedInterfaceMethod[\"getVideoClips\"] = \"getVideoClips\";\n    ScryptedInterfaceMethod[\"getVideoClipThumbnail\"] = \"getVideoClipThumbnail\";\n    ScryptedInterfaceMethod[\"removeVideoClips\"] = \"removeVideoClips\";\n    ScryptedInterfaceMethod[\"setVideoStreamOptions\"] = \"setVideoStreamOptions\";\n    ScryptedInterfaceMethod[\"startIntercom\"] = \"startIntercom\";\n    ScryptedInterfaceMethod[\"stopIntercom\"] = \"stopIntercom\";\n    ScryptedInterfaceMethod[\"lock\"] = \"lock\";\n    ScryptedInterfaceMethod[\"unlock\"] = \"unlock\";\n    ScryptedInterfaceMethod[\"addPassword\"] = \"addPassword\";\n    ScryptedInterfaceMethod[\"getPasswords\"] = \"getPasswords\";\n    ScryptedInterfaceMethod[\"removePassword\"] = \"removePassword\";\n    ScryptedInterfaceMethod[\"activate\"] = \"activate\";\n    ScryptedInterfaceMethod[\"deactivate\"] = \"deactivate\";\n    ScryptedInterfaceMethod[\"isReversible\"] = \"isReversible\";\n    ScryptedInterfaceMethod[\"closeEntry\"] = \"closeEntry\";\n    ScryptedInterfaceMethod[\"openEntry\"] = \"openEntry\";\n    ScryptedInterfaceMethod[\"getDevice\"] = \"getDevice\";\n    ScryptedInterfaceMethod[\"releaseDevice\"] = \"releaseDevice\";\n    ScryptedInterfaceMethod[\"adoptDevice\"] = \"adoptDevice\";\n    ScryptedInterfaceMethod[\"discoverDevices\"] = \"discoverDevices\";\n    ScryptedInterfaceMethod[\"createDevice\"] = \"createDevice\";\n    ScryptedInterfaceMethod[\"getCreateDeviceSettings\"] = \"getCreateDeviceSettings\";\n    ScryptedInterfaceMethod[\"reboot\"] = \"reboot\";\n    ScryptedInterfaceMethod[\"getRefreshFrequency\"] = \"getRefreshFrequency\";\n    ScryptedInterfaceMethod[\"refresh\"] = \"refresh\";\n    ScryptedInterfaceMethod[\"getMediaStatus\"] = \"getMediaStatus\";\n    ScryptedInterfaceMethod[\"load\"] = \"load\";\n    ScryptedInterfaceMethod[\"seek\"] = \"seek\";\n    ScryptedInterfaceMethod[\"skipNext\"] = \"skipNext\";\n    ScryptedInterfaceMethod[\"skipPrevious\"] = \"skipPrevious\";\n    ScryptedInterfaceMethod[\"convert\"] = \"convert\";\n    ScryptedInterfaceMethod[\"convertMedia\"] = \"convertMedia\";\n    ScryptedInterfaceMethod[\"getSettings\"] = \"getSettings\";\n    ScryptedInterfaceMethod[\"putSetting\"] = \"putSetting\";\n    ScryptedInterfaceMethod[\"armSecuritySystem\"] = \"armSecuritySystem\";\n    ScryptedInterfaceMethod[\"disarmSecuritySystem\"] = \"disarmSecuritySystem\";\n    ScryptedInterfaceMethod[\"setAirPurifierState\"] = \"setAirPurifierState\";\n    ScryptedInterfaceMethod[\"getReadmeMarkdown\"] = \"getReadmeMarkdown\";\n    ScryptedInterfaceMethod[\"getOauthUrl\"] = \"getOauthUrl\";\n    ScryptedInterfaceMethod[\"onOauthCallback\"] = \"onOauthCallback\";\n    ScryptedInterfaceMethod[\"canMixin\"] = \"canMixin\";\n    ScryptedInterfaceMethod[\"getMixin\"] = \"getMixin\";\n    ScryptedInterfaceMethod[\"releaseMixin\"] = \"releaseMixin\";\n    ScryptedInterfaceMethod[\"onRequest\"] = \"onRequest\";\n    ScryptedInterfaceMethod[\"onConnection\"] = \"onConnection\";\n    ScryptedInterfaceMethod[\"onPush\"] = \"onPush\";\n    ScryptedInterfaceMethod[\"run\"] = \"run\";\n    ScryptedInterfaceMethod[\"eval\"] = \"eval\";\n    ScryptedInterfaceMethod[\"loadScripts\"] = \"loadScripts\";\n    ScryptedInterfaceMethod[\"saveScript\"] = \"saveScript\";\n    ScryptedInterfaceMethod[\"forkInterface\"] = \"forkInterface\";\n    ScryptedInterfaceMethod[\"getDetectionInput\"] = \"getDetectionInput\";\n    ScryptedInterfaceMethod[\"getObjectTypes\"] = \"getObjectTypes\";\n    ScryptedInterfaceMethod[\"detectObjects\"] = \"detectObjects\";\n    ScryptedInterfaceMethod[\"generateObjectDetections\"] = \"generateObjectDetections\";\n    ScryptedInterfaceMethod[\"getDetectionModel\"] = \"getDetectionModel\";\n    ScryptedInterfaceMethod[\"setHumidity\"] = \"setHumidity\";\n    ScryptedInterfaceMethod[\"setFan\"] = \"setFan\";\n    ScryptedInterfaceMethod[\"startRTCSignalingSession\"] = \"startRTCSignalingSession\";\n    ScryptedInterfaceMethod[\"createRTCSignalingSession\"] = \"createRTCSignalingSession\";\n    ScryptedInterfaceMethod[\"getScryptedUserAccessControl\"] = \"getScryptedUserAccessControl\";\n    ScryptedInterfaceMethod[\"generateVideoFrames\"] = \"generateVideoFrames\";\n    ScryptedInterfaceMethod[\"connectStream\"] = \"connectStream\";\n    ScryptedInterfaceMethod[\"getTTYSettings\"] = \"getTTYSettings\";\n    ScryptedInterfaceMethod[\"getChatCompletion\"] = \"getChatCompletion\";\n    ScryptedInterfaceMethod[\"streamChatCompletion\"] = \"streamChatCompletion\";\n    ScryptedInterfaceMethod[\"getTextEmbedding\"] = \"getTextEmbedding\";\n    ScryptedInterfaceMethod[\"getImageEmbedding\"] = \"getImageEmbedding\";\n    ScryptedInterfaceMethod[\"callLLMTool\"] = \"callLLMTool\";\n    ScryptedInterfaceMethod[\"getLLMTools\"] = \"getLLMTools\";\n})(ScryptedInterfaceMethod || (exports.ScryptedInterfaceMethod = ScryptedInterfaceMethod = {}));\nexports.ScryptedInterfaceDescriptors = {\n    \"ScryptedDevice\": {\n        \"name\": \"ScryptedDevice\",\n        \"methods\": [\n            \"listen\",\n            \"probe\",\n            \"setMixins\",\n            \"setName\",\n            \"setRoom\",\n            \"setType\"\n        ],\n        \"properties\": [\n            \"id\",\n            \"info\",\n            \"interfaces\",\n            \"mixins\",\n            \"name\",\n            \"nativeId\",\n            \"pluginId\",\n            \"providedInterfaces\",\n            \"providedName\",\n            \"providedRoom\",\n            \"providedType\",\n            \"providerId\",\n            \"room\",\n            \"type\"\n        ]\n    },\n    \"ScryptedPlugin\": {\n        \"name\": \"ScryptedPlugin\",\n        \"methods\": [\n            \"getPluginJson\"\n        ],\n        \"properties\": []\n    },\n    \"ScryptedPluginRuntime\": {\n        \"name\": \"ScryptedPluginRuntime\",\n        \"methods\": [],\n        \"properties\": [\n            \"scryptedRuntimeArguments\"\n        ]\n    },\n    \"OnOff\": {\n        \"name\": \"OnOff\",\n        \"methods\": [\n            \"turnOff\",\n            \"turnOn\"\n        ],\n        \"properties\": [\n            \"on\"\n        ]\n    },\n    \"Brightness\": {\n        \"name\": \"Brightness\",\n        \"methods\": [\n            \"setBrightness\"\n        ],\n        \"properties\": [\n            \"brightness\"\n        ]\n    },\n    \"ColorSettingTemperature\": {\n        \"name\": \"ColorSettingTemperature\",\n        \"methods\": [\n            \"getTemperatureMaxK\",\n            \"getTemperatureMinK\",\n            \"setColorTemperature\"\n        ],\n        \"properties\": [\n            \"colorTemperature\"\n        ]\n    },\n    \"ColorSettingRgb\": {\n        \"name\": \"ColorSettingRgb\",\n        \"methods\": [\n            \"setRgb\"\n        ],\n        \"properties\": [\n            \"rgb\"\n        ]\n    },\n    \"ColorSettingHsv\": {\n        \"name\": \"ColorSettingHsv\",\n        \"methods\": [\n            \"setHsv\"\n        ],\n        \"properties\": [\n            \"hsv\"\n        ]\n    },\n    \"Buttons\": {\n        \"name\": \"Buttons\",\n        \"methods\": [],\n        \"properties\": [\n            \"buttons\"\n        ]\n    },\n    \"PressButtons\": {\n        \"name\": \"PressButtons\",\n        \"methods\": [\n            \"pressButton\"\n        ],\n        \"properties\": []\n    },\n    \"Sensors\": {\n        \"name\": \"Sensors\",\n        \"methods\": [],\n        \"properties\": [\n            \"sensors\"\n        ]\n    },\n    \"Notifier\": {\n        \"name\": \"Notifier\",\n        \"methods\": [\n            \"sendNotification\"\n        ],\n        \"properties\": []\n    },\n    \"StartStop\": {\n        \"name\": \"StartStop\",\n        \"methods\": [\n            \"start\",\n            \"stop\"\n        ],\n        \"properties\": [\n            \"running\"\n        ]\n    },\n    \"Pause\": {\n        \"name\": \"Pause\",\n        \"methods\": [\n            \"pause\",\n            \"resume\"\n        ],\n        \"properties\": [\n            \"paused\"\n        ]\n    },\n    \"Dock\": {\n        \"name\": \"Dock\",\n        \"methods\": [\n            \"dock\"\n        ],\n        \"properties\": [\n            \"docked\"\n        ]\n    },\n    \"TemperatureSetting\": {\n        \"name\": \"TemperatureSetting\",\n        \"methods\": [\n            \"setTemperature\"\n        ],\n        \"properties\": [\n            \"temperatureSetting\"\n        ]\n    },\n    \"Thermometer\": {\n        \"name\": \"Thermometer\",\n        \"methods\": [\n            \"setTemperatureUnit\"\n        ],\n        \"properties\": [\n            \"temperature\",\n            \"temperatureUnit\"\n        ]\n    },\n    \"HumiditySensor\": {\n        \"name\": \"HumiditySensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"humidity\"\n        ]\n    },\n    \"Camera\": {\n        \"name\": \"Camera\",\n        \"methods\": [\n            \"getPictureOptions\",\n            \"takePicture\"\n        ],\n        \"properties\": []\n    },\n    \"Resolution\": {\n        \"name\": \"Resolution\",\n        \"methods\": [],\n        \"properties\": [\n            \"resolution\"\n        ]\n    },\n    \"Microphone\": {\n        \"name\": \"Microphone\",\n        \"methods\": [\n            \"getAudioStream\"\n        ],\n        \"properties\": []\n    },\n    \"AudioVolumeControl\": {\n        \"name\": \"AudioVolumeControl\",\n        \"methods\": [\n            \"setAudioVolumes\"\n        ],\n        \"properties\": [\n            \"audioVolumes\"\n        ]\n    },\n    \"Display\": {\n        \"name\": \"Display\",\n        \"methods\": [\n            \"startDisplay\",\n            \"stopDisplay\"\n        ],\n        \"properties\": []\n    },\n    \"VideoCamera\": {\n        \"name\": \"VideoCamera\",\n        \"methods\": [\n            \"getVideoStream\",\n            \"getVideoStreamOptions\"\n        ],\n        \"properties\": []\n    },\n    \"VideoCameraMask\": {\n        \"name\": \"VideoCameraMask\",\n        \"methods\": [\n            \"getPrivacyMasks\",\n            \"setPrivacyMasks\"\n        ],\n        \"properties\": []\n    },\n    \"VideoTextOverlays\": {\n        \"name\": \"VideoTextOverlays\",\n        \"methods\": [\n            \"getVideoTextOverlays\",\n            \"setVideoTextOverlay\"\n        ],\n        \"properties\": []\n    },\n    \"VideoRecorder\": {\n        \"name\": \"VideoRecorder\",\n        \"methods\": [\n            \"getRecordingStream\",\n            \"getRecordingStreamCurrentTime\",\n            \"getRecordingStreamOptions\",\n            \"getRecordingStreamThumbnail\"\n        ],\n        \"properties\": [\n            \"recordingActive\"\n        ]\n    },\n    \"VideoRecorderManagement\": {\n        \"name\": \"VideoRecorderManagement\",\n        \"methods\": [\n            \"deleteRecordingStream\",\n            \"setRecordingActive\"\n        ],\n        \"properties\": []\n    },\n    \"PanTiltZoom\": {\n        \"name\": \"PanTiltZoom\",\n        \"methods\": [\n            \"ptzCommand\"\n        ],\n        \"properties\": [\n            \"ptzCapabilities\"\n        ]\n    },\n    \"EventRecorder\": {\n        \"name\": \"EventRecorder\",\n        \"methods\": [\n            \"getRecordedEvents\"\n        ],\n        \"properties\": []\n    },\n    \"VideoClips\": {\n        \"name\": \"VideoClips\",\n        \"methods\": [\n            \"getVideoClip\",\n            \"getVideoClips\",\n            \"getVideoClipThumbnail\",\n            \"removeVideoClips\"\n        ],\n        \"properties\": []\n    },\n    \"VideoCameraConfiguration\": {\n        \"name\": \"VideoCameraConfiguration\",\n        \"methods\": [\n            \"setVideoStreamOptions\"\n        ],\n        \"properties\": []\n    },\n    \"Intercom\": {\n        \"name\": \"Intercom\",\n        \"methods\": [\n            \"startIntercom\",\n            \"stopIntercom\"\n        ],\n        \"properties\": []\n    },\n    \"Lock\": {\n        \"name\": \"Lock\",\n        \"methods\": [\n            \"lock\",\n            \"unlock\"\n        ],\n        \"properties\": [\n            \"lockState\"\n        ]\n    },\n    \"PasswordStore\": {\n        \"name\": \"PasswordStore\",\n        \"methods\": [\n            \"addPassword\",\n            \"getPasswords\",\n            \"removePassword\"\n        ],\n        \"properties\": []\n    },\n    \"Scene\": {\n        \"name\": \"Scene\",\n        \"methods\": [\n            \"activate\",\n            \"deactivate\",\n            \"isReversible\"\n        ],\n        \"properties\": []\n    },\n    \"Entry\": {\n        \"name\": \"Entry\",\n        \"methods\": [\n            \"closeEntry\",\n            \"openEntry\"\n        ],\n        \"properties\": []\n    },\n    \"EntrySensor\": {\n        \"name\": \"EntrySensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"entryOpen\"\n        ]\n    },\n    \"DeviceProvider\": {\n        \"name\": \"DeviceProvider\",\n        \"methods\": [\n            \"getDevice\",\n            \"releaseDevice\"\n        ],\n        \"properties\": []\n    },\n    \"DeviceDiscovery\": {\n        \"name\": \"DeviceDiscovery\",\n        \"methods\": [\n            \"adoptDevice\",\n            \"discoverDevices\"\n        ],\n        \"properties\": []\n    },\n    \"DeviceCreator\": {\n        \"name\": \"DeviceCreator\",\n        \"methods\": [\n            \"createDevice\",\n            \"getCreateDeviceSettings\"\n        ],\n        \"properties\": []\n    },\n    \"Battery\": {\n        \"name\": \"Battery\",\n        \"methods\": [],\n        \"properties\": [\n            \"batteryLevel\"\n        ]\n    },\n    \"Charger\": {\n        \"name\": \"Charger\",\n        \"methods\": [],\n        \"properties\": [\n            \"chargeState\"\n        ]\n    },\n    \"Reboot\": {\n        \"name\": \"Reboot\",\n        \"methods\": [\n            \"reboot\"\n        ],\n        \"properties\": []\n    },\n    \"Refresh\": {\n        \"name\": \"Refresh\",\n        \"methods\": [\n            \"getRefreshFrequency\",\n            \"refresh\"\n        ],\n        \"properties\": []\n    },\n    \"MediaPlayer\": {\n        \"name\": \"MediaPlayer\",\n        \"methods\": [\n            \"getMediaStatus\",\n            \"load\",\n            \"seek\",\n            \"skipNext\",\n            \"skipPrevious\"\n        ],\n        \"properties\": []\n    },\n    \"Online\": {\n        \"name\": \"Online\",\n        \"methods\": [],\n        \"properties\": [\n            \"online\"\n        ]\n    },\n    \"BufferConverter\": {\n        \"name\": \"BufferConverter\",\n        \"methods\": [\n            \"convert\"\n        ],\n        \"properties\": [\n            \"fromMimeType\",\n            \"toMimeType\"\n        ]\n    },\n    \"MediaConverter\": {\n        \"name\": \"MediaConverter\",\n        \"methods\": [\n            \"convertMedia\"\n        ],\n        \"properties\": [\n            \"converters\"\n        ]\n    },\n    \"Settings\": {\n        \"name\": \"Settings\",\n        \"methods\": [\n            \"getSettings\",\n            \"putSetting\"\n        ],\n        \"properties\": []\n    },\n    \"BinarySensor\": {\n        \"name\": \"BinarySensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"binaryState\"\n        ]\n    },\n    \"TamperSensor\": {\n        \"name\": \"TamperSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"tampered\"\n        ]\n    },\n    \"Sleep\": {\n        \"name\": \"Sleep\",\n        \"methods\": [],\n        \"properties\": [\n            \"sleeping\"\n        ]\n    },\n    \"PowerSensor\": {\n        \"name\": \"PowerSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"powerDetected\"\n        ]\n    },\n    \"AudioSensor\": {\n        \"name\": \"AudioSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"audioDetected\"\n        ]\n    },\n    \"MotionSensor\": {\n        \"name\": \"MotionSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"motionDetected\"\n        ]\n    },\n    \"AmbientLightSensor\": {\n        \"name\": \"AmbientLightSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"ambientLight\"\n        ]\n    },\n    \"OccupancySensor\": {\n        \"name\": \"OccupancySensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"occupied\"\n        ]\n    },\n    \"FloodSensor\": {\n        \"name\": \"FloodSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"flooded\"\n        ]\n    },\n    \"UltravioletSensor\": {\n        \"name\": \"UltravioletSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"ultraviolet\"\n        ]\n    },\n    \"LuminanceSensor\": {\n        \"name\": \"LuminanceSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"luminance\"\n        ]\n    },\n    \"PositionSensor\": {\n        \"name\": \"PositionSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"position\"\n        ]\n    },\n    \"SecuritySystem\": {\n        \"name\": \"SecuritySystem\",\n        \"methods\": [\n            \"armSecuritySystem\",\n            \"disarmSecuritySystem\"\n        ],\n        \"properties\": [\n            \"securitySystemState\"\n        ]\n    },\n    \"PM10Sensor\": {\n        \"name\": \"PM10Sensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"pm10Density\"\n        ]\n    },\n    \"PM25Sensor\": {\n        \"name\": \"PM25Sensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"pm25Density\"\n        ]\n    },\n    \"VOCSensor\": {\n        \"name\": \"VOCSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"vocDensity\"\n        ]\n    },\n    \"NOXSensor\": {\n        \"name\": \"NOXSensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"noxDensity\"\n        ]\n    },\n    \"CO2Sensor\": {\n        \"name\": \"CO2Sensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"co2ppm\"\n        ]\n    },\n    \"AirQualitySensor\": {\n        \"name\": \"AirQualitySensor\",\n        \"methods\": [],\n        \"properties\": [\n            \"airQuality\"\n        ]\n    },\n    \"AirPurifier\": {\n        \"name\": \"AirPurifier\",\n        \"methods\": [\n            \"setAirPurifierState\"\n        ],\n        \"properties\": [\n            \"airPurifierState\"\n        ]\n    },\n    \"FilterMaintenance\": {\n        \"name\": \"FilterMaintenance\",\n        \"methods\": [],\n        \"properties\": [\n            \"filterChangeIndication\",\n            \"filterLifeLevel\"\n        ]\n    },\n    \"Readme\": {\n        \"name\": \"Readme\",\n        \"methods\": [\n            \"getReadmeMarkdown\"\n        ],\n        \"properties\": []\n    },\n    \"OauthClient\": {\n        \"name\": \"OauthClient\",\n        \"methods\": [\n            \"getOauthUrl\",\n            \"onOauthCallback\"\n        ],\n        \"properties\": []\n    },\n    \"MixinProvider\": {\n        \"name\": \"MixinProvider\",\n        \"methods\": [\n            \"canMixin\",\n            \"getMixin\",\n            \"releaseMixin\"\n        ],\n        \"properties\": []\n    },\n    \"HttpRequestHandler\": {\n        \"name\": \"HttpRequestHandler\",\n        \"methods\": [\n            \"onRequest\"\n        ],\n        \"properties\": []\n    },\n    \"EngineIOHandler\": {\n        \"name\": \"EngineIOHandler\",\n        \"methods\": [\n            \"onConnection\"\n        ],\n        \"properties\": []\n    },\n    \"PushHandler\": {\n        \"name\": \"PushHandler\",\n        \"methods\": [\n            \"onPush\"\n        ],\n        \"properties\": []\n    },\n    \"Program\": {\n        \"name\": \"Program\",\n        \"methods\": [\n            \"run\"\n        ],\n        \"properties\": []\n    },\n    \"Scriptable\": {\n        \"name\": \"Scriptable\",\n        \"methods\": [\n            \"eval\",\n            \"loadScripts\",\n            \"saveScript\"\n        ],\n        \"properties\": []\n    },\n    \"ClusterForkInterface\": {\n        \"name\": \"ClusterForkInterface\",\n        \"methods\": [\n            \"forkInterface\"\n        ],\n        \"properties\": []\n    },\n    \"ObjectDetector\": {\n        \"name\": \"ObjectDetector\",\n        \"methods\": [\n            \"getDetectionInput\",\n            \"getObjectTypes\"\n        ],\n        \"properties\": []\n    },\n    \"ObjectDetection\": {\n        \"name\": \"ObjectDetection\",\n        \"methods\": [\n            \"detectObjects\",\n            \"generateObjectDetections\",\n            \"getDetectionModel\"\n        ],\n        \"properties\": []\n    },\n    \"ObjectDetectionPreview\": {\n        \"name\": \"ObjectDetectionPreview\",\n        \"methods\": [],\n        \"properties\": []\n    },\n    \"ObjectDetectionGenerator\": {\n        \"name\": \"ObjectDetectionGenerator\",\n        \"methods\": [],\n        \"properties\": []\n    },\n    \"HumiditySetting\": {\n        \"name\": \"HumiditySetting\",\n        \"methods\": [\n            \"setHumidity\"\n        ],\n        \"properties\": [\n            \"humiditySetting\"\n        ]\n    },\n    \"Fan\": {\n        \"name\": \"Fan\",\n        \"methods\": [\n            \"setFan\"\n        ],\n        \"properties\": [\n            \"fan\"\n        ]\n    },\n    \"RTCSignalingChannel\": {\n        \"name\": \"RTCSignalingChannel\",\n        \"methods\": [\n            \"startRTCSignalingSession\"\n        ],\n        \"properties\": []\n    },\n    \"RTCSignalingClient\": {\n        \"name\": \"RTCSignalingClient\",\n        \"methods\": [\n            \"createRTCSignalingSession\"\n        ],\n        \"properties\": []\n    },\n    \"LauncherApplication\": {\n        \"name\": \"LauncherApplication\",\n        \"methods\": [],\n        \"properties\": [\n            \"applicationInfo\"\n        ]\n    },\n    \"ScryptedUser\": {\n        \"name\": \"ScryptedUser\",\n        \"methods\": [\n            \"getScryptedUserAccessControl\"\n        ],\n        \"properties\": []\n    },\n    \"VideoFrameGenerator\": {\n        \"name\": \"VideoFrameGenerator\",\n        \"methods\": [\n            \"generateVideoFrames\"\n        ],\n        \"properties\": []\n    },\n    \"StreamService\": {\n        \"name\": \"StreamService\",\n        \"methods\": [\n            \"connectStream\"\n        ],\n        \"properties\": []\n    },\n    \"TTY\": {\n        \"name\": \"TTY\",\n        \"methods\": [],\n        \"properties\": []\n    },\n    \"TTYSettings\": {\n        \"name\": \"TTYSettings\",\n        \"methods\": [\n            \"getTTYSettings\"\n        ],\n        \"properties\": []\n    },\n    \"ChatCompletion\": {\n        \"name\": \"ChatCompletion\",\n        \"methods\": [\n            \"getChatCompletion\",\n            \"streamChatCompletion\"\n        ],\n        \"properties\": [\n            \"chatCompletionCapabilities\"\n        ]\n    },\n    \"TextEmbedding\": {\n        \"name\": \"TextEmbedding\",\n        \"methods\": [\n            \"getTextEmbedding\"\n        ],\n        \"properties\": []\n    },\n    \"ImageEmbedding\": {\n        \"name\": \"ImageEmbedding\",\n        \"methods\": [\n            \"getImageEmbedding\"\n        ],\n        \"properties\": []\n    },\n    \"LLMTools\": {\n        \"name\": \"LLMTools\",\n        \"methods\": [\n            \"callLLMTool\",\n            \"getLLMTools\"\n        ],\n        \"properties\": []\n    },\n    \"ScryptedSystemDevice\": {\n        \"name\": \"ScryptedSystemDevice\",\n        \"methods\": [],\n        \"properties\": [\n            \"systemDevice\"\n        ]\n    },\n    \"ScryptedDeviceCreator\": {\n        \"name\": \"ScryptedDeviceCreator\",\n        \"methods\": [],\n        \"properties\": []\n    },\n    \"ScryptedSettings\": {\n        \"name\": \"ScryptedSettings\",\n        \"methods\": [],\n        \"properties\": []\n    }\n};\n/**\n * @category Core Reference\n */\nvar ScryptedDeviceType;\n(function (ScryptedDeviceType) {\n    /**\n     * @deprecated\n     */\n    ScryptedDeviceType[\"Builtin\"] = \"Builtin\";\n    /**\n     * Internal devices will not show up in device lists unless explicitly searched.\n     */\n    ScryptedDeviceType[\"Internal\"] = \"Internal\";\n    ScryptedDeviceType[\"Camera\"] = \"Camera\";\n    ScryptedDeviceType[\"Fan\"] = \"Fan\";\n    ScryptedDeviceType[\"Light\"] = \"Light\";\n    ScryptedDeviceType[\"Switch\"] = \"Switch\";\n    ScryptedDeviceType[\"Outlet\"] = \"Outlet\";\n    ScryptedDeviceType[\"Sensor\"] = \"Sensor\";\n    ScryptedDeviceType[\"Scene\"] = \"Scene\";\n    ScryptedDeviceType[\"Program\"] = \"Program\";\n    ScryptedDeviceType[\"Automation\"] = \"Automation\";\n    ScryptedDeviceType[\"Vacuum\"] = \"Vacuum\";\n    ScryptedDeviceType[\"Notifier\"] = \"Notifier\";\n    ScryptedDeviceType[\"Thermostat\"] = \"Thermostat\";\n    ScryptedDeviceType[\"Lock\"] = \"Lock\";\n    ScryptedDeviceType[\"PasswordControl\"] = \"PasswordControl\";\n    /**\n     * Displays have audio and video output.\n     */\n    ScryptedDeviceType[\"Display\"] = \"Display\";\n    /**\n     * Smart Displays have two way audio and video.\n     */\n    ScryptedDeviceType[\"SmartDisplay\"] = \"SmartDisplay\";\n    ScryptedDeviceType[\"Speaker\"] = \"Speaker\";\n    /**\n     * Smart Speakers have two way audio.\n     */\n    ScryptedDeviceType[\"SmartSpeaker\"] = \"SmartSpeaker\";\n    ScryptedDeviceType[\"RemoteDesktop\"] = \"RemoteDesktop\";\n    ScryptedDeviceType[\"Event\"] = \"Event\";\n    ScryptedDeviceType[\"Entry\"] = \"Entry\";\n    ScryptedDeviceType[\"Garage\"] = \"Garage\";\n    ScryptedDeviceType[\"DeviceProvider\"] = \"DeviceProvider\";\n    ScryptedDeviceType[\"DataSource\"] = \"DataSource\";\n    ScryptedDeviceType[\"API\"] = \"API\";\n    ScryptedDeviceType[\"Buttons\"] = \"Buttons\";\n    ScryptedDeviceType[\"Doorbell\"] = \"Doorbell\";\n    ScryptedDeviceType[\"Irrigation\"] = \"Irrigation\";\n    ScryptedDeviceType[\"Valve\"] = \"Valve\";\n    ScryptedDeviceType[\"Person\"] = \"Person\";\n    ScryptedDeviceType[\"SecuritySystem\"] = \"SecuritySystem\";\n    ScryptedDeviceType[\"WindowCovering\"] = \"WindowCovering\";\n    ScryptedDeviceType[\"Siren\"] = \"Siren\";\n    ScryptedDeviceType[\"AirPurifier\"] = \"AirPurifier\";\n    ScryptedDeviceType[\"Internet\"] = \"Internet\";\n    ScryptedDeviceType[\"Network\"] = \"Network\";\n    ScryptedDeviceType[\"Bridge\"] = \"Bridge\";\n    ScryptedDeviceType[\"LLM\"] = \"LLM\";\n    ScryptedDeviceType[\"Unknown\"] = \"Unknown\";\n})(ScryptedDeviceType || (exports.ScryptedDeviceType = ScryptedDeviceType = {}));\nvar HumidityMode;\n(function (HumidityMode) {\n    HumidityMode[\"Humidify\"] = \"Humidify\";\n    HumidityMode[\"Dehumidify\"] = \"Dehumidify\";\n    HumidityMode[\"Auto\"] = \"Auto\";\n    HumidityMode[\"Off\"] = \"Off\";\n})(HumidityMode || (exports.HumidityMode = HumidityMode = {}));\nvar FanMode;\n(function (FanMode) {\n    FanMode[\"Auto\"] = \"Auto\";\n    FanMode[\"Manual\"] = \"Manual\";\n})(FanMode || (exports.FanMode = FanMode = {}));\nvar TemperatureUnit;\n(function (TemperatureUnit) {\n    TemperatureUnit[\"C\"] = \"C\";\n    TemperatureUnit[\"F\"] = \"F\";\n})(TemperatureUnit || (exports.TemperatureUnit = TemperatureUnit = {}));\nvar ThermostatMode;\n(function (ThermostatMode) {\n    ThermostatMode[\"Off\"] = \"Off\";\n    ThermostatMode[\"Cool\"] = \"Cool\";\n    ThermostatMode[\"Heat\"] = \"Heat\";\n    ThermostatMode[\"HeatCool\"] = \"HeatCool\";\n    ThermostatMode[\"Auto\"] = \"Auto\";\n    ThermostatMode[\"FanOnly\"] = \"FanOnly\";\n    ThermostatMode[\"Purifier\"] = \"Purifier\";\n    ThermostatMode[\"Eco\"] = \"Eco\";\n    ThermostatMode[\"Dry\"] = \"Dry\";\n    ThermostatMode[\"On\"] = \"On\";\n})(ThermostatMode || (exports.ThermostatMode = ThermostatMode = {}));\nvar PanTiltZoomMovement;\n(function (PanTiltZoomMovement) {\n    PanTiltZoomMovement[\"Absolute\"] = \"Absolute\";\n    PanTiltZoomMovement[\"Relative\"] = \"Relative\";\n    PanTiltZoomMovement[\"Continuous\"] = \"Continuous\";\n    PanTiltZoomMovement[\"Preset\"] = \"Preset\";\n    PanTiltZoomMovement[\"Home\"] = \"Home\";\n})(PanTiltZoomMovement || (exports.PanTiltZoomMovement = PanTiltZoomMovement = {}));\nvar LockState;\n(function (LockState) {\n    LockState[\"Locked\"] = \"Locked\";\n    LockState[\"Unlocked\"] = \"Unlocked\";\n    LockState[\"Jammed\"] = \"Jammed\";\n})(LockState || (exports.LockState = LockState = {}));\nvar ChargeState;\n(function (ChargeState) {\n    ChargeState[\"Trickle\"] = \"trickle\";\n    ChargeState[\"Charging\"] = \"charging\";\n    ChargeState[\"NotCharging\"] = \"not-charging\";\n})(ChargeState || (exports.ChargeState = ChargeState = {}));\nvar AirPurifierStatus;\n(function (AirPurifierStatus) {\n    AirPurifierStatus[\"Inactive\"] = \"Inactive\";\n    AirPurifierStatus[\"Idle\"] = \"Idle\";\n    AirPurifierStatus[\"Active\"] = \"Active\";\n    AirPurifierStatus[\"ActiveNightMode\"] = \"ActiveNightMode\";\n})(AirPurifierStatus || (exports.AirPurifierStatus = AirPurifierStatus = {}));\nvar AirPurifierMode;\n(function (AirPurifierMode) {\n    AirPurifierMode[\"Manual\"] = \"Manual\";\n    AirPurifierMode[\"Automatic\"] = \"Automatic\";\n})(AirPurifierMode || (exports.AirPurifierMode = AirPurifierMode = {}));\nvar AirQuality;\n(function (AirQuality) {\n    AirQuality[\"Unknown\"] = \"Unknown\";\n    AirQuality[\"Excellent\"] = \"Excellent\";\n    AirQuality[\"Good\"] = \"Good\";\n    AirQuality[\"Fair\"] = \"Fair\";\n    AirQuality[\"Inferior\"] = \"Inferior\";\n    AirQuality[\"Poor\"] = \"Poor\";\n})(AirQuality || (exports.AirQuality = AirQuality = {}));\nvar SecuritySystemMode;\n(function (SecuritySystemMode) {\n    SecuritySystemMode[\"Disarmed\"] = \"Disarmed\";\n    SecuritySystemMode[\"HomeArmed\"] = \"HomeArmed\";\n    SecuritySystemMode[\"AwayArmed\"] = \"AwayArmed\";\n    SecuritySystemMode[\"NightArmed\"] = \"NightArmed\";\n})(SecuritySystemMode || (exports.SecuritySystemMode = SecuritySystemMode = {}));\nvar SecuritySystemObstruction;\n(function (SecuritySystemObstruction) {\n    SecuritySystemObstruction[\"Sensor\"] = \"Sensor\";\n    SecuritySystemObstruction[\"Occupied\"] = \"Occupied\";\n    SecuritySystemObstruction[\"Time\"] = \"Time\";\n    SecuritySystemObstruction[\"Error\"] = \"Error\";\n})(SecuritySystemObstruction || (exports.SecuritySystemObstruction = SecuritySystemObstruction = {}));\nvar MediaPlayerState;\n(function (MediaPlayerState) {\n    MediaPlayerState[\"Idle\"] = \"Idle\";\n    MediaPlayerState[\"Playing\"] = \"Playing\";\n    MediaPlayerState[\"Paused\"] = \"Paused\";\n    MediaPlayerState[\"Buffering\"] = \"Buffering\";\n})(MediaPlayerState || (exports.MediaPlayerState = MediaPlayerState = {}));\nvar ScryptedInterface;\n(function (ScryptedInterface) {\n    ScryptedInterface[\"ScryptedDevice\"] = \"ScryptedDevice\";\n    ScryptedInterface[\"ScryptedPlugin\"] = \"ScryptedPlugin\";\n    ScryptedInterface[\"ScryptedPluginRuntime\"] = \"ScryptedPluginRuntime\";\n    ScryptedInterface[\"OnOff\"] = \"OnOff\";\n    ScryptedInterface[\"Brightness\"] = \"Brightness\";\n    ScryptedInterface[\"ColorSettingTemperature\"] = \"ColorSettingTemperature\";\n    ScryptedInterface[\"ColorSettingRgb\"] = \"ColorSettingRgb\";\n    ScryptedInterface[\"ColorSettingHsv\"] = \"ColorSettingHsv\";\n    ScryptedInterface[\"Buttons\"] = \"Buttons\";\n    ScryptedInterface[\"PressButtons\"] = \"PressButtons\";\n    ScryptedInterface[\"Sensors\"] = \"Sensors\";\n    ScryptedInterface[\"Notifier\"] = \"Notifier\";\n    ScryptedInterface[\"StartStop\"] = \"StartStop\";\n    ScryptedInterface[\"Pause\"] = \"Pause\";\n    ScryptedInterface[\"Dock\"] = \"Dock\";\n    ScryptedInterface[\"TemperatureSetting\"] = \"TemperatureSetting\";\n    ScryptedInterface[\"Thermometer\"] = \"Thermometer\";\n    ScryptedInterface[\"HumiditySensor\"] = \"HumiditySensor\";\n    ScryptedInterface[\"Camera\"] = \"Camera\";\n    ScryptedInterface[\"Resolution\"] = \"Resolution\";\n    ScryptedInterface[\"Microphone\"] = \"Microphone\";\n    ScryptedInterface[\"AudioVolumeControl\"] = \"AudioVolumeControl\";\n    ScryptedInterface[\"Display\"] = \"Display\";\n    ScryptedInterface[\"VideoCamera\"] = \"VideoCamera\";\n    ScryptedInterface[\"VideoCameraMask\"] = \"VideoCameraMask\";\n    ScryptedInterface[\"VideoTextOverlays\"] = \"VideoTextOverlays\";\n    ScryptedInterface[\"VideoRecorder\"] = \"VideoRecorder\";\n    ScryptedInterface[\"VideoRecorderManagement\"] = \"VideoRecorderManagement\";\n    ScryptedInterface[\"PanTiltZoom\"] = \"PanTiltZoom\";\n    ScryptedInterface[\"EventRecorder\"] = \"EventRecorder\";\n    ScryptedInterface[\"VideoClips\"] = \"VideoClips\";\n    ScryptedInterface[\"VideoCameraConfiguration\"] = \"VideoCameraConfiguration\";\n    ScryptedInterface[\"Intercom\"] = \"Intercom\";\n    ScryptedInterface[\"Lock\"] = \"Lock\";\n    ScryptedInterface[\"PasswordStore\"] = \"PasswordStore\";\n    ScryptedInterface[\"Scene\"] = \"Scene\";\n    ScryptedInterface[\"Entry\"] = \"Entry\";\n    ScryptedInterface[\"EntrySensor\"] = \"EntrySensor\";\n    ScryptedInterface[\"DeviceProvider\"] = \"DeviceProvider\";\n    ScryptedInterface[\"DeviceDiscovery\"] = \"DeviceDiscovery\";\n    ScryptedInterface[\"DeviceCreator\"] = \"DeviceCreator\";\n    ScryptedInterface[\"Battery\"] = \"Battery\";\n    ScryptedInterface[\"Charger\"] = \"Charger\";\n    ScryptedInterface[\"Reboot\"] = \"Reboot\";\n    ScryptedInterface[\"Refresh\"] = \"Refresh\";\n    ScryptedInterface[\"MediaPlayer\"] = \"MediaPlayer\";\n    ScryptedInterface[\"Online\"] = \"Online\";\n    ScryptedInterface[\"BufferConverter\"] = \"BufferConverter\";\n    ScryptedInterface[\"MediaConverter\"] = \"MediaConverter\";\n    ScryptedInterface[\"Settings\"] = \"Settings\";\n    ScryptedInterface[\"BinarySensor\"] = \"BinarySensor\";\n    ScryptedInterface[\"TamperSensor\"] = \"TamperSensor\";\n    ScryptedInterface[\"Sleep\"] = \"Sleep\";\n    ScryptedInterface[\"PowerSensor\"] = \"PowerSensor\";\n    ScryptedInterface[\"AudioSensor\"] = \"AudioSensor\";\n    ScryptedInterface[\"MotionSensor\"] = \"MotionSensor\";\n    ScryptedInterface[\"AmbientLightSensor\"] = \"AmbientLightSensor\";\n    ScryptedInterface[\"OccupancySensor\"] = \"OccupancySensor\";\n    ScryptedInterface[\"FloodSensor\"] = \"FloodSensor\";\n    ScryptedInterface[\"UltravioletSensor\"] = \"UltravioletSensor\";\n    ScryptedInterface[\"LuminanceSensor\"] = \"LuminanceSensor\";\n    ScryptedInterface[\"PositionSensor\"] = \"PositionSensor\";\n    ScryptedInterface[\"SecuritySystem\"] = \"SecuritySystem\";\n    ScryptedInterface[\"PM10Sensor\"] = \"PM10Sensor\";\n    ScryptedInterface[\"PM25Sensor\"] = \"PM25Sensor\";\n    ScryptedInterface[\"VOCSensor\"] = \"VOCSensor\";\n    ScryptedInterface[\"NOXSensor\"] = \"NOXSensor\";\n    ScryptedInterface[\"CO2Sensor\"] = \"CO2Sensor\";\n    ScryptedInterface[\"AirQualitySensor\"] = \"AirQualitySensor\";\n    ScryptedInterface[\"AirPurifier\"] = \"AirPurifier\";\n    ScryptedInterface[\"FilterMaintenance\"] = \"FilterMaintenance\";\n    ScryptedInterface[\"Readme\"] = \"Readme\";\n    ScryptedInterface[\"OauthClient\"] = \"OauthClient\";\n    ScryptedInterface[\"MixinProvider\"] = \"MixinProvider\";\n    ScryptedInterface[\"HttpRequestHandler\"] = \"HttpRequestHandler\";\n    ScryptedInterface[\"EngineIOHandler\"] = \"EngineIOHandler\";\n    ScryptedInterface[\"PushHandler\"] = \"PushHandler\";\n    ScryptedInterface[\"Program\"] = \"Program\";\n    ScryptedInterface[\"Scriptable\"] = \"Scriptable\";\n    ScryptedInterface[\"ClusterForkInterface\"] = \"ClusterForkInterface\";\n    ScryptedInterface[\"ObjectDetector\"] = \"ObjectDetector\";\n    ScryptedInterface[\"ObjectDetection\"] = \"ObjectDetection\";\n    ScryptedInterface[\"ObjectDetectionPreview\"] = \"ObjectDetectionPreview\";\n    ScryptedInterface[\"ObjectDetectionGenerator\"] = \"ObjectDetectionGenerator\";\n    ScryptedInterface[\"HumiditySetting\"] = \"HumiditySetting\";\n    ScryptedInterface[\"Fan\"] = \"Fan\";\n    ScryptedInterface[\"RTCSignalingChannel\"] = \"RTCSignalingChannel\";\n    ScryptedInterface[\"RTCSignalingClient\"] = \"RTCSignalingClient\";\n    ScryptedInterface[\"LauncherApplication\"] = \"LauncherApplication\";\n    ScryptedInterface[\"ScryptedUser\"] = \"ScryptedUser\";\n    ScryptedInterface[\"VideoFrameGenerator\"] = \"VideoFrameGenerator\";\n    ScryptedInterface[\"StreamService\"] = \"StreamService\";\n    ScryptedInterface[\"TTY\"] = \"TTY\";\n    ScryptedInterface[\"TTYSettings\"] = \"TTYSettings\";\n    ScryptedInterface[\"ChatCompletion\"] = \"ChatCompletion\";\n    ScryptedInterface[\"TextEmbedding\"] = \"TextEmbedding\";\n    ScryptedInterface[\"ImageEmbedding\"] = \"ImageEmbedding\";\n    ScryptedInterface[\"LLMTools\"] = \"LLMTools\";\n    ScryptedInterface[\"ScryptedSystemDevice\"] = \"ScryptedSystemDevice\";\n    ScryptedInterface[\"ScryptedDeviceCreator\"] = \"ScryptedDeviceCreator\";\n    ScryptedInterface[\"ScryptedSettings\"] = \"ScryptedSettings\";\n})(ScryptedInterface || (exports.ScryptedInterface = ScryptedInterface = {}));\nvar ScryptedMimeTypes;\n(function (ScryptedMimeTypes) {\n    ScryptedMimeTypes[\"Url\"] = \"text/x-uri\";\n    ScryptedMimeTypes[\"InsecureLocalUrl\"] = \"text/x-insecure-local-uri\";\n    ScryptedMimeTypes[\"LocalUrl\"] = \"text/x-local-uri\";\n    ScryptedMimeTypes[\"ServerId\"] = \"text/x-server-id\";\n    ScryptedMimeTypes[\"PushEndpoint\"] = \"text/x-push-endpoint\";\n    ScryptedMimeTypes[\"SchemePrefix\"] = \"x-scrypted/x-scrypted-scheme-\";\n    ScryptedMimeTypes[\"MediaStreamUrl\"] = \"text/x-media-url\";\n    ScryptedMimeTypes[\"MediaObject\"] = \"x-scrypted/x-scrypted-media-object\";\n    ScryptedMimeTypes[\"RequestMediaObject\"] = \"x-scrypted/x-scrypted-request-media-object\";\n    ScryptedMimeTypes[\"RequestMediaStream\"] = \"x-scrypted/x-scrypted-request-stream\";\n    ScryptedMimeTypes[\"MediaStreamFeedback\"] = \"x-scrypted/x-media-stream-feedback\";\n    ScryptedMimeTypes[\"FFmpegInput\"] = \"x-scrypted/x-ffmpeg-input\";\n    ScryptedMimeTypes[\"FFmpegTranscodeStream\"] = \"x-scrypted/x-ffmpeg-transcode-stream\";\n    ScryptedMimeTypes[\"RTCSignalingChannel\"] = \"x-scrypted/x-scrypted-rtc-signaling-channel\";\n    ScryptedMimeTypes[\"RTCSignalingSession\"] = \"x-scrypted/x-scrypted-rtc-signaling-session\";\n    ScryptedMimeTypes[\"RTCConnectionManagement\"] = \"x-scrypted/x-scrypted-rtc-connection-management\";\n    ScryptedMimeTypes[\"Image\"] = \"x-scrypted/x-scrypted-image\";\n})(ScryptedMimeTypes || (exports.ScryptedMimeTypes = ScryptedMimeTypes = {}));\n//# sourceMappingURL=index.js.map","import { Settings, Setting, MixinDeviceBase, ScryptedInterface, SettingValue, MixinDeviceOptions } from \"@scrypted/sdk\";\nimport sdk from \"@scrypted/sdk\";\n\nconst { deviceManager } = sdk;\n\nexport interface SettingsMixinDeviceOptions<T> extends MixinDeviceOptions<T & Settings> {\n    group: string;\n    groupKey: string;\n}\n\nexport abstract class SettingsMixinDeviceBase<T> extends MixinDeviceBase<T & Settings> implements Settings {\n    settingsGroup: string;\n    settingsGroupKey: string;\n\n    constructor(options: SettingsMixinDeviceOptions<T>) {\n        super(options);\n\n        this.settingsGroup = options.group;\n        this.settingsGroupKey = options.groupKey;\n        process.nextTick(() => deviceManager.onMixinEvent(this.id, this, ScryptedInterface.Settings, null));\n    }\n\n    abstract getMixinSettings(): Promise<Setting[]>;\n    abstract putMixinSetting(key: string, value: SettingValue): Promise<boolean|void>;\n\n    async getSettings(): Promise<Setting[]> {\n        const settingsPromise = this.mixinDeviceInterfaces.includes(ScryptedInterface.Settings) ? this.mixinDevice.getSettings() : undefined;\n        const mixinSettingsPromise = this.getMixinSettings();\n        const allSettings: Setting[] = [];\n\n        try {\n            const settings = (await settingsPromise) || [];\n            allSettings.push(...settings);\n        }\n        catch (e) {\n            const name = this.name;\n            const description = `${name} Extension settings failed to load.`;\n            this.console.error(description, e)\n            allSettings.push({\n                key: Math.random().toString(),\n                title: name,\n                value: 'Settings Error',\n                group: 'Errors',\n                description,\n                readonly: true,\n            });\n        }\n\n        try {\n            const mixinSettings = (await mixinSettingsPromise) || [];\n            for (const setting of mixinSettings) {\n                setting.group = setting.group || this.settingsGroup;\n                setting.key = this.settingsGroupKey + ':' + setting.key;\n            }\n            allSettings.push(...mixinSettings);\n        }\n        catch (e) {\n            const name = deviceManager.getDeviceState(this.mixinProviderNativeId).name;\n            const description = `${name} Extension settings failed to load.`;\n            this.console.error(description, e)\n            allSettings.push({\n                key: Math.random().toString(),\n                title: name,\n                value: 'Settings Error',\n                group: 'Errors',\n                description,\n                readonly: true,\n            });\n        }\n\n        return allSettings;\n    }\n\n    async putSetting(key: string, value: SettingValue) {\n        const prefix = this.settingsGroupKey + ':';\n        if (!key?.startsWith(prefix)) {\n            return this.mixinDevice.putSetting(key, value);\n        }\n\n        if (!await this.putMixinSetting(key.substring(prefix.length), value))\n            deviceManager.onMixinEvent(this.id, this, ScryptedInterface.Settings, null);\n    }\n\n    async release() {\n        await deviceManager.onMixinEvent(this.id, this, ScryptedInterface.Settings, null);\n    }\n}\n","import { ScryptedDevice, ScryptedDeviceBase, ScryptedDeviceType, ScryptedInterface } from \"@scrypted/sdk\";\nimport sdk from \"@scrypted/sdk\";\n\nconst { systemManager } = sdk;\n\n\nexport abstract class AutoenableMixinProvider extends ScryptedDeviceBase {\n    hasEnabledMixin: { [id: string]: string } = {};\n    pluginsComponent: Promise<any>;\n\n    constructor(nativeId?: string, public autoIncludeToken = 'v4') {\n        super(nativeId);\n\n        try {\n            this.hasEnabledMixin = JSON.parse(this.storage.getItem('hasEnabledMixin'));\n        }\n        catch (e) {\n            this.hasEnabledMixin = {};\n        }\n\n        this.pluginsComponent = systemManager.getComponent('plugins');\n\n        // watch for descriptor changes.\n        systemManager.listen(async (eventSource, eventDetails, eventData) => {\n            if (eventDetails.eventInterface !== ScryptedInterface.ScryptedDevice || eventDetails.property)\n                return;\n\n            this.maybeEnableMixin(eventSource);\n        });\n\n        process.nextTick(() => {\n            for (const id of Object.keys(systemManager.getSystemState())) {\n                const device = systemManager.getDeviceById(id);\n                this.maybeEnableMixin(device);\n            }\n        });\n    }\n\n    async shouldEnableMixin(device: ScryptedDevice) {\n        return true;\n    }\n\n    checkHasEnabledMixin(device: ScryptedDevice) {\n        return this.hasEnabledMixin[device.id] === this.autoIncludeToken;\n    }\n\n    shouldUnshiftMixin(device: ScryptedDevice) {\n        return false;\n    }\n\n    async maybeEnableMixin(device: ScryptedDevice) {\n        if (!device || device.mixins?.includes(this.id))\n            return;\n\n        if (this.checkHasEnabledMixin(device))\n            return;\n\n        const match = await this.canMixin(device.type, device.interfaces);\n        if (!match)\n            return;\n\n        if (!await this.shouldEnableMixin(device))\n            return;\n\n        this.log.i('auto enabling mixin for ' + device.name)\n        const mixins = (device.mixins || []).slice();\n        if (this.shouldUnshiftMixin(device))\n            mixins.unshift(this.id);\n        else\n            mixins.push(this.id);\n        const plugins = await this.pluginsComponent;\n        await plugins.setMixins(device.id, mixins);\n        this.setHasEnabledMixin(device.id);\n    }\n\n    setHasEnabledMixin(id: string) {\n        if (this.hasEnabledMixin[id] === this.autoIncludeToken)\n            return;\n        this.hasEnabledMixin[id] = this.autoIncludeToken;\n        this.storage.setItem('hasEnabledMixin', JSON.stringify(this.hasEnabledMixin));\n    }\n\n    abstract canMixin(type: ScryptedDeviceType | string, interfaces: string[]): Promise<string[] | null | undefined | void>;\n}\n","// todo: move this to ring.\nexport function replacePorts(sdp: string, audioPort: number, videoPort: number) {\n    let outputSdp = sdp\n        .replace(/c=IN .*/, `c=IN IP4 127.0.0.1`)\n        .replace(/m=audio \\d+/, `m=audio ${audioPort}`)\n        .replace(/m=video \\d+/, `m=video ${videoPort}`);\n    return outputSdp;\n}\n\nexport function replaceSectionPort(sdp: string, section: string, port: number) {\n    const regex = new RegExp(`m=${section} \\\\d+`)\n    let outputSdp = sdp\n        .replace(/c=IN .*/, `c=IN IP4 127.0.0.1`)\n        .replace(regex, `m=${section} ${port}`);\n    return outputSdp;\n}\n\nexport function addTrackControls(sdp: string) {\n    let lines = sdp.split('\\n').map(line => line.trim());\n    lines = lines.filter(line => !line.includes('a=control:'));\n    let trackCount = 0;\n    for (let i = 0; i < lines.length; i++) {\n        const line = lines[i];\n        if (!line.startsWith('m='))\n            continue;\n        lines.splice(i + 1, 0, 'a=control:trackID=' + trackCount);\n        trackCount++;\n    }\n    return lines.join('\\r\\n')\n}\n\n// todo: move this to webrtc\n// this is an sdp corresponding to what is requested from webrtc.\n// h264 baseline and opus are required codecs that all webrtc implementations must provide.\nexport function createSdpInput(audioPort: number, videoPort: number, sdp: string) {\n    // replace all IPs\n    let outputSdp = sdp\n        .replace(/c=IN .*/, `c=IN IP4 127.0.0.1`)\n        .replace(/m=audio \\d+/, `m=audio ${audioPort}`)\n        .replace(/m=video \\d+/, `m=video ${videoPort}`);\n\n    // filter all ice and rtcp mux info\n    let lines = outputSdp.split('\\n').map(line => line.trim());\n    lines = lines\n        .filter(line => !line.includes('a=rtcp-mux'))\n        .filter(line => !line.includes('a=candidate'))\n        .filter(line => !line.includes('a=ice'));\n\n    outputSdp = lines.join('\\r\\n');\n\n    outputSdp = addTrackControls(outputSdp);\n\n    // only include the m sections.\n    outputSdp = outputSdp.split('m=')\n        .slice(1)\n        .map(line => 'm=' + line)\n        .join('');\n    return outputSdp;\n}\n\n// todo: move this to webrtc\nexport function findFmtp(sdp: string, codec: string) {\n    let lines = sdp.split('\\n').map(line => line.trim());\n\n    const re = new RegExp(`a=rtpmap:(\\\\d+) ${codec}`);\n    const rtpmaps = lines.map(line => line.match(re)).filter(match => !!match);\n    return rtpmaps.map(match => {\n        const payloadType = parseInt(match[1]);\n        const fmtpPrefix = `a=fmtp:${payloadType} `;\n        const fmtp = lines.find(line => line.startsWith(fmtpPrefix))?.substring(fmtpPrefix.length);\n        return {\n            payloadType,\n            fmtp,\n        }\n    })\n}\n\nfunction getSections(sdp: string) {\n    const sections = ('\\n' + sdp).split('\\nm=');\n    return sections;\n}\n\nexport function findTrackByType(sdp: string, type: string, directions: TrackDirection[] = ['recvonly', 'sendrecv']) {\n    const sections = getSections(sdp).filter(track => track.startsWith(type));\n\n    for (const section of sections) {\n        const returnTrack = () => {\n            const lines = section.split('\\n').map(line => line.trim());\n            const controlString = 'a=control:';\n            const control = lines.find(line => line.startsWith(controlString));\n            return {\n                section: 'm=' + section,\n                trackId: control.substring(controlString.length),\n            };\n        }\n\n        for (const dir of directions) {\n            if (section.includes(`a=${dir}`)) {\n                return returnTrack();\n            }\n        }\n\n        // some sdp do not advertise a media flow direction. i think recvonly is the default?\n        if ((directions.includes('recvonly'))\n            && !section.includes('sendonly')\n            && !section.includes('inactive')) {\n            return returnTrack();\n        }\n    }\n}\n\ntype TrackDirection = 'sendonly' | 'sendrecv' | 'recvonly' | 'inactive';\n\nexport function findTracksByType(sdp: string, directions: TrackDirection[] = ['recvonly', 'sendrecv']) {\n    return {\n        audio: findTrackByType(sdp, 'audio', directions)?.trackId,\n        video: findTrackByType(sdp, 'video', directions)?.trackId,\n    };\n}\n\nexport function parseMLinePayloadTypes(mline: string) {\n    const payloadTypes: number[] = [];\n    for (const pt of mline.split(' ').slice(3) || []) {\n        payloadTypes.push(parseInt(pt));\n    }\n    return payloadTypes;\n}\n\nexport function parseMLine(mline: string) {\n    // 'm=audio 0 RTP/AVP 96'\n    const split = mline.split(' ');\n    const type = split[0].substring(2);\n    return {\n        type,\n        port: parseInt(split[1]),\n        protocol: split[2],\n        payloadTypes: parseMLinePayloadTypes(mline),\n    }\n}\n\nconst afmtp = 'a=fmtp';\nexport function parseFmtp(msection: string[]) {\n    return msection.filter(line => line.startsWith(afmtp))\n        .map(fmtpLine => {\n            const firstSpace = fmtpLine.indexOf(' ');\n            if (firstSpace === -1)\n                return;\n            const fmtp = fmtpLine.substring(0, firstSpace);\n            const paramLine = fmtpLine.substring(firstSpace + 1);\n            const payloadType = parseInt(fmtp.split(':')[1]);\n\n            if (!fmtp || !paramLine || Number.isNaN(payloadType)) {\n                return;\n            }\n\n            const parameters: {\n                [key: string]: string;\n            } = {};\n\n            paramLine.split(';').map(param => param.trim()).forEach(param => {\n                const [key, ...value] = param.split('=');\n                parameters[key] = value.join('=');\n            });\n            return {\n                payloadType,\n                parameters,\n            }\n        })\n        .filter(fmtp => !!fmtp);\n}\n\nexport type MSection = ReturnType<typeof parseMSection>;\nexport type RTPMap = ReturnType<typeof parseRtpMap>;\n\nexport function parseRtpMap(mline: ReturnType<typeof parseMLine>, rtpmap: string) {\n    const mlineType = mline.type;\n    const match = rtpmap?.match(/a=rtpmap:([\\d]+) (.*?)\\/([\\d]+)(\\/([\\d]+))?/);\n    let channels = parseInt(match?.[5]) || undefined;\n    let payloadType = parseInt(match?.[1]);\n\n    rtpmap = rtpmap?.toLowerCase();\n\n    let codec: string;\n    let ffmpegEncoder: string;\n    if (rtpmap?.includes('mpeg4')) {\n        codec = 'aac';\n        ffmpegEncoder = 'aac';\n    }\n    else if (rtpmap?.includes('opus')) {\n        codec = 'opus';\n        ffmpegEncoder = 'libopus';\n    }\n    else if (rtpmap?.includes('pcma')) {\n        codec = 'pcm_alaw';\n        ffmpegEncoder = 'pcm_alaw';\n    }\n    else if (rtpmap?.includes('pcmu')) {\n        codec = 'pcm_mulaw';\n        ffmpegEncoder = 'pcm_mulaw';\n    }\n    else if (rtpmap?.includes('g726')) {\n        codec = 'g726';\n        // disabled since it 48000 is non compliant in ffmpeg and fails.\n        // ffmpegEncoder = 'g726';\n    }\n    else if (rtpmap?.includes('pcm')) {\n        codec = 'pcm';\n    }\n    else if (rtpmap?.includes('l16')) {\n        codec = 'pcm_s16be';\n        ffmpegEncoder = 'pcm_s16be';\n    }\n    else if (rtpmap?.includes('speex')) {\n        codec = 'speex';\n        ffmpegEncoder = 'libspeex';\n    }\n    else if (rtpmap?.includes('h264')) {\n        codec = 'h264';\n    }\n    else if (rtpmap?.includes('h265')) {\n        codec = 'h265';\n    }\n    else if (!rtpmap && mlineType === 'audio') {\n        if (mline.payloadTypes?.includes(0)) {\n            codec = 'pcm_mulaw';\n            ffmpegEncoder = 'pcm_mulaw';\n            payloadType = 0;\n            channels = 1;\n        }\n        else if (mline.payloadTypes?.includes(8)) {\n            codec = 'pcm_alaw';\n            ffmpegEncoder = 'pcm_alaw';\n            payloadType = 8;\n            channels = 1;\n        }\n        else if (mline.payloadTypes?.includes(14)) {\n            codec = 'mp3';\n            ffmpegEncoder = 'mp3';\n            payloadType = 14;\n            channels = 2;\n        }\n        else {\n            // ffmpeg seems to omit the rtpmap type for pcm alaw when creating sdp?\n            // is this the default?\n            // 2/21/2024: the paylaod types are included in the mline, and this is legacy code\n            // that maybe should be updated to use the mline payload types when no rtpmap(s) are available.\n            // https://en.wikipedia.org/wiki/RTP_payload_formats\n            codec = 'pcm_alaw';\n            ffmpegEncoder = 'pcm_alaw';\n            payloadType = 8;\n            channels = 1;\n        }\n    }\n\n    // assigned payload types do not need to provide a clock, there is a default.\n    let clock = parseInt(match?.[3]);\n    if (!clock) {\n        clock = undefined;\n        if (codec === 'pcm_mulaw' || codec === 'pcm_alaw')\n            clock = 8000;\n        else if (codec === 'pcm_s16be')\n            clock = 16000;\n    }\n\n    return {\n        line: rtpmap,\n        codec,\n        ffmpegEncoder,\n        rawCodec: match?.[2],\n        clock,\n        channels,\n        payloadType,\n    }\n}\n\nconst acontrol = 'a=control:';\nconst artpmap = 'a=rtpmap:';\nexport function parseMSection(msection: string[]) {\n    const control = msection.find(line => line.startsWith(acontrol))?.substring(acontrol.length);\n    const mline = parseMLine(msection[0]);\n    const rawRtpmaps = msection.filter(line => line.startsWith(artpmap));\n    const rtpmaps = rawRtpmaps.map(line => parseRtpMap(mline, line));\n    // if no rtp map is specified, pcm_alaw is used. parsing a null rtpmap is valid.\n    const rtpmap = parseRtpMap(mline, rawRtpmaps[0]);\n    const { codec } = rtpmap;\n    let direction: string;\n\n    for (const checkDirection of ['sendonly', 'sendrecv', 'recvonly', 'inactive']) {\n        const found = msection.find(line => line === 'a=' + checkDirection);\n        if (found) {\n            direction = checkDirection;\n            break;\n        }\n    }\n\n    const ret = {\n        ...mline,\n        fmtp: parseFmtp(msection),\n        lines: msection,\n        rtpmaps,\n        contents: msection.join('\\r\\n'),\n        control,\n        codec,\n        rtpmap,\n        direction,\n        toSdp: () => {\n            return ret.lines.join('\\r\\n');\n        }\n    }\n\n    return ret;\n}\n\nexport type ParsedSdp = ReturnType<typeof parseSdp>;\n\nexport function parseSdp(sdp: string) {\n    const lines = sdp.split('\\n').map(line => line.trim());\n    const header: string[] = [];\n    const msections: string[][] = [];\n    let msection: string[];\n\n    for (const line of lines) {\n        if (line.startsWith('m=')) {\n            if (msection) {\n                msections.push(msection);\n            }\n            msection = [];\n        }\n\n        if (msection) {\n            msection.push(line);\n        }\n        else {\n            header.push(line);\n        }\n    }\n\n    if (msection)\n        msections.push(msection);\n\n    const ret = {\n        header: {\n            lines: header,\n            contents: header.join('\\r\\n'),\n        },\n        msections: msections.map(parseMSection),\n        toSdp: () => {\n            return [...ret.header.lines, ...ret.msections.map(msection => msection.lines).flat()].join('\\r\\n');\n        }\n    }\n\n    return ret;\n}\n\nexport function getSpsPps(\n    section: {\n        fmtp: {\n            payloadType: number;\n            parameters: {\n                [key: string]: string;\n            };\n        }[]\n    }\n) {\n    const spspps = section?.fmtp?.[0]?.parameters?.['sprop-parameter-sets']?.split(',');\n    // empty sprop-parameter-sets is apparently a thing:\n    //     a=fmtp:96 profile-level-id=420029; packetization-mode=1; sprop-parameter-sets=\n    if (spspps?.length !== 2) {\n        return {\n            sps: undefined,\n            pps: undefined,\n        };\n    }\n\n    const [sps, pps] = spspps;\n\n    return {\n        sps: Buffer.from(sps, 'base64'),\n        pps: Buffer.from(pps, 'base64'),\n    }\n}\n\nexport function getSpsPpsVps(\n    section: {\n        fmtp: {\n            payloadType: number;\n            parameters: {\n                [key: string]: string;\n            };\n        }[]\n    }\n) {\n    const parameters = section?.fmtp?.[0]?.parameters;\n    if (!parameters) {\n        return {\n            sps: undefined,\n            pps: undefined,\n            vps: undefined,\n        };\n    }\n\n    const sps = parameters['sprop-sps'];\n    const pps = parameters['sprop-pps'];\n    const vps = parameters['sprop-vps'];\n\n    return {\n        sps: sps ? Buffer.from(sps, 'base64') : undefined,\n        pps: pps ? Buffer.from(pps, 'base64') : undefined,\n        vps: vps ? Buffer.from(vps, 'base64') : undefined,\n    }\n}","module.exports = require(\"fs\");","import { Deferred } from \"@scrypted/common/src/deferred\";\nimport { Headers, RtspServer } from \"@scrypted/common/src/rtsp-server\";\nimport fs from 'fs';\nimport path from 'path';\nimport { Duplex } from \"stream\";\n\nconst highWaterMark = 1024 * 1024;\nconst bufferOverflow = 100 * 1024 * 1024;\n\n// non standard extension that dumps the rtp payload to a file.\nexport class FileRtspServer extends RtspServer {\n    writeStream: fs.WriteStream;\n    segmentBytesWritten = 0;\n    writeConsole: Console;\n\n    constructor(client: Duplex, sdp?: string, checkRequest?: (method: string, url: string, headers: Headers, rawMessage: string[]) => Promise<boolean>) {\n        super(client, sdp, undefined, checkRequest);\n\n        this.client.on('close', () => {\n            if (this.writeStream)\n                this.writeConsole?.log('RTSP WRITE client closed.');\n            this.cleanup();\n        });\n\n        this.availableOptions.push('WRITE', \"WRITESIZE\");\n    }\n\n    cleanup() {\n        const ws = this.writeStream;\n        if (!ws)\n            return;\n        this.writeStream = undefined;\n        ws?.end(() => ws?.destroy());\n    }\n\n    async write(url: string, requestHeaders: Headers) {\n        const recordingFile = requestHeaders['x-scrypted-rtsp-file'];\n\n        if (!recordingFile)\n            return this.respond(400, 'Bad Request', requestHeaders, {});\n\n        await fs.promises.mkdir(path.dirname(recordingFile), {\n            recursive: true,\n        });\n\n        const truncate = requestHeaders['x-scrypted-rtsp-file-truncate'];\n\n        // this.writeConsole?.log('RTSP WRITE file', file);\n\n        // truncation preparation must happen before cleanup.\n        let truncateWriteStream: fs.WriteStream;\n        if (truncate) {\n            try {\n                const d = new Deferred<number>();\n                fs.open(truncate, 'w', (e, fd) => {\n                    if (e)\n                        d.reject(e);\n                    else\n                        d.resolve(fd);\n                });\n                const fd = await d.promise;\n                try {\n                    await fs.promises.rename(truncate, recordingFile);\n                    truncateWriteStream = fs.createWriteStream(undefined, {\n                        fd,\n                        highWaterMark,\n                    })\n                    // this.writeConsole?.log('truncating', truncate);\n                }\n                catch (e) {\n                    throw e;\n                }\n            }\n            catch (e) {\n                this.writeConsole?.error('RTSP WRITE error during truncate file', truncate, e);\n            }\n        }\n\n        // everything after this point must be sync due to cleanup potentially causing dangling state.\n        this.cleanup();\n        this.segmentBytesWritten = 0;\n\n        this.writeStream = truncateWriteStream || fs.createWriteStream(recordingFile, {\n            highWaterMark,\n        });\n        this.writeStream.on('error', e => {\n            this.writeConsole?.error('RTSP WRITE error', e);\n        });\n        this.respond(200, 'OK', requestHeaders, {});\n    }\n\n    writesize(url: string, requestHeaders: Headers) {\n        this.respond(200, 'OK', requestHeaders, {\n            'x-scrypted-rtsp-file-size': this.segmentBytesWritten.toString(),\n        });\n    }\n\n    writeRtpPayload(header: Buffer, rtp: Buffer): boolean {\n        if (!this.writeStream)\n            return super.writeRtpPayload(header, rtp);\n\n        this.segmentBytesWritten += header.length + rtp.length;\n        if (this.writeStream.writableLength > bufferOverflow) {\n            this.writeConsole?.error('RTSP WRITE overflowed.');\n            this.cleanup();\n            this.client?.destroy();\n            return;\n        }\n        this.writeStream.write(header);\n        return this.writeStream.write(rtp);\n    }\n}","module.exports = require(\"path\");","module.exports = require(\"process\");","module.exports = require(\"crypto\");","import { ChildProcess } from \"child_process\";\nimport process from 'process';\nimport { sleep } from \"./sleep\";\n\nconst filtered = [\n    'decode_slice_header error',\n    'no frame!',\n    'non-existing PPS',\n];\n\nexport async function safeKillFFmpeg(cp: ChildProcess) {\n    if (!cp)\n        return;\n    if (cp.exitCode != null)\n        return;\n    await new Promise(async resolve => {\n        cp.on('exit', resolve);\n        // this will allow ffmpeg to send rtsp TEARDOWN etc\n        try {\n            cp.stdin!.on('error', () => { });\n            cp.stdin!.write('q\\n');\n        }\n        catch (e) {\n        }\n\n        await sleep(2000);\n        for (const f of cp.stdio) {\n            try {\n                f?.destroy();\n            }\n            catch (e) {\n            }\n        }\n        cp.kill();\n        await sleep(2000);\n        cp.kill('SIGKILL');\n    });\n}\n\nexport function ffmpegLogInitialOutput(console: Console, cp: ChildProcess, forever?: boolean, storage?: Storage) {\n    if (!console)\n        return;\n\n    const SCRYPTED_FFMPEG_NOISY = !!process.env.SCRYPTED_FFMPEG_NOISY || !!storage?.getItem('SCRYPTED_FFMPEG_NOISY');\n\n    function logger(log: (str: string) => void): (buffer: Buffer) => void {\n        const ret = (buffer: Buffer) => {\n            const str = buffer.toString();\n\n            for (const filter of filtered) {\n                if (str.indexOf(filter) !== -1)\n                    return;\n            }\n\n            if (!SCRYPTED_FFMPEG_NOISY && !forever && (str.indexOf('frame=') !== -1 || str.indexOf('size=') !== -1)) {\n                log(str);\n                log('video/audio detected, discarding further input');\n                cp.stdout!.removeListener('data', ret);\n                cp.stderr!.removeListener('data', ret);\n                return;\n            }\n\n            log(str);\n        }\n\n        return ret;\n    };\n    cp.stdout?.on('data', logger(console.log));\n    cp.stderr?.on('data', logger(console.error));\n    cp.on('exit', () => console.log('ffmpeg exited'));\n}\n\nexport function safePrintFFmpegArguments(console: Console, args: string[]) {\n    if (!console)\n        return;\n    const ret = [];\n    let redactNext = false;\n    for (const arg of args) {\n        try {\n            if (redactNext) {\n                const url = new URL(arg);\n                ret.push(`${url.protocol}[REDACTED]`)\n            }\n            else {\n                ret.push(arg);\n            }\n        }\n        catch (e) {\n            ret.push(arg);\n        }\n\n        // input arguments may contain passwords.\n        redactNext = arg === '-i';\n    }\n\n    console.log(ret.join(' '));\n}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(431);\n"],"names":["module","exports","require","sps","SubWidthC","SubHeightC","chroma_format_idc","color_plane_flag","PicWidthInMbs","pic_width_in_mbs","PicHeightInMapUnits","pic_height_in_map_units","FrameHeightInMbs","frame_mbs_only_flag","crop_left","crop_right","crop_top","crop_bottom","frame_cropping_flag","frame_cropping","left","right","top","bottom","width","height","hrd_parameters","hrd","stream","cpb_cnt_minus1","ExpGolomb","cpb_cnt","bit_rate_scale","readNibble","cpb_size_scale","i","bit_rate_value","cpb_size_value","cbr_flag","readBit","initial_cpb_removal_delay_length","read5","cpb_removal_delay_length","dpb_output_delay_length","time_offset_length","Object","defineProperty","value","getVUIParams","flag","vp","aspect_ratio_info_present_flag","aspect_ratio_idc","sar_width","sar_height","overscan_info_present_flag","overscan_appropriate_flag","video_signal_type_present_flag","video_format","video_full_range_flag","colour_description_present_flag","colour_primaries","transfer_characteristics","matrix_coefficients","chroma_loc_info_present_flag","chroma_sample_loc_type_top_field","chroma_sample_loc_type_bottom_field","timing_info_present_flag","num_units_in_tick","time_scale","fixed_frame_rate_flag","nal_hrd_parameters_present_flag","vcl_hrd_parameters_present_flag","hrd_params","low_delay_hrd_flag","pic_struct_present_flag","bitstream_restriction_flag","motion_vectors_over_pic_boundaries_flag","max_bytes_per_pic_denom","max_bits_per_mb_denom","log2_max_mv_length_horizontal","log2_max_mv_length_vertical","num_reorder_frames","max_dec_frame_buffering","readByte","readWord","QUOTE","EQUAL","SEPARATOR","KEYVALUE_REGEXP","parseHTTPHeadersQuotedKeyValueSet","contents","authorizedKeys","requiredKeys","valuesToNormalize","matches","trim","match","data","map","part","partPosition","key","rest","split","join","length","reduce","parsedValues","name","valuePosition","normalizedName","toLowerCase","indexOf","strippedValue","replace","includes","_checkRequiredKeys","buildHTTPHeadersQuotedKeyValueSet","forEach","async","console","url","urls","addresses","endpointManager","getLocalAddresses","address","u","URL","hostname","isIPv6","toString","e","warn","process","env","SCRYPTED_CLUSTER_ADDRESS","clusterUrl","str","push","REQUIRED_WWW_AUTHENTICATE_KEYS","AUTHORIZED_WWW_AUTHENTICATE_KEYS","BASIC","type","parseWWWAuthenticateRest","buildWWWAuthenticateRest","parseAuthorizationRest","username","password","decodeHash","hash","buildAuthorizationRest","computeHash","Buffer","from","passwordParts","REQUIRED_AUTHORIZATION_KEYS","Deferred","finished","promise","Promise","resolve","reject","this","v","Symbol","dispose","Error","resolvePromise","p","streamChunk","naluType","findH264NaluTypeInNalu","chunks","subarray","findH265NaluTypeInNalu","options","container","tcpProtocol","randomBytes","inputArguments","outputArguments","vcodec","acodec","findSyncFrame","streamChunks","prebufferIndex","naluTypes","getStartedH264NaluTypes","has","H264_NAL_TYPE_SPS","H264_NAL_TYPE_IDR","slice","isH265KeyFrameRelatedInSet","getStartedH265NaluTypes","sdp","r","parse","duplex","server","RtspServer","handleSetup","rtcp","header","packet","handleRecord","pathToken","clientPromise","listenZeroSingleClient","rtspServerPath","rtspServerPromise","then","client","rtspServer","createServer","checkRequest","method","headers","message","undefined","pathname","readMessage","currentHeaders","line","readLine","readBody","response","cl","parseInt","readLength","writeMessage","messageLine","body","entries","write","log","parseH264NaluType","firstNaluByte","nalu","checkNaluType","H264_NAL_TYPE_STAP_A","pos","naluLength","readUInt16BE","H264_NAL_TYPE_FU_A","fuaType","isFuStart","parseH265NaluType","H265_NAL_TYPE_AGG","Set","getNaluTypesInNalu","fuaRequireStart","fuaRequireEnd","ret","add","stapaType","getNaluTypesInH265Nalu","H265_NAL_TYPE_FU","allowCodecInfo","H265_NAL_TYPE_IDR_N_LP","H265_NAL_TYPE_IDR_W_RADL","H265_NAL_TYPE_CRA_NUT","H265_NAL_TYPE_BLA_N_LP","H265_NAL_TYPE_BLA_W_LP","H265_NAL_TYPE_BLA_W_RADL","H265_NAL_TYPE_VPS","H265_NAL_TYPE_SPS","H265_NAL_TYPE_PPS","parseHeaders","index","substring","getFirstAuthenticateHeader","parseSemicolonDelimited","dict","RTSP_FRAME_MAGIC","H264_NAL_TYPE_RESERVED0","H264_NAL_TYPE_RESERVED30","H264_NAL_TYPE_RESERVED31","H264_NAL_TYPE_SEI","H264_NAL_TYPE_PPS","H264_NAL_TYPE_STAP_B","H264_NAL_TYPE_FU_B","H264_NAL_TYPE_MTAP16","H264_NAL_TYPE_MTAP32","H265_NAL_TYPE_SEI_PREFIX","H265_NAL_TYPE_SEI_SUFFIX","RtspStatusError","constructor","status","super","RtspBase","cseq","needKeepAlive","setupOptions","Map","issuedTeardown","hasGetParameter","port","startsWith","connect","rejectUnauthorized","host","on","safeTeardown","writeTeardown","sleep","destroy","writeRequest","path","fullUrl","contentBase","endsWith","sanitized","wwwAuthenticate","createAuthorizationHeader","session","handleDataPayload","channel","readUInt8","get","onRtp","readDataPayload","createBadHeader","readLoopLegacy","getParameter","handleStream","unshift","id","readLoop","deferred","read","writeGetParameter","writeOptions","removeListener","h","all","once","authedUrl","decodeURIComponent","wwwAuth","strippedUrl","ha1","createHash","update","realm","digest","ha2","nonce","params","uri","algorithm","request","authenticating","requestTimeout","timeoutPromise","statusLine","version","codeString","reason","code","publicHeader","describe","Accept","setup","protocol","dgram","udp","createBindZero","closeQuiet","assign","Transport","interleaved","sessionDict","timeout","timer","setInterval","clearInterval","transport","_","begin","end","set","play","start","writePlay","Range","writeRtpPayload","rtp","send","alloc","writeUInt8","writeUInt16BE","pause","teardown","setupTracks","availableOptions","Socket","setNoDelay","methods","handlePlayback","handleTeardown","destination","track","values","find","codec","sendUdp","sendTrack","trackId","requestHeaders","respond","get_parameter","setupInterleaved","msection","low","high","control","parseSdp","msections","resolveInterleaved","rtpServer","rtcpServer","createSquentialBindZero","rtpInfo","announce","contentLength","sdpBuffer","record","allow","error","toUpperCase","buffer","bitstream_1","Bitstream","vui_1","scaling_list","sizeOfScalingList","use_default","lastScale","nextScale","scalingList","j","SignedExpGolomb","DataView","byteOffset","profile_idc","profile_compatibility","level_idc","sps_id","bit_depth_luma","bit_depth_chroma","qpprime_y_zero_transform_bypass_flag","seq_scaling_matrix_present_flag","scaling_list_4x4","scaling_list_8x8","use_default_scaling_matrix_4x4_flag","use_default_scaling_matrix_8x8_flag","limit","log2_max_frame_num","pic_order_cnt_type","delta_pic_order_always_zero_flag","offset_for_non_ref_pic","offset_for_top_to_bottom_field","offset_for_ref_frame","log2_max_pic_order_cnt_lsb","num_ref_frames_in_pic_order_cnt_cycle","max_num_ref_frames","gaps_in_frame_num_value_allowed_flag","mb_adaptive_frame_field_flag","direct_8x8_inference_flag","getFrameCropping","vui_parameters_present_flag","seq_scaling_matrix","vui_parameters","webpackEmptyContext","req","keys","ownKeys","__createBinding","create","o","m","k","k2","desc","getOwnPropertyDescriptor","__esModule","writable","configurable","enumerable","__setModuleDefault","__importStar","getOwnPropertyNames","ar","prototype","hasOwnProperty","call","mod","result","StorageSettings","_1","systemManager","default","device","settings","hasValue","setting","rawGet","getItem","JSON","putSetting","storage","getSettings","onGet","s","hide","getItemInternal","deviceFilter","onPut","mapPut","mapGet","oldValue","putSettingInternal","noStore","removeItem","setItem","stringify","onDeviceEvent","ScryptedInterface","Settings","rawDevice","readDefaultValue","multiple","n","parseFloat","isNaN","getDeviceById","json","parseValue","persistedDefaultValue","defaultValue","view","bitoffset","zeros","skip","byt","byteoffset","bit","getUint8","ExpGolomInit","tmp","getUint16","more_rbsp_data","l","byteLength","byte","found_bit","Number","isInteger","Math","log2","has_bit","RebroadcastPluginFork","mediaManager","deviceManager","DEFAULT_FFMPEG_INPUT_ARGUMENTS","SCRYPTED_PARSER_TCP","SCRYPTED_PARSER_UDP","FFMPEG_PARSER_TCP","FFMPEG_PARSER_UDP","STRING_DEFAULT","PrebufferSession","mixin","advertisedMediaStreamOptions","enabled","forceBatteryPrebuffer","rtspPrebuffer","usingScryptedParser","usingScryptedUdpParser","activeClients","mixinDevice","syntheticInputIdKey","streamId","ffmpegInputArgumentsKey","ffmpegOutputArgumentsKey","lastDetectedAudioCodecKey","rtspParserKey","rtspServerPathKey","rtspServerMutedPathKey","rtspServerMutedPath","handleChargingBatteryEvents","stopInactive","shouldDisableBatteryPrebuffer","getDetectedIdrInterval","durations","last","chunk","findH264NaluType","time","prev","current","streamName","clearPrebuffers","release","parserSessionPromise","parserSession","kill","batteryListener","chargerListener","ensurePrebufferSession","released","startPrebufferSession","active","pso","online","killed","finally","catch","others","sessions","filter","some","canUseRtspParser","mediaStreamOptions","getParser","parser","rtspParser","isDefault","localStorage","parseCodecs","skipResolution","parsedSdp","videoSection","audioSection","inputAudioCodec","inputVideoCodec","inputVideoResolution","parsedSps","getSpsResolution","spspps","getSpsPps","getMixinSettings","total","prebuffer","elapsed","Date","now","bitrate","round","group","subgroup","streamSettings","storageSettings","synthenticStreams","nonSynthetic","title","description","choices","addFFmpegInputSettings","placeholder","combobox","usingFFmpeg","currentParser","codecInfo","resolution","idrInterval","readonly","rebroadcastPort","mso","getVideoStreamOptions","noAudio","audio","privacyMode","audioSoftMuted","advertisedAudioCodec","detectedAudioCodec","rbo","parsers","mo","ffmpegInput","createMediaObject","ScryptedMimeTypes","FFmpegInput","syntheticInputId","realDevice","getVideoStream","isRfc4571","mimeType","sessionMso","convertMediaObjectToJSON","addTrackControls","createRtspParser","rtsp","startRFC4571Parser","connectRFC4571Parser","startRtspSession","useUdp","rtspRequestTimeout","extraInputArguments","extraOutputArguments","h264EncoderArguments","d","startParserSession","clearTimeout","inactivityTimeout","advertisedVideoCodec","video","onMixinEvent","refreshAt","refreshTimeout","refreshStream","isActive","scheduleRefresh","refreshMso","when","setTimeout","shifts","prebufferContainer","shift","printActiveClients","inactivityCheck","resetTimeout","interfaces","Charger","Battery","checkDisablePrebuffer","listenDevice","lowBattery","batteryLevel","chargeState","ChargeState","Charging","handleRebroadcasterClient","isActiveClient","socketPromise","requestedPrebuffer","socket","ListenZeroSingleClientTimeoutError","writeData","startStream","writeDataWithoutStartStream","writableLength","safeWriteData","cleanup","filtered","pb","availablePrebuffers","refresh","startedParserSession","defaultPrebuffer","min","negotiateMediaStream","interleavePassthrough","interleavedMap","serverPortMap","filterPrebufferAudio","videoCodec","toSdp","writeStream","route","listenSingleRtspClient","FileRtspServer","writeConsole","parserSpecific","size","getUrlLocalAdresses","rtpmap","sampleRate","clock","available","prebufferBytes","max","PrebufferMixin","SettingsMixinDeviceBase","createStreamSettings","expected","webrtc","providedInterfaces","RTCSignalingChannel","matched","mixins","currentMixins","setMixins","delayStart","retry","startRtspServer","settingsListener","ensurePrebufferSessions","videoCameraListener","VideoCamera","reinitiatePrebufferSessions","Server","prebufferSession","localAddress","localPort","rawMessage","listen","msos","getRemoteStream","getLowResolutionStream","getRecordingStream","getRemoteRecordingStream","getDefaultStream","createFFmpegMediaObject","sourceId","getPrebufferedStreams","enabledIds","ids","cloud","source","a","synthetic","toRemove","delete","allowBatteryPrebuffer","ps","defaultStreamName","defaultStream","defaultSession","putMixinSetting","enabledStreams","destinations","RebroadcastPlugin","AutoenableMixinProvider","nativeId","defaultRtspParser","requestRestart","clearAlerts","fromMimeType","toMimeType","nextTick","getSystemState","getNativeIds","onDeviceRemoved","convert","trackLookups","pt","payloadTypes","clientUrl","ffmpeg","readInt16BE","shouldEnableMixin","ScryptedDeviceType","Camera","Doorbell","shouldUnshiftMixin","canMixin","Online","REBROADCAST_MIXIN_INTERFACE_TOKEN","getMixin","mixinDeviceInterfaces","mixinDeviceState","setHasEnabledMixin","forked","fork","worker","newPrebufferMixin","releaseMixin","terminate","mixinProviderNativeId","groupKey","readable","skipHeader","callback","offset","headerLength","skipCount","readCount","resumeRead","StreamEndError","readableEnded","destroyed","readUntil","CHARCODE_NEWLINE","readBuffer","where","charCodeAt","charCode","queued","findIndex","b","before","after","concat","buffers","resume","rp","cacheDuration","t","TimeoutError","f","isTimedOut","func","debounce","keyStr","cp","stdout","res","exec","stderr","parseInputToken","events","EventEmitter","sessionKilled","sdpDeferred","emit","safeKillFFmpeg","args","ensureActive","stdio","pipeCount","startParsers","tcp","resetActivityTimer","setupActivityTimer","safePrintFFmpegArguments","spawn","ffmpegPath","getFFmpegPath","ffmpegLogInitialOutput","deferredStart","pipeIndex","pipe","requestMediaStream","cloneDeep","event","cb","token","processed","idx","lastIndexOf","check","next","next2","removeAllListeners","createActivityTimeout","clearActivityTimer","bindUdp","socketType","attempts","createBindUdp","close","bind","usePort","createSocket","listenZero","YError","wrappedErrors","errorCode","Array","captureStackTrace","wrap","err","wrappedErrorIsACode","_looksLikeAYErrorCode","cast","_looksLikeAYError","bump","stack","test","timeoutCallback","dataTimeout","lastTime","ms","listenTimeout","tls","cancel","servers","rtspClient","RtspClient","cleanupSockets","mapping","udpSessionTimeout","checkUdpSessionTimeout","doSetup","rtspChannel","prefix","setupResult","punch","rtpPort","resultChannel","setupVideoSection","section","lines","flat","audioPt","videoPt","sprop","fmtp","parameters","sdpSps","read16BELengthLoop","NaN","__exportStar","__importDefault","sdk","MixinDeviceBase","ScryptedDeviceBase","fs_1","index_1","DeviceBase","_storage","getDeviceStorage","_log","getDeviceLogger","_console","getDeviceConsole","getMediaObjectConsole","mediaObject","getMixinConsole","_lazyLoadDeviceState","_deviceState","getDeviceState","eventInterface","eventData","_listeners","mixinStorageSuffix","__rpcproxy_traps_all_properties","createDeviceState","setState","mixinStorageKey","getMixinStorage","manageListener","listener","_createGetState","state","_createSetState","field","ScryptedInterfaceProperty","loaded","SCRYPTED_SDK_ES_MODULE","SCRYPTED_SDK_MODULE","cjsModule","SCRYPTED_SDK_CJS_MODULE","sdkModule","getScryptedStatic","runtimeAPI","pluginRuntimeAPI","pluginHostAPI","descriptors","ScryptedInterfaceDescriptors","customDescriptors","readFileSync","interfaceDescriptors","setScryptedInterfaceDescriptors","TYPES_VERSION","streamTypes","prefersPrebuffer","preferredResolution","remoteStream","lowResolutionStream","recordingStream","remoteRecordingStream","hasMjpeg","immediate","getDefaultPrebufferedStreams","local","getMediaStream","remoteRecording","getDefaultMediaStream","best","bestScore","msoHasJpegCodec","score","abs","MAX_SAFE_INTEGER","pickBestStream","createStreamOptions","lower","MediaPlayerState","SecuritySystemObstruction","SecuritySystemMode","AirQuality","AirPurifierMode","AirPurifierStatus","LockState","PanTiltZoomMovement","ThermostatMode","TemperatureUnit","FanMode","HumidityMode","ScryptedInterfaceMethod","settingsGroup","settingsGroupKey","settingsPromise","mixinSettingsPromise","allSettings","random","mixinSettings","autoIncludeToken","hasEnabledMixin","pluginsComponent","getComponent","eventSource","eventDetails","ScryptedDevice","property","maybeEnableMixin","checkHasEnabledMixin","plugins","trackCount","splice","findTrackByType","directions","sections","getSections","returnTrack","controlString","dir","parseMLinePayloadTypes","mline","parseMLine","audioPort","videoPort","regex","RegExp","outputSdp","re","payloadType","fmtpPrefix","parseMSection","pps","vps","afmtp","parseFmtp","fmtpLine","firstSpace","paramLine","param","parseRtpMap","mlineType","ffmpegEncoder","channels","rawCodec","acontrol","artpmap","rawRtpmaps","rtpmaps","direction","checkDirection","highWaterMark","segmentBytesWritten","ws","recordingFile","promises","mkdir","dirname","recursive","truncate","truncateWriteStream","open","fd","rename","createWriteStream","writesize","exitCode","stdin","forever","SCRYPTED_FFMPEG_NOISY","logger","redactNext","arg","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","definition","obj","prop","__webpack_exports__"],"sourceRoot":""}