(()=>{var e={16:e=>{"use strict";e.exports=require("url")},51:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSpsResolution=function(e){let t,r;0==e.chroma_format_idc&&0==e.color_plane_flag?t=r=0:1==e.chroma_format_idc&&0==e.color_plane_flag?t=r=2:2==e.chroma_format_idc&&0==e.color_plane_flag?(t=2,r=1):3==e.chroma_format_idc&&(0==e.color_plane_flag?t=r=1:1==e.color_plane_flag&&(t=r=0));let i=e.pic_width_in_mbs,s=e.pic_height_in_map_units,n=(2-e.frame_mbs_only_flag)*s,o=0,a=0,c=0,d=0;e.frame_cropping_flag&&(o=e.frame_cropping.left,a=e.frame_cropping.right,c=e.frame_cropping.top,d=e.frame_cropping.bottom);let l=16*i-t*(o+a),u=16*n-r*(2-e.frame_mbs_only_flag)*(c+d);return{width:l,height:u}}},57:(e,t)=>{"use strict";function r(e,t){const r=t.ExpGolomb();e.cpb_cnt=r+1,e.bit_rate_scale=t.readNibble(),e.cpb_size_scale=t.readNibble();for(let i=0;i<=r;i++)e.bit_rate_value[i]=t.ExpGolomb()+1,e.cpb_size_value[i]=t.ExpGolomb()+1,e.cbr_flag[i]=t.readBit();e.initial_cpb_removal_delay_length=t.read5()+1,e.cpb_removal_delay_length=t.read5()+1,e.dpb_output_delay_length=t.read5()+1,e.time_offset_length=t.read5()}Object.defineProperty(t,"__esModule",{value:!0}),t.getVUIParams=function(e,t){const i={aspect_ratio_info_present_flag:0,aspect_ratio_idc:0,sar_width:0,sar_height:0,overscan_info_present_flag:0,overscan_appropriate_flag:0,video_signal_type_present_flag:0,video_format:0,video_full_range_flag:0,colour_description_present_flag:0,colour_primaries:0,transfer_characteristics:0,matrix_coefficients:0,chroma_loc_info_present_flag:0,chroma_sample_loc_type_top_field:0,chroma_sample_loc_type_bottom_field:0,timing_info_present_flag:0,num_units_in_tick:0,time_scale:0,fixed_frame_rate_flag:0,nal_hrd_parameters_present_flag:0,vcl_hrd_parameters_present_flag:0,hrd_params:{cpb_cnt:0,bit_rate_scale:0,cpb_size_scale:0,bit_rate_value:[],cpb_size_value:[],cbr_flag:[],initial_cpb_removal_delay_length:0,cpb_removal_delay_length:0,dpb_output_delay_length:0,time_offset_length:0},low_delay_hrd_flag:0,pic_struct_present_flag:0,bitstream_restriction_flag:0,motion_vectors_over_pic_boundaries_flag:0,max_bytes_per_pic_denom:0,max_bits_per_mb_denom:0,log2_max_mv_length_horizontal:0,log2_max_mv_length_vertical:0,num_reorder_frames:0,max_dec_frame_buffering:0};return e?(i.aspect_ratio_info_present_flag=t.readBit(),i.aspect_ratio_info_present_flag&&(i.aspect_ratio_idc=t.ExpGolomb(),255===i.aspect_ratio_idc&&(i.sar_width=t.readByte(),i.sar_height=t.readByte())),i.overscan_info_present_flag=t.readBit(),i.overscan_info_present_flag&&(i.overscan_appropriate_flag=t.readBit()),i.video_signal_type_present_flag=t.readBit(),i.video_signal_type_present_flag&&(i.video_format=t.readBit()<<2|t.readBit()<<1|t.readBit(),i.video_full_range_flag=t.readBit(),i.colour_description_present_flag=t.readBit(),i.colour_description_present_flag&&(i.colour_primaries=t.readByte(),i.transfer_characteristics=t.readByte(),i.matrix_coefficients=t.readByte())),i.chroma_loc_info_present_flag=t.readBit(),i.chroma_loc_info_present_flag&&(i.chroma_sample_loc_type_top_field=t.ExpGolomb(),i.chroma_sample_loc_type_bottom_field=t.ExpGolomb()),i.timing_info_present_flag=t.readBit(),i.timing_info_present_flag&&(i.num_units_in_tick=t.readWord(),i.time_scale=t.readWord(),i.fixed_frame_rate_flag=t.readBit()),i.nal_hrd_parameters_present_flag=t.readBit(),i.nal_hrd_parameters_present_flag&&r(i.hrd_params,t),i.vcl_hrd_parameters_present_flag=t.readBit(),i.vcl_hrd_parameters_present_flag&&r(i.hrd_params,t),(i.nal_hrd_parameters_present_flag||i.vcl_hrd_parameters_present_flag)&&(i.low_delay_hrd_flag=t.readBit()),i.pic_struct_present_flag=t.readBit(),i.bitstream_restriction_flag=t.readBit(),i.bitstream_restriction_flag&&(i.motion_vectors_over_pic_boundaries_flag=t.readBit(),i.max_bytes_per_pic_denom=t.ExpGolomb(),i.max_bits_per_mb_denom=t.ExpGolomb(),i.log2_max_mv_length_horizontal=t.ExpGolomb(),i.log2_max_mv_length_vertical=t.ExpGolomb(),i.num_reorder_frames=t.ExpGolomb(),i.max_dec_frame_buffering=t.ExpGolomb()),i):i}},194:e=>{"use strict";e.exports=require("dgram")},203:e=>{"use strict";e.exports=require("stream")},238:(e,t,r)=>{"use strict";r.d(t,{$:()=>d,parseHTTPHeadersQuotedKeyValueSet:()=>c});var i=r(563);const s='"',n="=",o=", ",a=/\w+=(".*?"|[^",]+)(?=,|$)/g;function c(e,t,r=[],s=[]){const o=e.trim().match(a);if(!o)throw new i.w("E_MALFORMED_QUOTEDKEYVALUE",e);const c=o.map(((e,t)=>{const[r,...s]=e.split(n),o=s.join(n);if(0===s.length)throw new i.w("E_MALFORMED_QUOTEDKEYVALUE",t,e);return[r,o]})).reduce((function(e,[r,n],o){const a=r.toLowerCase();if(-1===t.indexOf(a))throw new i.w("E_UNAUTHORIZED_KEY",o,a);const c=n.replace(/^"(.+(?="$))"$/,"$1");return e[a]=s.includes(a)?c.toLowerCase():c,e}),{});return l(r,c),c}function d(e,t,r=[]){return l(r,e),t.reduce((function(t,r){return e[r]?t+(t?o:"")+r+n+s+e[r]+s:t}),"")}function l(e,t){e.forEach((e=>{if("undefined"==typeof t[e])throw new i.w("E_REQUIRED_KEY",e)}))}},254:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getUrlLocalAdresses=async function(e,t){let r;try{const e=await n.default.endpointManager.getLocalAddresses();e&&(r=e.map((e=>{const r=new URL(t);return r.hostname=s.default.isIPv6(e)?`[${e}]`:e,r.toString()})))}catch(t){e.warn("Error determining external addresses. Is Scrypted Server Address configured?",t)}if(process.env.SCRYPTED_CLUSTER_ADDRESS)try{const e=new URL(t);e.hostname=process.env.SCRYPTED_CLUSTER_ADDRESS;const i=e.toString();r?.includes(i)||(r||=[],r.push(i))}catch(t){e.warn("Error determining external addresses. Is Scrypted Cluster Address configured?",t)}return r};const s=i(r(278)),n=i(r(743))},278:e=>{"use strict";e.exports=require("net")},284:(e,t,r)=>{"use strict";r.d(t,{BASIC:()=>c});var i=r(563),s=r(238);const n=["realm"],o=n,a={type:"Basic",parseWWWAuthenticateRest:function(e){return(0,s.parseHTTPHeadersQuotedKeyValueSet)(e,o,n)},buildWWWAuthenticateRest:function(e){return(0,s.$)(e,o,n)},parseAuthorizationRest:function(e){if(!e)throw new i.w("E_EMPTY_AUTH");const{username:t,password:r}=a.decodeHash(e);return{hash:e,username:t,password:r}},buildAuthorizationRest:function({hash:e,username:t,password:r}){if(t&&r)return a.computeHash({username:t,password:r});if(!e)throw new i.w("E_NO_HASH");return e},computeHash:function({username:e,password:t}){return Buffer.from(e+":"+t).toString("base64")},decodeHash:function(e){const[t,...r]=Buffer.from(e,"base64").toString().split(":");return{username:t,password:r.join(":")}}},c=a;r(982);const d=["realm","nonce"],l=["username","realm","nonce","uri","response"]},290:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;class r{constructor(){this.finished=!1,this.promise=new Promise(((e,t)=>{this.resolve=t=>(this.finished=!0,e(t),this),this.reject=e=>(this.finished=!0,t(e),this)}))}[Symbol.dispose](){this.finished||this.reject(new Error("deferred disposed without being resolved"))}async resolvePromise(e){try{this.resolve(await e)}catch(e){this.reject(e)}}}t.Deferred=r},317:e=>{"use strict";e.exports=require("child_process")},336:function(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),o=0;o<r.length;o++)"default"!==r[o]&&s(t,e,r[o]);return n(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RtspServer=t.RtspClient=t.RtspBase=t.RtspStatusError=t.H265_NAL_TYPE_SEI_SUFFIX=t.H265_NAL_TYPE_SEI_PREFIX=t.H265_NAL_TYPE_FU=t.H265_NAL_TYPE_CRA_NUT=t.H265_NAL_TYPE_IDR_N_LP=t.H265_NAL_TYPE_IDR_W_RADL=t.H265_NAL_TYPE_BLA_N_LP=t.H265_NAL_TYPE_BLA_W_RADL=t.H265_NAL_TYPE_BLA_W_LP=t.H265_NAL_TYPE_PPS=t.H265_NAL_TYPE_SPS=t.H265_NAL_TYPE_VPS=t.H265_NAL_TYPE_AGG=t.H264_NAL_TYPE_MTAP32=t.H264_NAL_TYPE_MTAP16=t.H264_NAL_TYPE_FU_B=t.H264_NAL_TYPE_FU_A=t.H264_NAL_TYPE_STAP_B=t.H264_NAL_TYPE_STAP_A=t.H264_NAL_TYPE_PPS=t.H264_NAL_TYPE_SPS=t.H264_NAL_TYPE_SEI=t.H264_NAL_TYPE_IDR=t.H264_NAL_TYPE_RESERVED31=t.H264_NAL_TYPE_RESERVED30=t.H264_NAL_TYPE_RESERVED0=t.RTSP_FRAME_MAGIC=void 0,t.readMessage=v,t.readBody=b,t.writeMessage=P,t.findH264NaluType=function(e,t){if("h264"!==e.type)return;return T(e.chunks[e.chunks.length-1].subarray(12),t)},t.findH265NaluType=function(e,t){if("h265"!==e.type)return;return R(e.chunks[e.chunks.length-1].subarray(12),t)},t.parseH264NaluType=w,t.findH264NaluTypeInNalu=T,t.findH265NaluTypeInNalu=R,t.getStartedH264NaluTypes=M,t.getNaluTypesInNalu=I,t.getStartedH265NaluTypes=A,t.getNaluTypesInH265Nalu=x,t.isH265KeyFrameRelatedInSet=D,t.createRtspParser=function(e){let r;return{container:"rtsp",tcpProtocol:"rtsp://127.0.0.1/"+(0,c.randomBytes)(8).toString("hex"),inputArguments:["-rtsp_transport","tcp"],outputArguments:["-rtsp_transport","tcp",...e?.vcodec||[],...e?.acodec||[],"-pkt_size","32000","-f","rtsp"],findSyncFrame(e){for(let r=0;r<e.length;r++){const i=e[r];if("h264"===i.type){const s=M(i);if(s.has(t.H264_NAL_TYPE_SPS)||s.has(t.H264_NAL_TYPE_IDR))return e.slice(r)}else if("h265"===i.type){if(D(A(i)))return e.slice(r)}}},sdp:new Promise((e=>r=e)),async*parse(e,t,i){const s=new B(e);await s.handleSetup(),r(s.sdp);for await(const{type:e,rtcp:r,header:n,packet:o}of s.handleRecord())yield{chunks:[n,o],type:`${r?"rtcp-":""}${e}`,width:t,height:i}}}},t.parseHeaders=C,t.getFirstAuthenticateHeader=O,t.parseSemicolonDelimited=L,t.listenSingleRtspClient=async function(e){const t=e?.pathToken||c.default.randomBytes(8).toString("hex");let{url:r,clientPromise:i,server:s}=await(0,h.listenZeroSingleClient)(e?.hostname);const n="/"+t;r=r.replace("tcp:","rtsp:")+n;const o=i.then((t=>{const r=(e?.createServer||(e=>new B(e)))(t);return r.checkRequest=async(e,t,i,s)=>{r.checkRequest=void 0;return new p.URL(t).pathname===n},r}));return{url:r,rtspServerPromise:o,server:s}};const c=o(r(982)),d=r(434),l=a(r(278)),u=a(r(756)),p=r(16),m=r(290),h=r(515),f=r(488),g=r(460),S=r(890),y=r(724),_=["realm","nonce"];async function v(e){let t=[];for(;;){let r=await(0,g.readLine)(e);if(r=r.trim(),!r)return t;t.push(r)}}async function b(e,t){const r=parseInt(t["content-length"]);if(r)return(0,g.readLength)(e,r)}function P(e,t,r,i,s){let n=void 0!==t?`${t}\r\n`:"";r&&(i["Content-Length"]=r.length.toString());for(const[e,t]of Object.entries(i))n+=`${e}: ${t}\r\n`;n+="\r\n",e.write(n),s?.log("rtsp outgoing message\n",n),s?.log(),r&&e.write(r)}function w(e){return 31&e}function T(e,r){const i=w(e[0]);if(i===t.H264_NAL_TYPE_STAP_A){let t=1;for(;t<e.length;){const i=e.readUInt16BE(t);t+=2;if(w(e[t])===r)return e.subarray(t,t+i);t+=i}}else if(i===t.H264_NAL_TYPE_FU_A){const t=w(e[1]),i=!!(128&e[1]);if(t===r&&i)return e.subarray(1)}else if(i===r)return e}function E(e){return(126&e)>>1}function R(e,r){const i=E(e[0]);if(i===t.H265_NAL_TYPE_AGG){let t=1;for(;t<e.length;){const i=e.readUInt16BE(t);t+=2;if(E(e[t])===r)return e.subarray(t,t+i);t+=i}}else if(i===r)return e}function M(e){return"h264"!==e.type?new Set:I(e.chunks[e.chunks.length-1].subarray(12),!0)}function I(e,r=!1,i=!1){const s=new Set,n=w(e[0]);if(n===t.H264_NAL_TYPE_STAP_A){s.add(t.H264_NAL_TYPE_STAP_A);let r=1;for(;r<e.length;){const t=e.readUInt16BE(r);r+=2;const i=w(e[r]);s.add(i),r+=t}}else if(n===t.H264_NAL_TYPE_FU_A){s.add(t.H264_NAL_TYPE_FU_A);const n=w(e[1]);if(r){!!(128&e[1])&&s.add(n)}else if(i){!!(64&e[1])&&s.add(n)}else s.add(n)}else s.add(n);return s}function A(e){return"h265"!==e.type?new Set:x(e.chunks[e.chunks.length-1].subarray(12),!0)}function x(e,r=!1,i=!1){const s=new Set,n=E(e[0]);if(n===t.H265_NAL_TYPE_AGG){s.add(t.H265_NAL_TYPE_AGG);let r=2;for(;r<e.length;){const t=e.readUInt16BE(r);r+=2;const i=E(e[r]);s.add(i),r+=t}}else if(n===t.H265_NAL_TYPE_FU){s.add(t.H265_NAL_TYPE_FU);const n=63&e[2];if(r){!!(128&e[2])&&s.add(n)}else if(i){!!(64&e[2])&&s.add(n)}else s.add(n)}else s.add(n);return s}function D(e,r=!0){return!!(e.has(t.H265_NAL_TYPE_IDR_N_LP)||e.has(t.H265_NAL_TYPE_IDR_W_RADL)||e.has(t.H265_NAL_TYPE_CRA_NUT)||e.has(t.H265_NAL_TYPE_BLA_N_LP)||e.has(t.H265_NAL_TYPE_BLA_W_LP)||e.has(t.H265_NAL_TYPE_BLA_W_RADL))||!(!r||!(e.has(t.H265_NAL_TYPE_VPS)||e.has(t.H265_NAL_TYPE_SPS)||e.has(t.H265_NAL_TYPE_PPS)))}function C(e){const t={};for(const r of e.slice(1)){const e=r.indexOf(":");let i="";-1!==e&&(i=r.substring(e+1).trim());t[r.substring(0,e).toLowerCase()]=i}return t}function O(e){for(const t of e.slice(1)){const e=t.indexOf(":");let r="";-1!==e&&(r=t.substring(e+1).trim());if("www-authenticate"===t.substring(0,e).toLowerCase())return r}}function L(e){const t={};for(const r of e.split(";")){const[e,i]=r.split("=",2);t[e]=i}return t}t.RTSP_FRAME_MAGIC=36,t.H264_NAL_TYPE_RESERVED0=0,t.H264_NAL_TYPE_RESERVED30=30,t.H264_NAL_TYPE_RESERVED31=31,t.H264_NAL_TYPE_IDR=5,t.H264_NAL_TYPE_SEI=6,t.H264_NAL_TYPE_SPS=7,t.H264_NAL_TYPE_PPS=8,t.H264_NAL_TYPE_STAP_A=24,t.H264_NAL_TYPE_STAP_B=25,t.H264_NAL_TYPE_FU_A=28,t.H264_NAL_TYPE_FU_B=29,t.H264_NAL_TYPE_MTAP16=26,t.H264_NAL_TYPE_MTAP32=27,t.H265_NAL_TYPE_AGG=48,t.H265_NAL_TYPE_VPS=32,t.H265_NAL_TYPE_SPS=33,t.H265_NAL_TYPE_PPS=34,t.H265_NAL_TYPE_BLA_W_LP=16,t.H265_NAL_TYPE_BLA_W_RADL=17,t.H265_NAL_TYPE_BLA_N_LP=18,t.H265_NAL_TYPE_IDR_W_RADL=19,t.H265_NAL_TYPE_IDR_N_LP=20,t.H265_NAL_TYPE_CRA_NUT=21,t.H265_NAL_TYPE_FU=49,t.H265_NAL_TYPE_SEI_PREFIX=39,t.H265_NAL_TYPE_SEI_SUFFIX=40;class k extends Error{constructor(e){super(`RTSP Error: ${e.line}`),this.status=e}}t.RtspStatusError=k;class N{constructor(){}write(e,t,r){P(this.client,e,r,t,this.console)}async readMessage(){const e=await v(this.client);return this.console?.log("rtsp incoming message\n",e.join("\n")),this.console?.log(),e}}t.RtspBase=N;t.RtspClient=class extends N{constructor(e){super(),this.url=e,this.cseq=0,this.needKeepAlive=!1,this.setupOptions=new Map,this.issuedTeardown=!1,this.hasGetParameter=!0;const t=new p.URL(e),r=parseInt(t.port)||554;e.startsWith("rtsps")?this.client=u.default.connect({rejectUnauthorized:!1,port:r,host:t.hostname}):this.client=l.default.connect(r,t.hostname),this.client.on("error",(e=>{this.console?.log("client error",e)}))}async safeTeardown(){if(!this.issuedTeardown){this.issuedTeardown=!0;try{this.writeTeardown(),await(0,y.sleep)(500)}catch(e){}finally{this.client.destroy()}}}async writeRequest(e,t,r,i){let s;t=t||{},r?r.includes("rtsp://")||r.includes("rtsps://")||"*"===r?s=r:(s=this.contentBase||this.url,s+=(s.endsWith("/")?"":"/")+r):s=this.url;const n=new p.URL(s);n.username="",n.password="";const o=`${e} ${n} RTSP/1.0`,a=this.cseq++;t.CSeq=a.toString(),t["User-Agent"]="Scrypted",this.wwwAuthenticate&&(t.Authorization=await this.createAuthorizationHeader(e,new p.URL(s))),this.session&&(t.Session=this.session),this.write(o,t,i)}async handleDataPayload(e){if(e[0]!==t.RTSP_FRAME_MAGIC)throw new Error("RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): "+e.toString());const r=e.readUInt8(1),i=e.readUInt16BE(2),s=await(0,g.readLength)(this.client,i),n=this.setupOptions.get(r);n?.onRtp?.(e,s)}async readDataPayload(){const e=await(0,g.readLength)(this.client,4);return this.handleDataPayload(e)}createBadHeader(e){return new Error("RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): "+e.toString())}async readLoopLegacy(){try{for(;;)this.needKeepAlive&&(this.needKeepAlive=!1,this.hasGetParameter?await this.getParameter():await this.options()),await this.readDataPayload()}catch(e){throw this.client.destroy(e),e}}async*handleStream(){for(;;){const e=await(0,g.readLength)(this.client,4);if(e[0]!==t.RTSP_FRAME_MAGIC){if("RTSP"!==e.toString())throw this.createBadHeader(e);this.client.unshift(e);const t=await super.readMessage();await this.readBody(C(t));continue}const r=e.readUInt16BE(2),i=await(0,g.readLength)(this.client,r),s=e.readUInt8(1);yield{channel:s,rtcp:s%2==1,header:e,packet:i}}}async readLoop(){const e=new m.Deferred;let r,i,s;const n=async()=>{this.needKeepAlive&&(this.needKeepAlive=!1,this.hasGetParameter?this.writeGetParameter():this.writeOptions());try{for(;;){if(!r){if(r=this.client.read(4),!r)return;if(r[0]!==t.RTSP_FRAME_MAGIC){if("RTSP"!==r.toString())throw this.createBadHeader(r);this.client.unshift(r),r=void 0,this.client.removeListener("readable",n);const e=await super.readMessage();await this.readBody(C(e));this.client.on("readable",n);continue}i=r.readUInt8(1),s=r.readUInt16BE(2)}const e=this.client.read(s);if(!e)return;const o=r;r=void 0;const a=this.setupOptions.get(i);a?.onRtp?.(o,e)}}catch(t){e.finished||e.reject(t),this.client.destroy()}};n(),this.client.on("readable",n),await Promise.all([(0,d.once)(this.client,"end")])}async readMessage(){for(;;){const e=await(0,g.readLength)(this.client,4);if(e[0]!==t.RTSP_FRAME_MAGIC){if("RTSP"===e.toString()){this.client.unshift(e);return await super.readMessage()}throw this.createBadHeader(e)}await this.handleDataPayload(e)}}async createAuthorizationHeader(e,t){if(!this.wwwAuthenticate)throw new Error("no WWW-Authenticate found");const{BASIC:i}=await Promise.resolve().then(r.bind(r,284)),{parseHTTPHeadersQuotedKeyValueSet:s}=await Promise.resolve().then(r.bind(r,238)),n=new p.URL(this.url),o=decodeURIComponent(n.username),a=decodeURIComponent(n.password);if(this.wwwAuthenticate.includes("Basic")){return`Basic ${i.computeHash({username:o,password:a})}`}const d=s(this.wwwAuthenticate,{indexOf:()=>0},_),l=new p.URL(t.toString());l.username="",l.password="";const u=c.default.createHash("md5").update(`${o}:${d.realm}:${a}`).digest("hex"),m=c.default.createHash("md5").update(`${e}:${l}`).digest("hex"),h=c.default.createHash("md5").update(`${u}:${d.nonce}:${m}`).digest("hex"),f={username:o,realm:d.realm,nonce:d.nonce,uri:l.toString(),algorithm:"MD5",response:h};return`Digest ${Object.entries(f).map((([e,t])=>{return`${e}=${t&&(r=t,`"${r.replace(/"/g,'\\"')}"`)}`;var r})).join(", ")}`}async readBody(e){return b(this.client,e)}async request(e,t,r,i,s){await this.writeRequest(e,t,r,i);const n=this.requestTimeout?await(0,f.timeoutPromise)(this.requestTimeout,this.readMessage()):await this.readMessage(),o=n[0],[a,c,d]=o.split(" ",3),l=parseInt(c),u=C(n),p={line:o,code:l,version:a,reason:d};if(200!==l&&!u["www-authenticate"])throw new k(p);const m=O(n)||u["www-authenticate"];if(m){if(s)throw new Error("auth failed");return this.wwwAuthenticate=m,this.request(e,t,r,i,!0)}return{headers:u,body:await this.readBody(u),status:p}}async options(){const e=await this.request("OPTIONS",{}),t=e.headers.public;return t&&(this.hasGetParameter=t.toLowerCase().includes("get_parameter")),e}writeOptions(){return this.writeRequest("OPTIONS")}async getParameter(){return this.request("GET_PARAMETER")}writeGetParameter(){return this.writeRequest("GET_PARAMETER")}async describe(e){const t=await this.request("DESCRIBE",{...e||{},Accept:"application/sdp"});return this.contentBase=t.headers["content-base"]||t.headers["content-location"],this.contentBase&&(this.contentBase=new p.URL(this.contentBase,this.url).toString()),t}async setup(e,t){const r="udp"===e.type?"":"/TCP",i="udp"===e.type?"client_port":"interleaved";let s;if("tcp"===e.type)s=e.port;else{if(!e.dgram){const t=await(0,h.createBindZero)();e.dgram=t.server,this.client.on("close",(()=>(0,h.closeQuiet)(t.server)))}s=e.dgram.address().port,e.dgram.on("message",(t=>e.onRtp(void 0,t)))}t=Object.assign({Transport:`RTP/AVP${r};unicast;${i}=${s}-${s+1}`},t);const n=await this.request("SETUP",t,e.path);let o;if(n.headers.session){const e=L(n.headers.session);let t=parseInt(e.timeout);if(t){let e=setInterval((()=>this.needKeepAlive=!0),1e3*(t-5));this.client.once("close",(()=>clearInterval(e)))}this.session=n.headers.session.split(";")[0]}if(n.headers.transport){const e=n.headers.transport.match(/.*?interleaved=([0-9]+)-([0-9]+)/);if(e){const[t,r,i]=e;r&&i&&(o={begin:parseInt(r),end:parseInt(i)})}}return"tcp"===e.type&&this.setupOptions.set(o?o.begin:s,e),Object.assign({interleaved:o,options:e},n)}async play(e={},t="0.000"){return e.Range=`npt=${t}-`,this.request("PLAY",e)}writePlay(e="0.000"){const t={Range:`npt=${e}-`};return this.writeRequest("PLAY",t)}writeRtpPayload(e,t){return this.client.write(e),this.client.write(Buffer.from(t))}send(e,r){const i=Buffer.alloc(4);return i.writeUInt8(t.RTSP_FRAME_MAGIC,0),i.writeUInt8(r,1),i.writeUInt16BE(e.length,2),this.writeRtpPayload(i,e)}async pause(){return this.request("PAUSE")}async teardown(){try{return await this.request("TEARDOWN")}finally{this.client.destroy()}}writeTeardown(){this.writeRequest("TEARDOWN")}};class B{constructor(e,t,r,i){this.client=e,this.sdp=t,this.udp=r,this.checkRequest=i,this.setupTracks={},this.availableOptions=["DESCRIBE","OPTIONS","PAUSE","PLAY","SETUP","TEARDOWN","ANNOUNCE","RECORD","GET_PARAMETER"],this.session=(0,c.randomBytes)(4).toString("hex"),t&&(t=t.trim()),e instanceof l.default.Socket&&e.setNoDelay(!0)}async handleSetup(e=["play","record","teardown"]){let t=[];for(;;){let r=await(0,g.readLine)(this.client);if(r=r.trim(),r)t.push(r);else{const r=await this.headers(t);if(e.includes(r))return r;t=[]}}}async handlePlayback(){return this.handleSetup()}async handleTeardown(){return this.handleSetup()}async*handleRecord(){for(;;){const e=await(0,g.readLength)(this.client,4);if(e[0]!==t.RTSP_FRAME_MAGIC)throw new Error("RTSP Server expected frame magic but received: "+e.toString());const r=e.readUInt16BE(2),i=await(0,g.readLength)(this.client,r),s=e.readUInt8(1),n=s-s%2,o=Object.values(this.setupTracks).find((e=>e.destination===n));if(!o)throw new Error("RSTP Server received unknown channel: "+s);yield{type:o.codec,rtcp:s%2==1,header:e,packet:i}}}writeRtpPayload(e,t){return this.client.write(e),this.client.write(Buffer.from(t))}send(e,t){const r=Buffer.alloc(4);return r.writeUInt8(36,0),r.writeUInt8(t,1),r.writeUInt16BE(e.length,2),this.writeRtpPayload(r,e)}sendUdp(e,t,r){e.send(r,t,"127.0.0.1")}sendTrack(e,t,r){const i=this.setupTracks[e];return i?"udp"===i.protocol?(this.udp?this.sendUdp(r?i.rtcp:i.rtp,i.destination,t):this.console?.warn("RTSP Server UDP socket not available."),!0):this.send(t,r?i.destination+1:i.destination):(this.console?.warn("RTSP Server track not found:",e),!0)}options(e,t){const r={};r.Public=this.availableOptions.join(", "),this.respond(200,"OK",t,r)}async get_parameter(e,t){this.respond(200,"OK",t,{})}describe(e,t){const r={};r["Content-Base"]=e,r["Content-Type"]="application/sdp",this.respond(200,"OK",t,r,Buffer.from(this.sdp))}setupInterleaved(e,t,r){this.setupTracks[e.control]={control:e.control,protocol:"tcp",destination:t,codec:e.codec}}async setup(e,t){const r={};let i=t.transport;r.Session=this.session;const s=(0,S.parseSdp)(this.sdp).msections.find((t=>e.endsWith(t.control)));if(s){if(i.includes("TCP"))if(this.resolveInterleaved){const[e,t]=this.resolveInterleaved(s);this.setupInterleaved(s,e,t),i=`RTP/AVP/TCP;unicast;interleaved=${e}-${t}`}else{const e=i.match(/.*?interleaved=([0-9]+)-([0-9]+)/);if(e){const t=parseInt(e[1]),r=parseInt(e[2]);this.setupInterleaved(s,t,r)}}else{if(!this.udp)return void this.respond(461,"Unsupported Transport",t,{});const e=i.match(/.*?client_port=([0-9]+)-([0-9]+)/),[r,n,o]=e,[a,c]=await(0,h.createSquentialBindZero)();this.client.on("close",(()=>(0,h.closeQuiet)(a.server))),this.client.on("close",(()=>(0,h.closeQuiet)(c.server))),this.setupTracks[s.control]={control:s.control,protocol:"udp",destination:parseInt(n),codec:s.codec,rtp:a.server,rtcp:c.server},i=i.replace("RTP/AVP/UDP","RTP/AVP").replace("RTP/AVP","RTP/AVP/UDP"),i+=`;server_port=${a.port}-${c.port}`}r.Transport=i,this.respond(200,"OK",t,r)}else this.respond(404,"Not Found",t,r)}play(e,t){const r={},i=Object.values(this.setupTracks).map((t=>`url=${e}/${t.control}`)).join(",");r["RTP-Info"]=i,r.Range="npt=now-",r.Session=this.session,this.respond(200,"OK",t,r)}async announce(e,t){const r=parseInt(t["content-length"]),i=await(0,g.readLength)(this.client,r);this.sdp=i.toString();const s={};s.Session=this.session,this.respond(200,"OK",t,s)}async record(e,t){const r={};r.Session=this.session,this.respond(200,"OK",t,r)}async teardown(e,t){const r={};r.Session=this.session,this.respond(200,"OK",t,r),this.client.destroy()}async headers(e){this.console?.log("request headers",e.join("\n"));let[t,r]=e[0].split(" ",2);t=t.toLowerCase();const i=C(e);if(this.checkRequest){let s;try{s=await this.checkRequest(t,r,i,e)}catch(e){this.console?.error("error checking request",e)}if(!s)throw this.respond(400,"Bad Request",i,{}),this.client.destroy(),new Error("check request failed")}if(this[t]&&this.availableOptions.includes(t.toUpperCase()))return await this[t](r,i),t;this.respond(400,"Bad Request",i,{})}respond(e,t,r,i,s){let n=`RTSP/1.0 ${e} ${t}\r\n`;r.cseq&&(i.CSeq=r.cseq),s&&(i["Content-Length"]=s.length.toString());for(const[e,t]of Object.entries(i))n+=`${e}: ${t}\r\n`;this.console?.log("response headers",n),n+="\r\n",this.client.write(n),s&&(this.client.write(s),this.console?.log("response body",s.toString()))}destroy(){this.client.destroy();for(const e of Object.values(this.setupTracks))(0,h.closeQuiet)(e.rtp),(0,h.closeQuiet)(e.rtcp)}}t.RtspServer=B},339:e=>{"use strict";e.exports=require("module")},353:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(430);t.Bitstream=i.Bitstream;const s=r(57);function n(e,t,r,i){let s=8,n=8;const o=[];for(let a=0;a<t;a++){if(0!==n){n=(s+e.SignedExpGolomb()+256)%256,r[i]=+(0===a&&0===n)}n&&(s=n),o[a]=s}return o}t.parse=function(e){if(7!=(31&e[0]))throw new Error("Not an SPS unit");const t=new i.Bitstream(new DataView(e.buffer,e.byteOffset+4)),r=e[1],o=e[2],a=e[3],c=t.ExpGolomb();let d=1,l=0,u=0,p=0,m=0,h=0;const f=[],g=[],S=[],y=[];if(100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||139===r||134===r||135===r){d=t.ExpGolomb();let e=8;if(3===d&&(e=12,p=t.readBit()),l=t.ExpGolomb()+8,u=t.ExpGolomb()+8,m=t.readBit(),h=t.readBit(),h){let r=0;for(;r<6;r++)t.readBit()&&f.push(n(t,16,S,r));for(;r<e;r++)t.readBit()&&g.push(n(t,64,y,r-6))}}const _=t.ExpGolomb()+4,v=t.ExpGolomb();let b=0,P=0,w=0;const T=[];let E=0;if(0===v)E=t.ExpGolomb()+4;else if(1===v){b=t.readBit(),P=t.SignedExpGolomb(),w=t.SignedExpGolomb();const e=t.ExpGolomb();for(let r=0;r<e;r++)T.push(t.SignedExpGolomb())}const R=t.ExpGolomb(),M=t.readBit(),I=t.ExpGolomb()+1,A=t.ExpGolomb()+1,x=t.readBit();let D=0;x||(D=t.readBit());const C=t.readBit(),O=t.readBit(),L=function(e,t){return e?{left:t.ExpGolomb(),right:t.ExpGolomb(),top:t.ExpGolomb(),bottom:t.ExpGolomb()}:{left:0,right:0,top:0,bottom:0}}(O,t),k=t.readBit();return{sps_id:c,profile_compatibility:o,profile_idc:r,level_idc:a,chroma_format_idc:d,bit_depth_luma:l,bit_depth_chroma:u,color_plane_flag:p,qpprime_y_zero_transform_bypass_flag:m,seq_scaling_matrix_present_flag:h,seq_scaling_matrix:f,log2_max_frame_num:_,pic_order_cnt_type:v,delta_pic_order_always_zero_flag:b,offset_for_non_ref_pic:P,offset_for_top_to_bottom_field:w,offset_for_ref_frame:T,log2_max_pic_order_cnt_lsb:E,max_num_ref_frames:R,gaps_in_frame_num_value_allowed_flag:M,pic_width_in_mbs:I,pic_height_in_map_units:A,frame_mbs_only_flag:x,mb_adaptive_frame_field_flag:D,direct_8x8_inference_flag:C,frame_cropping_flag:O,frame_cropping:L,vui_parameters_present_flag:k,vui_parameters:s.getVUIParams(k,t)}}},394:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=394,e.exports=t},414:function(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),o=0;o<r.length;o++)"default"!==r[o]&&s(t,e,r[o]);return n(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.StorageSettings=void 0;const a=o(r(743)),{systemManager:c}=a.default;t.StorageSettings=class{constructor(e,t){this.device=e,this.settings=t,this.values={},this.hasValue={};for(const e of Object.keys(t)){const r=t[e],i=()=>this.getItem(e);let s;s="clippath"!==r.type?i:()=>{try{return JSON.parse(i())}catch(e){}},Object.defineProperty(this.values,e,{get:s,set:t=>this.putSetting(e,t),enumerable:!0}),Object.defineProperty(this.hasValue,e,{get:()=>null!=this.device.storage.getItem(e),enumerable:!0})}}get keys(){const e={};for(const t of Object.keys(this.settings))e[t]=t;return e}async getSettings(){const e=await(this.options?.onGet?.()),t=[];for(const[r,i]of Object.entries(this.settings)){let s=Object.assign({},i);e?.[r]&&(s=Object.assign(s,e[r])),s.onGet&&(s=Object.assign(s,await s.onGet())),s.hide||await(this.options?.hide?.[r]?.())||(s.key=r,s.value=this.getItemInternal(r,s,!0),"function"==typeof s.deviceFilter&&(s.deviceFilter=s.deviceFilter.toString()),t.push(s),delete s.onPut,delete s.onGet,delete s.mapPut,delete s.mapGet)}return t}async putSetting(e,t){const r=this.settings[e];let i;return r&&(i=this.getItemInternal(e,r)),this.putSettingInternal(r,i,e,t)}putSettingInternal(e,t,r,i){e?.noStore||(e?.mapPut&&(i=e.mapPut(t,i)),null==i?this.device.storage.removeItem(r):"object"==typeof i?this.device.storage.setItem(r,JSON.stringify(i)):this.device.storage.setItem(r,i?.toString())),e?.onPut?.(t,i),e?.hide||this.device.onDeviceEvent(a.ScryptedInterface.Settings,void 0)}getItemInternal(e,t,r){if(!t)return this.device.storage.getItem(e);const i=function(e,t,r,i){if(null==e)return r();const s=t.multiple?"array":t.type;if("boolean"===s)return"true"===e||"false"!==e&&(r()||!1);if("number"===s){const t=parseFloat(e);return isNaN(t)?r()||0:t}if("integer"===s){const t=parseInt(e);return isNaN(t)?r()||0:t}if("array"===s){if(!e)return r()||[];try{return JSON.parse(e)}catch(e){return r()||[]}}if("device"===s)return i?e:c.getDeviceById(e)||c.getDeviceById(r());if(e&&t.json)try{return JSON.parse(e)}catch(e){return r()}return e||r()}(this.device.storage.getItem(e),t,(()=>null!=t.persistedDefaultValue?(this.putSettingInternal(t,void 0,e,t.persistedDefaultValue),t.persistedDefaultValue):t.defaultValue),r);return t.mapGet?t.mapGet(i):i}getItem(e){return this.getItemInternal(e,this.settings[e])}}},430:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Bitstream=class{constructor(e){this.view=e,this.bitoffset=0}ExpGolomb(){const{view:e}=this;let{zeros:t,skip:r,byt:i,byteoffset:s}=function(e,t){let r=0,i=t>>3,s=7&t,n=-1,o=e.getUint8(i)<<s;do{r=128&o,o<<=1,n++,s++,8===s&&(s=0,i++,o=e.getUint8(i))}while(!r);return{zeros:n,skip:s,byt:o,byteoffset:i}}(e,this.bitoffset),n=1;for(;t>0;)n=n<<1|(128&i)>>>7,i<<=1,r++,t--,8===r&&(r=0,s++,i=e.getUint8(s));return this.bitoffset=s<<3|r,n-1}SignedExpGolomb(){const e=this.ExpGolomb();return 1&e?e+1>>>1:-(e>>>1)}readBit(){const e=7&this.bitoffset,t=this.bitoffset>>3;return this.bitoffset++,this.view.getUint8(t)>>>7-e&1}readByte(){const e=7&this.bitoffset,t=this.bitoffset>>>3;this.bitoffset+=8;const r=this.view.getUint8(t);if(0===e)return r;return r<<e|this.view.getUint8(t+1)>>>8-e}readNibble(){const e=7&this.bitoffset,t=this.bitoffset>>3;this.bitoffset+=4;const r=this.view.getUint8(t);if(0===e)return r>>>4;if(e<=4)return r>>>4-e&15;return 15&(r<<e-4|this.view.getUint8(t+1)>>>12-e)}read5(){const e=7&this.bitoffset,t=this.bitoffset>>3;this.bitoffset+=5;const r=this.view.getUint8(t);if(0===e)return r>>>3;if(e<=3)return r>>>3-e&31;return 31&(r<<e-3|this.view.getUint8(t+1)>>>11-e)}readWord(){const e=7&this.bitoffset,t=this.bitoffset>>>3;this.bitoffset+=32;const{view:r}=this,i=65536*r.getUint16(t)+r.getUint16(t+2);return 0===e?i:i*2**e+(r.getUint8(t+4)>>>8-e)}more_rbsp_data(){const e=7&this.bitoffset;let t=this.bitoffset>>3;const r=this.view.byteLength;if(t>=r)return!1;let i=this.view.getUint8(t)<<e&255,s=i>0;if(s&&!Number.isInteger(Math.log2(i)))return!0;for(;++t<r;){i=this.view.getUint8(t);const e=i>0;if(s&&e)return!0;if(e&&!Number.isInteger(Math.log2(i)))return!0;s=s||e}return!1}}},431:function(e,t,r){"use strict";var i,s=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(i=function(e){return i=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},i(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=i(e),o=0;o<r.length;o++)"default"!==r[o]&&s(t,e,r[o]);return n(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RebroadcastPlugin=void 0,t.fork=async function(){return new G};const c=r(889),d=r(515),l=r(460),u=r(336),p=r(890),m=r(854),h=r(724),f=o(r(743)),g=r(414),S=a(r(982)),y=r(434),_=r(353),v=a(r(278)),b=a(r(928)),P=r(502),w=r(926),T=r(254),E=r(588),R=r(710),M=r(702),I=r(51),A=r(802),{mediaManager:x,log:D,systemManager:C,deviceManager:O}=f.default,L="-fflags +genpts",k="Scrypted (TCP)",N="Scrypted (UDP)",B="FFmpeg (TCP)",H="FFmpeg (UDP)",j="Default";class U{constructor(e,t,r,i){this.mixin=e,this.advertisedMediaStreamOptions=t,this.enabled=r,this.forceBatteryPrebuffer=i,this.rtspPrebuffer=[],this.usingScryptedParser=!1,this.usingScryptedUdpParser=!1,this.activeClients=0,this.storage=e.storage,this.console=e.console,this.mixinDevice=e.mixinDevice,this.syntheticInputIdKey="syntheticInputIdKey-"+this.streamId,this.ffmpegInputArgumentsKey="ffmpegInputArguments-"+this.streamId,this.ffmpegOutputArgumentsKey="ffmpegOutputArguments-"+this.streamId,this.lastDetectedAudioCodecKey="lastDetectedAudioCodec-"+this.streamId,this.rtspParserKey="rtspParser-"+this.streamId;const s="rtspServerPathKey-"+this.streamId,n="rtspServerMutedPathKey-"+this.streamId;this.rtspServerPath=this.storage.getItem(s),this.rtspServerPath||(this.rtspServerPath=S.default.randomBytes(8).toString("hex"),this.storage.setItem(s,this.rtspServerPath)),this.rtspServerMutedPath=this.storage.getItem(n),this.rtspServerMutedPath||(this.rtspServerMutedPath=S.default.randomBytes(8).toString("hex"),this.storage.setItem(n,this.rtspServerMutedPath)),this.handleChargingBatteryEvents()}get stopInactive(){return!this.enabled||this.shouldDisableBatteryPrebuffer()}getDetectedIdrInterval(){const e=[];if(this.rtspPrebuffer.length){let t;for(const r of this.rtspPrebuffer)(0,u.findH264NaluType)(r,u.H264_NAL_TYPE_IDR)&&(t&&e.push(r.time-t),t=r.time)}if(!e.length)return;return e.reduce(((e,t)=>e+t),0)/e.length}get streamId(){return this.advertisedMediaStreamOptions.id}get streamName(){return this.advertisedMediaStreamOptions.name||`Stream ${this.streamId}`}clearPrebuffers(){this.rtspPrebuffer=[]}release(){this.clearPrebuffers(),this.parserSessionPromise?.then((e=>{this.console.log(this.streamName,"prebuffer session released"),e.kill(new Error("rebroadcast disabled")),this.clearPrebuffers()})),this.batteryListener&&(this.batteryListener.removeListener(),this.batteryListener=null),this.chargerListener&&(this.chargerListener.removeListener(),this.chargerListener=null)}ensurePrebufferSession(){if(this.parserSessionPromise||this.mixin.released)return;this.console.log(this.streamName,"prebuffer session started"),this.parserSessionPromise=this.startPrebufferSession();let e=!1;this.parserSessionPromise.then((t=>{t.once("rtsp",(()=>{e=!0,this.mixin.online||(this.mixin.online=!0)})),t.killed.finally((()=>{this.console.error(this.streamName,"prebuffer session ended"),this.parserSessionPromise=void 0}))})).catch((t=>{if(this.console.error(this.streamName,"prebuffer session ended with error",t),this.parserSessionPromise=void 0,!e){const e=[...this.mixin.sessions.values()].filter((e=>e!==this));if(e.length){!e.some((e=>e.rtspPrebuffer.length))&&this.mixin.online&&(this.mixin.online=!1)}}}))}canUseRtspParser(e){return e?.container?.startsWith("rtsp")}getParser(e){let t,r=this.storage.getItem(this.rtspParserKey),i=!r||"Default"===r;if(this.canUseRtspParser(e))switch(i&&(r=localStorage.getItem("defaultRtspParser")),r){case B:case H:case k:case N:t=r;break;default:t=k}else t=j,i=!0,r=void 0;return{parser:t,isDefault:i}}async parseCodecs(e){const t=await this.parserSession.sdp,r=(0,p.parseSdp)(t),i=r.msections.find((e=>"video"===e.type)),s=r.msections.find((e=>"audio"===e.type)),n=s?.codec,o=i.codec;let a;if(!e){for(const e of this.rtspPrebuffer)try{let t=(0,u.findH264NaluType)(e,u.H264_NAL_TYPE_SPS);if(t){const e=(0,_.parse)(t);a=(0,I.getSpsResolution)(e)}}catch(e){}if(!a)try{const e=(0,p.getSpsPps)(i);let{sps:t}=e;if(t)if("h264"===i.codec){const e=(0,_.parse)(t);a=(0,I.getSpsResolution)(e)}else i.codec}catch(e){}}return{inputVideoCodec:o,inputAudioCodec:n,inputVideoResolution:a}}async getMixinSettings(){const e=[],t=this.parserSession;let r=0,i=0;for(const e of this.rtspPrebuffer){i=i||e.time;for(const t of e.chunks)r+=t.byteLength}const s=Date.now()-i,n=Math.round(r/s*8),o="Streams",a=`Stream: ${this.streamName}`;if(this.mixin.streamSettings.storageSettings.values.synthenticStreams.includes(this.streamId)){const t=[...this.mixin.sessions.keys()].filter((e=>e&&!e.startsWith("synthetic:")));e.push({group:o,subgroup:a,key:this.syntheticInputIdKey,title:"Synthetic Stream Source",description:"The source stream to transcode.",choices:t,value:this.storage.getItem(this.syntheticInputIdKey)})}const c=()=>{e.push({title:"FFmpeg Input Arguments Prefix",group:o,subgroup:a,description:"Optional/Advanced: Additional input arguments to pass to the ffmpeg command. These will be placed before the input arguments.",key:this.ffmpegInputArgumentsKey,value:this.storage.getItem(this.ffmpegInputArgumentsKey),placeholder:L,choices:[L,"-use_wallclock_as_timestamps 1","-v verbose"],combobox:!0},{title:"FFmpeg Output Prefix",group:o,subgroup:a,description:"Optional/Advanced: Additional output arguments to pass to the ffmpeg command. These will be placed before the output.",key:this.ffmpegOutputArgumentsKey,value:this.storage.getItem(this.ffmpegOutputArgumentsKey),choices:["-c:v libx264 -pix_fmt yuvj420p -preset ultrafast -bf 0 -g 60 -r 15 -b:v 500000 -bufsize 1000000 -maxrate 500000"],combobox:!0})};let d=!0;if(this.canUseRtspParser(this.advertisedMediaStreamOptions)){const t=this.getParser(this.advertisedMediaStreamOptions),r=t.parser,i=t.isDefault?j:t.parser;e.push({key:this.rtspParserKey,group:o,subgroup:a,title:"RTSP Parser",description:`The RTSP Parser used to read the stream. The default is "${r}" for this stream.`,value:i,choices:[j,k,N,B,H]}),d=!t.parser.includes("Scrypted")}if(d&&c(),t){const t=await this.parseCodecs(),r=t.inputVideoResolution?.width&&t.inputVideoResolution?.height?`${t.inputVideoResolution?.width}x${t.inputVideoResolution?.height}`:"unknown",i=this.getDetectedIdrInterval();e.push({key:"detectedResolution",group:o,subgroup:a,title:"Detected Resolution and Bitrate",readonly:!0,value:`${r} @ ${n||"unknown"} Kb/s`,description:"Configuring your camera to 1920x1080, 2000Kb/S, Variable Bit Rate, is recommended."},{key:"detectedCodec",group:o,subgroup:a,title:"Detected Video/Audio Codecs",readonly:!0,value:(t?.inputVideoCodec?.toString()||"unknown")+"/"+(t?.inputAudioCodec?.toString()||"unknown"),description:"Configuring your camera to H264 video, and audio to Opus or PCM-mulaw (G.711ulaw) is recommended."},{key:"detectedKeyframe",group:o,subgroup:a,title:"Detected Keyframe Interval",description:"Configuring your camera to 4 seconds is recommended (IDR aka Frame Interval = FPS * 4 seconds).",readonly:!0,value:(i||0)/1e3||"unknown"})}else e.push({title:"Status",group:o,subgroup:a,key:"status",description:"Rebroadcast is currently idle and will be started automatically on demand.",value:"Idle",readonly:!0});return e.push({group:o,subgroup:a,key:"rtspRebroadcastUrl",title:"RTSP Rebroadcast Url",description:"The RTSP URL of the rebroadcast stream. Substitute localhost as appropriate.",readonly:!0,value:`rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerPath}`}),e.push({group:o,subgroup:a,key:"rtspRebroadcastMutedUrl",title:"RTSP Rebroadcast Url (Muted)",description:"The RTSP URL of the muted rebroadcast stream. Substitute localhost as appropriate.",readonly:!0,value:`rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerMutedPath}`}),e}async startPrebufferSession(){let e;this.clearPrebuffers();try{e=(await this.mixinDevice.getVideoStreamOptions()).find((e=>e.id===this.streamId)),this.mixin.streamSettings.storageSettings.values.noAudio&&(e.audio=null)}catch(e){}this.mixin.streamSettings.storageSettings.values.privacyMode&&(e.audio=null);const t=null===e?.audio,r=!t&&e?.audio?.codec;let i=this.storage.getItem(this.lastDetectedAudioCodecKey)||void 0;"null"===i&&(i=null);const s={console:this.console,timeout:6e4,parsers:{}};let n;if(this.parsers=s.parsers,this.mixin.streamSettings.storageSettings.values.privacyMode){const e={container:"mp4",inputArguments:["-re","-stream_loop","-1","-i","camera-slash.mp4"],mediaStreamOptions:{id:this.streamId,container:"mp4"}};n=await x.createMediaObject(e,f.ScryptedMimeTypes.FFmpegInput)}else if(this.mixin.streamSettings.storageSettings.values.synthenticStreams.includes(this.streamId)){const e=this.storage.getItem(this.syntheticInputIdKey);if(!e)throw new Error("synthetic stream has not been configured with an input");const t=C.getDeviceById(this.mixin.id);n=await t.getVideoStream({id:e})}else n=await this.mixinDevice.getVideoStream(e);const o="x-scrypted/x-rfc4571"===n.mimeType;let a,c;if(this.storage.removeItem(this.lastDetectedAudioCodecKey),this.usingScryptedParser=!1,o){this.usingScryptedParser=!0,this.console.log("bypassing ffmpeg: using scrypted rfc4571 parser");const e=await x.convertMediaObjectToJSON(n,"x-scrypted/x-rfc4571");let{url:t,sdp:r,mediaStreamOptions:i}=e;r=(0,p.addTrackControls)(r),c=i;const o=(0,u.createRtspParser)();s.parsers.rtsp=o,a=(0,R.startRFC4571Parser)(this.console,(0,R.connectRFC4571Parser)(t),r,i,{timeout:1e4})}else{const e=await x.convertMediaObjectToJSON(n,f.ScryptedMimeTypes.FFmpegInput);c=e.mediaStreamOptions||this.advertisedMediaStreamOptions;let{parser:r,isDefault:i}=this.getParser(c);if(this.usingScryptedParser=r===k||r===N,this.usingScryptedUdpParser=r===N,this.usingScryptedParser){const i=(0,u.createRtspParser)();s.parsers.rtsp=i,a=await(0,M.startRtspSession)(this.console,e.url,e.mediaStreamOptions,{useUdp:r===N,audioSoftMuted:t,rtspRequestTimeout:1e4})}else{let i;i=t?["-an"]:["-acodec","copy"];let n=["-vcodec","copy"];i=t?i:["-acodec","copy"],r===H?e.inputArguments=["-rtsp_transport","udp","-i",e.url]:r===B&&(e.inputArguments=["-rtsp_transport","tcp","-i",e.url]);const o=this.storage.getItem(this.ffmpegInputArgumentsKey)||L,c=this.storage.getItem(this.ffmpegOutputArgumentsKey)||"";e.inputArguments.unshift(...o.split(" ")),e.h264EncoderArguments?.length&&(n=[...e.h264EncoderArguments]),c&&(n=[...c.split(" ").filter((e=>!!e))],i=[]);const d=(0,u.createRtspParser)({vcodec:n,acodec:i});s.parsers.rtsp=d,a=await(0,P.startParserSession)(e,s)}}this.sdp=a.sdp,a.on("error",(e=>{e.message?.startsWith("killed:")||console.error("rebroadcast error",e)})),await a.sdp,this.parserSession=a,a.killed.finally((()=>{this.parserSession===a&&(this.parserSession=void 0)})),a.killed.finally((()=>clearTimeout(this.inactivityTimeout)));const d=await this.parseCodecs();!t&&r&&void 0!==d.inputAudioCodec&&d.inputAudioCodec!==r&&this.console.warn("Audio codec plugin reported vs detected mismatch",r,i);const l=e?.video?.codec;if(l&&void 0!==d.inputVideoCodec&&d.inputVideoCodec!==l&&this.console.warn("Video codec plugin reported vs detected mismatch",l,d.inputVideoCodec),d.inputAudioCodec||this.console.log("No audio stream detected."),this.storage.setItem(this.lastDetectedAudioCodecKey,d.inputAudioCodec||"null"),"h264"!==d.inputVideoCodec&&this.console.error("Video codec is not h264. If there are errors, try changing your camera's encoder output."),O.onMixinEvent(this.mixin.id,this.mixin,f.ScryptedInterface.Settings,void 0),c?.refreshAt){let e,t=c;const r=async()=>{if(!a.isActive)return;const e=await this.mixinDevice.getVideoStream(t),r=await x.convertMediaObjectToJSON(e,f.ScryptedMimeTypes.FFmpegInput);t=r.mediaStreamOptions,i(t)},i=t=>{const i=t.refreshAt-Date.now()-3e4;this.console.log("refreshing media stream in",i),e=setTimeout(r,i)};i(t),a.killed.finally((()=>clearTimeout(e)))}let m=0,h=this.rtspPrebuffer;return a.on("rtsp",(e=>{const t=Date.now();for(e.time=t,h.push(e);h.length&&h[0].time<t-1e4;)h.shift(),m++;m>1e5&&(h=h.slice(),this.rtspPrebuffer=h,m=0)})),a.start(),a}printActiveClients(){this.console.log(this.streamName,"active rebroadcast clients:",this.activeClients)}inactivityCheck(e,t){this.activeClients||this.stopInactive&&(this.inactivityTimeout&&!t||(clearTimeout(this.inactivityTimeout),this.inactivityTimeout=setTimeout((()=>{this.inactivityTimeout=void 0,this.activeClients?this.console.log("inactivity timeout found active clients."):(this.console.log(this.streamName,"terminating rebroadcast due to inactivity"),e.kill(new Error("killed: stream inactivity")))}),1e4)))}handleChargingBatteryEvents(){if(!this.mixin.interfaces.includes(f.ScryptedInterface.Charger)||!this.mixin.interfaces.includes(f.ScryptedInterface.Battery))return;const e=async()=>{if(this.stopInactive){if(this.console.log(this.streamName,"low battery or not charging, prebuffering and rebroadcasting will only work on demand"),!this.activeClients&&this.parserSessionPromise){this.console.log(this.streamName,"terminating rebroadcast due to low battery or not charging");(await this.parserSessionPromise).kill(new Error("killed: low battery or not charging"))}}else this.ensurePrebufferSession()},t=this.mixin.id;this.batteryListener||(this.batteryListener=C.listenDevice(t,f.ScryptedInterface.Battery,(()=>e()))),this.chargerListener||(this.chargerListener=C.listenDevice(t,f.ScryptedInterface.Charger,(()=>e())))}shouldDisableBatteryPrebuffer(){if(!this.mixin.interfaces.includes(f.ScryptedInterface.Battery))return null;if(this.forceBatteryPrebuffer)return!1;const e=null==this.mixin.batteryLevel||this.mixin.batteryLevel<20;return!this.mixin.interfaces.includes(f.ScryptedInterface.Charger)||e||this.mixin.chargeState!==f.ChargeState.Charging}async handleRebroadcasterClient(e){const{isActiveClient:t,session:r,socketPromise:i,requestedPrebuffer:s}=e;let n;try{if(n=await i,!r.isActive)throw n.destroy(),new Error("session terminated before socket connected")}catch(e){return this.inactivityCheck(r,!1),void(e instanceof d.ListenZeroSingleClientTimeoutError?this.console.warn("client connection timed out"):this.console.error("client connection error",e))}t&&(this.activeClients++,this.printActiveClients()),n.once("close",(()=>{t&&(this.activeClients--,this.printActiveClients()),this.inactivityCheck(r,t)}));let o=e=>{e.startStream&&n.write(e.startStream);const t=e=>{for(const t of e.chunks)n.write(t);return n.writableLength};return o=t,t(e)};const a=(t,r)=>{if(e.filter&&!(t=e.filter(t,r)))return;o(t)>1e8&&(this.console.log("more than 100MB has been buffered, did downstream die? killing connection.",this.streamName),c())},c=()=>{n.destroy(),r.removeListener("rtsp",a),r.removeListener("killed",c)};r.on("rtsp",a),r.once("killed",c),n.once("close",(()=>{c()}));const l=Date.now(),u=this.rtspPrebuffer;if(e.findSyncFrame){const e=this.parsers.rtsp,t=u.filter((e=>e.time>=l-s));let r=e.findSyncFrame(t);r||(this.console.warn("Unable to find sync frame in rtsp prebuffer."),r=[]);for(const e of r)a(e,!0)}else for(const e of u)e.time<l-s||a(e,!0)}async getVideoStream(e,t){if(!1===t?.refresh&&!this.parserSessionPromise)throw new Error("Stream is currently unavailable and will not be started for this request. RequestMediaStreamOptions.refresh === false");const r=!this.parserSessionPromise;this.ensurePrebufferSession();const i=await this.parserSessionPromise;let s=t?.prebuffer;if(null==s||r){const e="remote"===t?.destination?2e3:4e3;s=Math.min(e,this.getDetectedIdrInterval()||e)}const n=await this.parseCodecs(!0),o=i.negotiateMediaStream(t,n.inputVideoCodec,n.inputAudioCodec);let a,c,d,l,m=await this.sdp;this.mixin.streamSettings.storageSettings.values.noAudio&&(o.audio=null);let h=!1;const f=new Map,g=new Map;let y;const _=(0,p.parseSdp)(m),v=_.msections.find((e=>e.codec&&e.codec===o.video?.codec))||_.msections.find((e=>"video"===e.type));let P=_.msections.find((e=>e.codec&&e.codec===o.audio?.codec))||_.msections.find((e=>"audio"===e.type));null===o.audio&&(P=void 0),P||(o.audio=null),_.msections=_.msections.filter((e=>e===v||e===P));const E=void 0===t?.prebuffer,R=_.msections.find((e=>"video"===e.type))?.codec;m=_.toSdp(),l=(e,t)=>{if(t&&E&&e.type!==R)return;const r=f.get(e.type);if(h){if(void 0===r)return}else{if(null==r){const t=g.get(e.type);return void(t&&y.sendTrack(t.control,e.chunks[1],e.type.startsWith("rtcp-")))}const t=e.chunks.slice(),i=Buffer.from(t[0]);i.writeUInt8(r,1),t[0]=i,e={type:e.type,startStream:e.startStream,chunks:t}}if(!y.writeStream)return e;y.writeRtpPayload(e.chunks[0],e.chunks[1])};const M="internal"===t?.route?void 0:"0.0.0.0",I=await(0,u.listenSingleRtspClient)({hostname:M,pathToken:b.default.join(S.default.randomBytes(8).toString("hex"),this.mixin.id),createServer:e=>(m=(0,p.addTrackControls)(m),y=new w.FileRtspServer(e,m),y.writeConsole=this.console,y)});a=I.rtspServerPromise.then((async e=>{if(i.parserSpecific){const t=i.parserSpecific;e.resolveInterleaved=e=>{const r=t.interleaved.get(e.codec);return[r,r+1]}}await e.handlePlayback(),e.handleTeardown().catch((()=>{})).finally((()=>e.client.destroy()));for(const t of Object.values(e.setupTracks))"udp"!==t.protocol?(f.set(t.codec,t.destination),f.set(`rtcp-${t.codec}`,t.destination+1)):(g.set(t.codec,t),g.set(`rtcp-${t.codec}`,t));return h=i.parserSpecific&&0===g.size,e.client})),c=I.url,M&&(d=await(0,T.getUrlLocalAdresses)(this.console,c)),o.sdp=m;const A=!1!==t?.refresh;this.handleRebroadcasterClient({findSyncFrame:e,isActiveClient:A,requestedPrebuffer:s,socketPromise:a,session:i,filter:l}),o.prebuffer=0,P&&(o.audio||={},o.audio.codec||=P.rtpmap.codec,o.audio.sampleRate||=P.rtpmap.clock),n.inputVideoResolution?.width&&n.inputVideoResolution?.height&&o.video&&Object.assign(o.video,n.inputVideoResolution);const x=Date.now();let D=0;const C=this.rtspPrebuffer;for(const e of C)if(!(e.time<x-s)){o.prebuffer||(o.prebuffer=x-e.time);for(const t of e.chunks)D+=t.length}o.prebufferBytes=D;const O=["-analyzeduration","0","-probesize",Math.max(5e5,D).toString()];this.usingScryptedUdpParser||O.push("-reorder_queue_size","0");return{url:c,urls:d,container:"rtsp",inputArguments:[...O,...this.parsers.rtsp.inputArguments||[],"-f",this.parsers.rtsp.container,"-i",c],mediaStreamOptions:o}}}class V extends m.SettingsMixinDeviceBase{constructor(e){super(e),this.released=!1,this.sessions=new Map,this.streamSettings=(0,A.createStreamSettings)(this);const t=[C.getDeviceById("@scrypted/prebuffer-mixin").id],r=C.getDeviceById("@scrypted/webrtc");r&&this.providedInterfaces.includes(f.ScryptedInterface.RTCSignalingChannel)&&t.unshift(r.id);let i=!0;for(let e=0;e<t.length;e++)if(this.mixins[e]!==t[e]){i=!1;break}i||(this.console.warn("rebroadcast/webrtc order not matched. this may cause flapping on interface changes. fixing."),setTimeout((()=>{const e=this.mixins.filter((e=>!t.includes(e)));e.unshift(...t);C.getDeviceById(this.id).setMixins(e)}),1e3)),this.delayStart(),(async()=>{let e=1e3;for(;;)try{await this.startRtspServer();break}catch(t){this.console.warn("Error starting RTSP Rebroadcast Server. Retrying shortly. If this problem persists, consider assigning a different port. This warning can be ignored if the rebroadcast URL is not in use.",t),await(0,h.sleep)(e),e=Math.min(6e4,2*e)}})(),this.settingsListener=C.listenDevice(this.id,f.ScryptedInterface.Settings,(()=>this.ensurePrebufferSessions())),this.videoCameraListener=C.listenDevice(this.id,f.ScryptedInterface.VideoCamera,(()=>this.reinitiatePrebufferSessions()))}async startRtspServer(){(0,d.closeQuiet)(this.rtspServer),this.rtspServer=new v.default.Server((async e=>{let t;this.console.log("external rtsp client",e.localAddress,e.localPort);const r=new u.RtspServer(e,void 0,!1,(async(e,i,s,n)=>{r.checkRequest=void 0;const o=new URL(i);for(const e of this.sessions.values()){if(o.pathname==="/"+e.rtspServerPath)return r.console=e.console,t=e,t.ensurePrebufferSession(),await t.parserSessionPromise,r.sdp=await t.sdp,!0;if(o.pathname==="/"+e.rtspServerMutedPath){r.console=e.console,t=e,t.ensurePrebufferSession(),await t.parserSessionPromise;const i=(0,p.parseSdp)(await t.sdp);return i.msections=i.msections.filter((e=>"video"===e.type)),r.sdp=i.toSdp(),!0}}return!1}));this.console.log("RTSP Rebroadcast connection started."),r.console=this.console;try{await r.handlePlayback();const i=new Map;for(const[e,t]of Object.entries(r.setupTracks))i.set(t.codec,e);const s=await t.parserSessionPromise,n=Math.max(4e3,t.getDetectedIdrInterval()||4e3);t.handleRebroadcasterClient({findSyncFrame:!0,isActiveClient:!0,session:s,socketPromise:Promise.resolve(e),requestedPrebuffer:n,filter:(t,s)=>{const n=i.get(t.type);if(n){r.sendTrack(n,t.chunks[1],!1);r.client.writableLength>1e8&&(this.console.log("more than 100MB has been buffered to RTSP Client, did downstream die? killing connection."),e.destroy())}}}),await r.handleTeardown()}catch(t){e.destroy()}this.console.log("RTSP Rebroadcast connection finished.")})),this.rtspServer.listen(this.streamSettings.storageSettings.values.rebroadcastPort||0),await(0,y.once)(this.rtspServer,"listening").then((()=>{const e=this.rtspServer.address().port;this.streamSettings.storageSettings.values.rebroadcastPort=e}))}delayStart(){this.console.log("prebuffer sessions starting in 5 seconds"),setTimeout((()=>this.ensurePrebufferSessions()),5e3)}async getVideoStream(e){await this.ensurePrebufferSessions();let t=e?.id;this.sessions.has(t)||(t=void 0);const r=await this.mixinDevice.getVideoStreamOptions();let i;if(!t){switch(e?.destination){case"medium-resolution":case"remote":i=this.streamSettings.getRemoteStream(r);break;case"low-resolution":i=this.streamSettings.getLowResolutionStream(r);break;case"local-recorder":i=this.streamSettings.getRecordingStream(r);break;case"remote-recorder":i=this.streamSettings.getRemoteRecordingStream(r);break;case"local":i=this.streamSettings.getDefaultStream(r);break;default:const t=e?.video?.width,s=e?.video?.height,n=Math.max(t,s);i=n?n>1280?this.streamSettings.getDefaultStream(r):n>720?this.streamSettings.getRemoteStream(r):this.streamSettings.getLowResolutionStream(r):this.streamSettings.getDefaultStream(r)}t=i.stream.id}let s,n=this.sessions.get(t);if(!n)throw new Error("stream not found");return s=await n.getVideoStream(!0,e),x.createFFmpegMediaObject(s,{sourceId:this.id})}async ensurePrebufferSessions(){const e=await this.mixinDevice.getVideoStreamOptions(),t=this.getPrebufferedStreams(e),r=t?t.map((e=>e.id)):[void 0],i=e?.map((e=>e.id))||[void 0];if("true"!==this.storage.getItem("warnedCloud")){const t=e?.find((e=>"cloud"===e.source));t&&(this.storage.setItem("warnedCloud","true"),D.a(`${this.name} is a cloud camera. Prebuffering maintains a persistent stream and will not be enabled by default. You must enable the Prebuffer stream manually.`))}if("true"!==this.storage.getItem("warnedSynthetic")){const t=e?.find((e=>"synthetic"===e.source));t&&(this.storage.setItem("warnedSynthetic","true"),D.a(`${this.name} is a synthetic stream requiring substantial transcoding overhead. Prebuffering maintains a persistent stream and will not be enabled by default. You must enable the Prebuffer stream manually.`))}const s=new Set(this.sessions.keys());s.delete(void 0),this.sessions.delete(void 0);for(const t of i){s.delete(t);let i=this.sessions.get(t);if(i)continue;const n=e?.find((e=>e.id===t));n?.prebuffer&&D.a(`Prebuffer is already available on ${this.name}. If this is a grouped device, disable the Rebroadcast extension.`);const o=n?.name,a=r.includes(t);i=new U(this,n,a,n.allowBatteryPrebuffer),this.sessions.set(t,i),a?(i.shouldDisableBatteryPrebuffer()&&this.console.log("camera is battery powered and either not charging or on low battery, prebuffering and rebroadcasting will only work on demand."),(async()=>{for(;this.sessions.get(t)===i&&!this.released;)if(i.shouldDisableBatteryPrebuffer())await new Promise((e=>setTimeout(e,6e4)));else{i.ensurePrebufferSession();try{this.console.log(o,"prebuffer session starting");const e=await i.parserSessionPromise;await e.killed}catch(e){}this.console.log(this.name,"restarting prebuffer session in 5 seconds"),await new Promise((e=>setTimeout(e,5e3)))}this.console.log(o,"exiting prebuffer session (released or restarted with new configuration)")})()):this.console.log("stream",o,"is not enabled and will be rebroadcast on demand.")}for(const e of this.streamSettings.storageSettings.values.synthenticStreams){const t=`synthetic:${e}`;s.delete(t);let r=this.sessions.get(t);r||(r=new U(this,{id:e},!1,!1),this.sessions.set(t,r),this.console.log("stream",e,"is synthetic and will be rebroadcast on demand."))}if(!this.sessions.has(void 0)){const t=this.streamSettings.storageSettings.values.defaultStream;let s=this.sessions.get(e?.find((e=>e.name===t))?.id);s||(s=this.sessions.get(e?.find((e=>e.id===r[0]))?.id)),s||(s=this.sessions.get(e?.find((e=>e.id===i?.[0]))?.id)),s?this.sessions.set(void 0,s):this.console.warn("Unable to find Default Stream?")}if(s.size){this.console.log("Removing sessions due to config change",[...s]);for(const e of s){const t=this.sessions.get(e);this.sessions.delete(e),t.release()}}}async getMixinSettings(){const e=[];e.push(...await this.streamSettings.storageSettings.getSettings());for(const t of new Set([...this.sessions.values()]))if(t)try{e.push(...await t.getMixinSettings())}catch(e){this.console.error("error in prebuffer session getMixinSettings",e)}return e}async reinitiatePrebufferSessions(){const e=this.sessions;this.sessions=new Map;for(const t of e.values())t?.parserSessionPromise?.then((e=>e.kill(new Error("rebroadcast settings changed"))));this.ensurePrebufferSessions()}async putMixinSetting(e,t){this.streamSettings.storageSettings.settings[e]?await this.streamSettings.storageSettings.putSetting(e,t):this.storage.setItem(e,t?.toString()||""),"Transcoding"!==this.streamSettings.storageSettings.settings[e]?.group&&this.reinitiatePrebufferSessions()}getPrebufferedStreams(e){return this.streamSettings.getPrebufferedStreams(e)}async getVideoStreamOptions(){const e=await this.mixinDevice.getVideoStreamOptions()||[];let t=this.getPrebufferedStreams(e);const r=new Map;r.set("local",this.streamSettings.getDefaultStream(e)?.stream?.id),r.set("remote",this.streamSettings.getRemoteStream(e)?.stream?.id),r.set("medium-resolution",this.streamSettings.getRemoteRecordingStream(e)?.stream?.id),r.set("remote-recorder",this.streamSettings.getRemoteRecordingStream(e)?.stream?.id),r.set("local-recorder",this.streamSettings.getRecordingStream(e)?.stream?.id),r.set("low-resolution",this.streamSettings.getLowResolutionStream(e)?.stream?.id);for(const i of e){const e=this.sessions.get(i.id);if((e?.parserSession||t.includes(i))&&(i.prebuffer=1e4),!i.destinations){i.destinations=[];for(const[e,t]of r.entries())t===i.id&&i.destinations.push(e)}}return e}async release(){(0,d.closeQuiet)(this.rtspServer),this.settingsListener.removeListener(),this.videoCameraListener.removeListener(),this.online=!0,super.release(),this.console.log("prebuffer sessions releasing if started"),this.released=!0;for(const e of this.sessions.values())e?.release()}}class F extends c.AutoenableMixinProvider{constructor(e){super(e),this.storageSettings=new g.StorageSettings(this,{defaultRtspParser:{group:"Advanced",title:"Default RTSP Parser",description:`Experimental: The Default parser used to read RTSP streams. The default is "${k}".`,defaultValue:j,choices:[j,k,N,B,H],onPut:()=>{this.log.a("Rebroadcast Plugin will restart momentarily."),f.default.deviceManager.requestRestart()}}}),this.currentMixins=new Map,this.log.clearAlerts(),this.fromMimeType="x-scrypted/x-rfc4571",this.toMimeType=f.ScryptedMimeTypes.FFmpegInput,process.nextTick((()=>{for(const e of Object.keys(C.getSystemState())){const t=C.getDeviceById(e);if(t.mixins?.includes(this.id))try{t.getVideoStreamOptions()}catch(e){this.console.error("error triggering prebuffer",t.name,e)}}})),f.default.deviceManager.getNativeIds().includes("transcode")&&process.nextTick((()=>{O.onDeviceRemoved("transcode")}))}async getSettings(){return[...await this.storageSettings.getSettings()]}putSetting(e,t){return this.storageSettings.putSetting(e,t)}async convert(e,t,r){const i=JSON.parse(e.toString()),{url:s,sdp:n}=i,o=(0,p.parseSdp)(n),a=new Map;for(const e of o.msections)for(const t of e.payloadTypes)a.set(t,e.control);const c=new URL(s);if(!c.protocol.startsWith("tcp"))throw new Error("rfc4751 url must be tcp");const{clientPromise:m,url:h}=await(0,d.listenZeroSingleClient)("127.0.0.1"),f={url:h,inputArguments:["-rtsp_transport","tcp","-i",h.replace("tcp","rtsp")]};return m.then((async e=>{const t=new u.RtspServer(e,n);t.console=this.console,await t.handlePlayback();const r=v.default.connect(parseInt(c.port),c.hostname);for(e.on("close",(()=>{r.destroy()})),r.on("close",(()=>{e.destroy()}));;){const i=(await(0,l.readLength)(r,2)).readInt16BE(0),s=await(0,l.readLength)(r,i),n=127&s[1],o=a.get(n);if(!o)throw e.destroy(),r.destroy(),new Error("unknown payload type "+n);t.sendTrack(o,s,!1)}})),Buffer.from(JSON.stringify(f))}async shouldEnableMixin(e){return e.type===f.ScryptedDeviceType.Camera||e.type===f.ScryptedDeviceType.Doorbell}shouldUnshiftMixin(e){return e.providedInterfaces.includes(f.ScryptedInterface.VideoCamera)}async canMixin(e,t){if(e!==f.ScryptedDeviceType.Doorbell&&e!==f.ScryptedDeviceType.Camera)return;if(!t.includes(f.ScryptedInterface.VideoCamera))return;return[f.ScryptedInterface.VideoCamera,f.ScryptedInterface.Settings,f.ScryptedInterface.Online,E.REBROADCAST_MIXIN_INTERFACE_TOKEN]}async getMixin(e,t,r){this.setHasEnabledMixin(r.id);const{id:i}=r,s=f.default.fork(),{worker:n}=s,o=await s.result,a=await o.newPrebufferMixin(e,t,r);return this.currentMixins.set(a,{worker:n,id:i}),a}async releaseMixin(e,t){const r=this.currentMixins.get(t)?.worker;this.currentMixins.delete(t),await t.release().catch((()=>{})),await(0,h.sleep)(1e3),r?.terminate()}}async function Y(e,t,r){return new V({mixinDevice:e,mixinDeviceState:r,mixinProviderNativeId:void 0,mixinDeviceInterfaces:t,group:"Streams",groupKey:"prebuffer"})}t.RebroadcastPlugin=F;class G{constructor(){this.newPrebufferMixin=Y}}t.default=F},434:e=>{"use strict";e.exports=require("events")},445:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cloneDeep=function(e){if(!e)return;return JSON.parse(JSON.stringify(e))}},460:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StreamEndError=void 0,t.read16BELengthLoop=async function(e,t){let r;const{skipHeader:n,callback:o}=t,a=t.offset||0,c=t.headerLength||2;let d,l;e.on("error",(e=>r=e));let u=0,p=0;const m=()=>{p++,h()},h=()=>{for(;;){if(u!==p)return;if(d){const t=e.read(l);if(!t)return;o(d,t),d=void 0}else{if(d=e.read(c),!d)return;if(n?.(d,m)){u++,d=void 0;continue}l=d.readUInt16BE(a)}}};throw h(),e.on("readable",h),await(0,i.once)(e,"end"),new s("read16BELengthLoop")},t.readLength=async function(e,t){if(e.readableEnded||e.destroyed)throw new s("readLength start");if(!t)return Buffer.alloc(0);{const r=e.read(t);if(r)return r}return new Promise(((r,i)=>{const n=()=>{const n=e.read(t);if(n)return a(),void r(n);(e.readableEnded||e.destroyed)&&i(new s("readLength readable"))},o=()=>{a(),i(new s("readLength end"))},a=()=>{e.removeListener("readable",n),e.removeListener("end",o)};e.on("readable",n),e.on("end",o)}))},t.readUntil=o,t.readLine=async function(e){return o(e,n)},t.readString=async function(e){return(await a(e)).toString()},t.readBuffer=a;const i=r(434);class s extends Error{constructor(e){super(`stream ended: ${e}`)}}t.StreamEndError=s;const n="\n".charCodeAt(0);async function o(e,t){const r=[];for(;;){const s=e.read();if(!s){await(0,i.once)(e,"readable");continue}const n=s.findIndex((e=>e===t));if(-1===n){r.push(s);continue}const o=s.subarray(0,n);r.push(o);const a=s.subarray(n+1);return e.unshift(a),Buffer.concat(r).toString()}}async function a(e){const t=[];return(e=await e).on("data",(e=>{t.push(e)})),e.resume(),await(0,i.once)(e,"end"),Buffer.concat(t)}},488:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimeoutError=void 0,t.singletonPromise=function(e,t,r=0){if(e?.promise)return e;const i=t();e?e.promise=i:e={promise:i,cacheDuration:r};return i.finally((()=>setTimeout((()=>e.promise=void 0),e.cacheDuration))),e},t.timeoutPromise=function(e,t){return new Promise(((i,s)=>{const n=setTimeout((()=>s(new r(t))),e);t.then((e=>{clearTimeout(n),i(e)})).catch((e=>{clearTimeout(n),s(e)}))}))},t.timeoutFunction=function(e,t){return new Promise(((i,s)=>{let n=!1;const o=t((()=>n)),a=setTimeout((()=>{n=!0,s(new r(o))}),e);o.then((e=>{clearTimeout(a),i(e)})).catch((e=>{clearTimeout(a),s(e)}))}))},t.createPromiseDebouncer=function(){let e;return t=>(e||(e=t().finally((()=>e=void 0))),e)},t.createMapPromiseDebouncer=function(){const e=new Map;return(t,r,i)=>{const s=JSON.stringify(t);let n=e.get(s);return n||(n=i().finally((()=>{r?setTimeout((()=>e.delete(s)),r):e.delete(s)})),e.set(s,n)),n}};class r extends Error{constructor(e){super("Operation Timed Out"),this.promise=e}}t.TimeoutError=r},502:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.parseResolution=async function(e){return new Promise(((t,r)=>{e.on("exit",(()=>r(new Error("ffmpeg exited while waiting to parse stream resolution"))));const i=r=>{const s=r.toString(),n=/(([0-9]{2,5})x([0-9]{2,5}))/.exec(s);n&&(e.stdout.removeListener("data",i),e.stderr.removeListener("data",i),t(n))};e.stdout.on("data",i),e.stderr.on("data",i)}))},t.parseVideoCodec=async function(e){return m(e,"Video")},t.parseAudioCodec=async function(e){return m(e,"Audio")},t.setupActivityTimer=h,t.startParserSession=async function(e,t){const{console:r}=t;let i=!0;const s=new u.EventEmitter;let d;s.on("error",(()=>{}));const m=new Promise((e=>{d=e})),f=new o.Deferred;function g(e){e||=new Error("killed"),i&&(s.emit("killed"),s.emit("error",e)),f.finished||f.reject(e),i=!1,d(),(0,c.safeKillFFmpeg)(w)}const S=e.inputArguments.slice(),y=e.env?{...process.env,...e.env}:void 0,_=e=>{if(!i)throw e(),new Error("parser session was killed killed before ffmpeg connected");s.on("killed",e)},v=["pipe","pipe","pipe"];let b=3;const P=[];for(const e of Object.keys(t.parsers)){const i=t.parsers[e];if(i.tcpProtocol){const n=await(0,a.listenZeroSingleClient)("127.0.0.1"),o=new URL(i.tcpProtocol);o.port=n.port.toString(),S.push(...i.outputArguments,o.toString());const{resetActivityTimer:c}=h(e,g,s,t?.timeout);P.push((async()=>{const t=await n.clientPromise;try{_((()=>t.destroy()));for await(const r of i.parse(t,void 0,void 0))s.emit(e,r),c()}catch(e){r.error("rebroadcast parse error",e),g(e)}}))}else S.push(...i.outputArguments,"pipe:"+b++),v.push("pipe")}S.unshift("-hide_banner"),(0,c.safePrintFFmpegArguments)(r,S);const w=l.default.spawn(e.ffmpegPath||await p.getFFmpegPath(),S,{stdio:v,env:y});(0,c.ffmpegLogInitialOutput)(r,w,void 0,t?.storage),w.on("exit",(()=>g(new Error("ffmpeg exited"))));const T=new o.Deferred;return t.parsers.rtsp.sdp.then((e=>{r?.log("sdp received from ffmpeg",e),f.resolve(e)})),(()=>{for(const e of P)e();let e=0;Object.keys(t.parsers).forEach((async i=>{const n=t.parsers[i];if(!n.parse||n.tcpProtocol)return;const o=w.stdio[3+e];e++;try{const{resetActivityTimer:e}=h(i,g,s,t?.timeout);for await(const t of n.parse(o,void 0,void 0))await T.promise,s.emit(i,t),e()}catch(e){r.error("rebroadcast parse error",e),g(e)}}))})(),{start(){T.resolve()},sdp:f.promise,get isActive(){return i},kill(e){g(e)},killed:m,negotiateMediaStream:(t,r,i)=>{const s=(0,n.cloneDeep)(e.mediaStreamOptions)||{id:void 0,name:void 0};return s.video||(s.video={}),s.video.codec=r,s.audio=s?.audio?.codec===i?e?.mediaStreamOptions?.audio:{codec:i},s},emit(e,t){return s.emit(e,t),this},on(e,t){return s.on(e,t),this},once(e,t){return s.once(e,t),this},removeListener(e,t){return s.removeListener(e,t),this}}};const s=r(608),n=r(445),o=r(290),a=r(515),c=r(643),d=i(r(743)),l=i(r(317)),u=r(434),{mediaManager:p}=d.default;async function m(e,t){let r=0;return new Promise(((i,s)=>{e.on("exit",(()=>s(new Error("ffmpeg exited while waiting to parse stream information: "+t))));const n=s=>{if(r+=s.length,r>1e4)return i(void 0);const o=s.toString().split("Output ")[0],a=o.lastIndexOf(`${t}: `);if(-1!==a){const r=o.substring(a+t.length+1).trim();let s=r.indexOf(" ");const c=r.indexOf(",");-1!==s&&c<s&&(s=c),-1!==s&&(e.stdout.removeListener("data",n),e.stderr.removeListener("data",n),i(r.substring(0,s)))}};e.stdout.on("data",n),e.stderr.on("data",n)})).finally((()=>{e.stdout.removeAllListeners("data"),e.stderr.removeAllListeners("data")}))}function h(e,t,r,i){const n=(0,s.createActivityTimeout)(i,(()=>{const r="timeout waiting for data, killing parser session";console.error(r,e),t(new Error(r))}));return r.once("killed",(()=>n.clearActivityTimer())),n}},515:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.listenZeroSingleClient=t.listenZero=t.ListenZeroSingleClientTimeoutError=void 0,t.closeQuiet=o,t.bindUdp=a,t.bindZero=async function(e){return a(e,0)},t.createBindZero=c,t.createSquentialBindZero=async function(e){let t=0;for(;;){const r=await c(e);try{return[r,await d(r.port+1,e)]}catch(e){t++,o(r.server)}if(10===t)throw new Error("unable to reserve sequential udp ports")}},t.reserveUdpPort=async function(){const e=await c();return await new Promise((t=>e.server.close((()=>t(void 0))))),e.port},t.createBindUdp=d,t.bind=async function(e,t){return e.bind(t),await(0,n.once)(e,"listening"),{port:t,url:`udp://127.0.0.1:${t}`}};const s=i(r(194)),n=r(434);async function o(e){if(e)try{await new Promise(((t,r)=>{try{e.close(t)}catch(e){r(e)}}))}catch(e){}}async function a(e,t,r){e.bind(t,r),await(0,n.once)(e,"listening");const i=e.address().port;return{port:i,url:`udp://127.0.0.1:${i}`}}async function c(e){return d(0,e)}async function d(e,t){const r=s.default.createSocket(t||"udp4"),{port:i,url:n}=await a(r,e);return{server:r,port:i,url:n}}var l=r(649);Object.defineProperty(t,"ListenZeroSingleClientTimeoutError",{enumerable:!0,get:function(){return l.ListenZeroSingleClientTimeoutError}}),Object.defineProperty(t,"listenZero",{enumerable:!0,get:function(){return l.listenZero}}),Object.defineProperty(t,"listenZeroSingleClient",{enumerable:!0,get:function(){return l.listenZeroSingleClient}})},563:(e,t,r)=>{"use strict";r.d(t,{w:()=>s});const i=require("os");class s extends Error{code;params;wrappedErrors;constructor(e,t,...r){e instanceof Array||(r=("undefined"==typeof t?[]:[t]).concat(r),t=e,e=[]),super(t),this.code=t||"E_UNEXPECTED",this.params=r,this.wrappedErrors=e,this.name=this.toString(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}static wrap(e,t,...r){const i=o(e.message),n=("wrappedErrors"in e?e.wrappedErrors:[]).concat(e);return t||(t=i?e.message:"E_UNEXPECTED"),e.message&&!i&&r.push(e.message),new s(n,t,...r)}static cast(e,t,...r){return n(e)?e:s.wrap(e,t,...r)}static bump(e,t,...r){return n(e)?s.wrap(e,e.code,...e.params):s.wrap(e,t,...r)}toString(){return(this.wrappedErrors.length?this.wrappedErrors[this.wrappedErrors.length-1].stack+i.EOL:"")+this.constructor.name+": "+this.code+" ("+this.params.join(", ")+")"}}function n(e){return!!(e instanceof s)||!!(e.constructor&&e.constructor.name&&e.constructor.name.endsWith("Error")&&"code"in e&&"string"==typeof e.code&&o(e.code)&&"params"in e&&e.params&&e.params instanceof Array)}function o(e){return/^([A-Z0-9_]+)$/.test(e)}},588:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REBROADCAST_MIXIN_INTERFACE_TOKEN=void 0,t.REBROADCAST_MIXIN_INTERFACE_TOKEN="mixin:@scrypted/prebuffer-mixin"},608:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createActivityTimeout=function(e,t){let r,i=Date.now();function s(){i=Date.now()}e&&(r=setInterval((()=>{Date.now()>i+e&&(clearInterval(r),r=void 0,t())}),e));return s(),{resetActivityTimer:s,clearActivityTimer:function(){clearInterval(r)}}}},610:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sleep=async function(e){await new Promise((t=>setTimeout(t,e)))}},643:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.safePrintFFmpegArguments=t.ffmpegLogInitialOutput=t.safeKillFFmpeg=void 0;var i=r(989);Object.defineProperty(t,"safeKillFFmpeg",{enumerable:!0,get:function(){return i.safeKillFFmpeg}}),Object.defineProperty(t,"ffmpegLogInitialOutput",{enumerable:!0,get:function(){return i.ffmpegLogInitialOutput}}),Object.defineProperty(t,"safePrintFFmpegArguments",{enumerable:!0,get:function(){return i.safePrintFFmpegArguments}})},649:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ListenZeroSingleClientTimeoutError=void 0,t.listenZero=c,t.listenZeroSingleClient=async function(e,t,r=3e4){const i=t?.tls?new o.default.Server(t):new n.default.Server(t),s=await c(i,e);let d;const l=new Promise(((e,t)=>{const s=setTimeout((()=>{i.close(),t(new a)}),r);d=()=>{clearTimeout(s),i.close()},i.on("connection",(t=>{d(),e(t)}))}));l.catch((()=>{}));let u=e;u&&"0.0.0.0"!==u||(u="127.0.0.1");return{server:i,cancel:d,url:`tcp://${u}:${s}`,host:u,port:s,clientPromise:l}};const s=r(434),n=i(r(278)),o=i(r(756));class a extends Error{constructor(){super("timeout waiting for client")}}async function c(e,t){return e.listen(0,t||"127.0.0.1"),await(0,s.once)(e,"listening"),e.address().port}t.ListenZeroSingleClientTimeoutError=a},702:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startRtspSession=async function(e,t,r,d){let l=!0;const u=new o.EventEmitter;u.on("error",(()=>{}));let p=[];const m=new s.RtspClient(t);m.console=e,m.requestTimeout=d.rtspRequestTimeout;const h=()=>{for(const e of p)(0,i.closeQuiet)(e);m.safeTeardown()};let f;const g=new Promise((e=>{f=e})),S=e=>{l&&(u.emit("killed"),u.emit("error",e||new Error("killed"))),l=!1,f(),h()};m.client.on("close",(()=>{S(new Error("rtsp socket closed"))})),m.client.on("error",(e=>{S(e)}));const{resetActivityTimer:y}=(0,a.setupActivityTimer)("rtsp",S,u,d?.rtspRequestTimeout);try{await m.options();let t=(await m.describe()).body.toString().trim();e.log("sdp",t);const i=(0,n.parseSdp)(t);let o=0;const a={};let p;const{useUdp:h}=d,f=e=>{if(h&&e.session&&!p){const t=(0,s.parseSemicolonDelimited)(e.session);p=parseInt(t.timeout)}};let _;h||(_={interleaved:new Map});const v=async(e,t)=>{let r;if(h){const i=o,n={path:e,type:"udp",onRtp:(e,r)=>{const n=Buffer.alloc(4);n.writeUInt8(s.RTSP_FRAME_MAGIC,0),n.writeUInt8(i,1),n.writeUInt16BE(r.length,2);const o={chunks:[n,r],type:t};u.emit("rtsp",o),y?.()}},c=await m.setup(n);r=n.dgram,f(c.headers);const d=Buffer.alloc(1),l=c.headers.transport.match(/.*?server_port=([0-9]+)-([0-9]+)/),[p,h,g]=l,S=parseInt(h);if(S){const{hostname:e}=new URL(m.url);r.send(d,S,e)}a[o]=t}else{const r=await m.setup({path:e,type:"tcp",port:o,onRtp:(e,r)=>{const i={chunks:[e,r],type:t};u.emit("rtsp",i),y?.()}}),i=r.interleaved?r.interleaved.begin:o;a[i]=t,_.interleaved.set(t,i)}o+=2};let b=!1;i.msections=i.msections.filter((t=>{if("video"===t.type){if(b)return e.warn("additional video section found. skipping."),!1;b=!0}else{if("audio"!==t.type)return e.warn("unknown section",t.type),!1;if(d.audioSoftMuted)return!1}return!0}));for(const e of i.msections)await v(e.control,e.codec);t=[...i.header.lines,...i.msections.map((e=>e.lines)).flat()].join("\r\n");const P=async()=>{try{await m.play(),m.console=void 0,await m.readLoop()}catch(e){S(e)}finally{S(new Error("rtsp read loop exited"))}};return(()=>{if(!i.msections.find((e=>"video"===e.type)))throw new Error("SDP does not contain a video section!");return{parserSpecific:_,start:P,sdp:Promise.resolve(t),get isActive(){return l},kill(e){S(e)},killed:g,resetActivityTimer:y,negotiateMediaStream:(e,i,s)=>(0,c.negotiateMediaStream)(t,r,i,s,e),emit(e,t){return u.emit(e,t),this},on(e,t){return u.on(e,t),this},once(e,t){return u.once(e,t),this},removeListener(e,t){return u.removeListener(e,t),this}}})()}catch(e){throw h(),e}};const i=r(515),s=r(336),n=r(890),o=r(203),a=r(502),c=r(710)},710:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.negotiateMediaStream=m,t.connectRFC4571Parser=function(e){const t=new URL(e);if(!t.protocol.startsWith("tcp"))throw new Error("rfc4751 url must be tcp");return d.default.connect(parseInt(t.port),t.hostname)},t.startRFC4571Parser=function(e,t,r,i,s){let d=!0;const h=new l.EventEmitter;h.on("error",(()=>{}));const f=(0,a.parseSdp)(r),g=f.msections.find((e=>"audio"===e.type)),S=f.msections.find((e=>"video"===e.type)),y=g?.payloadTypes?.[0],_=S?.payloadTypes?.[0],v=g?.codec,b=S.codec;let P;const w=new Promise((e=>{P=e})),T=e=>{d&&(h.emit("killed"),h.emit("error",e||new Error("killed"))),d=!1,P(),t.destroy()};t.on("close",(()=>{T(new Error("rfc4751 socket closed"))})),t.on("error",(e=>{T(e)}));const{resetActivityTimer:E}=(0,u.setupActivityTimer)("rtsp",T,h,s?.timeout);let R;const M=S?.fmtp?.[0]?.parameters?.["sprop-parameter-sets"],I=M?.split(",")?.[0];if(I)try{const t=Buffer.from(I,"base64"),r=(0,c.parse)(t);R=(0,p.getSpsResolution)(r),e.log("parsed sdp sps",r)}catch(t){e.warn("sdp sps parsing failed",t)}return{start:()=>{(0,n.read16BELengthLoop)(t,{headerLength:2,skipHeader:void 0,callback:(t,r)=>{let i;const s=127&r[1],n=Buffer.alloc(2);n[0]=o.RTSP_FRAME_MAGIC,s===y?n[1]=0:s===_&&(n[1]=2),t=Buffer.concat([n,t]),s===y?i=v:s===_&&(i=b);const a={chunks:[t,r],type:i};if(!R){const t=(0,o.findH264NaluType)(a,o.H264_NAL_TYPE_SPS);if(t)try{const r=(0,c.parse)(t);R=(0,p.getSpsResolution)(r),e.log(R),e.log("parsed bitstream sps",r)}catch(t){e.warn("sps parsing failed"),R={width:NaN,height:NaN}}}h.emit("rtsp",a),a.type===b&&E()}}).catch((e=>{throw e})).finally((()=>{T(new Error("parser exited"))}))},sdp:Promise.resolve(r),get isActive(){return d},kill(e){T(e)},killed:w,resetActivityTimer:E,negotiateMediaStream:(e,t,s)=>m(r,i,t,s,e),emit(e,t){return h.emit(e,t),this},on(e,t){return h.on(e,t),this},once(e,t){return h.once(e,t),this},removeListener(e,t){return h.removeListener(e,t),this}}};const s=r(445),n=r(460),o=r(336),a=r(890),c=r(353),d=i(r(278)),l=r(203),u=r(502),p=r(51);function m(e,t,r,i,n){const o=(0,a.parseSdp)(e),c=(0,s.cloneDeep)(t)||{id:void 0,name:void 0};if(void 0===c.video&&(c.video={}),null===n?.video&&(c.video=null),c.video&&(c.video.codec=r),n?.audio?.codec&&n?.audio?.codec!==i){if(o.msections.find((e=>"audio"===e.type&&e.codec===n?.audio?.codec)))return c.audio={codec:n?.audio?.codec},c}return c.audio=c?.audio?.codec===i?t?.audio:{codec:i},c}},724:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sleep=void 0;var i=r(610);Object.defineProperty(t,"sleep",{enumerable:!0,get:function(){return i.sleep}})},743:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sdk=t.MixinDeviceBase=t.ScryptedDeviceBase=void 0,s(r(849),t);const o=n(r(896)),a=r(849);r(339);class c extends a.DeviceBase{constructor(e){super(),this.nativeId=e}get storage(){return this._storage||(this._storage=t.sdk.deviceManager.getDeviceStorage(this.nativeId)),this._storage}get log(){return this._log||(this._log=t.sdk.deviceManager.getDeviceLogger(this.nativeId)),this._log}get console(){return this._console||(this._console=t.sdk.deviceManager.getDeviceConsole(this.nativeId)),this._console}async createMediaObject(e,r){return t.sdk.mediaManager.createMediaObject(e,r,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.nativeId)}_lazyLoadDeviceState(){this._deviceState||(this.nativeId?this._deviceState=t.sdk.deviceManager.getDeviceState(this.nativeId):this._deviceState=t.sdk.deviceManager.getDeviceState())}onDeviceEvent(e,r){return t.sdk.deviceManager.onDeviceEvent(this.nativeId,e,r)}}t.ScryptedDeviceBase=c;class d extends a.DeviceBase{constructor(e){super(),this._listeners=new Set,this.mixinDevice=e.mixinDevice,this.mixinDeviceInterfaces=e.mixinDeviceInterfaces,this.mixinStorageSuffix=e.mixinStorageSuffix,this._deviceState=e.mixinDeviceState,this.nativeId=t.sdk.systemManager.getDeviceById(this.id).nativeId,this.mixinProviderNativeId=e.mixinProviderNativeId,this._deviceState.__rpcproxy_traps_all_properties&&"string"==typeof this._deviceState.id&&(this._deviceState=t.sdk.deviceManager.createDeviceState(this._deviceState.id,this._deviceState.setState))}get storage(){if(!this._storage){const e=this.mixinStorageSuffix,r=this.id+(e?":"+e:"");this._storage=t.sdk.deviceManager.getMixinStorage(r,this.mixinProviderNativeId)}return this._storage}get console(){return this._console||(t.sdk.deviceManager.getMixinConsole?this._console=t.sdk.deviceManager.getMixinConsole(this.id,this.mixinProviderNativeId):this._console=t.sdk.deviceManager.getDeviceConsole(this.mixinProviderNativeId)),this._console}async createMediaObject(e,r){return t.sdk.mediaManager.createMediaObject(e,r,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.mixinProviderNativeId)}onDeviceEvent(e,r){return t.sdk.deviceManager.onMixinEvent(this.id,this,e,r)}_lazyLoadDeviceState(){}manageListener(e){this._listeners.add(e)}release(){for(const e of this._listeners)e.removeListener()}}t.MixinDeviceBase=d,function(){function e(e){return function(){return this._lazyLoadDeviceState(),this._deviceState?.[e]}}function t(e){return function(t){this._lazyLoadDeviceState(),this._deviceState?this._deviceState[e]=t:console.warn("device state is unavailable. the device must be discovered with deviceManager.onDeviceDiscovered or deviceManager.onDevicesChanged before the state can be set.")}}for(const r of Object.values(a.ScryptedInterfaceProperty))r!==a.ScryptedInterfaceProperty.nativeId&&(Object.defineProperty(c.prototype,r,{set:t(r),get:e(r)}),Object.defineProperty(d.prototype,r,{set:t(r),get:e(r)}))}(),t.sdk={};try{let e=!1;try{process.env.SCRYPTED_SDK_ES_MODULE||process.env.SCRYPTED_SDK_MODULE;const i=process.env.SCRYPTED_SDK_CJS_MODULE||process.env.SCRYPTED_SDK_MODULE;if(i)if("undefined"!=typeof require){const r=require(process.env.SCRYPTED_SDK_MODULE);Object.assign(t.sdk,r.getScryptedStatic()),e=!0}else{const s=r(394)(i);Object.assign(t.sdk,s.getScryptedStatic()),e=!0}}catch(e){throw console.warn("failed to load sdk module",e),e}if(!e){let e;try{e=pluginRuntimeAPI}catch(e){}Object.assign(t.sdk,{log:deviceManager.getDeviceLogger(void 0),deviceManager,endpointManager,mediaManager,systemManager,pluginHostAPI,...e})}try{let e={...a.ScryptedInterfaceDescriptors};try{const t=JSON.parse(o.default.readFileSync("../sdk.json").toString()).interfaceDescriptors;t&&(e={...e,...t})}catch(e){console.warn("failed to load custom interface descriptors",e)}t.sdk.systemManager.setScryptedInterfaceDescriptors?.(a.TYPES_VERSION,e)?.catch((()=>{}))}catch(e){}}catch(e){console.error("sdk initialization error, import @scrypted/types or use @scrypted/client instead",e)}t.default=t.sdk},756:e=>{"use strict";e.exports=require("tls")},802:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStreamSettings=function(e){const t="Manage",r={defaultStream:{subgroup:t,title:"Local Stream",description:"The media stream to use when streaming on your local network. This stream should be prebuffered. Recommended resolution: 1920x1080 to 4K.",hide:!0,prefersPrebuffer:!1,preferredResolution:8294400},remoteStream:{subgroup:t,title:"Remote (Medium Resolution) Stream",description:"The media stream to use when streaming from outside your local network. Selecting a low birate stream is recommended. Recommended resolution: 1280x720.",hide:!0,prefersPrebuffer:!1,preferredResolution:921600},lowResolutionStream:{subgroup:t,title:"Low Resolution Stream",description:"The media stream to use for low resolution output, such as Apple Watch and Video Analysis. Recommended resolution: 480x360.",hide:!0,prefersPrebuffer:!1,preferredResolution:172800},recordingStream:{subgroup:t,title:"Local Recording Stream",description:"The media stream to use when recording to local storage such as an NVR. Recommended resolution: 1920x1080 to 4K.",hide:!0,prefersPrebuffer:!1,preferredResolution:8294400},remoteRecordingStream:{subgroup:t,title:"Remote Recording Stream",description:"The media stream to use when recording to cloud storage such as HomeKit Secure Video clips in iCloud. This stream should be prebuffered. Recommended resolution: 1280x720.",hide:!0,prefersPrebuffer:!0,preferredResolution:3686400}},n=new i.StorageSettings(e,{hasMjpeg:{subgroup:t,title:"Invalid Codecs",type:"html",defaultValue:'<p style="color: red;">MJPEG streams detected. These streams are incompatible Scrypted and should be reconfigured to H264 using the camera\'s web admin if possible.</p>',hide:!0},noAudio:{subgroup:t,title:"No Audio",description:"Enable this setting if the camera does not have audio or to mute audio.",type:"boolean"},privacyMode:{group:"Privacy",title:"Disable Stream",description:"Disable this camera's stream to all services provided by Scrypted.",type:"boolean"},enabledStreams:{subgroup:t,title:"Prebuffered Streams",description:"Prebuffering maintains an active connection to the stream and improves load times. Prebuffer also retains the recent video for capturing motion events with HomeKit Secure video. Enabling Prebuffer is not recommended on Cloud cameras.",multiple:!0,hide:!1},...r,rebroadcastPort:{subgroup:t,title:"Rebroadcast Port",description:"The port of the RTSP server that will rebroadcast your streams.",type:"number",hide:!1},synthenticStreams:{subgroup:t,title:"Synthetic Streams",description:"Create additional streams by transcoding the existing streams. This can be useful for creating streams with different resolutions or bitrates.",immediate:!0,multiple:!0,combobox:!0,choices:[],defaultValue:[]}});function o(e){if(!e)return;const t=c(n.keys.defaultStream,e),r=c(n.keys.remoteRecordingStream,e);return t?.stream&&"cloud"!==t.stream.source&&"synthetic"!==t.stream.source?t.stream.id===r.stream.id?[t.stream]:[t.stream,r.stream]:[]}function a(e,t){return function(e,t){if(!e)return;let r,i;for(const n of e){if(s(n))continue;const e=Math.abs(n.video?.width*n.video?.height-t);(!r||e<i)&&(r=n,i=e,Number.isNaN(i)&&(i=Number.MAX_SAFE_INTEGER))}return r}(t,e.preferredResolution)}function c(e,t){const i=n.settings[e],s=n.values[e];let o="Default"===s,c=t?.find((e=>e.name===s));return n.values.synthenticStreams.includes(s)?c={id:`synthetic:${s}`}:!o&&c||(o=!0,c=a(i,t)),{title:r[e].title,isDefault:o,stream:c}}function d(e,t){const r=["Default",...t.map((e=>e.name)),...n.values.synthenticStreams],i=a(e,t).name;return{defaultValue:"Default",description:e.description+` The default for this stream is ${i}.`,choices:r,hide:!1}}return n.options={onGet:async()=>{let t;try{const i=await e.mixinDevice.getVideoStreamOptions(),n=i?.find((e=>s(e)))?{hasMjpeg:{hide:!1}}:void 0;return t={defaultValue:o(i)?.map((e=>e.name||e.id)),choices:i.map(((e,t)=>e.name||e.id)),hide:!1},i?.length>1?{enabledStreams:t,defaultStream:d(r.defaultStream,i),remoteStream:d(r.remoteStream,i),lowResolutionStream:d(r.lowResolutionStream,i),recordingStream:d(r.recordingStream,i),remoteRecordingStream:d(r.remoteRecordingStream,i),...n}:{enabledStreams:t,...n}}catch(t){e.console.error("error retrieving getVideoStreamOptions",t)}return{}}},{getDefaultPrebufferedStreams:o,getPrebufferedStreams:function(e){if(!e)return;return n.hasValue.enabledStreams?e.filter((e=>n.values.enabledStreams.includes(e.name))):o(e)},getDefaultStream:e=>c(n.keys.defaultStream,e),getRemoteStream:e=>c(n.keys.remoteStream,e),getLowResolutionStream:e=>c(n.keys.lowResolutionStream,e),getRecordingStream:e=>c(n.keys.recordingStream,e),getRemoteRecordingStream:e=>c(n.keys.remoteRecordingStream,e),storageSettings:n}};const i=r(414);function s(e){const t=e?.video?.codec?.toLowerCase();return t?.includes("jpeg")||t?.includes("jpg")}},849:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScryptedMimeTypes=t.ScryptedInterface=t.MediaPlayerState=t.SecuritySystemObstruction=t.SecuritySystemMode=t.AirQuality=t.AirPurifierMode=t.AirPurifierStatus=t.ChargeState=t.LockState=t.PanTiltZoomMovement=t.ThermostatMode=t.TemperatureUnit=t.FanMode=t.HumidityMode=t.ScryptedDeviceType=t.ScryptedInterfaceDescriptors=t.ScryptedInterfaceMethod=t.ScryptedInterfaceProperty=t.DeviceBase=t.TYPES_VERSION=void 0,t.TYPES_VERSION="0.5.49";var r,i,s,n,o,a,c,d,l,u,p,m,h,f,g,S,y,_;t.DeviceBase=class{},function(e){e.id="id",e.info="info",e.interfaces="interfaces",e.mixins="mixins",e.name="name",e.nativeId="nativeId",e.pluginId="pluginId",e.providedInterfaces="providedInterfaces",e.providedName="providedName",e.providedRoom="providedRoom",e.providedType="providedType",e.providerId="providerId",e.room="room",e.type="type",e.scryptedRuntimeArguments="scryptedRuntimeArguments",e.on="on",e.brightness="brightness",e.colorTemperature="colorTemperature",e.rgb="rgb",e.hsv="hsv",e.buttons="buttons",e.sensors="sensors",e.running="running",e.paused="paused",e.docked="docked",e.temperatureSetting="temperatureSetting",e.temperature="temperature",e.temperatureUnit="temperatureUnit",e.humidity="humidity",e.resolution="resolution",e.audioVolumes="audioVolumes",e.recordingActive="recordingActive",e.ptzCapabilities="ptzCapabilities",e.lockState="lockState",e.entryOpen="entryOpen",e.batteryLevel="batteryLevel",e.chargeState="chargeState",e.online="online",e.fromMimeType="fromMimeType",e.toMimeType="toMimeType",e.converters="converters",e.binaryState="binaryState",e.tampered="tampered",e.sleeping="sleeping",e.powerDetected="powerDetected",e.audioDetected="audioDetected",e.motionDetected="motionDetected",e.ambientLight="ambientLight",e.occupied="occupied",e.flooded="flooded",e.ultraviolet="ultraviolet",e.luminance="luminance",e.position="position",e.securitySystemState="securitySystemState",e.pm10Density="pm10Density",e.pm25Density="pm25Density",e.vocDensity="vocDensity",e.noxDensity="noxDensity",e.co2ppm="co2ppm",e.airQuality="airQuality",e.airPurifierState="airPurifierState",e.filterChangeIndication="filterChangeIndication",e.filterLifeLevel="filterLifeLevel",e.humiditySetting="humiditySetting",e.fan="fan",e.applicationInfo="applicationInfo",e.chatCompletionCapabilities="chatCompletionCapabilities",e.systemDevice="systemDevice"}(r||(t.ScryptedInterfaceProperty=r={})),function(e){e.listen="listen",e.probe="probe",e.setMixins="setMixins",e.setName="setName",e.setRoom="setRoom",e.setType="setType",e.getPluginJson="getPluginJson",e.turnOff="turnOff",e.turnOn="turnOn",e.setBrightness="setBrightness",e.getTemperatureMaxK="getTemperatureMaxK",e.getTemperatureMinK="getTemperatureMinK",e.setColorTemperature="setColorTemperature",e.setRgb="setRgb",e.setHsv="setHsv",e.pressButton="pressButton",e.sendNotification="sendNotification",e.start="start",e.stop="stop",e.pause="pause",e.resume="resume",e.dock="dock",e.setTemperature="setTemperature",e.setTemperatureUnit="setTemperatureUnit",e.getPictureOptions="getPictureOptions",e.takePicture="takePicture",e.getAudioStream="getAudioStream",e.setAudioVolumes="setAudioVolumes",e.startDisplay="startDisplay",e.stopDisplay="stopDisplay",e.getVideoStream="getVideoStream",e.getVideoStreamOptions="getVideoStreamOptions",e.getPrivacyMasks="getPrivacyMasks",e.setPrivacyMasks="setPrivacyMasks",e.getVideoTextOverlays="getVideoTextOverlays",e.setVideoTextOverlay="setVideoTextOverlay",e.getRecordingStream="getRecordingStream",e.getRecordingStreamCurrentTime="getRecordingStreamCurrentTime",e.getRecordingStreamOptions="getRecordingStreamOptions",e.getRecordingStreamThumbnail="getRecordingStreamThumbnail",e.deleteRecordingStream="deleteRecordingStream",e.setRecordingActive="setRecordingActive",e.ptzCommand="ptzCommand",e.getRecordedEvents="getRecordedEvents",e.getVideoClip="getVideoClip",e.getVideoClips="getVideoClips",e.getVideoClipThumbnail="getVideoClipThumbnail",e.removeVideoClips="removeVideoClips",e.setVideoStreamOptions="setVideoStreamOptions",e.startIntercom="startIntercom",e.stopIntercom="stopIntercom",e.lock="lock",e.unlock="unlock",e.addPassword="addPassword",e.getPasswords="getPasswords",e.removePassword="removePassword",e.activate="activate",e.deactivate="deactivate",e.isReversible="isReversible",e.closeEntry="closeEntry",e.openEntry="openEntry",e.getDevice="getDevice",e.releaseDevice="releaseDevice",e.adoptDevice="adoptDevice",e.discoverDevices="discoverDevices",e.createDevice="createDevice",e.getCreateDeviceSettings="getCreateDeviceSettings",e.reboot="reboot",e.getRefreshFrequency="getRefreshFrequency",e.refresh="refresh",e.getMediaStatus="getMediaStatus",e.load="load",e.seek="seek",e.skipNext="skipNext",e.skipPrevious="skipPrevious",e.convert="convert",e.convertMedia="convertMedia",e.getSettings="getSettings",e.putSetting="putSetting",e.armSecuritySystem="armSecuritySystem",e.disarmSecuritySystem="disarmSecuritySystem",e.setAirPurifierState="setAirPurifierState",e.getReadmeMarkdown="getReadmeMarkdown",e.getOauthUrl="getOauthUrl",e.onOauthCallback="onOauthCallback",e.canMixin="canMixin",e.getMixin="getMixin",e.releaseMixin="releaseMixin",e.onRequest="onRequest",e.onConnection="onConnection",e.onPush="onPush",e.run="run",e.eval="eval",e.loadScripts="loadScripts",e.saveScript="saveScript",e.forkInterface="forkInterface",e.getDetectionInput="getDetectionInput",e.getObjectTypes="getObjectTypes",e.detectObjects="detectObjects",e.generateObjectDetections="generateObjectDetections",e.getDetectionModel="getDetectionModel",e.setHumidity="setHumidity",e.setFan="setFan",e.startRTCSignalingSession="startRTCSignalingSession",e.createRTCSignalingSession="createRTCSignalingSession",e.getScryptedUserAccessControl="getScryptedUserAccessControl",e.generateVideoFrames="generateVideoFrames",e.connectStream="connectStream",e.getTTYSettings="getTTYSettings",e.getChatCompletion="getChatCompletion",e.streamChatCompletion="streamChatCompletion",e.getTextEmbedding="getTextEmbedding",e.getImageEmbedding="getImageEmbedding",e.callLLMTool="callLLMTool",e.getLLMTools="getLLMTools"}(i||(t.ScryptedInterfaceMethod=i={})),t.ScryptedInterfaceDescriptors={ScryptedDevice:{name:"ScryptedDevice",methods:["listen","probe","setMixins","setName","setRoom","setType"],properties:["id","info","interfaces","mixins","name","nativeId","pluginId","providedInterfaces","providedName","providedRoom","providedType","providerId","room","type"]},ScryptedPlugin:{name:"ScryptedPlugin",methods:["getPluginJson"],properties:[]},ScryptedPluginRuntime:{name:"ScryptedPluginRuntime",methods:[],properties:["scryptedRuntimeArguments"]},OnOff:{name:"OnOff",methods:["turnOff","turnOn"],properties:["on"]},Brightness:{name:"Brightness",methods:["setBrightness"],properties:["brightness"]},ColorSettingTemperature:{name:"ColorSettingTemperature",methods:["getTemperatureMaxK","getTemperatureMinK","setColorTemperature"],properties:["colorTemperature"]},ColorSettingRgb:{name:"ColorSettingRgb",methods:["setRgb"],properties:["rgb"]},ColorSettingHsv:{name:"ColorSettingHsv",methods:["setHsv"],properties:["hsv"]},Buttons:{name:"Buttons",methods:[],properties:["buttons"]},PressButtons:{name:"PressButtons",methods:["pressButton"],properties:[]},Sensors:{name:"Sensors",methods:[],properties:["sensors"]},Notifier:{name:"Notifier",methods:["sendNotification"],properties:[]},StartStop:{name:"StartStop",methods:["start","stop"],properties:["running"]},Pause:{name:"Pause",methods:["pause","resume"],properties:["paused"]},Dock:{name:"Dock",methods:["dock"],properties:["docked"]},TemperatureSetting:{name:"TemperatureSetting",methods:["setTemperature"],properties:["temperatureSetting"]},Thermometer:{name:"Thermometer",methods:["setTemperatureUnit"],properties:["temperature","temperatureUnit"]},HumiditySensor:{name:"HumiditySensor",methods:[],properties:["humidity"]},Camera:{name:"Camera",methods:["getPictureOptions","takePicture"],properties:[]},Resolution:{name:"Resolution",methods:[],properties:["resolution"]},Microphone:{name:"Microphone",methods:["getAudioStream"],properties:[]},AudioVolumeControl:{name:"AudioVolumeControl",methods:["setAudioVolumes"],properties:["audioVolumes"]},Display:{name:"Display",methods:["startDisplay","stopDisplay"],properties:[]},VideoCamera:{name:"VideoCamera",methods:["getVideoStream","getVideoStreamOptions"],properties:[]},VideoCameraMask:{name:"VideoCameraMask",methods:["getPrivacyMasks","setPrivacyMasks"],properties:[]},VideoTextOverlays:{name:"VideoTextOverlays",methods:["getVideoTextOverlays","setVideoTextOverlay"],properties:[]},VideoRecorder:{name:"VideoRecorder",methods:["getRecordingStream","getRecordingStreamCurrentTime","getRecordingStreamOptions","getRecordingStreamThumbnail"],properties:["recordingActive"]},VideoRecorderManagement:{name:"VideoRecorderManagement",methods:["deleteRecordingStream","setRecordingActive"],properties:[]},PanTiltZoom:{name:"PanTiltZoom",methods:["ptzCommand"],properties:["ptzCapabilities"]},EventRecorder:{name:"EventRecorder",methods:["getRecordedEvents"],properties:[]},VideoClips:{name:"VideoClips",methods:["getVideoClip","getVideoClips","getVideoClipThumbnail","removeVideoClips"],properties:[]},VideoCameraConfiguration:{name:"VideoCameraConfiguration",methods:["setVideoStreamOptions"],properties:[]},Intercom:{name:"Intercom",methods:["startIntercom","stopIntercom"],properties:[]},Lock:{name:"Lock",methods:["lock","unlock"],properties:["lockState"]},PasswordStore:{name:"PasswordStore",methods:["addPassword","getPasswords","removePassword"],properties:[]},Scene:{name:"Scene",methods:["activate","deactivate","isReversible"],properties:[]},Entry:{name:"Entry",methods:["closeEntry","openEntry"],properties:[]},EntrySensor:{name:"EntrySensor",methods:[],properties:["entryOpen"]},DeviceProvider:{name:"DeviceProvider",methods:["getDevice","releaseDevice"],properties:[]},DeviceDiscovery:{name:"DeviceDiscovery",methods:["adoptDevice","discoverDevices"],properties:[]},DeviceCreator:{name:"DeviceCreator",methods:["createDevice","getCreateDeviceSettings"],properties:[]},Battery:{name:"Battery",methods:[],properties:["batteryLevel"]},Charger:{name:"Charger",methods:[],properties:["chargeState"]},Reboot:{name:"Reboot",methods:["reboot"],properties:[]},Refresh:{name:"Refresh",methods:["getRefreshFrequency","refresh"],properties:[]},MediaPlayer:{name:"MediaPlayer",methods:["getMediaStatus","load","seek","skipNext","skipPrevious"],properties:[]},Online:{name:"Online",methods:[],properties:["online"]},BufferConverter:{name:"BufferConverter",methods:["convert"],properties:["fromMimeType","toMimeType"]},MediaConverter:{name:"MediaConverter",methods:["convertMedia"],properties:["converters"]},Settings:{name:"Settings",methods:["getSettings","putSetting"],properties:[]},BinarySensor:{name:"BinarySensor",methods:[],properties:["binaryState"]},TamperSensor:{name:"TamperSensor",methods:[],properties:["tampered"]},Sleep:{name:"Sleep",methods:[],properties:["sleeping"]},PowerSensor:{name:"PowerSensor",methods:[],properties:["powerDetected"]},AudioSensor:{name:"AudioSensor",methods:[],properties:["audioDetected"]},MotionSensor:{name:"MotionSensor",methods:[],properties:["motionDetected"]},AmbientLightSensor:{name:"AmbientLightSensor",methods:[],properties:["ambientLight"]},OccupancySensor:{name:"OccupancySensor",methods:[],properties:["occupied"]},FloodSensor:{name:"FloodSensor",methods:[],properties:["flooded"]},UltravioletSensor:{name:"UltravioletSensor",methods:[],properties:["ultraviolet"]},LuminanceSensor:{name:"LuminanceSensor",methods:[],properties:["luminance"]},PositionSensor:{name:"PositionSensor",methods:[],properties:["position"]},SecuritySystem:{name:"SecuritySystem",methods:["armSecuritySystem","disarmSecuritySystem"],properties:["securitySystemState"]},PM10Sensor:{name:"PM10Sensor",methods:[],properties:["pm10Density"]},PM25Sensor:{name:"PM25Sensor",methods:[],properties:["pm25Density"]},VOCSensor:{name:"VOCSensor",methods:[],properties:["vocDensity"]},NOXSensor:{name:"NOXSensor",methods:[],properties:["noxDensity"]},CO2Sensor:{name:"CO2Sensor",methods:[],properties:["co2ppm"]},AirQualitySensor:{name:"AirQualitySensor",methods:[],properties:["airQuality"]},AirPurifier:{name:"AirPurifier",methods:["setAirPurifierState"],properties:["airPurifierState"]},FilterMaintenance:{name:"FilterMaintenance",methods:[],properties:["filterChangeIndication","filterLifeLevel"]},Readme:{name:"Readme",methods:["getReadmeMarkdown"],properties:[]},OauthClient:{name:"OauthClient",methods:["getOauthUrl","onOauthCallback"],properties:[]},MixinProvider:{name:"MixinProvider",methods:["canMixin","getMixin","releaseMixin"],properties:[]},HttpRequestHandler:{name:"HttpRequestHandler",methods:["onRequest"],properties:[]},EngineIOHandler:{name:"EngineIOHandler",methods:["onConnection"],properties:[]},PushHandler:{name:"PushHandler",methods:["onPush"],properties:[]},Program:{name:"Program",methods:["run"],properties:[]},Scriptable:{name:"Scriptable",methods:["eval","loadScripts","saveScript"],properties:[]},ClusterForkInterface:{name:"ClusterForkInterface",methods:["forkInterface"],properties:[]},ObjectDetector:{name:"ObjectDetector",methods:["getDetectionInput","getObjectTypes"],properties:[]},ObjectDetection:{name:"ObjectDetection",methods:["detectObjects","generateObjectDetections","getDetectionModel"],properties:[]},ObjectDetectionPreview:{name:"ObjectDetectionPreview",methods:[],properties:[]},ObjectDetectionGenerator:{name:"ObjectDetectionGenerator",methods:[],properties:[]},HumiditySetting:{name:"HumiditySetting",methods:["setHumidity"],properties:["humiditySetting"]},Fan:{name:"Fan",methods:["setFan"],properties:["fan"]},RTCSignalingChannel:{name:"RTCSignalingChannel",methods:["startRTCSignalingSession"],properties:[]},RTCSignalingClient:{name:"RTCSignalingClient",methods:["createRTCSignalingSession"],properties:[]},LauncherApplication:{name:"LauncherApplication",methods:[],properties:["applicationInfo"]},ScryptedUser:{name:"ScryptedUser",methods:["getScryptedUserAccessControl"],properties:[]},VideoFrameGenerator:{name:"VideoFrameGenerator",methods:["generateVideoFrames"],properties:[]},StreamService:{name:"StreamService",methods:["connectStream"],properties:[]},TTY:{name:"TTY",methods:[],properties:[]},TTYSettings:{name:"TTYSettings",methods:["getTTYSettings"],properties:[]},ChatCompletion:{name:"ChatCompletion",methods:["getChatCompletion","streamChatCompletion"],properties:["chatCompletionCapabilities"]},TextEmbedding:{name:"TextEmbedding",methods:["getTextEmbedding"],properties:[]},ImageEmbedding:{name:"ImageEmbedding",methods:["getImageEmbedding"],properties:[]},LLMTools:{name:"LLMTools",methods:["callLLMTool","getLLMTools"],properties:[]},ScryptedSystemDevice:{name:"ScryptedSystemDevice",methods:[],properties:["systemDevice"]},ScryptedDeviceCreator:{name:"ScryptedDeviceCreator",methods:[],properties:[]},ScryptedSettings:{name:"ScryptedSettings",methods:[],properties:[]}},function(e){e.Builtin="Builtin",e.Internal="Internal",e.Camera="Camera",e.Fan="Fan",e.Light="Light",e.Switch="Switch",e.Outlet="Outlet",e.Sensor="Sensor",e.Scene="Scene",e.Program="Program",e.Automation="Automation",e.Vacuum="Vacuum",e.Notifier="Notifier",e.Thermostat="Thermostat",e.Lock="Lock",e.PasswordControl="PasswordControl",e.Display="Display",e.SmartDisplay="SmartDisplay",e.Speaker="Speaker",e.SmartSpeaker="SmartSpeaker",e.RemoteDesktop="RemoteDesktop",e.Event="Event",e.Entry="Entry",e.Garage="Garage",e.DeviceProvider="DeviceProvider",e.DataSource="DataSource",e.API="API",e.Buttons="Buttons",e.Doorbell="Doorbell",e.Irrigation="Irrigation",e.Valve="Valve",e.Person="Person",e.SecuritySystem="SecuritySystem",e.WindowCovering="WindowCovering",e.Siren="Siren",e.AirPurifier="AirPurifier",e.Internet="Internet",e.Network="Network",e.Bridge="Bridge",e.LLM="LLM",e.Unknown="Unknown"}(s||(t.ScryptedDeviceType=s={})),function(e){e.Humidify="Humidify",e.Dehumidify="Dehumidify",e.Auto="Auto",e.Off="Off"}(n||(t.HumidityMode=n={})),function(e){e.Auto="Auto",e.Manual="Manual"}(o||(t.FanMode=o={})),function(e){e.C="C",e.F="F"}(a||(t.TemperatureUnit=a={})),function(e){e.Off="Off",e.Cool="Cool",e.Heat="Heat",e.HeatCool="HeatCool",e.Auto="Auto",e.FanOnly="FanOnly",e.Purifier="Purifier",e.Eco="Eco",e.Dry="Dry",e.On="On"}(c||(t.ThermostatMode=c={})),function(e){e.Absolute="Absolute",e.Relative="Relative",e.Continuous="Continuous",e.Preset="Preset",e.Home="Home"}(d||(t.PanTiltZoomMovement=d={})),function(e){e.Locked="Locked",e.Unlocked="Unlocked",e.Jammed="Jammed"}(l||(t.LockState=l={})),function(e){e.Trickle="trickle",e.Charging="charging",e.NotCharging="not-charging"}(u||(t.ChargeState=u={})),function(e){e.Inactive="Inactive",e.Idle="Idle",e.Active="Active",e.ActiveNightMode="ActiveNightMode"}(p||(t.AirPurifierStatus=p={})),function(e){e.Manual="Manual",e.Automatic="Automatic"}(m||(t.AirPurifierMode=m={})),function(e){e.Unknown="Unknown",e.Excellent="Excellent",e.Good="Good",e.Fair="Fair",e.Inferior="Inferior",e.Poor="Poor"}(h||(t.AirQuality=h={})),function(e){e.Disarmed="Disarmed",e.HomeArmed="HomeArmed",e.AwayArmed="AwayArmed",e.NightArmed="NightArmed"}(f||(t.SecuritySystemMode=f={})),function(e){e.Sensor="Sensor",e.Occupied="Occupied",e.Time="Time",e.Error="Error"}(g||(t.SecuritySystemObstruction=g={})),function(e){e.Idle="Idle",e.Playing="Playing",e.Paused="Paused",e.Buffering="Buffering"}(S||(t.MediaPlayerState=S={})),function(e){e.ScryptedDevice="ScryptedDevice",e.ScryptedPlugin="ScryptedPlugin",e.ScryptedPluginRuntime="ScryptedPluginRuntime",e.OnOff="OnOff",e.Brightness="Brightness",e.ColorSettingTemperature="ColorSettingTemperature",e.ColorSettingRgb="ColorSettingRgb",e.ColorSettingHsv="ColorSettingHsv",e.Buttons="Buttons",e.PressButtons="PressButtons",e.Sensors="Sensors",e.Notifier="Notifier",e.StartStop="StartStop",e.Pause="Pause",e.Dock="Dock",e.TemperatureSetting="TemperatureSetting",e.Thermometer="Thermometer",e.HumiditySensor="HumiditySensor",e.Camera="Camera",e.Resolution="Resolution",e.Microphone="Microphone",e.AudioVolumeControl="AudioVolumeControl",e.Display="Display",e.VideoCamera="VideoCamera",e.VideoCameraMask="VideoCameraMask",e.VideoTextOverlays="VideoTextOverlays",e.VideoRecorder="VideoRecorder",e.VideoRecorderManagement="VideoRecorderManagement",e.PanTiltZoom="PanTiltZoom",e.EventRecorder="EventRecorder",e.VideoClips="VideoClips",e.VideoCameraConfiguration="VideoCameraConfiguration",e.Intercom="Intercom",e.Lock="Lock",e.PasswordStore="PasswordStore",e.Scene="Scene",e.Entry="Entry",e.EntrySensor="EntrySensor",e.DeviceProvider="DeviceProvider",e.DeviceDiscovery="DeviceDiscovery",e.DeviceCreator="DeviceCreator",e.Battery="Battery",e.Charger="Charger",e.Reboot="Reboot",e.Refresh="Refresh",e.MediaPlayer="MediaPlayer",e.Online="Online",e.BufferConverter="BufferConverter",e.MediaConverter="MediaConverter",e.Settings="Settings",e.BinarySensor="BinarySensor",e.TamperSensor="TamperSensor",e.Sleep="Sleep",e.PowerSensor="PowerSensor",e.AudioSensor="AudioSensor",e.MotionSensor="MotionSensor",e.AmbientLightSensor="AmbientLightSensor",e.OccupancySensor="OccupancySensor",e.FloodSensor="FloodSensor",e.UltravioletSensor="UltravioletSensor",e.LuminanceSensor="LuminanceSensor",e.PositionSensor="PositionSensor",e.SecuritySystem="SecuritySystem",e.PM10Sensor="PM10Sensor",e.PM25Sensor="PM25Sensor",e.VOCSensor="VOCSensor",e.NOXSensor="NOXSensor",e.CO2Sensor="CO2Sensor",e.AirQualitySensor="AirQualitySensor",e.AirPurifier="AirPurifier",e.FilterMaintenance="FilterMaintenance",e.Readme="Readme",e.OauthClient="OauthClient",e.MixinProvider="MixinProvider",e.HttpRequestHandler="HttpRequestHandler",e.EngineIOHandler="EngineIOHandler",e.PushHandler="PushHandler",e.Program="Program",e.Scriptable="Scriptable",e.ClusterForkInterface="ClusterForkInterface",e.ObjectDetector="ObjectDetector",e.ObjectDetection="ObjectDetection",e.ObjectDetectionPreview="ObjectDetectionPreview",e.ObjectDetectionGenerator="ObjectDetectionGenerator",e.HumiditySetting="HumiditySetting",e.Fan="Fan",e.RTCSignalingChannel="RTCSignalingChannel",e.RTCSignalingClient="RTCSignalingClient",e.LauncherApplication="LauncherApplication",e.ScryptedUser="ScryptedUser",e.VideoFrameGenerator="VideoFrameGenerator",e.StreamService="StreamService",e.TTY="TTY",e.TTYSettings="TTYSettings",e.ChatCompletion="ChatCompletion",e.TextEmbedding="TextEmbedding",e.ImageEmbedding="ImageEmbedding",e.LLMTools="LLMTools",e.ScryptedSystemDevice="ScryptedSystemDevice",e.ScryptedDeviceCreator="ScryptedDeviceCreator",e.ScryptedSettings="ScryptedSettings"}(y||(t.ScryptedInterface=y={})),function(e){e.Url="text/x-uri",e.InsecureLocalUrl="text/x-insecure-local-uri",e.LocalUrl="text/x-local-uri",e.ServerId="text/x-server-id",e.PushEndpoint="text/x-push-endpoint",e.SchemePrefix="x-scrypted/x-scrypted-scheme-",e.MediaStreamUrl="text/x-media-url",e.MediaObject="x-scrypted/x-scrypted-media-object",e.RequestMediaObject="x-scrypted/x-scrypted-request-media-object",e.RequestMediaStream="x-scrypted/x-scrypted-request-stream",e.MediaStreamFeedback="x-scrypted/x-media-stream-feedback",e.FFmpegInput="x-scrypted/x-ffmpeg-input",e.FFmpegTranscodeStream="x-scrypted/x-ffmpeg-transcode-stream",e.RTCSignalingChannel="x-scrypted/x-scrypted-rtc-signaling-channel",e.RTCSignalingSession="x-scrypted/x-scrypted-rtc-signaling-session",e.RTCConnectionManagement="x-scrypted/x-scrypted-rtc-connection-management",e.Image="x-scrypted/x-scrypted-image"}(_||(t.ScryptedMimeTypes=_={}))},854:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsMixinDeviceBase=void 0;const s=r(743),n=i(r(743)),{deviceManager:o}=n.default;class a extends s.MixinDeviceBase{constructor(e){super(e),this.settingsGroup=e.group,this.settingsGroupKey=e.groupKey,process.nextTick((()=>o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)))}async getSettings(){const e=this.mixinDeviceInterfaces.includes(s.ScryptedInterface.Settings)?this.mixinDevice.getSettings():void 0,t=this.getMixinSettings(),r=[];try{const t=await e||[];r.push(...t)}catch(e){const t=this.name,i=`${t} Extension settings failed to load.`;this.console.error(i,e),r.push({key:Math.random().toString(),title:t,value:"Settings Error",group:"Errors",description:i,readonly:!0})}try{const e=await t||[];for(const t of e)t.group=t.group||this.settingsGroup,t.key=this.settingsGroupKey+":"+t.key;r.push(...e)}catch(e){const t=o.getDeviceState(this.mixinProviderNativeId).name,i=`${t} Extension settings failed to load.`;this.console.error(i,e),r.push({key:Math.random().toString(),title:t,value:"Settings Error",group:"Errors",description:i,readonly:!0})}return r}async putSetting(e,t){const r=this.settingsGroupKey+":";if(!e?.startsWith(r))return this.mixinDevice.putSetting(e,t);await this.putMixinSetting(e.substring(r.length),t)||o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)}async release(){await o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)}}t.SettingsMixinDeviceBase=a},889:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AutoenableMixinProvider=void 0;const s=r(743),n=i(r(743)),{systemManager:o}=n.default;class a extends s.ScryptedDeviceBase{constructor(e,t="v4"){super(e),this.autoIncludeToken=t,this.hasEnabledMixin={};try{this.hasEnabledMixin=JSON.parse(this.storage.getItem("hasEnabledMixin"))}catch(e){this.hasEnabledMixin={}}this.pluginsComponent=o.getComponent("plugins"),o.listen((async(e,t,r)=>{t.eventInterface!==s.ScryptedInterface.ScryptedDevice||t.property||this.maybeEnableMixin(e)})),process.nextTick((()=>{for(const e of Object.keys(o.getSystemState())){const t=o.getDeviceById(e);this.maybeEnableMixin(t)}}))}async shouldEnableMixin(e){return!0}checkHasEnabledMixin(e){return this.hasEnabledMixin[e.id]===this.autoIncludeToken}shouldUnshiftMixin(e){return!1}async maybeEnableMixin(e){if(!e||e.mixins?.includes(this.id))return;if(this.checkHasEnabledMixin(e))return;if(!await this.canMixin(e.type,e.interfaces))return;if(!await this.shouldEnableMixin(e))return;this.log.i("auto enabling mixin for "+e.name);const t=(e.mixins||[]).slice();this.shouldUnshiftMixin(e)?t.unshift(this.id):t.push(this.id);const r=await this.pluginsComponent;await r.setMixins(e.id,t),this.setHasEnabledMixin(e.id)}setHasEnabledMixin(e){this.hasEnabledMixin[e]!==this.autoIncludeToken&&(this.hasEnabledMixin[e]=this.autoIncludeToken,this.storage.setItem("hasEnabledMixin",JSON.stringify(this.hasEnabledMixin)))}}t.AutoenableMixinProvider=a},890:(e,t)=>{"use strict";function r(e){let t=e.split("\n").map((e=>e.trim()));t=t.filter((e=>!e.includes("a=control:")));let r=0;for(let e=0;e<t.length;e++){t[e].startsWith("m=")&&(t.splice(e+1,0,"a=control:trackID="+r),r++)}return t.join("\r\n")}function i(e,t,r=["recvonly","sendrecv"]){const i=function(e){return("\n"+e).split("\nm=")}(e).filter((e=>e.startsWith(t)));for(const e of i){const t=()=>{const t=e.split("\n").map((e=>e.trim())),r="a=control:",i=t.find((e=>e.startsWith(r)));return{section:"m="+e,trackId:i.substring(10)}};for(const i of r)if(e.includes(`a=${i}`))return t();if(r.includes("recvonly")&&!e.includes("sendonly")&&!e.includes("inactive"))return t()}}function s(e){const t=[];for(const r of e.split(" ").slice(3)||[])t.push(parseInt(r));return t}function n(e){const t=e.split(" ");return{type:t[0].substring(2),port:parseInt(t[1]),protocol:t[2],payloadTypes:s(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.replacePorts=function(e,t,r){return e.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(/m=audio \d+/,`m=audio ${t}`).replace(/m=video \d+/,`m=video ${r}`)},t.replaceSectionPort=function(e,t,r){const i=new RegExp(`m=${t} \\d+`);return e.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(i,`m=${t} ${r}`)},t.addTrackControls=r,t.createSdpInput=function(e,t,i){let s=i.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(/m=audio \d+/,`m=audio ${e}`).replace(/m=video \d+/,`m=video ${t}`),n=s.split("\n").map((e=>e.trim()));return n=n.filter((e=>!e.includes("a=rtcp-mux"))).filter((e=>!e.includes("a=candidate"))).filter((e=>!e.includes("a=ice"))),s=n.join("\r\n"),s=r(s),s=s.split("m=").slice(1).map((e=>"m="+e)).join(""),s},t.findFmtp=function(e,t){let r=e.split("\n").map((e=>e.trim()));const i=new RegExp(`a=rtpmap:(\\d+) ${t}`);return r.map((e=>e.match(i))).filter((e=>!!e)).map((e=>{const t=parseInt(e[1]),i=`a=fmtp:${t} `,s=r.find((e=>e.startsWith(i)))?.substring(i.length);return{payloadType:t,fmtp:s}}))},t.findTrackByType=i,t.findTracksByType=function(e,t=["recvonly","sendrecv"]){return{audio:i(e,"audio",t)?.trackId,video:i(e,"video",t)?.trackId}},t.parseMLinePayloadTypes=s,t.parseMLine=n,t.parseFmtp=a,t.parseRtpMap=c,t.parseMSection=u,t.parseSdp=function(e){const t=e.split("\n").map((e=>e.trim())),r=[],i=[];let s;for(const e of t)e.startsWith("m=")&&(s&&i.push(s),s=[]),s?s.push(e):r.push(e);s&&i.push(s);const n={header:{lines:r,contents:r.join("\r\n")},msections:i.map(u),toSdp:()=>[...n.header.lines,...n.msections.map((e=>e.lines)).flat()].join("\r\n")};return n},t.getSpsPps=function(e){const t=e?.fmtp?.[0]?.parameters?.["sprop-parameter-sets"]?.split(",");if(2!==t?.length)return{sps:void 0,pps:void 0};const[r,i]=t;return{sps:Buffer.from(r,"base64"),pps:Buffer.from(i,"base64")}},t.getSpsPpsVps=function(e){const t=e?.fmtp?.[0]?.parameters;if(!t)return{sps:void 0,pps:void 0,vps:void 0};const r=t["sprop-sps"],i=t["sprop-pps"],s=t["sprop-vps"];return{sps:r?Buffer.from(r,"base64"):void 0,pps:i?Buffer.from(i,"base64"):void 0,vps:s?Buffer.from(s,"base64"):void 0}};const o="a=fmtp";function a(e){return e.filter((e=>e.startsWith(o))).map((e=>{const t=e.indexOf(" ");if(-1===t)return;const r=e.substring(0,t),i=e.substring(t+1),s=parseInt(r.split(":")[1]);if(!r||!i||Number.isNaN(s))return;const n={};return i.split(";").map((e=>e.trim())).forEach((e=>{const[t,...r]=e.split("=");n[t]=r.join("=")})),{payloadType:s,parameters:n}})).filter((e=>!!e))}function c(e,t){const r=e.type,i=t?.match(/a=rtpmap:([\d]+) (.*?)\/([\d]+)(\/([\d]+))?/);let s,n,o=parseInt(i?.[5])||void 0,a=parseInt(i?.[1]);t=t?.toLowerCase(),t?.includes("mpeg4")?(s="aac",n="aac"):t?.includes("opus")?(s="opus",n="libopus"):t?.includes("pcma")?(s="pcm_alaw",n="pcm_alaw"):t?.includes("pcmu")?(s="pcm_mulaw",n="pcm_mulaw"):t?.includes("g726")?s="g726":t?.includes("pcm")?s="pcm":t?.includes("l16")?(s="pcm_s16be",n="pcm_s16be"):t?.includes("speex")?(s="speex",n="libspeex"):t?.includes("h264")?s="h264":t?.includes("h265")?s="h265":t||"audio"!==r||(e.payloadTypes?.includes(0)?(s="pcm_mulaw",n="pcm_mulaw",a=0,o=1):e.payloadTypes?.includes(8)?(s="pcm_alaw",n="pcm_alaw",a=8,o=1):e.payloadTypes?.includes(14)?(s="mp3",n="mp3",a=14,o=2):(s="pcm_alaw",n="pcm_alaw",a=8,o=1));let c=parseInt(i?.[3]);return c||(c=void 0,"pcm_mulaw"===s||"pcm_alaw"===s?c=8e3:"pcm_s16be"===s&&(c=16e3)),{line:t,codec:s,ffmpegEncoder:n,rawCodec:i?.[2],clock:c,channels:o,payloadType:a}}const d="a=control:",l="a=rtpmap:";function u(e){const t=e.find((e=>e.startsWith(d)))?.substring(d.length),r=n(e[0]),i=e.filter((e=>e.startsWith(l))),s=i.map((e=>c(r,e))),o=c(r,i[0]),{codec:u}=o;let p;for(const t of["sendonly","sendrecv","recvonly","inactive"]){if(e.find((e=>e==="a="+t))){p=t;break}}const m={...r,fmtp:a(e),lines:e,rtpmaps:s,contents:e.join("\r\n"),control:t,codec:u,rtpmap:o,direction:p,toSdp:()=>m.lines.join("\r\n")};return m}},896:e=>{"use strict";e.exports=require("fs")},926:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileRtspServer=void 0;const s=r(290),n=r(336),o=i(r(896)),a=i(r(928)),c=1048576;class d extends n.RtspServer{constructor(e,t,r){super(e,t,void 0,r),this.segmentBytesWritten=0,this.client.on("close",(()=>{this.writeStream&&this.writeConsole?.log("RTSP WRITE client closed."),this.cleanup()})),this.availableOptions.push("WRITE","WRITESIZE")}cleanup(){const e=this.writeStream;e&&(this.writeStream=void 0,e?.end((()=>e?.destroy())))}async write(e,t){const r=t["x-scrypted-rtsp-file"];if(!r)return this.respond(400,"Bad Request",t,{});await o.default.promises.mkdir(a.default.dirname(r),{recursive:!0});const i=t["x-scrypted-rtsp-file-truncate"];let n;if(i)try{const e=new s.Deferred;o.default.open(i,"w",((t,r)=>{t?e.reject(t):e.resolve(r)}));const t=await e.promise;try{await o.default.promises.rename(i,r),n=o.default.createWriteStream(void 0,{fd:t,highWaterMark:c})}catch(e){throw e}}catch(e){this.writeConsole?.error("RTSP WRITE error during truncate file",i,e)}this.cleanup(),this.segmentBytesWritten=0,this.writeStream=n||o.default.createWriteStream(r,{highWaterMark:c}),this.writeStream.on("error",(e=>{this.writeConsole?.error("RTSP WRITE error",e)})),this.respond(200,"OK",t,{})}writesize(e,t){this.respond(200,"OK",t,{"x-scrypted-rtsp-file-size":this.segmentBytesWritten.toString()})}writeRtpPayload(e,t){return this.writeStream?(this.segmentBytesWritten+=e.length+t.length,this.writeStream.writableLength>104857600?(this.writeConsole?.error("RTSP WRITE overflowed."),this.cleanup(),void this.client?.destroy()):(this.writeStream.write(e),this.writeStream.write(t))):super.writeRtpPayload(e,t)}}t.FileRtspServer=d},928:e=>{"use strict";e.exports=require("path")},932:e=>{"use strict";e.exports=require("process")},982:e=>{"use strict";e.exports=require("crypto")},989:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.safeKillFFmpeg=async function(e){if(!e)return;if(null!=e.exitCode)return;await new Promise((async t=>{e.on("exit",t);try{e.stdin.on("error",(()=>{})),e.stdin.write("q\n")}catch(e){}await(0,n.sleep)(2e3);for(const t of e.stdio)try{t?.destroy()}catch(e){}e.kill(),await(0,n.sleep)(2e3),e.kill("SIGKILL")}))},t.ffmpegLogInitialOutput=function(e,t,r,i){if(!e)return;const n=!!s.default.env.SCRYPTED_FFMPEG_NOISY||!!i?.getItem("SCRYPTED_FFMPEG_NOISY");function a(e){const i=s=>{const a=s.toString();for(const e of o)if(-1!==a.indexOf(e))return;if(!(n||r||-1===a.indexOf("frame=")&&-1===a.indexOf("size=")))return e(a),e("video/audio detected, discarding further input"),t.stdout.removeListener("data",i),void t.stderr.removeListener("data",i);e(a)};return i}t.stdout?.on("data",a(e.log)),t.stderr?.on("data",a(e.error)),t.on("exit",(()=>e.log("ffmpeg exited")))},t.safePrintFFmpegArguments=function(e,t){if(!e)return;const r=[];let i=!1;for(const e of t){try{if(i){const t=new URL(e);r.push(`${t.protocol}[REDACTED]`)}else r.push(e)}catch(t){r.push(e)}i="-i"===e}e.log(r.join(" "))};const s=i(r(932)),n=r(610),o=["decode_slice_header error","no frame!","non-existing PPS"]}},t={};function r(i){var s=t[i];if(void 0!==s)return s.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i=r(431),s=exports="undefined"==typeof exports?{}:exports;for(var n in i)s[n]=i[n];i.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();
//# sourceMappingURL=main.nodejs.js.map