<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Firebase Auth Guard -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) window.location.href = 'login.html';
            });
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St Mary Somerset | Site Tasks</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'portland': 'var(--color-text)',
                        'midnight': 'var(--color-bg)',
                        'bronze': '#9A8C74',
                        'bronze-dark': '#5c5240',
                        'alert': '#ef4444',
                        'warning': '#f59e0b',
                        'success': '#10b981',
                        'surface': 'var(--color-surface)',
                        'surface-light': 'var(--color-surface-light)',
                        'subtle': 'var(--color-border)'
                    },
                    fontFamily: {
                        'serif': ['Cinzel', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    backgroundImage: {
                        'blueprint': "linear-gradient(#9A8C74 1px, transparent 1px), linear-gradient(90deg, #9A8C74 1px, transparent 1px)"
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            /* Dark Mode (Default) */
            --color-bg: #0F1115;
            --color-text: #F5F5F0;
            --color-surface: #1A1D23;
            --color-surface-light: #252932;
            --color-border: rgba(154, 140, 116, 0.05);
            /* Bronze tint instead of white */
            --glass-bg: rgba(26, 29, 35, 0.6);
            --glass-border: rgba(154, 140, 116, 0.05);
            /* Bronze tint instead of white */
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-hover: rgba(255, 255, 255, 0.06);
            --grid-line: rgba(154, 140, 116, 0.02);
            --scrollbar-track: rgba(26, 29, 35, 0.5);
            --scrollbar-thumb: #333;
        }

        .light-mode {
            /* Light Mode (Paper/Technical Drawing style) */
            --color-bg: #F0F0ED;
            /* Warm aesthetic white */
            --color-text: #1A1D23;
            /* Dark ink */
            --color-surface: #E6E6E3;
            --color-surface-light: #FFFFFF;
            --color-border: rgba(0, 0, 0, 0.08);
            --glass-bg: rgba(240, 240, 237, 0.85);
            /* Frosty white */
            --glass-border: rgba(0, 0, 0, 0.05);
            --card-bg: #FFFFFF;
            --card-hover: #FAFAFA;
            --grid-line: rgba(154, 140, 116, 0.08);
            /* Darker grid for light mode */
            --scrollbar-track: rgba(0, 0, 0, 0.05);
            --scrollbar-thumb: #CCC;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            cursor: default;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Blueprint Grid Effect */
        .bg-grid-pattern {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, var(--grid-line) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9A8C74;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            transition: background 0.3s, border 0.3s;
        }

        .task-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .task-card:hover {
            background: var(--card-hover);
            border-color: rgba(154, 140, 116, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .task-card.dragging {
            opacity: 0.5;
            border: 1px dashed #9A8C74;
            cursor: grabbing;
        }

        .kanban-list.drag-over {
            background-color: rgba(154, 140, 116, 0.05);
            border-radius: 8px;
        }

        /* Confetti */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* Toast */
        .toast {
            transform: translateY(150%) translateX(-50%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .toast.show {
            transform: translateY(0) translateX(-50%);
        }

        /* Multi-line support */
        .task-content {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>

<body
    class="text-portland selection:bg-bronze selection:text-portland h-screen bg-grid-pattern flex flex-col font-sans overflow-hidden">

    <canvas id="confetti-canvas"></canvas>

    <!-- Navbar -->
    <nav
        class="sticky top-0 w-full border-b border-subtle bg-midnight/95 backdrop-blur-md z-50 px-6 py-3 flex justify-between items-center text-[11px] tracking-widest uppercase font-mono shrink-0">
        <div class="flex items-center gap-4 text-bronze">
            <span class="font-bold">SMS-1694</span>
            <span class="text-portland/20">|</span>
            <span class="text-portland/80">Site Tasks</span>
        </div>

        <div class="flex items-center gap-6">
            <button id="theme-toggle" class="text-portland/40 hover:text-portland transition-colors focus:outline-none"
                title="Toggle Light Mode">
                <i class="fas fa-sun"></i>
            </button>

            <div id="connection-status"
                class="hidden text-xs px-2 py-1 rounded bg-red-900/20 text-red-400 font-bold flex items-center gap-1 border border-red-900/50">
                <i class="fas fa-wifi"></i> Offline
            </div>

            <button onclick="migratePersonalToShared()" title="Migrate Personal Tasks to Shared Board"
                class="text-[#F5F5F0]/20 hover:text-warning transition-colors text-[10px] uppercase font-mono tracking-widest border border-white/5 hover:border-warning px-2 py-1 rounded">
                <i class="fas fa-sync-alt mr-1"></i> Migrate
            </button>

            <a href="projectexecutive.html"
                class="hover:text-bronze transition-colors ml-4 text-portland/20 hover:text-portland/60">Back
                to Portal</a>
        </div>
    </nav>

    <!-- Board Header -->
    <header class="h-16 flex items-center justify-between px-6 border-b border-subtle bg-surface/30 shrink-0">
        <div>
            <h1 class="font-serif text-xl tracking-wide text-portland">Kanban Board</h1>
            <p class="text-[10px] text-portland/40 font-mono uppercase tracking-widest" id="date-display">...</p>
        </div>

        <div class="flex items-center gap-3">
            <button id="add-btn-main"
                class="bg-bronze hover:bg-bronze-dark text-portland px-4 py-1.5 rounded text-xs font-mono uppercase tracking-widest transition-colors flex items-center gap-2">
                <i class="fas fa-plus"></i> New Task
            </button>
        </div>
    </header>

    <!-- Board Area -->
    <main class="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div class="flex h-full gap-6 min-w-max">

            <!-- Column: To Do -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-subtle flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-portland/40"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">To Do</h2>
                        <span class="bg-portland/5 text-portland/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-todo">0</span>
                    </div>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-todo"
                    data-status="todo">
                    <!-- Cards -->
                </div>
            </div>

            <!-- Column: In Progress -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-subtle flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-warning"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">In Progress</h2>
                        <span class="bg-portland/5 text-portland/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-doing">0</span>
                    </div>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-doing"
                    data-status="doing">
                    <!-- Cards -->
                </div>
            </div>

            <!-- Column: Done -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-subtle flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-success"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">Complete</h2>
                        <span class="bg-portland/5 text-portland/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-done">0</span>
                    </div>
                    <button class="text-portland/20 hover:text-alert transition-colors text-xs" onclick="clearDone()"
                        title="Clear Completed"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-done"
                    data-status="done">
                    <!-- Cards -->
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Adding Tasks -->
    <div id="add-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-200">
        <div class="glass-panel p-6 rounded-lg w-full max-w-md transform scale-95 transition-transform duration-200"
            id="modal-content">
            <h3 class="font-serif text-xl text-portland mb-6" id="modal-title">New Site Task</h3>
            <form id="modal-form">
                <input type="hidden" id="modal-status" value="todo">

                <div class="mb-6">
                    <label
                        class="block text-[10px] font-mono text-portland/40 uppercase tracking-widest mb-2">Description</label>
                    <input type="text" id="modal-input"
                        class="w-full bg-surface-light border border-portland/10 rounded px-4 py-3 text-portland focus:outline-none focus:border-bronze focus:ring-1 focus:ring-bronze transition-colors"
                        placeholder="Task details..." required autocomplete="off">
                </div>

                <div class="mb-8">
                    <label
                        class="block text-[10px] font-mono text-portland/40 uppercase tracking-widest mb-2">Category</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="site" checked class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-portland/10 text-xs font-mono uppercase tracking-wider text-portland/60 peer-checked:bg-bronze/20 peer-checked:text-bronze peer-checked:border-bronze hover:bg-portland/5 transition-all">
                                Site</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="office" class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-portland/10 text-xs font-mono uppercase tracking-wider text-portland/60 peer-checked:bg-blue-500/20 peer-checked:text-blue-300 peer-checked:border-blue-500 hover:bg-portland/5 transition-all">
                                Office</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="critical" class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-portland/10 text-xs font-mono uppercase tracking-wider text-portland/60 peer-checked:bg-red-500/20 peer-checked:text-red-300 peer-checked:border-red-500 hover:bg-portland/5 transition-all">
                                Critical</div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 text-xs font-mono uppercase tracking-widest text-portland/40 hover:text-portland transition-colors">Cancel</button>
                    <button type="submit"
                        class="bg-bronze hover:bg-bronze-dark text-portland px-6 py-2 rounded text-xs font-mono uppercase tracking-widest transition-colors shadow-lg shadow-black/20">Add
                        Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 flex flex-col gap-2 z-50 pointer-events-none">
        <!-- Toasts injected here -->
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
            onSnapshot, serverTimestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcezJRuEx8vsThQKhi8Az_XdL_XSM6u8g",
            authDomain: "st-mary-somerset.firebaseapp.com",
            projectId: "st-mary-somerset",
            storageBucket: "st-mary-somerset.firebasestorage.app",
            messagingSenderId: "924281338278",
            appId: "1:924281338278:web:82023a592a670e7d97f767"
        };
        // Internal ID for Firestore data path structure
        const appId = 'site-tasks';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- State ---
        let currentUser = null;
        let todos = [];

        // Pending deletions: Map<id, {timeout: number, data: object}>
        const pendingDeletions = new Map();

        // --- UI Refs ---
        const cols = {
            todo: document.getElementById('col-todo'),
            doing: document.getElementById('col-doing'),
            done: document.getElementById('col-done')
        };
        const counts = {
            todo: document.getElementById('count-todo'),
            doing: document.getElementById('count-doing'),
            done: document.getElementById('count-done')
        };
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');
        const modalInput = document.getElementById('modal-input');
        const modalStatus = document.getElementById('modal-status');
        const dateDisplay = document.getElementById('date-display');
        const toastContainer = document.getElementById('toast-container');

        // --- Init ---
        dateDisplay.textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        // --- Auth ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // SHARED PATH: artifacts/site-tasks/global/board/tasks
                const ref = collection(db, 'artifacts', appId, 'global', 'board', 'tasks');
                onSnapshot(ref, (snap) => {
                    todos = snap.docs.map(d => {
                        const data = d.data();
                        let status = data.status;
                        if (!status) status = data.completed ? 'done' : 'todo';
                        return { id: d.id, ...data, status };
                    });

                    todos.sort((a, b) => (a.order || 0) - (b.order || 0));
                    renderBoard();
                }, (err) => {
                    document.getElementById('connection-status').classList.remove('hidden');
                });
            }
        });

        // --- Render ---
        function renderBoard() {
            Object.values(cols).forEach(c => c.innerHTML = '');
            const stats = { todo: 0, doing: 0, done: 0 };

            todos.forEach(t => {
                // If this item is pending deletion, do not render it.
                if (pendingDeletions.has(t.id)) return;

                const status = ['todo', 'doing', 'done'].includes(t.status) ? t.status : 'todo';
                stats[status]++;

                const card = document.createElement('div');
                card.className = 'task-card p-3 rounded cursor-grab mb-2 group relative text-sm';
                card.draggable = true;
                card.dataset.id = t.id;

                // Categories
                let catClass = 'bg-portland/10 text-portland/60';
                if (t.category === 'critical') catClass = 'bg-alert/10 text-alert border border-alert/20';
                else if (t.category === 'office') catClass = 'bg-blue-500/10 text-blue-300 border border-blue-500/20';
                else if (t.category === 'site') catClass = 'bg-bronze/10 text-bronze border border-bronze/20';

                const catLabel = t.category ? t.category.toUpperCase() : 'SITE';

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-[10px] font-mono tracking-wider px-1.5 py-0.5 rounded ${catClass}">${catLabel}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] text-portland/30 font-mono">${t.createdAt ? new Date(t.createdAt.seconds * 1000).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) : 'Today'}</span>
                            <button onclick="askDelete('${t.id}')" class="text-portland/20 hover:text-alert opacity-0 group-hover:opacity-100 transition-all p-1 -mr-1">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-portland/90 font-light leading-snug task-content" 
                       contenteditable="false" 
                       ondblclick="editTask(this, '${t.id}')"
                       title="Double click to edit">${escapeHtml(t.text)}</p>
                `;

                card.addEventListener('dragstart', dragStart);
                card.addEventListener('dragend', dragEnd);
                cols[status].appendChild(card);
            });

            Object.keys(stats).forEach(k => counts[k].textContent = stats[k]);
        }

        // --- Drag & Drop & Reordering ---
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd() {
            this.classList.remove('dragging');
            draggedItem = null;
            document.querySelectorAll('.kanban-list').forEach(l => l.classList.remove('drag-over'));
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        Object.values(cols).forEach(col => {
            col.addEventListener('dragover', (e) => {
                e.preventDefault();
                col.classList.add('drag-over');

                const afterElement = getDragAfterElement(col, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (!draggable) return;

                if (afterElement == null) {
                    col.appendChild(draggable);
                } else {
                    col.insertBefore(draggable, afterElement);
                }
            });

            col.addEventListener('dragleave', () => {
                col.classList.remove('drag-over');
            });

            col.addEventListener('drop', async (e) => {
                e.preventDefault();
                col.classList.remove('drag-over');

                if (!draggedItem) return;

                const id = draggedItem.dataset.id;
                const newStatus = col.dataset.status;
                const task = todos.find(t => t.id === id);

                // Calculate new order
                const siblings = [...col.querySelectorAll('.task-card')];
                const index = siblings.indexOf(draggedItem);

                let newOrder;
                if (siblings.length === 1) {
                    // Only item in list
                    newOrder = 0;
                } else if (index === 0) {
                    // Top of list
                    const nextId = siblings[1].dataset.id;
                    const nextOrder = todos.find(t => t.id === nextId)?.order || 0;
                    newOrder = nextOrder - 100;
                } else if (index === siblings.length - 1) {
                    // Bottom of list
                    const prevId = siblings[index - 1].dataset.id;
                    const prevOrder = todos.find(t => t.id === prevId)?.order || 0;
                    newOrder = prevOrder + 100;
                } else {
                    // Between two items
                    const prevId = siblings[index - 1].dataset.id;
                    const nextId = siblings[index + 1].dataset.id;
                    const prevOrder = todos.find(t => t.id === prevId)?.order || 0;
                    const nextOrder = todos.find(t => t.id === nextId)?.order || 0;
                    newOrder = (prevOrder + nextOrder) / 2;
                }

                // Optimistic Update
                if (task) {
                    task.status = newStatus;
                    task.order = newOrder;
                }

                // Fire confetti if moved to done
                if (newStatus === 'done' && task && !task.completed) {
                    fireConfetti();
                }

                try {
                    const ref = doc(db, 'artifacts', appId, 'global', 'board', 'tasks', id);
                    await updateDoc(ref, {
                        status: newStatus,
                        completed: newStatus === 'done',
                        order: newOrder
                    });
                } catch (err) {
                    console.error("Move failed", err);
                    alert("Failed to save move: " + err.message);
                }
            });
        });


        // --- Actions ---
        window.openAddModal = (status) => {
            modalStatus.value = status;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalInput.focus();
            });
        };

        document.getElementById('add-btn-main').onclick = () => openAddModal('todo');

        window.closeModal = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('modal-form').reset();
            }, 200);
        };

        document.getElementById('modal-form').onsubmit = async (e) => {
            e.preventDefault();
            const text = modalInput.value.trim();
            const status = modalStatus.value;
            const category = document.querySelector('input[name="category"]:checked').value;

            if (!text || !currentUser) return;

            closeModal();

            const minOrder = todos.length ? Math.min(...todos.map(t => t.order || 0)) : 0;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'global', 'board', 'tasks'), {
                    text, category, status,
                    completed: status === 'done',
                    createdAt: serverTimestamp(),
                    order: minOrder - 100
                });
                closeModal();
            } catch (err) {
                console.error("Error adding task:", err);
                alert("Failed to add task. \n\nReason: " + err.message + "\n\nCheck console for details.");
            }
        };


        window.editTask = (el, id) => {
            el.contentEditable = true;
            el.focus();
            el.classList.add('bg-portland/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');

            const save = async () => {
                el.contentEditable = false;
                el.classList.remove('bg-portland/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');
                const val = el.innerText.trim();
                const original = todos.find(t => t.id === id).text;

                if (val && val !== original) {
                    await updateDoc(doc(db, 'artifacts', appId, 'global', 'board', 'tasks', id), { text: val });
                } else {
                    el.innerText = original;
                }
            };

            el.onblur = save;
            el.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); el.blur(); } };
        };

        // --- Deletion & Undo Logic ---

        // Show a new toast for a deletion event
        function showUndoToast(taskId) {
            const el = document.createElement('div');
            el.className = 'bg-portland text-midnight px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 toast pointer-events-auto min-w-[300px] justify-between';
            el.innerHTML = `
                <span class="font-medium text-sm">Task moved to trash</span>
                <button class="text-bronze-dark font-bold text-sm hover:underline uppercase tracking-wide">Undo</button>
            `;

            // Undo click handler
            el.querySelector('button').onclick = () => {
                undoDelete(taskId);
                el.remove(); // Remove toast immediately on undo
            };

            toastContainer.appendChild(el);

            // Animate in
            requestAnimationFrame(() => el.classList.add('show'));

            // Auto-dismiss if not clicked
            setTimeout(() => {
                if (el.parentElement) {
                    el.classList.remove('show');
                    setTimeout(() => el.remove(), 400);
                }
            }, 3000); // 3 seconds to undo
        }

        window.askDelete = (id) => {
            // 1. Mark as pending locally (hides from UI via renderBoard)
            const taskData = todos.find(t => t.id === id);
            if (!taskData) return;

            // 2. Set timeout to actually delete
            const timeoutId = setTimeout(async () => {
                // If this runs, the user didn't undo
                if (pendingDeletions.has(id)) {
                    pendingDeletions.delete(id); // Remove from local map
                    await deleteDoc(doc(db, 'artifacts', appId, 'global', 'board', 'tasks', id));
                }
            }, 3000);

            // 3. Store in map
            pendingDeletions.set(id, { timeout: timeoutId, data: taskData });

            // 4. Update UI
            renderBoard();
            showUndoToast(id);
        };

        function undoDelete(id) {
            const pending = pendingDeletions.get(id);
            if (pending) {
                clearTimeout(pending.timeout);
                pendingDeletions.delete(id);
                renderBoard(); // Re-appears because it's no longer in pendingDeletions map
            }
        }

        window.clearDone = async () => {
            if (!confirm('Delete all tasks in Done column?')) return;
            const batch = writeBatch(db);
            todos.filter(t => t.status === 'done').forEach(t => {
                batch.delete(doc(db, 'artifacts', appId, 'global', 'board', 'tasks', t.id));
            });
            await batch.commit();
        };

        // --- Utils ---
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = Array.from({ length: 60 }, () => ({
                x: window.innerWidth * 0.75,
                y: window.innerHeight * 0.5,
                vx: (Math.random() - 0.5) * 25, vy: (Math.random() - 0.8) * 25,
                color: `hsl(${Math.random() * 50 + 40}, 80%, 60%)`, // Bronze/Gold hues
                life: 100
            }));

            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if (p.life > 0) {
                        active = true; p.life--;
                        p.x += p.vx; p.y += p.vy; p.vy += 0.5;
                        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4);
                    }
                });
                if (active) requestAnimationFrame(loop);
            }
            loop();
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // --- New Features Logic ---

        // 1. Light Mode Toggle
        const toggleBtn = document.getElementById('theme-toggle');
        const body = document.body;
        // Check local storage or system preference
        let isLight = localStorage.getItem('theme') === 'light';

        function setTheme(light) {
            if (light) {
                body.classList.add('light-mode');
                toggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                body.classList.remove('light-mode');
                toggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
            localStorage.setItem('theme', light ? 'light' : 'dark');
            isLight = light;
        }

        // Initialize
        setTheme(isLight);
        toggleBtn.onclick = () => setTheme(!isLight);

        // 2. Keyboard Shortcuts ('n' for new task)
        document.addEventListener('keydown', (e) => {
            // Ignore if typing
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;

            if (e.key.toLowerCase() === 'n') {
                e.preventDefault();
                openAddModal('todo');
            }
        });

        // 3. Double Click on Panel/List to Add
        Object.entries(cols).forEach(([status, col]) => {
            // We want to catch clicks on the glass-panel or empty space, not on cards
            // The col is the list container. The parent is the glass panel.
            const panel = col.parentElement;
            panel.addEventListener('dblclick', (e) => {
                // Should not trigger if clicked on a card (which has its own logic or bubbles up)
                // But we want to avoid triggering if we dblclick text to select it?
                // For now, simple check if target is the container or panel
                if (e.target.closest('.task-card')) return;

                openAddModal(status);
            });
        });

        // 4. Update Edit Logic for Multi-line (Shift+Enter)
        // Redefine the existing window.editTask to support Shift+Enter
        const originalEditTask = window.editTask;
        window.editTask = (el, id) => {
            el.contentEditable = true;
            el.focus();
            el.classList.add('bg-portland/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');
            // Ensure pre-wrap class is there (it is added in CSS class .task-card p but let's be sure)

            const save = async () => {
                el.contentEditable = false;
                el.classList.remove('bg-portland/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');
                const val = el.innerText.trim(); // innerText preserves newlines as \n usually
                const original = todos.find(t => t.id === id).text;

                if (val && val !== original) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id), { text: val });
                } else {
                    el.innerText = original;
                }
            };

            el.onblur = save;
            el.onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    el.blur();
                }
            };
        };

        // 5. Dynamic Modal Header
        const modalTitle = document.getElementById('modal-title');
        const categoryInputs = document.querySelectorAll('input[name="category"]');

        categoryInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                const cat = e.target.value;
                // Capitalize first letter
                const catName = cat.charAt(0).toUpperCase() + cat.slice(1);
                modalTitle.textContent = `New ${catName} Task`;
            });
        });

        // Reset title when opening modal (defaults to Site usually, but let's be safe)
        const ORIGINAL_OPEN_MODAL = window.openAddModal;
        window.openAddModal = (status) => {
            // Call original logic (we can't easily hook into the previous function without redefining, 
            // but we can just update the title based on the currently checked radio)
            const currentCat = document.querySelector('input[name="category"]:checked').value;
            const catName = currentCat.charAt(0).toUpperCase() + currentCat.slice(1);
            modalTitle.textContent = `New ${catName} Task`;

            // Re-run the show logic from previous step manually since we are not wrapping cleanly
            // Actually, simpler to just copy the logic or ensure we don't break scope
            modalStatus.value = status;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalInput.focus();
            });
        };

        // 6. Migration Utility
        window.migratePersonalToShared = async () => {
            if (!currentUser) return;
            if (!confirm("This will copy all tasks from your Personal/Local board to the Shared Board.\n\nProceed?")) return;

            try {
                const button = document.querySelector('button[onclick="migratePersonalToShared()"]');
                if (button) button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Migrating...';

                // Read Personal
                const personalRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'todos');
                // Use getDocs from sdk
                const { getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                const snap = await getDocs(personalRef);

                if (snap.empty) {
                    alert("No personal tasks found to migrate.");
                    if (button) button.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Migrate';
                    return;
                }

                const batch = writeBatch(db);
                let count = 0;

                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    // Create new ref in Shared
                    const newRef = doc(collection(db, 'artifacts', appId, 'global', 'board', 'tasks'));
                    batch.set(newRef, data);
                    count++;
                });

                await batch.commit();
                alert(`Successfully migrated ${count} tasks to the Shared Board!`);
                if (button) button.remove();

            } catch (err) {
                console.error("Migration failed:", err);
                alert("Migration failed: " + err.message);
                const button = document.querySelector('button[onclick="migratePersonalToShared()"]');
                if (button) button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Retry';
            }
        };

    </script>
</body>

</html>