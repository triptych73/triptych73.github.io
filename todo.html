<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St Mary Somerset | Site Tasks</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'portland': '#F5F5F0',
                        'midnight': '#0F1115',
                        'bronze': '#9A8C74',
                        'bronze-dark': '#5c5240',
                        'alert': '#ef4444',
                        'warning': '#f59e0b',
                        'success': '#10b981',
                        'surface': '#1A1D23',
                        'surface-light': '#252932'
                    },
                    fontFamily: {
                        'serif': ['Cinzel', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    backgroundImage: {
                        'blueprint': "linear-gradient(#9A8C74 1px, transparent 1px), linear-gradient(90deg, #9A8C74 1px, transparent 1px)"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0F1115;
            cursor: default;
        }

        /* Blueprint Grid Effect */
        .bg-grid-pattern {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(154, 140, 116, 0.03) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(154, 140, 116, 0.03) 1px, transparent 1px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(26, 29, 35, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9A8C74;
        }

        .glass-panel {
            background: rgba(26, 29, 35, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .task-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .task-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(154, 140, 116, 0.3);
            /* Bronze hint */
            transform: translateY(-2px);
        }

        .task-card.dragging {
            opacity: 0.5;
            border: 1px dashed #9A8C74;
            cursor: grabbing;
        }

        .kanban-list.drag-over {
            background-color: rgba(154, 140, 116, 0.05);
            border-radius: 8px;
        }

        /* Confetti */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* Toast */
        .toast {
            transform: translateY(150%) translateX(-50%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .toast.show {
            transform: translateY(0) translateX(-50%);
        }
    </style>
</head>

<body
    class="text-portland selection:bg-bronze selection:text-white h-screen bg-grid-pattern flex flex-col font-sans overflow-hidden">

    <canvas id="confetti-canvas"></canvas>

    <!-- Navbar -->
    <nav
        class="sticky top-0 w-full border-b border-white/5 bg-midnight/95 backdrop-blur-md z-50 px-6 py-3 flex justify-between items-center text-[11px] tracking-widest uppercase font-mono shrink-0">
        <div class="flex items-center gap-4 text-bronze">
            <span class="font-bold">SMS-1694</span>
            <span class="text-white/20">|</span>
            <span class="text-portland/80">Site Tasks</span>
        </div>
        <div class="flex items-center gap-6">
            <div id="connection-status"
                class="hidden text-xs px-2 py-1 rounded bg-red-900/20 text-red-400 font-bold flex items-center gap-1 border border-red-900/50">
                <i class="fas fa-wifi"></i> Offline
            </div>

            <a href="index.html" class="hover:text-bronze transition-colors ml-4 text-white/20 hover:text-white/60">Back
                to Portal</a>
        </div>
    </nav>

    <!-- Board Header -->
    <header class="h-16 flex items-center justify-between px-6 border-b border-white/5 bg-surface/30 shrink-0">
        <div>
            <h1 class="font-serif text-xl tracking-wide text-portland">Kanban Board</h1>
            <p class="text-[10px] text-white/40 font-mono uppercase tracking-widest" id="date-display">...</p>
        </div>

        <div class="flex items-center gap-3">
            <button id="add-btn-main"
                class="bg-bronze hover:bg-bronze-dark text-white px-4 py-1.5 rounded text-xs font-mono uppercase tracking-widest transition-colors flex items-center gap-2">
                <i class="fas fa-plus"></i> New Task
            </button>
        </div>
    </header>

    <!-- Board Area -->
    <main class="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div class="flex h-full gap-6 min-w-max">

            <!-- Column: To Do -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-white/40"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">To Do</h2>
                        <span class="bg-white/5 text-white/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-todo">0</span>
                    </div>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-todo"
                    data-status="todo">
                    <!-- Cards -->
                </div>
            </div>

            <!-- Column: In Progress -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-warning"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">In Progress</h2>
                        <span class="bg-white/5 text-white/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-doing">0</span>
                    </div>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-doing"
                    data-status="doing">
                    <!-- Cards -->
                </div>
            </div>

            <!-- Column: Done -->
            <div class="glass-panel rounded-xl flex flex-col h-full w-[350px]">
                <div class="p-4 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-success"></div>
                        <h2 class="font-serif text-sm text-bronze tracking-wide">Complete</h2>
                        <span class="bg-white/5 text-white/40 text-[10px] font-mono px-2 py-0.5 rounded"
                            id="count-done">0</span>
                    </div>
                    <button class="text-white/20 hover:text-alert transition-colors text-xs" onclick="clearDone()"
                        title="Clear Completed"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="kanban-list flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar" id="col-done"
                    data-status="done">
                    <!-- Cards -->
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Adding Tasks -->
    <div id="add-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 opacity-0 transition-opacity duration-200">
        <div class="glass-panel p-6 rounded-lg w-full max-w-md transform scale-95 transition-transform duration-200"
            id="modal-content">
            <h3 class="font-serif text-xl text-portland mb-6">New Site Task</h3>
            <form id="modal-form">
                <input type="hidden" id="modal-status" value="todo">

                <div class="mb-6">
                    <label
                        class="block text-[10px] font-mono text-white/40 uppercase tracking-widest mb-2">Description</label>
                    <input type="text" id="modal-input"
                        class="w-full bg-surface-light border border-white/10 rounded px-4 py-3 text-portland focus:outline-none focus:border-bronze focus:ring-1 focus:ring-bronze transition-colors"
                        placeholder="Task details..." required autocomplete="off">
                </div>

                <div class="mb-8">
                    <label
                        class="block text-[10px] font-mono text-white/40 uppercase tracking-widest mb-2">Category</label>
                    <div class="flex gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="site" checked class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-white/10 text-xs font-mono uppercase tracking-wider text-white/60 peer-checked:bg-bronze/20 peer-checked:text-bronze peer-checked:border-bronze hover:bg-white/5 transition-all">
                                Site</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="office" class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-white/10 text-xs font-mono uppercase tracking-wider text-white/60 peer-checked:bg-blue-500/20 peer-checked:text-blue-300 peer-checked:border-blue-500 hover:bg-white/5 transition-all">
                                Office</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="category" value="critical" class="peer sr-only">
                            <div
                                class="px-3 py-2 rounded border border-white/10 text-xs font-mono uppercase tracking-wider text-white/60 peer-checked:bg-red-500/20 peer-checked:text-red-300 peer-checked:border-red-500 hover:bg-white/5 transition-all">
                                Critical</div>
                        </label>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 text-xs font-mono uppercase tracking-widest text-white/40 hover:text-white transition-colors">Cancel</button>
                    <button type="submit"
                        class="bg-bronze hover:bg-bronze-dark text-white px-6 py-2 rounded text-xs font-mono uppercase tracking-widest transition-colors shadow-lg shadow-black/20">Add
                        Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 flex flex-col gap-2 z-50 pointer-events-none">
        <!-- Toasts injected here -->
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
            onSnapshot, serverTimestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBcezJRuEx8vsThQKhi8Az_XdL_XSM6u8g",
            authDomain: "st-mary-somerset.firebaseapp.com",
            projectId: "st-mary-somerset",
            storageBucket: "st-mary-somerset.firebasestorage.app",
            messagingSenderId: "924281338278",
            appId: "1:924281338278:web:82023a592a670e7d97f767"
        };
        // Internal ID for Firestore data path structure
        const appId = 'site-tasks';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- State ---
        let currentUser = null;
        let todos = [];

        // Pending deletions: Map<id, {timeout: number, data: object}>
        const pendingDeletions = new Map();

        // --- UI Refs ---
        const cols = {
            todo: document.getElementById('col-todo'),
            doing: document.getElementById('col-doing'),
            done: document.getElementById('col-done')
        };
        const counts = {
            todo: document.getElementById('count-todo'),
            doing: document.getElementById('count-doing'),
            done: document.getElementById('count-done')
        };
        const modal = document.getElementById('add-modal');
        const modalContent = document.getElementById('modal-content');
        const modalInput = document.getElementById('modal-input');
        const modalStatus = document.getElementById('modal-status');
        const dateDisplay = document.getElementById('date-display');
        const toastContainer = document.getElementById('toast-container');

        // --- Init ---
        dateDisplay.textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        // --- Auth ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const ref = collection(db, 'artifacts', appId, 'users', user.uid, 'todos');
                onSnapshot(ref, (snap) => {
                    todos = snap.docs.map(d => {
                        const data = d.data();
                        let status = data.status;
                        if (!status) status = data.completed ? 'done' : 'todo';
                        return { id: d.id, ...data, status };
                    });

                    todos.sort((a, b) => (a.order || 0) - (b.order || 0));
                    renderBoard();
                }, (err) => {
                    document.getElementById('connection-status').classList.remove('hidden');
                });
            }
        });

        // --- Render ---
        function renderBoard() {
            Object.values(cols).forEach(c => c.innerHTML = '');
            const stats = { todo: 0, doing: 0, done: 0 };

            todos.forEach(t => {
                // If this item is pending deletion, do not render it.
                if (pendingDeletions.has(t.id)) return;

                const status = ['todo', 'doing', 'done'].includes(t.status) ? t.status : 'todo';
                stats[status]++;

                const card = document.createElement('div');
                card.className = 'task-card p-3 rounded cursor-grab mb-2 group relative text-sm';
                card.draggable = true;
                card.dataset.id = t.id;

                // Categories
                let catClass = 'bg-white/10 text-white/60';
                if (t.category === 'critical') catClass = 'bg-alert/10 text-alert border border-alert/20';
                else if (t.category === 'office') catClass = 'bg-blue-500/10 text-blue-300 border border-blue-500/20';
                else if (t.category === 'site') catClass = 'bg-bronze/10 text-bronze border border-bronze/20';

                const catLabel = t.category ? t.category.toUpperCase() : 'SITE';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-mono tracking-wider px-1.5 py-0.5 rounded ${catClass}">${catLabel}</span>
                        <button onclick="askDelete('${t.id}')" class="text-white/20 hover:text-alert opacity-0 group-hover:opacity-100 transition-all p-1 -mt-1 -mr-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-white/90 font-light leading-snug mb-2" 
                       contenteditable="false" 
                       ondblclick="editTask(this, '${t.id}')"
                       title="Double click to edit">${escapeHtml(t.text)}</p>
                    <div class="flex items-center justify-between border-t border-white/5 pt-1.5">
                         <div class="text-[10px] text-white/30 font-mono flex items-center gap-1">
                            <i class="far fa-clock"></i>
                            ${t.createdAt ? new Date(t.createdAt.seconds * 1000).toLocaleDateString() : 'Today'}
                        </div>
                    </div>
                `;

                card.addEventListener('dragstart', dragStart);
                card.addEventListener('dragend', dragEnd);
                cols[status].appendChild(card);
            });

            Object.keys(stats).forEach(k => counts[k].textContent = stats[k]);
        }

        // --- Drag & Drop ---
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragEnd() {
            this.classList.remove('dragging');
            draggedItem = null;
            document.querySelectorAll('.kanban-list').forEach(l => l.classList.remove('drag-over'));
        }

        Object.values(cols).forEach(col => {
            col.addEventListener('dragover', (e) => {
                e.preventDefault();
                col.classList.add('drag-over');
            });

            col.addEventListener('dragleave', () => {
                col.classList.remove('drag-over');
            });

            col.addEventListener('drop', async (e) => {
                e.preventDefault();
                col.classList.remove('drag-over');

                if (draggedItem) {
                    const id = draggedItem.dataset.id;
                    const newStatus = col.dataset.status;
                    const oldStatus = todos.find(t => t.id === id)?.status;

                    if (oldStatus !== newStatus) {
                        col.appendChild(draggedItem);
                        if (newStatus === 'done') fireConfetti();

                        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id);
                        await updateDoc(ref, {
                            status: newStatus,
                            completed: newStatus === 'done',
                            movedAt: serverTimestamp()
                        });
                    }
                }
            });
        });


        // --- Actions ---
        window.openAddModal = (status) => {
            modalStatus.value = status;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalInput.focus();
            });
        };

        document.getElementById('add-btn-main').onclick = () => openAddModal('todo');

        window.closeModal = () => {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('modal-form').reset();
            }, 200);
        };

        document.getElementById('modal-form').onsubmit = async (e) => {
            e.preventDefault();
            const text = modalInput.value.trim();
            const status = modalStatus.value;
            const category = document.querySelector('input[name="category"]:checked').value;

            if (!text || !currentUser) return;

            closeModal();

            const minOrder = todos.length ? Math.min(...todos.map(t => t.order || 0)) : 0;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'todos'), {
                    text, category, status,
                    completed: status === 'done',
                    createdAt: serverTimestamp(),
                    order: minOrder - 100
                });
                closeModal();
            } catch (err) {
                console.error("Error adding task:", err);
                alert("Failed to add task. \n\nReason: " + err.message + "\n\nCheck console for details.");
            }
        };


        window.editTask = (el, id) => {
            el.contentEditable = true;
            el.focus();
            el.classList.add('bg-white/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');

            const save = async () => {
                el.contentEditable = false;
                el.classList.remove('bg-white/5', 'rounded', 'px-1', 'outline-none', 'ring-1', 'ring-bronze');
                const val = el.innerText.trim();
                const original = todos.find(t => t.id === id).text;

                if (val && val !== original) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id), { text: val });
                } else {
                    el.innerText = original;
                }
            };

            el.onblur = save;
            el.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); el.blur(); } };
        };

        // --- Deletion & Undo Logic ---

        // Show a new toast for a deletion event
        function showUndoToast(taskId) {
            const el = document.createElement('div');
            el.className = 'bg-white text-midnight px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 toast pointer-events-auto min-w-[300px] justify-between';
            el.innerHTML = `
                <span class="font-medium text-sm">Task moved to trash</span>
                <button class="text-bronze-dark font-bold text-sm hover:underline uppercase tracking-wide">Undo</button>
            `;

            // Undo click handler
            el.querySelector('button').onclick = () => {
                undoDelete(taskId);
                el.remove(); // Remove toast immediately on undo
            };

            toastContainer.appendChild(el);

            // Animate in
            requestAnimationFrame(() => el.classList.add('show'));

            // Auto-dismiss if not clicked
            setTimeout(() => {
                if (el.parentElement) {
                    el.classList.remove('show');
                    setTimeout(() => el.remove(), 400);
                }
            }, 3000); // 3 seconds to undo
        }

        window.askDelete = (id) => {
            // 1. Mark as pending locally (hides from UI via renderBoard)
            const taskData = todos.find(t => t.id === id);
            if (!taskData) return;

            // 2. Set timeout to actually delete
            const timeoutId = setTimeout(async () => {
                // If this runs, the user didn't undo
                if (pendingDeletions.has(id)) {
                    pendingDeletions.delete(id); // Remove from local map
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', id));
                }
            }, 3000);

            // 3. Store in map
            pendingDeletions.set(id, { timeout: timeoutId, data: taskData });

            // 4. Update UI
            renderBoard();
            showUndoToast(id);
        };

        function undoDelete(id) {
            const pending = pendingDeletions.get(id);
            if (pending) {
                clearTimeout(pending.timeout);
                pendingDeletions.delete(id);
                renderBoard(); // Re-appears because it's no longer in pendingDeletions map
            }
        }

        window.clearDone = async () => {
            if (!confirm('Delete all tasks in Done column?')) return;
            const batch = writeBatch(db);
            todos.filter(t => t.status === 'done').forEach(t => {
                batch.delete(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'todos', t.id));
            });
            await batch.commit();
        };

        // --- Utils ---
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = Array.from({ length: 60 }, () => ({
                x: window.innerWidth * 0.75,
                y: window.innerHeight * 0.5,
                vx: (Math.random() - 0.5) * 25, vy: (Math.random() - 0.8) * 25,
                color: `hsl(${Math.random() * 50 + 40}, 80%, 60%)`, // Bronze/Gold hues
                life: 100
            }));

            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    if (p.life > 0) {
                        active = true; p.life--;
                        p.x += p.vx; p.y += p.vy; p.vy += 0.5;
                        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4);
                    }
                });
                if (active) requestAnimationFrame(loop);
            }
            loop();
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

    </script>
</body>

</html>