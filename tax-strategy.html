<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Strategy Engine</title>

    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="firebase-config.js"></script>

    <!-- Error Handler -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const div = document.createElement('div');
            div.style.color = 'red';
            div.style.padding = '20px';
            div.style.fontFamily = 'monospace';
            div.style.backgroundColor = '#fee';
            div.style.borderBottom = '1px solid #ecc';
            div.innerHTML = `<h3>Application Error</h3><p><strong>${msg}</strong></p><p>Location: ${url}:${line}:${col}</p><pre>${error ? error.stack : ''}</pre>`;
            document.body.prepend(div);
            return false;
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (React 17 - Unpkg) -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- Recharts (v1.8.5 - Known Stable UMD) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@1.8.5/umd/Recharts.min.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">

    <!-- Auth Guard Overlay -->
    <div id="loading-overlay"
        style="position:fixed; inset:0; background:#0F1115; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
        <div
            style="width: 4rem; height: 4rem; border: 1px solid rgba(154, 140, 116, 0.3); border-top-color: #9A8C74; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;">
        </div>
        <div
            style="font-family: 'Cinzel', serif; color: #9A8C74; letter-spacing: 0.2em; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;">
            VERIFYING PERMISSIONS</div>
        <style>
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                }

                50% {
                    opacity: .5;
                }
            }
        </style>
    </div>

    <div id="root" style="display:none;"></div>

    <script type="text/babel">
        // Globals Check
        if (!window.React) console.error("React missing!");
        if (!window.ReactDOM) console.error("ReactDOM missing!");
        if (!window.Recharts) console.error("Recharts missing!");

        // Fallback for Recharts if it fails to expose globally immediately
        const Recharts = window.Recharts || window.recharts;

        if (!window.React || !window.ReactDOM || !Recharts) {
            throw new Error(`Libraries failed (React: ${!!window.React}, ReactDOM: ${!!window.ReactDOM}, Recharts: ${!!Recharts}). Check console.`);
        }

        // --- Configuration & Default Data ---
        const DEFAULT_DATA = {
            salePrice: 3250000,
            devCosts: 2000000,
            saleYear: 2026, // Reset to future date
            currentYear: new Date().getFullYear(),
            loans: [
                { id: 1, name: "KR Loan", amount: 1650000, type: "assigned", assignmentYear: 2018 },
                { id: 2, name: "Other Director Loan", amount: 100000, type: "outstanding", assignmentYear: null }
            ],
            insurance: {
                enabled: true,
                premium: 2000,
                payout: 1000000,
                termStartYear: 2022
            }
        };

        const { useState, useEffect, useMemo, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // --- Utility Functions ---
        const formatCurrency = (val) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', minimumFractionDigits: 0 }).format(val);

        const getTaperRate = (years) => {
            if (years < 3) return 1.0;
            if (years < 4) return 0.8;
            if (years < 5) return 0.6;
            if (years < 6) return 0.4;
            if (years < 7) return 0.2;
            return 0.0;
        };

        // --- Components ---

        const Card = ({ title, children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-6 ${className}`}>
                <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
                {children}
            </div>
        );

        const NumberInput = ({ label, value, onChange, prefix = "£" }) => (
            <div className="flex flex-col space-y-1">
                <label className="text-sm font-medium text-gray-600">{label}</label>
                <div className="relative">
                    {prefix && <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">{prefix}</span>}
                    <input
                        type="number"
                        value={value}
                        onChange={(e) => onChange(parseFloat(e.target.value) || 0)}
                        className={`w-full pl-${prefix ? '8' : '3'} pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all`}
                    />
                </div>
            </div>
        );

        const SliderInput = ({ label, value, onChange, min, max, unit = "" }) => (
            <div className="flex flex-col space-y-2">
                <div className="flex justify-between items-end">
                    <label className="text-sm font-medium text-gray-600">{label}</label>
                    <span className="text-base font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{value} {unit}</span>
                </div>
                <input
                    type="range"
                    min={min}
                    max={max}
                    value={value}
                    onChange={(e) => onChange(parseInt(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
                <div className="flex justify-between text-xs text-gray-400 font-mono">
                    <span>{min}</span>
                    <span>{max}</span>
                </div>
            </div>
        );

        const Toggle = ({ enabled, onChange, label }) => (
            <div className="flex items-center justify-between cursor-pointer" onClick={() => onChange(!enabled)}>
                <span className="text-sm font-medium text-gray-700">{label}</span>
                <div className={`relative w-11 h-6 bg-gray-200 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 ${enabled ? 'bg-blue-600' : ''}`}>
                    <div className={`absolute top-[2px] left-[2px] bg-white border-gray-300 border rounded-full h-5 w-5 transition-all ${enabled ? 'translate-x-full border-white' : ''}`}></div>
                </div>
            </div>
        );

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-white p-3 border border-gray-200 shadow-lg rounded-lg text-sm z-50">
                        <p className="font-bold text-gray-800 mb-2">{label}</p>
                        <div className="space-y-1">
                            <p className="text-emerald-600 font-medium whitespace-nowrap">
                                Net Wealth: {formatCurrency(payload[0].value)}
                            </p>
                            <p className="text-red-500 font-medium whitespace-nowrap">
                                IHT Tax: {formatCurrency(payload[1].value)}
                            </p>
                            <div className="pt-2 mt-1 border-t border-gray-100 text-xs text-gray-500 whitespace-nowrap">
                                Total Created: {formatCurrency(payload[0].value + payload[1].value)}
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const MathWalkthrough = ({ calc, inputs, getTaper }) => {
            const profit = inputs.salePrice - inputs.devCosts;
            const yearsSinceSale = inputs.deathYear - inputs.saleYear;
            const taperA = getTaper(yearsSinceSale);

            return (
                <Card title="Calculation Logic (Step-by-Step)" className="mt-8 border-l-4 border-blue-500 bg-slate-50">
                    <div className="space-y-6 text-sm font-mono text-gray-700">

                        {/* 1. Corp Tax */}
                        <div>
                            <h4 className="font-bold text-gray-900 border-b pb-1 mb-2">1. Corporate Level</h4>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                <span>Gross Sale:</span> <span className="text-right">{formatCurrency(inputs.salePrice)}</span>
                                <span>- Dev Costs:</span> <span className="text-right text-red-600">({formatCurrency(inputs.devCosts)})</span>
                                <span className="font-semibold">= Profit:</span> <span className="text-right font-semibold">{formatCurrency(profit)}</span>
                                <span>x Corp Tax (25%):</span> <span className="text-right text-red-600">({formatCurrency(calc.corpTax)})</span>
                                <span className="font-bold border-t border-gray-300 pt-1">= Net Cash in Co:</span> <span className="text-right font-bold border-t border-gray-300 pt-1">{formatCurrency(calc.netCashFromCompany)}</span>
                            </div>
                        </div>

                        {/* 2. Strategy A */}
                        <div>
                            <h4 className="font-bold text-gray-900 border-b pb-1 mb-2">2. Strategy A (New Gift)</h4>
                            <p className="mb-2 italic text-xs text-gray-500">Assumption: All Net Cash ({formatCurrency(calc.netCashFromCompany)}) is extracted and gifted at Sale Year ({inputs.saleYear}).</p>
                            <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                <span>Taxable Amount:</span> <span className="text-right">{formatCurrency(calc.netCashFromCompany)}</span>
                                <span>IHT Rate (40%):</span> <span className="text-right text-red-600">{formatCurrency(calc.netCashFromCompany * 0.4)}</span>
                                <span>x Taper Relief ({Math.round((1 - taperA) * 100)}% off):</span> <span className="text-right text-blue-600">x {taperA.toFixed(2)}</span>
                                <span className="font-bold border-t border-gray-300 pt-1">= IHT Liability:</span> <span className="text-right font-bold border-t border-gray-300 pt-1">{formatCurrency(calc.strategyA.tax)}</span>
                            </div>
                        </div>

                        {/* 3. Strategy B */}
                        <div>
                            <h4 className="font-bold text-gray-900 border-b pb-1 mb-2">3. Strategy B (Loan Assignment)</h4>
                            <p className="mb-2 italic text-xs text-gray-500">Breakdown of taxable components based on their individual gift dates.</p>
                            <table className="w-full text-right">
                                <thead className="text-gray-500 text-xs border-b">
                                    <tr>
                                        <th className="text-left pb-1">Component</th>
                                        <th className="pb-1">Amount</th>
                                        <th className="pb-1">Gift Year</th>
                                        <th className="pb-1">Years Elapsed</th>
                                        <th className="pb-1">Eff. Rate</th>
                                        <th className="pb-1">Tax</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {/* Equity */}
                                    <tr>
                                        <td className="text-left py-1">New Equity Dist.</td>
                                        <td>{formatCurrency(Math.max(0, calc.netCashFromCompany - inputs.loans.reduce((a, b) => a + b.amount, 0)))}</td>
                                        <td>{inputs.saleYear}</td>
                                        <td>{yearsSinceSale}</td>
                                        <td>{(40 * taperA).toFixed(1)}%</td>
                                        <td>{formatCurrency(Math.max(0, calc.netCashFromCompany - inputs.loans.reduce((a, b) => a + b.amount, 0)) * 0.4 * taperA)}</td>
                                    </tr>
                                    {/* Loans */}
                                    {inputs.loans.map(l => {
                                        const isAssigned = l.type === 'assigned' && l.assignmentYear;
                                        const giftYear = isAssigned ? l.assignmentYear : inputs.saleYear;
                                        const elapsed = inputs.deathYear - giftYear;
                                        const taper = getTaper(elapsed);
                                        return (
                                            <tr key={l.id}>
                                                <td className="text-left py-1">{l.name}</td>
                                                <td>{formatCurrency(l.amount)}</td>
                                                <td>{giftYear}</td>
                                                <td>{Math.max(0, elapsed)}</td>
                                                <td>{(40 * taper).toFixed(1)}%</td>
                                                <td>{formatCurrency(l.amount * 0.4 * taper)}</td>
                                            </tr>
                                        );
                                    })}
                                    <tr className="border-t font-bold">
                                        <td className="text-left pt-2">TOTAL</td>
                                        <td colSpan="4"></td>
                                        <td className="pt-2">{formatCurrency(calc.strategyB.tax)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </Card>
            );
        };

        // --- Main App ---
        const App = () => {
            // State
            const [showMath, setShowMath] = useState(false);
            const [salePrice, setSalePrice] = useState(DEFAULT_DATA.salePrice);
            const [devCosts, setDevCosts] = useState(DEFAULT_DATA.devCosts);
            const [saleYear, setSaleYear] = useState(DEFAULT_DATA.saleYear);
            const [deathYear, setDeathYear] = useState(DEFAULT_DATA.saleYear + 1);

            const [loans, setLoans] = useState(DEFAULT_DATA.loans);
            const [insurance, setInsurance] = useState(DEFAULT_DATA.insurance);

            // Persistence
            useEffect(() => {
                const saved = localStorage.getItem('tax_strategy_data');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.salePrice) setSalePrice(parsed.salePrice);
                        if (parsed.devCosts) setDevCosts(parsed.devCosts);
                        if (parsed.saleYear) setSaleYear(parsed.saleYear);
                        if (parsed.deathYear) setDeathYear(parsed.deathYear);
                        if (parsed.loans) setLoans(parsed.loans);
                        if (parsed.insurance) setInsurance(parsed.insurance);
                        console.log("Loaded from LocalStorage");
                    } catch (e) {
                        console.error("Failed to load saved data", e);
                    }
                }
            }, []);

            const saveData = () => {
                const data = { salePrice, devCosts, saleYear, deathYear, loans, insurance };
                localStorage.setItem('tax_strategy_data', JSON.stringify(data));
                alert("Scenario saved to Local Browser Storage! (Offline Mode)");
            };

            const resetData = () => {
                if (confirm("Reset all data to defaults? This cannot be undone.")) {
                    localStorage.removeItem('tax_strategy_data');
                    window.location.reload();
                }
            };

            // Logic
            const calculations = useMemo(() => {
                const corpTaxRate = 0.25;
                const profit = Math.max(0, salePrice - devCosts);
                const corpTax = profit * corpTaxRate;

                const totalLoans = loans.reduce((acc, l) => acc + l.amount, 0);

                const netCashFromCompany = Math.max(0, salePrice - corpTax);
                const equityAfterLoans = Math.max(0, netCashFromCompany - totalLoans);

                // Strategy A
                const yearsElapsedA = Math.max(0, deathYear - saleYear);
                const taperFactorA = getTaperRate(yearsElapsedA);

                const wealthToTransfer = netCashFromCompany;
                const taxAtDeathA_Base = wealthToTransfer * 0.40;
                const taxAtDeathA_Actual = taxAtDeathA_Base * taperFactorA;

                // Strategy B
                let totalTaxB = 0;
                totalTaxB += (equityAfterLoans * 0.40) * taperFactorA;

                loans.forEach(loan => {
                    if (loan.type === 'assigned' && loan.assignmentYear) {
                        const yearsSinceAssignment = deathYear - loan.assignmentYear;
                        const taper = getTaperRate(yearsSinceAssignment);
                        totalTaxB += (loan.amount * 0.40) * taper;
                    } else {
                        totalTaxB += (loan.amount * 0.40) * taperFactorA;
                    }
                });

                // Insurance
                const duration = Math.max(0, deathYear - insurance.termStartYear);
                const insuranceCost = insurance.enabled ? insurance.premium * duration : 0;
                const insurancePayout = insurance.enabled ? insurance.payout : 0;

                const wealthA = wealthToTransfer - taxAtDeathA_Actual + insurancePayout - insuranceCost;
                const wealthB = wealthToTransfer - totalTaxB + insurancePayout - insuranceCost;

                return {
                    corpTax,
                    netCashFromCompany,
                    wealthToTransfer,
                    strategyA: { tax: taxAtDeathA_Actual, wealth: wealthA },
                    strategyB: { tax: totalTaxB, wealth: wealthB },
                    insuranceEffect: insurancePayout - insuranceCost
                };
            }, [salePrice, devCosts, saleYear, deathYear, loans, insurance]);

            const chartData = [
                { name: 'Strategy A', wealth: calculations.strategyA.wealth, tax: calculations.strategyA.tax },
                { name: 'Strategy B', wealth: calculations.strategyB.wealth, tax: calculations.strategyB.tax },
            ];

            // Handlers
            const addLoan = () => setLoans([...loans, { id: Date.now(), name: "New Loan", amount: 50000, type: "outstanding", assignmentYear: null }]);
            const updateLoan = (id, field, val) => setLoans(loans.map(l => l.id === id ? { ...l, [field]: val } : l));
            const removeLoan = (id) => setLoans(loans.filter(l => l.id !== id));

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8 pb-32">
                    <header className="flex flex-col md:flex-row md:justify-between md:items-center pb-6 border-b border-gray-200">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900 tracking-tight">Tax Strategy Engine</h1>
                            <p className="text-gray-500 mt-1">Modeling the liquidation of STMS Ltd & IHT Planning</p>
                        </div>
                        <div className="mt-4 md:mt-0 flex items-center gap-2">
                            <div className="bg-emerald-50 text-emerald-700 px-4 py-2 rounded-lg font-medium text-sm border border-emerald-100 hidden md:block">
                                Corp: {formatCurrency(calculations.corpTax)}
                            </div>
                            <button onClick={saveData} className="bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-900 transition-colors shadow-sm flex items-center gap-2">
                                <span>Save</span>
                            </button>
                            <button
                                onClick={() => setShowMath(!showMath)}
                                className={`px-4 py-2 rounded-lg font-medium text-sm border transition-colors ${showMath ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}
                            >
                                {showMath ? 'Hide Math' : 'Show Logic'}
                            </button>
                            <button onClick={resetData} className="text-gray-400 hover:text-red-500 p-2 rounded-full transition-colors" title="Reset to Defaults">
                                ↺
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* LEFT: Controls (4 cols) */}
                        <div className="lg:col-span-4 space-y-6">
                            <Card title="Timeline Stress Test">
                                <div className="space-y-6">
                                    <SliderInput
                                        label="Asset Sale Year"
                                        value={saleYear}
                                        onChange={setSaleYear}
                                        min={2024}
                                        max={2030}
                                    />
                                    <SliderInput
                                        label="Projected Death Year"
                                        value={deathYear}
                                        onChange={setDeathYear}
                                        min={saleYear}
                                        max={saleYear + 15}
                                    />

                                    <div className={`p-4 rounded-lg text-sm border ${(deathYear - saleYear) >= 7 ? 'bg-green-50 border-green-200 text-green-800' :
                                        'bg-amber-50 border-amber-200 text-amber-800'
                                        }`}>
                                        <strong>{deathYear - saleYear} Years</strong> elapsed since sale. <br />
                                        PET Taper Relief: {Math.round((1 - getTaperRate(deathYear - saleYear)) * 100)}%
                                    </div>
                                </div>
                            </Card>

                            <Card title="Structure & Values">
                                <div className="space-y-4">
                                    <NumberInput label="Sale Price" value={salePrice} onChange={setSalePrice} />
                                    <NumberInput label="Cost Basis (Dev Costs)" value={devCosts} onChange={setDevCosts} />

                                    <div className="pt-4 border-t border-gray-100">
                                        <Toggle
                                            label="Life Insurance Hedge"
                                            enabled={insurance.enabled}
                                            onChange={(v) => setInsurance({ ...insurance, enabled: v })}
                                        />
                                        {insurance.enabled && (
                                            <div className="mt-4 space-y-3 pl-4 border-l-2 border-blue-100 animation-fade-in">
                                                <NumberInput
                                                    label="Death Benefit (Payout)"
                                                    value={insurance.payout}
                                                    onChange={(v) => setInsurance({ ...insurance, payout: v })}
                                                />
                                                <NumberInput
                                                    label="Annual Premium"
                                                    value={insurance.premium}
                                                    onChange={(v) => setInsurance({ ...insurance, premium: v })}
                                                />
                                                <NumberInput
                                                    label="Policy Start Year"
                                                    value={insurance.termStartYear || 2022}
                                                    onChange={(v) => setInsurance({ ...insurance, termStartYear: v })}
                                                    prefix=""
                                                />
                                                <div className="text-xs text-gray-500 mt-2">
                                                    Total Cost to Date: {formatCurrency(insurance.premium * Math.max(0, deathYear - (insurance.termStartYear || 2022)))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </Card>

                            <Card title="Director Loans">
                                <div className="space-y-3">
                                    {loans.map(loan => (
                                        <div key={loan.id} className="p-3 bg-gray-50 rounded border border-gray-200 text-sm">
                                            <div className="flex justify-between mb-2">
                                                <input className="bg-transparent font-semibold w-1/2 outline-none" value={loan.name} onChange={(e) => updateLoan(loan.id, 'name', e.target.value)} />
                                                <button onClick={() => removeLoan(loan.id)} className="text-red-400 hover:text-red-600">×</button>
                                            </div>
                                            <div className="flex gap-2 mb-2">
                                                <input
                                                    type="number"
                                                    className="w-24 p-1 border rounded text-right"
                                                    value={loan.amount}
                                                    onChange={(e) => updateLoan(loan.id, 'amount', parseFloat(e.target.value))}
                                                />
                                                <select
                                                    className="flex-1 p-1 border rounded text-xs"
                                                    value={loan.type}
                                                    onChange={(e) => updateLoan(loan.id, 'type', e.target.value)}
                                                >
                                                    <option value="outstanding">Outstanding</option>
                                                    <option value="assigned">Assigned (Gifted)</option>
                                                </select>
                                            </div>
                                            {loan.type === 'assigned' && (
                                                <div className="flex items-center gap-2 text-xs text-blue-600">
                                                    <span>Gifted in:</span>
                                                    <input
                                                        type="number"
                                                        className="w-16 p-0.5 border rounded"
                                                        value={loan.assignmentYear || 2018}
                                                        onChange={(e) => updateLoan(loan.id, 'assignmentYear', parseInt(e.target.value))}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    <button onClick={addLoan} className="w-full py-2 text-sm text-blue-600 border border-dashed border-blue-300 rounded hover:bg-blue-50">+ Add Loan</button>
                                </div>
                            </Card>
                        </div>

                        {/* RIGHT: Visuals (8 cols) */}
                        <div className="lg:col-span-8 space-y-8">

                            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-6">Wealth Retention Analysis</h3>
                                <div className="h-96 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                            <YAxis axisLine={false} tickLine={false} tickFormatter={(val) => `£${val / 1000000}m`} />
                                            <Tooltip content={<CustomTooltip />} cursor={{ fill: '#f8fafc' }} />
                                            <Legend iconType="circle" />
                                            <Bar dataKey="wealth" name="Net Wealth to Heirs" fill="#10b981" radius={[4, 4, 0, 0]} barSize={60} />
                                            <Bar dataKey="tax" name="IHT Liability" fill="#ef4444" radius={[4, 4, 0, 0]} barSize={60} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="mt-8 grid grid-cols-2 gap-4 text-center">
                                    <div className="p-4 bg-gray-50 rounded-lg">
                                        <div className="text-sm text-gray-500 uppercase tracking-wide">Strategy A Tax</div>
                                        <div className="text-2xl font-bold text-red-600 mt-1">{formatCurrency(calculations.strategyA.tax)}</div>
                                        <div className="text-xs text-gray-400 mt-1">Based on new gift at {saleYear}</div>
                                    </div>
                                    <div className="p-4 bg-blue-50 rounded-lg">
                                        <div className="text-sm text-blue-600 uppercase tracking-wide">Strategy B Tax</div>
                                        <div className="text-2xl font-bold text-blue-700 mt-1">{formatCurrency(calculations.strategyB.tax)}</div>
                                        <div className="text-xs text-blue-400 mt-1">Saves {formatCurrency(calculations.strategyA.tax - calculations.strategyB.tax)}</div>
                                    </div>
                                </div>
                            </div>

                            <Card title="Detailed Breakdown">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-50 text-gray-500 border-b border-gray-100">
                                            <tr>
                                                <th className="py-3 px-4 font-medium">Component</th>
                                                <th className="py-3 px-4 font-medium text-right">Value</th>
                                                <th className="py-3 px-4 font-medium text-right text-red-500">IHT Risk (Strat A)</th>
                                                <th className="py-3 px-4 font-medium text-right text-blue-600">IHT Risk (Strat B)</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            <tr>
                                                <td className="py-3 px-4">Net Equity (Cash after Corp Tax & Loans)</td>
                                                <td className="py-3 px-4 text-right font-mono">{formatCurrency(calculations.netCashFromCompany - calculations.wealthToTransfer + calculations.strategyA.wealth + calculations.strategyA.tax - calculations.insuranceEffect)}</td>
                                                <td className="py-3 px-4 text-right text-red-500">{formatCurrency((calculations.netCashFromCompany - DEFAULT_DATA.loans.reduce((a, b) => a + b.amount, 0)) * 0.4 * getTaperRate(deathYear - saleYear))}</td>
                                                <td className="py-3 px-4 text-right text-blue-600">{formatCurrency((calculations.netCashFromCompany - DEFAULT_DATA.loans.reduce((a, b) => a + b.amount, 0)) * 0.4 * getTaperRate(deathYear - saleYear))}</td>
                                            </tr>
                                            {loans.map(loan => (
                                                <tr key={loan.id}>
                                                    <td className="py-3 px-4">{loan.name} <span className="text-xs text-gray-400">({loan.type})</span></td>
                                                    <td className="py-3 px-4 text-right font-mono">{formatCurrency(loan.amount)}</td>
                                                    <td className="py-3 px-4 text-right text-red-500">{formatCurrency(loan.amount * 0.4 * getTaperRate(deathYear - saleYear))}</td>
                                                    <td className="py-3 px-4 text-right text-blue-600">{
                                                        loan.type === 'assigned'
                                                            ? formatCurrency(loan.amount * 0.4 * getTaperRate(deathYear - (loan.assignmentYear || 2018)))
                                                            : formatCurrency(loan.amount * 0.4 * getTaperRate(deathYear - saleYear))
                                                    }</td>
                                                </tr>
                                            ))}
                                            <tr className="bg-gray-50 font-bold">
                                                <td className="py-3 px-4">TOTAL TAX DUE</td>
                                                <td className="py-3 px-4 text-right"></td>
                                                <td className="py-3 px-4 text-right text-red-600">{formatCurrency(calculations.strategyA.tax)}</td>
                                                <td className="py-3 px-4 text-right text-blue-700">{formatCurrency(calculations.strategyB.tax)}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </Card>

                            {showMath && <MathWalkthrough calc={calculations} inputs={{ salePrice, devCosts, saleYear, deathYear, loans }} getTaper={getTaperRate} />}

                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script>
        if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

            firebase.auth().onAuthStateChanged((user) => {
                const overlay = document.getElementById('loading-overlay');
                const root = document.getElementById('root');

                if (user) {
                    // Authenticated
                    setTimeout(() => {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.style.display = 'none', 500);
                        root.style.display = 'block';
                    }, 800);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }
    </script>
</body>

</html>